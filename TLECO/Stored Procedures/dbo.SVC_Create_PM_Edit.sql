SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_Create_PM_Edit]   (@EquipID integer,  @ServiceType char(11),   @PMDetailID char(9),  @SchedID char(9),  @Meter1 integer,  @Meter2 integer,  @UserDate datetime,  @CheckDate datetime) AS declare @PMType smallint,  @ItemNumber char(31),  @SerialNumber char(21),  @Customer char(15),  @CallNumber integer,  @Exists tinyint,  @ContractType smallint,  @Contract char(11),  @ContractLine numeric(19,5),  @ContractStart datetime ,  @ContractEnd datetime ,  @ResponseTime varchar(10) declare @template char(10),@newcallnbr varchar(10) declare @LastPMDate datetime, @Create tinyint declare @MinDate datetime  exec smGetMinDate @MinDate output  select @template = '0000000000' select    @Customer = CUSTNMBR,   @ItemNumber = ITEMNMBR,  @SerialNumber = SERLNMBR,  @Exists = 0 from SVC00300 where EQUIPID = @EquipID if @ItemNumber is null  return(0) BEGIN TRANSACTION select @CallNumber = MAX(IsNull(CONVERT(int,CALLNBR),1)) + 1 from SVC80010 if @CallNumber is null or @CallNumber = 0  select @CallNumber = 1 select @newcallnbr = Convert(varchar(10),@CallNumber) select @newcallnbr = stuff(@template,10 - DATALENGTH(ltrim(rtrim(@newcallnbr)))  + 1,DATALENGTH(ltrim(rtrim(@newcallnbr))),rtrim(@newcallnbr)) exec SVC_EquipOnContract @EquipID,@UserDate, @Exists OUTPUT,  @ContractType OUTPUT,@Contract OUTPUT,  @ContractLine OUTPUT,@ContractStart OUTPUT,  @ContractEnd OUTPUT,@ResponseTime  OUTPUT select @LastPMDate =  isnull(@CheckDate,@MinDate)  select @PMType = SVC_PM_Type from SVC8009 where SCHEDID = @SchedID and PMDTLID = @PMDetailID select @Create = 0   if @PMType = 2   begin   if not exists(select * from SVC00305 where EQUIPID=@EquipID and SCHEDID=@SchedID and PMDTLID = @PMDetailID and PMSTAT < 3 and Meter_1_Level = @Meter1 )  and not exists(select * from SVC00305 where EQUIPID=@EquipID and SCHEDID=@SchedID and PMDTLID = @PMDetailID and LSTPMDTE = @LastPMDate and Meter_1_Level = @Meter1)  select @Create = 1  end  if @PMType = 1 and not exists(select * from SVC00305 where EQUIPID=@EquipID and SCHEDID=@SchedID  and PMDTLID = @PMDetailID and PMSTAT = 1 and Meter_1_Level = @Meter1 and LSTPMDTE = @LastPMDate)  select @Create = 1  if @Create = 1  Begin  insert into SVC00305   values(@EquipID,  @ItemNumber,  @SerialNumber,  @SchedID,  @PMDetailID,  @Meter1,  @Meter2,  @newcallnbr,  @LastPMDate,  0,  0,  1,  @MinDate)   insert into SVC80010  values(@SerialNumber,  @PMDetailID,  @SchedID,  @newcallnbr,  @ItemNumber,  @ServiceType,  @Customer,  @Meter1,  0 ,  0,  0 ,  0 ,  1,  @ContractType,  @Contract,  @ContractLine) end  COMMIT TRANSACTION return(0) ERROR:  ROLLBACK TRANSACTION  return(0)    
GO
GRANT EXECUTE ON  [dbo].[SVC_Create_PM_Edit] TO [DYNGRP]
GO
