SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create         procedure [dbo].[aagCopyToGLWorkFromSubLedgerForApply] @I_nSubLedHdrID int, @I_nOrigSeqNum numeric(19,5), @I_nGLWorkHdrID int, @I_nDistID int, @I_nJrnEntry int, @I_dtGLPostingDate datetime, @L_SeqLine numeric(19,5), @O_fSuccess tinyint  output  as  Declare @Series smallint,  @APTVCHNM char(22),  @ACTINDX int,  @APTODCTY int,  @DISTTYPE smallint,  @DetCount int,  @CRDTAMNT numeric(19,5),  @DEBITAMT numeric(19,5),  @ORCRDAMT numeric(19,5),  @ORDBTAMT numeric(19,5),  @SEQNUMBR numeric(19,5),  @FUNLCURR char(15),  @aaGLWorkDistID int,  @CURRID char(15)  select @FUNLCURR = FUNLCURR from MC40000   Select @DetCount = 0  Select @Series =SERIES from AAG20000 Where aaSubLedgerHdrID = @I_nSubLedHdrID  Update AAG20001 Set aaCustID ='', aaVendID ='', aaItemID ='', aaSiteID =''  Where aaSubLedgerHdrID = @I_nSubLedHdrID and aaSubLedgerDistID = @I_nDistID and aaBrowseType =0   SELECT @DetCount = COUNT(1) FROM AAG20001 WHERE aaSubLedgerHdrID = @I_nSubLedHdrID and   SEQNUMBR =  @I_nOrigSeqNum  Delete AAG10001 where aaGLWorkHdrID=@I_nGLWorkHdrID and aaGLWorkDistID=@I_nDistID  Delete AAG10002 where aaGLWorkHdrID=@I_nGLWorkHdrID and aaGLWorkDistID=@I_nDistID  Delete AAG10003 where aaGLWorkHdrID=@I_nGLWorkHdrID and aaGLWorkDistID=@I_nDistID   IF @DetCount <> 1 AND @Series = 4   BEGIN  SELECT  @APTVCHNM = PM.APTVCHNM,  @ACTINDX = GL.ACTINDX,  @APTODCTY = PM.APTODCTY + (SPCLDIST * 1000),  @DISTTYPE = PM.DISTTYPE  FROM PM10100 PM, GL10001 GL  WHERE  GL.JRNENTRY = @I_nJrnEntry   AND GL.OrigSeqNum = @I_nOrigSeqNum   AND PM.VCHRNMBR = GL.ORCTRNUM   AND GL.OrigSeqNum = PM.DSTSQNUM   AND GL.BACHNUMB = PM.TRXSORCE  AND GL.ACTINDX = PM.DSTINDX  END   IF @DetCount <> 1 AND @Series = 4   BEGIN  INSERT INTO AAG10001(aaGLWorkHdrID,aaGLWorkDistID,  INTERID,CorrespondingUnit,ACTINDX,ACCTTYPE,DECPLACS,FXDORVAR,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,CURNCYID,CURRNIDX,RATETPID,EXGTBLID,  XCHGRATE,EXCHDATE,TIME1,RTCLCMTD,DENXRATE,MCTRXSTT,SQNCLINE,  aaCustID,aaVendID,aaSiteID,aaItemID,EMPLOYID,  aaCopyStatus,aaWinWasOpen,aaDistErrors,aaBrowseType,aaChangeDate, aaChangeTime)  SELECT  @I_nGLWorkHdrID,@I_nDistID,  INTERID,CorrespondingUnit,ACTINDX,ACCTTYPE,DECPLACS,isnull(dbo.aagFixedOrVar(ACTINDX),0),   DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,CURNCYID,CURRNIDX,RATETPID,EXGTBLID,  XCHGRATE,EXCHDATE,TIME1,RTCLCMTD,DENXRATE,MCTRXSTT,@L_SeqLine,  aaCustID,aaVendID,aaSiteID,aaItemID,EMPLOYID,  aaCopyStatus,1,0,aaBrowseType,convert(char(12), getdate(), 102), convert(char(12), getdate(), 108)  from AAG20001 where aaSubLedgerHdrID = @I_nSubLedHdrID   AND APTVCHNM = @APTVCHNM   AND ACTINDX = @ACTINDX  AND DISTTYPE = @DISTTYPE  AND APTODCTY = @APTODCTY  AND CRDTAMNT = @CRDTAMNT  AND DEBITAMT = @DEBITAMT  AND ORCRDAMT = @ORCRDAMT  AND ORDBTAMT = @ORDBTAMT  AND SEQNUMBR =  @SEQNUMBR   If @Series <> 3  Update AAG20001 set POSTED = 1 , GLPOSTDT = @I_dtGLPostingDate  where aaSubLedgerHdrID = @I_nSubLedHdrID   AND APTVCHNM = @APTVCHNM AND ACTINDX = @ACTINDX  AND DISTTYPE = @DISTTYPE AND APTODCTY = @APTODCTY  END  ELSE   BEGIN  INSERT INTO AAG10001(aaGLWorkHdrID,aaGLWorkDistID,  INTERID,CorrespondingUnit,ACTINDX,ACCTTYPE,DECPLACS,FXDORVAR,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,CURNCYID,CURRNIDX,RATETPID,EXGTBLID,  XCHGRATE,EXCHDATE,TIME1,RTCLCMTD,DENXRATE,MCTRXSTT,SQNCLINE,  aaCustID,aaVendID,aaSiteID,aaItemID,EMPLOYID,  aaCopyStatus,aaWinWasOpen,aaDistErrors,aaBrowseType,aaChangeDate, aaChangeTime)  SELECT @I_nGLWorkHdrID,@I_nDistID,  INTERID,CorrespondingUnit,ACTINDX,ACCTTYPE,DECPLACS,isnull(dbo.aagFixedOrVar(ACTINDX),0),   DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,CURNCYID,CURRNIDX,RATETPID,EXGTBLID,  XCHGRATE,EXCHDATE,TIME1,RTCLCMTD,DENXRATE,MCTRXSTT,@L_SeqLine,  aaCustID,aaVendID,aaSiteID,aaItemID,EMPLOYID,  aaCopyStatus,1,0,aaBrowseType,convert(char(12), getdate(), 102), convert(char(12), getdate(), 108)  from AAG20001 where aaSubLedgerHdrID = @I_nSubLedHdrID   AND SEQNUMBR =  @I_nOrigSeqNum    If @Series <> 3  Update AAG20001 set POSTED = 1 , GLPOSTDT = @I_dtGLPostingDate  where aaSubLedgerHdrID = @I_nSubLedHdrID and SEQNUMBR =  @I_nOrigSeqNum   END   IF @DetCount <> 1 AND @Series = 4   BEGIN  INSERT INTO AAG10002(aaGLWorkHdrID,aaGLWorkDistID,aaGLWorkAssignID,aaAssignedPercent,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,DistRef,NOTEINDX,aaAliasID)  SELECT @I_nGLWorkHdrID,@I_nDistID,aaSubLedgerAssignID,aaAssignedPercent,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,DistRef,NOTEINDX,aaAliasID  from AAG20002 where aaSubLedgerHdrID = @I_nSubLedHdrID and  aaSubLedgerDistID in (select aaSubLedgerDistID from AAG20001  where aaSubLedgerHdrID = @I_nSubLedHdrID   AND APTVCHNM = @APTVCHNM   AND ACTINDX = @ACTINDX  AND DISTTYPE = @DISTTYPE  AND APTODCTY = @APTODCTY  AND CRDTAMNT = @CRDTAMNT  AND DEBITAMT = @DEBITAMT  AND ORCRDAMT = @ORCRDAMT  AND ORDBTAMT = @ORDBTAMT  AND SEQNUMBR =  @SEQNUMBR)  END   ELSE  BEGIN  INSERT INTO AAG10002(aaGLWorkHdrID,aaGLWorkDistID,aaGLWorkAssignID,aaAssignedPercent,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,DistRef,NOTEINDX,aaAliasID)  SELECT @I_nGLWorkHdrID,@I_nDistID,aaSubLedgerAssignID,aaAssignedPercent,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,DistRef,NOTEINDX,aaAliasID  from AAG20002 where aaSubLedgerHdrID = @I_nSubLedHdrID and  aaSubLedgerDistID in (select aaSubLedgerDistID from AAG20001  where aaSubLedgerHdrID = @I_nSubLedHdrID   AND SEQNUMBR =  @I_nOrigSeqNum)  END   IF @DetCount <> 1 AND @Series = 4   BEGIN  INSERT INTO AAG10003(aaGLWorkHdrID,aaGLWorkDistID,aaGLWorkAssignID,  aaTrxDimID,aaTrxCodeID,aaCodeErrors)  SELECT @I_nGLWorkHdrID,@I_nDistID,aaSubLedgerAssignID,  aaTrxDimID,aaTrxCodeID,aaCodeErrors  from AAG20003 where aaSubLedgerHdrID = @I_nSubLedHdrID  and  aaSubLedgerDistID in (select aaSubLedgerDistID from AAG20001  where aaSubLedgerHdrID = @I_nSubLedHdrID   AND APTVCHNM = @APTVCHNM   AND ACTINDX = @ACTINDX  AND DISTTYPE = @DISTTYPE  AND APTODCTY = @APTODCTY  AND CRDTAMNT = @CRDTAMNT  AND DEBITAMT = @DEBITAMT  AND ORCRDAMT = @ORCRDAMT  AND ORDBTAMT = @ORDBTAMT  AND SEQNUMBR =  @SEQNUMBR)  END  ELSE  BEGIN  INSERT INTO AAG10003(aaGLWorkHdrID,aaGLWorkDistID,aaGLWorkAssignID,  aaTrxDimID,aaTrxCodeID,aaCodeErrors)  SELECT @I_nGLWorkHdrID,@I_nDistID,aaSubLedgerAssignID,  aaTrxDimID,aaTrxCodeID,aaCodeErrors  from AAG20003 where aaSubLedgerHdrID = @I_nSubLedHdrID  and  aaSubLedgerDistID in (select aaSubLedgerDistID from AAG20001  where aaSubLedgerHdrID = @I_nSubLedHdrID   AND SEQNUMBR = @I_nOrigSeqNum)  END   SELECT  @aaGLWorkDistID = aaGLWorkDistID,@CURRID = CURNCYID from AAG10001 WHERE aaGLWorkHdrID = @I_nGLWorkHdrID and SQNCLINE =  @L_SeqLine   if  (@FUNLCURR = @CURRID) or len(rtrim(ltrim(@CURRID))) = 0  begin  update AAG10001 set ORCRDAMT = CRDTAMNT , ORDBTAMT = DEBITAMT where  aaGLWorkHdrID = @I_nGLWorkHdrID and aaGLWorkDistID = @aaGLWorkDistID  update AAG10002 set ORCRDAMT = CRDTAMNT , ORDBTAMT = DEBITAMT where  aaGLWorkHdrID = @I_nGLWorkHdrID and aaGLWorkDistID = @aaGLWorkDistID  and aaGLWorkAssignID > 0  end     
GO
GRANT EXECUTE ON  [dbo].[aagCopyToGLWorkFromSubLedgerForApply] TO [DYNGRP]
GO
