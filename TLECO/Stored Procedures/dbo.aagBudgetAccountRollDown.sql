SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE                  PROCEDURE [dbo].[aagBudgetAccountRollDown]  (  @Type INTEGER ,   @Parts NUMERIC(19,5) ,  @IncLN INTEGER ,  @IncOB INTEGER )  AS BEGIN  DECLARE @TEMPACTINDX INTEGER ,  @Percentage NUMERIC(19,5) ,  @nCount INTEGER ,   @Result INTEGER ,  @ACTINDX INTEGER ,  @aaCodeSequence INTEGER ,  @USERID CHAR(15),  @WINTYPE INTEGER ,  @CMPANYID INTEGER ,  @aaBudgetID INTEGER ,  @aaActualPriliminary INTEGER,  @aaAcctType INTEGER ,  @aaAmtQty INTEGER   DECLARE @temp_ACTINDX TABLE (ACTINDX INTEGER, Percentage NUMERIC(19,5))  SELECT @USERID  = SYSTEM_USER  SELECT @WINTYPE = 1   SELECT @CMPANYID = dbo.aagGetCompanyID()  INSERT INTO @temp_ACTINDX SELECT ACTINDX, Percentage FROM #temp_ACTINDX  SET TRANSACTION ISOLATION LEVEL READ COMMITTED  BEGIN TRANSACTION   SELECT @aaAmtQty = aaAmtQty, @aaActualPriliminary = aaActualPriliminary, @aaBudgetID = aaBudgetID, @aaCodeSequence = aaCodeSequence, @TEMPACTINDX = ACTINDX FROM AAG00906   WHERE USERID = @USERID AND WINTYPE = @WINTYPE  SET @aaAcctType = @aaAmtQty + 1  DELETE FROM AAG00905 WHERE aaBudgetID = @aaBudgetID AND aaCodeSequence = @aaCodeSequence AND aaActualPriliminary = @aaActualPriliminary  AND ACTINDX IN (SELECT ACTINDX FROM GL00100 WHERE ACCTTYPE = @aaAcctType)  WHILE ( 1 = 1 )  BEGIN  SELECT @nCount = COUNT (*) FROM @temp_ACTINDX  IF @nCount <= 0   BREAK  SELECT TOP 1 @ACTINDX = ACTINDX, @Percentage = Percentage from @temp_ACTINDX  UPDATE AAG00906 SET ACTINDX = @ACTINDX WHERE USERID = @USERID AND   WINTYPE = @WINTYPE AND CMPANYID = @CMPANYID  EXEC aagBudgetAccountRollDownOne @USERID, @WINTYPE, @CMPANYID, @Percentage, @ACTINDX, @Type, @Parts, @IncOB, @Result OUTPUT  DELETE FROM @temp_ACTINDX WHERE ACTINDX = @ACTINDX  END   IF @Result < 0  BEGIN  ROLLBACK TRANSACTION   SELECT @Result  RETURN  END IF @IncLN = 1 EXEC aagIncludeLowerNodesForAccRollDown @USERID, @WINTYPE, @CMPANYID, @aaCodeSequence, @Type, @Parts, @IncOB, @Result OUTPUT   UPDATE AAG00906 SET ACTINDX = @ACTINDX, aaCodeSequence = @aaCodeSequence WHERE USERID = @USERID   AND WINTYPE = @WINTYPE AND CMPANYID = @CMPANYID  COMMIT TRANSACTION  SELECT @Result  RETURN  END    
GO
GRANT EXECUTE ON  [dbo].[aagBudgetAccountRollDown] TO [DYNGRP]
GO
