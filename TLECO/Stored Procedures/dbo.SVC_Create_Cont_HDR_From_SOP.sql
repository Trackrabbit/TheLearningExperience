SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_Create_Cont_HDR_From_SOP]  @SOPType smallint,  @SOPNumber char(21),  @newcontract char(11) OUTPUT As declare @contracttype smallint declare @custnumber char(15) declare @custname char(65) declare @addcode char(15) declare @conttype char(11) declare @contlenght smallint declare @contperiod smallint declare @startdate datetime declare @enddate datetime declare @prepaid tinyint declare @priceshcedule char(11) declare @billlength smallint declare @billperiod smallint declare @billstart datetime declare @billend datetime declare @billonday smallint declare @billcycle smallint declare @ltype smallint declare @billcust char(15) declare @billtoadd char(15) declare @ordernumber char(21) declare @detail tinyint declare @partpct numeric(19,5) declare @laborpct numeric(19,5) declare @miscpct numeric(19,5) declare @pmpartpct numeric(19,5) declare @pmlaborpct numeric(19,5) declare @pmmiscpct numeric(19,5) declare @paidcont tinyint declare @salesid char(15) declare @contact char(31) declare @taxid char(15) declare @tax1 char(25) declare @tax2 char(25) declare @country char(21) declare @currencyid char(15) declare @description char(31) declare @servtype char(11) declare @p1 tinyint declare @p2 tinyint declare @p3 tinyint declare @p4 tinyint declare @p5 tinyint declare @p6 tinyint declare @p7 tinyint declare @e1 datetime declare @e2 datetime declare @e3 datetime declare @e4 datetime declare @e5 datetime declare @e6 datetime declare @e7 datetime declare @s1 datetime declare @s2 datetime declare @s3 datetime declare @s4 datetime declare @s5 datetime declare @s6 datetime declare @s7 datetime declare @respose char(7) declare @discountpercent smallint declare @BillStartDate smallint declare @Smooth tinyint, @RevSmooth tinyint  declare @CURRNIDX smallint,  @RATETPID char(15),  @EXGTBLID char(15),  @XCHGRATE numeric(19, 7),  @EXCHDATE datetime ,  @DECPLACS smallint ,  @TIME1 datetime ,  @RATECALC smallint,  @VIEWMODE smallint ,  @ISMCTRX smallint ,  @EXPNDATE datetime,  @DENXRATE numeric(19, 7),  @MCTRXSTT smallint  declare @UserID char(21) declare @priority smallint declare @MinDate datetime declare @UseSameNumber tinyint declare @AtEvery smallint, @FrequencyQty numeric(19,2)  exec SVC_New_Contract_Number @newcontract OUTPUT exec smGetMinDate @MinDate output  select @UseSameNumber = SVC_Use_Same_Number from SVC00998 select @DECPLACS = 0, @VIEWMODE = 0, @ISMCTRX = 0, @EXPNDATE = @MinDate  select @custnumber = CUSTNMBR,  @custname = CUSTNAME,  @addcode = ADRSCODE,  @conttype = CNTTYPE,  @contlenght = Contract_Length,  @contperiod = Contract_Period,  @startdate = STRTDATE,  @enddate = ENDDATE,  @prepaid = PREPAID,  @priceshcedule = PRICSHED,  @billlength = BILLNGTH,  @billperiod = BILPRD,  @billstart = BILSTRT,  @billend = BILEND,  @billonday = BILONDY,  @billcycle = BILCYC,  @ltype = SVC_Liability_Type,  @billcust = Bill_To_Customer,  @billtoadd = SVC_Bill_To_Address_Code,  @ordernumber = PORDNMBR,  @detail = SVC_Invoice_Detail,  @partpct = PARTPCT,  @laborpct = LABPCT,  @miscpct = MISCPCT,  @pmpartpct = PMPRTPCT,  @pmlaborpct = PMLABPCT,  @pmmiscpct = PMMSCPCT,  @paidcont = SVC_Paid_Contract,  @discountpercent = DSCPCTAM,  @DECPLACS = 2  ,  @AtEvery = svcBillingFrequency,   @FrequencyQty = svcFrequencyQty  from SVC00660 where SOPTYPE=@SOPType and SOPNUMBE=@SOPNumber   select @CURRNIDX = CURRNIDX  ,@currencyid = CURNCYID,  @RATECALC = RTCLCMTD,  @RATETPID = RATETPID,  @EXGTBLID = EXGTBLID,  @XCHGRATE = XCHGRATE,  @EXCHDATE = EXCHDATE,  @TIME1  = TIME1,  @DENXRATE = DENXRATE,  @MCTRXSTT = MCTRXSTT from SOP30200 where SOPTYPE=@SOPType and SOPNUMBE=@SOPNumber   if DATEPART(dd,@billstart) = 1  select @Smooth = 1  else  select @Smooth = 0  if DATEPART(dd,@startdate) = 1  select @RevSmooth = 1  else  select @RevSmooth = 0   select @tax1 = TAXEXMT1, @tax2 = TAXEXMT2,  @salesid = SLPRSNID, @country = COUNTRY  from RM00101 where CUSTNMBR = (select CUSTNMBR from SVC00660  where SOPTYPE=@SOPType and SOPNUMBE=@SOPNumber)  select @taxid = TAXSCHID, @contact = CNTCPRSN   from RM00102 where CUSTNMBR = @custnumber and ADRSCODE = @addcode   select @description = CNTTYPDESC,  @servtype = SRVTYPE, @p1 = USECVPD_1,  @p2 = USECVPD_2,  @p3 = USECVPD_3,  @p4 = USECVPD_4,  @p5 = USECVPD_5,  @p6 = USECVPD_6,  @p7 = USECVPD_7,  @e1 = Contract_Coverage_Period_1,  @e2 = Contract_Coverage_Period_2,  @e3 = Contract_Coverage_Period_3,  @e4 = Contract_Coverage_Period_4,  @e5 = Contract_Coverage_Period_5,  @e6 = Contract_Coverage_Period_6,  @e7 = Contract_Coverage_Period_7,  @s1 = CNTCOVPD_1,  @s2 = CNTCOVPD_2,  @s3 = CNTCOVPD_3,  @s4 = CNTCOVPD_4,  @s5 = CNTCOVPD_5,  @s6 = CNTCOVPD_6,  @s7 = CNTCOVPD_7,  @respose = Contract_Response_Time,  @priority = priorityLevel  from SVC00602 where CNTTYPE = @conttype  select @UserID = SYSTEM_USER insert SVC00600  select  2,  @newcontract,  0,  @MinDate,  isnull(@taxid,''), isnull(@priority,0),  isnull(@addcode,''), 0,  '',  0.0,  0,  '',  0.0,  @MinDate,  @MinDate,  0.0,  0.0,  0.0,  @discountpercent,  0.0, isnull(@country,''), '',  isnull(@ordernumber,''), isnull(@description,''), isnull(@partpct,0.0), isnull(@laborpct,0.0), isnull(@miscpct,0.0), isnull(@pmmiscpct,0.0), isnull(@pmpartpct,0.0), isnull(@pmlaborpct,0.0), '',  0.0,  0.0,  isnull(@salesid,''), '',  0,  @billstart,  @billend,  @billlength,  @billperiod,  0.0,  @MinDate,  0.0,  @MinDate,  0,  0,  0.0,  isnull(@contact,''), isnull(@currencyid,''), @MinDate,  @conttype,  @priceshcedule,  @custnumber,  CONVERT(varchar(10),GETDATE(),102) + ' 00:00:00',  0.0,  0.0,  0.0,  0,  '',  @servtype,  0,  0.0,  @prepaid,  @billonday,  @billcycle,  '',  0,  @MinDate + CONVERT(varchar(8),GETDATE(),108),  @startdate,  @enddate,  @s1,  @s2, @s3, @s4, @s5, @s6, @s7, @e1,  @e2, @e3, @e4, @e5, @e6, @e7, @p1,  @p2, @p3, @p4, @p5, @p6, @p7, @contlenght,  @contperiod,  0.0,  0.0, 0.0,  0.0,  0.0,  0,  0,  @MinDate,  0,  isnull(@tax1,''), isnull(@tax2,''), 0,  '',  @SOPNumber,  5,        @respose,  0,  @MinDate,  @MinDate,  0.0,  0.0,  @UserID,  '',  @MinDate,  @ltype,  '',  '',  isnull(@billcust,''), @detail,  '',  '',  '',  '',  '',  isnull(@billtoadd,''), 0.0,  @paidcont, 0.0,0.0,0.0, @CURRNIDX , @RATETPID , @EXGTBLID , @XCHGRATE , @EXCHDATE , @DECPLACS , @TIME1 , @RATECALC , @VIEWMODE , @ISMCTRX , @EXPNDATE, @DENXRATE , @MCTRXSTT , 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, @Smooth, @RevSmooth, @UseSameNumber, '',  0, 0 , 0,0,0,'','',9,2,  @AtEvery ,   @FrequencyQty   exec SVC_Create_Contract_Audit 2, @newcontract,0,'','',@addcode,@UserID,'Create Contract From SOP'    
GO
GRANT EXECUTE ON  [dbo].[SVC_Create_Cont_HDR_From_SOP] TO [DYNGRP]
GO
