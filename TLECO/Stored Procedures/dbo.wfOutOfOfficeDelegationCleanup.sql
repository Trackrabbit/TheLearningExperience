SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[wfOutOfOfficeDelegationCleanup] as begin  set NOCOUNT ON  declare @DomainUserName char(255) declare @UsersListGuid char(37), @ActualUsersListGuid char(37)  declare Delegation_Users cursor local fast_forward for select DomainUserName, UsersListGuid from WF40500 open Delegation_Users fetch next from Delegation_Users into @DomainUserName, @UsersListGuid while @@FETCH_STATUS=0 begin  select @ActualUsersListGuid = rtrim(upper(isnull((select DYNAMICS.dbo.GetObjectGuidByUser(@DomainUserName,1,0)),'')))   if rtrim(upper(@UsersListGuid))<>rtrim(@ActualUsersListGuid)  begin  delete from WF40510 where UsersListGuid=@UsersListGuid  delete from WF40500 where UsersListGuid=@UsersListGuid  end   fetch next from Delegation_Users into @DomainUserName, @UsersListGuid end  close Delegation_Users deallocate Delegation_Users  declare Delegation_Lines cursor local fast_forward for select DomainUserName from WF40510 open Delegation_Lines fetch next from Delegation_Lines into @DomainUserName while @@FETCH_STATUS=0 begin  if DYNAMICS.dbo.IsValidUserByUser(@DomainUserName,1,0)=0   begin  delete from WF40510 where DomainUserName=@DomainUserName  end   fetch next from Delegation_Lines into @DomainUserName end  close Delegation_Lines deallocate Delegation_Lines  delete from WF40500 where rtrim(upper(UsersListGuid)) not in  (select rtrim(upper(UsersListGuid)) from WF40510)  declare @UserDelegationDates TABLE(ENDDATE datetime, UsersListGuid char(37)) insert into @UserDelegationDates  select MAX(ENDDATE) as ENDDATE,UsersListGuid from WF40510 group by UsersListGuid  update WF40500 set WF_Auto_Delegate_Tasks=0   where WF_Auto_Delegate_Tasks=1 and UsersListGuid in  (select UsersListGuid from @UserDelegationDates where ENDDATE<SYSDATETIME())  END   
GO
GRANT EXECUTE ON  [dbo].[wfOutOfOfficeDelegationCleanup] TO [DYNGRP]
GO
