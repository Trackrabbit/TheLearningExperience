SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[taCreateAccountGroup]  @I_vACCTGRPID char(15),    @I_vACCTGRPDESC  char(30) = '',   @I_vDEPREXPACCT char(75) = '',   @I_vDEPRRESACCT char(75) = '',   @I_vPRIORYRDEPRACCT char(75) = '',   @I_vASSETCOSTACCT char(75) = '',   @I_vPROCEEDSACCT char(75) = '',   @I_vRECOGGAINLOSSACCT char(75) = '',   @I_vNONRECOGGAINLOSSACCT char(75) = '',   @I_vCLEARINGACCT char(75) = '',   @I_vLASTMNTDDATE datetime = null,  @I_vLASTMNTDUSERID char(15) = '',   @I_vUSRDEFND1   char(50) = '',       @I_vUSRDEFND2   char(50) = '',       @I_vUSRDEFND3   char(50) = '',       @I_vUSRDEFND4   varchar(8000) = '',  @I_vUSRDEFND5   varchar(8000) = '',  @O_iErrorState   int output,   @oErrString   varchar(255) output   with encryption as  set transaction isolation level read uncommitted set nocount on  declare   @ACCTGRPINDEX int,    @DEPREXPACCTINDX int,    @DEPRRESVACCTINDX int,     @PRIORYRDEPRACCTINDX int,   @ASSETCOSTACCTINDX int,    @PROCEEDSACCTINDX int,    @RECGAINLOSSACCTINDX int,    @NONRECGAINLOSSACCTINDX int,    @CLEARINGACCTINDX int,    @O_iNumErrorState int,  @NOTEINDX numeric(19,5),  @CMPANYID smallint,  @iGetNextNoteIdxErrState int,  @iAddCodeErrState int,    @iStatus int,  @iCustomState int,  @iCustomErrString varchar(255),  @O_oErrorState int,  @iError int     select  @ACCTGRPINDEX = 0,    @DEPREXPACCTINDX = 0,    @DEPRRESVACCTINDX = 0,     @PRIORYRDEPRACCTINDX = 0,   @ASSETCOSTACCTINDX = 0,    @PROCEEDSACCTINDX = 0,    @RECGAINLOSSACCTINDX = 0,    @NONRECGAINLOSSACCTINDX = 0,    @CLEARINGACCTINDX = 0,    @CMPANYID = 0,  @iStatus = 0,   @O_iErrorState = 0    if (@oErrString is NULL) begin  select @oErrString = '' end  exec @iStatus = taCreateAccountGroupPre  @I_vACCTGRPID output,  @I_vACCTGRPDESC output,  @I_vDEPREXPACCT output,  @I_vDEPRRESACCT output,  @I_vPRIORYRDEPRACCT output,  @I_vASSETCOSTACCT output,  @I_vPROCEEDSACCT output,  @I_vRECOGGAINLOSSACCT output,  @I_vNONRECOGGAINLOSSACCT output,   @I_vCLEARINGACCT output,  @I_vLASTMNTDDATE output,  @I_vLASTMNTDUSERID output,  @I_vUSRDEFND1 output,  @I_vUSRDEFND2 output,  @I_vUSRDEFND3 output,  @I_vUSRDEFND4 output,  @I_vUSRDEFND5 output,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if @iStatus = 0 and @iError <> 0 begin  select @iStatus = @iError end if (@iStatus <> 0) or (@iCustomState <> 0) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  select @O_iErrorState = 3108    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if(  @I_vACCTGRPDESC is NULL or  @I_vACCTGRPDESC is NULL or  @I_vDEPREXPACCT is NULL or  @I_vDEPRRESACCT is NULL or  @I_vPRIORYRDEPRACCT is NULL or  @I_vASSETCOSTACCT is NULL or  @I_vPROCEEDSACCT is NULL or  @I_vRECOGGAINLOSSACCT is NULL or  @I_vNONRECOGGAINLOSSACCT is NULL or  @I_vCLEARINGACCT is NULL or   @I_vLASTMNTDUSERID is NULL or   @I_vUSRDEFND1 is NULL or   @I_vUSRDEFND2 is NULL or   @I_vUSRDEFND3 is NULL or   @I_vUSRDEFND4 is NULL or  @I_vUSRDEFND5 is NULL   )  begin  select @O_iErrorState = 3109    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  select  @I_vACCTGRPID = UPPER(@I_vACCTGRPID)  select @CMPANYID = CMPANYID from DYNAMICS..SY01500 (nolock) where INTERID = db_name()  if (@ACCTGRPINDEX = 0)   begin  exec @iStatus = taGetAcctGroupIndex  @I_tInc_Dec = 1,   @O_vAcctGroupIndex = @ACCTGRPINDEX output,  @O_iErrorState = @O_iNumErrorState output  select @iError = @@error  if ((@iStatus <> 0) or (@O_iNumErrorState <> 0) or (@iError <> 0))  begin  select @O_iErrorState = 9151   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end  exec @iStatus = DYNAMICS..tasmGetNextNoteIndex  @I_sCompanyID   = @CMPANYID,  @I_iSQLSessionID = 0,  @I_noteincrement  = 1,  @O_mNoteIndex   = @NOTEINDX output,  @O_iErrorState  = @iGetNextNoteIdxErrState output select @iError = @@error if @iStatus = 0 and @iError <> 0 begin  select @iStatus = @iError end if (@iStatus <> 0) or (@iGetNextNoteIdxErrState <> 0) begin  if (@iGetNextNoteIdxErrState <> 0)  begin  exec @iStatus = taUpdateString  @iGetNextNoteIdxErrState,  @oErrString,  @oErrString output,  @O_oErrorState output  end   select @O_iErrorState = 3103   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vACCTGRPID = '' ) begin  select @O_iErrorState = 3110    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output end  if ( @I_vDEPREXPACCT <> '' ) begin  select @DEPREXPACCTINDX = ACTINDX from GL00105 (nolock) where ACTNUMST = @I_vDEPREXPACCT  select @DEPREXPACCTINDX = isnull(@DEPREXPACCTINDX,0)  if ( @DEPREXPACCTINDX = 0 )  begin  select @O_iErrorState = 3111     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if ( @I_vDEPRRESACCT <> '' ) begin  select @DEPRRESVACCTINDX = ACTINDX from GL00105 (nolock) where ACTNUMST = @I_vDEPRRESACCT  select @DEPRRESVACCTINDX = isnull(@DEPRRESVACCTINDX,0)  if ( @DEPRRESVACCTINDX = 0 )  begin  select @O_iErrorState = 3112     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if ( @I_vPRIORYRDEPRACCT <> '' ) begin  select @PRIORYRDEPRACCTINDX = ACTINDX from GL00105 (nolock) where ACTNUMST = @I_vPRIORYRDEPRACCT  select @PRIORYRDEPRACCTINDX = isnull(@PRIORYRDEPRACCTINDX,0)  if ( @PRIORYRDEPRACCTINDX = 0 )  begin  select @O_iErrorState = 3113     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if ( @I_vASSETCOSTACCT <> '' ) begin  select @ASSETCOSTACCTINDX = ACTINDX from GL00105 (nolock) where ACTNUMST = @I_vASSETCOSTACCT  select @ASSETCOSTACCTINDX = isnull(@ASSETCOSTACCTINDX,0)  if ( @ASSETCOSTACCTINDX = 0 )  begin  select @O_iErrorState = 3114     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if ( @I_vPROCEEDSACCT <> '' ) begin  select @PROCEEDSACCTINDX = ACTINDX from GL00105 (nolock) where ACTNUMST = @I_vPROCEEDSACCT  select @PROCEEDSACCTINDX = isnull(@PROCEEDSACCTINDX,0)  if ( @PROCEEDSACCTINDX = 0 )  begin  select @O_iErrorState = 3115     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if ( @I_vRECOGGAINLOSSACCT <> '' ) begin  select @RECGAINLOSSACCTINDX = ACTINDX from GL00105 (nolock) where ACTNUMST = @I_vRECOGGAINLOSSACCT  select @RECGAINLOSSACCTINDX = isnull(@RECGAINLOSSACCTINDX,0)  if ( @RECGAINLOSSACCTINDX = 0 )  begin  select @O_iErrorState = 3116     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if ( @I_vNONRECOGGAINLOSSACCT <> '' ) begin  select @NONRECGAINLOSSACCTINDX = ACTINDX from GL00105 (nolock) where ACTNUMST = @I_vNONRECOGGAINLOSSACCT  select @NONRECGAINLOSSACCTINDX = isnull(@NONRECGAINLOSSACCTINDX,0)  if ( @NONRECGAINLOSSACCTINDX = 0 )  begin  select @O_iErrorState = 3117     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if ( @I_vCLEARINGACCT <> '' ) begin  select @CLEARINGACCTINDX = ACTINDX from GL00105 (nolock) where ACTNUMST = @I_vCLEARINGACCT  select @CLEARINGACCTINDX = isnull(@CLEARINGACCTINDX,0)  if ( @CLEARINGACCTINDX = 0 )  begin  select @O_iErrorState = 3118     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@O_iErrorState = 0) begin  if not exists( select 1 from FA41300 (nolock) where  ACCTGRPID = @I_vACCTGRPID )  begin  insert into FA41300 ( ACCTGRPINDEX,  ACCTGRPID,  ACCTGRPDESC,   DEPREXPACCTINDX,  DEPRRESVACCTINDX,  PRIORYRDEPRACCTINDX,  ASSETCOSTACCTINDX,  PROCEEDSACCTINDX,  RECGAINLOSSACCTINDX,  NONRECGAINLOSSACCTINDX,  CLEARINGACCTINDX,  NOTEINDX,  LASTMNTDDATE,  LASTMNTDTIME,  LASTMNTDUSERID  )  select  @ACCTGRPINDEX,      @I_vACCTGRPID,      @I_vACCTGRPDESC,      @DEPREXPACCTINDX,     @DEPRRESVACCTINDX,     @PRIORYRDEPRACCTINDX,     @ASSETCOSTACCTINDX,     @PROCEEDSACCTINDX,     @RECGAINLOSSACCTINDX,     @NONRECGAINLOSSACCTINDX,    @CLEARINGACCTINDX,     @NOTEINDX,      case       WHEN @I_vLASTMNTDDATE is null  THEN convert(varchar(12),getdate())  ELSE @I_vLASTMNTDDATE  end,  '',       @I_vLASTMNTDUSERID      if @@error <> 0  begin  select @O_iErrorState = 3119    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end  end  else  begin  select @O_iErrorState = 3120    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end  if @O_iErrorState <> 0  return (@O_iErrorState)  exec @iStatus = taCreateAccountGroupPost  @I_vACCTGRPID,  @I_vACCTGRPDESC,  @I_vDEPREXPACCT,  @I_vDEPRRESACCT,  @I_vPRIORYRDEPRACCT,  @I_vASSETCOSTACCT,  @I_vPROCEEDSACCT,  @I_vRECOGGAINLOSSACCT,  @I_vNONRECOGGAINLOSSACCT,   @I_vCLEARINGACCT,  @I_vLASTMNTDDATE,  @I_vLASTMNTDUSERID,  @I_vUSRDEFND1,  @I_vUSRDEFND2,  @I_vUSRDEFND3,  @I_vUSRDEFND4,  @I_vUSRDEFND5,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if @iStatus = 0 and @iError <> 0 begin  select @iStatus = @iError end if (@iStatus <> 0) or (@iCustomState <> 0) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  select @O_iErrorState = 3121    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  return (@O_iErrorState)   
GO
GRANT EXECUTE ON  [dbo].[taCreateAccountGroup] TO [DYNGRP]
GO
