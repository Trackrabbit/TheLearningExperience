SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create         PROCEDURE [dbo].[aagRenumberAADistsGLWork]  @iHdrID int,  @iDistID Int,  @iISDelete tinyint,   @iSeqNum bigint,   @oStatus smallint = NULL out AS  declare @transaction tinyint,  @retCode int,  @dbName varchar(32),  @companyID smallint,  @companyStatus smallint,  @DistID int,  @SeqNum bigint,  @NextDistID int,  @TempDistID int,  @DistIDINSPos int   select  @transaction = 0,  @retCode = 0,  @dbName = '',  @companyID = 0,  @companyStatus = 0,  @DistID = 0,  @SeqNum = 0  if (@iHdrID is NULL) begin select @oStatus = 35000 return end  if (@iHdrID = 0) begin select @oStatus = 35001 return end  select @dbName = db_name() exec @retCode = DYNAMICS.dbo.aagGetCompanyStatus @dbName, @companyID out, @companyStatus out, @oStatus out if ((@retCode <> 0) or (@oStatus <> 0)) return @retCode  if (@@trancount = 0)  begin  select @transaction = 1  begin transaction  end  IF @iISDelete = 1   Begin    Update AAG10003   Set aaGLWorkDistID = aaGLWorkDistID - 1   Where aaGLWorkHdrID = @iHdrID and aaGLWorkDistID > @iDistID   and aaGLWorkDistID >=0   Update AAG10002   Set aaGLWorkDistID = aaGLWorkDistID - 1   Where aaGLWorkHdrID = @iHdrID and aaGLWorkDistID > @iDistID   and aaGLWorkDistID >=0  Update AAG10001   Set aaGLWorkDistID = aaGLWorkDistID - 1   Where aaGLWorkHdrID = @iHdrID And aaGLWorkDistID > @iDistID   and aaGLWorkDistID >=0   if (@transaction = 1)  and @@error  = 0   Begin   commit transaction   return 0  End  Else  Begin  Rollback   Return   End End Else  Begin    Select @DistIDINSPos = Max(aaGLWorkDistID)   From AAG10001   Where aaGLWorkHdrID = @iHdrID and  SQNCLINE < @iSeqNum  and aaGLWorkDistID >=0   Update AAG10001   Set aaGLWorkDistID = aaGLWorkDistID + 1   Where aaGLWorkHdrID = @iHdrID and  aaGLWorkDistID > @DistIDINSPos  and aaGLWorkDistID >=0   IF @@error <> 0  goto errlbl   Update AAG10002   Set aaGLWorkDistID = aaGLWorkDistID + 1   Where aaGLWorkHdrID = @iHdrID and aaGLWorkDistID > @DistIDINSPos   and aaGLWorkDistID >=0   IF @@error <> 0  goto errlbl  Update AAG10003   Set aaGLWorkDistID = aaGLWorkDistID + 1   Where aaGLWorkHdrID = @iHdrID And aaGLWorkDistID > @DistIDINSPos   and aaGLWorkDistID >=0   IF @@error <> 0  goto errlbl   Update AAG10001   Set aaGLWorkDistID = @DistIDINSPos + 1   Where aaGLWorkHdrID = @iHdrID and  aaGLWorkDistID = @iDistID + 1   and aaGLWorkDistID >=0   IF @@error <> 0  goto errlbl   Update AAG10002   Set aaGLWorkDistID = @DistIDINSPos + 1   Where aaGLWorkHdrID = @iHdrID and aaGLWorkDistID = @iDistID + 1  and aaGLWorkDistID >=0   IF @@error <> 0  goto errlbl  Update AAG10003   Set aaGLWorkDistID = @DistIDINSPos  + 1   Where aaGLWorkHdrID = @iHdrID And aaGLWorkDistID = @iDistID + 1   and aaGLWorkDistID >=0  IF @@error <> 0  goto errlbl  End  errlbl:  if (@transaction = 1)  and @@error  = 0   Begin   commit transaction   return 0  End  Else  Rollback    
GO
GRANT EXECUTE ON  [dbo].[aagRenumberAADistsGLWork] TO [DYNGRP]
GO
