SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[ADH_AUTOLINK_PROCESS]  @ADH_Favorite_Dict_ID AS INT,  @ADH_Favorite_Type AS INT,   @ADH_Sequence AS INT,  @FieldTableName AS VARCHAR(255),  @RelationTableName AS VARCHAR(255)  AS BEGIN   DECLARE @ADH_TableFrom AS VARCHAR(255),  @ADH_DisplayTableFrom AS VARCHAR(255),   @ADH_TableTo AS VARCHAR(255),  @ADH_DisplayTableTo AS VARCHAR(255),  @FieldName AS VARCHAR(255),  @LeftTable_Cursor CURSOR,  @RightTable_Cursor CURSOR,  @JoinField_Cursor CURSOR,  @New_Sequence AS INT,  @ADHSeriesFrom AS INT,  @ADHSeriesTo AS INT,  @ADHFieldTo AS varchar(255),   @ADHFieldFromDictID AS INT,  @ADHFieldToDictID AS INT,   @ADHInnerJoin AS TINYINT,  @ADHDisplayRelation AS TINYINT,   @ADHRightRecordNumber AS INT,  @ADHLeftRecordNumber AS INT,  @Series as TINYINT   SELECT @New_Sequence = @ADH_Sequence, @ADHInnerJoin = 5 ,@ADHDisplayRelation=1, @Series = 7  CREATE TABLE #RightTempTable(  ADHRightRecordNumber INT IDENTITY(1,1) ,  ADHTablePhysicalName VARCHAR(255),  ADHTableDisplayName VARCHAR(255),  ADHSeries INT,  ADHFieldDictID INT,  ASI_Sequence INT  )   CREATE TABLE #LeftTempTable(  ADHLeftRecordNumber INT IDENTITY(1,1) ,  ADHTablePhysicalName VARCHAR(255),  ADHTableDisplayName VARCHAR(255),  ADHSeries  INT,  ADHFieldDictID INT,  ASI_Sequence INT  )    CREATE TABLE #JoinFieldTempTable(  FieldPhysicalName VARCHAR(255)  )   EXEC('INSERT INTO #LeftTempTable (  ADHTablePhysicalName,  ADHTableDisplayName,  ADHSeries,  ADHFieldDictID,  ASI_Sequence  )   SELECT DISTINCT ADHTablePhysicalName,  ADHTableDisplayName,  ADHSeries,  ADHFieldDictID,  MIN(ASI_Sequence) AS ASI_Sequence   FROM '+ @FieldTableName+' WHERE ADHFieldType <> 4  GROUP BY  ADHTablePhysicalName,  ADHTableDisplayName,  ADHSeries,  ADHFieldDictID   ORDER BY ASI_Sequence ASC')   INSERT INTO #RightTempTable(   ADHTablePhysicalName,  ADHTableDisplayName,  ADHSeries,  ADHFieldDictID,  ASI_Sequence  )   SELECT ADHTablePhysicalName,  ADHTableDisplayName,  ADHSeries,  ADHFieldDictID,  ASI_Sequence from #LeftTempTable ORDER BY ASI_Sequence ASC   SET @LeftTable_Cursor = CURSOR LOCAL FAST_FORWARD  FOR  SELECT ADHTablePhysicalName,  ADHTableDisplayName,  ADHSeries,  ADHFieldDictID,  ADHLeftRecordNumber  FROM #LeftTempTable   OPEN @LeftTable_Cursor  FETCH NEXT FROM @LeftTable_Cursor   INTO @ADH_TableFrom,   @ADH_DisplayTableFrom,  @ADHSeriesFrom,  @ADHFieldFromDictID,  @ADHLeftRecordNumber   WHILE @@FETCH_STATUS = 0  BEGIN  SET @RightTable_Cursor = CURSOR LOCAL FAST_FORWARD  FOR  SELECT ADHTablePhysicalName,  ADHTableDisplayName,  ADHSeries,  ADHFieldDictID,  ADHRightRecordNumber  FROM #RightTempTable where ADHRightRecordNumber< @ADHLeftRecordNumber order by ADHRightRecordNumber DESC   OPEN @RightTable_Cursor  FETCH NEXT FROM @RightTable_Cursor   INTO @ADH_TableTo,   @ADH_DisplayTableTo,  @ADHSeriesTo,  @ADHFieldToDictID,  @ADHRightRecordNumber   WHILE @@FETCH_STATUS = 0  BEGIN  IF @ADH_TableTo=@ADH_TableFrom   BREAK;  ELSE  Begin  IF @ADHSeriesFrom= @Series   INSERT INTO   #JoinFieldTempTable   SELECT COLUMN_NAME   FROM DYNAMICS.INFORMATION_SCHEMA.KEY_COLUMN_USAGE   WHERE table_name = @ADH_TableFrom   ELSE  INSERT INTO   #JoinFieldTempTable   SELECT COLUMN_NAME   FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE   WHERE table_name =@ADH_TableFrom  SET @JoinField_Cursor = Cursor Local Forward_Only Static For   SELECT   FieldPhysicalName   FROM #JoinFieldTempTable   OPEN @JoinField_Cursor  FETCH NEXT  FROM @JoinField_Cursor Into @FieldName  WHILE @@FETCH_STATUS = 0  BEGIN  IF @ADHSeriesTo= @Series  SELECT COLUMN_NAME   FROM DYNAMICS.INFORMATION_SCHEMA.KEY_COLUMN_USAGE   WHERE table_name = @ADH_TableTo and COLUMN_NAME =  @FieldName   ELSE  SELECT COLUMN_NAME   FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE   WHERE table_name = @ADH_TableTo and COLUMN_NAME =  @FieldName   IF @@ROWCOUNT <> 0  BEGIN  EXEC('SELECT TOP 1 1 FROM '+@RelationTableName+'   WHERE ADHTableTo = '''+@ADH_DisplayTableFrom +''' and   ADHFieldTo = '''+ @FieldName+'''')  if @@ROWCOUNT = 0  BEGIN  SET @New_Sequence=@New_Sequence+1   EXEC('INSERT INTO '+ @RelationTableName+'(  ASI_Favorite_Dict_ID,  ASI_Favorite_Type,  ASI_Sequence,  ADHTableFrom,  ADHTableTo,  ADHFieldFrom,  ADHFieldDictIDFrom,  ADHFieldTo,  ADHFieldDictIDTo,  ADHJoinType,  ADHDisplayRelation  )  values ('+ @ADH_Favorite_Dict_ID +',  '+ @ADH_Favorite_Type +',  '+ @New_Sequence +',  '''+ @ADH_DisplayTableTo +''',  '''+ @ADH_DisplayTableFrom +''',  '''+ @FieldName +''',  '+ @ADHFieldToDictID +',  '''+ @FieldName +''',  '+ @ADHFieldFromDictID +',  '+@ADHInnerJoin+',  '+@ADHDisplayRelation+'  )')   END   END  Fetch Next  From @JoinField_Cursor Into @FieldName  END  truncate table #JoinFieldTempTable  END  CLOSE @JoinField_Cursor  DEALLOCATE @JoinField_Cursor  FETCH NEXT FROM @RightTable_Cursor   INTO @ADH_TableTo,  @ADH_DisplayTableTo,  @ADHSeriesTo,  @ADHFieldToDictID,  @ADHRightRecordNumber  END  CLOSE @RightTable_Cursor  DEALLOCATE @RightTable_Cursor   PRINT @ADH_TableFrom  FETCH NEXT FROM @LeftTable_Cursor   INTO @ADH_TableFrom,  @ADH_DisplayTableFrom,  @ADHSeriesFrom,  @ADHFieldFromDictID,  @ADHLeftRecordNumber   END   CLOSE @LeftTable_Cursor  DEALLOCATE @LeftTable_Cursor  END   
GO
GRANT EXECUTE ON  [dbo].[ADH_AUTOLINK_PROCESS] TO [DYNGRP]
GO
