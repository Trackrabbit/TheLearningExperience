SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[svcCreateNewInvoiceForCancel] (  @CONSTS                 smallint,  @CONTNBR                char(11),  @LNSEQNBR               numeric(19,5),  @CANCELDATE             datetime,  @AmountDue numeric(19,5),  @OrigAmountDue numeric(19,5)  )  AS  declare @BillCycle smallint,  @LIABILITY      smallint,  @N    int,  @Liabiltiy_Reduction tinyint,  @UserID char(30) declare @StartDate  datetime,  @EndDate    datetime,  @YEAR1      smallint,  @PERIODID   smallint,  @RevenueLine int declare @MinDate datetime declare @svcFrequencyQty smallint  if @AmountDue = 0 or @AmountDue is null   Return(10)  exec smGetMinDate @MinDate output   select @N = isnull(MAX(SVC00603.SVC_Invoice_SEQ_Number),0) + 1  from SVC00603 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR   if @AmountDue > 0   insert into SVC00603 with (ROWLOCK)  VALUES(@CONSTS,  @CONTNBR,  @LNSEQNBR,   @N,  IsNull(@CANCELDATE,CONVERT(varchar(10),GETDATE(),102) + ' 00:00:00'),  @AmountDue,  @CANCELDATE,  @CANCELDATE,  0,  @MinDate,  0,  0,  @AmountDue,  0,  @OrigAmountDue,  0,  0,  0,0,'',8)  else if @AmountDue < 0   insert into SVC00603 with (ROWLOCK)  VALUES(@CONSTS,  @CONTNBR,  @LNSEQNBR,   @N,  IsNull(@CANCELDATE,CONVERT(varchar(10),GETDATE(),102) + ' 00:00:00'),  0 ,  @CANCELDATE,  @CANCELDATE,   0,  @MinDate,  0,  (-1) * @AmountDue,  (-1) * @AmountDue,  0,  0,   0,  (-1) * @OrigAmountDue,  0,0,'',8)  select @LIABILITY = SVC_Liability_Type, @BillCycle = BILCYC, @Liabiltiy_Reduction = Liabiltiy_Reduction, @svcFrequencyQty = svcFrequencyQty  from SVC00600 where CONSTS = @CONSTS and CONTNBR = @CONTNBR  if (@BillCycle =4) or (@BillCycle = 3 and (@Liabiltiy_Reduction = 1 or @svcFrequencyQty > 1) )  begin  select  @UserID = SUSER_SNAME()  select @RevenueLine = max(LNITMSEQ) + 1  from SVC00604 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR   exec SVC_GetFiscalPeriodDates @UserID, @CANCELDATE,@StartDate OUTPUT,  @EndDate OUTPUT, @YEAR1 OUTPUT, @PERIODID OUTPUT  insert into SVC00604 select  2, @CONTNBR, @LNSEQNBR, @YEAR1, @PERIODID, isnull(@RevenueLine,1), 0, @MinDate,  @CANCELDATE, @UserID, 0, 0, 'CAL',  CONVERT(varchar(1),2) + '-' + RTRIM(CONVERT(varchar(20),@CONTNBR)) + '-' + CONVERT(varchar(20),@LNSEQNBR),  @AmountDue, @OrigAmountDue,  @StartDate, @EndDate, 0, 0, 0, 0,  @AmountDue, @OrigAmountDue   end  UPDATE SVC00600  with (ROWLOCK)  SET Amount_To_Invoice = Amount_To_Invoice+ @AmountDue,  Orig_Amount_To_Invoice = Orig_Amount_To_Invoice + @OrigAmountDue,  TOTAL = TOTAL + @AmountDue , ORIGTOTAL = ORIGTOTAL + @OrigAmountDue  WHERE CONSTS = @CONSTS AND CONTNBR = @CONTNBR  return   
GO
GRANT EXECUTE ON  [dbo].[svcCreateNewInvoiceForCancel] TO [DYNGRP]
GO
