SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE  procedure [dbo].[uprLoadTempXCmpyPayCodeSummary]  @IN_TempTableName varchar(255),  @IN_CompanyName char(64),  @IN_CompanyID char(5),  @IN_sYear smallint,  @IN_eYear smallint,  @IN_sDept char(6),  @IN_eDept char(6),  @IN_sPosition char(6),  @IN_ePosition char(6),  @IN_sEmpID char(15),  @IN_eEmpID char(15),  @IN_sEmpClassID char(15),  @IN_eEmpClassID char(15),  @IN_sDate datetime,  @IN_eDate datetime,  @IN_RangeSelect smallint,  @IN_ReportType smallint as  DECLARE @SQLString  varchar(3000) DECLARE @CompanyID  varchar(5) DECLARE @QDate      datetime DECLARE @YDate      datetime  SET @YDate = '19000101' SET @YDate = DATEADD(yyyy, datepart(yyyy, @IN_sDate) - 1900, @YDate) IF (@IN_ReportType = 3)  SET @YDate = @IN_sDate  SET @QDate = '19000101' SET @QDate = DATEADD(yyyy, datepart(yyyy, @IN_sDate) - 1900, @QDate) IF (month(@IN_sDate) >= 4) AND (month(@IN_sDate) <= 6)  SET @QDate = DATEADD(mm, 3, @QDate) IF (month(@IN_sDate) >= 7) AND (month(@IN_sDate) <= 9)  SET @QDate = DATEADD(mm, 6, @QDate) IF (month(@IN_sDate) >= 10)  SET @QDate = DATEADD(mm, 9, @QDate)  SET @CompanyID = rtrim(@IN_CompanyID)  SET @SQLString = 'INSERT INTO ' + @IN_TempTableName + '(CMPNYNAM,PYRLRTYP,PAYROLCD,EMPLOYID,LASTNAME,FRSTNAME,MIDLNAME,PYRLDSCR,MTDTXBWG,MNTHHRS,MNTHSWGS,MNTHSTTL,FLAG,MONTHTAX,QTDHOURS,QTDWAGES,QTDTXWGS,QTDTAX,QTDTOTAL,YTDHOURS,YTDWAGES,YTDTXWGS,YTDTAX,YTDTOTAL) ' SET @SQLString = @SQLString + ' SELECT ' + QUOTENAME(@IN_CompanyName,'''') + ',1 ,UPRTRXHist.PAYROLCD ,'''' , '''' , '''' , '''' ,'''' ,0.0 , '  IF (@IN_ReportType = 2)   SET @SQLString = @SQLString + ' 0.0, 0.0, ' ELSE BEGIN  SET @SQLString = @SQLString + ' ISNULL(SUM(CASE WHEN UPRTRXHist.CHEKDATE BETWEEN ''' + CONVERT(varchar(8), @IN_sDate, 112) + ''' AND ''' + CONVERT(varchar(8), @IN_eDate, 112) + ''' THEN UPRTRXHist.UNTSTOPY ELSE 0.0 END), 0.0), '  SET @SQLString = @SQLString + ' ISNULL(SUM(CASE WHEN UPRTRXHist.CHEKDATE BETWEEN ''' + CONVERT(varchar(8), @IN_sDate, 112) + ''' AND ''' + CONVERT(varchar(8), @IN_eDate, 112) + ''' THEN UPRTRXHist.UPRTRXAM ELSE 0.0 END), 0.0), ' END  SET @SQLString = @SQLString + ' 0.0 ,'''' ,0.0, '  IF (@IN_ReportType = 3)   SET @SQLString = @SQLString + ' 0.0, 0.0, 0.0 ,0.0 ,0.0,  ' ELSE BEGIN  SET @SQLString = @SQLString + ' ISNULL(SUM(CASE WHEN UPRTRXHist.CHEKDATE BETWEEN ''' + CONVERT(varchar(8), @QDate, 112) + ''' AND ''' + CONVERT(varchar(8), @IN_eDate, 112) + ''' THEN UPRTRXHist.UNTSTOPY ELSE 0.0 END), 0.0), '  SET @SQLString = @SQLString + ' ISNULL(SUM(CASE WHEN UPRTRXHist.CHEKDATE BETWEEN ''' + CONVERT(varchar(8), @QDate, 112) + ''' AND ''' + CONVERT(varchar(8), @IN_eDate, 112) + ''' THEN UPRTRXHist.UPRTRXAM ELSE 0.0 END), 0.0), 0.0 ,0.0 ,0.0, ' END  IF (@IN_ReportType = 3)   SET @SQLString = @SQLString + ' 0.0, 0.0, 0.0, 0.0, 0.0  ' ELSE BEGIN  SET @SQLString = @SQLString + ' ISNULL(SUM(CASE WHEN UPRTRXHist.CHEKDATE BETWEEN ''' + CONVERT(varchar(8), @YDate, 112) + ''' AND ''' + CONVERT(varchar(8), @IN_eDate, 112) + ''' THEN UPRTRXHist.UNTSTOPY * 100 ELSE 0.0 END), 0.0), '  SET @SQLString = @SQLString + ' ISNULL(SUM(CASE WHEN UPRTRXHist.CHEKDATE BETWEEN ''' + CONVERT(varchar(8), @YDate, 112) + ''' AND ''' + CONVERT(varchar(8), @IN_eDate, 112) + ''' THEN UPRTRXHist.UPRTRXAM ELSE 0.0 END), 0.0), 0.0, 0.0, 0.0  ' END  SET @SQLString = @SQLString + 'FROM '+ @CompanyID +'.dbo.UPR00100 INNER JOIN '+ @CompanyID +'.dbo.UPR00400 ' SET @SQLString = @SQLString + '  ON '+ @CompanyID +'.dbo.UPR00100.EMPLOYID = '+ @CompanyID +'.dbo.UPR00400.EMPLOYID LEFT OUTER JOIN '+ @CompanyID +'.dbo.UPR30300 AS UPRTRXHist' SET @SQLString = @SQLString + '    ON UPRTRXHist.EMPLOYID = '+ @CompanyID +'.dbo.UPR00400.EMPLOYID AND UPRTRXHist.PAYROLCD = '+ @CompanyID +'.dbo.UPR00400.PAYRCORD ' SET @SQLString = @SQLString + 'WHERE UPRTRXHist.PYRLRTYP = 1 AND '  IF @IN_RangeSelect= 1   SET @SQLString = @SQLString + '('+ @CompanyID +'.dbo.UPR00100.EMPLOYID >= ''' + @IN_sEmpID + ''' AND '+ @CompanyID +'.dbo.UPR00100.EMPLOYID <= ''' + @IN_eEmpID + ''') AND '  IF @IN_RangeSelect= 2   SET @SQLString = @SQLString + '('+ @CompanyID +'.dbo.UPR00100.EMPLCLAS >= ''' + @IN_sEmpClassID + ''' AND '+ @CompanyID +'.dbo.UPR00100.EMPLCLAS <= ''' + @IN_eEmpClassID + ''') AND '  IF @IN_RangeSelect= 3   SET @SQLString = @SQLString + '('+ @CompanyID +'.dbo.UPR00100.DEPRTMNT >= ''' + @IN_sDept + ''' AND '+ @CompanyID +'.dbo.UPR00100.DEPRTMNT <= ''' + @IN_eDept + ''') AND '  IF @IN_RangeSelect= 4   SET @SQLString = @SQLString + '('+ @CompanyID +'.dbo.UPR00100.JOBTITLE >= ''' + @IN_sPosition + ''' AND '+ @CompanyID +'.dbo.UPR00100.JOBTITLE <= ''' + @IN_ePosition + ''') AND '  SET @SQLString = @SQLString + '(UPRTRXHist.CHEKDATE BETWEEN ''' + CONVERT(varchar(8), @YDate, 112) + ''' AND ''' + CONVERT(varchar(8), @IN_eDate, 112) + ''') AND ' SET @SQLString = @SQLString + '(UPRTRXHist.YEAR1 >= ' + CAST(@IN_sYear AS CHAR(4)) + ' AND UPRTRXHist.YEAR1 <= ' + CAST(@IN_eYear AS CHAR(4)) + ') AND ' SET @SQLString = @SQLString + 'UPRTRXHist.PAYADVNC = 0.00 ' SET @SQLString = @SQLString + 'GROUP BY UPRTRXHist.PAYROLCD '  EXEC(@SQLString)  return(@@ERROR)   
GO
GRANT EXECUTE ON  [dbo].[uprLoadTempXCmpyPayCodeSummary] TO [DYNGRP]
GO
