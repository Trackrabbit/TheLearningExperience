SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
 CREATE PROCEDURE [dbo].[aagPMRedisplayDists]  @I_VoucherNumber CHAR(21) = '',  @I_SubledgerHrdID CHAR(21) = '',  @O_Updated BIT OUTPUT AS BEGIN DECLARE @PMSeqNumbr INTEGER,  @Rnk1 INTEGER,  @Rnk2 INTEGER,  @aaDistId INTEGER   DECLARE PMCur CURSOR FAST_FORWARD FOR   SELECT DSTSQNUM,RANK() OVER (partition by 1 ORDER BY DISTTYPE, DSTINDX, CRDTAMNT, DEBITAMT,DEX_ROW_ID) FROM PM10100   WHERE VCHRNMBR = @I_VoucherNumber ORDER BY DISTTYPE, DSTINDX, CRDTAMNT, DEBITAMT,DSTSQNUM  OPEN PMCur   FETCH NEXT FROM PMCur into @PMSeqNumbr,@Rnk1  WHILE @@FETCH_STATUS =0  BEGIN  DECLARE AASub CURSOR FAST_FORWARD FOR   SELECT  a.aaSubLedgerDistID,RANK() OVER (partition by 1 ORDER BY a.DISTTYPE,a.ACTINDX,a.CRDTAMNT,a.DEBITAMT,a.DEX_ROW_ID)  FROM AAG20001 a WHERE aaSubLedgerHdrID = @I_SubledgerHrdID ORDER BY a.DISTTYPE,a.ACTINDX,a.CRDTAMNT,a.DEBITAMT  OPEN AASub  FETCH NEXT FROM AASub into @aaDistId,@Rnk2  WHILE @@FETCH_STATUS =0  BEGIN  IF @Rnk1 = @Rnk2   UPDATE AAG20001 SET SEQNUMBR = @PMSeqNumbr WHERE aaSubLedgerHdrID = @I_SubledgerHrdID and aaSubLedgerDistID = @aaDistId   FETCH NEXT FROM AASub INTO @aaDistId,@Rnk2  END  CLOSE AASub  DEALLOCATE AASub  FETCH NEXT FROM PMCur INTO @PMSeqNumbr,@Rnk1  END  CLOSE PMCur  DEALLOCATE PMCur  SET @O_Updated = 1 END    
GO
GRANT EXECUTE ON  [dbo].[aagPMRedisplayDists] TO [DYNGRP]
GO
