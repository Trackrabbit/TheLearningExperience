SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create            procedure [dbo].[aagTODiv]  @SqlSessionID int as  begin  set nocount on   declare @CMPANYID smallint,  @HdrID int,  @DOCTYPE int,  @DOCNUMBR char(21)   select @CMPANYID = CMPANYID from DYNAMICS.dbo.SY01500 where INTERID = DB_NAME()   select @HdrID = dbo.aagGetNextHdrID(20000) - 1    declare  CIV cursor fast_forward for   select IVDOCTYP,IVDOCNBR  from IV10001  group by IVDOCTYP,IVDOCNBR  union   select DOCTYPE,DOCNUMBR  from IV30300  group by DOCTYPE,DOCNUMBR  open CIV  fetch next from CIV into @DOCTYPE,@DOCNUMBR  while @@fetch_status = 0  begin  insert into AAG20000  (aaSubLedgerHdrID,SERIES,DOCTYPE,DOCNUMBR,Master_ID,aaHdrErrors)  values(dbo.aagGetNextHdrID(20000),5,@DOCTYPE,@DOCNUMBR,' ',0)   fetch next from CIV into @DOCTYPE,@DOCNUMBR  end  close CIV  deallocate CIV   update DYNAMICS..AAG00102 set aaRowID = dbo.aagGetNextHdrID(20000) - 1  where aaTableID = 20000 and CMPANYID = @CMPANYID   insert into AAG20001  (aaSubLedgerHdrID,   aaSubLedgerDistID,   INTERID, ACTINDX, DISTTYPE, aaBrowseType,   DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, CURNCYID, CURRNIDX, SEQNUMBR,  GLPOSTDT, aaCustID, POSTED ,RATETPID, EXGTBLID, XCHGRATE,  TIME1,  RTCLCMTD, DENXRATE, MCTRXSTT,aaChangeDate,aaChangeTime,ACCTTYPE)   select dbo.aagGetHdrID(5,IVDOCTYP,IVDOCNBR,' ',0,0, getdate(),0,' ',20000),  DEX_ROW_ID,  DB_NAME(), IVIVINDX, 0, 0,   EXTDCOST, 0, 0, 0, ' ', 0, LNSEQNBR,  '1999-03-06 00:00:00.000', '', 1, ' ', ' ', 0,  0,   0, 0, 0,convert(char(12), getdate(), 102),convert(char(12), getdate(), 108),  dbo.aagGetAccountType(IVIVINDX) from IV10001  union all  select dbo.aagGetHdrID(5,IVDOCTYP,IVDOCNBR,' ',0,0, getdate(),0,' ',20000),  DEX_ROW_ID+ LNSEQNBR+dbo.aagGetHdrID(5,IVDOCTYP,IVDOCNBR,' ',0,0, getdate(),0,' ',20000),  DB_NAME(), IVIVOFIX, 0, 0,   0,EXTDCOST, 0, 0, ' ', 0, LNSEQNBR,  '1999-03-06 00:00:00.000', '', 1, ' ', ' ', 0,  0,   0, 0, 0,convert(char(12), getdate(), 102),convert(char(12), getdate(), 108),  dbo.aagGetAccountType(IVIVOFIX) from IV10001  union all  select dbo.aagGetHdrID(5,DOCTYPE,DOCNUMBR,' ',0,0, getdate(),0,' ',20000),  DEX_ROW_ID,  DB_NAME(), IVIVINDX, 0, 0,   EXTDCOST, 0, 0, 0, ' ', 0, LNSEQNBR,  DOCDATE, '', 1, ' ', ' ', 0,  0,   0, 0, 0,convert(char(12), getdate(), 102),convert(char(12), getdate(), 108),  dbo.aagGetAccountType(IVIVINDX) from IV30300   union all  select dbo.aagGetHdrID(5,DOCTYPE,DOCNUMBR,' ',0,0, getdate(),0,' ',20000),  DEX_ROW_ID+ LNSEQNBR+ dbo.aagGetHdrID(5,DOCTYPE,DOCNUMBR,' ',0,0, getdate(),0,' ',20000),  DB_NAME(), IVIVOFIX, 0, 0,   0,EXTDCOST, 0, 0, ' ', 0, LNSEQNBR,  DOCDATE, '', 1, ' ', ' ', 0,  0,   0, 0, 0,convert(char(12), getdate(), 102),convert(char(12), getdate(), 108),  dbo.aagGetAccountType(IVIVOFIX) from IV30300   Update AAG20001 SET aaSubLedgerDistID=0-aaSubLedgerDistID  where aaSubLedgerHdrID not in (select distinct aaSubLedgerHdrID from AAG20002)  UPDATE AAG20001   SET aaSubLedgerDistID = (SELECT COUNT(1) FROM AAG20001 AA WHERE AAG20001.DEX_ROW_ID >= AA.DEX_ROW_ID AND AA.aaSubLedgerHdrID = AAG20001.aaSubLedgerHdrID )  where AAG20001.aaSubLedgerHdrID not in (select distinct aaSubLedgerHdrID from AAG20002)   insert into AAG20002   (aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID,DEBITAMT,  CRDTAMNT,ORDBTAMT,ORCRDAMT,aaAssignedPercent,DistRef,NOTEINDX,aaAssignErrors)  select aaSubLedgerHdrID,aaSubLedgerDistID,1,DEBITAMT,  CRDTAMNT,ORDBTAMT,ORCRDAMT,10000,' ',0,0 from AAG20001 where aaSubLedgerHdrID in  (select aaSubLedgerHdrID from AAG20000 where SERIES = 5)   set nocount off end    
GO
GRANT EXECUTE ON  [dbo].[aagTODiv] TO [DYNGRP]
GO
