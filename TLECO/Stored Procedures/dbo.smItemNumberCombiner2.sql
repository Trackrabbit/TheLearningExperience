SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
create procedure [dbo].[smItemNumberCombiner2] @I_charStartItem char(31), @I_charEndItem char(31), @cStartItem char(50), @cEndItem char(50), @O_iErrorState int=NULL output with encryption as set transaction isolation level read uncommitted set nocount on declare	@ITEMNMBR char(255), @cStatement varchar(255), @DBNAME	char(25), @DBID char(25), @iStatus int, @iSEQNUMBR int select	@O_iErrorState=0, @ITEMNMBR = '', @cStatement = '', @DBNAME = '', @DBID = '', @iStatus = 0 select @DBNAME=DB_NAME() select @DBID=CMPANYID from DYNAMICS..SY01500 where INTERID=@DBNAME declare ta_INCCursor insensitive CURSOR for select 'update '+o.name+' set ITMNUM='+rtrim(@cEndItem) + ' where ITMNUM='+rtrim(@cStartItem) from sysobjects o, syscolumns c where	o.id=c.id and o.type='U' and c.name='ITMNUM' order by o.name set nocount on OPEN ta_INCCursor FETCH NEXT FROM ta_INCCursor INTO @ITEMNMBR WHILE (@@FETCH_STATUS<>-1) begin exec (@ITEMNMBR) if (@@error<>0) begin select @O_iErrorState=1  break end FETCH NEXT FROM ta_INCCursor INTO @ITEMNMBR end DEALLOCATE ta_INCCursor if (@O_iErrorState<>0) return declare ta_INCCursor insensitive CURSOR for select 'update DYNAMICS..'+o.name+' set Item='+rtrim(@cEndItem) + ' where Item='+rtrim(@cStartItem)+' and CompanyID='+str(@DBID) from DYNAMICS..sysobjects o, DYNAMICS..syscolumns c where o.id=c.id and o.type='U' and c.name='Item' and (o.name='POWarehouse' or o.name='ReqItemList' or o.name='ReqItemListHist') order by o.name set nocount on OPEN ta_INCCursor FETCH NEXT FROM ta_INCCursor INTO @ITEMNMBR WHILE (@@FETCH_STATUS<>-1) begin exec (@ITEMNMBR) if (@@error<>0) begin select @O_iErrorState=2  break end FETCH NEXT FROM ta_INCCursor INTO @ITEMNMBR end DEALLOCATE ta_INCCursor if (@O_iErrorState<>0) return if (exists(select * from sysobjects where id=object_id('dbo.gpItmCus') and sysstat & 0xf=3)) begin update gpItmCus set ITEMNMBR=@I_charEndItem where ITEMNMBR=@I_charStartItem and CUSTNMBR+UOFM not in(select CUSTNMBR+UOFM from gpItmCus where ITEMNMBR=@I_charEndItem) if (@@error<>0) begin select @O_iErrorState=3  return end end if (exists (select * from sysobjects where id=object_id('dbo.PA01901') and sysstat & 0xf=3)) begin update PA01901 set PACOSTOWNER=@I_charEndItem where PACOSTOWNER=@I_charStartItem and PATranType=6 if (@@error<>0) begin select @O_iErrorState=4  return end end if (exists (select * from sysobjects where id=object_id('dbo.PA11800') and sysstat & 0xf=3)) begin update PA11800 set PACOSTOWNER=@I_charEndItem where PACOSTOWNER=@I_charStartItem and PATU=6 if (@@error<>0) begin select @O_iErrorState=5  return end end if (exists (select * from sysobjects where id=object_id('dbo.PA11801') and sysstat & 0xf=3)) begin update PA11801 set PACOSTOWNER=@I_charEndItem where PACOSTOWNER=@I_charStartItem and PATU=6 if (@@error<>0) begin select @O_iErrorState=6  return end end if (exists (select * from sysobjects where id=object_id('dbo.PA13202') and sysstat & 0xf=3)) begin update PA13202 set PACOSTOWNER=@I_charEndItem where PACOSTOWNER=@I_charStartItem and PATU=6 if (@@error<>0) begin select @O_iErrorState=7  return end end if (exists (select * from sysobjects where id=object_id('dbo.PA23203') and sysstat & 0xf=3)) begin update PA23203 set PACOSTOWNER=@I_charEndItem where PACOSTOWNER=@I_charStartItem and PATU=6 if (@@error<>0) begin select @O_iErrorState=8  return end end if (exists (select * from sysobjects where id=object_id('dbo.PA33203') and sysstat & 0xf=3)) begin update PA33203 set PACOSTOWNER=@I_charEndItem where PACOSTOWNER=@I_charStartItem and PATU=6 if (@@error<>0) begin select @O_iErrorState=9  return end end if (exists (select * from sysobjects where id=object_id('dbo.IntSubstituteItems') and sysstat & 0xf=3)) begin update IntSubstituteItems set ITEMNMBR=@I_charEndItem where ITEMNMBR=@I_charStartItem and ALTITEM+cast(ALTTYPE as varchar) not in (select ALTITEM+cast(ALTTYPE as varchar) from IntSubstituteItems where ITEMNMBR=@I_charEndItem) if (@@error<>0) begin select @O_iErrorState=10  return end end if (exists(select * from sysobjects where id=object_id('dbo.SOP60300') and sysstat & 0xf=3)) begin update SOP60300 set ITEMNMBR=@I_charEndItem where ITEMNMBR=@I_charStartItem and CUSTNMBR not in(select CUSTNMBR from SOP60300 where ITEMNMBR=@I_charEndItem) if (@@error<>0) begin select @O_iErrorState=93  return end end select @iSEQNUMBR=isnull(max(SEQNUMBR),0) from IV00401 where ITEMNMBR=@I_charEndItem update IV00401  set ITEMNMBR=@I_charEndItem,  SEQNUMBR = SEQNUMBR + @iSEQNUMBR where ITEMNMBR=@I_charStartItem and SUGITEMNMBR not in(select SUGITEMNMBR from IV00401 where ITEMNMBR=@I_charEndItem) if (exists (select * from sysobjects where id=object_id('dbo.SVC00998') and sysstat & 0xf=3)) begin exec smItemNumberCombinerService @I_charStartItem, @I_charEndItem, @cStartItem, @cEndItem, @O_iErrorState output if (@O_iErrorState<>0) or (@@error<>0) begin select @O_iErrorState=11  return end end if (exists (select * from sysobjects where id=object_id('dbo.WO010032') and sysstat & 0xf=3)) begin exec smItemNumberCombinerMfg @I_charStartItem, @I_charEndItem, @cStartItem, @cEndItem, @O_iErrorState output if (@O_iErrorState<>0) or (@@error<>0) begin select @O_iErrorState=12  return end end return  
GO
GRANT EXECUTE ON  [dbo].[smItemNumberCombiner2] TO [DYNGRP]
GO
