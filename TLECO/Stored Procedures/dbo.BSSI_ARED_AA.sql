SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
CREATE PROCEDURE [dbo].[BSSI_ARED_AA]@JRNENTRY BIGINT,@DEFACTINDX BIGINT,@REVACTINDX BIGINT,@SEQNUMBR NUMERIC(19, 5),@DOCNUMBR CHAR(35),@SERIES CHAR(3),@ROUNDDECIMALS INTASBEGIN	DECLARE @HeaderID NUMERIC(19, 5)	DECLARE @DistID	  NUMERIC(19, 5)	DECLARE @AASERIES INT	DECLARE @SubHeaderID NUMERIC(19, 5)	DECLARE @SubDistID	  NUMERIC(19, 5)	DECLARE @aaGLWorkHdrID NUMERIC(19, 5)	DECLARE @aaGLWorkDistID NUMERIC(19, 5)	DECLARE @aaGLWorkAssignID NUMERIC(19, 5)	DECLARE @TEMPaaGLWorkAssignID NUMERIC(19, 5)	DECLARE @aaAssignErrors BINARY(4)	DECLARE @DEBITAMT NUMERIC(19, 5),			@CRDTAMNT NUMERIC(19, 5),			@ORDBTAMT NUMERIC(19, 5),			@ORCRDAMT NUMERIC(19, 5)	DECLARE @DimExists INT	DECLARE @Count INT	DECLARE @AACount int	DECLARE @ScheduleID varchar(50)	DECLARE @ScheduleSeqNo NUMERIC(19, 5)	DECLARE @ScheduleAA int	SET @AACount = 0	SET @ScheduleAA = 0	SELECT @AASERIES = CASE @SERIES WHEN 'SOP' THEN 11									WHEN 'RM'  THEN 3									WHEN 'PM'  THEN 4									WHEN 'POP' THEN 12									ELSE 0 END	SELECT @ScheduleID = RTRIM(BSSI_RecurringContractID), @ScheduleSeqNo = BSSI_RBLineSeqNumber 	FROM B7110100 	WHERE SOPNUMBE = @DOCNUMBR AND LNITMSEQ = @SEQNUMBR	IF @ScheduleID <> ''	BEGIN		SELECT @ScheduleAA = COUNT(*) FROM B0800041		WHERE PEER_Billing_Schedule_ID = @ScheduleID AND SEQNUMBR = @SEQNUMBR	END	IF @DEFACTINDX <> @REVACTINDX 	BEGIN		SELECT @DimExists = CASE WHEN COUNT(AAG10003.aaTrxDimID) > 0 THEN 1 ELSE 0 END FROM AAG10000 		INNER JOIN AAG10001 ON AAG10001.aaGLWorkHdrID = AAG10000.aaGLWorkHdrID 		INNER JOIN AAG10002 ON AAG10001.aaGLWorkHdrID = AAG10002.aaGLWorkHdrID    						   AND AAG10001.aaGLWorkDistID = AAG10002.aaGLWorkDistID 		INNER JOIN AAG10003 ON AAG10002.aaGLWorkHdrID = AAG10003.aaGLWorkHdrID 						   AND AAG10002.aaGLWorkDistID = AAG10003.aaGLWorkDistID 						   AND AAG10002.aaGLWorkAssignID = AAG10003.aaGLWorkAssignID 		 WHERE JRNENTRY =  @JRNENTRY  AND AAG10001.ACTINDX = @DEFACTINDX		 AND AAG10003.aaTrxDimID IN (SELECT AAG10003.aaTrxDimID FROM AAG10000    									 INNER JOIN AAG10001 ON AAG10001.aaGLWorkHdrID = AAG10000.aaGLWorkHdrID    									 INNER JOIN AAG10002 ON AAG10001.aaGLWorkHdrID = AAG10002.aaGLWorkHdrID    														AND AAG10001.aaGLWorkDistID = AAG10002.aaGLWorkDistID    									 INNER JOIN AAG10003 ON AAG10002.aaGLWorkHdrID = AAG10003.aaGLWorkHdrID    														AND AAG10002.aaGLWorkDistID = AAG10003.aaGLWorkDistID    														AND AAG10002.aaGLWorkAssignID = AAG10003.aaGLWorkAssignID    									  WHERE JRNENTRY =  @JRNENTRY AND AAG10001.ACTINDX = @REVACTINDX)						IF @DimExists = 0 				BEGIN						RETURN				END		END	SELECT @SubHeaderID = aaSubLedgerHdrID FROM AAG20000	WHERE SERIES = @AASERIES AND DOCNUMBR = @DOCNUMBR		IF @SERIES = 'SOP' OR @SERIES = 'POP'	 BEGIN		SELECT @SubDistID = aaSubLedgerDistID FROM AAG20001 		WHERE aaSubLedgerHdrID = @SubHeaderID AND ACTINDX = @DEFACTINDX		SELECT @Count = COUNT(*) 		FROM AAG20002		WHERE aaSubLedgerHdrID = @SubHeaderID AND aaSubLedgerDistID = @SubDistID		  AND CASE WHEN @SERIES IN ('SOP', 'POP') THEN AAG20002.DistRef ELSE '1' END = CASE WHEN @SERIES IN ('SOP', 'POP') 			THEN @SEQNUMBR ELSE '1' END		IF @Count = 0 		BEGIN			RETURN		END	 END	ELSE	 BEGIN	 	SELECT @SubDistID = aaSubLedgerDistID FROM AAG20001		WHERE aaSubLedgerHdrID = @SubHeaderID AND ACTINDX = @DEFACTINDX AND SEQNUMBR = @SEQNUMBR	 END	SELECT @HeaderID = aaGLWorkHdrID FROM AAG10000	WHERE JRNENTRY = @JRNENTRY		SELECT @DistID = aaGLWorkDistID FROM AAG10001	WHERE aaGLWorkHdrID = @HeaderID AND ACTINDX = @REVACTINDX	SELECT * INTO #BSSI_AAG10002 FROM AAG10002	WHERE aaGLWorkHdrID = @HeaderID AND aaGLWorkDistID = @DistID	DECLARE BSSI_GLAssignCursor 	CURSOR FOR SELECT aaGLWorkHdrID, aaGLWorkDistID, aaGLWorkAssignID, DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, aaAssignErrors FROM #BSSI_AAG10002			   ORDER BY aaGLWorkDistID, aaGLWorkAssignID		OPEN BSSI_GLAssignCursor	FETCH NEXT FROM BSSI_GLAssignCursor 	INTO @aaGLWorkHdrID, @aaGLWorkDistID, @aaGLWorkAssignID, @DEBITAMT, @CRDTAMNT, @ORDBTAMT, @ORCRDAMT, @aaAssignErrors		WHILE @@FETCH_STATUS = 0	BEGIN		DELETE FROM AAG10002 		WHERE aaGLWorkHdrID = @aaGLWorkHdrID 		  AND aaGLWorkDistID = @aaGLWorkDistID 		  AND aaGLWorkAssignID = @aaGLWorkAssignID		SELECT @AACount = COUNT(*) FROM AAG20002		WHERE aaSubLedgerHdrID = @SubHeaderID AND aaSubLedgerDistID = @SubDistID		  AND CASE WHEN @SERIES IN ('SOP', 'POP') THEN AAG20002.DistRef ELSE '1' END = CASE WHEN @SERIES IN ('SOP', 'POP') THEN @SEQNUMBR ELSE '1' END		IF @ScheduleID = '' OR @ScheduleAA = 0		BEGIN			INSERT INTO AAG10002			SELECT aaGLWorkHdrID = @aaGLWorkHdrID, aaGLWorkDistID = @aaGLWorkDistID, aaGLWorkAssignID = AAG20002.aaSubLedgerAssignID, 				   DEBITAMT = ROUND(@DEBITAMT * ((CASE WHEN @SERIES IN ('SOP', 'POP') THEN (10000/@AACount) ELSE AAG20002.aaAssignedPercent END) * 1.0/10000), @ROUNDDECIMALS), 				   CRDTAMNT = ROUND(@CRDTAMNT * ((CASE WHEN @SERIES IN ('SOP', 'POP') THEN (10000/@AACount) ELSE AAG20002.aaAssignedPercent END) * 1.0/10000), @ROUNDDECIMALS), 				   ORDBTAMT = ROUND(@ORDBTAMT * ((CASE WHEN @SERIES IN ('SOP', 'POP') THEN (10000/@AACount) ELSE AAG20002.aaAssignedPercent END) * 1.0/10000), @ROUNDDECIMALS), 				   ORCRDAMT = ROUND(@ORCRDAMT * ((CASE WHEN @SERIES IN ('SOP', 'POP') THEN (10000/@AACount) ELSE AAG20002.aaAssignedPercent END) * 1.0/10000), @ROUNDDECIMALS),				   aaAssignedPercent = CASE WHEN @SERIES IN ('SOP', 'POP') THEN (10000/@AACount) ELSE AAG20002.aaAssignedPercent END, AAG20002.DistRef, 0, 				   aaAssignErrors = @aaAssignErrors, AAG20002.aaAliasID, DEX_ROW_TS = GETDATE()			FROM AAG20002			WHERE aaSubLedgerHdrID = @SubHeaderID AND aaSubLedgerDistID = @SubDistID			  AND CASE WHEN @SERIES IN ('SOP', 'POP') THEN AAG20002.DistRef ELSE '1' END = CASE WHEN @SERIES IN ('SOP', 'POP') THEN @SEQNUMBR ELSE '1' END		END		ELSE		BEGIN			INSERT INTO AAG10002			SELECT aaGLWorkHdrID = @aaGLWorkHdrID, aaGLWorkDistID = @aaGLWorkDistID, 					aaGLWorkAssignID = ROW_NUMBER() OVER (ORDER BY B0800041.PEER_Billing_Schedule_ID, B0800041.SEQNUMBR, B0800041.LNITMSEQ), 					DEBITAMT = ROUND(@DEBITAMT * (B0800041.BSSI_aaAssignedPercent * 1.0/10000), @ROUNDDECIMALS),					CRDTAMNT = ROUND(@CRDTAMNT * (B0800041.BSSI_aaAssignedPercent * 1.0/10000), @ROUNDDECIMALS), 					ORDBTAMT = ROUND(@ORDBTAMT * (B0800041.BSSI_aaAssignedPercent * 1.0/10000), @ROUNDDECIMALS), 					ORCRDAMT = ROUND(@ORCRDAMT * (B0800041.BSSI_aaAssignedPercent * 1.0/10000), @ROUNDDECIMALS),					aaAssignedPercent = B0800041.BSSI_aaAssignedPercent, 					B0800041.DistRef, 0, aaAssignErrors = @aaAssignErrors, B0800041.BSSI_aaAliasID,					DEX_ROW_TS = GETDATE()			FROM B0800041			WHERE PEER_Billing_Schedule_ID = @ScheduleID AND SEQNUMBR = @SEQNUMBR		END			SELECT @TEMPaaGLWorkAssignID = MAX(aaGLWorkAssignID) FROM AAG10002 			WHERE AAG10002.aaGLWorkHdrID = @aaGLWorkHdrID AND AAG10002.aaGLWorkDistID = @aaGLWorkDistID			UPDATE AAG10002 SET DEBITAMT = DEBITAMT - X.DBDiff,								CRDTAMNT = CRDTAMNT - X.CRDiff,								ORDBTAMT = ORDBTAMT - X.ORDBDiff,								ORCRDAMT = ORCRDAMT - X.ORCRDiff 			FROM  			(SELECT aaGLWorkHdrID, aaGLWorkDistID,					DBDiff = SUM(DEBITAMT) - @DEBITAMT, 					CRDiff = SUM(CRDTAMNT) - @CRDTAMNT, 					ORDBDiff = SUM(ORDBTAMT) - @ORDBTAMT, 					ORCRDiff = SUM(ORCRDAMT) - @ORCRDAMT 			 FROM AAG10002			 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID = @aaGLWorkDistID			 GROUP BY aaGLWorkHdrID, aaGLWorkDistID) X 			WHERE AAG10002.aaGLWorkHdrID = @aaGLWorkHdrID AND AAG10002.aaGLWorkDistID = @aaGLWorkDistID AND AAG10002.aaGLWorkAssignID = @TEMPaaGLWorkAssignID 		DELETE FROM AAG10003 		WHERE aaGLWorkHdrID = @aaGLWorkHdrID 		  AND aaGLWorkDistID = @aaGLWorkDistID 		  AND aaGLWorkAssignID = @aaGLWorkAssignID		  AND aaTrxDimID IN (SELECT AAG20003.aaTrxDimID							 FROM AAG20003							 WHERE AAG20003.aaSubLedgerHdrID = @SubHeaderID AND AAG20003.aaSubLedgerDistID = @SubDistID)		IF @ScheduleID = '' OR @ScheduleAA = 0		BEGIN			INSERT INTO AAG10003			SELECT aaGLWorkHdrID = @aaGLWorkHdrID, aaGLWorkDistID = @aaGLWorkDistID, aaGLWorkAssignID = AAG20002.aaSubLedgerAssignID,				AAG20003.aaTrxDimID, AAG20003.aaTrxCodeID, AAG20003.aaCodeErrors, DEX_ROW_TS = GETDATE()			FROM AAG20003			INNER JOIN AAG20002 ON AAG20002.aaSubLedgerHdrID = AAG20003.aaSubLedgerHdrID							   AND AAG20002.aaSubLedgerDistID = AAG20003.aaSubLedgerDistID							   AND AAG20002.aaSubLedgerAssignID = AAG20003.aaSubLedgerAssignID			WHERE AAG20003.aaSubLedgerHdrID = @SubHeaderID AND AAG20003.aaSubLedgerDistID = @SubDistID			  AND AAG20003.aaTrxDimID IN (SELECT aaTrxDimID FROM AAG00202 WHERE aaAcctClassID IN (SELECT aaAcctClassID FROM AAG00200 WHERE ACTINDX = @REVACTINDX))				AND CASE WHEN @SERIES IN ('SOP', 'POP') THEN AAG20002.DistRef ELSE '1' END = CASE WHEN @SERIES IN ('SOP', 'POP') THEN @SEQNUMBR ELSE '1' END		END		ELSE		BEGIN			INSERT INTO AAG10003			SELECT aaGLWorkHdrID = @aaGLWorkHdrID, aaGLWorkDistID = @aaGLWorkDistID, 				aaGLWorkAssignID = B0800042.LNITMSEQ/16384,				B0800042.BSSI_aaTrxDimID, BSSI_aaTrxCodeID,CONVERT(VARBINARY(MAX),''), DEX_ROW_TS = GETDATE()			FROM B0800042			WHERE B0800042.PEER_Billing_Schedule_ID = @ScheduleID AND B0800042.SEQNUMBR = @ScheduleSeqNo			  AND B0800042.BSSI_aaTrxDimID IN (SELECT aaTrxDimID FROM AAG00202 WHERE aaAcctClassID IN (SELECT aaAcctClassID FROM AAG00200 WHERE ACTINDX = @REVACTINDX))		END		INSERT INTO AAG10003		SELECT aaGLWorkHdrID = @aaGLWorkHdrID, aaGLWorkDistID = AAG10003.aaGLWorkDistID, aaGLWorkAssignID = AAG20002.aaSubLedgerAssignID,			AAG10003.aaTrxDimID, AAG10003.aaTrxCodeID, AAG10003.aaCodeErrors, DEX_ROW_TS = GETDATE()		FROM AAG20002		LEFT JOIN AAG10003 ON AAG10003.aaGLWorkHdrID = @aaGLWorkHdrID						   AND AAG10003.aaGLWorkDistID = @aaGLWorkDistID						   AND AAG10003.aaGLWorkAssignID = 1		WHERE AAG20002.aaSubLedgerHdrID = @SubHeaderID AND AAG20002.aaSubLedgerDistID = @SubDistID		  AND CONVERT(VARCHAR(MAX), AAG10003.aaTrxDimID)+'-'+CONVERT(VARCHAR(MAX), AAG20002.aaSubLedgerAssignID) NOT IN 			(SELECT CONVERT(VARCHAR(MAX), AAG10003.aaTrxDimID)+'-'+CONVERT(VARCHAR(MAX), AAG10003.aaGLWorkAssignID) 			FROM AAG10003 WHERE AAG10003.aaGLWorkHdrID = @aaGLWorkHdrID AND AAG10003.aaGLWorkDistID = @aaGLWorkDistID)			AND CASE WHEN @SERIES IN ('SOP', 'POP') THEN AAG20002.DistRef ELSE '1' END = CASE WHEN @SERIES IN ('SOP', 'POP') THEN @SEQNUMBR ELSE '1' END		FETCH NEXT FROM BSSI_GLAssignCursor 		INTO @aaGLWorkHdrID, @aaGLWorkDistID, @aaGLWorkAssignID, @DEBITAMT, @CRDTAMNT, @ORDBTAMT, @ORCRDAMT, @aaAssignErrors	END	CLOSE BSSI_GLAssignCursor	DEALLOCATE BSSI_GLAssignCursor	END 
GO
GRANT EXECUTE ON  [dbo].[BSSI_ARED_AA] TO [DYNGRP]
GO
