SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE procedure [dbo].[SVC_RMA_UpdateProcessLine] (  @RecType smallint,  @RMA char(15),  @Line numeric(19,5),  @CMPNTSEQ int = 0 ) as declare @ProcessLine Numeric(19,5) declare @DocNumber char(31) declare @DocLine numeric (19,5) declare @Bin char(21) declare @ProcessType smallint declare @ReturnItem char(31) declare @ReturnSerial char(21) declare @ReturnEquip int declare @LotSeq int declare @LocationCode char(11) declare @Qty numeric(19,5) declare @CustomerOwned tinyint declare @ItemTrack int declare @DateRec datetime,@MfgDate datetime,@ExpDate datetime declare @DateSEQ numeric(19,5), @IVDateSEQ numeric(19,5) declare @RTVrouting smallint, @RTVType char(11), @UoM char(8), @QtyInBase numeric(19,5) declare @QtyType smallint  delete from SVC05210 where RETDOCID = @RMA and Return_Record_Type = @RecType and LNSEQNBR = @Line and CMPNTSEQ = @CMPNTSEQ  and Return_Disposition_Statu = 0 and SVC_Document_Number = '' declare Process_Line cursor for select SVC_Process_SEQ_Number, SVC_Document_Number, SVC_IV_SEQ_Number,  SVC_Process_Type, SLTSQNUM, SVC_Process_QTY, QTYTYPE from SVC05210   where RETDOCID = @RMA and Return_Record_Type = @RecType and LNSEQNBR = @Line and CMPNTSEQ = @CMPNTSEQ and SVC_Process_Type > 0 open Process_Line  fetch next from Process_Line into @ProcessLine, @DocNumber, @DocLine, @ProcessType, @LotSeq, @Qty, @QtyType while @@FETCH_STATUS = 0  Begin  if @LotSeq > 0   select @ReturnItem = Return_Item_Number, @ReturnSerial = Return_Serial_Number, @QtyType= QTYTYPE,  @ReturnEquip = Return_Equipment_ID, @Bin = BIN from SVC05255   where RETDOCID = @RMA and Return_Record_Type = @RecType and LNSEQNBR = @Line and SLTSQNUM = @LotSeq  else  begin  if exists(select * from SVC05212 where RETDOCID = @RMA and Return_Record_Type = @RecType and LNSEQNBR = @Line and CMPNTSEQ = @CMPNTSEQ)  select @ReturnItem = ITEMNMBR, @Bin = BIN, @QtyType = QTYTYPE from SVC05212 where RETDOCID = @RMA and Return_Record_Type = @RecType and LNSEQNBR = @Line and CMPNTSEQ = @CMPNTSEQ  else  select @ReturnItem = Return_Item_Number from SVC05200 where RETDOCID = @RMA and Return_Record_Type = @RecType and LNSEQNBR = @Line and svcRMAComponentSeq = @CMPNTSEQ  end   if @ProcessType = 4  begin  exec SVC_Copy_WO 1, @DocNumber, 2, 0  select @Bin = isnull(@Bin,'')  update SVC06100 set BIN = @Bin, QTYTYPE = @QtyType where WORECTYPE = 2 and WORKORDNUM = @DocNumber  update SVC05210 set SVC_Process_Type = 5, QTYTYPE = @QtyType where RETDOCID = @RMA and   Return_Record_Type = @RecType and LNSEQNBR = @Line and SVC_Process_SEQ_Number = @ProcessLine and CMPNTSEQ = @CMPNTSEQ  end  if @ProcessType > 3  begin  select @CustomerOwned = CUSTOWN, @LocationCode = LOCNCODE  from SVC06100 where WORECTYPE = 2 and WORKORDNUM = @DocNumber  if @CustomerOwned = 0 and @QtyType = 1  begin   exec SVC_Allocate_Quantity @ReturnItem, @LocationCode, @Qty  if @ReturnSerial > ''  select @ItemTrack = ITMTRKOP from IV00101 where ITEMNMBR = @ReturnItem  if @ItemTrack = 2  Begin  update IV00200 set SERLNSLD  = 1 where   ITEMNMBR = @ReturnItem and SERLNMBR = @ReturnSerial  End  if @ItemTrack = 3      Begin  select @DateRec = DATERECD, @DateSEQ = DTSEQNUM, @MfgDate= MFGDATE,  @ExpDate = EXPNDATE from SVC05255  where Return_Record_Type = @RecType and RETDOCID = @RMA and LNSEQNBR = @Line and CMPNTSEQ = @CMPNTSEQ  and QTYTYPE = 1 and SLTSQNUM = @LotSeq and Return_Serial_Number = @ReturnSerial  update IV00300 set ATYALLOC = ATYALLOC + @Qty, @IVDateSEQ = DTSEQNUM where  ITEMNMBR = @ReturnItem and LOTNUMBR = @ReturnSerial and LOCNCODE = @LocationCode  and DATERECD = @DateRec   insert into SVC06120 values(2,@DocNumber,'D',1,1,@Qty,@ReturnSerial,0,@DateRec,@IVDateSEQ,  0.0,@ReturnItem,' ',0,0,0,@Bin,@MfgDate,@ExpDate, 0)  if @IVDateSEQ <> @DateSEQ  update SVC05255 set DTSEQNUM = @IVDateSEQ  where Return_Record_Type = @RecType and RETDOCID = @RMA and LNSEQNBR = @Line and CMPNTSEQ = @CMPNTSEQ  and QTYTYPE = 1 and SLTSQNUM = @LotSeq and Return_Serial_Number = @ReturnSerial  End  if (select ENABLEMULTIBIN from IV40100) = 1  update IV00112 set ATYALLOC = ATYALLOC + @Qty where  ITEMNMBR = @ReturnItem and LOCNCODE =@LocationCode and BIN = @Bin and QTYTYPE = 1  end  end  else if @ProcessType = 2  BEGIN  select @LocationCode = Return_Location_Code, @UoM = UOFM  from SVC05200 where RETDOCID = @RMA and Return_Record_Type = @RecType and LNSEQNBR = @Line  exec SVC_Get_QtyInBase @ReturnItem,@UoM,1,@QtyInBase OUTPUT   select @RTVType = RTV_Type from SVC05601 where RTV_Number = @DocNumber and RTV_Line = @DocLine  select @RTVrouting = RTV_Routing from SVC05003 where RTV_Type = @RTVType  if @RTVrouting <> 3 and @QtyType = 1  exec SVC_Allocate_Quantity @ReturnItem, @LocationCode, @Qty  if @QtyType = 1   begin  select @ItemTrack = ITMTRKOP from IV00101 where ITEMNMBR = @ReturnItem  if @ItemTrack = 2  Begin  update IV00200 set SERLNSLD  = 1 where   ITEMNMBR = @ReturnItem and SERLNMBR = @ReturnSerial  End  if @ItemTrack = 3   Begin  select @DateRec = DATERECD, @DateSEQ = DTSEQNUM, @MfgDate= MFGDATE,  @ExpDate = EXPNDATE from SVC05255  where Return_Record_Type = @RecType and RETDOCID = @RMA and LNSEQNBR = @Line and CMPNTSEQ = @CMPNTSEQ  and QTYTYPE = 1 and SLTSQNUM = @LotSeq and Return_Serial_Number = @ReturnSerial  update IV00300 set ATYALLOC = ATYALLOC + @Qty, @IVDateSEQ = DTSEQNUM where  ITEMNMBR = @ReturnItem and LOTNUMBR = @ReturnSerial and LOCNCODE = @LocationCode  and DATERECD = @DateRec   if exists(select * from SVC05602 where RTV_Number = @DocNumber and RTV_Line = @DocLine and ITEMNMBR =@ReturnItem and SERLNMBR=@ReturnSerial and Shipped = 0)  update SVC05602 set DTSEQNUM = @IVDateSEQ, DATERECD = @DateRec  where RTV_Number = @DocNumber and RTV_Line = @DocLine and ITEMNMBR =@ReturnItem and SERLNMBR=@ReturnSerial and Shipped = 0  if @IVDateSEQ <> @DateSEQ  update SVC05255 set DTSEQNUM = @IVDateSEQ  where Return_Record_Type = @RecType and RETDOCID = @RMA and LNSEQNBR = @Line and CMPNTSEQ = @CMPNTSEQ  and QTYTYPE = 1 and SLTSQNUM = @LotSeq and Return_Serial_Number = @ReturnSerial  End  end  if (select ENABLEMULTIBIN from IV40100) = 1 and @QtyType = 1  update IV00112 set ATYALLOC = ATYALLOC + @Qty where  ITEMNMBR = @ReturnItem and LOCNCODE =@LocationCode and BIN = @Bin and QTYTYPE = 1  END  fetch next from Process_Line into @ProcessLine, @DocNumber, @DocLine, @ProcessType, @LotSeq, @Qty, @QtyType  End deallocate Process_Line   return    
GO
GRANT EXECUTE ON  [dbo].[SVC_RMA_UpdateProcessLine] TO [DYNGRP]
GO
