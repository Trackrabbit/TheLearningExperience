SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[seeUPRTimecards]  @i_AS_EMPLOYID char(15),  @sdate datetime,  @edate datetime,  @team tinyint  as  DECLARE   @SORTBY char(15),  @HISTORY tinyint = 0,  @MY_DEX_ROW int,  @O_SQL_Error_State int= NULL  If OBJECT_ID('tempdb..#TIMECARDS') is  NULL  Begin  CREATE TABLE #TIMECARDS (  EMPLOYID char(15) not null default '',  Supervisor_Employee_ID char(15) not null default '',  FRSTNAME char(15) not null default '',  LASTNAME char(21) not null default '',  MIDLNAME char(15) not null default '',  EMPLSUFF char(5) not null default '',  STRTDATE datetime not null default '01/01/1900',  ENDDATE datetime not null default '01/01/1900',  PayCode char(7) not null default '',  PAYDSCRIPTN char(31) not null default '',  TRXDATE datetime not null default '01/01/1900',  TRXDOW char(4) not null default '',  JOBTITLE char(7) not null default '',  POSDESCRIPTN char(31) not null default '',  DEPRTMNT char(7) not null default '',  DEPTDSCRIPTN char(31) not null default '',  STATECD char(3) not null default '',  STATENAM char(21) not null default '',  LOCALTAX char(7) not null default '',  LTDSCRIPTN char(31) not null default '',  SHFTCODE char(7) not null default '',  SHIFTDESCRIPTN char(31) not null default '',  DAYSWRDK int not null default 0,  WKSWRKD int not null default 0,  UNTSTOPY numeric(19,5) not null default 0.00,  CMMTTEXT text not null default '',  HISTORICAL tinyint not null default 0,  MY_DEX_ROW int Identity (1,1) ) End  DELETE #TIMECARDS  If OBJECT_ID('tempdb..#REPORTSTO') is  NULL  Begin  CREATE TABLE #REPORTSTO (  EMPLOYID char(15) not null default '',  Supervisor_Employee_ID char(15) not null default '',  LVLLABEL char(20) not null default '',  Group_ID int not null default 0,  LASTNAME char(21) not null default '',  FRSTNAME char(15) not null default '',  MIDLNAME char(15) not null default '',  EMPLSUFF char(5) not null default '',  USERID char(15) not null default '',  SUPERVISORCODE_I char(7) not null default '',  SUPERVISOR char(31) not null default '',  PHONE1 char(21) not null default '',  PHONE2 char(21) not null default '',  Supervisor_Last_Name char(21) not null default '',  Supervisor_First_Name char(15) not null default '',  Supervisor_Middle_Name char(15) not null default '',  MY_DEX_ROW int Identity (1,1) ) End  DELETE #REPORTSTO exec UPR_SetReportsToStructureForList '#REPORTSTO', 0, @i_AS_EMPLOYID, @O_SQL_Error_State  INSERT INTO #TIMECARDS (  EMPLOYID,  Supervisor_Employee_ID,  FRSTNAME,  LASTNAME,  MIDLNAME,  EMPLSUFF,  STRTDATE,  ENDDATE,  PayCode,  PAYDSCRIPTN,  TRXDATE,  TRXDOW,  JOBTITLE,  POSDESCRIPTN,  DEPRTMNT,  DEPTDSCRIPTN,  STATECD,  STATENAM,  LOCALTAX,  LTDSCRIPTN,  SHFTCODE,  SHIFTDESCRIPTN,  DAYSWRDK,  WKSWRKD,  UNTSTOPY,  CMMTTEXT,  HISTORICAL ) SELECT TCD.EMPLOYID, REP.Supervisor_Employee_ID,  EE.FRSTNAME, EE.LASTNAME, EE.MIDLNAME, EE.EMPLSUFF,   PSD.STRTDATE, PSD.ENDDATE,  TCD.PayCode, PAY.DSCRIPTN AS PAYDSCRIPTN, TCD.TRXDATE, LEFT(datename(dw, TCD.TRXDATE),3) AS TRXDOW,   TCD.JOBTITLE, POS.DSCRIPTN AS POSDESCRIPTN, TCD.DEPRTMNT, DEPT.DSCRIPTN AS DEPTDSCRIPTN, TCD.STATECD, ISNULL(ST.STATENAM, '') AS STATENAM, TCD.LOCALTAX, ISNULL(LT.DSCRIPTN, '') AS LTDSCRIPTN,  TCD.SHFTCODE, ISNULL(SHFT.DSCRIPTN, '') AS SHIFTDESCRIPTN, TCD.DAYSWRDK, TCD.WKSWRKD, TCD.UNTSTOPY, TCD.CMMTTEXT, 0 AS HISTORICAL FROM UPR10501 TCD INNER JOIN UPR10500 TC ON TC.EMPLOYID = TCD.EMPLOYID AND TC.Pay_Schedule = TCD.Pay_Schedule AND TC.YEAR1 = TCD.YEAR1 AND TC.PERIODID = TCD.PERIODID INNER JOIN UPR00100 EE ON EE.EMPLOYID = TCD.EMPLOYID INNER JOIN UPR42101 PSD ON PSD.Pay_Schedule = TCD.Pay_Schedule AND PSD.YEAR1 = TCD.YEAR1 AND PSD.PERIODID = TCD.PERIODID INNER JOIN UPR40600 PAY ON PAY.PAYRCORD = TCD.PayCode INNER JOIN UPR40300 DEPT ON DEPT.DEPRTMNT = TCD.DEPRTMNT INNER JOIN UPR40301 POS ON POS.JOBTITLE = TCD.JOBTITLE INNER JOIN #REPORTSTO REP ON REP.EMPLOYID = TC.EMPLOYID LEFT JOIN UPR41100 ST ON ST.STATECD = TCD.STATECD LEFT JOIN UPR41400 LT ON LT.LOCALTAX = TCD.LOCALTAX LEFT JOIN UPR41500 SHFT ON SHFT.SHFTCODE = TCD.SHFTCODE  INSERT INTO #TIMECARDS (  EMPLOYID,  Supervisor_Employee_ID,  FRSTNAME,  LASTNAME,  MIDLNAME,  EMPLSUFF,  STRTDATE,  ENDDATE,  PayCode,  PAYDSCRIPTN,  TRXDATE,  TRXDOW,  JOBTITLE,  POSDESCRIPTN,  DEPRTMNT,  DEPTDSCRIPTN,  STATECD,  STATENAM,  LOCALTAX,  LTDSCRIPTN,  SHFTCODE,  SHIFTDESCRIPTN,  DAYSWRDK,  WKSWRKD,  UNTSTOPY,  CMMTTEXT,  HISTORICAL ) SELECT TCD.EMPLOYID, REP.Supervisor_Employee_ID,  EE.FRSTNAME, EE.LASTNAME, EE.MIDLNAME, EE.EMPLSUFF,   PSD.STRTDATE, PSD.ENDDATE,  TCD.PayCode, PAY.DSCRIPTN AS PAYDSCRIPTN, TCD.TRXDATE, LEFT(datename(dw, TCD.TRXDATE),3) AS TRXDOW,   TCD.JOBTITLE, POS.DSCRIPTN AS POSDESCRIPTN, TCD.DEPRTMNT, DEPT.DSCRIPTN AS DEPTDSCRIPTN, TCD.STATECD, ISNULL(ST.STATENAM, '') AS STATENAM, TCD.LOCALTAX, ISNULL(LT.DSCRIPTN, '') AS LTDSCRIPTN,  TCD.SHFTCODE, ISNULL(SHFT.DSCRIPTN, '') AS SHIFTDESCRIPTN, TCD.DAYSWRDK, TCD.WKSWRKD, TCD.UNTSTOPY, TCD.CMMTTEXT, 1 AS HISTORICAL FROM UPR30501 TCD INNER JOIN UPR30500 TC ON TC.EMPLOYID = TCD.EMPLOYID AND TC.Pay_Schedule = TCD.Pay_Schedule AND TC.YEAR1 = TCD.YEAR1 AND TC.PERIODID = TCD.PERIODID INNER JOIN UPR00100 EE ON EE.EMPLOYID = TCD.EMPLOYID INNER JOIN UPR42101 PSD ON PSD.Pay_Schedule = TCD.Pay_Schedule AND PSD.YEAR1 = TCD.YEAR1 AND PSD.PERIODID = TCD.PERIODID INNER JOIN UPR40600 PAY ON PAY.PAYRCORD = TCD.PayCode INNER JOIN UPR40300 DEPT ON DEPT.DEPRTMNT = TCD.DEPRTMNT INNER JOIN UPR40301 POS ON POS.JOBTITLE = TCD.JOBTITLE INNER JOIN #REPORTSTO REP ON REP.EMPLOYID = TC.EMPLOYID LEFT JOIN UPR41100 ST ON ST.STATECD = TCD.STATECD LEFT JOIN UPR41400 LT ON LT.LOCALTAX = TCD.LOCALTAX LEFT JOIN UPR41500 SHFT ON SHFT.SHFTCODE = TCD.SHFTCODE  INSERT INTO #TIMECARDS (  EMPLOYID,  Supervisor_Employee_ID,  FRSTNAME,  LASTNAME,  MIDLNAME,  EMPLSUFF,  STRTDATE,  ENDDATE,  PayCode,  PAYDSCRIPTN,  TRXDATE,  TRXDOW,  JOBTITLE,  POSDESCRIPTN,  DEPRTMNT,  DEPTDSCRIPTN,  STATECD,  STATENAM,  LOCALTAX,  LTDSCRIPTN,  SHFTCODE,  SHIFTDESCRIPTN,  DAYSWRDK,  WKSWRKD,  UNTSTOPY,  CMMTTEXT,  HISTORICAL ) SELECT A.EMPLOYID, A.Supervisor_Employee_ID,A.FRSTNAME, A.LASTNAME, A.MIDLNAME, A.EMPLSUFF, A.STRTDATE, A.ENDDATE, A.PayCode, A.PAYDSCRIPTN, A.TRXDATE, A.TRXDOW, A.JOBTITLE, A.POSDESCRIPTN, A.DEPRTMNT, A.DEPTDSCRIPTN, A.STATECD, A.STATENAM, A.LOCALTAX, A.LTDSCRIPTN,  A.SHFTCODE, A.SHIFTDESCRIPTN, A.DAYSWRDK, A.WKSWRKD, A.UNTSTOPY, B.CMMTTEXT, A.HISTORICAL FROM (  SELECT MAX(EE.EMPLOYID) AS EMPLOYID, MAX(REP.Supervisor_Employee_ID) AS Supervisor_Employee_ID, MAX(TCD.Pay_Schedule) AS Pay_Schedule, MAX(TCD.YEAR1) AS YEAR1, MAX(TCD.PERIODID) AS PERIODID,  MAX(EE.FRSTNAME) AS FRSTNAME, MAX(EE.LASTNAME) AS LASTNAME, MAX(EE.MIDLNAME) AS MIDLNAME, MAX(EE.EMPLSUFF) AS EMPLSUFF,   MAX(PSD.STRTDATE) AS STRTDATE, MAX(PSD.ENDDATE) AS ENDDATE,  MAX(TCD.PayCode) AS PayCode, MAX(PAY.DSCRIPTN) AS PAYDSCRIPTN, MAX(TCD.TRXDATE) AS TRXDATE, LEFT(datename(dw, MAX(TCD.TRXDATE)),3) AS TRXDOW,   MAX(TCD.JOBTITLE) AS JOBTITLE, MAX(POS.DSCRIPTN) AS POSDESCRIPTN, MAX(TCD.DEPRTMNT) AS DEPRTMNT, MAX(DEPT.DSCRIPTN) AS DEPTDSCRIPTN,   MAX(TCD.STATECD) AS STATECD, ISNULL(MAX(ST.STATENAM), '') AS STATENAM, MAX(TCD.LOCALTAX) AS LOCALTAX, ISNULL(MAX(LT.DSCRIPTN), '') AS LTDSCRIPTN,  MAX(TCD.SHFTCODE) AS SHFTCODE, ISNULL(MAX(SHFT.DSCRIPTN), '') AS SHIFTDESCRIPTN, MAX(TCD.DAYSWRDK) AS DAYSWRDK, MAX(TCD.WKSWRKD) AS WKSWRKD, MAX(TCD.UNTSTOPY) AS UNTSTOPY, 0 AS HISTORICAL  FROM UPR10501 TCD  INNER JOIN UPR10500 TC ON TC.EMPLOYID = TCD.EMPLOYID AND TC.Pay_Schedule = TCD.Pay_Schedule AND TC.YEAR1 = TCD.YEAR1 AND TC.PERIODID = TCD.PERIODID  INNER JOIN UPR42101 PSD ON PSD.Pay_Schedule = TCD.Pay_Schedule AND PSD.YEAR1 = TCD.YEAR1 AND PSD.PERIODID = TCD.PERIODID  INNER JOIN UPR40600 PAY ON PAY.PAYRCORD = TCD.PayCode  INNER JOIN UPR40300 DEPT ON DEPT.DEPRTMNT = TCD.DEPRTMNT  INNER JOIN UPR40301 POS ON POS.JOBTITLE = TCD.JOBTITLE  INNER JOIN UPR00100 EE ON EE.EMPLOYID = TCD.EMPLOYID  LEFT JOIN #REPORTSTO REP ON REP.EMPLOYID = TC.EMPLOYID  LEFT JOIN UPR41100 ST ON ST.STATECD = TCD.STATECD  LEFT JOIN UPR41400 LT ON LT.LOCALTAX = TCD.LOCALTAX  LEFT JOIN UPR41500 SHFT ON SHFT.SHFTCODE = TCD.SHFTCODE  LEFT JOIN UPR00201 TOBDEPT ON TOBDEPT.DEPRTMNT = EE.DEPRTMNT  LEFT JOIN UPR00202 TOBCLASS ON TOBCLASS.EMPLCLAS = EE.EMPLCLAS  LEFT JOIN UPR00203 TOBEMP ON TOBEMP.Employee_ID_Assigned = EE.EMPLOYID  LEFT JOIN UPR41700 SUP ON EE.SUPERVISORCODE_I = SUP.SUPERVISORCODE_I  LEFT JOIN UPR00100 EESUP ON SUP.EMPLOYID = EESUP.EMPLOYID  LEFT JOIN UPR00200 TOBHDR ON TOBDEPT.Time_on_Behalf_Code = TOBHDR.Time_on_Behalf_Code OR TOBCLASS.Time_on_Behalf_Code = TOBHDR.Time_on_Behalf_Code   OR TOBEMP.Time_on_Behalf_Code = TOBEMP.Time_on_Behalf_Code OR   TOBHDR.Admin_Code = 1  WHERE REP.EMPLOYID IS NOT NULL AND   ((TOBDEPT.DEPRTMNT IS NOT NULL OR TOBCLASS.EMPLCLAS IS NOT NULL OR TOBEMP.EMPLOYID IS NOT NULL) OR TOBHDR.Admin_Code = 1) AND   (TOBDEPT.EMPLOYID = @i_AS_EMPLOYID OR TOBCLASS.EMPLOYID = @i_AS_EMPLOYID OR TOBEMP.EMPLOYID = @i_AS_EMPLOYID)  ) AS A INNER JOIN UPR10501 B ON A.EMPLOYID = B.EMPLOYID AND A.Pay_Schedule = B.Pay_Schedule AND A.YEAR1 = B.YEAR1 AND A.PERIODID = B.PERIODID  INSERT INTO #TIMECARDS (  EMPLOYID,  Supervisor_Employee_ID,  FRSTNAME,  LASTNAME,  MIDLNAME,  EMPLSUFF,  STRTDATE,  ENDDATE,  PayCode,  PAYDSCRIPTN,  TRXDATE,  TRXDOW,  JOBTITLE,  POSDESCRIPTN,  DEPRTMNT,  DEPTDSCRIPTN,  STATECD,  STATENAM,  LOCALTAX,  LTDSCRIPTN,  SHFTCODE,  SHIFTDESCRIPTN,  DAYSWRDK,  WKSWRKD,  UNTSTOPY,  CMMTTEXT,  HISTORICAL ) SELECT A.EMPLOYID,'', A.FRSTNAME, A.LASTNAME, A.MIDLNAME, A.EMPLSUFF, A.STRTDATE, A.ENDDATE, A.PayCode, A.PAYDSCRIPTN, A.TRXDATE, A.TRXDOW, A.JOBTITLE, A.POSDESCRIPTN, A.DEPRTMNT, A.DEPTDSCRIPTN, A.STATECD, A.STATENAM, A.LOCALTAX, A.LTDSCRIPTN,  A.SHFTCODE, A.SHIFTDESCRIPTN, A.DAYSWRDK, A.WKSWRKD, A.UNTSTOPY, B.CMMTTEXT, A.HISTORICAL FROM (  SELECT MAX(EE.EMPLOYID) AS EMPLOYID, MAX(TCD.Pay_Schedule) AS Pay_Schedule, MAX(TCD.YEAR1) AS YEAR1, MAX(TCD.PERIODID) AS PERIODID,  MAX(EE.FRSTNAME) AS FRSTNAME, MAX(EE.LASTNAME) AS LASTNAME, MAX(EE.MIDLNAME) AS MIDLNAME, MAX(EE.EMPLSUFF) AS EMPLSUFF,   MAX(PSD.STRTDATE) AS STRTDATE, MAX(PSD.ENDDATE) AS ENDDATE,  MAX(TCD.PayCode) AS PayCode, MAX(PAY.DSCRIPTN) AS PAYDSCRIPTN, MAX(TCD.TRXDATE) AS TRXDATE, LEFT(datename(dw, MAX(TCD.TRXDATE)),3) AS TRXDOW,   MAX(TCD.JOBTITLE) AS JOBTITLE, MAX(POS.DSCRIPTN) AS POSDESCRIPTN, MAX(TCD.DEPRTMNT) AS DEPRTMNT, MAX(DEPT.DSCRIPTN) AS DEPTDSCRIPTN,   MAX(TCD.STATECD) AS STATECD, ISNULL(MAX(ST.STATENAM), '') AS STATENAM, MAX(TCD.LOCALTAX) AS LOCALTAX, ISNULL(MAX(LT.DSCRIPTN), '') AS LTDSCRIPTN,  MAX(TCD.SHFTCODE) AS SHFTCODE, ISNULL(MAX(SHFT.DSCRIPTN), '') AS SHIFTDESCRIPTN, MAX(TCD.DAYSWRDK) AS DAYSWRDK, MAX(TCD.WKSWRKD) AS WKSWRKD, MAX(TCD.UNTSTOPY) AS UNTSTOPY, 1 AS HISTORICAL  FROM UPR30501 TCD  INNER JOIN UPR30500 TC ON TC.EMPLOYID = TCD.EMPLOYID AND TC.Pay_Schedule = TCD.Pay_Schedule AND TC.YEAR1 = TCD.YEAR1 AND TC.PERIODID = TCD.PERIODID  INNER JOIN UPR42101 PSD ON PSD.Pay_Schedule = TCD.Pay_Schedule AND PSD.YEAR1 = TCD.YEAR1 AND PSD.PERIODID = TCD.PERIODID  INNER JOIN UPR40600 PAY ON PAY.PAYRCORD = TCD.PayCode  INNER JOIN UPR40300 DEPT ON DEPT.DEPRTMNT = TCD.DEPRTMNT  INNER JOIN UPR40301 POS ON POS.JOBTITLE = TCD.JOBTITLE  INNER JOIN UPR00100 EE ON EE.EMPLOYID = TCD.EMPLOYID  LEFT JOIN #REPORTSTO REP ON REP.EMPLOYID = TC.EMPLOYID  LEFT JOIN UPR41100 ST ON ST.STATECD = TCD.STATECD  LEFT JOIN UPR41400 LT ON LT.LOCALTAX = TCD.LOCALTAX  LEFT JOIN UPR41500 SHFT ON SHFT.SHFTCODE = TCD.SHFTCODE  LEFT JOIN UPR00201 TOBDEPT ON TOBDEPT.DEPRTMNT = EE.DEPRTMNT  LEFT JOIN UPR00202 TOBCLASS ON TOBCLASS.EMPLCLAS = EE.EMPLCLAS  LEFT JOIN UPR00203 TOBEMP ON TOBEMP.Employee_ID_Assigned = EE.EMPLOYID  LEFT JOIN UPR41700 SUP ON EE.SUPERVISORCODE_I = SUP.SUPERVISORCODE_I  LEFT JOIN UPR00100 EESUP ON SUP.EMPLOYID = EESUP.EMPLOYID  LEFT JOIN UPR00200 TOBHDR ON TOBDEPT.Time_on_Behalf_Code = TOBHDR.Time_on_Behalf_Code OR TOBCLASS.Time_on_Behalf_Code = TOBHDR.Time_on_Behalf_Code   OR TOBEMP.Time_on_Behalf_Code = TOBEMP.Time_on_Behalf_Code OR   TOBHDR.Admin_Code = 1  WHERE REP.EMPLOYID IS NOT NULL AND   ((TOBDEPT.DEPRTMNT IS NOT NULL OR TOBCLASS.EMPLCLAS IS NOT NULL OR TOBEMP.EMPLOYID IS NOT NULL) OR TOBHDR.Admin_Code = 1) AND   (TOBDEPT.EMPLOYID = @i_AS_EMPLOYID OR TOBCLASS.EMPLOYID = @i_AS_EMPLOYID OR TOBEMP.EMPLOYID = @i_AS_EMPLOYID)  ) AS A INNER JOIN UPR30501 B ON A.EMPLOYID = B.EMPLOYID AND A.Pay_Schedule = B.Pay_Schedule AND A.YEAR1 = B.YEAR1 AND A.PERIODID = B.PERIODID   if @team=1  SELECT A.* FROM #TIMECARDS A where UNTSTOPY>.01 and TRXDATE>=@sdate and  TRXDATE<=@edate and (Supervisor_Employee_ID=@i_AS_EMPLOYID or EMPLOYID=@i_AS_EMPLOYID)  else SELECT A.* FROM #TIMECARDS A where UNTSTOPY>.01 and TRXDATE>=@sdate and  TRXDATE<=@edate and  EMPLOYID=@i_AS_EMPLOYID    
GO
GRANT EXECUTE ON  [dbo].[seeUPRTimecards] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[seeUPRTimecards] TO [rpt_executive]
GO
GRANT EXECUTE ON  [dbo].[seeUPRTimecards] TO [rpt_human resource administrator]
GO
GRANT EXECUTE ON  [dbo].[seeUPRTimecards] TO [rpt_payroll]
GO
GRANT EXECUTE ON  [dbo].[seeUPRTimecards] TO [rpt_power user]
GO
