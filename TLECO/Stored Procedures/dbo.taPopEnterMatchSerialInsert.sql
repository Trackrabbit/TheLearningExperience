SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[taPopEnterMatchSerialInsert] @I_vPOPRCTNM char(17),     @I_vITEMNMBR char(30),    @I_vSERLTNUM char(20),    @I_vRCPTLNNM int,        @I_vRequesterTrx smallint = 0,   @I_vUSRDEFND1 char(50) = '',   @I_vUSRDEFND2 char(50) = '',   @I_vUSRDEFND3 char(50) = '',   @I_vUSRDEFND4 varchar(8000) = '',  @I_vUSRDEFND5 varchar(8000) = '',  @O_iErrorState int output,   @oErrString varchar(255) output    with encryption as  set transaction isolation level read uncommitted set nocount on  declare @SLTSQNUM int,    @ITMTRKOP smallint,    @DTSEQNUM smallint,    @ENABLEMULTIBIN tinyint,  @sCompanyID int,  @NOTEINDX numeric(19,5),  @iGetNextNoteIdxErrState int,  @iStatus int,  @iCustomState int,  @iCustomErrString varchar(255),  @O_oErrorState int,  @iError int     select @SLTSQNUM = 0,  @ITMTRKOP = 0,  @DTSEQNUM = 0,  @ENABLEMULTIBIN = 0,  @sCompanyID = 0,  @NOTEINDX = 0,  @iGetNextNoteIdxErrState = 0,  @iStatus = 0,  @O_iErrorState = 0    if (@oErrString is null) begin  select @oErrString = '' end  exec @iStatus = taPopEnterMatchSerialInsertPre  @I_vPOPRCTNM output,  @I_vITEMNMBR output,  @I_vSERLTNUM output,  @I_vRCPTLNNM output,  @I_vRequesterTrx output,  @I_vUSRDEFND1 output,  @I_vUSRDEFND2 output,  @I_vUSRDEFND3 output,  @I_vUSRDEFND4 output,  @I_vUSRDEFND5 output,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if ((@iStatus <> 0) or (@iCustomState <> 0) or (@iError <> 0)) begin  select @oErrString = rtrim(@oErrString) + ' ' + @iCustomErrString  select @O_iErrorState = 11785    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if (  @I_vPOPRCTNM is null or  @I_vITEMNMBR is null or  @I_vSERLTNUM is null or  @I_vRCPTLNNM is null or  @I_vUSRDEFND1 is null or  @I_vUSRDEFND2 is null or  @I_vUSRDEFND3 is null or  @I_vUSRDEFND4 is null or  @I_vUSRDEFND5 is null) begin  select @O_iErrorState = 11786    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if ( @I_vPOPRCTNM = '' or  @I_vITEMNMBR = '' or  @I_vSERLTNUM = '' or  @I_vRCPTLNNM = '') begin  select @O_iErrorState = 11787    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  select @I_vITEMNMBR = UPPER(@I_vITEMNMBR),  @I_vSERLTNUM = UPPER(@I_vSERLTNUM)  if ((@I_vRequesterTrx < 0) or (@I_vRequesterTrx > 1)) begin  select @O_iErrorState = 11788     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  select @ITMTRKOP = ITMTRKOP from IV00101 (nolock) where ITEMNMBR = @I_vITEMNMBR  if (@ITMTRKOP <> 2) begin  select @O_iErrorState = 11789    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if exists  (  select 1 from IV00200 (nolock) where ITEMNMBR = @I_vITEMNMBR and SERLNMBR = @I_vSERLTNUM union  select 2 from BM10400 (nolock) where ITEMNMBR = @I_vITEMNMBR and SERLTNUM = @I_vSERLTNUM union  select 3 from POP10330 (nolock) where ITEMNMBR = @I_vITEMNMBR and SERLTNUM = @I_vSERLTNUM union  select 4 from IV10002 (nolock) where ITEMNMBR = @I_vITEMNMBR and SERLTNUM = @I_vSERLTNUM union  select 5 from IVC10102 (nolock) where POSTED = 0 and ITEMNMBR = @I_vITEMNMBR and SERLTNUM = @I_vSERLTNUM union  select 6 from SOP10201 (nolock) where POSTED = 0 and ITEMNMBR = @I_vITEMNMBR and SERLTNUM = @I_vSERLTNUM  ) begin  select @O_iErrorState = 11790    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vRequesterTrx=0) begin  exec @iStatus = eConnectOutVerify  @I_vDOCTYPE='PO_Receiving_Transaction',  @I_vINDEX1=@I_vPOPRCTNM,  @I_vINDEX2='',  @I_vINDEX3='',  @I_vINDEX4='',  @I_vINDEX5='',  @I_vINDEX6='',  @I_vINDEX7='',  @I_vINDEX8='',  @I_vINDEX9='',  @I_vINDEX10='',  @I_vINDEX11='',  @I_vINDEX12='',  @I_vINDEX13='',  @I_vINDEX14='',  @I_vINDEX15='',  @I_vDelete = 0,  @O_iErrorState = @iCustomState output  select @iError = @@error  if ((@iStatus <> 0) or (@iCustomState <> 0) or (@iError <> 0))  begin  select @oErrString = rtrim(@oErrString) + ' ' + @iCustomErrString  select @O_iErrorState = 11791   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@O_iErrorState <> 0)  return (@O_iErrorState)  while (1=1) begin  if (@ITMTRKOP = 2)  begin  select @SLTSQNUM = isnull(max(SLTSQNUM),0) + 1 from POP10330 (nolock) where ITMTRKOP = 2 and POPRCTNM = @I_vPOPRCTNM and RCPTLNNM = @I_vRCPTLNNM and QTYTYPE = 1    insert POP10330  (  ITMTRKOP,  POPRCTNM,  RCPTLNNM,  SLTSQNUM,  ITEMNMBR,  SERLTNUM,  SERLTQTY,  TRXSORCE,  DATERECD,  DTSEQNUM,  UNITCOST,  QTYTYPE,  BIN,  MFGDATE,  EXPNDATE  )  select  2,    @I_vPOPRCTNM,   @I_vRCPTLNNM,   @SLTSQNUM,   @I_vITEMNMBR,   @I_vSERLTNUM,   1,    '',    '',    0,    0,    1,    '',       '',    ''    if (@@error <> 0)  begin  select @O_iErrorState = 11792    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  break  end  end  break end  exec @iStatus = taPopEnterMatchSerialInsertPost  @I_vPOPRCTNM,  @I_vITEMNMBR,  @I_vSERLTNUM,  @I_vRCPTLNNM,  @I_vRequesterTrx,  @I_vUSRDEFND1,  @I_vUSRDEFND2,  @I_vUSRDEFND3,  @I_vUSRDEFND4,  @I_vUSRDEFND5,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if ((@iStatus <> 0) or (@iCustomState <> 0) or (@iError <> 0)) begin  select @oErrString = rtrim(@oErrString) + ' ' + @iCustomErrString  select @O_iErrorState = 11793    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vRequesterTrx=0) begin  exec @iStatus = eConnectOutVerify  @I_vDOCTYPE='PO_Receiving_Transaction',  @I_vINDEX1=@I_vPOPRCTNM,  @I_vINDEX2='',  @I_vINDEX3='',  @I_vINDEX4='',  @I_vINDEX5='',  @I_vINDEX6='',  @I_vINDEX7='',  @I_vINDEX8='',  @I_vINDEX9='',  @I_vINDEX10='',  @I_vINDEX11='',  @I_vINDEX12='',  @I_vINDEX13='',  @I_vINDEX14='',  @I_vINDEX15='',  @I_vDelete = 1,  @O_iErrorState = @iCustomState output  select @iError = @@error  if ((@iStatus <> 0) or (@iCustomState <> 0) or (@iError <> 0))  begin  select @oErrString = rtrim(@oErrString) + ' ' + @iCustomErrString  select @O_iErrorState = 11794   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end  return (@O_iErrorState)   
GO
GRANT EXECUTE ON  [dbo].[taPopEnterMatchSerialInsert] TO [DYNGRP]
GO
