SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[seeSOPTopTenSalesItemsByPriceMetric]  @UserDate datetime = NULL,  @NumDays int   = NULL,  @NumItems int   = NULL,  @CustomerNumber varchar(max),  @SalesPerson varchar(max),  @ItemNumber varchar(max)   as set nocount ON  declare @dtStart datetime,   @dtEnd  datetime,  @Stmt  varchar(3000)  declare @ValuesTable table (Value nvarchar(500)) if (@SalesPerson != '') begin  insert into @ValuesTable select * from dbo.seeSplitString(@SalesPerson, ',') end  if (@CustomerNumber != '') begin  insert into @ValuesTable select * from dbo.seeSplitString(@CustomerNumber, ',') end  if (@ItemNumber != '') begin  insert into @ValuesTable select * from dbo.seeSplitString(@ItemNumber, ',') end  set dateformat ymd  select  @UserDate = dbo.GetDateStripTime(@UserDate)   select  @dtEnd = @UserDate  select  @dtStart = @dtEnd - @NumDays  create table #TopSalesItemsTemp (RemPrice numeric(19,5) not null,  ItemNumber char(31) not null,  Filter char(15)) create table #TopSalesItems (RemPrice numeric(19,5) not null,  ItemNumber char(31) not null,  Filter char(15))  if (@CustomerNumber = '' and @SalesPerson = '' and @ItemNumber = '') begin   insert into #TopSalesItemsTemp (RemPrice,  ItemNumber,  Filter )  select TOP (select @NumItems) sum(Line.REMPRICE) as RemPrice, Line.ITEMNMBR, '' as Filter  from SOP30200 as Header, SOP30300 as Line with (NOLOCK)   where ( Header.DOCDATE >= dbo.GetDateStripTime(@dtStart)  and   Header.DOCDATE <= dbo.GetDateStripTime(@dtEnd) ) and   Header.SOPTYPE = 3 and Header.VOIDSTTS = 0 and   ( Header.SOPTYPE = Line.SOPTYPE and Header.SOPNUMBE = Line.SOPNUMBE) and   Line.REMPRICE > 0   group by ITEMNMBR  order by RemPrice DESC end  if @CustomerNumber != '' begin  insert into #TopSalesItems (RemPrice,  ItemNumber,  Filter )  select TOP (select @NumItems) sum(Line.REMPRICE) as RemPrice, Line.ITEMNMBR, '' as Filter  from SOP30200 as Header, SOP30300 as Line with (NOLOCK)   where ( Header.DOCDATE >= dbo.GetDateStripTime(@dtStart)  and   Header.DOCDATE <= dbo.GetDateStripTime(@dtEnd) ) and   Header.SOPTYPE = 3 and Header.VOIDSTTS = 0 and   ( Header.SOPTYPE = Line.SOPTYPE and Header.SOPNUMBE = Line.SOPNUMBE) and   Line.REMPRICE > 0   group by ITEMNMBR  order by RemPrice DESC   insert into #TopSalesItemsTemp (RemPrice,  ItemNumber,  Filter )  select sum(Line.REMPRICE) as RemPrice, Line.ITEMNMBR, Header.CUSTNMBR as filter  from SOP30200 as Header with (NOLOCK)   inner join SOP30300 as Line with (NOLOCK) on ( Header.DOCDATE >= dbo.GetDateStripTime(@dtStart)  and   Header.DOCDATE <= dbo.GetDateStripTime(@dtEnd) ) and   Header.SOPTYPE = 3 and Header.VOIDSTTS = 0 and   ( Header.SOPTYPE = Line.SOPTYPE and Header.SOPNUMBE = Line.SOPNUMBE) and   Line.REMPRICE > 0  inner join @ValuesTable CustomerList on CustomerList.Value = Header.CUSTNMBR   inner join #TopSalesItems on #TopSalesItems.ItemNumber = Line.ITEMNMBR  group by #TopSalesItems.RemPrice, Line.ITEMNMBR, Header.CUSTNMBR  order by #TopSalesItems.RemPrice DESC, Line.ITEMNMBR  end  if @SalesPerson != '' begin     insert into #TopSalesItems (RemPrice,  ItemNumber,  Filter )  select TOP (select @NumItems) sum(Line.REMPRICE) as RemPrice, Line.ITEMNMBR, '' as Filter  from SOP30200 as Header, SOP30300 as Line with (NOLOCK)   where ( Header.DOCDATE >= dbo.GetDateStripTime(@dtStart)  and   Header.DOCDATE <= dbo.GetDateStripTime(@dtEnd) ) and   Header.SOPTYPE = 3 and Header.VOIDSTTS = 0 and   ( Header.SOPTYPE = Line.SOPTYPE and Header.SOPNUMBE = Line.SOPNUMBE) and   Line.REMPRICE > 0   group by ITEMNMBR  order by RemPrice DESC  insert into #TopSalesItemsTemp (RemPrice,  ItemNumber,  Filter )  select sum(Line.REMPRICE) as RemPrice, Line.ITEMNMBR, Header.SLPRSNID as filter  from SOP30200 as Header with (NOLOCK)   inner join SOP30300 as Line with (NOLOCK) on ( Header.DOCDATE >= dbo.GetDateStripTime(@dtStart)  and   Header.DOCDATE <= dbo.GetDateStripTime(@dtEnd) ) and   Header.SOPTYPE = 3 and Header.VOIDSTTS = 0 and   ( Header.SOPTYPE = Line.SOPTYPE and Header.SOPNUMBE = Line.SOPNUMBE) and   Line.REMPRICE > 0  inner join @ValuesTable SalespersonList on SalespersonList.Value = Header.SLPRSNID   inner join #TopSalesItems on #TopSalesItems.ItemNumber = Line.ITEMNMBR  group by #TopSalesItems.RemPrice,ITEMNMBR, Header.SLPRSNID  order by #TopSalesItems.RemPrice DESC, Line.ITEMNMBR  end  if (@ItemNumber != '') begin   insert into #TopSalesItemsTemp (RemPrice,  ItemNumber,  Filter )  select TOP (select @NumItems) sum(Line.REMPRICE) as RemPrice, Line.ITEMNMBR, Line.ITEMNMBR as Filter  from SOP30200 as Header, SOP30300 as Line with (NOLOCK)   where ( Header.DOCDATE >= dbo.GetDateStripTime(@dtStart)  and   Header.DOCDATE <= dbo.GetDateStripTime(@dtEnd) ) and   Header.SOPTYPE = 3 and Header.VOIDSTTS = 0 and   ( Header.SOPTYPE = Line.SOPTYPE and Header.SOPNUMBE = Line.SOPNUMBE) and   Line.REMPRICE > 0 and  Line.ITEMNMBR in (select * from @ValuesTable)  group by ITEMNMBR  order by RemPrice DESC end  select * from #TopSalesItemsTemp with (nolock) drop table #TopSalesItemsTemp drop table #TopSalesItems    
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopTenSalesItemsByPriceMetric] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopTenSalesItemsByPriceMetric] TO [rpt_executive]
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopTenSalesItemsByPriceMetric] TO [rpt_materials manager]
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopTenSalesItemsByPriceMetric] TO [rpt_operations manager]
GO
