SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aagUpdateBackOutDistr]  @JRNENTRY int AS BEGIN  DECLARE @DEBITAMT numeric(19,5),  @CRDTAMNT numeric(19,5),  @ORDBTAMT numeric(19,5),  @ORCRDAMT numeric(19,5),  @DEBITAMT1 numeric(19,5),  @CRDTAMNT1 numeric(19,5),  @ORDBTAMT1 numeric(19,5),  @ORCRDAMT1 numeric(19,5),  @Diff numeric(19,5),  @lSeqNumber int   UPDATE AAG10001 SET AAG10001.XCHGRATE = GL10001.XCHGRATE, AAG10001.EXCHDATE = GL10001.EXCHDATE, AAG10001.TIME1 = GL10001.TIME1,  AAG10001.DEBITAMT = GL10001.DEBITAMT, AAG10001.CRDTAMNT = GL10001.CRDTAMNT, AAG10001.ORDBTAMT = GL10001.ORDBTAMT, AAG10001.ORCRDAMT  = GL10001.ORCRDAMT   from AAG10001 INNER JOIN AAG10000 on AAG10001.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID  INNER JOIN GL10001 on AAG10000.JRNENTRY = GL10001.JRNENTRY and AAG10001.SQNCLINE = GL10001.SQNCLINE   where GL10001.JRNENTRY = @JRNENTRY   UPDATE AAG10002 SET AAG10002.DEBITAMT = ROUND(GL10001.DEBITAMT * aaAssignedPercent / 10000.0,GL10001.DECPLACS),   AAG10002.CRDTAMNT = ROUND(GL10001.CRDTAMNT * aaAssignedPercent / 10000.0,GL10001.DECPLACS),   AAG10002.ORDBTAMT = ROUND(GL10001.ORDBTAMT * aaAssignedPercent / 10000.0,AAG10001.DECPLACS),   AAG10002.ORCRDAMT = ROUND(GL10001.ORCRDAMT * aaAssignedPercent / 10000.0,AAG10001.DECPLACS)   from AAG10002 INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID   INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID   INNER JOIN GL10001 on AAG10000.JRNENTRY = GL10001.JRNENTRY and AAG10001.SQNCLINE = GL10001.SQNCLINE   where GL10001.JRNENTRY  = @JRNENTRY   DECLARE  TrxOpenCursor  CURSOR LOCAL FOR   SELECT  SQNCLINE   FROM  GL10001  WHERE JRNENTRY = @JRNENTRY order by  SQNCLINE   OPEN TrxOpenCursor   FETCH NEXT   FROM   TrxOpenCursor  INTO  @lSeqNumber  WHILE @@fetch_status = 0   BEGIN   SELECT @DEBITAMT = sum(DEBITAMT), @ORDBTAMT = sum(ORDBTAMT),@CRDTAMNT = sum(CRDTAMNT),@ORCRDAMT = sum(ORCRDAMT) FROM GL10001   WHERE JRNENTRY = @JRNENTRY and SQNCLINE = @lSeqNumber GROUP BY JRNENTRY   SELECT @DEBITAMT1 = sum(AAG10002.DEBITAMT), @ORDBTAMT1 = sum(AAG10002.ORDBTAMT),@CRDTAMNT1 = sum(AAG10002.CRDTAMNT),  @ORCRDAMT1 = sum(AAG10002.ORCRDAMT)  from AAG10002   INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID   INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID  WHERE JRNENTRY = @JRNENTRY  and SQNCLINE = @lSeqNumber GROUP BY JRNENTRY   IF @DEBITAMT <> @DEBITAMT1   BEGIN  SELECT @Diff  = CASE WHEN  @DEBITAMT > @DEBITAMT1 THEN @DEBITAMT - @DEBITAMT1 ELSE @DEBITAMT1 - @DEBITAMT END  IF @DEBITAMT > @DEBITAMT1   UPDATE AAG10002 SET AAG10002.DEBITAMT = AAG10002.DEBITAMT + @Diff  from AAG10002 INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID  INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID  where AAG10000.JRNENTRY = @JRNENTRY and AAG10001.SQNCLINE = @lSeqNumber and AAG10002.DEX_ROW_ID = (SELECT max(AAG10002.DEX_ROW_ID)   from AAG10002 INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID  INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID  where AAG10000.JRNENTRY = @JRNENTRY and AAG10001.SQNCLINE = @lSeqNumber )  ELSE  UPDATE AAG10002 SET AAG10002.DEBITAMT = AAG10002.DEBITAMT - @Diff  from AAG10002 INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID  INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID  where AAG10000.JRNENTRY = @JRNENTRY and AAG10001.SQNCLINE = @lSeqNumber and AAG10002.DEX_ROW_ID = (SELECT max(AAG10002.DEX_ROW_ID)   from AAG10002 INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID  INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID  where AAG10000.JRNENTRY = @JRNENTRY and AAG10001.SQNCLINE = @lSeqNumber )  END  IF @CRDTAMNT <> @CRDTAMNT1   BEGIN  SELECT @Diff  = CASE WHEN  @CRDTAMNT > @CRDTAMNT1 THEN @CRDTAMNT - @CRDTAMNT1 ELSE @CRDTAMNT1 - @CRDTAMNT END  IF @CRDTAMNT > @CRDTAMNT1   UPDATE AAG10002 SET AAG10002.CRDTAMNT = AAG10002.CRDTAMNT + @Diff  from AAG10002 INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID  INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID  where AAG10000.JRNENTRY = @JRNENTRY and AAG10001.SQNCLINE = @lSeqNumber and AAG10002.DEX_ROW_ID = (SELECT max(AAG10002.DEX_ROW_ID)   from AAG10002 INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID  INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID  where AAG10000.JRNENTRY = @JRNENTRY and AAG10001.SQNCLINE = @lSeqNumber)  ELSE  UPDATE AAG10002 SET AAG10002.CRDTAMNT = AAG10002.CRDTAMNT - @Diff  from AAG10002 INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID  INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID  where AAG10000.JRNENTRY = @JRNENTRY and AAG10001.SQNCLINE = @lSeqNumber and AAG10002.DEX_ROW_ID = (SELECT max(AAG10002.DEX_ROW_ID)   from AAG10002 INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID  INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID  where AAG10000.JRNENTRY = @JRNENTRY and AAG10001.SQNCLINE = @lSeqNumber)  END  IF @ORDBTAMT <> @ORDBTAMT   BEGIN  SELECT @Diff  = CASE WHEN  @ORDBTAMT > @ORDBTAMT1 THEN @ORDBTAMT - @ORDBTAMT1 ELSE @ORDBTAMT1 - @ORDBTAMT END  IF @ORDBTAMT > @ORDBTAMT1   UPDATE AAG10002 SET AAG10002.ORDBTAMT = AAG10002.ORDBTAMT + @Diff  from AAG10002 INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID  INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID  where AAG10000.JRNENTRY = @JRNENTRY and AAG10001.SQNCLINE = @lSeqNumber and AAG10002.DEX_ROW_ID = (SELECT max(AAG10002.DEX_ROW_ID)   from AAG10002 INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID  INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID  where AAG10000.JRNENTRY = @JRNENTRY and AAG10001.SQNCLINE = @lSeqNumber)  ELSE  UPDATE AAG10002 SET AAG10002.ORDBTAMT = AAG10002.ORDBTAMT - @Diff  from AAG10002 INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID  INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID  where AAG10000.JRNENTRY = @JRNENTRY and AAG10001.SQNCLINE = @lSeqNumber and AAG10002.DEX_ROW_ID = (SELECT max(AAG10002.DEX_ROW_ID)   from AAG10002 INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID  INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID  where AAG10000.JRNENTRY = @JRNENTRY and AAG10001.SQNCLINE = @lSeqNumber)  END  IF @ORCRDAMT <> @ORCRDAMT1   BEGIN  SELECT @Diff  = CASE WHEN  @ORCRDAMT > @ORCRDAMT1 THEN @ORCRDAMT - @ORCRDAMT1 ELSE @ORCRDAMT1 - @ORCRDAMT END  IF @CRDTAMNT > @CRDTAMNT1   UPDATE AAG10002 SET AAG10002.ORCRDAMT = AAG10002.ORCRDAMT + @Diff  from AAG10002 INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID  INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID  where AAG10000.JRNENTRY = @JRNENTRY and AAG10001.SQNCLINE = @lSeqNumber and AAG10002.DEX_ROW_ID = (SELECT max(AAG10002.DEX_ROW_ID)   from AAG10002 INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID  INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID  where AAG10000.JRNENTRY = @JRNENTRY and AAG10001.SQNCLINE = @lSeqNumber)  ELSE  UPDATE AAG10002 SET AAG10002.ORCRDAMT = AAG10002.ORCRDAMT - @Diff  from AAG10002 INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID  INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID  where AAG10000.JRNENTRY = @JRNENTRY and AAG10001.SQNCLINE = @lSeqNumber and AAG10002.DEX_ROW_ID = (SELECT max(AAG10002.DEX_ROW_ID)   from AAG10002 INNER JOIN AAG10000 on AAG10002.aaGLWorkHdrID  = AAG10000.aaGLWorkHdrID  INNER JOIN AAG10001 on AAG10002.aaGLWorkHdrID  = AAG10001.aaGLWorkHdrID and AAG10002.aaGLWorkDistID  = AAG10001.aaGLWorkDistID  where AAG10000.JRNENTRY = @JRNENTRY and AAG10001.SQNCLINE = @lSeqNumber)  END  FETCH NEXT   FROM   TrxOpenCursor  INTO  @lSeqNumber  END  CLOSE TrxOpenCursor  DEALLOCATE TrxOpenCursor END     
GO
GRANT EXECUTE ON  [dbo].[aagUpdateBackOutDistr] TO [DYNGRP]
GO
