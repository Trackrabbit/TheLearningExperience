SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE Procedure [dbo].[SVC_Remove_Call_Serial_RMA]  (@SRVRECTYPE smallint,  @CALLNBR char(11),  @EQPLINE integer,  @LNITMSEQ integer,  @ITEMNMBR char(31),  @SERLNMBR char(21),  @TRANSFERDELETED integer OUTPUT,  @OUTERROR integer OUTPUT) As declare @ORDDOCID char(15),  @TRANSLINESEQ integer,  @DELETE tinyint,  @TRANSQTY numeric(19,5) declare @RMA char(15), @RMAQTY numeric(19,5) declare @LineNumber numeric(19,5) declare @SerialSeq int declare @UOM char(10), @QtyInBase numeric(19,5) declare @Tracking smallint  set NOCOUNT ON select @DELETE = 1,  @TRANSFERDELETED = 0,  @OUTERROR = 0 select @Tracking = ITMTRKOP from IV00101  where ITEMNMBR = @ITEMNMBR  if @SERLNMBR > ''   select @ORDDOCID = ORDDOCID, @TRANSLINESEQ = TRANSLINESEQ, @RMAQTY = QUANTITY - 1,  @RMA = SVC05255.RETDOCID, @LineNumber = SVC05255.LNSEQNBR, @SerialSeq = SLTSQNUM  from SVC05200 left join SVC05255 on   SVC05200.Return_Record_Type= SVC05255.Return_Record_Type and   SVC05200.RETDOCID = SVC05255.RETDOCID and SVC05200.LNSEQNBR = SVC05255.LNSEQNBR  where SVC05200.Return_Record_Type = 1  AND SRVRECTYPE = @SRVRECTYPE AND CALLNBR = @CALLNBR AND EQPLINE = @EQPLINE AND LNITMSEQ = @LNITMSEQ  AND Return_Serial_Number = @SERLNMBR AND SVC05255.Return_Item_Number = @ITEMNMBR else if @Tracking = 3  select @ORDDOCID = ORDDOCID, @TRANSLINESEQ = TRANSLINESEQ, @RMAQTY = QUANTITY - 1,  @RMA = SVC05255.RETDOCID, @LineNumber = SVC05255.LNSEQNBR, @SerialSeq = SLTSQNUM  from SVC05200 left join SVC05255 on   SVC05200.Return_Record_Type= SVC05255.Return_Record_Type and   SVC05200.RETDOCID = SVC05255.RETDOCID and SVC05200.LNSEQNBR = SVC05255.LNSEQNBR  where SVC05200.Return_Record_Type = 1  AND SRVRECTYPE = @SRVRECTYPE AND CALLNBR = @CALLNBR AND EQPLINE = @EQPLINE AND LNITMSEQ = @LNITMSEQ  AND SVC05255.Return_Item_Number = @ITEMNMBR else   select @ORDDOCID = ORDDOCID, @TRANSLINESEQ = TRANSLINESEQ, @RMAQTY = 0,  @RMA = RETDOCID, @LineNumber = LNSEQNBR  from SVC05200  where Return_Record_Type = 1 AND SRVRECTYPE = @SRVRECTYPE  AND CALLNBR = @CALLNBR AND EQPLINE = @EQPLINE AND LNITMSEQ = @LNITMSEQ  AND Return_Item_Number = @ITEMNMBR if exists(select * from SVC00701 where   SVC00701.ORDDOCID = @ORDDOCID and  SVC00701.LNITMSEQ = @TRANSLINESEQ and  SVC00701.STATUS > 1)  select @DELETE = 0  IF @DELETE = 1 BEGIN   exec SVC_Get_QtyInBase @ITEMNMBR,@UOM,1,@QtyInBase OUTPUT   IF @RMAQTY = 0 or @Tracking = 3  begin  delete SVC05200   where Return_Record_Type = 1 and  LNSEQNBR = @LineNumber and  RETDOCID = @RMA  AND SRVRECTYPE = @SRVRECTYPE AND CALLNBR = @CALLNBR AND EQPLINE = @EQPLINE  AND ITEMNMBR = @ITEMNMBR AND LNITMSEQ = @LNITMSEQ  delete SVC05030 where Return_Record_Type = 1 and  LNSEQNBR = @LineNumber and  RETDOCID = @RMA  delete SVC05001 where Return_Record_Type = 1 and  LNSEQNBR = @LineNumber and  RETDOCID = @RMA  delete SVC05212 where Return_Record_Type = 1 and  LNSEQNBR = @LineNumber and  RETDOCID = @RMA  delete SVC05255 where Return_Record_Type = 1 and  LNSEQNBR = @LineNumber and  RETDOCID = @RMA  delete SVC05256 where Return_Record_Type = 1 and  LNSEQNBR = @LineNumber and  RETDOCID = @RMA  delete SVC05210 where Return_Record_Type = 1 and  LNSEQNBR = @LineNumber and  RETDOCID = @RMA  if @Tracking = 3  begin  delete SVC00702 where ORDDOCID = @ORDDOCID and  TRANSLINESEQ = @TRANSLINESEQ and ITEMNMBR = @ITEMNMBR   delete SVC00701 where ORDDOCID = @ORDDOCID AND LNITMSEQ = @TRANSLINESEQ  update SVC00250 set POSTED = 0 where SRVRECTYPE = @SRVRECTYPE AND CALLNBR = @CALLNBR AND EQPLINE = @EQPLINE AND LNITMSEQ = @LNITMSEQ  end  end  ELSE  begin  update SVC05200 set QUANTITY = @RMAQTY, EXTDCOST = UNITCOST * @RMAQTY, OREXTCST = ORUNTCST * @RMAQTY,  XTNDPRCE = UNITPRCE * @RMAQTY , OXTNDPRC = ORUNTPRC * @RMAQTY  where Return_Record_Type = 1 and  LNSEQNBR = @LineNumber and  RETDOCID = @RMA  AND SRVRECTYPE = @SRVRECTYPE AND CALLNBR = @CALLNBR  AND EQPLINE = @EQPLINE  AND ITEMNMBR = @ITEMNMBR AND LNITMSEQ = @LNITMSEQ  exec SVC_Set_RMA_Dist @RMA,1,@LineNumber, 0,'',0,0,0,0,0,1,0  end   delete SVC05255 where  Return_Record_Type = 1 and LNSEQNBR = @LineNumber and  RETDOCID = @RMA  AND Return_Serial_Number = @SERLNMBR  AND Return_Item_Number = @ITEMNMBR  IF (select count(*) from SVC05200 WHERE Return_Record_Type = 1 and RETDOCID = @RMA) < 1  exec SVC_RMA_Delete 1, @RMA, 0  ELSE  exec SVC_RMA_Set_HDR_Status @RMA   delete SVC00702   where ORDDOCID = @ORDDOCID and  TRANSLINESEQ = @TRANSLINESEQ and   SERLTNUM = @SERLNMBR and  ITEMNMBR = @ITEMNMBR   select @TRANSQTY = IsNull(TRNSFQTY,0) from SVC00701   where ORDDOCID = @ORDDOCID and  LNITMSEQ = @TRANSLINESEQ  if @TRANSQTY is NULL  select @TRANSQTY = 0   IF @TRANSQTY > 1 and @SERLNMBR > ''  BEGIN  select @TRANSFERDELETED = 0  update SVC00701 set TRNSFQTY = TRNSFQTY - 1, QTYFULFI = QTYFULFI - 1  where ORDDOCID = @ORDDOCID AND LNITMSEQ = @TRANSLINESEQ   END ELSE  BEGIN  select @TRANSFERDELETED = 1  delete SVC00701 where ORDDOCID = @ORDDOCID AND LNITMSEQ = @TRANSLINESEQ  delete SVC00712 where ORDDOCID = @ORDDOCID AND LNITMSEQ = @TRANSLINESEQ  END  IF (select count(*) from SVC00701 WHERE ORDDOCID = @ORDDOCID) < 1  BEGIN  delete SVC00700 WHERE ORDDOCID = @ORDDOCID  delete SVC00731 WHERE ORDDOCID = @ORDDOCID  END  END ELSE  select @OUTERROR = -1 select @TRANSFERDELETED, @OUTERROR  return (0)    
GO
GRANT EXECUTE ON  [dbo].[SVC_Remove_Call_Serial_RMA] TO [DYNGRP]
GO
