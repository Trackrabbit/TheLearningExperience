SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create   procedure  [dbo].[aagUpdateUnpostedDistsForAcctGLWork]  @iAcctIndex  int = 0,  @oSuccess tinyint = 0 output  As  Begin  Declare @AcctClassID int,  @AcctIndex int,  @RequiredFieldEmpty tinyint,  @Series smallint,  @QtyIsZero tinyint,  @HdrID int,  @DistID int,  @TrxQty numeric(19,5),  @RetCode int  Select @AcctClassID = aaAcctClassID from AAG00200 where ACTINDX = @iAcctIndex  If @AcctClassID = 0 or @AcctClassID = null  Begin  If exists(select top 1 ACTINDX from AAG10001 where ACTINDX = @iAcctIndex )  Begin  Update AAG10002   Set DEBITAMT = AAG10001.DEBITAMT, CRDTAMNT = AAG10001.CRDTAMNT, ORDBTAMT = AAG10001.ORDBTAMT, ORCRDAMT = AAG10001.ORCRDAMT,  aaAssignedPercent = 10000  From AAG10001 INNER JOIN AAG10002  On AAG10001.aaGLWorkHdrID = AAG10002.aaGLWorkHdrID and   AAG10001.aaGLWorkDistID = AAG10002.aaGLWorkDistID and   AAG10002.aaGLWorkAssignID = 1  Where  AAG10001.ACTINDX = @iAcctIndex and  (select max(AAG10002.aaGLWorkAssignID) from AAG10002  where AAG10001.aaGLWorkHdrID = AAG10002.aaGLWorkHdrID and   AAG10001.aaGLWorkDistID = AAG10002.aaGLWorkDistID) <> 1   Delete AAG10003 from AAG10003 AS Code INNER JOIN AAG10001 AS Dist ON Code.aaGLWorkDistID = Dist.aaGLWorkDistID and  Code.aaGLWorkHdrID = Dist.aaGLWorkHdrID and  Dist.ACTINDX = @iAcctIndex    Delete AAG10002 from AAG10002 AS Assign INNER JOIN AAG10001 AS Dist ON Assign.aaGLWorkAssignID > 1 and   Assign.aaGLWorkDistID = Dist.aaGLWorkDistID and  Assign.aaGLWorkHdrID = Dist.aaGLWorkHdrID and  Dist.ACTINDX = @iAcctIndex    Update AAG10001 set aaBrowseType = 0 where ACTINDX = @iAcctIndex   End  Return 0  End  Else   Begin  If exists(select ACTINDX from AAG10001 where ACTINDX = @iAcctIndex )  Begin   Update AAG10002   Set DEBITAMT = AAG10001.DEBITAMT, CRDTAMNT = AAG10001.CRDTAMNT, ORDBTAMT = AAG10001.ORDBTAMT, ORCRDAMT = AAG10001.ORCRDAMT,  aaAssignedPercent = 10000  From AAG10001 INNER JOIN AAG10002  On AAG10001.aaGLWorkHdrID = AAG10002.aaGLWorkHdrID and   AAG10001.aaGLWorkDistID = AAG10002.aaGLWorkDistID and   AAG10002.aaGLWorkAssignID = 1  Where  AAG10001.ACTINDX = @iAcctIndex and  (select max(AAG10002.aaGLWorkAssignID) from AAG10002  where AAG10001.aaGLWorkHdrID = AAG10002.aaGLWorkHdrID and   AAG10001.aaGLWorkDistID = AAG10002.aaGLWorkDistID) <> 1   Delete AAG10003 from AAG10003 AS Code INNER JOIN AAG10001 AS Dist ON Code.aaGLWorkDistID = Dist.aaGLWorkDistID and  Code.aaGLWorkHdrID = Dist.aaGLWorkHdrID and  Dist.ACTINDX = @iAcctIndex    Delete AAG10002 from AAG10002 AS Assign INNER JOIN AAG10001 AS Dist ON Assign.aaGLWorkAssignID > 1 and   Assign.aaGLWorkDistID = Dist.aaGLWorkDistID and  Assign.aaGLWorkHdrID = Dist.aaGLWorkHdrID and  Dist.ACTINDX = @iAcctIndex    Update AAG10001 set aaBrowseType = 0 where ACTINDX = @iAcctIndex   End  Declare Accounts cursor fast_forward FOR Select aaGLWorkHdrID, aaGLWorkDistID  From AAG10001 Where ACTINDX = @iAcctIndex   Order by aaGLWorkHdrID, aaGLWorkDistID  Open Accounts  Fetch next from Accounts into @HdrID, @DistID  WHILE @@fetch_status = 0  Begin  Set @QtyIsZero = 0   Execute aagGLWorkCodeUpdate @HdrID, @DistID, 1, @AcctClassID, @RequiredFieldEmpty output   If @Series = 5   Begin  If @QtyIsZero = 1   Update AAG10001 set aaBrowseType = 3 where aaGLWorkHdrID = @HdrID and ACTINDX = @iAcctIndex   Else if @RequiredFieldEmpty = 1  Update AAG10001 set aaBrowseType = 2 where aaGLWorkHdrID = @HdrID and ACTINDX = @iAcctIndex   Else  Update AAG10001 set aaBrowseType = 1 where aaGLWorkHdrID = @HdrID and ACTINDX = @iAcctIndex   End  Else if @RequiredFieldEmpty = 1  Update AAG10001 set aaBrowseType = 2 where aaGLWorkHdrID = @HdrID and ACTINDX = @iAcctIndex   Else  Update AAG10001 set aaBrowseType = 1 where aaGLWorkHdrID = @HdrID and ACTINDX = @iAcctIndex   Fetch next from Accounts into @HdrID, @DistID  End  Close Accounts  Deallocate Accounts  End  End    
GO
GRANT EXECUTE ON  [dbo].[aagUpdateUnpostedDistsForAcctGLWork] TO [DYNGRP]
GO
