SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
CREATE PROCEDURE [dbo].[popGetVendorShipments] (@IN_sVendorID varchar(60),@I_Orderby Integer,@IN_TypeID smallint,@IN_DocumentNo varchar(60),@IN_ShipmentsTbl varchar(10)) AS BEGIN   DECLARE @DocFilterStr VARCHAR(500)   DECLARE @ColFilterStr VARCHAR(8000)  DECLARE @OrderbyStr VARCHAR(7)   if @I_Orderby = 0   SET @OrderbyStr = ' DESC '  else   SET @OrderbyStr = ' ASC '   EXEC('DELETE FROM ' + @IN_ShipmentsTbl)  exec POPVendAnalysisBuildQuery 4,2,@ColFilterStr out   IF @IN_TypeID = 1  and @IN_DocumentNo <> ''  SELECT @DocFilterStr = 'AND POPRCTNM IN (SELECT POPRCTNM FROM POP10310 WHERE PONUMBER = '+ @IN_DocumentNo +' UNION SELECT POPRCTNM FROM POP30310 WHERE PONUMBER = '+ @IN_DocumentNo +') '  ELSE IF @IN_TypeID = 3  and @IN_DocumentNo <> ''   SELECT @DocFilterStr = 'AND POPRCTNM IN (SELECT POPRCTNM FROM POP10600 WHERE POPIVCNO = '+ @IN_DocumentNo +' OR POPIVCNO IN (SELECT POPRCTNM FROM POP30300 WHERE POPTYPE = 2 AND VCHRNMBR  = '+ @IN_DocumentNo +')) '   ELSE IF @IN_TypeID = 4  and @IN_DocumentNo <> ''   BEGIN  SELECT @DocFilterStr = 'AND POPRCTNM IN (SELECT POPRCTNM FROM POP30310 WHERE PONUMBER IN ( SELECT PORDNMBR FROM PM20000 WHERE VCHRNMBR IN (SELECT APTVCHNM FROM PM10200 WHERE APFRDCNM = '+ @IN_DocumentNo +')) UNION SELECT POPRCTNM FROM POP10600 WHERE POPIVCNO IN (SELECT POPRCTNM FROM POP30300 WHERE POPTYPE = 2 AND VCHRNMBR IN (SELECT APTVCHNM FROM PM10200 WHERE VCHRNMBR = '+ @IN_DocumentNo +' UNION SELECT APTVCHNM FROM PM30300 WHERE VCHRNMBR = '+ @IN_DocumentNo +'))) '  END  ELSE IF @IN_TypeID = 5  and @IN_DocumentNo <> ''   BEGIN  SELECT @DocFilterStr = 'AND POPRCTNM IN (SELECT POPRCTNM FROM (SELECT POPRCTNM,PONUMBER  FROM POP10310 UNION SELECT POPRCTNM,PONUMBER FROM POP30310)M WHERE PONUMBER IN (SELECT PONUMBER FROM POP10310 WHERE POPRCTNM= '+ @IN_DocumentNo +' UNION SELECT PONUMBER FROM POP30310 WHERE POPRCTNM = '+ @IN_DocumentNo +'))'  END  ELSE IF @IN_TypeID = 6  and @IN_DocumentNo <> ''   BEGIN  SELECT @DocFilterStr = 'AND POPRCTNM IN (SELECT APTVCHNM FROM PM30300 WHERE VCHRNMBR = '+ @IN_DocumentNo +')'  END  EXEC('INSERT INTO '+@IN_ShipmentsTbl+' (INDXLONG,VENDORID,POPRCTNM,POPTYPE,receiptdate,SUBTOTAL,BACHNUMB,GLPOSTDT,Total_Landed_Cost_Amount,DCSTATUS)  SELECT TOP 100 ROW_NUMBER() OVER (ORDER BY receiptdate '+ @OrderbyStr +') INDEX1,VENDORID,POPRCTNM,POPTYPE,receiptdate,SUBTOTAL,BACHNUMB,PSTGDATE,Total_Landed_Cost_Amount,DCSTATUS FROM  (  SELECT VENDORID,POPRCTNM,POPTYPE,receiptdate,SUBTOTAL,BACHNUMB,GLPOSTDT PSTGDATE,Total_Landed_Cost_Amount,4 DCSTATUS FROM POP10300  UNION  SELECT VENDORID,POPRCTNM,POPTYPE,receiptdate,SUBTOTAL,BACHNUMB,GLPOSTDT PSTGDATE,Total_Landed_Cost_Amount,3 DCSTATUS FROM POP30300  ) A WHERE VENDORID = '+ @IN_sVendorID +' '+ @ColFilterStr + @DocFilterStr ) END   
GO
GRANT EXECUTE ON  [dbo].[popGetVendorShipments] TO [DYNGRP]
GO
