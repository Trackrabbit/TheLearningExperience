SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[wfAssignTasks]   @WorkflowStepInstanceID char(37),  @Workflow_Step_Assign_To char(37),  @Workflow_User char(85),  @calculate_due_date tinyint,  @escalate tinyint,  @TempFilePath nvarchar(300),  @assignment_status tinyint OUTPUT,  @approval_tasks_created tinyint OUTPUT  AS  BEGIN set NOCOUNT ON   declare @assigned_task_user char(85)  declare @DueDate datetime,   @DueTime datetime,  @UseWorkflowCalendar tinyint,   @TimeUnit tinyint,   @NumbOfUnits int,  @Workflow_Step_Type smallint,  @WF_AllowOrigApprover tinyint,  @Workflow_Manually_Delega tinyint,  @Workflow_Step_Send_Email tinyint,  @WorkflowInstanceID char(37),  @EmailMessageID char(25),  @WF_Use_Alt_Final_Approv tinyint, @users_found tinyint = 0,  @WF_Alt_FinalApprover char(37),  @Workflow_Type_Name char(51),  @WfBusObjKey char(201),  @Workflow_Originator char(238),  @DocAttachBusObjKey char(200),  @Document_ID char(50),  @DocumentDrillDown varchar(255),  @Originator_Comments varchar(500),  @PriorStepComments varchar(255),  @Workflow_Managers char(37),  @Workflow_Name char(51),  @Workflow_Version int,  @Workflow_Status smallint,   @Workflow_Step_Name char(51),  @Workflow_Error int,  @send_email tinyint,  @CMPANYID nvarchar(6),   @server_name nvarchar(128),   @SystemDB nvarchar(11),  @originatorCommentsDate datetime,  @originatorCommentsTime datetime,  @priorStepCommentsDate datetime,  @priorStepCommentsTime datetime,  @priorStepCommentsUser nvarchar(85),  @Workflow_Action_1 tinyint,  @Workflow_Action_2 tinyint,  @Workflow_Action_3 tinyint,  @Workflow_Action_4 tinyint,  @Workflow_Action_5 tinyint,  @Workflow_Action_6 tinyint,  @Workflow_Action_7 tinyint,  @Workflow_Action_8 tinyint,  @Workflow_Action_9 tinyint,  @Workflow_Action_10 tinyint,  @Single_Action_Available tinyint,  @user_already_assigned tinyint,  @DEX_ROW_ID integer   select @WorkflowStepInstanceID = UPPER(@WorkflowStepInstanceID)  select @Workflow_Step_Assign_To = UPPER(@Workflow_Step_Assign_To)  select @Workflow_User = UPPER(@Workflow_User)   select @assignment_status=1   select @approval_tasks_created=1  select @SystemDB = (select top 1 DBNAME from SY00100)  select @server_name=@@SERVERNAME   select @CMPANYID=DB_NAME()   select @UseWorkflowCalendar=WF_Apply_WF_Calendar, @TimeUnit=WF_Step_Time_Limit_UofM,   @NumbOfUnits=Workflow_Step_Time_Limit,  @Workflow_Step_Type=Workflow_Step_Type,  @WorkflowInstanceID=WorkflowInstanceID,  @Workflow_Step_Name=Workflow_Step_Name,  @Workflow_Name=Workflow_Name,    @Workflow_Version=Workflow_Version,  @Workflow_Step_Send_Email=Workflow_Step_Send_Email,  @EmailMessageID=EmailMessageID  from WFI10003 where WorkflowStepInstanceID=@WorkflowStepInstanceID   select @Workflow_Type_Name=Workflow_Type_Name, @WfBusObjKey=WfBusObjKey,  @Workflow_Originator=Workflow_Originator, @WF_AllowOrigApprover=WF_AllowOrigApprover,  @Workflow_Manually_Delega=Workflow_Manually_Delega,  @WF_Use_Alt_Final_Approv=WF_Use_Alt_Final_Approv, @WF_Alt_FinalApprover=UPPER(WF_Alt_FinalApprover)  from WFI10002 where WorkflowInstanceID=@WorkflowInstanceID  select @Workflow_Managers=UPPER(Workflow_Managers) from WF100001 where Workflow_Type_Name = @Workflow_Type_Name   if @Workflow_Step_Assign_To<>''   begin  delete from WFI10005 where Workflow_User=@Workflow_User  exec DYNAMICS.dbo.GetAssignedUsers  @Workflow_User,   @Workflow_Step_Assign_To,  @Workflow_Type_Name,  @Workflow_Name,  @Workflow_Version,  @WorkflowInstanceID,  @Workflow_Step_Name,  @WorkflowStepInstanceID,  @server_name,  @CMPANYID,  @SystemDB   delete from WFI10005 where UPPER(Workflow_User)=@Workflow_User   and UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID and (UsersListGuid='' and WorkflowTaskAssignedTo='')  if @WF_AllowOrigApprover=0 and @Workflow_Step_Type=1   begin  delete from WFI10005 where UPPER(Workflow_User)=@Workflow_User   and UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID   and UPPER(rtrim(@Workflow_Originator))=UPPER(rtrim(WorkflowTaskAssignedTo))  end    end   if @calculate_due_date>0  begin  exec wfCalculateDueDate @UseWorkflowCalendar, @TimeUnit, @NumbOfUnits, @DueDate output, @DueTime output  end  else  begin  if (select COUNT(*) from WFI10004 where UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID)>0  begin  select TOP 1 @DueDate=Workflow_Due_Date, @DueTime=Workflow_Due_Time  from WFI10004 with (nolock, index=AK2WFI10004)   where UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID   end  else  begin  exec wfCalculateDueDate @UseWorkflowCalendar, @TimeUnit, @NumbOfUnits, @DueDate output, @DueTime output  end  end   if (select COUNT(*) from WFI10005 where Workflow_User=@Workflow_User and WorkflowStepInstanceID=@WorkflowStepInstanceID)=0  begin   if @WF_Use_Alt_Final_Approv>0  begin  select @Workflow_Step_Assign_To=@WF_Alt_FinalApprover    if @Workflow_Step_Assign_To<>''  begin  delete from WFI10005 where Workflow_User=@Workflow_User and UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID  exec DYNAMICS.dbo.GetAssignedUsers   @Workflow_User,  @Workflow_Step_Assign_To,  @Workflow_Type_Name,  @Workflow_Name,  @Workflow_Version,  @WorkflowInstanceID,  @Workflow_Step_Name,  @WorkflowStepInstanceID,  @server_name,  @CMPANYID,  @SystemDB  delete from WFI10005 where UPPER(Workflow_User)=@Workflow_User   and UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID and (UsersListGuid='' and WorkflowTaskAssignedTo='')   if (select COUNT(*) from WFI10005 where Workflow_User=@Workflow_User and UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID)>0  begin  select @users_found=1  end  end  end   if @users_found=0   begin  select @Workflow_Step_Assign_To=UPPER(Workflow_Managers) from WF100001   where Workflow_Type_Name=@Workflow_Type_Name  if @Workflow_Step_Assign_To<>''  begin  delete from WFI10005 where Workflow_User=@Workflow_User and UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID  exec DYNAMICS.dbo.GetAssignedUsers   @Workflow_User,  @Workflow_Step_Assign_To,  @Workflow_Type_Name,  @Workflow_Name,  @Workflow_Version,  @WorkflowInstanceID,  @Workflow_Step_Name,  @WorkflowStepInstanceID,  @server_name,  @CMPANYID,  @SystemDB   delete from WFI10005 where UPPER(Workflow_User)=@Workflow_User   and UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID and (UsersListGuid='' and WorkflowTaskAssignedTo='')   if (select COUNT(*) from WFI10005 where Workflow_User=@Workflow_User and UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID)=0  begin  if @escalate=0  begin  delete from WFI10005 where Workflow_User=@Workflow_User  end  select @assignment_status=2   RETURN  end  end  else  begin  if @escalate=0  begin  delete from WFI10005 where Workflow_User=@Workflow_User  end  select @assignment_status=2   RETURN  end  end  end   declare Step_Instance_Assigned_Users cursor local fast_forward for  select UPPER(WorkflowTaskAssignedTo),DEX_ROW_ID from WFI10005 where Workflow_User=@Workflow_User and UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID   open Step_Instance_Assigned_Users  fetch next from Step_Instance_Assigned_Users into @assigned_task_user, @DEX_ROW_ID  while @@FETCH_STATUS=0  begin  exec wfOutOfOfficeDelegation  @Workflow_User,  @assigned_task_user,  @Workflow_Name,  @Workflow_Step_Name,  @DueDate,   @DueTime,  @Workflow_Type_Name,  @WF_AllowOrigApprover,  @Workflow_Manually_Delega,  @Workflow_Originator,  @WorkflowStepInstanceID,  @DEX_ROW_ID,  @Workflow_Error OUTPUT  fetch next from Step_Instance_Assigned_Users into @assigned_task_user, @DEX_ROW_ID  end  close Step_Instance_Assigned_Users  deallocate Step_Instance_Assigned_Users   if (select count(WorkflowTaskAssignedTo) from WFI10005 where Workflow_User=@Workflow_User and UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID )>0  begin   update WFI10002 set Workflow_Status=4  where WorkflowInstanceID=@WorkflowInstanceID  end   select @send_email = 0  if (select top 1 isnull(Enable_Workflow_Email, 0) from WF00100) > 0  begin   if @Workflow_Step_Send_Email>0 and   (@EmailMessageID<>'' and (select count(EmailMessageID)   from SY04901 where EmailMessageID=@EmailMessageID and Email_Message_Type=2)>0)  begin  exec wfGetAssignmentEmailInformation   @WorkflowInstanceID,  @WorkflowStepInstanceID,   @DocAttachBusObjKey OUTPUT,   @Document_ID OUTPUT,  @DocumentDrillDown OUTPUT,  @Originator_Comments OUTPUT,  @originatorCommentsDate OUTPUT,  @originatorCommentsTime OUTPUT,   @Workflow_Managers OUTPUT,  @Workflow_Name OUTPUT,  @Workflow_Originator OUTPUT,  @Workflow_Status OUTPUT,  @Workflow_Step_Name OUTPUT,  @Workflow_Error OUTPUT  select @send_email=1   end  end   declare @originalWFI10005 TABLE(  Workflow_User char(85),  WorkflowStepInstanceID char(37),  UsersListGuid char(37),  WorkflowTaskAssignedTo char(85),  EMail char(255),  ADDisplayName char(255) )  insert into @originalWFI10005  select Workflow_User,WorkflowStepInstanceID,UsersListGuid,WorkflowTaskAssignedTo,EMail,ADDisplayName  from WFI10005 where Workflow_User=@Workflow_User    declare Step_Instance_Assigned_Users cursor local fast_forward for  select UPPER(WorkflowTaskAssignedTo) from WFI10005 where Workflow_User=@Workflow_User and UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID   open Step_Instance_Assigned_Users  fetch next from Step_Instance_Assigned_Users into @assigned_task_user  while @@FETCH_STATUS=0  begin   select @user_already_assigned=0  if @escalate=0  begin  if (select count(WorkflowStepInstanceID) from WFI10004   where WorkflowInstanceID=@WorkflowInstanceID and WorkflowStepInstanceID=@WorkflowStepInstanceID  and upper(WorkflowTaskAssignedTo)=@assigned_task_user)>0   begin  select @user_already_assigned=1  select @assignment_status=0   end  end  if @escalate=1  begin  if (select count(WorkflowStepInstanceID) from WFI10004   where WorkflowInstanceID=@WorkflowInstanceID and WorkflowStepInstanceID=@WorkflowStepInstanceID  and upper(WorkflowTaskAssignedTo)=@assigned_task_user and Workflow_Task_Escalated=1)>0   begin  select @user_already_assigned=1  select @assignment_status=0   end  end   if @user_already_assigned=0  begin   if @escalate=1  begin  if (select count(WorkflowStepInstanceID) from WFI10004   where WorkflowInstanceID=@WorkflowInstanceID and WorkflowStepInstanceID=@WorkflowStepInstanceID  and upper(WorkflowTaskAssignedTo)=@assigned_task_user and Workflow_Task_Escalated=0)>0  begin  delete from WFI10004 where WorkflowInstanceID=@WorkflowInstanceID and WorkflowStepInstanceID=@WorkflowStepInstanceID  and upper(WorkflowTaskAssignedTo)=@assigned_task_user and Workflow_Task_Escalated=0  end   end   if @Workflow_Step_Type=2    or (@Workflow_Step_Type=1 and   ((@WF_AllowOrigApprover=1) or  (@WF_AllowOrigApprover=0 and rtrim(@Workflow_Originator)<>RTRIM(@assigned_task_user))))  begin  insert into WFI10004  select @WorkflowInstanceID,@WorkflowStepInstanceID,@assigned_task_user,@Workflow_Step_Name,  @Workflow_Name,Workflow_Version,WF_Step_Description,'','',  @DueDate,@DueTime,Workflow_Step_Sequence,Workflow_Step_Type,Workflow_Step_Order,  WF_Step_Predecessor,WF_Step_Completion_Polic,@escalate,SYSDATETIME()  from WFI10003 where UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID   update WFI10002 set Workflow_Status=4  where WorkflowInstanceID=@WorkflowInstanceID  if @send_email>0  begin  exec wfAllowableActions @Workflow_Type_Name, @WfBusObjKey, @WorkflowInstanceID,   @WorkflowStepInstanceID, @assigned_task_user, 0,  0,   @Workflow_Action_1 OUTPUT, @Workflow_Action_2 OUTPUT, @Workflow_Action_3 OUTPUT,   @Workflow_Action_4 OUTPUT, @Workflow_Action_5 OUTPUT, @Workflow_Action_6 OUTPUT,   @Workflow_Action_7 OUTPUT, @Workflow_Action_8 OUTPUT, @Workflow_Action_9 OUTPUT,   @Workflow_Action_10 OUTPUT, @Single_Action_Available OUTPUT, @Workflow_Error OUTPUT  delete from WFI10005 where Workflow_User=@Workflow_User  insert into WFI10005  select Workflow_User,WorkflowStepInstanceID,UsersListGuid,WorkflowTaskAssignedTo,EMail,ADDisplayName  from @originalWFI10005   exec DYNAMICS.dbo.SendWorkflowAssignmentEmail   @WorkflowInstanceID,  @WorkflowStepInstanceID,  @EmailMessageID,  @Workflow_Version,  @assigned_task_user,   @DueDate,  @DueTime,  @DocAttachBusObjKey,  @DocumentDrillDown,  @Document_ID,  @Originator_Comments,  @originatorCommentsDate,  @originatorCommentsTime,  @Workflow_Managers,  @Workflow_Name,  @Workflow_Type_Name,  @Workflow_Originator,  @Workflow_Status,  @Workflow_Step_Name,  @server_name,  @CMPANYID,  @SystemDB,  @Workflow_Action_3,  @Workflow_Action_4,  @Workflow_Action_5,  @Workflow_Action_6,  @Workflow_Action_7,  @TempFilePath,  @Workflow_Error out  end   if @Workflow_Step_Type=1  begin  select @approval_tasks_created=1  end  select @assignment_status=0  end  end  fetch next from Step_Instance_Assigned_Users into @assigned_task_user  end  close Step_Instance_Assigned_Users  deallocate Step_Instance_Assigned_Users   if @escalate=0  begin  delete from WFI10005 where @Workflow_User=@Workflow_User  end  END   
GO
GRANT EXECUTE ON  [dbo].[wfAssignTasks] TO [DYNGRP]
GO
