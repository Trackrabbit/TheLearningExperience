SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[taMCCurrencyValidate] @I_vMASTERID char(15)='',   @I_vDOCDATE datetime,     @I_vCURNCYID char(15)= '',   @I_vEXGTBDSC char(30) = '',   @I_vEXTBLSRC char(50) = '',   @I_vRATEEXPR smallint = -1 output,    @I_vDYSTINCR smallint = -1 output,  @I_vRATEVARC numeric(19,7)=0,   @I_vTRXDTDEF smallint = -1,   @I_vPRVDSLMT smallint = 0,   @I_vDATELMTS smallint = 0,   @I_vMODULE int = 0,    @I_vEXCHDATE datetime = '' output,  @I_vRTCLCMTD smallint = -1 output,  @I_vTIME1 datetime = '' output,   @I_vXCHGRATE numeric(19,7) = 0 output,  @I_vEXPNDATE datetime= '' output,  @I_vRATETPID char(15) = '' output,  @I_vEXGTBLID char(15) = '' output,  @O_iErrorState int output,   @oErrString varchar(255) output    with encryption as  set transaction isolation level read uncommitted set nocount on  declare  @RATECALC smallint,     @CMPANYID smallint,     @iAddCodeErrState int,     @iStatus int,      @O_oErrorState int,  @TRXDTDEF int,  @PRVDSLMT int,  @DATELMTS int,  @verifytime int  select  @RATECALC = 0,  @CMPANYID = 0,  @iAddCodeErrState = 0,  @iStatus = 0,  @O_oErrorState = 0,  @O_iErrorState = 0,  @TRXDTDEF = 0,  @PRVDSLMT = 0,  @DATELMTS = 0,  @verifytime = 1  if @oErrString is NULL begin  select @oErrString = '' end  if ( @I_vMASTERID is NULL or  @I_vDOCDATE is NULL or  @I_vCURNCYID is NULL or  @I_vEXCHDATE is NULL or  @I_vTIME1 is NULL or  @I_vXCHGRATE is NULL or  @I_vEXPNDATE is NULL or  @I_vEXGTBLID is NULL) begin  select @O_iErrorState = 355    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output end  select @I_vMASTERID = UPPER(@I_vMASTERID),  @I_vCURNCYID = UPPER(@I_vCURNCYID)  select @CMPANYID = CMPANYID from DYNAMICS..SY01500 (nolock) where INTERID = db_name()  if (IsNull(@CMPANYID,0) = 0) begin  select top 1 @CMPANYID = CMPANYID from SY00600 end  if not exists(select 1 from DYNAMICS..MC40200 (nolock) where CURNCYID = @I_vCURNCYID ) begin  select @O_iErrorState = 483     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if not exists(select 1 from DYNAMICS..MC60100 (nolock) where CURNCYID = @I_vCURNCYID and CMPANYID = @CMPANYID and INACTIVE = 0) begin  select @O_iErrorState = 492     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if (@I_vRATETPID <> '') begin  if (not exists(select 1 from MC40100 (nolock) where RATETPID = @I_vRATETPID))  begin  select @O_iErrorState = 434     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState)  end end  if (@I_vRATETPID = '') begin  if (@I_vMODULE = 0)  begin  select @I_vRATETPID = RATETPID from PM00200 (nolock) where VENDORID = @I_vMASTERID   if (@I_vRATETPID = '')  begin  select @I_vRATETPID = DEFPURTP from MC40000 (nolock)  end  end  else  begin  if (@I_vMODULE = 1)  begin  select @I_vRATETPID = RATETPID from RM00101 (nolock) where CUSTNMBR = @I_vMASTERID   if (@I_vRATETPID = '')  begin  select @I_vRATETPID = DEFSLSTP from MC40000 (nolock)  end  end  else  begin  if (@I_vMODULE = 2)  begin  select @I_vRATETPID = DEFFINTP from MC40000 (nolock)  end  else  begin  if (@I_vMODULE = 3)  begin  select @I_vRATETPID = DepositRateTypeID from CM00100 (nolock) where CHEKBKID = @I_vMASTERID   if (@I_vRATETPID = '')  begin  select @I_vRATETPID = DEFFINTP from MC40000 (nolock)  end  end  else  begin  if (@I_vMODULE = 4)  begin  select @I_vRATETPID = PaymentRateTypeID from CM00100 (nolock) where CHEKBKID = @I_vMASTERID   if (@I_vRATETPID = '')  begin  select @I_vRATETPID = DEFFINTP from MC40000 (nolock)  end  end  end  end  end  end   if (@I_vRATETPID = '')  begin  select @O_iErrorState = 356     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState)  end end  if (@I_vEXGTBLID = '') begin  select @I_vEXGTBLID = EXGTBLID from MC40301 (nolock) where CURNCYID = @I_vCURNCYID and RATETPID = @I_vRATETPID   if (@I_vEXGTBLID = '')  begin  select @O_iErrorState = 696     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState)  end end else begin  if not exists(select 1 from MC40301 (nolock) where CURNCYID = @I_vCURNCYID and RATETPID = @I_vRATETPID and EXGTBLID = @I_vEXGTBLID)  begin  select @O_iErrorState = 6349     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState)  end end  select   @I_vRATEEXPR = case when (@I_vRATEEXPR = -1) then RATEEXPR else @I_vRATEEXPR end,  @I_vDYSTINCR = case when (@I_vDYSTINCR = -1) then DYSTINCR else @I_vDYSTINCR end,  @I_vRTCLCMTD = case when (@I_vRTCLCMTD = -1) then RTCLCMTD else @I_vRTCLCMTD end,  @RATECALC = RTCLCMTD,  @TRXDTDEF = TRXDTDEF,  @PRVDSLMT = PRVDSLMT,  @DATELMTS = DATELMTS  from DYNAMICS..MC40300 (nolock) where EXGTBLID = @I_vEXGTBLID  if (@I_vRTCLCMTD not in (0,1)) begin  select @O_iErrorState = 691     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState) end  if (@I_vRTCLCMTD <> @RATECALC)  begin  if (exists(select 1 from DYNAMICS..MC00100 (nolock) where EXGTBLID = @I_vEXGTBLID))  begin  select @O_iErrorState = 690     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState)  end end  if (@I_vXCHGRATE = 0) begin   if (@I_vEXCHDATE = '')  begin  if ((@TRXDTDEF = 1) and (@DATELMTS = 1))     begin  select top 1 @I_vXCHGRATE = isnull(XCHGRATE,0), @I_vEXCHDATE = isnull(EXCHDATE,''), @I_vTIME1 = isnull(TIME1,''),  @I_vEXPNDATE = isnull(EXPNDATE,'') from DYNAMICS..MC00100 (nolock)  where EXGTBLID = @I_vEXGTBLID  and EXCHDATE <= @I_vDOCDATE  and abs(datediff(day, EXCHDATE, @I_vDOCDATE)) <= @PRVDSLMT  and (EXPNDATE >= @I_vDOCDATE or EXPNDATE = '')  and TIME1 =  case  when @I_vTIME1 <> ''  then @I_vTIME1  else TIME1  end  order by EXCHDATE desc,TIME1 desc  if (@I_vXCHGRATE = 0)   select top 1 @I_vXCHGRATE = isnull(XCHGRATE,0), @I_vEXCHDATE = isnull(EXCHDATE,''), @I_vTIME1 = isnull(TIME1,''),  @I_vEXPNDATE = isnull(EXPNDATE,'') from DYNAMICS..MC00100 (nolock)  where EXGTBLID = @I_vEXGTBLID  and EXCHDATE >= @I_vDOCDATE  and abs(datediff(day, EXCHDATE, @I_vDOCDATE)) <= @PRVDSLMT  and (EXPNDATE >= @I_vDOCDATE or EXPNDATE = '')  and TIME1 =  case  when @I_vTIME1 <> ''  then @I_vTIME1  else TIME1  end  order by EXCHDATE,TIME1   end  else   if ((@TRXDTDEF = 1) and (@DATELMTS = 0))    begin  select top 1 @I_vXCHGRATE = isnull(XCHGRATE,0), @I_vEXCHDATE = isnull(EXCHDATE,''), @I_vTIME1 = isnull(TIME1,''),  @I_vEXPNDATE = isnull(EXPNDATE,'') from DYNAMICS..MC00100 (nolock)  where EXGTBLID = @I_vEXGTBLID  and EXCHDATE <= @I_vDOCDATE  and (EXPNDATE >= @I_vDOCDATE or EXPNDATE = '')  and TIME1 =  case  when @I_vTIME1 <> ''  then @I_vTIME1  else TIME1  end  order by EXCHDATE desc,TIME1 desc  if (@I_vXCHGRATE = 0)   select top 1 @I_vXCHGRATE = isnull(XCHGRATE,0), @I_vEXCHDATE = isnull(EXCHDATE,''), @I_vTIME1 = isnull(TIME1,''),  @I_vEXPNDATE = isnull(EXPNDATE,'') from DYNAMICS..MC00100 (nolock)  where EXGTBLID = @I_vEXGTBLID  and EXCHDATE >= @I_vDOCDATE  and (EXPNDATE >= @I_vDOCDATE or EXPNDATE = '')  and TIME1 =  case  when @I_vTIME1 <> ''  then @I_vTIME1  else TIME1  end  order by EXCHDATE,TIME1  end  else  if ((@TRXDTDEF = 2) and (@DATELMTS = 1))    begin  select top 1 @I_vXCHGRATE = isnull(XCHGRATE,0), @I_vEXCHDATE = isnull(EXCHDATE,''), @I_vTIME1 = isnull(TIME1,''),  @I_vEXPNDATE = isnull(EXPNDATE,'') from DYNAMICS..MC00100 (nolock)  where EXGTBLID = @I_vEXGTBLID  and EXCHDATE >= @I_vDOCDATE  and abs(datediff(day, EXCHDATE, @I_vDOCDATE)) <= @PRVDSLMT  and (EXPNDATE >= @I_vDOCDATE or EXPNDATE = '')  and TIME1 =  case  when @I_vTIME1 <> ''  then @I_vTIME1  else TIME1  end  order by EXCHDATE,TIME1   if (@I_vXCHGRATE = 0)    select top 1 @I_vXCHGRATE = isnull(XCHGRATE,0), @I_vEXCHDATE = isnull(EXCHDATE,''), @I_vTIME1 = isnull(TIME1,''),  @I_vEXPNDATE = isnull(EXPNDATE,'') from DYNAMICS..MC00100 (nolock)  where EXGTBLID = @I_vEXGTBLID  and EXCHDATE <= @I_vDOCDATE  and abs(datediff(day, EXCHDATE, @I_vDOCDATE)) <= @PRVDSLMT  and (EXPNDATE >= @I_vDOCDATE or EXPNDATE = '')  and TIME1 =  case  when @I_vTIME1 <> ''  then @I_vTIME1  else TIME1  end  order by EXCHDATE desc,TIME1 desc  end  else  if ((@TRXDTDEF = 2) and (@DATELMTS = 0))    begin  select top 1 @I_vXCHGRATE = isnull(XCHGRATE,0), @I_vEXCHDATE = isnull(EXCHDATE,''), @I_vTIME1 = isnull(TIME1,''),  @I_vEXPNDATE = isnull(EXPNDATE,'') from DYNAMICS..MC00100 (nolock)   where EXGTBLID = @I_vEXGTBLID   and EXCHDATE >= @I_vDOCDATE   and (EXPNDATE >= @I_vDOCDATE or EXPNDATE = '')  and TIME1 =   case  when @I_vTIME1 <> ''  then @I_vTIME1  else TIME1  end   order by EXCHDATE,TIME1   if (@I_vXCHGRATE = 0)    select top 1 @I_vXCHGRATE = isnull(XCHGRATE,0), @I_vEXCHDATE = isnull(EXCHDATE,''), @I_vTIME1 = isnull(TIME1,''),  @I_vEXPNDATE = isnull(EXPNDATE,'') from DYNAMICS..MC00100 (nolock)  where EXGTBLID = @I_vEXGTBLID  and EXCHDATE <= @I_vDOCDATE  and (EXPNDATE >= @I_vDOCDATE or EXPNDATE = '')  and TIME1 =  case  when @I_vTIME1 <> ''  then @I_vTIME1  else TIME1  end  order by EXCHDATE desc,TIME1 desc  end  else   select top 1 @I_vXCHGRATE = isnull(XCHGRATE,0), @I_vEXCHDATE = isnull(EXCHDATE,''), @I_vTIME1 = isnull(TIME1,''),  @I_vEXPNDATE = isnull(EXPNDATE,'') from DYNAMICS..MC00100 (nolock)  where EXGTBLID = @I_vEXGTBLID  and EXCHDATE = @I_vDOCDATE  and (EXPNDATE >= @I_vDOCDATE or EXPNDATE = '')  and TIME1 =  case  when @I_vTIME1 <> ''  then @I_vTIME1  else TIME1  end  order by EXCHDATE,TIME1 desc  select @verifytime = 0  if (@I_vXCHGRATE = 0)   begin   select @O_iErrorState = 9389     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState)  end  end   else  begin  if not exists(select top 1 1 from DYNAMICS..MC00100 (nolock) where EXGTBLID = @I_vEXGTBLID   and EXCHDATE = @I_vEXCHDATE and @I_vEXPNDATE < @I_vDOCDATE)  begin   select @O_iErrorState = 6348     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState)  end  end   if @verifytime = 1   begin  if (@I_vTIME1 = '')  begin  select @I_vTIME1 = isnull(max(TIME1),'') from DYNAMICS..MC00100 (nolock)  where EXGTBLID = @I_vEXGTBLID and EXCHDATE = @I_vEXCHDATE  end  else  begin  if not exists(select 1 from DYNAMICS..MC00100 (nolock) where EXGTBLID = @I_vEXGTBLID and EXCHDATE = @I_vEXCHDATE and TIME1 = @I_vTIME1)  begin  select @O_iErrorState = 6347     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState)  end  end  select @I_vEXPNDATE = EXPNDATE from DYNAMICS..MC00100 (nolock)  where EXGTBLID = @I_vEXGTBLID and EXCHDATE = @I_vEXCHDATE and TIME1 = @I_vTIME1   if (@I_vEXPNDATE >= @I_vDOCDATE )  begin  select @I_vXCHGRATE = XCHGRATE from DYNAMICS..MC00100 (nolock)  where EXGTBLID = @I_vEXGTBLID and EXCHDATE = @I_vEXCHDATE and TIME1 = @I_vTIME1  end  if (@I_vEXPNDATE < @I_vDOCDATE)  begin  select @O_iErrorState = 267     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState)  end  end end else  begin  if (@I_vEXCHDATE = '')  begin   select @I_vEXCHDATE = isnull(max(EXCHDATE),'') from DYNAMICS..MC00100 (nolock)  where EXGTBLID = @I_vEXGTBLID and XCHGRATE = @I_vXCHGRATE  end   if (@I_vTIME1 = '')  begin   select @I_vTIME1 = isnull(max(TIME1),'') from DYNAMICS..MC00100 (nolock)  where EXGTBLID = @I_vEXGTBLID and EXCHDATE = @I_vEXCHDATE and XCHGRATE = @I_vXCHGRATE  end   if (@I_vEXPNDATE = '')  begin  select @I_vEXPNDATE = isnull(max(EXPNDATE),'') from DYNAMICS..MC00100 (nolock)  where EXGTBLID = @I_vEXGTBLID and XCHGRATE = @I_vXCHGRATE and  EXCHDATE = @I_vEXCHDATE and TIME1 = @I_vTIME1 and  XCHGRATE = @I_vXCHGRATE  end   if (@I_vEXPNDATE < @I_vDOCDATE)  begin   select @I_vEXCHDATE = @I_vDOCDATE,  @I_vEXPNDATE = '',  @I_vTIME1 = ' '+ substring(convert(varchar(25),getdate()),12,12)  end end  exec @iStatus = taMCExchangeRate  @I_vCURNCYID = @I_vCURNCYID,  @I_vEXGTBDSC = @I_vEXGTBDSC,  @I_vEXTBLSRC = @I_vEXTBLSRC,  @I_vRATEEXPR = @I_vRATEEXPR,  @I_vDYSTINCR = @I_vDYSTINCR,  @I_vRATEVARC = @I_vRATEVARC,  @I_vTRXDTDEF = @I_vTRXDTDEF,  @I_vRTCLCMTD = @I_vRTCLCMTD,  @I_vPRVDSLMT = @I_vPRVDSLMT,  @I_vDATELMTS = @I_vDATELMTS,  @I_vEXCHDATE = @I_vEXCHDATE output,  @I_vEXGTBLID = @I_vEXGTBLID output,  @I_vTIME1 = @I_vTIME1 output,  @I_vXCHGRATE = @I_vXCHGRATE output,  @I_vEXPNDATE = @I_vEXPNDATE output,  @oErrString = @oErrString output,  @O_iErrorState = @O_iErrorState output if (@@error <> 0) begin  select @O_iErrorState = 354   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState) end  if (@iStatus <> 0) or (@O_iErrorState <> 0) begin  if (@O_iErrorState <> 0)  begin  return (@O_iErrorState)  end  select @O_iErrorState = 353   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState) end  return (@O_iErrorState)   
GO
GRANT EXECUTE ON  [dbo].[taMCCurrencyValidate] TO [DYNGRP]
GO
