SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[seePOPTopTenRequisitionItemsByAmt30DaysMetric]   @UserDate datetime = NULL,  @I_iNumItems int   = NULL,  @I_iPeriodDays int   = NULL,  @Vendor varchar(max),  @ItemNumber varchar(max)   as set nocount ON  declare @dtStart datetime declare @dtEnd datetime  declare @ValuesTable table (Value nvarchar(500))  if (@Vendor != '') or ISNULL(@Vendor, '0') = '0' begin  insert into @ValuesTable select * from dbo.seeSplitString(@Vendor, ',') end else begin  insert into @ValuesTable select * from dbo.seeSplitString(@ItemNumber, ',') end  select  @UserDate = DATEADD(HOUR, -DATEPART(HOUR, @UserDate), @UserDate) select  @UserDate = DATEADD(MINUTE, -DATEPART(MINUTE, @UserDate), @UserDate) select  @UserDate = DATEADD(SECOND, -DATEPART(SECOND, @UserDate), @UserDate) select  @UserDate = DATEADD(MILLISECOND, -DATEPART(MILLISECOND, @UserDate), @UserDate)  set @dtEnd = @UserDate - 1  set @dtStart = @dtEnd - @I_iPeriodDays  CREATE TABLE dbo.#ItemQtys (ITEMNMBR char(51) NOT NULL,   QTYORDER numeric(19,5),   UNITCOST numeric(19,5),  REQDATE datetime,  Filter varchar(31))   CREATE INDEX AK2#ItemQtys ON #ItemQtys (ITEMNMBR)   if (@Vendor = '' or ISNULL(@Vendor, '0') = '0') and   (@ItemNumber = '' or ISNULL(@ItemNumber, '0') = '0') begin  insert #ItemQtys (ITEMNMBR, QTYORDER, UNITCOST, REQDATE, Filter)   select   rtrim(PurchReqLineWork.ITEMNMBR) +  ' - ' +   substring(PurchReqLineWork.ITEMDESC,1,10) as Item,  PurchReqLineWork.QTYORDER as Qty,  PurchReqLineWork.UNITCOST +   PurchReqLineWork.FRTAMNT +   PurchReqLineWork.TAXAMNT as UnitCost,  PurchReqLineWork.REQDATE as ReqDate,  '' as Filter  from POP10210 as PurchReqLineWork  where PurchReqLineWork.REQDATE between @dtStart and @dtEnd  and PurchReqLineWork.NONINVEN = 1  union all  select   rtrim(PurchReqLineHist.ITEMNMBR) +  ' - ' +  substring(PurchReqLineHist.ITEMDESC,1,10) as Item,  PurchReqLineHist.QTYORDER as Qty,  PurchReqLineHist.UNITCOST +   PurchReqLineHist.FRTAMNT +   PurchReqLineHist.TAXAMNT as UnitCost,  PurchReqLineHist.REQDATE as ReqDate,  '' as Filter  from POP30210 as PurchReqLineHist  where PurchReqLineHist.REQDATE between @dtStart and @dtEnd  and PurchReqLineHist.NONINVEN = 1  union all  select   rtrim(PurchReqLineWork.ITEMNMBR) as Item,  PurchReqLineWork.QTYORDER as Qty,  PurchReqLineWork.UNITCOST +   PurchReqLineWork.FRTAMNT +   PurchReqLineWork.TAXAMNT as UnitCost,  PurchReqLineWork.REQDATE as ReqDate,  '' as Filter  from POP10210 as PurchReqLineWork  where PurchReqLineWork.REQDATE between @dtStart and @dtEnd  and PurchReqLineWork.NONINVEN = 0  union all  select   rtrim(PurchReqLineHist.ITEMNMBR) as Item,  PurchReqLineHist.QTYORDER as Qty,  PurchReqLineHist.UNITCOST +   PurchReqLineHist.FRTAMNT +   PurchReqLineHist.TAXAMNT as UnitCost,  PurchReqLineHist.REQDATE as ReqDate,  '' as Filter  from POP30210 as PurchReqLineHist  where PurchReqLineHist.REQDATE between @dtStart and @dtEnd  and PurchReqLineHist.NONINVEN = 0 end else begin  if @Vendor = '' or ISNULL(@Vendor, '0') = '0'  begin  insert #ItemQtys (ITEMNMBR, QTYORDER, UNITCOST, REQDATE, Filter)   select   rtrim(PurchReqLineWork.ITEMNMBR) +  ' - ' +   substring(PurchReqLineWork.ITEMDESC,1,10) as Item,  PurchReqLineWork.QTYORDER as Qty,  PurchReqLineWork.UNITCOST +   PurchReqLineWork.FRTAMNT +   PurchReqLineWork.TAXAMNT as UnitCost,  PurchReqLineWork.REQDATE as ReqDate,  PurchReqLineWork.VENDORID as Filter  from POP10210 as PurchReqLineWork  where PurchReqLineWork.REQDATE between @dtStart and @dtEnd  and PurchReqLineWork.NONINVEN = 1  and PurchReqLineWork.ITEMNMBR <> ''   union all  select   rtrim(PurchReqLineHist.ITEMNMBR) +  ' - ' +  substring(PurchReqLineHist.ITEMDESC,1,10) as Item,  PurchReqLineHist.QTYORDER as Qty,  PurchReqLineHist.UNITCOST +   PurchReqLineHist.FRTAMNT +   PurchReqLineHist.TAXAMNT as UnitCost,  PurchReqLineHist.REQDATE as ReqDate,  PurchReqLineHist.VENDORID as Filter  from POP30210 as PurchReqLineHist  where PurchReqLineHist.REQDATE between @dtStart and @dtEnd  and PurchReqLineHist.NONINVEN = 1  and PurchReqLineHist.ITEMNMBR <> ''   union all  select   rtrim(PurchReqLineWork.ITEMNMBR) as Item,  PurchReqLineWork.QTYORDER as Qty,  PurchReqLineWork.UNITCOST +   PurchReqLineWork.FRTAMNT +   PurchReqLineWork.TAXAMNT as UnitCost,  PurchReqLineWork.REQDATE as ReqDate,  PurchReqLineWork.VENDORID as Filter  from POP10210 as PurchReqLineWork  where PurchReqLineWork.REQDATE between @dtStart and @dtEnd  and PurchReqLineWork.NONINVEN = 0  and PurchReqLineWork.ITEMNMBR <> ''   union all  select   rtrim(PurchReqLineHist.ITEMNMBR) as Item,  PurchReqLineHist.QTYORDER as Qty,  PurchReqLineHist.UNITCOST +   PurchReqLineHist.FRTAMNT +   PurchReqLineHist.TAXAMNT as UnitCost,  PurchReqLineHist.REQDATE as ReqDate,  PurchReqLineHist.VENDORID as Filter  from POP30210 as PurchReqLineHist  where PurchReqLineHist.REQDATE between @dtStart and @dtEnd  and PurchReqLineHist.NONINVEN = 0  and PurchReqLineHist.ITEMNMBR <> ''   end  else  begin   insert #ItemQtys (ITEMNMBR, QTYORDER, UNITCOST, REQDATE, Filter)   select   rtrim(PurchReqLineWork.ITEMNMBR) +  ' - ' +   substring(PurchReqLineWork.ITEMDESC,1,10) as Item,  PurchReqLineWork.QTYORDER as Qty,  PurchReqLineWork.UNITCOST +   PurchReqLineWork.FRTAMNT +   PurchReqLineWork.TAXAMNT as UnitCost,  PurchReqLineWork.REQDATE as ReqDate,  PurchReqLineWork.ITEMNMBR as Filter  from POP10210 as PurchReqLineWork  where PurchReqLineWork.REQDATE between @dtStart and @dtEnd  and PurchReqLineWork.NONINVEN = 1  and PurchReqLineWork.ITEMNMBR <> ''   union all  select   rtrim(PurchReqLineHist.ITEMNMBR) +  ' - ' +  substring(PurchReqLineHist.ITEMDESC,1,10) as Item,  PurchReqLineHist.QTYORDER as Qty,  PurchReqLineHist.UNITCOST +   PurchReqLineHist.FRTAMNT +   PurchReqLineHist.TAXAMNT as UnitCost,  PurchReqLineHist.REQDATE as ReqDate,  PurchReqLineHist.ITEMNMBR as Filter  from POP30210 as PurchReqLineHist  where PurchReqLineHist.REQDATE between @dtStart and @dtEnd  and PurchReqLineHist.NONINVEN = 1  and PurchReqLineHist.ITEMNMBR <> ''   union all  select   rtrim(PurchReqLineWork.ITEMNMBR) as Item,  PurchReqLineWork.QTYORDER as Qty,  PurchReqLineWork.UNITCOST +   PurchReqLineWork.FRTAMNT +   PurchReqLineWork.TAXAMNT as UnitCost,  PurchReqLineWork.REQDATE as ReqDate,  PurchReqLineWork.ITEMNMBR as Filter  from POP10210 as PurchReqLineWork  where PurchReqLineWork.REQDATE between @dtStart and @dtEnd  and PurchReqLineWork.NONINVEN = 0  and PurchReqLineWork.ITEMNMBR <> ''   union all  select   rtrim(PurchReqLineHist.ITEMNMBR) as Item,  PurchReqLineHist.QTYORDER as Qty,  PurchReqLineHist.UNITCOST +   PurchReqLineHist.FRTAMNT +   PurchReqLineHist.TAXAMNT as UnitCost,  PurchReqLineHist.REQDATE as ReqDate,  PurchReqLineHist.ITEMNMBR as Filter  from POP30210 as PurchReqLineHist  where PurchReqLineHist.REQDATE between @dtStart and @dtEnd  and PurchReqLineHist.NONINVEN = 0  and PurchReqLineHist.ITEMNMBR <> ''   end end   if (@Vendor = '' or ISNULL(@Vendor, '0') = '0') and   (@ItemNumber = '' or ISNULL(@ItemNumber, '0') = '0') begin     select top (select @I_iNumItems) sum(round(ItemQtys.QTYORDER * ItemQtys.UNITCOST, 2)) as TotalAmount,   ItemQtys.ITEMNMBR as Item, Filter from #ItemQtys as ItemQtys with (NOLOCK)  where ItemQtys.REQDATE between @dtStart and @dtEnd  group by ItemQtys.ITEMNMBR, Filter order by TotalAmount DESC, Item, Filter end else begin  select sum(round(ItemQtys.QTYORDER * ItemQtys.UNITCOST, 2)) as TotalAmount,   ItemQtys.ITEMNMBR as Item,   Filter   from #ItemQtys as ItemQtys with (NOLOCK)  inner join   (select top (select @I_iNumItems) sum(round(ItemQtys.QTYORDER * ItemQtys.UNITCOST, 2)) as TotalAmount,   ItemQtys.ITEMNMBR as Item  from #ItemQtys as ItemQtys with (NOLOCK)  where ItemQtys.REQDATE between @dtStart and @dtEnd  group by   ItemQtys.ITEMNMBR  order by TotalAmount DESC, Item) ItemsList on ItemQtys.ITEMNMBR = ItemsList.Item   inner join @ValuesTable FilterList on FilterList.Value = ItemQtys.Filter  group by   ItemQtys.ITEMNMBR, Filter   order by TotalAmount DESC, Item, Filter end DROP TABLE #ItemQtys  set nocount OFF RETURN   
GO
GRANT EXECUTE ON  [dbo].[seePOPTopTenRequisitionItemsByAmt30DaysMetric] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[seePOPTopTenRequisitionItemsByAmt30DaysMetric] TO [rpt_accounting manager]
GO
GRANT EXECUTE ON  [dbo].[seePOPTopTenRequisitionItemsByAmt30DaysMetric] TO [rpt_executive]
GO
GRANT EXECUTE ON  [dbo].[seePOPTopTenRequisitionItemsByAmt30DaysMetric] TO [rpt_operations manager]
GO
GRANT EXECUTE ON  [dbo].[seePOPTopTenRequisitionItemsByAmt30DaysMetric] TO [rpt_purchasing agent]
GO
GRANT EXECUTE ON  [dbo].[seePOPTopTenRequisitionItemsByAmt30DaysMetric] TO [rpt_purchasing manager]
GO
