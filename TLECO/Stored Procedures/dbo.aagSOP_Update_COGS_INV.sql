SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create                procedure [dbo].[aagSOP_Update_COGS_INV]  @SOPType integer,   @SOPNumber char(21),   @HdrID integer ,  @post integer,   @INTERID char(5),  @nStatus integer out as begin   declare @LINVINDX   integer,   @LCSLSINDX   integer,   @LaaSubLedgerDistID  integer,  @LaaSubLedgerDistID1  integer,  @LACTINDX   integer,  @Cnt    integer ,  @ITEMTYPE   integer,  @KTACCTSR   integer,  @KTITEM   char(31),  @KTACCT   integer,  @ITEM    Char(31),  @KTACCTL   integer,  @Status   integer,  @LNITMSEQ   integer,  @Stat    smallint,  @TempCnt   int,  @TempAct   int,   @DistDel int,  @SkipItem char(31)   select  @LINVINDX   = 0,   @LCSLSINDX   = 0,   @LaaSubLedgerDistID  = 0,  @LaaSubLedgerDistID1  = 0,  @LACTINDX   = 0,  @Cnt    = 0,  @ITEMTYPE   = 0,  @KTACCTSR   = 0,  @KTITEM   = '',  @KTACCT   = 0,  @ITEM    = '',  @KTACCTL   = 0,  @Status   = 0,  @LNITMSEQ   = 0,  @TempCnt    = 0,  @TempAct  = 0,  @DistDel  = 0   set nocount on  if exists (select name from tempdb..sysobjects where name = '#aaCOGSINV' and type = 'U')   drop table #aaCOGSINV  create table #aaCOGSINV(ACTINDEX integer)   exec aagSOP_DIST_DELETE @SOPType , @SOPNumber , @HdrID,@Status   Select @Cnt = count(*) from SOP10200 where SOPTYPE = @SOPType and SOPNUMBE = @SOPNumber  if @Cnt  = 0  return  else  set @Cnt =  0  if @post = 0   begin  If @SOPType = 3   begin  declare aaCSOPLINEWORK cursor fast_forward FOR   Select SOP10200.INVINDX, SOP10200.CSLSINDX , IV00101.KTACCTSR   from SOP10200, IV00101   where SOP10200.ITEMNMBR = IV00101.ITEMNMBR and   IV00101.ITEMTYPE not in (3,4,5,6) and   SOP10200.SOPTYPE = @SOPType and   SOP10200.SOPNUMBE = @SOPNumber and   SOP10200.LNITMSEQ >= 0 and   SOP10200.CMPNTSEQ = 0 and   SOP10200.UNITCOST <> 0  union all  Select SOP10200.INVINDX, SOP10200.CSLSINDX , 0   from SOP10200  where  SOP10200.SOPTYPE = @SOPType and   SOP10200.SOPNUMBE = @SOPNumber and   SOP10200.LNITMSEQ >= 0 and   SOP10200.CMPNTSEQ = 0 and   SOP10200.UNITCOST <> 0 and  SOP10200.NONINVEN =  1   open aaCSOPLINEWORK   fetch next from aaCSOPLINEWORK into @LINVINDX,@LCSLSINDX,@KTACCTSR   while @@fetch_status = 0  begin   exec aagSOP_INSERT_DIST @LINVINDX,@HdrID,@INTERID,15   select @TempCnt = 0  Select @TempCnt = count(*) from #aaCOGSINV   where ACTINDEX =  @LINVINDX   if @TempCnt = 0   insert into #aaCOGSINV values ( @LINVINDX )   exec aagSOP_INSERT_DIST @LCSLSINDX,@HdrID,@INTERID,14   select @TempCnt = 0  Select @TempCnt = count(*) from #aaCOGSINV   where ACTINDEX =  @LCSLSINDX   if @TempCnt = 0   insert into #aaCOGSINV values ( @LCSLSINDX )  fetch next from aaCSOPLINEWORK into @LINVINDX,@LCSLSINDX,@KTACCTSR  end   close aaCSOPLINEWORK  deallocate aaCSOPLINEWORK   declare aaCSOPLINEWORK cursor fast_forward FOR   Select SOP10200.INVINDX, SOP10200.CSLSINDX , SOP10200.LNITMSEQ, IV00101.KTACCTSR ,IV00101.ITEMNMBR   from SOP10200, IV00101   where SOP10200.ITEMNMBR = IV00101.ITEMNMBR and   IV00101.ITEMTYPE  = 3 and   SOP10200.SOPTYPE  = @SOPType and   SOP10200.SOPNUMBE = @SOPNumber and   SOP10200.CMPNTSEQ = 0 and   SOP10200.LNITMSEQ >= 0 and  SOP10200.NONINVEN <> 1   open aaCSOPLINEWORK   fetch next from aaCSOPLINEWORK into @LINVINDX,@LCSLSINDX, @LNITMSEQ, @KTACCTSR, @ITEM   while @@fetch_status = 0  begin  if @KTACCTSR = 1  begin   exec aagSOP_INSERT_DIST @LCSLSINDX,@HdrID,@INTERID,14   select @TempCnt = 0  Select @TempCnt = count(*) from #aaCOGSINV   where ACTINDEX =  @LCSLSINDX   if @TempCnt = 0   insert into #aaCOGSINV values ( @LCSLSINDX )  end   declare  AACKIT cursor fast_forward for  Select SOP.INVINDX, SOP.CSLSINDX   from SOP10200 SOP Inner join IV00101 IV ON SOP.ITEMNMBR = IV.ITEMNMBR  where SOP.SOPNUMBE  =  @SOPNumber and  SOP.SOPTYPE   =  @SOPType and   SOP.CMPNTSEQ <> 0 and   SOP.LNITMSEQ = @LNITMSEQ and  IV.ITEMTYPE = 1  open AACKIT   fetch next  from AACKIT into @KTACCTL,@KTACCT   while @@fetch_Status = 0  begin  exec aagSOP_INSERT_DIST @KTACCTL,@HdrID,@INTERID,15   select @TempCnt = 0  Select @TempCnt = count(*) from #aaCOGSINV   where ACTINDEX = @KTACCTL  if @TempCnt = 0   insert into #aaCOGSINV values (@KTACCTL )  if @KTACCTSR = 0   begin  exec aagSOP_INSERT_DIST @KTACCT,@HdrID,@INTERID,14   select @TempCnt = 0  Select @TempCnt = count(*) from #aaCOGSINV   where ACTINDEX = @KTACCT  if @TempCnt = 0   insert into #aaCOGSINV values ( @KTACCT )  end   fetch next  from AACKIT into @KTACCTL,@KTACCT   end  close AACKIT  deallocate AACKIT   fetch next from aaCSOPLINEWORK into @LINVINDX,@LCSLSINDX, @LNITMSEQ, @KTACCTSR, @ITEM   end   close  aaCSOPLINEWORK  deallocate aaCSOPLINEWORK  end   select @TempCnt = 0  Select @TempCnt = count(*) from #aaCOGSINV  if @TempCnt = 0   insert into #aaCOGSINV values (0)   Delete from AAG20003 where aaSubLedgerHdrID = @HdrID   and aaSubLedgerDistID in ( Select  aaSubLedgerDistID from  AAG20001 where aaSubLedgerHdrID =  @HdrID   and aaSubLedgerDistID > 0 and aaFutureDist = 1   and ACTINDX not in (Select ACTINDEX from #aaCOGSINV) and DISTTYPE in(14,15))   Delete from AAG20002 where aaSubLedgerHdrID = @HdrID  and aaSubLedgerDistID in ( Select  aaSubLedgerDistID from  AAG20001 where aaSubLedgerHdrID = @HdrID   and aaSubLedgerDistID > 0 and aaFutureDist = 1   and ACTINDX not in (Select ACTINDEX from #aaCOGSINV) and DISTTYPE in(14,15))   delete  from AAG20001 where aaSubLedgerHdrID = @HdrID   and aaSubLedgerDistID > 0 and aaFutureDist = 1   and ACTINDX not in (Select ACTINDEX from #aaCOGSINV) and DISTTYPE in(14,15)   end    If @post = 1  begin  Delete from AAG20003 where aaSubLedgerHdrID = @HdrID and aaSubLedgerDistID in (Select aaSubLedgerDistID  from AAG20001 where aaSubLedgerHdrID = @HdrID and aaSubLedgerDistID >=0 and   ACTINDX in (Select ACTINDX from SOP10102 where SOPTYPE = @SOPType and  SOPNUMBE= @SOPNumber and  SEQNUMBR >=0 and SOP10102.DISTTYPE in (14,15))  and aaFutureDist = 0)   declare aaCSOPASSIGN cursor fast_forward for   Select AAG20001.aaSubLedgerDistID, AAG20001.ACTINDX  from AAG20001 , SOP10102  where AAG20001.aaSubLedgerHdrID = @HdrID and   AAG20001.aaSubLedgerDistID >= 0 and   AAG20001.aaFutureDist  = 0  and   SOP10102.SOPTYPE = @SOPType and   SOP10102.SOPNUMBE= @SOPNumber and  SOP10102.SEQNUMBR >=0 and   SOP10102.ACTINDX = AAG20001.ACTINDX and   SOP10102.DISTTYPE in (14,15)   order by aaSubLedgerDistID   open aaCSOPASSIGN  fetch next from aaCSOPASSIGN into @LaaSubLedgerDistID,@LACTINDX  while @@fetch_status = 0   begin   Select @LaaSubLedgerDistID1 = aaSubLedgerDistID   from AAG20001   where aaSubLedgerHdrID =  @HdrID and aaSubLedgerDistID >0 and   ACTINDX = @LACTINDX and DISTTYPE in (14,15) and aaFutureDist = 1   Update AAG20003 set aaSubLedgerDistID =  @LaaSubLedgerDistID  where aaSubLedgerHdrID = @HdrID and aaSubLedgerDistID = @LaaSubLedgerDistID1 and   aaSubLedgerAssignID = 1 and aaTrxDimID >=0   fetch next from aaCSOPASSIGN into @LaaSubLedgerDistID,@LACTINDX   end   close aaCSOPASSIGN  deallocate  aaCSOPASSIGN  update AAG20002 set aaAliasID = Fut1.aaAliasID  from (SELECT aaAliasID, ACTINDX, DISTTYPE FROM AAG20002, AAG20001  WHERE AAG20001.aaSubLedgerHdrID = @HdrID  and AAG20001.aaSubLedgerHdrID = AAG20002.aaSubLedgerHdrID  and AAG20002.DEBITAMT = 0 and AAG20002.CRDTAMNT = 0 and AAG20001.aaSubLedgerDistID = AAG20002.aaSubLedgerDistID   and DISTTYPE in(15,14) and aaFutureDist = 1 ) Fut1, AAG20001 where AAG20001.ACTINDX = Fut1.ACTINDX  and AAG20001.DISTTYPE = Fut1.DISTTYPE  and AAG20001.aaSubLedgerHdrID = @HdrID   and AAG20001.aaSubLedgerHdrID = AAG20002.aaSubLedgerHdrID   and AAG20001.aaSubLedgerDistID = AAG20002.aaSubLedgerDistID   and AAG20001.DISTTYPE in(15,14) and aaFutureDist = 0   Delete from AAG20002 where aaSubLedgerHdrID = @HdrID  and   aaSubLedgerDistID in (Select aaSubLedgerDistID from AAG20001 where  aaSubLedgerHdrID = @HdrID  and aaSubLedgerDistID >=0 and aaFutureDist = 1)   and  aaSubLedgerAssignID = 1   Delete from AAG20001 where aaSubLedgerHdrID = @HdrID  and   aaSubLedgerDistID >=0 and aaFutureDist = 1   exec aagRenumberSOP_DIST @HdrID, @Stat  end   set nocount off  end     
GO
GRANT EXECUTE ON  [dbo].[aagSOP_Update_COGS_INV] TO [DYNGRP]
GO
