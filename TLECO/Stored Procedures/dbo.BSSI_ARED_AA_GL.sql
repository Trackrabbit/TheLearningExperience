SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
CREATE PROCEDURE [dbo].[BSSI_ARED_AA_GL]@JRNENTRY BIGINT,@DEFACTINDX BIGINT,@REVACTINDX BIGINT,@SEQNUMBR NUMERIC(19, 5),@SJRNENTRY BIGINT,@ROUNDDECIMALS INTASBEGIN	DECLARE @HeaderID NUMERIC(19, 5)	DECLARE @DistID	  NUMERIC(19, 5)		DECLARE @SubHeaderID NUMERIC(19, 5)	DECLARE @SubDistID	  NUMERIC(19, 5)		DECLARE @aaGLWorkHdrID NUMERIC(19, 5)	DECLARE @aaGLWorkDistID NUMERIC(19, 5)	DECLARE @aaGLWorkAssignID NUMERIC(19, 5)	DECLARE @aaAssignErrors BINARY(4)		DECLARE @DEBITAMT NUMERIC(19, 5),			@CRDTAMNT NUMERIC(19, 5),			@ORDBTAMT NUMERIC(19, 5),			@ORCRDAMT NUMERIC(19, 5)		DECLARE @DimExists INT										IF @DEFACTINDX <> @REVACTINDX 	BEGIN		SELECT @DimExists = CASE WHEN COUNT(AAG10003.aaTrxDimID) > 0 THEN 1 ELSE 0 END FROM AAG10000 		INNER JOIN AAG10001 ON AAG10001.aaGLWorkHdrID = AAG10000.aaGLWorkHdrID 		INNER JOIN AAG10002 ON AAG10001.aaGLWorkHdrID = AAG10002.aaGLWorkHdrID    						   AND AAG10001.aaGLWorkDistID = AAG10002.aaGLWorkDistID 		INNER JOIN AAG10003 ON AAG10002.aaGLWorkHdrID = AAG10003.aaGLWorkHdrID 						   AND AAG10002.aaGLWorkDistID = AAG10003.aaGLWorkDistID 						   AND AAG10002.aaGLWorkAssignID = AAG10003.aaGLWorkAssignID 		 WHERE JRNENTRY =  @JRNENTRY  AND AAG10001.ACTINDX = @DEFACTINDX		 AND AAG10003.aaTrxDimID IN (SELECT AAG10003.aaTrxDimID FROM AAG10000    									 INNER JOIN AAG10001 ON AAG10001.aaGLWorkHdrID = AAG10000.aaGLWorkHdrID    									 INNER JOIN AAG10002 ON AAG10001.aaGLWorkHdrID = AAG10002.aaGLWorkHdrID    														AND AAG10001.aaGLWorkDistID = AAG10002.aaGLWorkDistID    									 INNER JOIN AAG10003 ON AAG10002.aaGLWorkHdrID = AAG10003.aaGLWorkHdrID    														AND AAG10002.aaGLWorkDistID = AAG10003.aaGLWorkDistID    														AND AAG10002.aaGLWorkAssignID = AAG10003.aaGLWorkAssignID    									  WHERE JRNENTRY =  @JRNENTRY AND AAG10001.ACTINDX = @REVACTINDX)						IF @DimExists = 0 				BEGIN						RETURN				END		END	SELECT @SubHeaderID = aaGLHdrID FROM AAG30000 	WHERE JRNENTRY = @SJRNENTRY		SELECT @SubDistID = aaGLDistID FROM AAG30001	WHERE aaGLHdrID = @SubHeaderID AND ACTINDX = @DEFACTINDX AND SEQNUMBR = @SEQNUMBR	--------------	SELECT @HeaderID = aaGLWorkHdrID FROM AAG10000	WHERE JRNENTRY = @JRNENTRY		SELECT @DistID = aaGLWorkDistID FROM AAG10001	WHERE aaGLWorkHdrID = @HeaderID AND ACTINDX = @REVACTINDX		SELECT * INTO #BSSI_AAG10002 FROM AAG10002	WHERE aaGLWorkHdrID = @HeaderID AND aaGLWorkDistID = @DistID	--------------	DECLARE BSSI_GLAssignCursor 	CURSOR FOR SELECT aaGLWorkHdrID, aaGLWorkDistID, aaGLWorkAssignID, DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, aaAssignErrors FROM #BSSI_AAG10002			   ORDER BY aaGLWorkDistID, aaGLWorkAssignID		OPEN BSSI_GLAssignCursor	FETCH NEXT FROM BSSI_GLAssignCursor 	INTO @aaGLWorkHdrID, @aaGLWorkDistID, @aaGLWorkAssignID, @DEBITAMT, @CRDTAMNT, @ORDBTAMT, @ORCRDAMT, @aaAssignErrors		WHILE @@FETCH_STATUS = 0	BEGIN		DELETE FROM AAG10002 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID = @aaGLWorkDistID AND aaGLWorkAssignID = @aaGLWorkAssignID				INSERT INTO AAG10002		SELECT aaGLWorkHdrID = @aaGLWorkHdrID, aaGLWorkDistID = @aaGLWorkDistID, aaGLWorkAssignID = AAG30002.aaGLAssignID, 			   DEBITAMT = ROUND(@DEBITAMT * (AAG30002.aaAssignedPercent * 1.0/10000), @ROUNDDECIMALS), 			   CRDTAMNT = ROUND(@CRDTAMNT * (AAG30002.aaAssignedPercent * 1.0/10000), @ROUNDDECIMALS), 			   ORDBTAMT = ROUND(@ORDBTAMT * (AAG30002.aaAssignedPercent * 1.0/10000), @ROUNDDECIMALS), 			   ORCRDAMT = ROUND(@ORCRDAMT * (AAG30002.aaAssignedPercent * 1.0/10000), @ROUNDDECIMALS),			   aaAssignedPercent = AAG30002.aaAssignedPercent, AAG30002.DistRef, 0, aaAssignErrors = @aaAssignErrors, AAG30002.aaAliasID, DEX_ROW_TS = GETDATE()		FROM AAG30002		WHERE AAG30002.aaGLHdrID = @SubHeaderID AND aaGLDistID = @SubDistID			DELETE FROM AAG10003 		WHERE aaGLWorkHdrID = @aaGLWorkHdrID 		  AND aaGLWorkDistID = @aaGLWorkDistID 		  AND aaGLWorkAssignID = @aaGLWorkAssignID		  AND aaTrxDimID IN (SELECT AAG30003.aaTrxDimID							 FROM AAG30003							 WHERE AAG30003.aaGLHdrID = @SubHeaderID AND AAG30003.aaGLDistID = @SubDistID)				INSERT INTO AAG10003		SELECT aaGLWorkHdrID = @aaGLWorkHdrID, aaGLWorkDistID = @aaGLWorkDistID, aaGLWorkAssignID = AAG30002.aaGLAssignID,			AAG30003.aaTrxDimID, AAG30003.aaTrxCodeID, aaCodeErrors = CONVERT(varbinary(max),''), DEX_ROW_TS = GETDATE()		FROM AAG30003		INNER JOIN AAG30002 ON AAG30002.aaGLHdrID = AAG30003.aaGLHdrID						   AND AAG30002.aaGLDistID = AAG30003.aaGLDistID						   AND AAG30002.aaGLAssignID = AAG30003.aaGLAssignID		WHERE AAG30003.aaGLHdrID = @SubHeaderID AND AAG30003.aaGLDistID = @SubDistID		  AND AAG30003.aaTrxDimID IN (SELECT aaTrxDimID FROM AAG00202 WHERE aaAcctClassID IN (SELECT aaAcctClassID FROM AAg00200 WHERE ACTINDX = @REVACTINDX))				INSERT INTO AAG10003		SELECT aaGLWorkHdrID = @aaGLWorkHdrID, aaGLWorkDistID = AAG10003.aaGLWorkDistID, aaGLWorkAssignID = AAG30002.aaGLAssignID,			AAG10003.aaTrxDimID, AAG10003.aaTrxCodeID, AAG10003.aaCodeErrors, DEX_ROW_TS = GETDATE()		FROM AAG30002		LEFT JOIN AAG10003 ON AAG10003.aaGLWorkHdrID = @aaGLWorkHdrID						   AND AAG10003.aaGLWorkDistID = @aaGLWorkDistID						   AND AAG10003.aaGLWorkAssignID = 1		WHERE AAG30002.aaGLHdrID = @SubHeaderID AND AAG30002.aaGLDistID = @SubDistID		  AND CONVERT(VARCHAR(MAX), AAG10003.aaTrxDimID)+'-'+CONVERT(VARCHAR(MAX), AAG30002.aaGLAssignID) NOT IN 			(SELECT CONVERT(VARCHAR(MAX), AAG10003.aaTrxDimID)+'-'+CONVERT(VARCHAR(MAX), AAG10003.aaGLWorkAssignID) 			  FROM AAG10003 WHERE AAG10003.aaGLWorkHdrID = @aaGLWorkHdrID AND AAG10003.aaGLWorkDistID = @aaGLWorkDistID)		FETCH NEXT FROM BSSI_GLAssignCursor 		INTO @aaGLWorkHdrID, @aaGLWorkDistID, @aaGLWorkAssignID, @DEBITAMT, @CRDTAMNT, @ORDBTAMT, @ORCRDAMT, @aaAssignErrors	END	CLOSE BSSI_GLAssignCursor	DEALLOCATE BSSI_GLAssignCursor	END 
GO
GRANT EXECUTE ON  [dbo].[BSSI_ARED_AA_GL] TO [DYNGRP]
GO
