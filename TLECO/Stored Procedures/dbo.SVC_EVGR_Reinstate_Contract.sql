SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE procedure [dbo].[SVC_EVGR_Reinstate_Contract]  @CONSTS                 smallint,  @CONTNBR                char(11),  @LNSEQNBR               numeric(19,5),  @Address         char(15),  @ReinstateDate          datetime AS declare @Line numeric (19,5) declare @LineStatus char (1) declare @RevLineEndDdate datetime declare @TotalPostedRevenue  numeric(19,5), @InvoiceAmount numeric(19,2) declare @TransactionDate datetime, @MinDate datetime declare @StartDate datetime, @CoverageStart datetime, @CoverageEnd datetime declare @UserID   Varchar(30), @SourceDocument  Varchar(255),  @DiscountPercent smallint, @ErrorCondition integer  exec smGetMinDate @MinDate output   if @Address > '' and @LNSEQNBR > 0  begin  update SVC00608 with (rowlock) set ENDDATE = @ReinstateDate, BILEND = @ReinstateDate, canceled = 0, BILSTAT = 1  where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR and ADRSCODE = @Address  declare Site_Cursor CURSOR for select LNSEQNBR, Contract_Line_Status, FRZEND, DSCPCTAM from SVC00601 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and ADRSCODE = @Address  OPEN Site_Cursor  fetch next from Site_Cursor into @Line, @LineStatus  , @CoverageEnd, @DiscountPercent   while @@FETCH_STATUS = 0 and @LineStatus <> 'C'  BEGIN   update SVC00601 with (rowlock) set ENDDATE = @ReinstateDate, BILEND = @ReinstateDate, Contract_Line_Status = 'R', BILSTAT = 1  where CONSTS = @CONSTS and CONTNBR = @CONTNBR  and LNSEQNBR = @Line   exec SVC_EVGR_Update_Contract_Line @CONSTS, @CONTNBR, @Line, 2  if exists(select * from SVC00604 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @Line)  Begin  delete from SVC00604 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @Line and Status = 0  select @UserID = SUSER_SNAME()  select @StartDate = STRTDATE,@DiscountPercent = DSCPCTAM from SVC00601 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR    select @RevLineEndDdate = max(SVC_Coverage_End_Date) from SVC00604 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @Line  select @CoverageStart = dateadd(dd, 1, @RevLineEndDdate)  select @CoverageStart = IsNull(@CoverageStart,@StartDate)   select @SourceDocument = '2-' + RTRIM(@CONTNBR) + '-' + CONVERT(varchar(20),@Line),  @TransactionDate = convert(char(12),getdate(),102)  select @TotalPostedRevenue = isnull(SUM(PSTDAMNT),0) from SVC00604 WITH (NOLOCK)  where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @Line  select @InvoiceAmount = ROUND(SUM(IsNull(SVC00603.DOCAMNT,0) - IsNull(SVC00603.DSCDLRAM,0) - IsNull(SVC00603.SVC_Invoice_Credit_Amoun,0) ),2)  , @CoverageEnd = max(SVC_Coverage_End_Date)  from SVC00603 WITH (NOLOCK) where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @Line  select @InvoiceAmount = @InvoiceAmount - @TotalPostedRevenue  if @InvoiceAmount > 0   exec SVC_RET_Create_Revenue_Recognition_Lines  -1,   -1,  @CONSTS,  @CONTNBR,  @Line ,  0 ,  @MinDate,  'EGR',  @SourceDocument ,  @TransactionDate,  @InvoiceAmount,  @UserID ,  @CoverageStart,  @CoverageEnd,  @DiscountPercent,  @ErrorCondition OUTPUT   End  fetch next from Site_Cursor into @Line, @LineStatus  , @CoverageEnd, @DiscountPercent   END  close Site_Cursor  DEALLOCATE Site_Cursor  end else if @LNSEQNBR > 0  Begin  update SVC00601 with (rowlock) set ENDDATE = @ReinstateDate, BILEND = @ReinstateDate, Contract_Line_Status = 'R', BILSTAT = 1  where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR  if (select ENDDATE from SVC00600 where CONSTS = @CONSTS and CONTNBR = @CONTNBR) < @ReinstateDate  update SVC00600 with (ROWLOCK)  set ENDDATE = @ReinstateDate  WHERE CONSTS = @CONSTS AND CONTNBR = @CONTNBR   exec SVC_EVGR_Update_Contract_Line @CONSTS, @CONTNBR, @LNSEQNBR, 2  if exists(select * from SVC00604 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR)  Begin  delete from SVC00604 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR and Status = 0  select @UserID = SUSER_SNAME()  select @StartDate = STRTDATE,@DiscountPercent = DSCPCTAM from SVC00601 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR    select @RevLineEndDdate = max(SVC_Coverage_End_Date) from SVC00604 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR  select @CoverageStart = dateadd(dd, 1, @RevLineEndDdate)  select @CoverageStart = IsNull(@CoverageStart,@StartDate)   select @SourceDocument = '2-' + RTRIM(@CONTNBR) + '-' + CONVERT(varchar(20),@LNSEQNBR),  @TransactionDate = convert(char(12),getdate(),102)  select @TotalPostedRevenue = isnull(SUM(PSTDAMNT),0) from SVC00604 WITH (NOLOCK)  where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR  select @InvoiceAmount = ROUND(SUM(IsNull(SVC00603.DOCAMNT,0) - IsNull(SVC00603.DSCDLRAM,0) ),2), @CoverageEnd = max(SVC_Coverage_End_Date)  from SVC00603 WITH (NOLOCK) where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR  select @InvoiceAmount = @InvoiceAmount - @TotalPostedRevenue  if @InvoiceAmount > 0   exec SVC_RET_Create_Revenue_Recognition_Lines  -1,   -1,  @CONSTS,  @CONTNBR,  @LNSEQNBR ,  0 ,  @MinDate,  'EGR',  @SourceDocument ,  @TransactionDate,  @InvoiceAmount,  @UserID ,  @CoverageStart,  @CoverageEnd,  @DiscountPercent,  @ErrorCondition OUTPUT   End   end else  begin  update SVC00600 with (rowlock) set ENDDATE = @ReinstateDate, BILEND = @ReinstateDate,  BILSTAT = 1  where CONSTS = @CONSTS and CONTNBR = @CONTNBR   update SVC00608 with (rowlock) set ENDDATE = @ReinstateDate, BILEND = @ReinstateDate, canceled = 0, BILSTAT = 1  where CONSTS = @CONSTS and CONTNBR = @CONTNBR   declare cline_Cursor CURSOR for select LNSEQNBR, Contract_Line_Status, FRZEND, DSCPCTAM from SVC00601 where CONSTS = @CONSTS and CONTNBR = @CONTNBR   OPEN cline_Cursor  fetch next from cline_Cursor into @Line, @LineStatus , @CoverageEnd, @DiscountPercent   while @@FETCH_STATUS = 0 and @LineStatus <> 'C'  BEGIN   update SVC00601 with (rowlock) set ENDDATE = @ReinstateDate, BILEND = @ReinstateDate, Contract_Line_Status = 'R', BILSTAT = 1  where CONSTS = @CONSTS and CONTNBR = @CONTNBR  and LNSEQNBR = @Line   exec SVC_EVGR_Update_Contract_Line @CONSTS, @CONTNBR, @Line, 2  if exists(select * from SVC00604 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @Line)  Begin  delete from SVC00604 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @Line and Status = 0  select @UserID = SUSER_SNAME()  select @StartDate = STRTDATE,@DiscountPercent = DSCPCTAM from SVC00601 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @Line    select @RevLineEndDdate = max(SVC_Coverage_End_Date) from SVC00604 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @Line  select @CoverageStart = dateadd(dd, 1, @RevLineEndDdate)  select @CoverageStart = IsNull(@CoverageStart,@StartDate)    select @SourceDocument = '2-' + RTRIM(@CONTNBR) + '-' + CONVERT(varchar(20),@Line),  @TransactionDate = convert(char(12),getdate(),102)  select @TotalPostedRevenue = isnull(SUM(PSTDAMNT),0) from SVC00604 WITH (NOLOCK)  where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @Line  select @InvoiceAmount = ROUND(SUM(IsNull(SVC00603.DOCAMNT,0) - IsNull(SVC00603.DSCDLRAM,0) ),2) , @CoverageEnd = max(SVC_Coverage_End_Date)  from SVC00603 WITH (NOLOCK) where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @Line  select @InvoiceAmount = @InvoiceAmount - @TotalPostedRevenue  if @InvoiceAmount > 0   exec SVC_RET_Create_Revenue_Recognition_Lines  -1,   -1,  @CONSTS,  @CONTNBR,  @Line ,  0 ,  @MinDate,  'EGR',  @SourceDocument ,  @TransactionDate,  @InvoiceAmount,  @UserID ,  @CoverageStart,  @CoverageEnd,  @DiscountPercent,  @ErrorCondition OUTPUT   End  fetch next from cline_Cursor into @Line, @LineStatus, @CoverageEnd, @DiscountPercent  END  close cline_Cursor  DEALLOCATE cline_Cursor  end  return    
GO
GRANT EXECUTE ON  [dbo].[SVC_EVGR_Reinstate_Contract] TO [DYNGRP]
GO
