SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE procedure [dbo].[uprLoadFUTATempTable]  @I_vTableName varchar(25) = NULL,  @O_iErrorState          int             = NULL output  as  declare @iStatus int,  @iError int  select @iStatus = 0  select @O_iErrorState = 0  if( @I_vTableName is NULL) begin  select          @O_iErrorState = 21022  return end  EXEC    (' declare @employid char(20),@prevemployid char(20) '  + ' declare @dexrowid int,@rsmtdall dec(19,5),@rsqtdall dec(19,5),@rsytdall dec(19,5),@YEARWAGS dec(19,5),@YTDTSBFT dec(19,5),@YTDTSHAM dec(19,5),@MNTHSWGS dec(19,5), '  + ' @MTXBLBFT dec(19,5),@MTXSHAMT dec(19,5),@QTDWAGES dec(19,5),@QTDTXBFT dec(19,5),@QTDTSHAM dec(19,5) '  + ' select @prevemployid='''',@rsmtdall=0,@rsqtdall=0,@rsytdall=0 '  + ' DECLARE t_cursor CURSOR for '  + ' select DEX_ROW_ID,EMPLOYID,YEARWAGS,YTDTSBFT,YTDTSHAM,MNTHSWGS,MTXBLBFT,MTXSHAMT,QTDWAGES,QTDTXBFT,QTDTSHAM from ' + @I_vTableName + ' order by EMPLOYID,DEX_ROW_ID DESC '  + ' set NOCOUNT on '  + ' open t_cursor '  + ' FETCH NEXT FROM t_cursor INTO @dexrowid,@employid,@YEARWAGS,@YTDTSBFT,@YTDTSHAM,@MNTHSWGS,@MTXBLBFT,@MTXSHAMT,@QTDWAGES,@QTDTXBFT,@QTDTSHAM '  + ' while (@@fetch_status <> -1) '  + ' begin '  + ' if (@employid <> @prevemployid) '  + ' begin '  + '   select @rsmtdall =0, @rsqtdall=0, @rsytdall=0 '  + '  end  '  + ' select @rsmtdall = @rsmtdall + ((@YEARWAGS + @YTDTSBFT - @YTDTSHAM) - (@MNTHSWGS + @MTXBLBFT - @MTXSHAMT)) '  + ' select @rsqtdall = @rsqtdall + ((@YEARWAGS + @YTDTSBFT - @YTDTSHAM) - (@QTDWAGES + @QTDTXBFT - @QTDTSHAM)) '   + ' select @rsytdall = @rsytdall + (@YEARWAGS + @YTDTSBFT - @YTDTSHAM) '  + ' update ' + @I_vTableName + ' set INPRSTWG = 1, '  + '    MNTHSWGS = MNTHSWGS + MTXBLBFT - MTXSHAMT, '  + '    RSMTDALL = @rsmtdall, '  + '    RGSMTDST = @rsmtdall, '  + '      QTDWAGES = QTDWAGES + QTDTXBFT - QTDTSHAM, '  + '    RGSQTDST = @rsqtdall, '  + '    RSQTDALL = @rsqtdall, '  + '    YEARWAGS = YEARWAGS + YTDTSBFT - YTDTSHAM, '  + '    RGSYTDST = @rsytdall, '  + '    RSYTDALL = @rsytdall '  + '    where DEX_ROW_ID = @dexrowid '  + ' set @prevemployid = @employid '  + ' FETCH NEXT FROM t_cursor into @dexrowid,@employid,@YEARWAGS,@YTDTSBFT,@YTDTSHAM,@MNTHSWGS,@MTXBLBFT,@MTXSHAMT,@QTDWAGES,@QTDTXBFT,@QTDTSHAM '  + ' end '  + ' DEALLOCATE t_cursor '  )   return(@iStatus)    
GO
GRANT EXECUTE ON  [dbo].[uprLoadFUTATempTable] TO [DYNGRP]
GO
