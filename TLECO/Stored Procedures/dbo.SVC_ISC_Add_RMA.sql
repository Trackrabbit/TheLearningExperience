SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE procedure [dbo].[SVC_ISC_Add_RMA]  (  @RETDOCID char(15) OUTPUT,  @LNSEQNBR numeric(19,5) OUTPUT,  @custnmbr varchar(15) = NULL,   @adrscode varchar(15) = NULL,  @address1 varchar(31) = NULL,  @address2 varchar(31) = NULL,  @city varchar(31) = NULL,  @statecd varchar(30) = NULL,  @zip varchar(11) = NULL,  @cntcprsn varchar(31) = NULL,  @equipid integer = NULL,  @item varchar(31) = NULL,  @QTY numeric(19,5),  @NTEPRICE numeric(19,5) = 0,  @txtfield text = NULL,  @RETTYPE char(11) = NULL,  @Reason char(3) = NULL,  @ReasonDesc char (31) =NULL,  @Origin smallint = NULL,  @OriginID  char (31) = NULL,  @POAUTH char (21) = NULL,  @Serial char(15)= NULL,  @address3 varchar(31) = NULL,  @UserDate varchar(31) = NULL  ) as  declare @newcallnbr char(11) declare @tempadrscode varchar(15) declare @custname varchar(65) declare @retadrs varchar(15) declare @tempaddress1 varchar(31) declare @tempaddress2 varchar(31) declare @tempaddress3 varchar(31) declare @tempcity varchar(31) declare @tempstatecd varchar(30) declare @tempzip varchar(11) declare @tempcountry varchar(21) declare @tempphone1 varchar(21) declare @taxschid varchar(15) declare @prclevel varchar(15) declare @taxexmt1 varchar(25) declare @taxexmt2 varchar(25) declare @pymtrmid varchar(21) declare @rqstdte datetime declare @rqsttme datetime declare @slspersonid varchar(15) declare @svcarea varchar(10) declare @techid varchar(10) declare @timezone varchar(3) declare @offid varchar(10) declare @msg varchar(255) declare @noteindx int declare @default_status varchar(3) declare @default_type varchar(10) declare @srvtype char(11) declare @entdte datetime declare @enttme datetime declare @tempcntcprsn varchar(31) declare @return_status integer declare @CurrencyID char(15) ,  @BillToCustomer varchar(15) ,  @BillToAddress varchar(15) ,  @OnHold tinyint declare @country varchar(21) declare @LineSeq numeric(19,5)  declare @UofM char(10)   SELECT @UofM = IV40201.UOMSCHDL from IV40201 left join IV00101 on IV40201.UOMSCHDL = IV00101.UOMSCHDL  where IV00101.ITEMNMBR = @item  if @custnmbr is NULL goto badentry if @NTEPRICE is NULL select @NTEPRICE = 0 select @noteindx = 0 exec SVC_Get_Customer_Info @custnmbr, @adrscode OUTPUT,   @custname output, @retadrs output, @tempcntcprsn output,  @tempphone1 output, @tempaddress1 output, @tempaddress2 output, @tempaddress3 output,  @tempcity output, @tempstatecd output, @tempzip output, @tempcountry output,  @taxschid output, @prclevel output,   @taxexmt1 output, @taxexmt2 output, @pymtrmid output,  @slspersonid output,  @svcarea output, @offid output, @timezone output,   @CurrencyID OUTPUT,  @BillToCustomer OUTPUT,  @BillToAddress OUTPUT ,  @OnHold OUTPUT if @custname is NULL goto badentry if (@cntcprsn is NULL) or (@cntcprsn = '') select @cntcprsn = @tempcntcprsn if @adrscode is NULL goto badentry  set @country =  @tempcountry  if (@address1 is NULL) or (@address1 = '') begin  select   @address1 = @tempaddress1,  @address2 = @tempaddress2,  @address3 = @tempaddress3,  @city = @tempcity,  @statecd = @tempstatecd,  @zip = @tempzip,  @country =  @tempcountry  end  exec SVC_UpdateTextObject @noteindx OUTPUT,@rqstdte,@rqsttme,@txtfield exec SVC_Create_RMA @RETDOCID OUTPUT,@LineSeq OUTPUT,@Origin,@RETTYPE,@OriginID,@custnmbr,@adrscode,@equipid,@Serial,@item,'',0,'',0,0,0,@QTY,@UofM,@Reason,@ReasonDesc,'eRT',@UserDate,''  if @@error <= 0  begin  update SVC05200   set ADDRESS1 = @address1,   ADDRESS2 = IsNull(@address2,''),   ADDRESS3 = IsNull(@address3,''),   CITY = @city,   STATE = @statecd,  ZIPCODE = @zip,  COUNTRY =@country ,   CONTACT = @cntcprsn,  RETTYPE =case when @RETTYPE <> '' and @RETTYPE is not null then @RETTYPE else RETTYPE end,  SVC_RMA_Reason_Code = @Reason,  SVC_RMA_Reason_Code_Desc = @ReasonDesc,  CSTPONBR = @POAUTH,  RETORIG = @Origin,  RETREF = @OriginID,  QUANTITY = @QTY,  NTE_Price = @NTEPRICE,   Originating_NTE_Price = @NTEPRICE,   Bill_To_Customer = @BillToCustomer,  SVC_Bill_To_Address_Code = @BillToAddress,  NOTEINDX = @noteindx  where RETDOCID = @RETDOCID and LNSEQNBR = @LineSeq end  else  goto badentry  return badentry:  if @@TRANCOUNT > 0   rollback transaction return    
GO
GRANT EXECUTE ON  [dbo].[SVC_ISC_Add_RMA] TO [DYNGRP]
GO
