SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 Create Procedure [dbo].[SVC_RMA_Create_SerialLot] ( @RecType smallint,  @RMANumber char(15),  @Line Numeric(19,5),  @serial_number char(20),  @item_number char(30),  @location_code char(11),  @Bin char(15),  @customer char(15),  @addresscode char(15),  @original tinyint, @CMPNTSEQ int = 0, @QtyType smallint = 1 )  as declare @LotSequence int declare @item_cost numeric(19,5) declare @EquipID int declare @UserID char(15) declare @MinDate datetime  exec smGetMinDate @MinDate output   select @UserID = SYSTEM_USER select @item_cost = CURRCOST from IV00101 where ITEMNMBR = @item_number  begin transaction  if exists(select * from SVC00300 where ITEMNMBR = @item_number and SERLNMBR = @serial_number and CUSTNMBR = @customer )  select @EquipID = EQUIPID from SVC00300 where ITEMNMBR = @item_number and SERLNMBR = @serial_number and CUSTNMBR = @customer  else  exec SVC_Create_Serial_MSTR @serial_number, @item_number, @customer, @addresscode, @UserID, '', @EquipID output  if not exists(select * from SVC05255 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line  and Return_Serial_Number = @serial_number and Return_Item_Number = @item_number and CMPNTSEQ = @CMPNTSEQ)  begin  if @Bin = '' or @Bin is null  select @Bin = SORETURNBIN from IV00102 where ITEMNMBR = @item_number and LOCNCODE = @location_code  if @Bin = '' or @Bin is null  select @Bin = SORETURNBIN from IV40700 where LOCNCODE = @location_code  if exists(select * from IV00200 where ITEMNMBR = @item_number and SERLNMBR = @serial_number)  select @item_cost = UNITCOST from IV00200   where ITEMNMBR = @item_number and SERLNMBR = @serial_number  select @LotSequence = isnull(Max(SLTSQNUM),0) + 1 from SVC05255  where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line and CMPNTSEQ = @CMPNTSEQ  insert SVC05255 select  @RecType, @RMANumber, @Line, @QtyType, 1, @item_number, @serial_number, @EquipID, @LotSequence, isnull(@Bin,''), @item_cost,  @original, CONVERT(char(10),GETDATE(),102) + ' 00:00:00' , 1, 'RMA RCV' , case when @original =1 then 0 else 1 end, 0,  @MinDate,@MinDate, @CMPNTSEQ  if @@error <> 0 goto badentry  end  ELSE  begin  update SVC05255 set QTYTYPE = @QtyType, MARKED = 1 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line  and Return_Serial_Number = @serial_number and Return_Item_Number = @item_number and CMPNTSEQ = @CMPNTSEQ  end  commit transaction  return badentry:  rollback transaction  return     
GO
GRANT EXECUTE ON  [dbo].[SVC_RMA_Create_SerialLot] TO [DYNGRP]
GO
