SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE PROCEDURE [dbo].[aagFA_CreateMassDeprValidateRecords] @bDepeciateAll TINYINT, @sBookID VARCHAR(15)='', @aAssetGroupName VARCHAR(15), @UserID VARCHAR(15), @COMPANYID SMALLINT AS BEGIN   DECLARE @AssetIndex INT,  @BookIndex INT,  @aaFASetupID INT,  @aaAliasID INT  IF @bDepeciateAll = 1   BEGIN  DECLARE CURSOR1 CURSOR FAST_FORWARD FOR  SELECT ASSETINDEX,BOOKINDX FROM FA00200 WHERE BOOKINDX IN (SELECT BOOKINDX FROM FA40203 WHERE USERID=@UserID AND BOOKINDX IN(SELECT BOOKINDX FROM FA40200 WHERE PTGENLED=1)) ORDER BY ASSETINDEX,BOOKINDX  END  ELSE  BEGIN  IF @sBookID !=''  BEGIN  DECLARE CURSOR1 CURSOR FAST_FORWARD FOR  SELECT A.ASSETINDEX,B.BOOKINDX FROM FA10200 A,FA40200 B WHERE EXISTS(SELECT C.ASSETINDEX,C.BOOKINDX FROM FA00200 C WHERE C.ASSETINDEX=A.ASSETINDEX AND C.BOOKINDX=B.BOOKINDX)  AND B.BOOKINDX =(SELECT BOOKINDX FROM FA40200 WHERE PTGENLED=1 and BOOKID=@sBookID) and A.GROUPNAME=@aAssetGroupName and A.USERID=@UserID ORDER BY A.ASSETINDEX,B.BOOKINDX   END  ELSE  BEGIN  DECLARE CURSOR1 CURSOR FAST_FORWARD FOR  SELECT A.ASSETINDEX,B.BOOKINDX FROM FA10200 A,FA40203 B WHERE EXISTS(SELECT C.ASSETINDEX,C.BOOKINDX FROM FA00200 C WHERE C.ASSETINDEX=A.ASSETINDEX AND C.BOOKINDX=B.BOOKINDX)  AND B.BOOKINDX IN (SELECT BOOKINDX FROM FA40200 WHERE PTGENLED=1) AND B.USERID=@UserID and A.GROUPNAME=@aAssetGroupName and A.USERID=@UserID ORDER BY A.ASSETINDEX,B.BOOKINDX   END  END   DELETE FROM FA00904 WHERE FA_Doc_Number = '204'   OPEN CURSOR1  FETCH NEXT FROM CURSOR1 INTO @AssetIndex,@BookIndex  WHILE @@fetch_status = 0  BEGIN  IF (SELECT count(*) FROM AAG04000 WHERE aaAssetIndex=@AssetIndex and aaBookIndex=0)=0   BEGIN  exec aagFACreateSetupInfo @AssetIndex,0,0,@COMPANYID,@UserID,@aaFASetupID OUT  END  IF (SELECT count(*) FROM AAG04000 WHERE aaAssetIndex=@AssetIndex and aaBookIndex=@BookIndex)=0   BEGIN  SELECT @aaAliasID=aaAliasID FROM FA00100 WHERE ASSETINDEX=@AssetIndex  exec aagFACreateSetupInfo @AssetIndex,@BookIndex,@aaAliasID,@COMPANYID,@UserID,@aaFASetupID OUT  END  SELECT TOP 1 @aaFASetupID=aaFASetupID FROM AAG04000 WHERE aaAssetIndex=@AssetIndex and aaBookIndex=@BookIndex  INSERT INTO FA00904(FINANCIALINDX,ASSETINDEX,BOOKINDX,FA_Doc_Number) VALUES (@aaFASetupID,@AssetIndex,@BookIndex,'204')   FETCH NEXT FROM CURSOR1 INTO @AssetIndex,@BookIndex  END  CLOSE CURSOR1  DEALLOCATE CURSOR1  END   
GO
GRANT EXECUTE ON  [dbo].[aagFA_CreateMassDeprValidateRecords] TO [DYNGRP]
GO
