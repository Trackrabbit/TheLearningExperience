SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[popAreRequisitionsAvailToPurchase]   @I_sTableName varchar(27) = NULL,  @I_nSortBy tinyint  = NULL,  @I_bReqsToPurchase int   = NULL output,  @O_iErrorState int         = NULL output  as   declare  @SQLString NVARCHAR(500),  @ParamDef NVARCHAR(500)  select @SQLString = '',  @ParamDef = ''  select  @I_bReqsToPurchase = 0,  @O_iErrorState  = 0  if  @I_sTableName is NULL or   @I_nSortBy   is NULL begin  SELECT @O_iErrorState = 20949  RETURN end   IF @I_nSortBy = 1 or @I_nSortBy = 2 BEGIN   if (select count(Workflow_Type_Name) from WF100002 where ACTIVE=1 and Workflow_Type_Name='Purchase Requisition Approval')>0  begin  select @SQLString = 'select @I_bReqsToPurchaseTemp = (SELECT COUNT(L.POPRequisitionNumber) from ' + @I_sTableName + ' T join POP10210 L '   select @SQLString = @SQLString + 'on L.POPRequisitionNumber = T.POPRequisitionNumber where T.HISTORY = 0 and L.QTYORDER > 0 and L.RequisitionLineStatus = 1 '  select @SQLString = @SQLString + 'and T.Workflow_Status not in (1,4,5,7) )'  select @ParamDef = '@I_bReqsToPurchaseTemp int OUTPUT'  end  else  begin  select @SQLString = 'select @I_bReqsToPurchaseTemp = (SELECT COUNT(L.POPRequisitionNumber) from ' + @I_sTableName + ' T join POP10210 L '   select @SQLString = @SQLString + 'on L.POPRequisitionNumber = T.POPRequisitionNumber where T.HISTORY = 0 and L.QTYORDER > 0 and L.RequisitionLineStatus = 1 )'  select @ParamDef = '@I_bReqsToPurchaseTemp int OUTPUT'  end   EXECUTE sp_executesql   @SQLString,   @ParamDef,   @I_bReqsToPurchaseTemp = @I_bReqsToPurchase OUTPUT  END ELSE  BEGIN    if (select count(Workflow_Type_Name) from WF100002 where ACTIVE=1 and Workflow_Type_Name='Purchase Requisition Approval')>0  begin  select @SQLString = 'select @I_bReqsToPurchaseTemp = (SELECT COUNT(POPRequisitionNumber) from ' + @I_sTableName   select @SQLString = @SQLString + ' where HISTORY = 0 and QTYTOPURCH > 0 and RequisitionStatus = 1 '  select @SQLString = @SQLString + ' and Workflow_Status not in (1,4,5,7) )'  select @ParamDef = '@I_bReqsToPurchaseTemp int OUTPUT'  end  else  begin  select @SQLString = 'select @I_bReqsToPurchaseTemp = (SELECT COUNT(POPRequisitionNumber) from ' + @I_sTableName   select @SQLString = @SQLString + ' where HISTORY = 0 and QTYTOPURCH > 0 and RequisitionStatus = 1 )'  select @ParamDef = '@I_bReqsToPurchaseTemp int OUTPUT'  end   EXECUTE sp_executesql   @SQLString,   @ParamDef,   @I_bReqsToPurchaseTemp = @I_bReqsToPurchase OUTPUT  END  RETURN    
GO
GRANT EXECUTE ON  [dbo].[popAreRequisitionsAvailToPurchase] TO [DYNGRP]
GO
