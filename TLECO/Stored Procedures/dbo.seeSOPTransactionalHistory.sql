SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[seeSOPTransactionalHistory]  @SORTBY char(15),       @i_CUSTNMBR_RS char(15) = '',    @i_CUSTNMBR_RE char(15) = '',    @i_DOCDATE_RS datetime = '',    @i_DOCDATE_RE datetime = '',    @i_DOCNUMBR_RS char(21) = '',    @i_DOCNUMBR_RE char(21) = '',    @TXDETAILS tinyint = 0,      @PYMDEPOTS tinyint = 0,      @USRDEFIND tinyint = 0,      @DETAIL tinyint = 0        as  set nocount on  declare @SOPNUMBE char(21),  @SOPTYPE tinyint,  @ITEMNMBR char(31), @MY_DEX_ROW int, @x varchar(1000), @PRRTNTAL numeric(19,5), @PRINVTAL numeric(19,5), @CSINVTAL numeric(19,5), @CSRTNTAL numeric(19,5), @EPINVTAL numeric(19,5), @EPRTNTAL numeric(19,5), @TOTFRGHTINV numeric(19,5), @TOTFRGHTRTN numeric(19,5), @TOTTRDICRTN numeric(19,5), @TOTTRDICINV numeric(19,5), @TOTLMISCRTN numeric(19,5), @TOTLMISCINV numeric(19,5), @TOTALTAXRTN numeric(19,5), @TOTALTAXINV numeric(19,5), @CASHDEP numeric(19,5), @CASHPAY numeric(19,5), @CHECKDEP numeric(19,5), @CHECKPAY numeric(19,5), @CCDEP numeric(19,5), @CCPAY numeric(19,5)  set @x = ''  If OBJECT_ID('tempdb..#SOPDOCSTATUS') is  NULL  Begin  create table #SOPDOCSTATUS (  SOPNUMBE char(21) not null default '',  SOPTYPE char(15) not null default '',  DOCID char(15) not null default '',  DOCDATE datetime not null default '01/01/1900',  MSTRNUMB int not null default 0,  SLPRSNID char(15) not null default '',  CUSTNMBR char(15) not null default '',  CUSTNAME char(65) not null default '',  ITEMNMBR char(31) not null default '',  ITEMDESC char(101) not null default '',  ITEMTYPE tinyint not null default 0,  ITMTRKOP tinyint not null default 0,  LNITMSEQ int not null default 0,  CMPNTSEQ int not null default 0,  LOCNCODE char(11) not null default '',  UofM char(9) not null default '',  ITMTSHID char(15) not null default '',  QUANTITY numeric(19,5) not null default 0.00,  QTYTOINV numeric(19,5) not null default 0.00,  EXTDPRIC numeric(19,5) not null default 0.00,  EXTDCOST numeric(19,5) not null default 0.00,  PROFIT   numeric(19,5) not null default 0.00,  TAXAMNT numeric(19,5) not null default 0.00,  PMARGIN  numeric(19,5) not null default 0.00,  VOIDSTTS tinyint not null default 0,  SERLTNUM char(1000) not null default '',  EPINVTAL numeric(19,5) not null default 0.00,  EPRTNTAL numeric(19,5) not null default 0.00,  CSINVTAL numeric(19,5) not null default 0.00,  CSRTNTAL numeric(19,5) not null default 0.00,  PRINVTAL numeric(19,5) not null default 0.00,  PRRTNTAL numeric(19,5) not null default 0.00,  TOTFRGHT numeric(19,5) not null default 0.00,  TOTTRDIC numeric(19,5) not null default 0.00,  TOTLMISC numeric(19,5) not null default 0.00,  TOTALTAX numeric(19,5) not null default 0.00,  TOTLCASH numeric(19,5) not null default 0.00,  TOTLCHCK numeric(19,5) not null default 0.00,  TOTLCRDC numeric(19,5) not null default 0.00,  PYMTTYPE char(25) not null default '',  PMNTDATE datetime not null default '01/01/1900',  PMNTCRCY char(12) not null default '',  PMNTNUMB char(21) not null default '',  CARDNAME char(15) not null default '',  PMNTAMNT numeric(19,5) not null default 0.00,  HIDEDETL tinyint not null default 0,  HIDESERL tinyint not null default 0,  USRDAT01 datetime not null default '01/01/1900',  USRDAT02 datetime not null default '01/01/1900',  USRTAB01 char(21) not null default '',  USRTAB09 char(21) not null default '',  USRTAB03 char(21) not null default '',  USERDEF1 char(21) not null default '',  USERDEF2 char(21) not null default '',  USRDEF03 char(21) not null default '',  USRDEF04 char(21) not null default '',  USRDEF05 char(21) not null default '',  USRDFPR1 char(21) not null default '',  USRDFPR2 char(21) not null default '',  USRDFPR3 char(21) not null default '',  USRDFPR4 char(21) not null default '',  USRDFPR5 char(21) not null default '',  USRDFPR6 char(21) not null default '',  USRDFPR7 char(21) not null default '',  USRDFPR8 char(21) not null default '',  USRDFPR9 char(21) not null default '',  USRDFP10 char(21) not null default '',  MY_DEX_ROW int Identity (1,1) )  End   delete #SOPDOCSTATUS   insert into #SOPDOCSTATUS ( SOPNUMBE,SOPTYPE,DOCID,DOCDATE,MSTRNUMB,SLPRSNID,CUSTNMBR,CUSTNAME,  ITEMNMBR,ITEMDESC,ITEMTYPE,ITMTRKOP,LNITMSEQ,CMPNTSEQ,LOCNCODE,UofM,ITMTSHID,QUANTITY,QTYTOINV,EXTDPRIC,EXTDCOST,PROFIT,TAXAMNT,PMARGIN,VOIDSTTS)   select a.SOPNUMBE, a.SOPTYPE, a.DOCID, a.DOCDATE,a.MSTRNUMB,a.SLPRSNID,a.CUSTNMBR,a.CUSTNAME,  b.ITEMNMBR,b.ITEMDESC,isnull(c.ITEMTYPE,1),isnull(c.ITMTRKOP,1),b.LNITMSEQ,b.CMPNTSEQ,b.LOCNCODE,b.UOFM,b.ITMTSHID,b.QUANTITY,b.QTYTOINV,b.XTNDPRCE,b.EXTDCOST,  cast(b.XTNDPRCE - b.EXTDCOST as numeric(19,2)) as PROFIT, a.TAXAMNT,  case when b.XTNDPRCE = 0.00 then 0.00 else cast((b.XTNDPRCE - b.EXTDCOST) / b.XTNDPRCE as numeric(19,5)) end,  a.VOIDSTTS  FROM   sop30200 a inner join   sop30300 b on a.sopnumbe = b.sopnumbe AND a.soptype = b.soptype  left outer join  iv00101 c on b.itemnmbr = c.itemnmbr  WHERE  a.soptype IN ( 3, 4 )  AND a.sopnumbe BETWEEN @i_DOCNUMBR_RS AND @i_DOCNUMBR_RE   AND a.custnmbr BETWEEN @i_CUSTNMBR_RS AND @i_CUSTNMBR_RE   AND a.docdate BETWEEN @i_DOCDATE_RS AND @i_DOCDATE_RE    update a set a.USRDAT01 = b.USRDAT01,  a.USRDAT02 = b.USRDAT02,  a.USRTAB01 = b.USRTAB01,  a.USRTAB09 = b.USRTAB09,  a.USRTAB03 = b.USRTAB03,  a.USERDEF1 = b.USERDEF1,  a.USERDEF2 = b.USERDEF2,  a.USRDEF03 = b.USRDEF03,  a.USRDEF04 = b.USRDEF04,  a.USRDEF05 = b.USRDEF05  from #SOPDOCSTATUS a, SOP10106 b  where a.SOPNUMBE = b.SOPNUMBE and  a.SOPTYPE = b.SOPTYPE   update a set a.USRDFPR1 = case when b.USRDFPR1 = '' then 'List 1:' else b.USRDFPR1 end,  a.USRDFPR2 = case when b.USRDRPR2 = '' then 'List 2:' else b.USRDRPR2 end,  a.USRDFPR3 = case when b.USRDRPR3 = '' then 'List 3:' else b.USRDRPR3 end,  a.USRDFPR4 = case when b.USRDRPR4 = '' then 'Text Field 1:' else b.USRDRPR4 end,  a.USRDFPR5 = case when b.USRDRPR5 = '' then 'Text Field 2:' else b.USRDRPR5 end,  a.USRDFPR6 = case when b.USRDRPR6 = '' then 'Text Field 3:' else b.USRDRPR6 end,  a.USRDFPR7 = case when b.USRDRPR7 = '' then 'Text Field 4:' else b.USRDRPR7 end,  a.USRDFPR8 = case when b.USRDRPR7 = '' then 'Text Field 5:' else b.USRDRPR8 end,  a.USRDFPR9 = case when b.USRDRPR8 = '' then 'Date Field 1:' else b.USRDRPR9 end,  a.USRDFP10 = case when b.USRDRP10 = '' then 'Date Field 2:' else b.USRDRP10 end  from #SOPDOCSTATUS a, SOP40100 b   DECLARE SERIAL_CHECK CURSOR FOR  SELECT distinct SOPNUMBE, SOPTYPE, ITEMNMBR, MY_DEX_ROW   FROM #SOPDOCSTATUS  where ITMTRKOP = 2  order by SOPNUMBE, SOPTYPE, ITEMNMBR   OPEN SERIAL_CHECK   FETCH NEXT FROM SERIAL_CHECK  INTO @SOPNUMBE, @SOPTYPE, @ITEMNMBR, @MY_DEX_ROW  WHILE @@FETCH_STATUS = 0  Begin   select @x = @x +  case   when @x = '' then rtrim(SERLTNUM)  else '; ' + rtrim(SERLTNUM)  end  from SOP10201 where SOPNUMBE = @SOPNUMBE and SOPTYPE = @SOPTYPE and ITEMNMBR = @ITEMNMBR  update #SOPDOCSTATUS set SERLTNUM = @x where MY_DEX_ROW = @MY_DEX_ROW   FETCH NEXT FROM SERIAL_CHECK INTO @SOPNUMBE, @SOPTYPE, @ITEMNMBR, @MY_DEX_ROW  End    CLOSE SERIAL_CHECK  DEALLOCATE SERIAL_CHECK   update #SOPDOCSTATUS set HIDESERL = 1 where SERLTNUM <> ''   select @EPINVTAL = sum(isNULL(EXTDPRIC,0)) from #SOPDOCSTATUS where SOPTYPE = 3  select @EPRTNTAL = sum(isNULL(EXTDPRIC,0)) from #SOPDOCSTATUS where SOPTYPE = 4  select @CSINVTAL = sum(isNULL(EXTDCOST,0)) from #SOPDOCSTATUS where SOPTYPE = 3  select @CSRTNTAL = sum(isNULL(EXTDCOST,0)) from #SOPDOCSTATUS where SOPTYPE = 4  select @PRINVTAL = sum(isNULL(EXTDPRIC,0) - isNULL(EXTDCOST,0)) from #SOPDOCSTATUS where SOPTYPE = 3  select @PRRTNTAL = sum(isNULL(EXTDPRIC,0) - isNULL(EXTDCOST,0)) from #SOPDOCSTATUS where SOPTYPE = 4  update #SOPDOCSTATUS set EPINVTAL = isNULL(@EPINVTAL,0)  update #SOPDOCSTATUS set EPRTNTAL = isNULL(@EPRTNTAL,0)  update #SOPDOCSTATUS set CSINVTAL = isNULL(@CSINVTAL,0)  update #SOPDOCSTATUS set CSRTNTAL = isNULL(@CSRTNTAL,0)  update #SOPDOCSTATUS set PRINVTAL = isNULL(@PRINVTAL,0)  update #SOPDOCSTATUS set PRRTNTAL = isNULL(@PRRTNTAL,0)   select @TOTFRGHTINV = sum(FRTAMNT) from SOP30200 where SOPNUMBE in (select SOPNUMBE from #SOPDOCSTATUS) and SOPTYPE = 3  select @TOTFRGHTRTN = sum(FRTAMNT) from SOP30200 where SOPNUMBE in (select SOPNUMBE from #SOPDOCSTATUS) and SOPTYPE = 4   update #SOPDOCSTATUS set TOTFRGHT = isNULL(@TOTFRGHTINV,0) - isNULL(@TOTFRGHTRTN,0)   select @TOTTRDICINV = sum(TRDISAMT) from SOP30200 where SOPNUMBE in (select SOPNUMBE from #SOPDOCSTATUS) and SOPTYPE = 3  select @TOTTRDICRTN = sum(TRDISAMT) from SOP30200 where SOPNUMBE in (select SOPNUMBE from #SOPDOCSTATUS) and SOPTYPE = 4   update #SOPDOCSTATUS set TOTTRDIC = isNULL(@TOTTRDICINV,0) - isNULL(@TOTTRDICRTN,0)   select @TOTLMISCINV = sum(MISCAMNT) from SOP30200 where SOPNUMBE in (select SOPNUMBE from #SOPDOCSTATUS) and SOPTYPE = 3  select @TOTLMISCRTN = sum(MISCAMNT) from SOP30200 where SOPNUMBE in (select SOPNUMBE from #SOPDOCSTATUS) and SOPTYPE = 4   update #SOPDOCSTATUS set TOTLMISC = isNULL(@TOTLMISCINV,0) - isNULL(@TOTLMISCRTN,0)   select @TOTALTAXINV = sum(TAXAMNT) from SOP30200 where SOPNUMBE in (select SOPNUMBE from #SOPDOCSTATUS) and SOPTYPE = 3  select @TOTALTAXRTN = sum(TAXAMNT) from SOP30200 where SOPNUMBE in (select SOPNUMBE from #SOPDOCSTATUS) and SOPTYPE = 4   update #SOPDOCSTATUS set TOTALTAX = isNULL(@TOTALTAXINV,0) - isNULL(@TOTALTAXRTN,0)   select @CASHDEP = sum(AMNTPAID) from SOP10103 where SOPNUMBE in (select SOPNUMBE from #SOPDOCSTATUS) and PYMTTYPE = 1  select @CASHPAY = sum(AMNTPAID) from SOP10103 where SOPNUMBE in (select SOPNUMBE from #SOPDOCSTATUS) and PYMTTYPE = 4   select @CHECKDEP = sum(AMNTPAID) from SOP10103 where SOPNUMBE in (select SOPNUMBE from #SOPDOCSTATUS) and PYMTTYPE = 2  select @CHECKPAY = sum(AMNTPAID) from SOP10103 where SOPNUMBE in (select SOPNUMBE from #SOPDOCSTATUS) and PYMTTYPE = 5   select @CCDEP = sum(AMNTPAID) from SOP10103 where SOPNUMBE in (select SOPNUMBE from #SOPDOCSTATUS) and PYMTTYPE = 3  select @CCPAY = sum(AMNTPAID) from SOP10103 where SOPNUMBE in (select SOPNUMBE from #SOPDOCSTATUS) and PYMTTYPE = 6   update #SOPDOCSTATUS set TOTLCASH = isNULL(@CASHDEP,0) + isNULL(@CASHPAY,0)  update #SOPDOCSTATUS set TOTLCHCK = isNULL(@CHECKDEP,0) + isNULL(@CHECKPAY,0)  update #SOPDOCSTATUS set TOTLCRDC = isNULL(@CCDEP,0) + isNULL(@CCPAY,0)   update a set  a.PYMTTYPE = case   when b.PYMTTYPE = 1 then 'Cash Deposit'  when b.PYMTTYPE = 2 then 'Check Deposit'  when b.PYMTTYPE = 3 then 'Credit Card Deposit'  when b.PYMTTYPE = 4 then 'Cash Payment'  when b.PYMTTYPE = 5 then 'Check Payment'   when b.PYMTTYPE = 6 then 'Credit Card Payment'  else '' end,  a.PMNTDATE = b.DOCDATE,  a.PMNTCRCY = b.CURNCYID,  a.PMNTNUMB = b.DOCNUMBR,  a.CARDNAME = b.CARDNAME,  a.PMNTAMNT = AMNTPAID  from #SOPDOCSTATUS a, SOP10103 b  where a.SOPNUMBE = b.SOPNUMBE and  a.SOPTYPE = b.SOPTYPE  select * from #SOPDOCSTATUS     
GO
GRANT EXECUTE ON  [dbo].[seeSOPTransactionalHistory] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[seeSOPTransactionalHistory] TO [rpt_order processor]
GO
