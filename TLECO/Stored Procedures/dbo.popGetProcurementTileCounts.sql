SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[popGetProcurementTileCounts]  @I_cUserID char(15) = NULL,  @I_cDomainUserName                  char(255) = NULL,   @I_fWorkflowActivated               tinyint  = NULL,   @O_nSavedCount int   = NULL output,   @O_nPendingUserActionCount          int   = NULL output,  @O_nReadyForPurchaseCount           int   = NULL output,  @O_nRejectedCount int   = NULL output,   @O_iErrorState int   = NULL output  AS  DECLARE @nSavedCt int,  @nPendingUserActionCt int,  @nReadyForPurchaseCt int,  @nRejectedCt int,  @sCompanyDatabase char(30)  if( @I_cUserID is NULL or  @I_cDomainUserName is NULL or  @I_fWorkflowActivated is NULL  ) begin  select          @O_iErrorState = 21022  return end   select @O_iErrorState = 0,  @O_nSavedCount = 0,  @O_nPendingUserActionCount = 0,  @O_nReadyForPurchaseCount = 0,  @O_nRejectedCount = 0  select @nSavedCt = 0,  @nPendingUserActionCt = 0,  @nReadyForPurchaseCt = 0,  @nRejectedCt = 0  select @nSavedCt = COUNT(POPRequisitionNumber) from POP10200 as R where ((R.RequisitionStatus = 1 and R.Workflow_Status in (1, 3, 9)) or  (R.RequisitionStatus = 2 and R.Workflow_Status in (1, 5))) and  ( R.REQSTDBY = @I_cUserID or (NOT EXISTS (select 1 from DYNAMICS..SY01400 as U where R.REQSTDBY = U.USERID) and  R.DomainUserName = @I_cDomainUserName ))  select @nReadyForPurchaseCt = COUNT(POPRequisitionNumber) from POP10200 as R where (R.RequisitionStatus = 2 and R.Workflow_Status in (3, 6, 9)) and  ( R.REQSTDBY = @I_cUserID or (NOT EXISTS (select 1 from DYNAMICS..SY01400 as U where R.REQSTDBY = U.USERID) and  R.DomainUserName = @I_cDomainUserName )) if @I_fWorkflowActivated  = 1  BEGIN  select @nPendingUserActionCt = COUNT(POPRequisitionNumber) from POP10200 as R  where (R.RequisitionStatus = 2 and R.Workflow_Status = 4) and  ( R.REQSTDBY = @I_cUserID or (NOT EXISTS (select 1 from DYNAMICS..SY01400 as U where R.REQSTDBY = U.USERID) and  R.DomainUserName = @I_cDomainUserName ))   select @nRejectedCt = COUNT(POPRequisitionNumber) from POP10200 as R  where (R.Workflow_Status = 7) and  ( R.REQSTDBY = @I_cUserID or (NOT EXISTS (select 1 from DYNAMICS..SY01400 as U where R.REQSTDBY = U.USERID) and  R.DomainUserName = @I_cDomainUserName ))   END  select @O_nSavedCount = @nSavedCt select @O_nPendingUserActionCount = @nPendingUserActionCt select @O_nReadyForPurchaseCount = @nReadyForPurchaseCt select @O_nRejectedCount = @nRejectedCt  RETURN    
GO
GRANT EXECUTE ON  [dbo].[popGetProcurementTileCounts] TO [DYNGRP]
GO
