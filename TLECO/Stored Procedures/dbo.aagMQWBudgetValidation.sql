SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[aagMQWBudgetValidation]  @aaColumn int,  @LevlTable nvarchar(30),  @ColmnTable nvarchar(30),  @WINTYPE smallint,  @Error int output as begin  set nocount on  declare @aaBudgetTreeID int,  @aaOrder int,  @Cnt int,  @aaBudgetTree char(15),  @Top nvarchar(50)   select @aaBudgetTreeID  = 0,  @aaOrder  = 0,  @Cnt   = 0,  @aaOrder  = 0   if @WINTYPE = 4   begin  if @aaColumn not in (-1,6)  begin  exec ('declare CLvl cursor fast_forward for  select count(*) from ' + @LevlTable + ' where aaColumn = 118')  open CLvl  fetch next from CLvl into @Cnt  close CLvl  deallocate CLvl  if @Cnt <> 0  set @Error = 900   end   if @aaColumn = 118  begin  exec ('declare CLvl cursor fast_forward for  select count(*) from ' + @LevlTable + ' where aaColumn not in (-1,6)')  open CLvl  fetch next from CLvl into @Cnt  close CLvl  deallocate CLvl  if @Cnt <> 0  begin  set @Error = 901   return  end   select top 1 @aaBudgetTreeID = aaBudgetTreeID , @aaBudgetTree = aaBudgetTree   from AAG00900   if len(ltrim(rtrim(str(@aaBudgetTreeID)))) = 0  begin  set @Error = 902  end  else  begin  exec('update ' + @ColmnTable + ' set aaUseTree = 1 where aaColumn = 118')  end  end   end   else if @WINTYPE = 5   begin  if @aaColumn not in (-1,6)  begin  exec ('declare CLvl cursor fast_forward for  select count(*) from ' + @LevlTable + ' where aaColumn = 118')  open CLvl  fetch next from CLvl into @Cnt  close CLvl  deallocate CLvl  if @Cnt <> 0  set @Error = 903   end   end   else if @WINTYPE = 8   begin  exec('declare CCOL cursor fast_forward for  select count(*) from '+@ColmnTable+' where aaColumn = ' + @aaColumn +' and aaBudget = 0' )  open CCOL  fetch next from CCOL into @Cnt  close CCOL  deallocate CCOL  if @Cnt <> 0  set @Error = 904   select @Cnt = count(*) from AAG00903  if @Cnt = 0  set @Error = 905   end   else if @WINTYPE = 9   begin   exec('declare CCOL cursor fast_forward for  select count(*),aaOrder from '+@LevlTable+' where aaColumn = 118 group by aaOrder')  open CCOL  fetch next from CCOL into @Cnt,@aaOrder  close CCOL  deallocate CCOL  if @Cnt = 1  begin  if exists(select name from tempdb..sysobjects where name = '##BudgetTree'    and type = 'U') drop table ##BudgetTree  exec(' declare clvl cursor fast_forward for select aaTreeLevel from '+ @ColmnTable + ' where aaColumn = 118')  open clvl  fetch next from clvl into @Cnt  close clvl  deallocate clvl  if @Cnt = 0  set @Top = ''  else  set @Top = 'Top' +space(1) + ltrim(str(@Cnt))  exec('select * into ##BudgetTree from '+ @LevlTable +' where aaColumn = 118')   update ##BudgetTree set aaIsCodeSpread = @Cnt    exec ('delete from ' + @LevlTable + ' where  aaColumn = 118')   exec('insert into '+  @LevlTable +' (aaColumn,aaOrder,aaIsCodeSpread)  select ' + @Top + ' a.aaColumn,b.aaOrder + '+ @aaOrder +',0  from '+  @ColmnTable +' a, AAG00901 b  where b.aaBudgetTreeID = (select aaTreeID from '+  @ColmnTable +' where aaColumn = 118)  and a.aaTrxDimID = b.aaTrxDimID')   exec('Update '+  @ColmnTable +' set aaTotals = 1 where aaTrxDimID in (select aaTrxDimID from AAG00901   where aaBudgetTreeID = (select aaTreeID from '+  @ColmnTable +' where aaColumn = 118))')   set @Cnt = 0  exec('declare CRen cursor fast_forward for select aaColumn from ' + @LevlTable + ' order by aaOrder')  open CRen  set @Cnt  = 0  fetch next from CRen into @aaColumn  while @@fetch_status = 0  begin  set @Cnt = @Cnt  + 1  exec ('update ' + @LevlTable + ' set aaOrder = ' + @Cnt + ' where aaColumn = '+ @aaColumn)  fetch next from CRen into @aaColumn  end  close CRen  deallocate CRen  end   end   set nocount off end    
GO
GRANT EXECUTE ON  [dbo].[aagMQWBudgetValidation] TO [DYNGRP]
GO
