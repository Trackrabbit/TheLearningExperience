SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE procedure  [dbo].[aagUpdateUnpostedDistsForAcct]  @iAcctIndex  int = 0,  @oSuccess tinyint = 0 output As Begin Declare @AcctClassID int,  @AcctIndex int,  @RequiredFieldEmpty tinyint,  @Series smallint,  @QtyIsZero tinyint,  @HdrID int,  @DistID int,  @TrxQty numeric(19,5),  @RetCode int  Select @AcctClassID = aaAcctClassID from AAG00200 where ACTINDX = @iAcctIndex  If @AcctClassID = 0 or @AcctClassID = null  Begin  If exists(select top 1 ACTINDX from AAG20001 where ACTINDX = @iAcctIndex and POSTED = 0)  Begin  Update AAG20002  Set DEBITAMT = AAG20001.DEBITAMT, CRDTAMNT = AAG20001.CRDTAMNT, ORDBTAMT = AAG20001.ORDBTAMT, ORCRDAMT = AAG20001.ORCRDAMT,  aaAssignedPercent = 10000  From AAG20001 INNER JOIN AAG20002  On AAG20001.aaSubLedgerHdrID = AAG20002.aaSubLedgerHdrID and  AAG20001.aaSubLedgerDistID = AAG20002.aaSubLedgerDistID and  AAG20002.aaSubLedgerAssignID = 1  Where AAG20001.POSTED = 0 and AAG20001.ACTINDX = @iAcctIndex and  (select max(AAG20002.aaSubLedgerAssignID) from AAG20002  where AAG20001.aaSubLedgerHdrID = AAG20002.aaSubLedgerHdrID and  AAG20001.aaSubLedgerDistID = AAG20002.aaSubLedgerDistID) <> 1  Delete AAG20003 from AAG20003 AS Code INNER JOIN AAG20001 AS Dist ON Code.aaSubLedgerDistID = Dist.aaSubLedgerDistID and  Code.aaSubLedgerHdrID = Dist.aaSubLedgerHdrID and  Dist.ACTINDX = @iAcctIndex and Dist.POSTED = 0   Delete AAG20002 from AAG20002 AS Assign INNER JOIN AAG20001 AS Dist ON Assign.aaSubLedgerAssignID > 1 and  Assign.aaSubLedgerDistID = Dist.aaSubLedgerDistID and  Assign.aaSubLedgerHdrID = Dist.aaSubLedgerHdrID and  Dist.ACTINDX = @iAcctIndex and Dist.POSTED = 0   Update AAG20001 set aaBrowseType = 0 where ACTINDX = @iAcctIndex and POSTED = 0  End  End  Else   Begin  If exists(select top 1 ACTINDX from AAG20001 where ACTINDX = @iAcctIndex and POSTED = 0)  Begin   Update AAG20002  Set DEBITAMT = AAG20001.DEBITAMT, CRDTAMNT = AAG20001.CRDTAMNT, ORDBTAMT = AAG20001.ORDBTAMT, ORCRDAMT = AAG20001.ORCRDAMT,  aaAssignedPercent = 10000  From AAG20001 INNER JOIN AAG20002  On AAG20001.aaSubLedgerHdrID = AAG20002.aaSubLedgerHdrID and  AAG20001.aaSubLedgerDistID = AAG20002.aaSubLedgerDistID and  AAG20002.aaSubLedgerAssignID = 1  Where AAG20001.POSTED = 0 and AAG20001.ACTINDX = @iAcctIndex and  (select max(AAG20002.aaSubLedgerAssignID) from AAG20002  where AAG20001.aaSubLedgerHdrID = AAG20002.aaSubLedgerHdrID and  AAG20001.aaSubLedgerDistID = AAG20002.aaSubLedgerDistID) <> 1  Delete AAG20003 from AAG20003 AS Code INNER JOIN AAG20001 AS Dist ON Code.aaSubLedgerDistID = Dist.aaSubLedgerDistID and  Code.aaSubLedgerHdrID = Dist.aaSubLedgerHdrID and  Dist.ACTINDX = @iAcctIndex and Dist.POSTED = 0   Delete AAG20002 from AAG20002 AS Assign INNER JOIN AAG20001 AS Dist ON Assign.aaSubLedgerAssignID > 1 and  Assign.aaSubLedgerDistID = Dist.aaSubLedgerDistID and  Assign.aaSubLedgerHdrID = Dist.aaSubLedgerHdrID and  Dist.ACTINDX = @iAcctIndex and Dist.POSTED = 0   Update AAG20001 set aaBrowseType = 0 where ACTINDX = @iAcctIndex and POSTED = 0  End  Declare Accounts cursor fast_forward FOR Select aaSubLedgerHdrID, aaSubLedgerDistID, TRXQTY  From AAG20001 Where ACTINDX = @iAcctIndex and POSTED = 0  Order by aaSubLedgerHdrID, aaSubLedgerDistID  Open Accounts  Fetch next from Accounts into @HdrID, @DistID, @TrxQty  WHILE @@fetch_status = 0  Begin  Select @Series = SERIES From AAG20000 Where aaSubLedgerHdrID = @HdrID  If @Series = 5 and @TrxQty = 0   Set @QtyIsZero = 1  Else  Set @QtyIsZero = 0   Execute aagSubLedgerCodeUpdate @HdrID, @DistID, 1, @AcctClassID, @RequiredFieldEmpty output   If @Series = 5   Begin  If @QtyIsZero = 1   Update AAG20001 set aaBrowseType = 3 where aaSubLedgerHdrID = @HdrID and ACTINDX = @iAcctIndex and POSTED = 0  Else if @RequiredFieldEmpty = 1  Update AAG20001 set aaBrowseType = 2 where aaSubLedgerHdrID = @HdrID and ACTINDX = @iAcctIndex and POSTED = 0  Else  Update AAG20001 set aaBrowseType = 1 where aaSubLedgerHdrID = @HdrID and ACTINDX = @iAcctIndex and POSTED = 0  End  Else if @RequiredFieldEmpty = 1  Update AAG20001 set aaBrowseType = 2 where aaSubLedgerHdrID = @HdrID and ACTINDX = @iAcctIndex and POSTED = 0  Else  Update AAG20001 set aaBrowseType = 1 where aaSubLedgerHdrID = @HdrID and ACTINDX = @iAcctIndex and POSTED = 0  Fetch next from Accounts into @HdrID, @DistID, @TrxQty  End  Close Accounts  Deallocate Accounts End  Exec aagUpdateUnpostedDistsForAcctGLWork @iAcctIndex, @oSuccess End    
GO
GRANT EXECUTE ON  [dbo].[aagUpdateUnpostedDistsForAcct] TO [DYNGRP]
GO
