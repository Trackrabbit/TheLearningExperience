SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create proc [dbo].[aagMLCalcCellAlt]   @iYear smallint = 0, @iTruncateTo smallint = 0,  @whereCmd   nvarchar(2000), @iClearIfNull tinyint  as  begin   declare @period nvarchar(3),  @year nvarchar(4),  @execCmd nvarchar(4000),  @colID smallint,   @oStatus smallint,  @retCode int,  @SelectdCols varchar(1000),  @SelColID int   Select @oStatus = 0,  @execCmd  = N'',  @year   = convert(nvarchar(4), @iYear),  @retCode = 0    set dateformat ymd    set @SelectdCols=','  declare  aaSelectedCols cursor fast_forward for select distinct col from ##RowCols  open aaSelectedCols  fetch next from aaSelectedCols into @SelColID  while @@fetch_status=0  begin  set @SelectdCols=@SelectdCols + convert(varchar,@SelColID) + ','  fetch next from aaSelectedCols into @SelColID  end  close aaSelectedCols  deallocate aaSelectedCols   if exists(select * from tempdb..sysobjects where name = '##PreActCellImport'    and type = 'U') drop table ##PreActCellImport  Create table ##PreActCellImport (AtActualVal numeric(19,5), rowOrder int not null, colID int not null)   if charindex(',101,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreActCellImport (AtActualVal, rowOrder, colID) ' +  ' select isnull(sum(balance), 0) AtActualVal,   a.rowOrder, a.colID from ##RowCols, ##PreCalc, ##ExpCols, ##RowCols a where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and a.col in(101) and year1 = ' + @year   + ' and period = a.basePeriod and ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = 0'  + ' Group By a.rowOrder, a.colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',102,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreActCellImport (AtActualVal, rowOrder, colID) ' +  ' select isnull(sum(balance), 0) AtActualVal,   a.rowOrder, a.colID from ##RowCols, ##PreCalc, ##ExpCols, ##RowCols a where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and a.col in(102) and year1 = ' + @year   + ' and period between 1 and a.basePeriod and ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = 0'  + ' Group By a.rowOrder, a.colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',103,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreActCellImport (AtActualVal, rowOrder, colID) ' +  ' select isnull(sum(balance), 0) AtActualVal,   a.rowOrder, a.colID from ##RowCols, ##PreCalc, ##ExpCols, ##RowCols a where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and a.col in(103) and year1 = ' + @year   + ' and period = a.basePeriod -1 and ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = 0'  + ' Group By a.rowOrder, a.colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',104,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreActCellImport (AtActualVal, rowOrder, colID) ' +  ' select isnull(sum(balance), 0) AtActualVal,   a.rowOrder, a.colID from ##RowCols, ##PreCalc, ##ExpCols, ##RowCols a where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and a.col in(104) and year1 = ' + @year   + ' and period between 1 and a.basePeriod - 1 and ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = 0'  + ' Group By a.rowOrder, a.colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',105,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreActCellImport (AtActualVal, rowOrder, colID) ' +  ' select isnull(sum(balance), 0) AtActualVal,   a.rowOrder, a.colID from ##RowCols, ##PreCalc, ##ExpCols, ##RowCols a where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and a.col in(105) and year1 = ' + @year   + ' and period = a.basePeriod and ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = 0'  + ' Group By a.rowOrder, a.colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',106,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreActCellImport (AtActualVal, rowOrder, colID) ' +  ' select isnull(sum(balance), 0) AtActualVal,   a.rowOrder, a.colID from ##RowCols, ##PreCalc, ##ExpCols, ##RowCols a where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and a.col in(106) and year1 = ' + @year   + ' and period between 1 and a.basePeriod and ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = 0'  + ' Group By a.rowOrder, a.colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',107,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreActCellImport (AtActualVal, rowOrder, colID) ' +  ' select isnull(sum(balance), 0) AtActualVal,   a.rowOrder, a.colID from ##RowCols, ##PreCalc, ##ExpCols, ##RowCols a where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and a.col in(107) and year1 = ' + @year   + ' and period = a.basePeriod -1 and ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = 0'  + ' Group By a.rowOrder, a.colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',108,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreActCellImport (AtActualVal, rowOrder, colID) ' +  ' select isnull(sum(balance), 0) AtActualVal,   a.rowOrder, a.colID from ##RowCols, ##PreCalc, ##ExpCols, ##RowCols a where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and a.col in(108) and year1 = ' + @year   + ' and period between 1 and a.basePeriod - 1 and ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = 0'  + ' Group By a.rowOrder, a.colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',109,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreActCellImport (AtActualVal, rowOrder, colID) ' +  ' select isnull(sum(balance), 0) AtActualVal,   a.rowOrder, a.colID from ##RowCols, ##PreCalc, ##ExpCols, ##RowCols a where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and a.col in(109) and year1 = ' + @year + '-1'  + ' and period = a.basePeriod and ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = 0'  + ' Group By a.rowOrder, a.colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',110,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreActCellImport (AtActualVal, rowOrder, colID) ' +  ' select isnull(sum(balance), 0) AtActualVal,   a.rowOrder, a.colID from ##RowCols, ##PreCalc, ##ExpCols, ##RowCols a where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and a.col in(110) and year1 = ' + @year + '-1'  + ' and period between 1 and a.basePeriod and ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = 0'  + ' Group By a.rowOrder, a.colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',111,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreActCellImport (AtActualVal, rowOrder, colID) ' +  ' select isnull(sum(balance), 0) AtActualVal,   a.rowOrder, a.colID from ##RowCols, ##PreCalc, ##ExpCols, ##RowCols a where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and a.col in(111) and year1 = ' + @year + '-1'  + ' and period = a.basePeriod and ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = 0'  + ' Group By a.rowOrder, a.colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',112,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreActCellImport (AtActualVal, rowOrder, colID) ' +  ' select isnull(sum(balance), 0) AtActualVal,   a.rowOrder, a.colID from ##RowCols, ##PreCalc, ##ExpCols, ##RowCols a where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and a.col in(112) and year1 = ' + @year + '-1'  + ' and period between 1 and a.basePeriod and ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = 0'  + ' Group By a.rowOrder, a.colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if exists(select * from tempdb..sysobjects where name = '##PreCellImport'    and type = 'U') drop table ##PreCellImport  Create table ##PreCellImport (AtcellVal numeric(19,5), rowOrder int not null, colID int not null)  if charindex(',1,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(1, isnull(sum(debit), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 1  and year1 = ' + @year   + ' and period = basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',2,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(2, isnull(sum(debit), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 2  and year1 = ' + @year   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',3,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(3, isnull(sum(debit), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 3  and year1 = ' + @year + '-1'   + ' and period = basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',4,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(4, isnull(sum(debit), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 4  and year1 = ' + @year + ' -1'  + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',5,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(5, isnull(sum(debit), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 5  and year1 = ' + @year   + ' and period = basePeriod - 1  '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',6,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(6, isnull(sum(debit), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 6  and year1 = ' + @year   + ' and period between 1 and basePeriod - 1 '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',7,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(7, isnull(sum(case when period = basePeriod then debit else 0 end), 0), isnull(sum(debit), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 7  and year1 = ' + @year   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',8,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(8, isnull(sum(case when period = basePeriod then debit else 0 end), 0),' +  'isnull(sum(case when period = basePeriod - 1 then debit else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 8  and year1 = ' + @year   + ' and period in(basePeriod - 1, basePeriod) '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',9,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(9, isnull(sum(case when period = basePeriod then debit else 0 end), 0),' +  'isnull(sum(case when period = basePeriod - 1 then debit else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 9  and year1 = ' + @year   + ' and period in(basePeriod - 1, basePeriod) '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',10,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(10, isnull(sum(case when period = basePeriod then debit else 0 end), 0), isnull(sum(debit), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 10  and year1 = ' + @year + '-1'   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',11,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(11, isnull(sum(case when year1 = ' + @year + '   then debit else 0 end), 0),' +  'isnull(sum(case when year1 = ' + @year + '-1 then debit else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 11  and year1 in (' + @year + '-1,' + @year + ')'  + ' and period = basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',12,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(12, isnull(sum(case when year1 = ' + @year + '   then debit else 0 end), 0),' +  'isnull(sum(case when year1 = ' + @year + '-1 then debit else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 12  and year1 in (' + @year + '-1,' + @year + ')'   + ' and period = basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',13,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(13, isnull(sum(case when year1 = ' + @year + '   then debit else 0 end), 0),' +  'isnull(sum(case when year1 = ' + @year + '-1 then debit else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 13  and year1 in (' + @year + '-1,' + @year + ')'   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',14,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(14, isnull(sum(case when year1 = ' + @year + '   then debit else 0 end), 0),' +  'isnull(sum(case when year1 = ' + @year + '-1 then debit else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 14  and year1 in (' + @year + '-1,' + @year + ')'   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',21,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(21, isnull(sum(credit), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 21  and year1 = ' + @year   + ' and period = basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',22,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(22, isnull(sum(credit), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 22  and year1 = ' + @year   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',23,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(23, isnull(sum(credit), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 23  and year1 = ' + @year + ' - 1'  + ' and period = basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',24,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(24, isnull(sum(credit), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 24 and year1 = ' + @year + ' - 1'  + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',25,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(25, isnull(sum(credit), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 25  and year1 = ' + @year   + ' and period = basePeriod - 1 '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',26,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(26, isnull(sum(credit), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 26  and year1 = ' + @year   + ' and period between 1 and basePeriod - 1 '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',27,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(27, isnull(sum(case when period = basePeriod then credit else 0 end), 0), isnull(sum(credit), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 27  and year1 = ' + @year   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',28,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(28, isnull(sum(case when period = basePeriod   then credit else 0 end), 0),' +  'isnull(sum(case when period = basePeriod -1 then credit else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 28  and year1 = ' + @year   + ' and period in (basePeriod -1, basePeriod) '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',29,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(29, isnull(sum(case when period = basePeriod then credit else 0 end), 0),' +  'isnull(sum(case when period = basePeriod -1 then credit else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 29  and year1 = ' + @year   + ' and period in (basePeriod -1, basePeriod) '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',30,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(30, isnull(sum(case when period = basePeriod then credit else 0 end), 0), isnull(sum(credit), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 30  and year1 = ' + @year + '-1'   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',31,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(31, isnull(sum(case when year1 = ' + @year + '   then credit else 0 end), 0),' +  'isnull(sum(case when year1 = ' + @year + '-1 then credit else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 31  and year1 in (' + @year + '-1,' + @year + ')'   + ' and period = basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',32,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(32, isnull(sum(case when year1 = ' + @year + '   then credit else 0 end), 0),' +  'isnull(sum(case when year1 = ' + @year + '-1 then credit else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 32  and year1 in (' + @year + '-1,' + @year + ')'   + ' and period = basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',33,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(33, isnull(sum(case when year1 = ' + @year + '   then credit else 0 end), 0),' +  'isnull(sum(case when year1 = ' + @year + '-1 then credit else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 33  and year1 in (' + @year + '-1,' + @year + ')'  + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',34,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(34, isnull(sum(case when year1 = ' + @year + '   then credit else 0 end), 0),' +  'isnull(sum(case when year1 = ' + @year + '-1 then credit else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 34  and year1 in (' + @year + '-1,' + @year + ')'  + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',41,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(41, isnull(sum(balance), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 41  and year1 = ' + @year   + ' and period = basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',42,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(42, isnull(sum(balance), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 42  and year1 = ' + @year   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',43,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(43, isnull(sum(balance), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 43  and year1 = ' + @year + '-1'   + ' and period = basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',44,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(44, isnull(sum(balance), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 44  and year1 = ' + @year + '-1'   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',45,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(45, isnull(sum(balance), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 45  and year1 = ' + @year   + ' and period = basePeriod -1 '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',46,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(46, isnull(sum(balance), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 46  and year1 = ' + @year   + ' and period between 1 and basePeriod -1 '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',47,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(47, isnull(sum(case when period = basePeriod then balance else 0 end), 0), isnull(sum(balance), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 47 and year1 = ' + @year   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',48,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(48, isnull(sum(case when period = basePeriod   then balance else 0 end), 0),' +  'isnull(sum(case when period = basePeriod -1 then balance else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 48  and year1 = ' + @year   + ' and period in (basePeriod - 1, basePeriod) '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',49,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(49, isnull(sum(case when period = basePeriod   then balance else 0 end), 0),' +  'isnull(sum(case when period = basePeriod -1 then balance else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 49 and year1 = ' + @year   + ' and period in (basePeriod -1, basePeriod) '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',50,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(50, isnull(sum(case when period = basePeriod then balance else 0 end), 0), isnull(sum(balance), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 50  and year1 = ' + @year + '-1'   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',51,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(51, isnull(sum(case when year1 = ' + @year + '   then balance else 0 end), 0),' +  'isnull(sum(case when year1 = ' + @year + '-1 then balance else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 51  and year1 in (' + @year + '-1,' + @year + ')'   + ' and period = basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',52,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(52, isnull(sum(case when year1 = ' + @year + '   then balance else 0 end), 0),' +  'isnull(sum(case when year1 = ' + @year + '-1 then balance else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 52  and year1 in (' + @year + '-1,' + @year + ')'   + ' and period = basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',53,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(53, isnull(sum(case when year1 = ' + @year + '   then balance else 0 end), 0),' +  'isnull(sum(case when year1 = ' + @year + '-1 then balance else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 53  and year1 in (' + @year + '-1,' + @year + ')'   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',54,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(54, isnull(sum(case when year1 = ' + @year + '   then balance else 0 end), 0),' +  'isnull(sum(case when year1 = ' + @year + '-1 then balance else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 54  and year1 in (' + @year + '-1,' + @year + ')'   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID = ##RowCols.aaBudgetID'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',80,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(80, 0,0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 80  and year1 in (' + @year + '-1,' + @year + ')'   + ' and period = basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',81,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(81, isnull(sum(balance), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 81  and year1 = ' + @year   + ' and period = basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',82,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(82, isnull(sum(balance), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 82  and year1 = ' + @year   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',83,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(83, isnull(sum(balance), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 83  and year1 = ' + @year + '-1'   + ' and period = basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',84,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(84, isnull(sum(balance), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 84  and year1 = ' + @year + '-1'   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',85,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(85, isnull(sum(balance), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 85 and year1 = ' + @year   + ' and period = basePeriod -1 '  + @whereCmd  + ' and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',86,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(86, isnull(sum(balance), 0), 0'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 86  and year1 = ' + @year   + ' and period between 1 and basePeriod -1 '  + @whereCmd  + ' and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',87,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(87, isnull(sum(case when period = basePeriod then balance else 0 end), 0), isnull(sum(balance), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 87  and year1 = ' + @year   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',88,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(88, isnull(sum(case when period = basePeriod then balance else 0 end), 0),' +  'isnull(sum(case when period = basePeriod -1 then balance else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 88  and year1 = ' + @year   + ' and period in (basePeriod -1, basePeriod) '  + @whereCmd  + ' and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',89,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(89, isnull(sum(case when period = basePeriod then balance else 0 end), 0),' +  'isnull(sum(case when period = basePeriod -1 then balance else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 89  and year1 = ' + @year   + ' and period in (basePeriod -1, basePeriod) '  + @whereCmd  + ' and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',90,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(90, isnull(sum(case when year1 = ' + @year + '   then balance else 0 end), 0),' +  'isnull(sum(case when year1 = ' + @year + '-1 then balance else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 90  and year1 in (' + @year + '-1,' + @year + ')'   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',91,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(91, isnull(sum(case when year1 = ' + @year + '   then balance else 0 end), 0),' +  'isnull(sum(case when year1 = ' + @year + '-1 then balance else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 91  and year1 in (' + @year + '-1,' + @year + ')'   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',92,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(92, isnull(sum(case when period = basePeriod then balance else 0 end), 0), isnull(sum(balance), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 92  and year1 = ' + @year + '-1'   + ' and period between 1 and basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',93,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(93, isnull(sum(case when year1 = ' + @year + '   then balance else 0 end), 0),' +  'isnull(sum(case when year1 = ' + @year + '-1 then balance else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 93  and year1 in (' + @year + '-1,' + @year + ')'   + ' and period = basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',94,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(94, isnull(sum(case when year1 = ' + @year + '   then balance else 0 end), 0),' +  'isnull(sum(case when year1 = ' + @year + '-1 then balance else 0 end), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   rowOrder, colID from ##RowCols, ##PreCalc, ##ExpCols where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0   and col = 94  and year1 in (' + @year + '-1,' + @year + ')'   + ' and period = basePeriod '  + @whereCmd  + ' and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))'  + ' Group By rowOrder, colID'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',101,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(101, isnull(sum(balance), 0), isnull(AtActualVal,0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   a.rowOrder, a.colID from ##RowCols Inner Join ##ExpCols On (##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0)   Inner Join ##RowCols a on (##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID )  left outer join ##PreActCellImport on (##PreActCellImport.rowOrder = a.rowOrder and ##PreActCellImport.colID = a.colID)   left outer Join (select ##PreCalc.*, a.rowOrder, a.colID from ##PreCalc, ##ExpCols, ##RowCols, ##RowCols a  where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0 and a.col = 101 and   ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID   ' +  @whereCmd + ' and year1 = ' + @year + ' and period = a.basePeriod  and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))  ) ddPreCalc on (' +  replace(substring(@whereCmd, 5, len(@whereCmd) - 4 ), '##PreCalc', 'ddPreCalc') + ' and year1 = ' + @year + '  and period = a.basePeriod and  ddPreCalc.rowOrder = a.rowOrder and ddPreCalc.colID = a.colID)   where a.col = 101   Group By a.rowOrder, a.colID, AtActualVal'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',102,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(102, isnull(sum(balance), 0), isnull(AtActualVal,0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   a.rowOrder, a.colID from ##RowCols Inner Join ##ExpCols On (##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0)   Inner Join ##RowCols a on (##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID )  left outer join ##PreActCellImport on (##PreActCellImport.rowOrder = a.rowOrder and ##PreActCellImport.colID = a.colID)   left outer Join (select ##PreCalc.*, a.rowOrder, a.colID from ##PreCalc, ##ExpCols, ##RowCols, ##RowCols a  where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0 and a.col = 102 and   ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID   ' +  @whereCmd + ' and year1 = ' + @year + ' and period between 1 and a.basePeriod  and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))  ) ddPreCalc on (' +  replace(substring(@whereCmd, 5, len(@whereCmd) - 4 ), '##PreCalc', 'ddPreCalc') + ' and year1 = ' + @year + '  and period between 1 and a.basePeriod and  ddPreCalc.rowOrder = a.rowOrder and ddPreCalc.colID = a.colID)   where a.col = 102   Group By a.rowOrder, a.colID, AtActualVal'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',103,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(103, isnull(sum(balance), 0), isnull(AtActualVal,0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   a.rowOrder, a.colID from ##RowCols Inner Join ##ExpCols On (##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0)   Inner Join ##RowCols a on (##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID )  left outer join ##PreActCellImport on (##PreActCellImport.rowOrder = a.rowOrder and ##PreActCellImport.colID = a.colID)   left outer Join (select ##PreCalc.*, a.rowOrder, a.colID from ##PreCalc, ##ExpCols, ##RowCols, ##RowCols a  where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0 and a.col = 103 and   ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID   ' +  @whereCmd + ' and year1 = ' + @year + ' and period = a.basePeriod -1  and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))  ) ddPreCalc on (' +  replace(substring(@whereCmd, 5, len(@whereCmd) - 4 ), '##PreCalc', 'ddPreCalc') + ' and year1 = ' + @year + '  and period = a.basePeriod -1 and  ddPreCalc.rowOrder = a.rowOrder and ddPreCalc.colID = a.colID)   where a.col = 103   Group By a.rowOrder, a.colID, AtActualVal'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',104,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(104, isnull(sum(balance), 0), isnull(AtActualVal,0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   a.rowOrder, a.colID from ##RowCols Inner Join ##ExpCols On (##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0)   Inner Join ##RowCols a on (##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID )  left outer join ##PreActCellImport on (##PreActCellImport.rowOrder = a.rowOrder and ##PreActCellImport.colID = a.colID)   left outer Join (select ##PreCalc.*, a.rowOrder, a.colID from ##PreCalc, ##ExpCols, ##RowCols, ##RowCols a  where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0 and a.col = 104 and   ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID   ' +  @whereCmd + ' and year1 = ' + @year + ' and period between 1 and a.basePeriod -1  and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))  ) ddPreCalc on (' +  replace(substring(@whereCmd, 5, len(@whereCmd) - 4 ), '##PreCalc', 'ddPreCalc') + ' and year1 = ' + @year + '  and period between 1 and a.basePeriod -1 and  ddPreCalc.rowOrder = a.rowOrder and ddPreCalc.colID = a.colID)   where a.col = 104   Group By a.rowOrder, a.colID, AtActualVal'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',105,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(105, isnull(sum(balance), 0), isnull(sum(balance)-isnull(AtActualVal,0), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   a.rowOrder, a.colID from ##RowCols Inner Join ##ExpCols On (##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0)   Inner Join ##RowCols a on (##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID )  left outer join ##PreActCellImport on (##PreActCellImport.rowOrder = a.rowOrder and ##PreActCellImport.colID = a.colID)   left outer Join (select ##PreCalc.*, a.rowOrder, a.colID from ##PreCalc, ##ExpCols, ##RowCols, ##RowCols a  where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0 and a.col = 105 and   ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID   ' +  @whereCmd + ' and year1 = ' + @year + ' and period = a.basePeriod  and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))  ) ddPreCalc on (' +  replace(substring(@whereCmd, 5, len(@whereCmd) - 4 ), '##PreCalc', 'ddPreCalc') + ' and year1 = ' + @year + '  and period = a.basePeriod and  ddPreCalc.rowOrder = a.rowOrder and ddPreCalc.colID = a.colID)   where a.col = 105   Group By a.rowOrder, a.colID, AtActualVal'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',106,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(106, isnull(sum(balance), 0), isnull(sum(balance)- isnull(AtActualVal,0), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   a.rowOrder, a.colID from ##RowCols Inner Join ##ExpCols On (##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0)   Inner Join ##RowCols a on (##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID )  left outer join ##PreActCellImport on (##PreActCellImport.rowOrder = a.rowOrder and ##PreActCellImport.colID = a.colID)   left outer Join (select ##PreCalc.*, a.rowOrder, a.colID from ##PreCalc, ##ExpCols, ##RowCols, ##RowCols a  where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0 and a.col = 106 and   ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID   ' +  @whereCmd + ' and year1 = ' + @year + ' and period between 1 and a.basePeriod  and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))  ) ddPreCalc on (' +  replace(substring(@whereCmd, 5, len(@whereCmd) - 4 ), '##PreCalc', 'ddPreCalc') + ' and year1 = ' + @year + '  and period between 1 and a.basePeriod and  ddPreCalc.rowOrder = a.rowOrder and ddPreCalc.colID = a.colID)   where a.col = 106   Group By a.rowOrder, a.colID, AtActualVal'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',107,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(107, isnull(sum(balance), 0), isnull(sum(balance)- isnull(AtActualVal,0), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   a.rowOrder, a.colID from ##RowCols Inner Join ##ExpCols On (##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0)   Inner Join ##RowCols a on (##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID )  left outer join ##PreActCellImport on (##PreActCellImport.rowOrder = a.rowOrder and ##PreActCellImport.colID = a.colID)   left outer Join (select ##PreCalc.*, a.rowOrder, a.colID from ##PreCalc, ##ExpCols, ##RowCols, ##RowCols a  where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0 and a.col = 107 and   ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID   ' +  @whereCmd + ' and year1 = ' + @year + ' and period = a.basePeriod - 1  and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))  ) ddPreCalc on (' +  replace(substring(@whereCmd, 5, len(@whereCmd) - 4 ), '##PreCalc', 'ddPreCalc') + ' and year1 = ' + @year + '  and period = a.basePeriod - 1 and  ddPreCalc.rowOrder = a.rowOrder and ddPreCalc.colID = a.colID)   where a.col = 107   Group By a.rowOrder, a.colID, AtActualVal'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',108,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(108, isnull(sum(balance), 0), isnull(sum(balance)-isnull(AtActualVal,0), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   a.rowOrder, a.colID from ##RowCols Inner Join ##ExpCols On (##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0)   Inner Join ##RowCols a on (##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID )  left outer join ##PreActCellImport on (##PreActCellImport.rowOrder = a.rowOrder and ##PreActCellImport.colID = a.colID)   left outer Join (select ##PreCalc.*, a.rowOrder, a.colID from ##PreCalc, ##ExpCols, ##RowCols, ##RowCols a  where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0 and a.col = 108 and   ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID   ' +  @whereCmd + ' and year1 = ' + @year + ' and period between 1 and a.basePeriod -1  and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))  ) ddPreCalc on (' +  replace(substring(@whereCmd, 5, len(@whereCmd) - 4 ), '##PreCalc', 'ddPreCalc') + ' and year1 = ' + @year + '  and period between 1 and a.basePeriod -1 and  ddPreCalc.rowOrder = a.rowOrder and ddPreCalc.colID = a.colID)   where a.col = 108   Group By a.rowOrder, a.colID, AtActualVal'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',109,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(109, isnull(sum(balance), 0), isnull(AtActualVal,0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   a.rowOrder, a.colID from ##RowCols Inner Join ##ExpCols On (##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0)   Inner Join ##RowCols a on (##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID )  left outer join ##PreActCellImport on (##PreActCellImport.rowOrder = a.rowOrder and ##PreActCellImport.colID = a.colID)   left outer Join (select ##PreCalc.*, a.rowOrder, a.colID from ##PreCalc, ##ExpCols, ##RowCols, ##RowCols a  where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0 and a.col = 109 and   ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID   ' +  @whereCmd + ' and year1 = ' + @year + '-1 and period = a.basePeriod  and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))  ) ddPreCalc on (' +  replace(substring(@whereCmd, 5, len(@whereCmd) - 4 ), '##PreCalc', 'ddPreCalc') + ' and year1 = ' + @year + '-1  and period = a.basePeriod and  ddPreCalc.rowOrder = a.rowOrder and ddPreCalc.colID = a.colID)   where a.col = 109   Group By a.rowOrder, a.colID, AtActualVal'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',110,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(110, isnull(sum(balance), 0), isnull(AtActualVal,0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   a.rowOrder, a.colID from ##RowCols Inner Join ##ExpCols On (##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0)   Inner Join ##RowCols a on (##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID )  left outer join ##PreActCellImport on (##PreActCellImport.rowOrder = a.rowOrder and ##PreActCellImport.colID = a.colID)   left outer Join (select ##PreCalc.*, a.rowOrder, a.colID from ##PreCalc, ##ExpCols, ##RowCols, ##RowCols a  where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0 and a.col = 110 and   ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID   ' +  @whereCmd + ' and year1 = ' + @year + '-1 and period between 1 and a.basePeriod  and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))  ) ddPreCalc on (' +  replace(substring(@whereCmd, 5, len(@whereCmd) - 4 ), '##PreCalc', 'ddPreCalc') + ' and year1 = ' + @year + '-1  and period between 1 and a.basePeriod and  ddPreCalc.rowOrder = a.rowOrder and ddPreCalc.colID = a.colID)   where a.col = 110   Group By a.rowOrder, a.colID, AtActualVal'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',111,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(111, isnull(sum(balance), 0), isnull(sum(balance)-isnull(AtActualVal,0), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   a.rowOrder, a.colID from ##RowCols Inner Join ##ExpCols On (##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0)   Inner Join ##RowCols a on (##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID )  left outer join ##PreActCellImport on (##PreActCellImport.rowOrder = a.rowOrder and ##PreActCellImport.colID = a.colID)   left outer Join (select ##PreCalc.*, a.rowOrder, a.colID from ##PreCalc, ##ExpCols, ##RowCols, ##RowCols a  where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0 and a.col = 111 and   ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID   ' +  @whereCmd + ' and year1 = ' + @year + '-1 and period = a.basePeriod  and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))  ) ddPreCalc on (' +  replace(substring(@whereCmd, 5, len(@whereCmd) - 4 ), '##PreCalc', 'ddPreCalc') + ' and year1 = ' + @year + '-1  and period = a.basePeriod and  ddPreCalc.rowOrder = a.rowOrder and ddPreCalc.colID = a.colID)   where a.col = 111   Group By a.rowOrder, a.colID, AtActualVal'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   if charindex(',112,',@SelectdCols)>0  begin  select @execCmd = 'Insert ##PreCellImport (AtcellVal, rowOrder, colID) ' +  ' select dbo.aagMLCellVal(112, isnull(sum(balance), 0), isnull(sum(balance)-isnull(AtActualVal,0), 0)'  + ' , ' + convert(nvarchar(3), @iTruncateTo) + ',  0, 1) AtcellVal,   a.rowOrder, a.colID from ##RowCols Inner Join ##ExpCols On (##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0)   Inner Join ##RowCols a on (##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID )  left outer join ##PreActCellImport on (##PreActCellImport.rowOrder = a.rowOrder and ##PreActCellImport.colID = a.colID)   left outer Join (select ##PreCalc.*, a.rowOrder, a.colID from ##PreCalc, ##ExpCols, ##RowCols, ##RowCols a  where ##ExpCols.aaColID = ##RowCols.colID and aaColFlag = 0 and a.col = 112 and   ##RowCols.rowOrder = a.rowOrder and ##RowCols.colID = a.colID   ' +  @whereCmd + ' and year1 = ' + @year + '-1 and period between 1 and a.basePeriod  and ##PreCalc.aaBudgetID in (select Distinct aaBudgetID from AAG00903 where aaBudget=(select Distinct aaBudget from AAG00903 where  aaBudgetID= ##RowCols.aaBudgetID))  ) ddPreCalc on (' +  replace(substring(@whereCmd, 5, len(@whereCmd) - 4 ), '##PreCalc', 'ddPreCalc') + ' and year1 = ' + @year + '-1  and period between 1 and a.basePeriod and  ddPreCalc.rowOrder = a.rowOrder and ddPreCalc.colID = a.colID)   where a.col = 112   Group By a.rowOrder, a.colID, AtActualVal'  if LEN(@execCmd) >= 8000   begin   select @oStatus = -30   return @oStatus   end   exec @retCode = sp_executesql @execCmd   end   Declare @AtcellVal numeric(19,5), @rowOrder int, @execCmd1 nvarchar(4000)  declare p cursor fast_forward for select AtcellVal, rowOrder, colID from ##PreCellImport  open p  fetch next from p into @AtcellVal, @rowOrder, @colID  while (@@fetch_status <> -1)   begin  if @iClearIfNull = 1  select @execCmd1 = N' Update ##CellImport set cell' + convert(nvarchar,@colID) + ' = ' +   case   when  @AtcellVal = 0 then  ' Null '   else convert(nvarchar, @AtcellVal )  end   + ' where rowOrder = ' + convert(nvarchar, @rowOrder)  else  select @execCmd1 = N' Update ##CellImport set cell' + convert(nvarchar,@colID) + ' = ' +   convert(nvarchar,isnull(@AtcellVal, 0))  + ' where rowOrder = ' + convert(nvarchar,@rowOrder)   exec @retCode = sp_executesql @execCmd1  fetch next from p into @AtcellVal, @rowOrder, @colID  end  close p  deallocate p   if exists(select * from tempdb..sysobjects where name = '##PreActCellImport'    and type = 'U') drop table ##PreActCellImport  return 0 end    
GO
GRANT EXECUTE ON  [dbo].[aagMLCalcCellAlt] TO [DYNGRP]
GO
