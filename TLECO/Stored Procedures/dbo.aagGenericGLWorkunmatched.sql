SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
 CREATE  PROCEDURE [dbo].[aagGenericGLWorkunmatched] @USERID CHAR(15), @TBName varchar(25), @Preview SMALLINT, @O_SQL_Error_State int = NULL  output AS Begin  SET NOCOUNT ON  SET TRANSACTION ISOLATION LEVEL READ COMMITTED  BEGIN TRANSACTION   IF @Preview = 1  BEGIN  EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Work Distribution Table'',''AA GL Work Header ID=''+LTRIM(STR(A.aaGLWorkHdrID))+Space(3)+''AA GL Work Distribution ID=''+LTRIM(STR(A.aaGLWorkDistID))  ,10,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG10000 WHERE AAG10000.aaGLWorkHdrID =LTRIM(STR(A.aaGLWorkHdrID)) ),0)  from AAG10001 A inner join (select MIN(DEX_ROW_ID) as DEX_ROW_ID,count(1) as COUNT1, aaGLWorkHdrID, SQNCLINE from AAG10001   group by aaGLWorkHdrID, SQNCLINE having count(1) > 1) B on A.aaGLWorkHdrID = B.aaGLWorkHdrID   and A.SQNCLINE = B.SQNCLINE where A.DEX_ROW_ID <> B.DEX_ROW_ID and A.aaGLWorkHdrID  not in (   select distinct A0.aaGLWorkHdrID from AAG10000 A0 inner join (select JRNENTRY,SQNCLINE,DEX_ROW_ID from GL10001  union all select JRNENTRY,SQNCLINE,DEX_ROW_ID from GL10101) GL on GL.JRNENTRY =A0.JRNENTRY and GL.SQNCLINE = B.SQNCLINE   inner join (select MIN(B1.DEX_ROW_ID) as DEX_ROW_ID,count(1) as COUNT1,B1.JRNENTRY,B1.SQNCLINE from   (select JRNENTRY,SQNCLINE,DEX_ROW_ID from GL10001 union all select JRNENTRY,SQNCLINE,DEX_ROW_ID from GL10101) B1   group by B1.JRNENTRY,B1.SQNCLINE having count(1) > 1) B2 on GL.JRNENTRY = B2.JRNENTRY   and GL.SQNCLINE = B2.SQNCLINE where GL.DEX_ROW_ID <> B2.DEX_ROW_ID )')   IF NOT EXISTS(SELECT TOP 1 1 FROM AAG10001 A1 INNER JOIN AAG10000 A on A1.aaGLWorkHdrID =A.aaGLWorkHdrID inner join   (SELECT GL10000.JRNENTRY,GL10001.SQNCLINE GL_SQNCLINE,ACTINDX,TRXDATE,CURNCYID,GL10000.CURRNIDX,DEBITAMT,CRDTAMNT from GL10000 , GL10001   where GL10001.JRNENTRY = GL10000.JRNENTRY and   (GL10000.JRNENTRY IN (select JRNENTRY from AAG10000 where aaGLWorkHdrID not in (select Distinct aaGLWorkHdrID from AAG10001)) or  (GL10000.JRNENTRY IN (select JRNENTRY from AAG10000 where aaGLWorkHdrID in (select Distinct aaGLWorkHdrID from AAG10001)) and  (GL10001.SQNCLINE) not in  (select  SQNCLINE from AAG10001 where aaGLWorkHdrID = (select aaGLWorkHdrID from AAG10000 where AAG10000.JRNENTRY=GL10000.JRNENTRY))))  ) GL on GL.JRNENTRY=A.JRNENTRY AND A1.ACTINDX = GL.ACTINDX AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   UNION  SELECT TOP 1 1 FROM AAG10001 A1 INNER JOIN AAG10000 A on A1.aaGLWorkHdrID =A.aaGLWorkHdrID inner join   (SELECT GL10100.JRNENTRY,GL10101.SQNCLINE GL_SQNCLINE,ACTINDX,TRXDATE,CURNCYID,  case when GL10101.TRXAMNT < 0 then 0 else GL10101.TRXAMNT end as DEBITAMT,  case when GL10101.TRXAMNT > 0  then 0 else abs(GL10101.TRXAMNT) end as CRDTAMNT from GL10100 , GL10101   where GL10101.JRNENTRY = GL10100.JRNENTRY and   (GL10100.JRNENTRY IN (select JRNENTRY from AAG10000 where aaGLWorkHdrID not in (select Distinct aaGLWorkHdrID from AAG10001)) or  (GL10100.JRNENTRY IN (select JRNENTRY from AAG10000 where aaGLWorkHdrID in (select Distinct aaGLWorkHdrID from AAG10001)) and (GL10101.SQNCLINE) not in  (select  SQNCLINE from AAG10001 where aaGLWorkHdrID = (select aaGLWorkHdrID from AAG10000 where AAG10000.JRNENTRY=GL10100.JRNENTRY))))  ) GL on GL.JRNENTRY=A.JRNENTRY AND A1.ACTINDX = GL.ACTINDX AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT )   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Work Distribution Table'',''AA GL Work Header ID=''+LTRIM(STR(A1.aaGLWorkHdrID ))+SPACE(3)+''AA GL Work Distribution ID=''+LTRIM(STR(A1.aaGLWorkDistID )) ,10,1, LTRIM(STR(A.JRNENTRY))  FROM AAG10001 A1 INNER JOIN AAG10000 A ON A1.aaGLWorkHdrID=A.aaGLWorkHdrID AND AA_CL_Status = 0  LEFT JOIN (SELECT GL1.JRNENTRY,GL1.SQNCLINE,GL1.ACTINDX,GL.RCTRXSEQ FROM GL10001 GL1 INNER JOIN GL10000 GL ON GL1.JRNENTRY = GL.JRNENTRY AND GL1.BACHNUMB = GL.BACHNUMB UNION ALL SELECT JRNENTRY,SQNCLINE,ACTINDX,0 AS RCTRXSEQ FROM GL10101) B ON B.JRNENTRY =A.JRNENTRY  AND A1.ACTINDX = B.ACTINDX AND A.RCTRXSEQ = B.RCTRXSEQ WHERE B.JRNENTRY IS NULL')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Work Assignment Table'',''AA GL Work Header ID=''+LTRIM(STR(A2.aaGLWorkHdrID ))+SPACE(3)+''AA GL Work Distribution ID=''+LTRIM(STR(A2.aaGLWorkDistID )) ,10,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG10000 WHERE aaGLWorkHdrID =LTRIM(STR(A2.aaGLWorkHdrID)) ),0)  FROM AAG10002 A2 WHERE A2.aaGLWorkDistID NOT IN (SELECT A1.aaGLWorkDistID FROM   AAG10001 A1 WHERE A1.aaGLWorkHdrID=A2.aaGLWorkHdrID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Work Code Table'',''AA GL Work Header ID=''+LTRIM(STR(A3.aaGLWorkHdrID ))+SPACE(3)+''AA GL Work Distribution ID=''+LTRIM(STR(A3.aaGLWorkDistID )),10,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG10000 WHERE aaGLWorkHdrID =LTRIM(STR(A3.aaGLWorkHdrID)) ),0)  FROM AAG10003 A3 WHERE A3.aaGLWorkDistID NOT IN (SELECT A1.aaGLWorkDistID FROM   AAG10001 A1 WHERE A1.aaGLWorkHdrID=A3.aaGLWorkHdrID)')   IF NOT EXISTS(SELECT TOP 1 1 FROM AAG10001 A1 INNER JOIN AAG10000 A on A1.aaGLWorkHdrID =A.aaGLWorkHdrID inner join   (SELECT GL10000.JRNENTRY,GL10001.SQNCLINE GL_SQNCLINE,ACTINDX,TRXDATE,CURNCYID,GL10000.CURRNIDX,DEBITAMT,CRDTAMNT from GL10000 , GL10001   where GL10001.JRNENTRY = GL10000.JRNENTRY and   (GL10000.JRNENTRY IN (select JRNENTRY from AAG10000 where aaGLWorkHdrID not in (select Distinct aaGLWorkHdrID from AAG10001)) or  (GL10000.JRNENTRY IN (select JRNENTRY from AAG10000 where aaGLWorkHdrID in (select Distinct aaGLWorkHdrID from AAG10001)) and  (GL10001.SQNCLINE) not in  (select  SQNCLINE from AAG10001 where aaGLWorkHdrID = (select aaGLWorkHdrID from AAG10000 where AAG10000.JRNENTRY=GL10000.JRNENTRY))))  ) GL on GL.JRNENTRY=A.JRNENTRY AND A1.ACTINDX = GL.ACTINDX AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   UNION  SELECT TOP 1 1 FROM AAG10001 A1 INNER JOIN AAG10000 A on A1.aaGLWorkHdrID =A.aaGLWorkHdrID inner join   (SELECT GL10100.JRNENTRY,GL10101.SQNCLINE GL_SQNCLINE,ACTINDX,TRXDATE,CURNCYID,  case when GL10101.TRXAMNT < 0 then 0 else GL10101.TRXAMNT end as DEBITAMT,  case when GL10101.TRXAMNT > 0  then 0 else abs(GL10101.TRXAMNT) end as CRDTAMNT from GL10100 , GL10101   where GL10101.JRNENTRY = GL10100.JRNENTRY and   (GL10100.JRNENTRY IN (select JRNENTRY from AAG10000 where aaGLWorkHdrID not in (select Distinct aaGLWorkHdrID from AAG10001)) or  (GL10100.JRNENTRY IN (select JRNENTRY from AAG10000 where aaGLWorkHdrID in (select Distinct aaGLWorkHdrID from AAG10001)) and (GL10101.SQNCLINE) not in  (select  SQNCLINE from AAG10001 where aaGLWorkHdrID = (select aaGLWorkHdrID from AAG10000 where AAG10000.JRNENTRY=GL10100.JRNENTRY))))  ) GL on GL.JRNENTRY=A.JRNENTRY AND A1.ACTINDX = GL.ACTINDX AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT )   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Work Distribution Table'',''AA GL Work Header ID=''+LTRIM(STR(AAG10001.aaGLWorkHdrID ))+SPACE(3)+''AA GL Work Distribution ID=''+LTRIM(STR(AAG10001.aaGLWorkDistID )) ,10,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG10000 WHERE aaGLWorkHdrID =LTRIM(STR(AAG10001.aaGLWorkHdrID)) ),0)  FROM AAG10001 WHERE AA_CL_Status = 0 AND aaGLWorkHdrID IN (SELECT DISTINCT aaGLWorkHdrID FROM AAG10000) AND   aaGLWorkDistID >  (SELECT COUNT(B.JRNENTRY) FROM AAG10001 A1 INNER JOIN AAG10000 A ON A1.aaGLWorkHdrID=A.aaGLWorkHdrID   RIGHT JOIN (SELECT JRNENTRY,SQNCLINE,ACTINDX FROM GL10001 UNION ALL SELECT JRNENTRY,SQNCLINE,ACTINDX FROM GL10101) B   ON B.JRNENTRY =A.JRNENTRY AND A1.ACTINDX = B.ACTINDX WHERE B.JRNENTRY IS NOT NULL AND  A.aaGLWorkHdrID= AAG10001.aaGLWorkHdrID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Work Assignment Table'',''AA GL Work Header ID=''+LTRIM(STR(A2.aaGLWorkHdrID ))+SPACE(3)+''AA GL Work Distribution ID=''+LTRIM(STR(A2.aaGLWorkDistID )),10,1  ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG10000 WHERE aaGLWorkHdrID =LTRIM(STR(A2.aaGLWorkHdrID)) ),0)  FROM AAG10002 A2 WHERE A2.aaGLWorkDistID not in (select A1.aaGLWorkDistID FROM   AAG10001 A1 where A1.aaGLWorkHdrID=A2.aaGLWorkHdrID) ')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Work Code Table'',''AA GL Work Header ID=''+LTRIM(STR(A3.aaGLWorkHdrID ))+SPACE(3)+''AA GL Work Distribution ID=''+LTRIM(STR(A3.aaGLWorkDistID )) ,10,1  ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG10000 WHERE aaGLWorkHdrID =LTRIM(STR(A3.aaGLWorkHdrID)) ),0)  FROM AAG10003 A3 WHERE A3.aaGLWorkDistID NOT IN (SELECT A1.aaGLWorkDistID FROM   AAG10001 A1 WHERE A1.aaGLWorkHdrID=A3.aaGLWorkHdrID)')   END  ELSE  BEGIN  EXEC (' With AAG01 as(  SELECT A.aaGLWorkDistID , A.aaGLWorkHdrID,A.SQNCLINE FROM  AAG10001 A INNER JOIN   (SELECT MIN(DEX_ROW_ID) AS DEX_ROW_ID,COUNT(1) AS COUNT1, aaGLWorkHdrID, SQNCLINE FROM AAG10001   GROUP BY aaGLWorkHdrID, SQNCLINE HAVING COUNT(1) > 1) B ON A.aaGLWorkHdrID = B.aaGLWorkHdrID   AND A.SQNCLINE = B.SQNCLINE WHERE A.DEX_ROW_ID <> B.DEX_ROW_ID AND A.aaGLWorkHdrID  NOT IN (   SELECT DISTINCT A0.aaGLWorkHdrID FROM AAG10000 A0 INNER JOIN (SELECT a.JRNENTRY,a.SQNCLINE,a.DEX_ROW_ID,RCTRXSEQ FROM GL10001 a INNER JOIN GL10000 ON a.JRNENTRY = GL10000.JRNENTRY AND a.BACHNUMB = GL10000.BACHNUMB  UNION ALL SELECT JRNENTRY,SQNCLINE,DEX_ROW_ID,0 AS RCTRXSEQ FROM GL10101) GL on GL.JRNENTRY =A0.JRNENTRY AND GL.SQNCLINE = B.SQNCLINE AND GL.RCTRXSEQ =A0.RCTRXSEQ  INNER JOIN (SELECT MIN(B1.DEX_ROW_ID) AS DEX_ROW_ID,COUNT(1) AS COUNT1,B1.JRNENTRY,B1.SQNCLINE FROM   (SELECT JRNENTRY,SQNCLINE,DEX_ROW_ID FROM GL10001 UNION ALL SELECT JRNENTRY,SQNCLINE,DEX_ROW_ID FROM GL10101) B1   GROUP BY B1.JRNENTRY,B1.SQNCLINE HAVING COUNT(1) > 1) B2 ON GL.JRNENTRY = B2.JRNENTRY   AND GL.SQNCLINE = B2.SQNCLINE WHERE GL.DEX_ROW_ID <> B2.DEX_ROW_ID ) )   INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Work Distribution Table'',''AA GL Work Header ID=''+LTRIM(STR(A.aaGLWorkHdrID))+Space(3)+''AA GL Work Distribution ID=''+LTRIM(STR(A.aaGLWorkDistID))  ,4,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG10000 WHERE AAG10000.aaGLWorkHdrID =LTRIM(STR(A.aaGLWorkHdrID)) ),0)  FROM  AAG10001 A INNER JOIN (Select AAG10003.aaGLWorkHdrID,AAG10003.aaGLWorkDistID,AAG01.SQNCLINE from AAG01 Inner Join AAG10003 on  AAG01.aaGLWorkHdrID  = AAG10003.aaGLWorkHdrID AND AAG10003.aaGLWorkDistID IN (SELECT AAG10001.aaGLWorkDistID FROM AAG10001 WHERE AAG01.aaGLWorkHdrID = AAG10001.aaGLWorkHdrID AND AAG10001.SQNCLINE=AAG01.SQNCLINE)  GROUP BY AAG10003.aaGLWorkHdrID,AAG10003.aaGLWorkDistID ,AAG01.SQNCLINE  HAVING SUM(AAG10003.aaTrxCodeID)=0) a ON a.aaGLWorkHdrID = A.aaGLWorkHdrID AND a.aaGLWorkDistID = A.aaGLWorkDistID AND a.SQNCLINE = A.SQNCLINE')   EXEC(' With AAG01 as(  SELECT A.aaGLWorkDistID , A.aaGLWorkHdrID,A.SQNCLINE FROM  AAG10001 A INNER JOIN   (SELECT MIN(DEX_ROW_ID) AS DEX_ROW_ID,COUNT(1) AS COUNT1, aaGLWorkHdrID, SQNCLINE FROM AAG10001   GROUP BY aaGLWorkHdrID, SQNCLINE HAVING COUNT(1) > 1) B ON A.aaGLWorkHdrID = B.aaGLWorkHdrID   AND A.SQNCLINE = B.SQNCLINE WHERE A.DEX_ROW_ID <> B.DEX_ROW_ID AND A.aaGLWorkHdrID  NOT IN (   SELECT DISTINCT A0.aaGLWorkHdrID FROM AAG10000 A0 INNER JOIN (SELECT a.JRNENTRY,a.SQNCLINE,a.DEX_ROW_ID,RCTRXSEQ FROM GL10001 a INNER JOIN GL10000 ON a.JRNENTRY = GL10000.JRNENTRY AND a.BACHNUMB = GL10000.BACHNUMB  UNION ALL SELECT JRNENTRY,SQNCLINE,DEX_ROW_ID,0 AS RCTRXSEQ FROM GL10101) GL on GL.JRNENTRY =A0.JRNENTRY AND GL.SQNCLINE = B.SQNCLINE AND GL.RCTRXSEQ =A0.RCTRXSEQ  INNER JOIN (SELECT MIN(B1.DEX_ROW_ID) AS DEX_ROW_ID,COUNT(1) AS COUNT1,B1.JRNENTRY,B1.SQNCLINE FROM   (SELECT JRNENTRY,SQNCLINE,DEX_ROW_ID FROM GL10001 UNION ALL SELECT JRNENTRY,SQNCLINE,DEX_ROW_ID FROM GL10101) B1   GROUP BY B1.JRNENTRY,B1.SQNCLINE HAVING COUNT(1) > 1) B2 ON GL.JRNENTRY = B2.JRNENTRY   AND GL.SQNCLINE = B2.SQNCLINE WHERE GL.DEX_ROW_ID <> B2.DEX_ROW_ID ) )   DELETE AAG10001 FROM AAG10001 INNER JOIN (Select AAG10003.aaGLWorkHdrID,AAG10003.aaGLWorkDistID,AAG01.SQNCLINE from AAG01 Inner Join AAG10003 on  AAG01.aaGLWorkHdrID  = AAG10003.aaGLWorkHdrID AND AAG10003.aaGLWorkDistID IN (SELECT AAG10001.aaGLWorkDistID FROM AAG10001 WHERE AAG01.aaGLWorkHdrID = AAG10001.aaGLWorkHdrID AND AAG10001.SQNCLINE=AAG01.SQNCLINE)  GROUP BY AAG10003.aaGLWorkHdrID,AAG10003.aaGLWorkDistID ,AAG01.SQNCLINE  HAVING SUM(AAG10003.aaTrxCodeID)=0) a ON a.aaGLWorkHdrID = AAG10001.aaGLWorkHdrID AND a.aaGLWorkDistID = AAG10001.aaGLWorkDistID AND a.SQNCLINE = AAG10001.SQNCLINE')  EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Work Distribution Table'',''AA GL Work Header ID=''+LTRIM(STR(A.aaGLWorkHdrID))+Space(3)+''AA GL Work Distribution ID=''+LTRIM(STR(A.aaGLWorkDistID))  ,4,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG10000 WHERE AAG10000.aaGLWorkHdrID =LTRIM(STR(A.aaGLWorkHdrID)) ),0)  FROM  AAG10001 A INNER JOIN   (SELECT MIN(DEX_ROW_ID) AS DEX_ROW_ID,COUNT(1) AS COUNT1, aaGLWorkHdrID, SQNCLINE FROM AAG10001   GROUP BY aaGLWorkHdrID, SQNCLINE HAVING COUNT(1) > 1) B ON A.aaGLWorkHdrID = B.aaGLWorkHdrID   AND A.SQNCLINE = B.SQNCLINE WHERE A.DEX_ROW_ID <> B.DEX_ROW_ID AND A.aaGLWorkHdrID  NOT IN (   SELECT DISTINCT A0.aaGLWorkHdrID FROM AAG10000 A0 INNER JOIN (SELECT a.JRNENTRY,a.SQNCLINE,a.DEX_ROW_ID,RCTRXSEQ FROM GL10001 a INNER JOIN GL10000 ON a.JRNENTRY = GL10000.JRNENTRY AND a.BACHNUMB = GL10000.BACHNUMB  UNION ALL SELECT JRNENTRY,SQNCLINE,DEX_ROW_ID,0 AS RCTRXSEQ FROM GL10101) GL on GL.JRNENTRY =A0.JRNENTRY AND GL.SQNCLINE = B.SQNCLINE  AND GL.RCTRXSEQ =A0.RCTRXSEQ  INNER JOIN (SELECT MIN(B1.DEX_ROW_ID) AS DEX_ROW_ID,COUNT(1) AS COUNT1,B1.JRNENTRY,B1.SQNCLINE FROM   (SELECT JRNENTRY,SQNCLINE,DEX_ROW_ID FROM GL10001 UNION ALL SELECT JRNENTRY,SQNCLINE,DEX_ROW_ID FROM GL10101) B1   GROUP BY B1.JRNENTRY,B1.SQNCLINE HAVING COUNT(1) > 1) B2 ON GL.JRNENTRY = B2.JRNENTRY   AND GL.SQNCLINE = B2.SQNCLINE WHERE GL.DEX_ROW_ID <> B2.DEX_ROW_ID )')   DELETE AAG10001  FROM  AAG10001 A INNER JOIN   (SELECT MIN(DEX_ROW_ID) AS DEX_ROW_ID,COUNT(1) AS COUNT1, aaGLWorkHdrID, SQNCLINE FROM AAG10001   GROUP BY aaGLWorkHdrID, SQNCLINE HAVING COUNT(1) > 1) B ON A.aaGLWorkHdrID = B.aaGLWorkHdrID   AND A.SQNCLINE = B.SQNCLINE WHERE A.DEX_ROW_ID <> B.DEX_ROW_ID AND A.aaGLWorkHdrID  NOT IN (   SELECT DISTINCT A0.aaGLWorkHdrID FROM AAG10000 A0 INNER JOIN (SELECT a.JRNENTRY,a.SQNCLINE,a.DEX_ROW_ID,RCTRXSEQ FROM GL10001 a INNER JOIN GL10000 ON a.JRNENTRY = GL10000.JRNENTRY AND a.BACHNUMB = GL10000.BACHNUMB  UNION ALL SELECT JRNENTRY,SQNCLINE,DEX_ROW_ID,0 AS RCTRXSEQ FROM GL10101) GL on GL.JRNENTRY =A0.JRNENTRY AND GL.SQNCLINE = B.SQNCLINE AND GL.RCTRXSEQ =A0.RCTRXSEQ  INNER JOIN (SELECT MIN(B1.DEX_ROW_ID) AS DEX_ROW_ID,COUNT(1) AS COUNT1,B1.JRNENTRY,B1.SQNCLINE FROM   (SELECT JRNENTRY,SQNCLINE,DEX_ROW_ID FROM GL10001 UNION ALL SELECT JRNENTRY,SQNCLINE,DEX_ROW_ID FROM GL10101) B1   GROUP BY B1.JRNENTRY,B1.SQNCLINE HAVING COUNT(1) > 1) B2 ON GL.JRNENTRY = B2.JRNENTRY   AND GL.SQNCLINE = B2.SQNCLINE WHERE GL.DEX_ROW_ID <> B2.DEX_ROW_ID )    EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Work Distribution Table'',''AA GL Work Header ID=''+LTRIM(STR(A1.aaGLWorkHdrID ))+SPACE(3)+''AA GL Work Distribution ID=''+LTRIM(STR(A1.aaGLWorkDistID )) ,4,1 , LTRIM(STR(A.JRNENTRY))  FROM AAG10001 A1 INNER JOIN AAG10000 A ON A1.aaGLWorkHdrID=A.aaGLWorkHdrID AND AA_CL_Status = 0  LEFT JOIN (SELECT GL1.JRNENTRY,GL1.SQNCLINE,GL1.ACTINDX,GL.RCTRXSEQ FROM GL10001 GL1 INNER JOIN GL10000 GL ON GL1.JRNENTRY = GL.JRNENTRY AND GL1.BACHNUMB = GL.BACHNUMB UNION ALL SELECT JRNENTRY,SQNCLINE,ACTINDX,0 AS RCTRXSEQ FROM GL10101) B ON B.JRNENTRY =A.JRNENTRY  AND A1.ACTINDX = B.ACTINDX AND A.RCTRXSEQ = B.RCTRXSEQ WHERE B.JRNENTRY IS NULL')   DELETE AAG10001  FROM AAG10001 A1 INNER JOIN AAG10000 A ON A1.aaGLWorkHdrID=A.aaGLWorkHdrID AND AA_CL_Status = 0  LEFT JOIN (SELECT GL1.JRNENTRY,GL1.SQNCLINE,GL1.ACTINDX,GL.RCTRXSEQ FROM GL10001 GL1 INNER JOIN GL10000 GL ON GL1.JRNENTRY = GL.JRNENTRY AND GL1.BACHNUMB = GL.BACHNUMB UNION ALL SELECT JRNENTRY,SQNCLINE,ACTINDX,0 AS RCTRXSEQ FROM GL10101) B ON B.JRNENTRY =A.JRNENTRY  AND A1.ACTINDX = B.ACTINDX AND A.RCTRXSEQ = B.RCTRXSEQ WHERE B.JRNENTRY IS NULL   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Work Assignment Table'',''AA GL Work Header ID=''+LTRIM(STR(AAG10002.aaGLWorkHdrID))+SPACE(3)+''AA GL Work Distribution ID=''+LTRIM(STR(AAG10002.aaGLWorkDistID)),6,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG10000 WHERE aaGLWorkHdrID =LTRIM(STR(AAG10002.aaGLWorkHdrID)) ),-9999)  FROM AAG10002 WHERE NOT EXISTS (SELECT DISTINCT aaGLWorkDistID FROM AAG10001 WHERE AAG10001.aaGLWorkHdrID=AAG10002.aaGLWorkHdrID AND AAG10001.aaGLWorkDistID=AAG10002.aaGLWorkDistID)')   DELETE AAG10002 FROM AAG10002 WHERE NOT EXISTS (SELECT DISTINCT aaGLWorkDistID FROM AAG10001 WHERE AAG10001.aaGLWorkHdrID=AAG10002.aaGLWorkHdrID AND AAG10001.aaGLWorkDistID=AAG10002.aaGLWorkDistID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Work Code Table'',''AA GL Work Header ID=''+LTRIM(STR(AAG10003.aaGLWorkHdrID))+SPACE(3)+''AA GL Work Distribution ID=''+LTRIM(STR(AAG10003.aaGLWorkDistID)),6,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG10000 WHERE aaGLWorkHdrID =LTRIM(STR(AAG10003.aaGLWorkHdrID)) ),-9999)  FROM AAG10003 WHERE NOT EXISTS (SELECT DISTINCT aaGLWorkDistID FROM AAG10001 WHERE AAG10001.aaGLWorkHdrID=AAG10003.aaGLWorkHdrID AND AAG10001.aaGLWorkDistID=AAG10003.aaGLWorkDistID)')   DELETE AAG10003 FROM AAG10003 WHERE NOT EXISTS (SELECT DISTINCT aaGLWorkDistID FROM AAG10001 WHERE AAG10001.aaGLWorkHdrID=AAG10003.aaGLWorkHdrID AND AAG10001.aaGLWorkDistID=AAG10003.aaGLWorkDistID)  UPDATE AAG10001 SET aaGLWorkDistID=0-ABS(aaGLWorkDistID)   UPDATE AAG10002 SET aaGLWorkDistID=0-ABS(aaGLWorkDistID)   UPDATE AAG10003 SET aaGLWorkDistID=0-ABS(aaGLWorkDistID)  UPDATE AAG10003 SET aaGLWorkDistID = a.ID FROM (  SELECT RANK() OVER (PARTITION BY aaGLWorkHdrID ORDER BY SQNCLINE,DEX_ROW_ID ASC) ID,aaGLWorkHdrID,aaGLWorkDistID from AAG10001 group by aaGLWorkHdrID,SQNCLINE,aaGLWorkDistID,DEX_ROW_ID  ) a INNER JOIN AAG10001 A1 ON A1.aaGLWorkHdrID = a.aaGLWorkHdrID AND A1.aaGLWorkDistID = a.aaGLWorkDistID  INNER JOIN AAG10003 A3 ON A3.aaGLWorkHdrID = A1.aaGLWorkHdrID AND A3.aaGLWorkDistID = A1.aaGLWorkDistID    UPDATE AAG10002 SET aaGLWorkDistID = a.ID FROM (  SELECT RANK() OVER (PARTITION BY aaGLWorkHdrID ORDER BY SQNCLINE,DEX_ROW_ID ASC) ID,aaGLWorkHdrID,aaGLWorkDistID from AAG10001 group by aaGLWorkHdrID,SQNCLINE,aaGLWorkDistID,DEX_ROW_ID  ) a INNER JOIN AAG10001 A1 ON A1.aaGLWorkHdrID = a.aaGLWorkHdrID AND A1.aaGLWorkDistID = a.aaGLWorkDistID  INNER JOIN AAG10002 A2 ON A2.aaGLWorkHdrID = A1.aaGLWorkHdrID AND A2.aaGLWorkDistID = A1.aaGLWorkDistID    UPDATE AAG10001 SET aaGLWorkDistID = a.ID FROM (  SELECT RANK() OVER (PARTITION BY aaGLWorkHdrID ORDER BY SQNCLINE,DEX_ROW_ID ASC) ID,aaGLWorkHdrID,aaGLWorkDistID from AAG10001 group by aaGLWorkHdrID,SQNCLINE,aaGLWorkDistID,DEX_ROW_ID  ) a INNER JOIN AAG10001 A1 ON A1.aaGLWorkHdrID = a.aaGLWorkHdrID AND A1.aaGLWorkDistID = a.aaGLWorkDistID    BEGIN  EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Work Distribution Table'',''AA GL Work Header ID=''+LTRIM(STR(AAG10001.aaGLWorkHdrID ))+SPACE(3)+''AA GL Work Distribution ID=''+LTRIM(STR(AAG10001.aaGLWorkDistID )) ,4,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG10000 WHERE aaGLWorkHdrID =LTRIM(STR(AAG10001.aaGLWorkHdrID)) ),0)  FROM AAG10001 WHERE AA_CL_Status = 0 AND aaGLWorkHdrID IN (SELECT DISTINCT aaGLWorkHdrID FROM AAG10000) AND   aaGLWorkDistID >  (SELECT COUNT(B.JRNENTRY) FROM AAG10001 A1 INNER JOIN AAG10000 A ON A1.aaGLWorkHdrID=A.aaGLWorkHdrID   RIGHT JOIN (SELECT JRNENTRY,SQNCLINE,ACTINDX FROM GL10001 UNION ALL SELECT JRNENTRY,SQNCLINE,ACTINDX FROM GL10101) B   ON B.JRNENTRY =A.JRNENTRY AND A1.ACTINDX = B.ACTINDX WHERE B.JRNENTRY IS NOT NULL AND  A.aaGLWorkHdrID= AAG10001.aaGLWorkHdrID)')   Delete AAG10001 where AAG10001.AA_CL_Status = 0 AND  aaGLWorkHdrID in (select Distinct aaGLWorkHdrID from AAG10000) and   aaGLWorkDistID >  (select count(B.JRNENTRY) from AAG10001 A1 inner join AAG10000 A on A1.aaGLWorkHdrID=A.aaGLWorkHdrID   right join (select JRNENTRY,SQNCLINE,ACTINDX from GL10001 union all select JRNENTRY,SQNCLINE,ACTINDX from GL10101) B   on B.JRNENTRY =A.JRNENTRY and A1.ACTINDX = B.ACTINDX where B.JRNENTRY is not null and  A.aaGLWorkHdrID= AAG10001.aaGLWorkHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Work Assignment Table'',''AA GL Work Header ID=''+LTRIM(STR(AAG10002.aaGLWorkHdrID))+SPACE(3)+''AA GL Work Distribution ID=''+LTRIM(STR(AAG10002.aaGLWorkDistID)),6,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG10000 WHERE aaGLWorkHdrID =LTRIM(STR(AAG10002.aaGLWorkHdrID)) ),-9999)  FROM AAG10002 WHERE NOT EXISTS (SELECT DISTINCT aaGLWorkDistID FROM AAG10001 WHERE AAG10001.aaGLWorkHdrID=AAG10002.aaGLWorkHdrID AND AAG10001.aaGLWorkDistID=AAG10002.aaGLWorkDistID)')   DELETE AAG10002 FROM AAG10002 WHERE NOT EXISTS (SELECT DISTINCT aaGLWorkDistID FROM AAG10001 WHERE AAG10001.aaGLWorkHdrID=AAG10002.aaGLWorkHdrID AND AAG10001.aaGLWorkDistID=AAG10002.aaGLWorkDistID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Work Code Table'',''AA GL Work Header ID=''+LTRIM(STR(AAG10003.aaGLWorkHdrID))+SPACE(3)+''AA GL Work Distribution ID=''+LTRIM(STR(AAG10003.aaGLWorkDistID)),6,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG10000 WHERE aaGLWorkHdrID =LTRIM(STR(AAG10003.aaGLWorkHdrID)) ),-9999)  FROM AAG10003 WHERE NOT EXISTS (SELECT DISTINCT aaGLWorkDistID FROM AAG10001 WHERE AAG10001.aaGLWorkHdrID=AAG10003.aaGLWorkHdrID AND AAG10001.aaGLWorkDistID=AAG10003.aaGLWorkDistID)')   DELETE AAG10003 FROM AAG10003 WHERE NOT EXISTS (SELECT DISTINCT aaGLWorkDistID FROM AAG10001 WHERE AAG10001.aaGLWorkHdrID=AAG10003.aaGLWorkHdrID AND AAG10001.aaGLWorkDistID=AAG10003.aaGLWorkDistID)  END  END  IF @@ERROR <> 0  BEGIN  ROLLBACK TRANSACTION  END  ELSE  BEGIN  COMMIT TRANSACTION  END  SET NOCOUNT OFF End    
GO
GRANT EXECUTE ON  [dbo].[aagGenericGLWorkunmatched] TO [DYNGRP]
GO
