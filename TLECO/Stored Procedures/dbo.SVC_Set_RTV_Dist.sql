SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 Create Procedure [dbo].[SVC_Set_RTV_Dist] (@RTVNumber char(15),@RTVLine numeric(19,5),  @LineType as char(3),@DistType as smallint,  @Price numeric (19,2),@OrigPrice numeric (19,2),  @Cost numeric (19,2),@OrigCost numeric (19,2)) As declare @SEQNUMBR integer declare @AccountIndex integer declare @oldAccountIndex1 integer declare @oldAccountIndex2 integer declare @oldAccountIndex4 integer declare @oldAccountIndex5 integer declare @PMPurchaseIndex integer declare @PurchaseIndex integer declare @PayableIndex integer declare @CostIndex integer declare @InvIndex integer declare @ReimburseIndex integer declare @CurrencyIndex smallint declare @Vendor char(15) declare @Item char(31),@ReturnItem char(31) declare @QtyInBase numeric(19,5),@UOM char(10) declare @RTVType char(10) declare @RTVRouting smallint declare @RTVCost numeric (19,2),@OrigRTVCost numeric (19,2) declare @ReimbursePrice numeric (19,2),@OrigReimbursePrice numeric (19,2) declare @Qty numeric(19,5) declare @PostDate datetime declare @FromRMA tinyint declare @CUSTOWN smallint declare @RTV_Status smallint declare @I_sRateCalcMethod  smallint ,           @I_sViewMode   smallint,            @I_nExchangeRate  numeric(15,7),       @I_nDenomExchangeRate numeric(15,7),       @I_sMCTrxState   smallint,            @I_sDecimalPlaces  smallint,            @O_iErrorState          int  select @Item = ITEMNMBR, @Vendor = VENDORID, @RTVType = RTV_Type, @RTV_Status = RTV_Status,  @CUSTOWN = CUSTOWN, @UOM = UOFM, @Qty = QUANTITY  from SVC05601 where RTV_Number = @RTVNumber  and RTV_Line = @RTVLine select  @CurrencyIndex = CURRNIDX from SVC05600 where RTV_Number = @RTVNumber  exec SVC_Get_QtyInBase @Item,@UOM,1,@QtyInBase OUTPUT   if @DistType = 0   delete from SVC05630 where RTV_Number = @RTVNumber and RTV_Line = @RTVLine and POSTED = 0 else  delete from SVC05630  where RTV_Number = @RTVNumber and RTV_Line = @RTVLine and POSTED = 0 and LINITMTYP = @LineType  select @RTVRouting = RTV_Routing, @PurchaseIndex = SVC_Purchase_Index,  @CostIndex = SVC_Cost_Index, @ReimburseIndex = SVC_Reimbursement_Index  from SVC05003 where RTV_Type = @RTVType select @PMPurchaseIndex = PMPRCHIX, @PayableIndex = PMAPINDX from PM00200 where @Vendor = VENDORID  if @PMPurchaseIndex = 0 or @PMPurchaseIndex is null  select @PMPurchaseIndex = ACTINDX from SY01100 where SERIES=4 and SEQNUMBR = 600 if @PayableIndex = 0 or @PayableIndex is null  select @PayableIndex = ACTINDX from SY01100 where SERIES=4 and SEQNUMBR = 200  select @InvIndex = IVIVINDX, @Cost = CURRCOST from IV00101 where ITEMNMBR = @Item if @InvIndex = 0 or @InvIndex is null  select @InvIndex = ACTINDX from SY01100 where SERIES=3 and SEQNUMBR = 900  if @PurchaseIndex = 0 or @PurchaseIndex is null  select @PurchaseIndex = @PMPurchaseIndex  if @CostIndex = 0 or @CostIndex is null  select @CostIndex = @PMPurchaseIndex  if @ReimburseIndex = 0 or @ReimburseIndex is null  select @ReimburseIndex = @PMPurchaseIndex exec smGetMinDate @PostDate output  if @LineType = '' or @LineType = 'I' begin  if @RTVRouting < 3 and @CUSTOWN = 0 and @RTV_Status < 3   BEGIN  select @Cost = @Cost * @QtyInBase * @Qty  select @I_sRateCalcMethod = RATECALC,   @I_sViewMode = 3,            @I_nExchangeRate = XCHGRATE,   @I_nDenomExchangeRate = DENXRATE,   @I_sDecimalPlaces = DECPLACS,   @I_sMCTrxState = MCTRXSTT   from SVC05600 where RTV_Number = @RTVNumber  exec SVC_Convert_Amount @I_sRateCalcMethod, @I_sViewMode,@I_nExchangeRate,  @I_nDenomExchangeRate,@I_sMCTrxState,@I_sDecimalPlaces,  @Cost,@OrigCost OUTPUT, @O_iErrorState OUTPUT  exec SVC_Dist_Get_SEQ_RTV @RTVNumber, @RTVLine, 4,@SEQNUMBR output  insert SVC05630  select   @RTVNumber,  @RTVLine,  'I',  @SEQNUMBR,  4,   '',  isnull(@InvIndex,0),  0,0,    @Cost,@OrigCost,   isnull(@CurrencyIndex,0),  '',  0,  @PostDate  exec SVC_Dist_Get_SEQ_RTV @RTVNumber, @RTVLine, 5,@SEQNUMBR output  insert SVC05630  select   @RTVNumber,  @RTVLine,  'I',  @SEQNUMBR,  5,   '',  isnull(@PurchaseIndex,0),  @Cost,@OrigCost,    0,0,   isnull(@CurrencyIndex,0),  '',  0,  @PostDate  exec SVC_Dist_Get_SEQ_RTV @RTVNumber, @RTVLine,6,@SEQNUMBR output  insert SVC05630  select   @RTVNumber,  @RTVLine,  'I',  @SEQNUMBR,  6,   '',  isnull(@PurchaseIndex,0),  0,0,    @Cost,@OrigCost,   isnull(@CurrencyIndex,0),  '',  0,  @PostDate  exec SVC_Dist_Get_SEQ_RTV @RTVNumber, @RTVLine,7,@SEQNUMBR output  insert SVC05630  select   @RTVNumber,  @RTVLine,  'I',  @SEQNUMBR,  7,   '',  isnull(@PayableIndex,0),  @Cost,@OrigCost,    0,0,   isnull(@CurrencyIndex,0),  '',  0,  @PostDate  END end  if @LineType = '' or @LineType = 'C' begin  select @RTVCost = (Part_Cost + Labor_Cost + Expense_Cost + Travel_Cost)   from SVC05601 where RTV_Number = @RTVNumber and RTV_Line = @RTVLine  select @OrigRTVCost = (Originating_Part_Cost + Originating_Labor_Cost + Originating_Expense_Cost + Originating_Travel_Cost)  from SVC05601 where RTV_Number = @RTVNumber and RTV_Line = @RTVLine  if @RTVCost > 0   BEGIN  exec SVC_Dist_Get_SEQ_RTV @RTVNumber, @RTVLine,6,@SEQNUMBR output  insert SVC05630  select   @RTVNumber,  @RTVLine,  'C',  @SEQNUMBR,  6,   '',  isnull(@CostIndex,0),  @RTVCost,@OrigRTVCost,    0,0,   isnull(@CurrencyIndex,0),  '',  0,  @PostDate  exec SVC_Dist_Get_SEQ_RTV @RTVNumber, @RTVLine,7,@SEQNUMBR output  insert SVC05630  select   @RTVNumber,  @RTVLine,  'C',  @SEQNUMBR,  7,   '',  isnull(@PayableIndex,0),  0,0,    @RTVCost,@OrigRTVCost,   isnull(@CurrencyIndex,0),  '',  0,  @PostDate  END end  if @LineType = '' or @LineType = 'R' begin  select @ReimbursePrice = (Part_Price + Labor_Price + Expense_Price + Travel_Price)   from SVC05601 where RTV_Number = @RTVNumber and RTV_Line = @RTVLine  select @OrigReimbursePrice = (Originating_Part_Price + Originating_Labor_Price + Originating_ExpensePrice + Originating_Travel_Price)  from SVC05601 where RTV_Number = @RTVNumber and RTV_Line = @RTVLine  if @ReimbursePrice > 0   BEGIN  exec SVC_Dist_Get_SEQ_RTV @RTVNumber, @RTVLine,6,@SEQNUMBR output  insert SVC05630  select   @RTVNumber,  @RTVLine,  'R',  @SEQNUMBR,  6,   '',  isnull(@ReimburseIndex,0),  0,0,    @ReimbursePrice,@OrigReimbursePrice,   isnull(@CurrencyIndex,0),  '',  0,  @PostDate  exec SVC_Dist_Get_SEQ_RTV @RTVNumber, @RTVLine,7,@SEQNUMBR output  insert SVC05630  select   @RTVNumber,  @RTVLine,  'R',  @SEQNUMBR,  7,   '',  isnull(@PayableIndex,0),  @ReimbursePrice,@OrigReimbursePrice,    0,0,   isnull(@CurrencyIndex,0),  '',  0,  @PostDate  END end  return     
GO
GRANT EXECUTE ON  [dbo].[SVC_Set_RTV_Dist] TO [DYNGRP]
GO
