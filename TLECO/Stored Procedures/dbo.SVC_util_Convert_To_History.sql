SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 Create Procedure [dbo].[SVC_util_Convert_To_History] As declare @TransferNumber char(15) declare @NumberOfRecords int declare @CONSTS smallint,@ContractNumber char(11) declare @SVCStatus char(3) declare @DOCUMENTAMOUNT numeric(19,5) declare @ORGDOCUMENTAMOUNT numeric(19,5) declare @DOCUMENTAMOUNT2 numeric(19,5) declare @ORGDOCUMENTAMOUNT2 numeric(19,5) declare @Version smallint declare @UserID char(21)  select @NumberOfRecords = 0 declare ConvertTransfer cursor for select ORDDOCID from SVC00700 where STATUS = 6 open ConvertTransfer  FETCH NEXT FROM ConvertTransfer INTO @TransferNumber  while @@FETCH_STATUS = 0  BEGIN  exec  SVC_Transfer_TransferToHistory @TransferNumber  select @NumberOfRecords = @NumberOfRecords + 1  FETCH NEXT FROM ConvertTransfer INTO @TransferNumber  END deallocate ConvertTransfer  select @SVCStatus = Invoiced_Status from SVC00998 select @UserID = SYSTEM_USER declare ConvertContract cursor for select CONTNBR,CONSTS from SVC00600 where CONSTS = 2 or CONSTS = 4 open ConvertContract  FETCH NEXT FROM ConvertContract INTO @ContractNumber,@CONSTS  while @@FETCH_STATUS = 0  BEGIN  select @DOCUMENTAMOUNT = sum(LABSTOTCST*(100-LABPCT)/100)+sum(PARSTOTCST*(100-PARTPCT)/100) +  sum(MISSTOTCST*(100-MISCPCT)/100),  @ORGDOCUMENTAMOUNT = sum(ORIGLABSUBTOTCOST*(100-LABPCT)/100)+sum(ORIGPARSTOTCST*(100-PARTPCT)/100) +  sum(ORIGMISSTOTCST*(100-MISCPCT)/100)  from SVC00200 where CONTNBR = @ContractNumber and SRVSTAT = @SVCStatus  select @DOCUMENTAMOUNT2 =  sum(LABSTOTCST*(100-LABPCT)/100)+  sum(PARSTOTCST*(100-PARTPCT)/100) + sum(MISSTOTCST*(100-MISCPCT)/100),  @ORGDOCUMENTAMOUNT2 = sum(ORIGLABSUBTOTCOST*(100-LABPCT)/100)+  sum(ORIGPARSTOTCST*(100-PARTPCT)/100) + sum(ORIGMISSTOTCST*(100-MISCPCT)/100)  from SVC30200 where CONTNBR = @ContractNumber and SRVSTAT = @SVCStatus  select @DOCUMENTAMOUNT = isnull(@DOCUMENTAMOUNT,0) + isnull(@DOCUMENTAMOUNT2,0)  select @ORGDOCUMENTAMOUNT = isnull(@ORGDOCUMENTAMOUNT,0) + isnull(@ORGDOCUMENTAMOUNT2,0)  if @DOCUMENTAMOUNT > 0   begin   update SVC00600 set SVC_Invoiced_Cost = @DOCUMENTAMOUNT,Orig_SVC_Invoiced_Cost = @ORGDOCUMENTAMOUNT  where CONTNBR = @ContractNumber and CONSTS = @CONSTS  end  if @CONSTS = 4  Begin  exec SVC_Create_Contract_Audit @CONSTS, @ContractNumber,0,'','','',@UserID,'Move To History via Upgrade Util'  exec  SVC_Transfer_ContractToHistory 4,@ContractNumber,@Version output,0  update SVC30600 set CONSTS = 2 where CONTNBR = @ContractNumber and CONSTS = 4 and SVC_Contract_Version = @Version  update SVC30601 set CONSTS = 2 where CONTNBR = @ContractNumber and CONSTS = 4 and SVC_Contract_Version = @Version  update SVC30603 set CONSTS = 2 where CONTNBR = @ContractNumber and CONSTS = 4 and SVC_Contract_Version = @Version  update SVC30604 set CONSTS = 2 where CONTNBR = @ContractNumber and CONSTS = 4 and SVC_Contract_Version = @Version  update SVC30605 set CONSTS = 2 where CONTNBR = @ContractNumber and CONSTS = 4 and SVC_Contract_Version = @Version  update SVC30606 set CONSTS = 2 where CONTNBR = @ContractNumber and CONSTS = 4 and SVC_Contract_Version = @Version  update SVC30607 set CONSTS = 2 where CONTNBR = @ContractNumber and CONSTS = 4 and SVC_Contract_Version = @Version  update SVC30608 set CONSTS = 2 where CONTNBR = @ContractNumber and CONSTS = 4 and SVC_Contract_Version = @Version  update SVC30609 set CONSTS = 2 where CONTNBR = @ContractNumber and CONSTS = 4 and SVC_Contract_Version = @Version  update SVC30610 set CONSTS = 2 where CONTNBR = @ContractNumber and CONSTS = 4 and SVC_Contract_Version = @Version  update SVC30620 set CONSTS = 2 where CONTNBR = @ContractNumber and CONSTS = 4 and SVC_Contract_Version = @Version  update SVC30652 set CONSTS = 2 where CONTNBR = @ContractNumber and CONSTS = 4 and SVC_Contract_Version = @Version  update SVC30655 set CONSTS = 2 where CONTNBR = @ContractNumber and CONSTS = 4 and SVC_Contract_Version = @Version  End  FETCH NEXT FROM ConvertContract INTO @ContractNumber,@CONSTS  END deallocate ConvertContract return     
GO
GRANT EXECUTE ON  [dbo].[SVC_util_Convert_To_History] TO [DYNGRP]
GO
