SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create        PROCEDURE [dbo].[aagRenumberAADists]  @iHdrID int,  @iDistID Int,  @iISDelete tinyint,   @iSeqNum bigint,   @oStatus smallint = NULL out AS  declare @transaction tinyint,  @retCode int,  @dbName varchar(32),  @companyID smallint,  @companyStatus smallint,  @DistID int,  @SeqNum bigint,  @NextDistID int,  @TempDistID int,  @DistIDINSPos int   select  @transaction = 0,  @retCode = 0,  @dbName = '',  @companyID = 0,  @companyStatus = 0,  @DistID = 0,  @SeqNum = 0  if (@iHdrID is NULL) begin select @oStatus = 35000 return end  if (@iHdrID = 0) begin select @oStatus = 35001 return end  select @dbName = db_name() exec @retCode = DYNAMICS.dbo.aagGetCompanyStatus @dbName, @companyID out, @companyStatus out, @oStatus out if ((@retCode <> 0) or (@oStatus <> 0)) return @retCode  if (@@trancount = 0)  begin  select @transaction = 1  begin transaction  end  IF @iISDelete = 1   Begin    Update AAG20003   Set aaSubLedgerDistID = aaSubLedgerDistID - 1   Where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID > @iDistID   and aaSubLedgerDistID >=0   Update AAG20002   Set aaSubLedgerDistID = aaSubLedgerDistID - 1   Where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID > @iDistID   and aaSubLedgerDistID >=0  Update AAG20001   Set aaSubLedgerDistID = aaSubLedgerDistID - 1   Where aaSubLedgerHdrID = @iHdrID And aaSubLedgerDistID > @iDistID   and aaSubLedgerDistID >=0   if (@transaction = 1)  and @@error  = 0   Begin   commit transaction   return 0  End  Else  Begin  Rollback   Return   End End Else  Begin    Select @DistIDINSPos = Max(aaSubLedgerDistID)   From AAG20001   Where aaSubLedgerHdrID = @iHdrID and  SEQNUMBR < @iSeqNum  and aaSubLedgerDistID >=0   Update AAG20001   Set aaSubLedgerDistID = aaSubLedgerDistID + 1   Where aaSubLedgerHdrID = @iHdrID and  aaSubLedgerDistID > @DistIDINSPos  and aaSubLedgerDistID >=0   IF @@error <> 0  goto errlbl   Update AAG20002   Set aaSubLedgerDistID = aaSubLedgerDistID + 1   Where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID > @DistIDINSPos   and aaSubLedgerDistID >=0   IF @@error <> 0  goto errlbl  Update AAG20003   Set aaSubLedgerDistID = aaSubLedgerDistID + 1   Where aaSubLedgerHdrID = @iHdrID And aaSubLedgerDistID > @DistIDINSPos   and aaSubLedgerDistID >=0   IF @@error <> 0  goto errlbl   Update AAG20001   Set aaSubLedgerDistID = @DistIDINSPos + 1   Where aaSubLedgerHdrID = @iHdrID and  aaSubLedgerDistID = @iDistID + 1   and aaSubLedgerDistID >=0   IF @@error <> 0  goto errlbl   Update AAG20002   Set aaSubLedgerDistID = @DistIDINSPos + 1   Where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID = @iDistID + 1  and aaSubLedgerDistID >=0   IF @@error <> 0  goto errlbl  Update AAG20003   Set aaSubLedgerDistID = @DistIDINSPos  + 1   Where aaSubLedgerHdrID = @iHdrID And aaSubLedgerDistID = @iDistID + 1   and aaSubLedgerDistID >=0  IF @@error <> 0  goto errlbl End  errlbl:  if (@transaction = 1)  and @@error  = 0   Begin   commit transaction   return 0  End  Else  Rollback    
GO
GRANT EXECUTE ON  [dbo].[aagRenumberAADists] TO [DYNGRP]
GO
