SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[smSYCompanyRoutinesMoveIndex]  @I_sSeries smallint = NULL,  @I_sEndType smallint = NULL,  @I_sOldIndex smallint = NULL,  @I_sNewIndex smallint = NULL,  @I_iSQLSessionID int  = NULL,  @O_iErrorState int  = NULL output as  declare  @tTransaction tinyint,   @iNumberOfRows int    if @I_sSeries is NULL or  @I_sEndType is NULL or  @I_sOldIndex is NULL or  @I_sNewIndex is NULL or  @I_iSQLSessionID is NULL begin  select @O_iErrorState = 20382  return end else begin  select @O_iErrorState = 0,  @iNumberOfRows = 0 end  if @I_sOldIndex = @I_sNewIndex  return  if @I_sOldIndex < 0 or @I_sNewIndex < 0 begin  select @O_iErrorState = 20383  return end  if @I_sNewIndex > (select   max(INDEX1)  from  SY02500  where  ENDTYPE = @I_sEndType  and SERIES = @I_sSeries) begin  select @O_iErrorState = 20394  return end  if not exists (select   1  from  SY02500  where  ENDTYPE = @I_sEndType  and SERIES = @I_sSeries  and INDEX1 = @I_sOldIndex) begin  select @O_iErrorState = 20395  return end  if @@trancount = 0 begin  select @tTransaction = 1  begin transaction end  if exists(select  1  from  SY02500  where  ENDTYPE = @I_sEndType  and SERIES = @I_sSeries  and INDEX1 = -1)  begin  if @tTransaction = 1  rollback transaction   select @O_iErrorState = 20384  return end else begin  delete   SY02500  where  ENDTYPE = @I_sEndType  and SERIES = @I_sSeries  and INDEX1 = -1 end  update  SY02500 set   INDEX1 = -1 where  ENDTYPE = @I_sEndType  and SERIES = @I_sSeries  and INDEX1 = @I_sOldIndex  if @@rowcount <> 1  begin  if @tTransaction = 1  rollback transaction   select @O_iErrorState = 20385  return end  if @I_sOldIndex > @I_sNewIndex begin   select   @iNumberOfRows = count(ENDTYPE)  from  SY02500  where  ENDTYPE = @I_sEndType  and SERIES = @I_sSeries  and INDEX1 >= @I_sNewIndex  and INDEX1 <= @I_sOldIndex   if @iNumberOfRows > 0  begin  update  SY02500  set  INDEX1 = INDEX1 + 1  where  ENDTYPE = @I_sEndType  and SERIES = @I_sSeries  and INDEX1 >= @I_sNewIndex  and INDEX1 <= @I_sOldIndex   if @@rowcount <> @iNumberOfRows  begin  if @tTransaction = 1  rollback transaction  select @O_iErrorState = 20386  return  end  end end else  begin   select   @iNumberOfRows = count(ENDTYPE)  from  SY02500  where  ENDTYPE = @I_sEndType  and SERIES = @I_sSeries  and INDEX1 <= @I_sNewIndex  and INDEX1 >= @I_sOldIndex   if @iNumberOfRows > 0  begin  update  SY02500  set  INDEX1 = INDEX1 - 1  where  ENDTYPE = @I_sEndType  and SERIES = @I_sSeries  and INDEX1 <= @I_sNewIndex  and INDEX1 >= @I_sOldIndex   if @@rowcount <> @iNumberOfRows  begin  if @tTransaction = 1  rollback transaction  select @O_iErrorState = 20386  return  end  end end  update  SY02500 set   INDEX1 = @I_sNewIndex where  ENDTYPE = @I_sEndType  and SERIES = @I_sSeries  and INDEX1 = -1  if @@rowcount <> 1  begin  if @tTransaction = 1  rollback transaction   select @O_iErrorState = 20387  return end  if @tTransaction = 1  commit transaction  return    
GO
GRANT EXECUTE ON  [dbo].[smSYCompanyRoutinesMoveIndex] TO [DYNGRP]
GO
