SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 Create PROCEDURE [dbo].[aagAdjustBudgetOnFiscalPeriodChange] (  @FiscalYear INT,   @nStartDate varchar(10),   @nEndDate varchar(10)  ) AS  BEGIN  Declare @nBudgetID INT,   @nBudTreeID INT  DECLARE BudgetTree cursor fast_forward for   select aaBudgetID, aaBudgetTreeID from AAG00903 where AAG00903.YEAR1 = @FiscalYear and Based_On = 1  Open BudgetTree  Fetch next from BudgetTree into @nBudgetID, @nBudTreeID  While (@@fetch_status <> -1)  Begin  DECLARE @TempPeriodBalances TABLE  (  aaBudgetID INTEGER,   aaCodeSequence INTEGER,   PERIODDT DATETIME,   aaFiscalPeriod INTEGER,   aaActualPriliminary INTEGER,   Balance NUMERIC(19, 5),   QUANTITY NUMERIC(19, 5),  YEAR1 SMALLINT  )    delete from @TempPeriodBalances   INSERT INTO @TempPeriodBalances  SELECT aaBudgetID, aaCodeSequence, PERIODDT, aaFiscalPeriod, aaActualPriliminary, Balance, QUANTITY, YEAR1  FROM AAG00904  WHERE aaBudgetID = @nBudgetID   IF @@ERROR <> 0  begin  close BudgetTree  deallocate BudgetTree  RETURN @@ERROR  end   DELETE FROM AAG00904 WHERE aaBudgetID = @nBudgetID   EXEC aagCreateInitialBudgetEntry  @nStartDate,   @nEndDate,   @nBudgetID,   @nBudTreeID   UPDATE AAG00904  SET aaActualPriliminary = B.aaActualPriliminary, Balance = B.Balance, QUANTITY = B.QUANTITY  FROM AAG00904 A, @TempPeriodBalances B  WHERE  A.aaBudgetID = @nBudgetID AND  A.aaBudgetID = B.aaBudgetID AND  A.aaCodeSequence = B.aaCodeSequence AND  A.aaFiscalPeriod = B.aaFiscalPeriod    IF @@ERROR <> 0  begin  close BudgetTree  deallocate BudgetTree  RETURN @@ERROR  end   IF EXISTS(SELECT top 1 aaBudgetID FROM AAG00905 WHERE aaBudgetID = @nBudgetID)  BEGIN  DECLARE @TempPeriodAccountBalances TABLE  (  aaBudgetID INTEGER,   aaCodeSequence INTEGER,   ACTINDX INTEGER,   PERIODDT DATETIME,   aaFiscalPeriod INTEGER,   aaActualPriliminary INTEGER,   aaRange INTEGER,   Balance NUMERIC(19, 5),  YEAR1 SMALLINT  )  delete from @TempPeriodAccountBalances  INSERT INTO @TempPeriodAccountBalances  SELECT aaBudgetID, aaCodeSequence, ACTINDX, PERIODDT, aaFiscalPeriod, aaActualPriliminary, aaRange, Balance,YEAR1  FROM AAG00905  WHERE aaBudgetID = @nBudgetID   IF @@ERROR <> 0  begin  close BudgetTree  deallocate BudgetTree  RETURN @@ERROR  end   DELETE FROM AAG00905 WHERE aaBudgetID = @nBudgetID   INSERT INTO AAG00905  SELECT   B.aaBudgetID,   B.aaCodeSequence,   B.ACTINDX,   A.PERIODDT,   A.aaFiscalPeriod,   B.aaActualPriliminary,   B.aaRange,   B.Balance,  B.YEAR1  FROM  AAG00904 A JOIN @TempPeriodAccountBalances B ON  A.aaBudgetID = B.aaBudgetID AND  A.aaCodeSequence = B.aaCodeSequence AND  A.aaFiscalPeriod = B.aaFiscalPeriod  WHERE  A.aaCodeSequence = B.aaCodeSequence AND  A.aaBudgetID = B.aaBudgetID AND  B.aaBudgetID = @nBudgetID   IF @@ERROR <> 0  begin  close BudgetTree  deallocate BudgetTree  RETURN @@ERROR  end   INSERT INTO AAG00905  SELECT DISTINCT B.aaBudgetID,   B.aaCodeSequence,   B.ACTINDX,   A.PERIODDT,   A.aaFiscalPeriod,   B.aaActualPriliminary,   B.aaRange,   0 AS Balance,  (SELECT TOP 1 aaFiscalYear FROM AAG00500 WHERE AAG00500.DATE1=ISNULL((SELECT  top 1 DATE1 from AAG00500 WHERE DATE1 =A.PERIODDT),DATEADD(MONTH, 1, A.PERIODDT))) AS YEAR1   FROM AAG00904 A, AAG00905 B  WHERE   A.PERIODDT NOT IN (SELECT PERIODDT FROM AAG00905 WHERE aaBudgetID = @nBudgetID and aaCodeSequence = 1) AND  A.aaBudgetID = B.aaBudgetID AND  A.aaCodeSequence = B.aaCodeSequence and   A.aaBudgetID = @nBudgetID   IF @@ERROR <> 0  begin  close BudgetTree  deallocate BudgetTree  RETURN @@ERROR  end  END  Fetch next from BudgetTree into @nBudgetID, @nBudTreeID  END  close BudgetTree  deallocate BudgetTree END    
GO
GRANT EXECUTE ON  [dbo].[aagAdjustBudgetOnFiscalPeriodChange] TO [DYNGRP]
GO
