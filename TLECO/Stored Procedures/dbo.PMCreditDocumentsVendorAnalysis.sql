SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[PMCreditDocumentsVendorAnalysis] (@IN_sVendorID varchar(60),@I_Orderby Integer,@IN_TypeID smallint,@IN_DocumentNo varchar(60),@IN_CreditDocTbl varchar(10), @I_DocType varchar(10)) AS  BEGIN   DECLARE @DocFilterStr VARCHAR(500)   DECLARE @ColFilterStr VARCHAR(8000)  DECLARE @OrderbyStr VARCHAR(7)   IF @I_Orderby = 0   SET @OrderbyStr = ' DESC '  ELSE   SET @OrderbyStr = ' ASC '   IF @I_DocType = ''  SET @I_DocType = '0'   EXEC('DELETE FROM ' + @IN_CreditDocTbl)   exec POPVendAnalysisBuildQuery 4,6,@ColFilterStr out  IF @IN_TypeID = 1  and @IN_DocumentNo <> ''  SELECT @DocFilterStr = 'AND A.PORDNMBR = ' + @IN_DocumentNo + ' '  ELSE IF @IN_TypeID = 2  and @IN_DocumentNo <> ''   SELECT @DocFilterStr = 'AND B.POPRCTNM IN (SELECT POPIVCNO FROM POP10600 WHERE POPRCTNM = '+ @IN_DocumentNo +') '  ELSE IF @IN_TypeID = 3  and @IN_DocumentNo <> ''   SELECT @DocFilterStr = 'AND A.VCHRNMBR IN (SELECT VCHRNMBR FROM PM30300 WHERE APTVCHNM= '+ @IN_DocumentNo +') '  ELSE IF @IN_TypeID = 4  and @IN_DocumentNo <> ''   SELECT @DocFilterStr = ' AND A.VCHRNMBR IN (SELECT APTVCHNM FROM PM10200 WHERE VCHRNMBR = '+ @IN_DocumentNo +' UNION SELECT APTVCHNM FROM PM30300 WHERE VCHRNMBR = '+ @IN_DocumentNo +' ) '  ELSE IF @IN_TypeID = 5  and @IN_DocumentNo <> ''   SELECT @DocFilterStr = 'AND A.VCHRNMBR IN (SELECT VCHRNMBR FROM PM30300 WHERE APTVCHNM = '+ @IN_DocumentNo +') '  EXEC('  INSERT INTO ' + @IN_CreditDocTbl + ' (INDXLONG,VENDORID,VCHNUMWK,DOCTYPE,DOCAMNT,DOCDATE,DOCNUMBR,CURNCYID, VOIDED, DINVPDOF,TEN99AMNT, APPLDAMT, DCSTATUS, TRXSORCE, CNTRLTYP)  SELECT TOP 100 ROW_NUMBER() OVER (ORDER BY R.DOCDATE  ' + @OrderbyStr + ' ) INDEX1 ,R.*   FROM(   SELECT DISTINCT A.VENDORID,A.VCHRNMBR, A.DOCTYPE,A.DOCAMNT,A.DOCDATE,A.DOCNUMBR,A.CURNCYID, A.VOIDED  , A.VOIDDATE,A.UN1099AM, ISNULL((SELECT SUM(APPLDAMT) FROM PM10200 WHERE  PM10200.APTVCHNM = A.VCHRNMBR AND A.DOCTYPE = PM10200.APTODCTY GROUP BY   APTVCHNM, APTODCTY),0) APPLDAMT, PM00400.DCSTATUS, PM00400.TRXSORCE, PM00400.CNTRLTYP FROM  (  SELECT PM20000.VENDORID,PM20000.VCHRNMBR, PM20000.DOCTYPE,PM20000.DOCDATE,DOCNUMBR,DOCAMNT,  PM20000.CURNCYID, PM20000.VOIDED, DINVPDOF VOIDDATE,UN1099AM, 0 APPLDAMT,PORDNMBR,T.VCHRNMBR CNTRLNUM  FROM PM20000 LEFT OUTER JOIN (SELECT VCHRNMBR, APTVCHNM AS CNTRLNUM FROM PM30300)T ON T.CNTRLNUM = PM20000.VCHRNMBR WHERE PM20000.VENDORID = ' + @IN_sVendorID + '   UNION  SELECT PM10000.VENDORID, PM10000.VCHRNMBR,PM10000.DOCTYPE,PM10000.DOCDATE,DOCNUMBR,DOCAMNT,  PM10000.CURNCYID,0 VOIDED,'''' VOIDDATE,UN1099AM,APPLDAMT,PORDNMBR,T.VCHRNMBR CNTRLNUM  FROM PM10000 LEFT OUTER JOIN (SELECT VCHRNMBR, APTVCHNM AS CNTRLNUM FROM PM30300)T ON T.CNTRLNUM = PM10000.VCHRNMBR WHERE PM10000.VENDORID = ' + @IN_sVendorID + '  UNION  SELECT PM30200.VENDORID,PM30200.VCHRNMBR, PM30200.DOCTYPE,PM30200.DOCDATE,DOCNUMBR,DOCAMNT,  PM30200.CURNCYID,PM30200.VOIDED, (CASE WHEN PM30200.VOIDED = 1 THEN DINVPDOF ELSE PM30200.VOIDPDATE END) AS VOIDDATE,UN1099AM, 0 APPLDAMT,PORDNMBR,T.VCHRNMBR CNTRLNUM  FROM PM30200 LEFT OUTER JOIN (SELECT VCHRNMBR, APTVCHNM AS CNTRLNUM FROM PM30300)T ON T.CNTRLNUM = PM30200.VCHRNMBR WHERE PM30200.VENDORID = ' + @IN_sVendorID + '   )A  INNER JOIN PM00400  ON PM00400.CNTRLNUM = A.VCHRNMBR AND A.DOCTYPE = PM00400.DOCTYPE AND A.DOCTYPE IN ('+ @I_DocType +')  LEFT JOIN POP30300 B ON A.VCHRNMBR = B.VCHRNMBR   WHERE A.VENDORID = A.VENDORID ' +  @ColFilterStr + ' ' +  @DocFilterStr + '   )R')  END   
GO
GRANT EXECUTE ON  [dbo].[PMCreditDocumentsVendorAnalysis] TO [DYNGRP]
GO
