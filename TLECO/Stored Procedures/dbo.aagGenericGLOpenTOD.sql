SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
 CREATE  PROCEDURE [dbo].[aagGenericGLOpenTOD] @USERID CHAR(15), @TBName varchar(25), @Preview SMALLINT, @O_SQL_Error_State int = NULL  output AS  BEGIN  SET NOCOUNT ON  SET TRANSACTION ISOLATION LEVEL READ COMMITTED  BEGIN TRANSACTION  Declare @CMPANYID SMALLINT,  @aagGetHdrID BIGINT,  @Status INT,  @RCTRXSEQ NUMERIC(19,5),  @OPENYEAR INT,  @TRXSORCE CHAR(13),  @TRXDATE DATETIME,  @JRNENTRY BIGINT,   @HDRID INT,  @DISTID INT,  @SEQNUMBR INT,  @DISTID2 INT,  @LedgerID INT,  @cDBName CHAR(5),  @l_nStatus INT,  @l_nError INT,  @O_nSQL_Error_State INT,  @l_cBBF VARCHAR(255),  @l_cPANDL VARCHAR(255)  select @cDBName = DB_NAME()   exec    @l_nStatus = DYNAMICS.dbo.smGetMsgString 12030, @cDBName, @l_cBBF output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)   exec    @l_nStatus = DYNAMICS.dbo.smGetMsgString 12125, @cDBName, @l_cPANDL output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)  IF @Preview = 1   BEGIN  EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Header Table'','''' ,9,1 ,LTRIM(STR(GL20000.JRNENTRY))  from GL20000 where SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''')  and JRNENTRY not in (select Distinct JRNENTRY from AAG30000 where  aaGLTRXSource=GL20000.TRXSORCE AND AAG30000.RCTRXSEQ = GL20000.RCTRXSEQ AND AAG30000.YEAR1 = GL20000.OPENYEAR)  group by OPENYEAR,JRNENTRY,RCTRXSEQ,TRXSORCE,TRXDATE')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Distribution Table'',''AA GL Open Header ID='' + CONVERT(VARCHAR(20),(SELECT dbo.aagGetHdrID(0,1,'' '','' '',JRNENTRY,RCTRXSEQ, TRXDATE,OPENYEAR,TRXSORCE,30000)))  ,9,1, LTRIM(STR(GL20000.JRNENTRY))  from GL20000 where SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''')   and (JRNENTRY IN (select JRNENTRY from AAG30000 where  aaGLTRXSource=GL20000.TRXSORCE and aaGLHdrID not in (select Distinct aaGLHdrID from AAG30001 )) or  (JRNENTRY IN (select JRNENTRY from AAG30000 where  aaGLTRXSource=GL20000.TRXSORCE and aaGLHdrID in (select Distinct aaGLHdrID from AAG30001 ))  and   (SEQNUMBR) not in (select Distinct SEQNUMBR from AAG30001 where aaGLHdrID = (select aaGLHdrID from AAG30000 where   AAG30000.aaGLTRXSource=GL20000.TRXSORCE and AAG30000.JRNENTRY=GL20000.JRNENTRY))))')    EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30001.aaGLHdrID))+space(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30001.aaGLDistID)) ,9,1,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30001.aaGLHdrID)) ),0)  from AAG30001 where (AAG30001.aaGLDistID not in (select Distinct aaGLDistID from AAG30002 where AAG30002.aaGLHdrID =AAG30001.aaGLHdrID) )   or AAG30001.aaGLHdrID not in (select Distinct aaGLHdrID from AAG30002)')   END  ELSE  BEGIN  Begin  select  @CMPANYID = CMPANYID from DYNAMICS.dbo.SY01500 where INTERID = DB_NAME()   exec DYNAMICS..aagGetNextID 30000, @CMPANYID, @aagGetHdrID out, @Status   declare CGLOPEN cursor fast_forward for  select JRNENTRY, RCTRXSEQ,OPENYEAR,TRXSORCE,TRXDATE, Ledger_ID  from GL20000 where SOURCDOC not IN(@l_cBBF, @l_cPANDL) and JRNENTRY not in (select Distinct JRNENTRY from AAG30000 where aaGLTRXSource = GL20000.TRXSORCE AND AAG30000.RCTRXSEQ = GL20000.RCTRXSEQ AND AAG30000.YEAR1 = GL20000.OPENYEAR)  group by OPENYEAR,JRNENTRY,RCTRXSEQ,TRXSORCE,TRXDATE, Ledger_ID  for read only   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Header Table'','''' ,3,1,LTRIM(STR(GL20000.JRNENTRY))  from GL20000 where SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''')  and JRNENTRY not in (select Distinct JRNENTRY from AAG30000 where  aaGLTRXSource=GL20000.TRXSORCE AND AAG30000.RCTRXSEQ = GL20000.RCTRXSEQ AND AAG30000.YEAR1 = GL20000.OPENYEAR)  group by OPENYEAR,JRNENTRY,RCTRXSEQ,TRXSORCE,TRXDATE')   open CGLOPEN  fetch next from CGLOPEN into @JRNENTRY,@RCTRXSEQ,@OPENYEAR,@TRXSORCE,@TRXDATE,@LedgerID  while @@fetch_status =0  begin  exec DYNAMICS..aagGetNextID 30000, @CMPANYID, @aagGetHdrID out, @Status  insert into AAG30000  (aaGLHdrID,JRNENTRY,RCTRXSEQ,YEAR1,aaTRXType,aaGLTRXSource,aaTRXSource,GLPOSTDT,Ledger_ID)  values(@aagGetHdrID,@JRNENTRY,@RCTRXSEQ,@OPENYEAR,1,@TRXSORCE,' ',@TRXDATE,@LedgerID)   fetch next from CGLOPEN into @JRNENTRY,@RCTRXSEQ,@OPENYEAR,@TRXSORCE,@TRXDATE,@LedgerID  end   close CGLOPEN  deallocate CGLOPEN   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Distribution Table'',''AA GL Open Header ID='' + CONVERT(VARCHAR(20),(SELECT dbo.aagGetHdrID(0,1,'' '','' '',JRNENTRY,RCTRXSEQ, TRXDATE,OPENYEAR,TRXSORCE,30000))) ,3,1 ,LTRIM(STR(GL20000.JRNENTRY))  from GL20000 where SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''')   and (JRNENTRY IN (select JRNENTRY from AAG30000 where  aaGLTRXSource=GL20000.TRXSORCE and aaGLHdrID not in (select Distinct aaGLHdrID from AAG30001 )) or  (JRNENTRY IN (select JRNENTRY from AAG30000 where  aaGLTRXSource=GL20000.TRXSORCE and aaGLHdrID in (select Distinct aaGLHdrID from AAG30001 ))  and   (SEQNUMBR) not in (select Distinct SEQNUMBR from AAG30001 where aaGLHdrID = (select aaGLHdrID from AAG30000 where   AAG30000.aaGLTRXSource=GL20000.TRXSORCE and AAG30000.JRNENTRY=GL20000.JRNENTRY))))')    insert into AAG30001  (aaGLHdrID,  aaGLDistID, INTERID , CorrespondingUnit, ACTINDX, ACCTTYPE ,  aaBrowseType, DECPLACS, DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT,  CURNCYID, CURRNIDX, RATETPID, EXGTBLID, XCHGRATE, EXCHDATE, TIME1,  RTCLCMTD, DENXRATE, MCTRXSTT, SEQNUMBR,  aaCustID, aaVendID, aaSiteID, aaItemID, aaCopyStatus,aaChangeDate, aaChangeTime, AA_CL_Status)  select dbo.aagGetHdrID(0,1,' ',' ',JRNENTRY,RCTRXSEQ, TRXDATE,OPENYEAR,TRXSORCE,30000),  DEX_ROW_ID,  DB_NAME() ,CorrespondingUnit,ACTINDX, dbo.aagGetAccountType(ACTINDX),  0,2,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT,  CURNCYID, CURRNIDX, RATETPID,  EXGTBLID, XCHGRATE, EXCHDATE,TIME1,  RTCLCMTD, DENXRATE, MCTRXSTT, SEQNUMBR,'',  '', '', '', 8,convert(char(12), getdate(), 102), convert(char(12), getdate(), 108),0  from GL20000 where SOURCDOC not IN(@l_cBBF, @l_cPANDL)   and (JRNENTRY IN   (select JRNENTRY from AAG30000   where  aaGLTRXSource=GL20000.TRXSORCE   and aaGLHdrID not in (select Distinct aaGLHdrID from AAG30001))   or (JRNENTRY IN   (select JRNENTRY from AAG30000   where  aaGLTRXSource=GL20000.TRXSORCE   and aaGLHdrID in (select Distinct aaGLHdrID from AAG30001))   and (SEQNUMBR) not in   (select Distinct SEQNUMBR from AAG30001   where aaGLHdrID = (select aaGLHdrID from AAG30000   where AAG30000.aaGLTRXSource=GL20000.TRXSORCE   and AAG30000.JRNENTRY=GL20000.JRNENTRY)))  ) order by GL20000.SEQNUMBR   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30001.aaGLHdrID)) ,3,1,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30001.aaGLHdrID)) ),0)  from AAG30001 where (AAG30001.aaGLDistID not in (select Distinct aaGLDistID from AAG30002 where AAG30002.aaGLHdrID =AAG30001.aaGLHdrID) )   or AAG30001.aaGLHdrID not in (select Distinct aaGLHdrID from AAG30002)  OR AAG30001.aaGLHdrID not in (select Distinct aaGLHdrID from AAG30000) ')   insert into AAG30002  (aaGLHdrID,aaGLDistID,aaGLAssignID,DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,aaAssignedPercent,  DistRef,NOTEINDX)  select aaGLHdrID,aaGLDistID,1,DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,10000,  ' ',0 from AAG30001 where (AAG30001.aaGLDistID not in (select Distinct aaGLDistID from AAG30002 where AAG30002.aaGLHdrID =AAG30001.aaGLHdrID) )   or AAG30001.aaGLHdrID not in (select Distinct aaGLHdrID from AAG30002)  End  EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30002.aaGLHdrID)) ),-9999)  FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30002.aaGLHdrID AND AAG30001.aaGLDistID=AAG30002.aaGLDistID)')   DELETE AAG30002 FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30002.aaGLHdrID AND AAG30001.aaGLDistID=AAG30002.aaGLDistID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30003.aaGLHdrID AND AAG30001.aaGLDistID=AAG30003.aaGLDistID)')   DELETE AAG30003 FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30003.aaGLHdrID AND AAG30001.aaGLDistID=AAG30003.aaGLDistID)  Update AAG30001 SET aaGLDistID=0-ABS(aaGLDistID)  Update AAG30002 SET aaGLDistID=0-ABS(aaGLDistID)  Update AAG30003 SET aaGLDistID=0-ABS(aaGLDistID)   UPDATE AAG30003 SET aaGLDistID = a.ID FROM (  SELECT RANK() OVER (PARTITION BY aaGLHdrID ORDER BY SEQNUMBR,DEX_ROW_ID ASC) ID,aaGLHdrID,aaGLDistID from AAG30001 where SOURCDOC = '' group by aaGLHdrID,SEQNUMBR,aaGLDistID,DEX_ROW_ID  ) a INNER JOIN AAG30001 A1 ON A1.aaGLHdrID = a.aaGLHdrID AND A1.aaGLDistID = a.aaGLDistID  INNER JOIN AAG30003 A3 ON A3.aaGLHdrID = A1.aaGLHdrID AND A3.aaGLDistID = A1.aaGLDistID AND A1.SOURCDOC = ''   UPDATE AAG30002 SET aaGLDistID = a.ID FROM (  SELECT RANK() OVER (PARTITION BY aaGLHdrID ORDER BY SEQNUMBR,DEX_ROW_ID ASC) ID,aaGLHdrID,aaGLDistID from AAG30001 where SOURCDOC = '' group by aaGLHdrID,SEQNUMBR,aaGLDistID,DEX_ROW_ID  ) a INNER JOIN AAG30001 A1 ON A1.aaGLHdrID = a.aaGLHdrID AND A1.aaGLDistID = a.aaGLDistID  INNER JOIN AAG30002 A2 ON A2.aaGLHdrID = A1.aaGLHdrID AND A2.aaGLDistID = A1.aaGLDistID AND A1.SOURCDOC = ''   UPDATE AAG30001 SET aaGLDistID = a.ID FROM (  SELECT RANK() OVER (PARTITION BY aaGLHdrID ORDER BY SEQNUMBR,DEX_ROW_ID ASC) ID,aaGLHdrID,aaGLDistID from AAG30001 where SOURCDOC = '' group by aaGLHdrID,SEQNUMBR,aaGLDistID,DEX_ROW_ID  ) a INNER JOIN AAG30001 A1 ON A1.aaGLHdrID = a.aaGLHdrID AND A1.aaGLDistID = a.aaGLDistID AND A1.SOURCDOC = ''   UPDATE AAG30003 SET aaGLDistID = ABS(AAG30003.aaGLDistID) from AAG30001 A1 where AAG30003.aaGLHdrID=A1.aaGLHdrID and AAG30003.aaGLDistID=A1.aaGLDistID and A1.SOURCDOC <> ''  UPDATE AAG30002 SET aaGLDistID = ABS(AAG30002.aaGLDistID) from AAG30001 A1 where AAG30002.aaGLHdrID=A1.aaGLHdrID and AAG30002.aaGLDistID=A1.aaGLDistID and A1.SOURCDOC <> ''  UPDATE AAG30001 SET aaGLDistID = ABS(aaGLDistID) where SOURCDOC <> ''   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Distribution Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30001.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30001.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30001.aaGLHdrID)) ),-9999)  FROM AAG30001 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30000 WHERE AAG30000.aaGLHdrID=AAG30001.aaGLHdrID)')   DELETE AAG30001 FROM AAG30001 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30000 WHERE AAG30000.aaGLHdrID=AAG30001.aaGLHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30002.aaGLHdrID)) ),-9999)  FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30002.aaGLHdrID)')   DELETE AAG30002 FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30002.aaGLHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30003.aaGLHdrID)')   DELETE AAG30003 FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30003.aaGLHdrID)  END  IF @@ERROR <> 0  BEGIN  ROLLBACK TRANSACTION  END  ELSE  BEGIN  COMMIT TRANSACTION  END  SET NOCOUNT OFF END     
GO
GRANT EXECUTE ON  [dbo].[aagGenericGLOpenTOD] TO [DYNGRP]
GO
