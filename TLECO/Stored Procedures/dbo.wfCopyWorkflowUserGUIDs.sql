SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[wfCopyWorkflowUserGUIDs]   @source_Workflow_Name char(51),  @dest_Workflow_Name char(51),  @sourceDB char(5),  @destDB char(5),  @source_Workflow_Version int,  @Workflow_Error int OUTPUT AS  BEGIN SET NOCOUNT ON  declare @dest_Workflow_Version int  declare @new_WF_Alt_FinalApprover char(37), @new_Workflow_Delegate_To char(37)  declare @old_WF_Alt_FinalApprover char(37), @old_Workflow_Delegate_To char(37)  declare @sql_statement as varchar(8000)  select @dest_Workflow_Version=1  select @new_WF_Alt_FinalApprover=newid(), @new_Workflow_Delegate_To=newid()  select @old_WF_Alt_FinalApprover=WF_Alt_FinalApprover, @old_Workflow_Delegate_To=Workflow_Delegate_To from WF100002   where Workflow_Name=@source_Workflow_Name and Workflow_Version=@source_Workflow_Version   select @sql_statement = ''  select @sql_statement = @sql_statement + ' update '+rtrim(@destDB)+'..WF100002 set WF_Alt_FinalApprover='''+rtrim(@new_WF_Alt_FinalApprover) select @sql_statement = @sql_statement +''',Workflow_Delegate_To='''+rtrim(@new_Workflow_Delegate_To)+''' ' select @sql_statement = @sql_statement + ' where Workflow_Name='''+rtrim(@dest_Workflow_Name)+''' and Workflow_Version='+rtrim(cast(@dest_Workflow_Version as CHAR(5)))+' '  exec (@sql_statement)  select @sql_statement  select @sql_statement = ''  select @sql_statement = @sql_statement + ' insert into '+rtrim(@destDB)+'..WF40200 ' select @sql_statement = @sql_statement + ' select '''+rtrim(@new_WF_Alt_FinalApprover)+''',SEQUENCE1,WorkflowSelectionType,ADObjectGuid,ADDistinguishedName,ADDisplayName,ADAlias,' select @sql_statement = @sql_statement + '    ADDomain,ADLogin,EMail,ADType,WorkflowRoleID,WorkflowRole,WorkflowHierarchyID,WorkflowHierarchy,HierarchyLevel ' select @sql_statement = @sql_statement + ' from WF40200 where UsersListGuid = '''+rtrim(@old_WF_Alt_FinalApprover)+''' ' select @sql_statement = @sql_statement + ' insert into '+rtrim(@destDB)+'..WF40200  ' select @sql_statement = @sql_statement + ' select '''+rtrim(@new_Workflow_Delegate_To)+''',SEQUENCE1,WorkflowSelectionType,ADObjectGuid,ADDistinguishedName,ADDisplayName,ADAlias, ' select @sql_statement = @sql_statement + '    ADDomain,ADLogin,EMail,ADType,WorkflowRoleID,WorkflowRole,WorkflowHierarchyID,WorkflowHierarchy,HierarchyLevel ' select @sql_statement = @sql_statement + ' from WF40200 where UsersListGuid = '''+rtrim(@old_Workflow_Delegate_To)+'''  ' exec (@sql_statement)  select @sql_statement  select @sql_statement = ''  select @sql_statement = @sql_statement + ' declare @Workflow_Step_Name char(51), @old_Workflow_Step_Assign_To char(37) ' select @sql_statement = @sql_statement + ' declare @new_Workflow_Step_Assign_To char(37) ' select @sql_statement = @sql_statement + ' declare workflow_steps cursor local fast_forward ' select @sql_statement = @sql_statement + ' for select Workflow_Step_Name, Workflow_Step_Assign_To from WF100003 ' select @sql_statement = @sql_statement + '  where Workflow_Name='''+rtrim(@source_Workflow_Name)+''' and Workflow_Version='+rtrim(cast(@source_Workflow_Version as CHAR(5))) select @sql_statement = @sql_statement + ' open workflow_steps ' select @sql_statement = @sql_statement + ' fetch next from workflow_steps into @Workflow_Step_Name, @old_Workflow_Step_Assign_To ' select @sql_statement = @sql_statement + ' while @@FETCH_STATUS=0 ' select @sql_statement = @sql_statement + ' begin ' select @sql_statement = @sql_statement + '  if @old_Workflow_Step_Assign_To<>''''  ' select @sql_statement = @sql_statement + '  begin ' select @sql_statement = @sql_statement + '   select @new_Workflow_Step_Assign_To=newid() ' select @sql_statement = @sql_statement + '   update '+rtrim(@destDB)+'..WF100003 set Workflow_Step_Assign_To=@new_Workflow_Step_Assign_To ' select @sql_statement = @sql_statement + '    where Workflow_Step_Name=@Workflow_Step_Name and Workflow_Name='''+rtrim(@dest_Workflow_Name)+''' and Workflow_Version='+rtrim(cast(@dest_Workflow_Version as CHAR(5))) select @sql_statement = @sql_statement + '   insert into '+rtrim(@destDB)+'..WF40200 ' select @sql_statement = @sql_statement + '   select @new_Workflow_Step_Assign_To,SEQUENCE1,WorkflowSelectionType,ADObjectGuid,ADDistinguishedName,ADDisplayName,ADAlias, ' select @sql_statement = @sql_statement + '      ADDomain,ADLogin,EMail,ADType,WorkflowRoleID,WorkflowRole,WorkflowHierarchyID,WorkflowHierarchy,HierarchyLevel ' select @sql_statement = @sql_statement + '   from WF40200 where UsersListGuid = @old_Workflow_Step_Assign_To ' select @sql_statement = @sql_statement + '  end ' select @sql_statement = @sql_statement + '  fetch next from workflow_steps into @Workflow_Step_Name, @old_Workflow_Step_Assign_To ' select @sql_statement = @sql_statement + ' end ' select @sql_statement = @sql_statement + ' close workflow_steps ' select @sql_statement = @sql_statement + ' deallocate workflow_steps ' exec (@sql_statement)  select @sql_statement  END    
GO
GRANT EXECUTE ON  [dbo].[wfCopyWorkflowUserGUIDs] TO [DYNGRP]
GO
