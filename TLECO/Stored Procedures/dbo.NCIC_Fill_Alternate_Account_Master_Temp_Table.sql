SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
create procedure [dbo].[NCIC_Fill_Alternate_Account_Master_Temp_Table]  	@TBLNAME varchar(30), 	@TRGRACT varchar(200)=''	 as begin	 	 	declare @INTERID				varchar(5), 			@ACCTNMBRSTR1			varchar(1000), 			@COLUMN_NAME			varchar(20), 			@COLUMN_NAME1			varchar(4000), 			@VALUES					varchar(2000), 			@TEST					varchar(8000), 			@COTE					varchar(5) 	select @COTE = '''''' 	 	if exists(select name from tempdb..sysobjects where name='##FAMT001' and  xtype = 'U') 		drop table ##FAMT001 	if exists(select name from tempdb..sysobjects where name='#FAMT001' and  xtype = 'U') 		drop table #FAMT001 	 	if exists(select name from tempdb..sysobjects where name='##ACTNMBR_COLUMN_NAME' and  xtype = 'U') 		drop table ##ACTNMBR_COLUMN_NAME	 	exec('delete  '+@TBLNAME) 	 	create table #FAMT001  (CMPANYID  smallint,CMPNYNAM char(65),INTERID  char(5),ACTINDX  int, ACTNUMST  char(129))	 	insert into #FAMT001(CMPANYID,CMPNYNAM,INTERID,ACTINDX)  	select distinct NCIC3005.NC_Source_Company_ID ,DYNAMICS..SY01500.CMPNYNAM,DYNAMICS..SY01500.INTERID, NCIC3005.NC_Src_IC_Account_Index from NCIC3005 inner join DYNAMICS..SY01500 	on NCIC3005.NC_Source_Company_ID = DYNAMICS..SY01500.CMPANYID   	union all	 	select distinct NCIC3005.CMPANYID,DYNAMICS..SY01500.CMPNYNAM, DYNAMICS..SY01500.INTERID, NCIC3005.NC_Dest_IC_Account_Index from NCIC3005 inner join DYNAMICS..SY01500 	on NCIC3005.CMPANYID = DYNAMICS..SY01500.CMPANYID 	create table ##FAMT001  (CMPANYID  smallint,CMPNYNAM char(65),INTERID  char(5),ACTINDX  int, ACTNUMST  char(129) PRIMARY KEY (CMPANYID,INTERID,ACTINDX))	 	insert into ##FAMT001(CMPANYID,CMPNYNAM,INTERID,ACTINDX)  	select distinct CMPANYID,CMPNYNAM,INTERID,ACTINDX from #FAMT001 	 	/*delete ##FAMT001 where  INTERID not in (select DATABASE_NAME   = db_name(s_mf.database_id) 		from  sys.master_files s_mf where s_mf.state = 0 and  		has_dbaccess(db_name(s_mf.database_id)) = 1 group by s_mf.database_id)*/ 	declare CMP1 cursor for  	select distinct INTERID from ##FAMT001 	open CMP1 	fetch next from CMP1 into @INTERID 	while @@fetch_status = 0 	begin 		 		exec('update ##FAMT001 set  ACTNUMST = ' +@INTERID+ '..GL00105.ACTNUMST from ##FAMT001 inner join ' + @INTERID+'..GL00105  on ##FAMT001.ACTINDX = ' + @INTERID+'..GL00105.ACTINDX where ##FAMT001.INTERID = '''+@INTERID+'''')			 		 		fetch next from CMP1 into @INTERID 	end 	close CMP1 	deallocate CMP1	 	 	if @TRGRACT <> '' 	begin 		select @TRGRACT = replace(@TRGRACT,'?','_') 		select @TRGRACT = replace(@TRGRACT,'%','_') 		select @TRGRACT = replace(@TRGRACT,' ','_') 	end  	 	set @COLUMN_NAME = '' 	set @COLUMN_NAME1 = '' 	set @VALUES = ''	 		/* exec('use tempdb  declare ACTNMBR cursor for select COLUMN_NAME from INFORMATION_SCHEMA.COLUMNS where TABLE_NAME = '''+@TBLNAME+''' and COLUMN_NAME like ''ACCNUMARY_%''')*/ 	exec('use tempdb   select COLUMN_NAME into ##ACTNMBR_COLUMN_NAME from INFORMATION_SCHEMA.COLUMNS where TABLE_NAME = '''+@TBLNAME+''' and COLUMN_NAME like ''ACCNUMARY_%''') 	declare ACTNMBR cursor for select COLUMN_NAME from ##ACTNMBR_COLUMN_NAME  	open ACTNMBR 	fetch next from ACTNMBR into @COLUMN_NAME 	while @@fetch_status = 0 	begin			 		set @COLUMN_NAME1 = @COLUMN_NAME1 + @COLUMN_NAME +','				 		if substring(@COLUMN_NAME,1,12) = 'ACCNUMARY_2_' 				set @VALUES = @VALUES + 'b.ACTNUMBR_' + substring(@COLUMN_NAME,13,1)+',' 		else set @VALUES = @VALUES + ''''' ,' 		fetch next from ACTNMBR into @COLUMN_NAME 	end 	close ACTNMBR 	deallocate ACTNMBR exec('insert into ' + @TBLNAME +' 		('+@COLUMN_NAME1+ 'NC_Source_Company_ID, 		NC_Src_IC_Account_Index,CMPANYID, 		NC_Dest_IC_Account_Index,NC_Copy_MDA_CB,NC_Reverse_MDA_CB,Remote_Company_ID, 		Remote_Destination_Accou,Remote_Destination_IC_Ac,NC_Src_Account_String, 		NC_Dest_Account_String) 		select '+@VALUES+'NC_Source_Company_ID, 		NC_Src_IC_Account_Index,n.CMPANYID, 		NC_Dest_IC_Account_Index,NC_Copy_MDA_CB,NC_Reverse_MDA_CB,Remote_Company_ID, 		Remote_Destination_Accou,Remote_Destination_IC_Ac, 		isnull(f1.ACTNUMST,'+@COTE+'),isnull(f1.ACTNUMST,'+@COTE+') 		from NCIC3005 as n  		 		inner join GL00105 as b on n.NC_Src_IC_Account_Index = b.ACTINDX  		left outer join ##FAMT001 as f1 on  n.CMPANYID = f1.CMPANYID and n.NC_Dest_IC_Account_Index = f1.ACTINDX 		where b.ACTNUMST like '''+@TRGRACT+'%''') 	 end  
GO
GRANT EXECUTE ON  [dbo].[NCIC_Fill_Alternate_Account_Master_Temp_Table] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[NCIC_Fill_Alternate_Account_Master_Temp_Table] TO [public]
GO
