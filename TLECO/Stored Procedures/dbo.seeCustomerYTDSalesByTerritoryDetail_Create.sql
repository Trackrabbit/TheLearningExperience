SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[seeCustomerYTDSalesByTerritoryDetail_Create] @iLanguageID int   as   set nocount on   declare @sqldropstring varchar(400),   @sqlstring1 varchar(8000),   @sqlstring2 varchar(8000),   @sqlstring3 varchar(8000),   @sqlstring4 varchar(8000),   @sqlstring5 varchar(8000),   @sqlstring6 varchar(8000),   @sqlstring7 varchar(8000),   @sqlstring8 varchar(8000),   @sqlstring9 varchar(8000),   @sqlstring10 varchar(8000),   @sqljoinstring varchar(8000),   @sqlaccessstring varchar(2000),   @tNumberSegments int,   @tSegment int,   @I_iDictID int,   @I_iLangID int,   @I_iMessageNumber int,   @I_iAliasMessageNumber int,   @I_iIntegerValue int,  @Customer_Number varchar(255), @Customer_Number_For_DrillBack varchar(255), @SalespersonID_For_DrillBack varchar(255) select @I_iDictID = 1493 select @I_iMessageNumber = 22900 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgStringForProcs  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Customer_Number output    select @I_iDictID = 1493 select @I_iMessageNumber = 22900 select @I_iAliasMessageNumber = 22214 exec DYNAMICS..smGetBIMsgStringForProcs  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Customer_Number_For_DrillBack output   select @I_iDictID = 1493 select @I_iMessageNumber = 22924 select @I_iAliasMessageNumber = 22214 exec DYNAMICS..smGetBIMsgStringForProcs  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @SalespersonID_For_DrillBack output    select @sqldropstring =   'IF EXISTS (SELECT * FROM   sys.objects WHERE  object_id = OBJECT_ID(N''[dbo].[seeCustomerYTDSalesByTerritoryDetail]'') AND type in ( N''P'', N''PC'' ))  ' +   '  DROP PROCEDURE [dbo].[seeCustomerYTDSalesByTerritoryDetail]  '   select @sqlstring1 =   'create procedure dbo.seeCustomerYTDSalesByTerritoryDetail '+   '  @State char (10) '+   'as '+   'create table #Detail ( '+   ' Customer_Number char (15), '+   ' Customer_Name char(65), '+   ' City char (35), '+   ' [State] char (29), '+   ' Country char (61), '+   ' Territory char (15), '+   ' Salesperson_ID char (15), '+   ' Total_Sales_YTD numeric (19,5), '+   ' Drillback_for_CustomerID varchar(500), '+   ' Drillback_for_Salesperson varchar (500)) '+    'INSERT INTO #Detail (Customer_Number, Customer_Name, City, [State], Country, Territory, Salesperson_ID, Total_Sales_YTD, Drillback_for_CustomerID, Drillback_for_Salesperson) '+   'SELECT RM00101.CUSTNMBR, RM00101.CUSTNAME, RM00101.CITY, RTRIM(RM00101.[STATE]), RM00101.COUNTRY, RM00101.SALSTERR, RM00101.SLPRSNID, isnull(RM00103.TTLSLYTD,0), Customers.['+@Customer_Number_For_DrillBack+'], Customers.['+@SalespersonID_For_DrillBack+'] '+   'FROM RM00101 '+   'JOIN RM00103 on '+   ' RM00101.CUSTNMBR = RM00103.CUSTNMBR '+   'JOIN (select DISTINCT ['+@Customer_Number+'], ['+@Customer_Number_For_DrillBack+'], ['+@SalespersonID_For_DrillBack+'] from Customers) Customers  '+   ' on RM00101.CUSTNMBR = Customers.['+@Customer_Number+'] '+   'WHERE isnull(RM00103.TTLSLYTD,0)<>0  '+   'IF @State = ''All''  '+   'BEGIN '+   ' SELECT Customer_Number, Customer_Name, City, [State], Country, Territory, Salesperson_ID, Total_Sales_YTD, Drillback_for_CustomerID, Drillback_for_Salesperson '+   ' FROM #Detail '+   'END '+   'Else '+   'BEGIN '+   ' SELECT Customer_Number, Customer_Name, City, [State], Country, Territory, Salesperson_ID, Total_Sales_YTD, Drillback_for_CustomerID, Drillback_for_Salesperson '+   ' FROM #Detail  '+   ' WHERE [State] = @State '+   'END '  select @sqlaccessstring =   'GRANT execute ON [dbo].[seeCustomerYTDSalesByTerritoryDetail] TO [rpt_warehouse manager], [rpt_materials manager], [rpt_operations manager], [rpt_shipping and receiving], [rpt_operations manager], [rpt_order processor], [rpt_executive], [rpt_power user], [rpt_sales manager] '   exec (@sqldropstring)   exec (@sqlstring1+' '+@sqlstring2+' '+@sqlstring3+' '+@sqlstring4+' '+@sqlstring5+' '+@sqlstring6+' '+@sqlstring7+' '+@sqlstring8+' '+@sqlstring9+' '+@sqlstring10)   exec (@sqlaccessstring)   set nocount off    
GO
GRANT EXECUTE ON  [dbo].[seeCustomerYTDSalesByTerritoryDetail_Create] TO [DYNGRP]
GO
