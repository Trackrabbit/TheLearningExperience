SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_RTV_TransferToHistory]  (  @RTV char(15),  @TransferStatus smallint output ) As declare @Transfer char(15) declare @RTVLine numeric(19,5) declare @Sequence int declare @DistType smallint  if exists(select * from SVC05601 where RTV_Number = @RTV and RTV_Status < 6) AND (SELECT VOIDSTTS FROM SVC05600 WHERE RTV_Number = @RTV) = 0  begin  select @TransferStatus  = 99  return  end  insert into SVC35600 with (rowlock) select RTV_Number,RTV_Type,RTV_Return_Status,RTV_Status,VRMA_Document_ID,RETDOCID,LNSEQNBR,DSCRIPTN,VENDORID,VENDNAME, ADRSCODE,Ship_Address_Name,Ship_Address_1,Ship_Address_2,Ship_Address_3,Ship_City,Ship_State,ZIPCODE,Ship_Country, ENTDTE,ENTTME,PRMDATE,Promised_Time,Shipped_Date,Shipped_Time,receiptdate,Receipt_Time,COMPDTE,COMPTME, LOCCODEB,LOCNCODE,Part_Price,Part_Cost,Labor_Price,Labor_Cost,Expense_Price,Expense_Cost,Travel_Price,Travel_Cost, Bill_of_Lading_Out,Shipping_Method_Out,Bill_of_Lading,SHIPMTHD,OFFID,NOTEINDX, VCHNUMWK,Voucher_Number_Invoice,Voucher_Number_Reimburse,CUSTOWN, USERID,USERDEF1,USERDEF2,USRDEF03,USRDEF04,USRDEF05, CURNCYID,CURRNIDX,RATETPID,EXGTBLID,XCHGRATE,EXCHDATE,DECPLACS,TIME1,RATECALC,VIEWMODE,ISMCTRX,EXPNDATE,DENXRATE,MCTRXSTT, Originating_Part_Price,Originating_Part_Cost,Originating_Labor_Price,Originating_Labor_Cost, Originating_ExpensePrice,Originating_Expense_Cost,Originating_Travel_Price,Originating_Travel_Cost,VOIDSTTS from SVC05600 where RTV_Number = @RTV if @@error <> 0 goto baderror  declare cursor_5601 cursor for select RTV_Line from SVC05601 where RTV_Number = @RTV  open cursor_5601  fetch next from cursor_5601 into @RTVLine  while @@FETCH_STATUS = 0   begin  insert into SVC35601 with (rowlock)  select  RTV_Number,RTV_Line,RTV_Type,RTV_Status,RTV_Return_Status,VRMA_Document_ID,RETDOCID,LNSEQNBR,SVC_Process_SEQ_Number,  DSCRIPTN,REFRENCE,Reference2,ITEMNMBR,ITEMDESC,ITMTRKOP,DECPLQTY,QUANTITY,QTYSHPPD,QTY_To_Receive,QTYRECVD,QTYCANCE,  UOFM,VENDORID,VNDITNUM,Return_Item_Number,OFFID,LOCCODEB,LOCNCODE,ADRSCODE,  Ship_Address_Name,Ship_Address_1,Ship_Address_2,Ship_Address_3,Ship_City,Ship_State,ZIPCODE,Ship_Country,  ENTDTE,ENTTME,PRMDATE,Promised_Time,Shipped_Date,Shipped_Time,receiptdate,Receipt_Time,COMPDTE,COMPTME,  PONMBRSTR,POLNSEQ,POPRCTNM,RCPTLNNM,Transfer_Reference,TRANSLINESEQ,CALLNBR,EQPLINE,LINITMTYP,LNITMSEQ,  Bill_of_Lading_Out,Shipping_Method_Out,Bill_of_Lading,SHIPMTHD,Tracking_Number,NOTEINDX,  VCHNUMWK,Voucher_Number_Invoice,Voucher_Number_Reimburse,CUSTOWN,  USERDEF1,USERDEF2,USRDEF03,USRDEF04,USRDEF05,  Part_Price,Part_Cost,Labor_Price,Labor_Cost,Expense_Price,Expense_Cost,Travel_Price,Travel_Cost,  Originating_Part_Price,Originating_Part_Cost,Originating_Labor_Price,Originating_Labor_Cost,  Originating_ExpensePrice,Originating_Expense_Cost,Originating_Travel_Price,Originating_Travel_Cost, QTYTYPE  from SVC05601 where RTV_Number = @RTV and RTV_Line = @RTVLine  if @@error <> 0 goto baderror   fetch next from cursor_5601 into @RTVLine  end  deallocate cursor_5601  declare cursor_5602 cursor for select RTV_Line, SLTSQNUM from SVC05602 where RTV_Number = @RTV  open cursor_5602  fetch next from cursor_5602 into @RTVLine, @Sequence  while @@FETCH_STATUS = 0   begin  insert into SVC35602 with (rowlock)  select  RTV_Number,RTV_Line,QTYTYPE,SERLTQTY,SLTSQNUM,ITEMNMBR,SERLNMBR,SVC_Serial_ID,EQUIPID,  Return_Item_Number,Return_Serial_Number,SVC_Return_Serial_ID,Return_Equipment_ID,BIN,TOBIN,  RETCOST,SVC_Original_Serial,DATERECD,DTSEQNUM,TRXSORCE,Shipped,MARKED,POSTED,  MFGDATE, EXPNDATE  from SVC05602 where RTV_Number = @RTV and RTV_Line = @RTVLine and SLTSQNUM = @Sequence  if @@error <> 0 goto baderror   fetch next from cursor_5602 into @RTVLine, @Sequence  end  deallocate cursor_5602  declare cursor_5620 cursor for select  LNSEQNBR from SVC05620 where RTV_Number = @RTV  open cursor_5620  fetch next from cursor_5620 into @RTVLine  while @@FETCH_STATUS = 0   begin  insert into SVC35620 with (rowlock)  select  RTV_Number,RTV_Line,LNSEQNBR,SVCFRMSTAT,SVCTOSTAT,DSCRPTION,USERID,CREATDDT,CREATETIME  from SVC05620 where RTV_Number = @RTV and LNSEQNBR = @RTVLine  if @@error <> 0 goto baderror   fetch next from cursor_5620 into @RTVLine  end  deallocate cursor_5620  if (select SVC_DistHistory_RTV from SVC00998) = 1  BEGIN  Declare cursor_5630 cursor for select RTV_Line, SEQNUMBR,SVC_Distribution_Type from SVC05630 where RTV_Number = @RTV  open cursor_5630  fetch next from cursor_5630 into @RTVLine, @Sequence, @DistType  while @@FETCH_STATUS = 0   begin  insert into SVC35630 with (rowlock)  select  RTV_Number,RTV_Line,LINITMTYP,SEQNUMBR,SVC_Distribution_Type,DistRef,  ACTINDX,DEBITAMT,ORDBTAMT,CRDTAMNT,ORCRDAMT,CURRNIDX,TRXSORCE,POSTED,POSTEDDT  from SVC05630 where RTV_Number = @RTV and RTV_Line = @RTVLine and SEQNUMBR = @Sequence and SVC_Distribution_Type = @DistType  if @@error <> 0 goto baderror   fetch next from cursor_5630 into @RTVLine, @Sequence, @DistType  end  deallocate cursor_5630 END   delete from SVC05620 where RTV_Number = @RTV  delete from SVC05630 where RTV_Number = @RTV  delete from SVC05601 where RTV_Number = @RTV  delete from SVC05602 where RTV_Number = @RTV  delete from SVC05600 where RTV_Number = @RTV  return(0) baderror:  return (99)    
GO
GRANT EXECUTE ON  [dbo].[SVC_RTV_TransferToHistory] TO [DYNGRP]
GO
