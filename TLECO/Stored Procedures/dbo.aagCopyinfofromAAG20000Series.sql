SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
 CREATE PROCEDURE [dbo].[aagCopyinfofromAAG20000Series]  @Batchnum as char(20) AS  DECLARE  @Docnumbr as char(21),  @Accindx as int,  @aagGetHdrID as int,  @aagGetDistID as int,  @dbtamt as numeric(19,5),  @crtamt as numeric(19,5),  @ordbtamt as numeric(19,5),  @orcrtamt as numeric(19,5), @bachtotal as numeric(19,5),  @cuncyid as char(15), @Currncy as char(15),  @curnindx as int,  @distyp as int,  @seqno as int ,  @i as int,  @intrid as char(5),  @decplcs as smallint,  @xchgrate as numeric(19,7),  @ratcalc as smallint, @ratetypid  as char(15), @exgtablid  as char(15), @denxrate as numeric(19,7),  @mctrxstat as smallint,  @aacustid as char(15),  @aavenid as char(15),  @aasiteid as char(11),  @aaitemid as char(31),  @EMPLOYID as char(15), @aacpystus as smallint,  @noteindx as numeric(19,5),  @rec as int,  @actindx as int,  @aatrxdimid as int,  @aatrxdimdflt as int, @flag  as int, @aaSubLedDistID as int, @aagGetGLWHdrID as int, @aagGetGLHdrID as int, @aagNextGLID as int, @aaGLWorkDistID as int, @aaSubLedgerAssignID as int, @aaGLHdrID  as int, @aaGLDistID as int, @V_HdrID as int, @V_TrimID as int, @year1 as int, @aatrxsrc as char(15), @aaGLTRXSource as char(13), @aaGLTRXSrc as char(13),  @GLPOSTDT as datetime, @NUMOFTRX as int, @Text as varchar(1000), @dat as char(20), @actdescr as char(51), @BCHTOTAL as numeric(9,5), @ACCTTYPE as int, @seq as int,  @SOURCDOC as char(11),  @actnumst as char(129), @aatrxdimcode as int, @aatrxdimid1 as int, @aatrxdimcod as int, @aaSubLedgerHdrID as int, @aaSubLedgerDistID as int, @DEBITAMT01 as numeric(19,5), @CREDITAMT01 as numeric(19,5), @ORDBTMAT as numeric(19,5), @ORCRTMAT as numeric(19,5), @n as int, @asinID as int, @aaGLAssignID as int, @ACCTTYPE002 as int, @ACCTTYPE003 as int, @JRNENTRY as int, @aaGLDistID1 as int, @aaGLDistID2 as int, @aaGLDistID3 as int, @totaadim as int, @NUMBERIE as char(30), @aaGLWorkHdrID as int, @FUNCRIDX as int, @CURRNIDX as int BEGIN  select @FUNCRIDX=FUNCRIDX from MC40000 if (select AUTPSTGL from SY02300 where SERIES=3 and TRXSOURC in(select TRANSVAL from DYNAMICS..SY05300 where UNTRSVAL='Receivables Cash Receipts'))=1  BEGIN   DECLARE AllDoc CURSOR FOR  select aaGLHdrID,JRNENTRY from AAG70000 OPEN AllDoc  FETCH NEXT FROM AllDoc INTO @aaGLHdrID,@JRNENTRY WHILE @@FETCH_STATUS = 0 BEGIN   select @intrid=[INTERID],@decplcs=[DECPLACS],@cuncyid=[CURNCYID],@curnindx=[CURRNIDX] ,@ratetypid=[RATETPID],@exgtablid=[EXGTBLID],@xchgrate=[XCHGRATE] ,@ratcalc=[RTCLCMTD],@denxrate=[DENXRATE],@mctrxstat=[MCTRXSTT],@seqno=[SEQNUMBR] ,@aacustid=[aaCustID],@aavenid=[aaVendID],@aasiteid=[aaSiteID], @aaitemid=[aaItemID],@EMPLOYID=[EMPLOYID],@aacpystus=[aaCopyStatus] from AAG30001 where aaGLHdrID=@aaGLHdrID  set @i=1 set @aaGLDistID1 =1 delete from AAG30001 where aaGLHdrID=@aaGLHdrID delete from AAG30002 where aaGLHdrID=@aaGLHdrID delete from AAG30003 where aaGLHdrID=@aaGLHdrID   DECLARE Assign_Cursor1 CURSOR FOR  SELECT DISTINCT(ORDOCNUM) FROM GL20000 where JRNENTRY=@JRNENTRY OPEN Assign_Cursor1  FETCH NEXT FROM Assign_Cursor1 INTO @Docnumbr WHILE @@FETCH_STATUS = 0 BEGIN  if (select PSTOGLHW from SY02300 where SERIES=3 and TRXSOURC in(select TRANSVAL from DYNAMICS..SY05300 where UNTRSVAL='Receivables Cash Receipts'))=0 BEGIN set @i=1 set @aaGLDistID1 =1  delete from AAG30001 where aaGLHdrID=@aaGLHdrID delete from AAG30002 where aaGLHdrID=@aaGLHdrID delete from AAG30003 where aaGLHdrID=@aaGLHdrID  END select @aaSubLedgerHdrID=aaSubLedgerHdrID from AAG20000 where DOCNUMBR=@Docnumbr  DECLARE Cursor20001 CURSOR FOR  SELECT ACTINDX,ACCTTYPE,DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,aaSubLedgerDistID,CURRNIDX from AAG20001 where aaSubLedgerHdrID=@aaSubLedgerHdrID  OPEN Cursor20001  FETCH NEXT FROM Cursor20001 INTO @Accindx,@ACCTTYPE003,@dbtamt,@crtamt,@ordbtamt,@orcrtamt,@aaSubLedgerDistID,@CURRNIDX WHILE @@FETCH_STATUS = 0 BEGIN   set @aaGLDistID=@aaSubLedgerDistID  SELECT @aaGLDistID3= isnull(max(aaGLDistID),0) from AAG30001 where  [aaGLHdrID]=@aaGLHdrID  if @FUNCRIDX=@CURRNIDX  BEGIN set @ordbtamt=@dbtamt set @orcrtamt=@crtamt Update AAG20001 set  ORDBTAMT=@dbtamt ,ORCRDAMT =@crtamt where aaSubLedgerHdrID=@aaSubLedgerHdrID and aaSubLedgerDistID=@aaSubLedgerDistID Update AAG20002 set  ORDBTAMT=@dbtamt ,ORCRDAMT =@crtamt where aaSubLedgerHdrID=@aaSubLedgerHdrID and aaSubLedgerDistID=@aaSubLedgerDistID END   INSERT INTO [AAG30001] ([aaGLHdrID],[aaGLDistID],[INTERID],[CorrespondingUnit] ,[ACTINDX],[ACCTTYPE],[aaBrowseType],[DECPLACS],[DEBITAMT] ,[CRDTAMNT],[ORDBTAMT],[ORCRDAMT],[CURNCYID],[CURRNIDX] ,[RATETPID],[EXGTBLID],[XCHGRATE],[EXCHDATE],[TIME1] ,[RTCLCMTD],[DENXRATE],[MCTRXSTT],[SEQNUMBR] ,[aaCustID],[aaVendID],[aaSiteID],[aaItemID],[EMPLOYID],[aaCopyStatus] ,[aaChangeDate],[aaChangeTime]) VALUES (@aaGLHdrID,@aaGLDistID3+1,isnull(@intrid,''),'',@Accindx,@ACCTTYPE003,1,isnull(@decplcs,2) ,@dbtamt,@crtamt,@ordbtamt,@orcrtamt,@cuncyid,@curnindx,isnull(@ratetypid,'') ,isnull(@exgtablid,''),isnull(@xchgrate,0),'' ,'',isnull(@ratcalc,0),isnull(@denxrate,0),isnull(@mctrxstat,0),@seqno,isnull(@aacustid,'') ,isnull(@aavenid,'') ,isnull(@aasiteid,''),isnull(@aaitemid,''),isnull(@EMPLOYID,''),isnull(@aacpystus,0),'','')   select @noteindx= isnull(max(NOTEINDX),0) from AAG30002  SELECT @aaGLDistID2= isnull(max(aaGLDistID),0) from AAG30002 where [aaGLHdrID]=@aaGLHdrID INSERT INTO [AAG30002] ([aaGLHdrID],[aaGLDistID],[aaGLAssignID],[DEBITAMT] ,[CRDTAMNT],[ORDBTAMT],[ORCRDAMT],[aaAssignedPercent] ,[DistRef],[NOTEINDX]) VALUES (@aaGLHdrID ,@aaGLDistID2+1,1,@dbtamt,@crtamt,@ordbtamt,@orcrtamt ,10000,'',@noteindx+1)  FETCH NEXT FROM Cursor20001 INTO @Accindx,@ACCTTYPE003,@dbtamt,@crtamt,@ordbtamt,@orcrtamt,@aaSubLedgerDistID,@CURRNIDX  END  CLOSE Cursor20001  DEALLOCATE Cursor20001  DECLARE AAINFO CURSOR FOR  SELECT ACTINDX from AAG20001 where aaSubLedgerHdrID=@aaSubLedgerHdrID  OPEN AAINFO  FETCH NEXT FROM AAINFO INTO @Accindx WHILE @@FETCH_STATUS = 0 BEGIN  SELECT @totaadim=count(*) from AAG00202 where aaAcctClassID in(Select aaAcctClassID from AAG00200 where ACTINDX=@Accindx)  DECLARE Cursor20003 CURSOR FOR  SELECT aaTrxDimID,aaTrxCodeID from AAG20003 where aaSubLedgerHdrID=@aaSubLedgerHdrID  OPEN Cursor20003  FETCH NEXT FROM Cursor20003 INTO @aatrxdimid,@aatrxdimcod WHILE @@FETCH_STATUS = 0 BEGIN  if @i > @totaadim BEGIN set @aaGLDistID1 = @aaGLDistID1 + 1 set  @i=1  END  INSERT INTO [AAG30003] ([aaGLHdrID],[aaGLDistID],[aaGLAssignID],[aaTrxDimID] ,[aaTrxCodeID]) VALUES (@aaGLHdrID,@aaGLDistID1,1,@aatrxdimid,@aatrxdimcod)  if @i <> @totaadim or @i = @totaadim set @i = @i+1 FETCH NEXT FROM Cursor20003 INTO @aatrxdimid,@aatrxdimcod  END  CLOSE Cursor20003  DEALLOCATE Cursor20003  FETCH NEXT FROM AAINFO INTO @Accindx END  CLOSE AAINFO  DEALLOCATE AAINFO  FETCH NEXT FROM Assign_Cursor1 INTO @Docnumbr  END  CLOSE Assign_Cursor1  DEALLOCATE Assign_Cursor1  FETCH NEXT FROM AllDoc INTO @aaGLHdrID,@JRNENTRY  END  CLOSE AllDoc  DEALLOCATE AllDoc  END  if (select AUTPSTGL from SY02300 where SERIES=3 and TRXSOURC in(select TRANSVAL from DYNAMICS..SY05300 where UNTRSVAL='Receivables Cash Receipts'))=0   BEGIN  set @i=1 set @aaGLDistID1 =1 set @n=0 SELECT @totaadim=count(*) from AAG00400  set @Text=''  set @Text='DECLARE Cursos_DOC CURSOR FOR  SELECT NUMBERIE FROM nfMCP10000 WHERE BACHNUMB = ''' + @Batchnum +''''  + 'OPEN Cursos_DOC '  Exec (@Text)   FETCH NEXT FROM Cursos_DOC INTO @NUMBERIE WHILE @@FETCH_STATUS = 0 BEGIN Select @JRNENTRY=JRNENTRY from GL10000 where DTAControlNum =@NUMBERIE  select @aaSubLedgerHdrID=aaSubLedgerHdrID from AAG20000 where DOCNUMBR=@NUMBERIE Select @aaGLWorkHdrID=aaGLWorkHdrID from AAG10000 where  @JRNENTRY=JRNENTRY  if (select PSTOGLHW from SY02300 where SERIES=3 and TRXSOURC in(select TRANSVAL from DYNAMICS..SY05300 where UNTRSVAL='Receivables Cash Receipts'))=1 BEGIN  Select @JRNENTRY=JRNENTRY from GL10000 where BACHNUMB IN (select TRXSORCE from RM10101 where DOCNUMBR=@NUMBERIE)  Select @aaGLWorkHdrID=aaGLWorkHdrID from AAG10000 where  @JRNENTRY=JRNENTRY  END if @n=0 BEGIN delete from AAG10001 where aaGLWorkHdrID=@aaGLWorkHdrID delete from AAG10002 where aaGLWorkHdrID=@aaGLWorkHdrID delete from AAG10003 where aaGLWorkHdrID=@aaGLWorkHdrID set @n=@n+1 END  if (select PSTOGLHW from SY02300 where SERIES=3 and TRXSOURC in(select TRANSVAL from DYNAMICS..SY05300 where UNTRSVAL='Receivables Cash Receipts'))=0 BEGIN set @i=1 set @aaGLDistID1 =1  delete from AAG10001 where aaGLWorkHdrID=@aaGLWorkHdrID delete from AAG10002 where aaGLWorkHdrID=@aaGLWorkHdrID delete from AAG10003 where aaGLWorkHdrID=@aaGLWorkHdrID END  DECLARE Cursor20001_Postto CURSOR FOR  SELECT ACTINDX,ACCTTYPE,DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,aaSubLedgerDistID,DECPLACS, CURNCYID,CURRNIDX,RATETPID,EXGTBLID,XCHGRATE,RTCLCMTD,DENXRATE,MCTRXSTT,SEQNUMBR,aaCustID, aaVendID,aaSiteID,aaItemID,EMPLOYID,aaCopyStatus from AAG20001 where aaSubLedgerHdrID=@aaSubLedgerHdrID  OPEN Cursor20001_Postto  FETCH NEXT FROM Cursor20001_Postto INTO @Accindx,@ACCTTYPE003,@dbtamt,@crtamt,@ordbtamt, @orcrtamt,@aaSubLedgerDistID,@decplcs,@cuncyid,@curnindx,@ratetypid,@exgtablid,@xchgrate, @ratcalc,@denxrate,@mctrxstat,@seqno,@aacustid,@aavenid,@aasiteid,@aaitemid,@EMPLOYID,@aacpystus WHILE @@FETCH_STATUS = 0 BEGIN   set @aaGLDistID=@aaSubLedgerDistID  SELECT @aaGLDistID3= isnull(max(aaGLWorkDistID),0) from AAG10001 where  aaGLWorkHdrID=@aaGLWorkHdrID if @FUNCRIDX=@curnindx  BEGIN  set @ordbtamt=@dbtamt set @orcrtamt=@crtamt  Update AAG20001 set  ORDBTAMT=@dbtamt ,ORCRDAMT =@crtamt where aaSubLedgerHdrID=@aaSubLedgerHdrID and aaSubLedgerDistID=@aaSubLedgerDistID Update AAG20002 set  ORDBTAMT=@dbtamt ,ORCRDAMT =@crtamt where aaSubLedgerHdrID=@aaSubLedgerHdrID and aaSubLedgerDistID=@aaSubLedgerDistID  END   INSERT INTO [AAG10001] ([aaGLWorkHdrID],[aaGLWorkDistID],[INTERID],[CorrespondingUnit] ,[ACTINDX],[ACCTTYPE],[aaBrowseType],[DECPLACS] ,[FXDORVAR],[DEBITAMT],[CRDTAMNT],[ORDBTAMT],[ORCRDAMT] ,[CURNCYID],[CURRNIDX],[RATETPID],[EXGTBLID],[XCHGRATE] ,[EXCHDATE],[TIME1],[RTCLCMTD],[DENXRATE],[MCTRXSTT] ,[SQNCLINE],[aaCustID],[aaVendID],[aaSiteID] ,[aaItemID],[EMPLOYID],[aaCopyStatus],[aaWinWasOpen],[aaOFFSETAcct] ,[aaDistErrors],[aaChangeDate],[aaChangeTime]) VALUES (@aaGLWorkHdrID,@aaGLDistID3+1,isnull(@intrid,''),'',@Accindx,@ACCTTYPE003,1,isnull(@decplcs,2) ,0,@dbtamt,@crtamt,@ordbtamt,@orcrtamt,@cuncyid,@curnindx,isnull(@ratetypid,'') ,isnull(@exgtablid,''),isnull(@xchgrate,0),'' ,'',isnull(@ratcalc,0),isnull(@denxrate,0),isnull(@mctrxstat,0),@seqno,isnull(@aacustid,'') ,isnull(@aavenid,'') ,isnull(@aasiteid,''),isnull(@aaitemid,''),isnull(@EMPLOYID,''),isnull(@aacpystus,0),1,0,0,'','')   select @noteindx= isnull(max(NOTEINDX),0) from AAG10002  SELECT @aaGLDistID2= isnull(max(aaGLWorkDistID),0) from AAG10002 where aaGLWorkHdrID=@aaGLWorkHdrID INSERT INTO [AAG10002] ([aaGLWorkHdrID],[aaGLWorkDistID],[aaGLWorkAssignID],[DEBITAMT] ,[CRDTAMNT],[ORDBTAMT],[ORCRDAMT],[aaAssignedPercent] ,[DistRef],[NOTEINDX],[aaAssignErrors],[aaAliasID]) VALUES (@aaGLWorkHdrID ,@aaGLDistID2+1,1,@dbtamt,@crtamt,@ordbtamt,@orcrtamt ,10000,'',@noteindx+1,0,0)  FETCH NEXT FROM Cursor20001_Postto INTO @Accindx,@ACCTTYPE003,@dbtamt,@crtamt,@ordbtamt, @orcrtamt,@aaSubLedgerDistID,@decplcs,@cuncyid,@curnindx,@ratetypid,@exgtablid,@xchgrate, @ratcalc,@denxrate,@mctrxstat,@seqno,@aacustid,@aavenid,@aasiteid,@aaitemid,@EMPLOYID,@aacpystus END  CLOSE Cursor20001_Postto  DEALLOCATE Cursor20001_Postto  DECLARE AAINFO1 CURSOR FOR  SELECT ACTINDX from AAG20001 where aaSubLedgerHdrID=@aaSubLedgerHdrID  OPEN AAINFO1  FETCH NEXT FROM AAINFO1 INTO @Accindx WHILE @@FETCH_STATUS = 0 BEGIN  SELECT @totaadim=count(*) from AAG00202 where aaAcctClassID in(Select aaAcctClassID from AAG00200 where ACTINDX=@Accindx)   DECLARE Cursor20003_POstto CURSOR FOR  SELECT aaTrxDimID,aaTrxCodeID from AAG20003 where aaSubLedgerHdrID=@aaSubLedgerHdrID  OPEN Cursor20003_POstto  FETCH NEXT FROM Cursor20003_POstto INTO @aatrxdimid,@aatrxdimcod WHILE @@FETCH_STATUS = 0 BEGIN   if @i > @totaadim BEGIN set @aaGLDistID1 = @aaGLDistID1 + 1 set  @i=1  END  INSERT INTO [AAG10003] ([aaGLWorkHdrID] ,[aaGLWorkDistID],[aaGLWorkAssignID] ,[aaTrxDimID],[aaTrxCodeID],[aaCodeErrors]) VALUES (@aaGLWorkHdrID,@aaGLDistID1,1,@aatrxdimid,@aatrxdimcod,0)  if @i <> @totaadim or @i = @totaadim set @i = @i+1 FETCH NEXT FROM Cursor20003_POstto INTO @aatrxdimid,@aatrxdimcod  END  CLOSE Cursor20003_POstto  DEALLOCATE Cursor20003_POstto  FETCH NEXT FROM AAINFO1 INTO @Accindx  END  CLOSE AAINFO1  DEALLOCATE AAINFO1  FETCH NEXT FROM Cursos_DOC INTO @NUMBERIE END  CLOSE Cursos_DOC  DEALLOCATE Cursos_DOC   END END    
GO
GRANT EXECUTE ON  [dbo].[aagCopyinfofromAAG20000Series] TO [DYNGRP]
GO
