SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[pmGetVendorPayments] (@IN_sVendorID varchar(60),@I_Orderby Integer,@IN_TypeID smallint,@IN_DocumentNo varchar(60),@IN_PaymentsTbl varchar(10)) AS BEGIN   DECLARE @DocFilterStr VARCHAR(800)   DECLARE @ColFilterStr VARCHAR(8000)  DECLARE @DefaultDate  datetime  DECLARE @OrderbyStr VARCHAR(7)   if @I_Orderby = 0   SET @OrderbyStr = ' DESC '  else   SET @OrderbyStr = ' ASC '   SET @DefaultDate = '1900-01-01 00:00:00.000'   EXEC('DELETE FROM ' + @IN_PaymentsTbl)  exec POPVendAnalysisBuildQuery 4,4,@ColFilterStr out   IF @IN_TypeID = 1  and @IN_DocumentNo <> ''  SELECT @DocFilterStr = ' AND D.APTVCHNM IN (SELECT VCHRNMBR FROM PM20000 WHERE PORDNMBR='+ @IN_DocumentNo +' UNION SELECT VCHRNMBR FROM PM30200 WHERE PORDNMBR='+ @IN_DocumentNo +' UNION SELECT VCHRNMBR FROM POP30300 WHERE VCHRNMBR <> '''' AND POPRCTNM IN (SELECT POPRCTNM FROM POP10500 WHERE PONUMBER = '+ @IN_DocumentNo +')) '  ELSE IF @IN_TypeID = 2  and @IN_DocumentNo <> ''   SELECT @DocFilterStr = ' AND D.APTVCHNM IN (SELECT VCHRNMBR FROM POP30300 WHERE POPRCTNM IN (SELECT POPIVCNO FROM POP10600 WHERE POPRCTNM = '+ @IN_DocumentNo +')) '   ELSE IF @IN_TypeID = 3  and @IN_DocumentNo <> ''   BEGIN  SELECT @DocFilterStr = ' AND (D.APTVCHNM = '+ @IN_DocumentNo +' OR E.APTVCHNM = '+ @IN_DocumentNo +') '  END  ELSE IF @IN_TypeID = 5  and @IN_DocumentNo <> ''   BEGIN  SELECT @DocFilterStr = ' AND A.VCHRNMBR IN (SELECT VCHRNMBR FROM PM30300 WHERE APTVCHNM IN(SELECT APTVCHNM FROM PM10200 WHERE VCHRNMBR = '+ @IN_DocumentNo +' UNION  SELECT APTVCHNM FROM PM30300 WHERE VCHRNMBR = '+ @IN_DocumentNo +' UNION   SELECT VCHRNMBR from POP30300 WHERE POPRCTNM IN(SELECT POPRCTNM FROM (SELECT POPRCTNM,PONUMBER  FROM POP10310 UNION SELECT POPRCTNM,PONUMBER FROM POP30310)M   WHERE PONUMBER IN (SELECT PONUMBER FROM POP10310 WHERE POPRCTNM = '+ @IN_DocumentNo +' UNION SELECT PONUMBER FROM POP30310 WHERE POPRCTNM = '+ @IN_DocumentNo +')))) '  END  ELSE IF @IN_TypeID = 6  and @IN_DocumentNo <> ''   BEGIN  SELECT @DocFilterStr = ' AND A.VCHRNMBR IN (SELECT VCHRNMBR FROM PM30300 WHERE APTVCHNM = '+ @IN_DocumentNo +') '  END   EXEC ('INSERT INTO [dbo].['+@IN_PaymentsTbl+']([INDXLONG],[VENDORID],[PMNTNMBR],[DOCAMNT],[DOCDATE],[DOCNUMBR],[PmtMethod],[CHEKBKID],[CHKBKNAM],[DISTKNAM],[CARDNAME],[VNDCHKNM],[APPLDAMT],[VOIDDATE],[APTVCHNM],[PONUMBER],[DCSTATUS])   SELECT TOP 100 ROW_NUMBER() OVER (ORDER BY B.DOCDATE '+ @OrderbyStr +') INDEX1,B.VENDORID,CNTRLNUM,A.DOCAMNT,B.DOCDATE,B.DOCNUMBR,PmtMethod,B.CHEKBKID,ISNULL(C.DSCRIPTN,''''),A.DISTKNAM,CARDNAME,VNDCHKNM,A.APPLDAMT,VOIDDATE,COALESCE(D.APTVCHNM,E.APTVCHNM,'''') APTVCHNM,PORDNMBR,B.DCSTATUS  FROM PM00400 B   left join CM00100 C ON B.CHEKBKID = C.CHEKBKID left join  (SELECT VCHRNMBR,DOCDATE,DOCNUMBR,DOCAMNT,DOCTYPE,0 PmtMethod,CHEKBKID,DISTKNAM,CARDNAME,'''' VNDCHKNM,(DOCAMNT-CURTRXAM) APPLDAMT,'''+@DefaultDate+''' VOIDDATE,PORDNMBR,1 DCSTATUS, CURTRXAM FROM PM10000  UNION  SELECT PMNTNMBR,DOCDATE,DOCNUMBR,CHEKTOTL,DOCTYPE,0 PmtMethod,CHEKBKID,DISTKNAM,'''' CARDNAME,VNDCHKNM,APPLDAMT,'''+@DefaultDate+''' VOIDDATE,PONUMBER,1 DCSTATUS, CURTRXAM  FROM PM10300  UNION  SELECT PMNTNMBR,DOCDATE,DOCNUMBR,DOCAMNT,DOCTYPE,PYENTTYP PmtMethod,CHEKBKID,DISTKNAM,CARDNAME,'''' VNDCHKNM,APPLDAMT,'''+@DefaultDate+''' VOIDDATE,PONUMBER,1 DCSTATUS, CURTRXAM FROM PM10400  UNION  SELECT VCHRNMBR,DOCDATE,DOCNUMBR,DOCAMNT,DOCTYPE,PYENTTYP PmtMethod,CHEKBKID,DISTKNAM,CARDNAME,VNDCHKNM,(DOCAMNT-CURTRXAM) APPLDAMT,'''+@DefaultDate+''' VOIDDATE,PONUMBER,2 DCSTATUS, CURTRXAM FROM PM20000  UNION  SELECT VCHRNMBR,DOCDATE,DOCNUMBR,DOCAMNT,DOCTYPE,PYENTTYP PmtMethod,CHEKBKID,DISTKNAM,CARDNAME,VNDCHKNM,(DOCAMNT-CURTRXAM) APPLDAMT,CASE VOIDED WHEN 0 THEN '''+@DefaultDate+''' ELSE DINVPDOF END VOIDDATE,PONUMBER,3 DCSTATUS, CURTRXAM FROM PM30200  ) A ON B.CNTRLNUM = A.VCHRNMBR AND B.DOCTYPE = A.DOCTYPE LEFT JOIN PM30300 D ON B.CNTRLNUM = D.VCHRNMBR LEFT JOIN PM10200 E ON B.CNTRLNUM = E.VCHRNMBR  WHERE A.DOCTYPE = 6 AND B.VENDORID = ' + @IN_sVendorID +' ' + @ColFilterStr + @DocFilterStr) END   
GO
GRANT EXECUTE ON  [dbo].[pmGetVendorPayments] TO [DYNGRP]
GO
