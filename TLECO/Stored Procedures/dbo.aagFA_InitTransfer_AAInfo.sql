SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE PROC [dbo].[aagFA_InitTransfer_AAInfo] @TransferEvent INT, @COMPANYID SMALLINT, @USERID VARCHAR(15) AS   BEGIN  DECLARE @TransferIndex INT,  @ASSETINDEX INT,  @LastAssetIndex INT,  @ACTINDX INTEGER,  @Count INTEGER,  @ListID SMALLINT,  @aaBrowseType SMALLINT,  @AcctClassID INT,  @AcctType SMALLINT,  @aaAliasID INT,  @aaFASetupID INT   SET @aaAliasID =0  DELETE FROM AAG04001 WHERE aaFASetupID IN (SELECT aaFASetupID FROM AAG04000 WHERE aaAssetIndex>(SELECT INDXVALUE FROM FAINDEX WHERE INDXNAME=2) AND   aaBookIndex NOT IN (SELECT TRANSFERINDX FROM FA00801 WHERE TRANSFEREVENT=@TransferEvent))  DELETE FROM AAG04000 WHERE aaAssetIndex>(SELECT INDXVALUE FROM FAINDEX WHERE INDXNAME=2) AND   aaBookIndex NOT IN (SELECT TRANSFERINDX FROM FA00801 WHERE TRANSFEREVENT=@TransferEvent)  SELECT @LastAssetIndex=INDXVALUE FROM FAINDEX WHERE INDXNAME=2   IF (SELECT COUNT(*) FROM AAG04000  WHERE aaAssetIndex>(SELECT INDXVALUE FROM FAINDEX WHERE INDXNAME=2) AND aaBookIndex IN (SELECT TRANSFERINDX FROM FA00801 WHERE TRANSFEREVENT=@TransferEvent)) > 0  BEGIN  DECLARE AAFASETUP CURSOR FAST_FORWARD FOR  SELECT DISTINCT aaFASetupID FROM AAG04000 WHERE  aaAssetIndex>(SELECT INDXVALUE FROM FAINDEX WHERE INDXNAME=2) AND aaBookIndex IN (SELECT TRANSFERINDX FROM FA00801 WHERE TRANSFEREVENT=@TransferEvent)  OPEN AAFASETUP  FETCH NEXT FROM AAFASETUP INTO @aaFASetupID  WHILE @@fetch_status = 0  BEGIN  SET @LastAssetIndex=@LastAssetIndex+1  UPDATE AAG04000 SET aaAssetIndex=@LastAssetIndex WHERE aaFASetupID=@aaFASetupID  FETCH NEXT FROM AAFASETUP INTO @aaFASetupID  END  CLOSE AAFASETUP  DEALLOCATE AAFASETUP  END   SET @aaFASetupID = 0   DECLARE XFRLINEDIST CURSOR FAST_FORWARD FOR  SELECT TRANSFERINDX,ASSETINDEX FROM FA00801 WHERE TRANSFEREVENT=@TransferEvent AND TRANSFERINDX NOT IN (SELECT aaBookIndex FROM AAG04000 WHERE aaAssetIndex>(SELECT INDXVALUE FROM FAINDEX WHERE INDXNAME=2))  OPEN XFRLINEDIST  FETCH NEXT FROM XFRLINEDIST INTO @TransferIndex,@ASSETINDEX   WHILE @@fetch_status = 0  BEGIN  EXEC DYNAMICS.dbo.aagGetNextID 20000,@COMPANYID,@aaFASetupID OUT  SET @ListID=1  SET @LastAssetIndex=@LastAssetIndex+1  DECLARE CREATEDIST CURSOR FAST_FORWARD FOR  SELECT ACT FROM (SELECT TRANSFERINDX, TODEPREXPACCTINDX, TODEPRRESVACCTINDX, TOPRYRDEPRACCTINDX, TOASSETCOSTACCTINDX, TOPROCEEDSACCTINDX, TORECGAINLOSSACCTINDX,   TONONRECGAINLOSSACCTINDX, TOCLEARACCTINDX FROM FA00801 WHERE TRANSFERINDX = @TransferIndex) p  UNPIVOT (ACT FOR ASSETI in ( TODEPREXPACCTINDX, TODEPRRESVACCTINDX, TOPRYRDEPRACCTINDX, TOASSETCOSTACCTINDX, TOPROCEEDSACCTINDX, TORECGAINLOSSACCTINDX,   TONONRECGAINLOSSACCTINDX,TOCLEARACCTINDX )) as a WHERE TRANSFERINDX = @TransferIndex  OPEN CREATEDIST  FETCH NEXT FROM CREATEDIST INTO @ACTINDX  WHILE @@fetch_status = 0  BEGIN  SELECT @aaAliasID=aaAliasID from FA00100 WHERE ASSETINDEX=@ASSETINDEX  SELECT @AcctType=ACCTTYPE FROM GL00100 WHERE ACTINDX=@ACTINDX  EXEC aagGetClassIDBrowseType @ACTINDX,@AcctClassID OUTPUT,@aaBrowseType OUTPUT  INSERT INTO AAG04000(aaFASetupID,ListID,INTERID,USERID,SERIES,ACTINDX,ACCTTYPE,aaBrowseType,aaAssetIndex,aaBookIndex,aaAliasID)   VALUES (@aaFASetupID,@ListID,DB_NAME(),@USERID,2,@ACTINDX,@AcctType,@aaBrowseType,@LastAssetIndex,@TransferIndex,@aaAliasID)  IF @AcctClassID !=0  BEGIN  INSERT INTO AAG04001 (aaFASetupID, ListID,aaTrxDimID, aaTrxDimCodeID)   SELECT @aaFASetupID, @ListID,aaTrxDimID,aaTrxDimCodeID  FROM AAG04001 WHERE aaFASetupID= (SELECT TOP 1 aaFASetupID FROM AAG04000 WHERE aaAssetIndex=@ASSETINDEX AND aaBookIndex=0) AND ListID=@ListID  AND aaTrxDimID NOT IN (SELECT l.aaTrxDimID FROM AAG04001 l WHERE l.aaFASetupID = @aaFASetupID AND l.ListID = @ListID)  END  SET @ListID=@ListID+1  FETCH NEXT FROM CREATEDIST INTO @ACTINDX  END  CLOSE CREATEDIST  DEALLOCATE CREATEDIST  FETCH NEXT FROM XFRLINEDIST INTO @TransferIndex,@ASSETINDEX  END  CLOSE XFRLINEDIST  DEALLOCATE XFRLINEDIST END   
GO
GRANT EXECUTE ON  [dbo].[aagFA_InitTransfer_AAInfo] TO [DYNGRP]
GO
