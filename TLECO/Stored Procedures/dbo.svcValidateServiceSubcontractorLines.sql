SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROC [dbo].[svcValidateServiceSubcontractorLines]  @I_vSRVRECTYPE smallint,  @I_vCALLNBR char(11),  @I_vSRVTYPE char(11),  @O_vErrorState integer  output,  @O_vErrorString char(255)  output AS  declare @iRecordExists   smallint,  @svcSubContractor  tinyint,  @svcPayableBatchID  char(15),  @EQPLINE integer,  @LINITMTYP char(3),  @LNITMSEQ integer,  @TECHID char(11),  @oErrorState   integer,  @oErrorString char(255)  select  @I_vSRVRECTYPE = isnull(@I_vSRVRECTYPE, 0),  @I_vCALLNBR = isnull(@I_vCALLNBR, ''),  @I_vSRVTYPE = isnull(@I_vSRVTYPE, ''),  @EQPLINE = 0,  @LINITMTYP = '',  @LNITMSEQ = 0,  @TECHID = '',  @O_vErrorState = 0,  @O_vErrorString = '',  @iRecordExists = 0,  @svcSubContractor = 0,  @svcPayableBatchID = '',  @oErrorState = 0,  @oErrorString = ''  if ( @I_vSRVRECTYPE <= 0 or  @I_vCALLNBR = '') begin  select  @O_vErrorState = 0,  @O_vErrorString = ''  return (@O_vErrorState) end  if (@I_vSRVTYPE = '') begin  set @iRecordExists = 0  select  @iRecordExists = 1,  @I_vSRVTYPE = isnull(SRVTYPE, '')  from SVC00200   where SRVRECTYPE = @I_vSRVRECTYPE and CALLNBR = @I_vCALLNBR  if (@iRecordExists <> 1)  begin  select  @O_vErrorState = 3001,  @O_vErrorString = 'Service Call ' + rtrim(@I_vCALLNBR) + ' does not exist.'  return (@O_vErrorState)  end end  if (@I_vSRVTYPE = '') begin  select  @O_vErrorState = 3002,  @O_vErrorString = 'Service Type is not entered for the Service Call ' + rtrim(@I_vCALLNBR) + '. '  return (@O_vErrorState) end  set @iRecordExists = 0 select  @iRecordExists = 1,  @svcSubContractor = isnull(svcSubcontractor, 0),  @svcPayableBatchID = isnull(svcPayableBatchID, '')  from SVC00920  where SRVTYPE = @I_vSRVTYPE  if (@iRecordExists <> 1) begin  select  @O_vErrorState = 3003,  @O_vErrorString = 'Service Type ' + rtrim(@I_vSRVTYPE) + ' does not exist.'  return (@O_vErrorState) end  if (@svcSubContractor = 1 and @svcPayableBatchID = '') begin  if exists(SELECT 1 from SVC00203 where SRVRECTYPE = @I_vSRVRECTYPE and CALLNBR = @I_vCALLNBR   and LINITMTYP in ('L', 'A', 'E')  and TECHID <> '' and svcCreateVoucher = 1)  begin  select  @O_vErrorState = 3004,  @O_vErrorString = 'Subcontractor feature requires a valid Payables Batch ID setup for Service Type ' + rtrim(@I_vSRVTYPE) + '. '  end  return (@O_vErrorState) end  DECLARE ServiceCallLines CURSOR FOR SELECT EQPLINE, LINITMTYP, LNITMSEQ, TECHID from SVC00203 where SRVRECTYPE = @I_vSRVRECTYPE and CALLNBR = @I_vCALLNBR   and LINITMTYP in ('L', 'A', 'E')  and TECHID <> '' and svcCreateVoucher = 1  OPEN ServiceCallLines FETCH NEXT FROM ServiceCallLines INTO @EQPLINE, @LINITMTYP, @LNITMSEQ, @TECHID  WHILE @@FETCH_STATUS = 0 BEGIN  exec svcValidateServiceSubcontractorInfo  @I_vSRVRECTYPE = @I_vSRVRECTYPE,  @I_vCALLNBR = @I_vCALLNBR,  @I_vSRVTYPE = @I_vSRVTYPE,  @I_vEQPLINE = @EQPLINE,  @I_vLINITMTYP = @LINITMTYP,  @I_vLNITMSEQ = @LNITMSEQ,  @I_vTECHID = @TECHID,  @O_vErrorState = @oErrorState output,  @O_vErrorString = @oErrorString output   if (@oErrorState <> 0)   begin  select  @O_vErrorState = @oErrorState,  @O_vErrorString = @oErrorString   break  end   FETCH NEXT FROM ServiceCallLines INTO @EQPLINE, @LINITMTYP, @LNITMSEQ, @TECHID END  CLOSE ServiceCallLines DEALLOCATE ServiceCallLines  return (@O_vErrorState)   
GO
GRANT EXECUTE ON  [dbo].[svcValidateServiceSubcontractorLines] TO [DYNGRP]
GO
