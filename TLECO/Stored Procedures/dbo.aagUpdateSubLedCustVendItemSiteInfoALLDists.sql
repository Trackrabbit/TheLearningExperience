SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE    procedure  [dbo].[aagUpdateSubLedCustVendItemSiteInfoALLDists]   @iHdrID int,  @iHdrIDPrimary int,  @icSource char(30)   As  begin  declare @Series tinyint,  @DocType smallint,  @DocNum varchar(20),  @nSeqNum int,  @nIVAcct int,  @nIVOffsetAcct int,  @AcctLinked tinyint,  @TrackCust tinyint,  @TrackVend tinyint,  @TrackItem tinyint,  @TrackSite tinyint,  @TrackEmpl tinyint,  @CustVendNum varchar(30),  @VendorID varchar(30),  @ItemNumber varchar(30),  @TRXLocation varchar(15),  @TRFToLocation varchar(15),  @HdrID int,  @DistID int,  @CustID varchar(15),   @VendID varchar(15),  @TrackAsset varchar(21),  @TrackBook varchar(15)  If @iHdrIDPrimary >0  Select @Series = SERIES, @DocType = DOCTYPE, @DocNum = DOCNUMBR From AAG20000 Where aaSubLedgerHdrID = @iHdrIDPrimary  Else  Select @Series = SERIES, @DocType = DOCTYPE, @DocNum = DOCNUMBR From AAG20000 Where aaSubLedgerHdrID = @iHdrID  If @Series <> 5   Begin  Declare UpdateInfo cursor fast_forward For  Select aaSubLedgerHdrID, aaSubLedgerDistID from AAG20001 Where aaSubLedgerHdrID = @iHdrID and POSTED = 0  Exec aagGetCustVendID @Series, @DocType, @DocNum, @icSource, @CustVendNum out  Open UpdateInfo  If @Series = 3 or @Series =11  Begin  Set @CustID = @CustVendNum  Set @VendID = ''  End  Else If @Series = 4 or @Series =12  Begin  Set @VendID = @CustVendNum  Set @CustID = ''  End  Else   Begin  Close UpdateInfo  Deallocate UpdateInfo   Return  End  Fetch next from UpdateInfo into @HdrID, @DistID  While @@fetch_status = 0  Begin  Exec aagUpdateSubLedCustVendItemSiteInfo @HdrID, @DistID, @CustID, @VendID, '', ''  Fetch next from UpdateInfo into @HdrID, @DistID  End  Close UpdateInfo  Deallocate UpdateInfo   End   Else  begin  declare curUpdateSLDist cursor fast_forward FOR  select LNSEQNBR, IVIVINDX, IVIVOFIX, ITEMNMBR, TRXLOCTN, TRNSTLOC  from IV30300 where DOCTYPE = @DocType and DOCNUMBR = @DocNum  order by LNSEQNBR  open curUpdateSLDist  fetch next from curUpdateSLDist into @nSeqNum, @nIVAcct, @nIVOffsetAcct, @ItemNumber, @TRXLocation, @TRFToLocation  WHILE @@fetch_status = 0  begin  Set @AcctLinked=0  Set @TrackCust =0  Set @TrackVend =0  Set @TrackItem =0  Set @TrackSite =0  Set @TrackEmpl =0  Set @TrackAsset=0  Set @TrackBook =0   exec aagIsAcctLinkedToClass   @nIVAcct,   @AcctLinked out,   @TrackCust out,   @TrackVend out,   @TrackItem out,   @TrackSite out,  @TrackEmpl out,  @TrackAsset out,  @TrackBook out   If @AcctLinked = 1  Begin  If @TrackItem = 1 and @ItemNumber <> ''  update AAG20001  set  aaItemID = @ItemNumber  where aaSubLedgerHdrID = @iHdrID and SEQNUMBR = @nSeqNum and  ACTINDX = @nIVAcct and aaOffsetAcct = 0  Else  update AAG20001  set  aaItemID = ''  where aaSubLedgerHdrID = @iHdrID and SEQNUMBR = @nSeqNum and  ACTINDX = @nIVAcct and aaOffsetAcct = 0  If @TrackSite = 1 and @TRXLocation <> ''  update AAG20001  set  aaSiteID = @TRXLocation  where aaSubLedgerHdrID = @iHdrID and SEQNUMBR = @nSeqNum and  ACTINDX = @nIVAcct and aaOffsetAcct = 0  Else  update AAG20001  set  aaSiteID = ''  where aaSubLedgerHdrID = @iHdrID and SEQNUMBR = @nSeqNum and  ACTINDX = @nIVAcct and aaOffsetAcct = 0  End  Else  update AAG20001  set  aaItemID = '', aaSiteID = ''  where aaSubLedgerHdrID = @iHdrID and SEQNUMBR = @nSeqNum and  ACTINDX = @nIVAcct and aaOffsetAcct = 0  Set @AcctLinked =0  Set @TrackCust =0  Set @TrackVend =0  Set @TrackItem =0  Set @TrackSite =0  Set @TrackEmpl =0  Set @TrackAsset=0  Set @TrackBook =0   exec aagIsAcctLinkedToClass   @nIVOffsetAcct,   @AcctLinked out,   @TrackCust out,   @TrackVend out,   @TrackItem out,   @TrackSite out,  @TrackEmpl out,  @TrackAsset out,  @TrackBook out   If @AcctLinked = 1  Begin  If @TrackItem = 1 and @ItemNumber <> ''  update AAG20001  set  aaItemID = @ItemNumber  where aaSubLedgerHdrID = @iHdrID and SEQNUMBR = @nSeqNum and  ACTINDX = @nIVOffsetAcct and aaOffsetAcct = 1  Else  update AAG20001  set  aaItemID = ''  where aaSubLedgerHdrID = @iHdrID and SEQNUMBR = @nSeqNum and  ACTINDX = @nIVOffsetAcct and aaOffsetAcct = 1  If @TrackSite = 1 and @DocType = 3and @TRFToLocation <> ''  update AAG20001  set  aaSiteID = @TRFToLocation  where aaSubLedgerHdrID = @iHdrID and SEQNUMBR = @nSeqNum and  ACTINDX = @nIVOffsetAcct and aaOffsetAcct = 1  Else If @TrackSite = 1 and @TRXLocation <> ''  update AAG20001  set  aaSiteID = @TRXLocation  where aaSubLedgerHdrID = @iHdrID and SEQNUMBR = @nSeqNum and  ACTINDX = @nIVOffsetAcct and aaOffsetAcct = 1  Else  update AAG20001  set  aaSiteID = ''  where aaSubLedgerHdrID = @iHdrID and SEQNUMBR = @nSeqNum and  ACTINDX = @nIVOffsetAcct and aaOffsetAcct = 1  End  Else  update AAG20001  set  aaItemID = '', aaSiteID = ''  where aaSubLedgerHdrID = @iHdrID and SEQNUMBR = @nSeqNum and  ACTINDX = @nIVOffsetAcct and aaOffsetAcct = 1  fetch next from curUpdateSLDist into @nSeqNum, @nIVAcct, @nIVOffsetAcct, @ItemNumber, @TRXLocation, @TRFToLocation  end  close curUpdateSLDist  deallocate curUpdateSLDist  end end    
GO
GRANT EXECUTE ON  [dbo].[aagUpdateSubLedCustVendItemSiteInfoALLDists] TO [DYNGRP]
GO
