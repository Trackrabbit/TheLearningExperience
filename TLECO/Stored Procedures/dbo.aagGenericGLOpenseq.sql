SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
 CREATE  PROCEDURE [dbo].[aagGenericGLOpenseq] @USERID CHAR(15), @TBName varchar(25), @Preview SMALLINT, @O_SQL_Error_State int = NULL  output AS  BEGIN   set nocount on  Declare @execStr varchar(8000),  @JRNENTRY bigint,  @aaGLHdrID   bigint,  @counter int,  @CntGP int,  @CntAA int,  @Cnt int,  @j   int,  @k int,  @l int   Declare @ACTINDX int,  @DEBITAMT numeric(19,5),  @CRDTAMNT numeric(19,5),  @ORDBTAMT numeric(19,5),  @ORCRDAMT numeric(19,5),  @SEQNUMBR bigint,  @lJRNENTRY bigint   Declare @cDBName char(5),  @l_nStatus int,  @l_cPROFIT_AND_LOSS varchar(255),  @l_cBalSheet varchar(255),  @O_nSQL_Error_State int,  @l_nError int,  @l_cBBF varchar(255),  @l_cPANDL varchar(255),  @l_RCTRXSEQ numeric(19,5),  @l_YEAR1 smallint,  @l_aaGLTRXSource char(13)   Declare @DistID int   select @cDBName = DB_NAME()   exec    @l_nStatus = DYNAMICS.dbo.smGetMsgString 12030, @cDBName, @l_cBBF output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)   exec    @l_nStatus = DYNAMICS.dbo.smGetMsgString 12125, @cDBName, @l_cPANDL output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)  exec    @l_nStatus = DYNAMICS.dbo.smGetMsgString 12125, @cDBName, @l_cPROFIT_AND_LOSS output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)   exec    @l_nStatus = DYNAMICS.dbo.smGetMsgString 12030, @cDBName, @l_cBalSheet output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)   declare CGLOpenseq cursor fast_forward  for   (Select Distinct A.JRNENTRY,A.aaGLHdrID, A.RCTRXSEQ, A.YEAR1, A.aaGLTRXSource from AAG30001 A1 inner join AAG30000 A on A1.aaGLHdrID = A.aaGLHdrID  inner join (select (select case when count(SEQNUMBR) > 1 then 3 else 1 end from GL20000 Der   where Der.JRNENTRY = GL20000.JRNENTRY and Der.SEQNUMBR = GL20000.SEQNUMBR and Der.RCTRXSEQ = GL20000.RCTRXSEQ) ACCTTYPE, *  from GL20000) B   on  A.aaGLTRXSource =B.TRXSORCE and B.SOURCDOC <> @l_cPROFIT_AND_LOSS and B.SOURCDOC <>  @l_cBalSheet  and A.JRNENTRY = B.JRNENTRY AND   A.aaGLTRXSource=B.TRXSORCE AND  A.RCTRXSEQ=B.RCTRXSEQ AND  A.YEAR1=B.OPENYEAR   where (A1.SEQNUMBR = B.SEQNUMBR and (A1.ACTINDX<>B.ACTINDX or   A1.DEBITAMT<>B.DEBITAMT or A1.CRDTAMNT<>B.CRDTAMNT or A1.ORDBTAMT<>B.ORDBTAMT or A1.ORCRDAMT<> B.ORCRDAMT)) and B.ACCTTYPE<>3 )  for read only   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP)   SELECT DISTINCT '+''''+@USERID + ''''+',''aaGLDist'',''Journal Entry=''+LTRIM(STR(A.JRNENTRY))+SPACE(3)+''aaGLHdrID=''+LTRIM(STR(A.aaGLHdrID))+SPACE(3)+''aaGLDistID=''+LTRIM(STR(A1.aaGLDistID)),5,1   from AAG30001 A1 inner join AAG30000 A on A1.aaGLHdrID = A.aaGLHdrID  and ltrim(rtrim(SOURCDOC)) = ''''  inner join (select (select case when count(SEQNUMBR) > 1 then 3 else 1 end from GL20000 Der   where Der.JRNENTRY = GL20000.JRNENTRY and Der.SEQNUMBR = GL20000.SEQNUMBR and Der.RCTRXSEQ = GL20000.RCTRXSEQ) ACCTTYPE, *  from GL20000) B   on  A.aaGLTRXSource =B.TRXSORCE and B.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''')   and A.JRNENTRY = B.JRNENTRY AND   A.aaGLTRXSource=B.TRXSORCE AND  A.RCTRXSEQ=B.RCTRXSEQ AND  A.YEAR1=B.OPENYEAR   where (A1.SEQNUMBR = B.SEQNUMBR and (A1.ACTINDX<>B.ACTINDX or   A1.DEBITAMT<>B.DEBITAMT or A1.CRDTAMNT<>B.CRDTAMNT or A1.ORDBTAMT<>B.ORDBTAMT or A1.ORCRDAMT<> B.ORCRDAMT)) and B.ACCTTYPE<>3')   open CGLOpenseq  fetch next from CGLOpenseq into @JRNENTRY,@aaGLHdrID, @l_RCTRXSEQ, @l_YEAR1, @l_aaGLTRXSource  while @@fetch_status = 0  Begin    Update AAG30001 SET aaGLDistID=0-aaGLDistID where aaGLHdrID=@aaGLHdrID  Update AAG30002 SET aaGLDistID=0-aaGLDistID where aaGLHdrID=@aaGLHdrID  Update AAG30003 SET aaGLDistID=0-aaGLDistID where aaGLHdrID=@aaGLHdrID  UPDATE AAG30002   SET aaGLDistID = (SELECT COUNT(1) FROM AAG30001 AA WHERE A1.DEX_ROW_ID >= AA.DEX_ROW_ID AND AA.aaGLHdrID = A1.aaGLHdrID) from AAG30001 A1 where AAG30002.aaGLHdrID=A1.aaGLHdrID and AAG30002.aaGLDistID=A1.aaGLDistID and A1.aaGLHdrID=@aaGLHdrID  UPDATE AAG30003  SET aaGLDistID = (SELECT COUNT(1) FROM AAG30001 AA WHERE A1.DEX_ROW_ID >= AA.DEX_ROW_ID AND AA.aaGLHdrID = A1.aaGLHdrID) from AAG30001 A1 where AAG30003.aaGLHdrID=A1.aaGLHdrID and AAG30003.aaGLDistID=A1.aaGLDistID and A1.aaGLHdrID=@aaGLHdrID  UPDATE AAG30001   SET aaGLDistID = (SELECT COUNT(1) FROM AAG30001 AA WHERE AAG30001.DEX_ROW_ID >= AA.DEX_ROW_ID AND AA.aaGLHdrID = AAG30001.aaGLHdrID) where AAG30001.aaGLHdrID=@aaGLHdrID   set @Cnt=0  Select  @CntGP= count(JRNENTRY) from GL20000 where JRNENTRY = @JRNENTRY   Select  @CntAA= count(aaGLHdrID) from AAG30001 where aaGLHdrID=@aaGLHdrID    if @CntGP>=@CntAA  Begin  SET @l=1  declare lCGLO cursor fast_forward for  select JRNENTRY, ACTINDX,DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,SEQNUMBR   from GL20000 where  JRNENTRY=@JRNENTRY   AND RCTRXSEQ = @l_RCTRXSEQ   AND OPENYEAR = @l_YEAR1   AND TRXSORCE = @l_aaGLTRXSource   group by SEQNUMBR,JRNENTRY, ACTINDX,DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT   for read only  open lCGLO  fetch next from lCGLO into @lJRNENTRY, @ACTINDX,@DEBITAMT,@CRDTAMNT,@ORDBTAMT,@ORCRDAMT,@SEQNUMBR  while @@fetch_status = 0  Begin  Update AAG30001 set SEQNUMBR=@SEQNUMBR  where aaGLHdrID = @aaGLHdrID and aaGLDistID = @l  set @l=@l+1  fetch next from lCGLO into @lJRNENTRY, @ACTINDX,@DEBITAMT,@CRDTAMNT,@ORDBTAMT,@ORCRDAMT,@SEQNUMBR  end   close lCGLO  deallocate lCGLO  End  Create table #AAGLODistID(DistID int,rowID int not null identity)  SET @k=1  While  @CntAA>=@k  Begin   if @Cnt=@CntGP Break  SET @l=1  declare lCGLO cursor fast_forward for  select JRNENTRY, ACTINDX,DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,SEQNUMBR   from GL20000 where  JRNENTRY=@JRNENTRY   AND RCTRXSEQ = @l_RCTRXSEQ   AND OPENYEAR = @l_YEAR1   AND TRXSORCE = @l_aaGLTRXSource   group by SEQNUMBR,JRNENTRY, ACTINDX,DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT   for read only  open lCGLO  fetch next from lCGLO into @lJRNENTRY, @ACTINDX,@DEBITAMT,@CRDTAMNT,@ORDBTAMT,@ORCRDAMT,@SEQNUMBR  while @@fetch_status = 0 and  @CntAA >= @l  Begin  set @counter=0  if @k = 1  Begin  select @counter=count(*) from AAG30001 A1 inner join AAG30000 A on A1.aaGLHdrID =A.aaGLHdrID   INNER JOIN GL20000 GL on GL.JRNENTRY=A.JRNENTRY  AND GL.TRXSORCE =A.aaGLTRXSource   AND A.RCTRXSEQ = GL.RCTRXSEQ  AND A.YEAR1 = GL.OPENYEAR  AND GL.SOURCDOC <> @l_cPROFIT_AND_LOSS   AND GL.SOURCDOC <>  @l_cBalSheet   where A1.ACTINDX = GL.ACTINDX and A1.CRDTAMNT  = GL.CRDTAMNT and A1.DEBITAMT = GL.DEBITAMT   and A1.ORDBTAMT=GL.ORDBTAMT and   A1.ORCRDAMT= GL.ORCRDAMT and GL.SEQNUMBR=@SEQNUMBR and GL.ACTINDX=@ACTINDX and GL.DEBITAMT=@DEBITAMT and A.aaGLHdrID =@aaGLHdrID   and GL.CRDTAMNT=@CRDTAMNT and GL.ORDBTAMT=@ORDBTAMT and GL.ORCRDAMT=@ORCRDAMT and GL.JRNENTRY=@lJRNENTRY and A1.aaGLDistID = @k  end   else  begin   select @counter=count(*)  from AAG30001 A1 inner join AAG30000 A on A1.aaGLHdrID =A.aaGLHdrID   inner join GL20000 GL on GL.JRNENTRY=A.JRNENTRY  and GL.TRXSORCE =A.aaGLTRXSource   AND A.RCTRXSEQ = GL.RCTRXSEQ  AND A.YEAR1 = GL.OPENYEAR  and GL.SOURCDOC <> @l_cPROFIT_AND_LOSS   and GL.SOURCDOC <>  @l_cBalSheet   where A1.ACTINDX = GL.ACTINDX and A1.CRDTAMNT  = GL.CRDTAMNT and A1.DEBITAMT = GL.DEBITAMT   and A1.ORDBTAMT=GL.ORDBTAMT and   A1.ORCRDAMT= GL.ORCRDAMT and GL.SEQNUMBR=@SEQNUMBR and GL.ACTINDX=@ACTINDX and GL.DEBITAMT=@DEBITAMT and A.aaGLHdrID =@aaGLHdrID   and GL.CRDTAMNT=@CRDTAMNT and GL.ORDBTAMT=@ORDBTAMT and GL.ORCRDAMT=@ORCRDAMT and GL.JRNENTRY=@lJRNENTRY and A1.aaGLDistID = @k  and GL.SEQNUMBR not in   (select SEQNUMBR from AAG30001 where aaGLDistID in (select DistID from #AAGLODistID) and aaGLHdrID =@aaGLHdrID and ACCTTYPE<>3)  end   if @counter = 1   Begin  insert into #AAGLODistID(DistID) VALUES(@l)  Select @Cnt = @Cnt + 1   Break  end   SET  @l = @l + 1  fetch next from lCGLO into @lJRNENTRY, @ACTINDX,@DEBITAMT,@CRDTAMNT,@ORDBTAMT,@ORCRDAMT,@SEQNUMBR  end   close lCGLO  deallocate lCGLO  SET  @k = @k + 1  End   SET @j=1  Update AAG30001 SET aaGLDistID=0-aaGLDistID  where aaGLHdrID=@aaGLHdrID  Update AAG30002 SET aaGLDistID=0-aaGLDistID  where aaGLHdrID=@aaGLHdrID  Update AAG30003 SET aaGLDistID=0-aaGLDistID  where aaGLHdrID=@aaGLHdrID   declare lCGLO cursor fast_forward for  select JRNENTRY, ACTINDX,DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,SEQNUMBR   from GL20000 where  JRNENTRY=@JRNENTRY   AND RCTRXSEQ = @l_RCTRXSEQ   AND OPENYEAR = @l_YEAR1   AND TRXSORCE = @l_aaGLTRXSource   group by SEQNUMBR,JRNENTRY, ACTINDX,DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT   for read only  open lCGLO  fetch next from lCGLO into @lJRNENTRY, @ACTINDX,@DEBITAMT,@CRDTAMNT,@ORDBTAMT,@ORCRDAMT,@SEQNUMBR  while @@fetch_status = 0 and  @CntAA>=@j  Begin   Select  @DistID = ltrim(rtrim(STR(rowID))) from  #AAGLODistID where DistID=@j   Update AAG30001 SET SEQNUMBR= ltrim(rtrim(str(@SEQNUMBR)))where aaGLHdrID= ltrim(rtrim(str(@aaGLHdrID))) and aaGLDistID=(-@DistID)  Update AAG30001 SET aaGLDistID= ltrim(rtrim(str(@j))) where aaGLHdrID= ltrim(rtrim(str(@aaGLHdrID)))and aaGLDistID=(-@DistID)  Update AAG30002 SET aaGLDistID= ltrim(rtrim(str(@j))) where aaGLHdrID= ltrim(rtrim(str(@aaGLHdrID))) and aaGLDistID=(-@DistID)  Update AAG30003 SET aaGLDistID= ltrim(rtrim(str(@j)))  where aaGLHdrID= ltrim(rtrim(str(@aaGLHdrID))) and aaGLDistID=(-@DistID)   SET  @j = @j + 1  fetch next from lCGLO into @lJRNENTRY, @ACTINDX,@DEBITAMT,@CRDTAMNT,@ORDBTAMT,@ORCRDAMT,@SEQNUMBR  End   Drop table #AAGLODistID  close lCGLO  deallocate lCGLO   Update AAG30001 SET aaGLDistID=@CntGP-aaGLDistID  where aaGLHdrID=@aaGLHdrID and aaGLDistID < 0  Update AAG30002 SET aaGLDistID=@CntGP-aaGLDistID  where aaGLHdrID=@aaGLHdrID and aaGLDistID < 0  Update AAG30003 SET aaGLDistID=@CntGP-aaGLDistID  where aaGLHdrID=@aaGLHdrID and aaGLDistID < 0   UPDATE AAG30002   SET aaGLDistID = @CntGP+(SELECT COUNT(1) FROM AAG30001 AA WHERE A1.DEX_ROW_ID >= AA.DEX_ROW_ID AND AA.aaGLHdrID = A1.aaGLHdrID) from AAG30001 A1 where AAG30002.aaGLHdrID=A1.aaGLHdrID and AAG30002.aaGLDistID=A1.aaGLDistID  and  AAG30002.aaGLHdrID = @aaGLHdrID and AAG30002.aaGLDistID>@CntGP  UPDATE AAG30003  SET aaGLDistID = @CntGP+(SELECT COUNT(1) FROM AAG30001 AA WHERE A1.DEX_ROW_ID >= AA.DEX_ROW_ID  AND AA.aaGLHdrID = A1.aaGLHdrID) from AAG30001 A1 where AAG30003.aaGLHdrID=A1.aaGLHdrID and AAG30003.aaGLDistID=A1.aaGLDistID  and AAG30003.aaGLHdrID = @aaGLHdrID and AAG30003.aaGLDistID>@CntGP   if (select Distinct count(aaGLDistID) from AAG30002 where aaGLHdrID=@aaGLHdrID)   = ( select count(GL20000.JRNENTRY) from GL20000,AAG30000   where GL20000.TRXSORCE =AAG30000.aaGLTRXSource   AND AAG30000.RCTRXSEQ = GL20000.RCTRXSEQ  AND AAG30000.YEAR1 = GL20000.OPENYEAR  and GL20000.SOURCDOC <> @l_cPROFIT_AND_LOSS   and GL20000.SOURCDOC <>  @l_cBalSheet   and AAG30000.JRNENTRY=GL20000.JRNENTRY   and GL20000.JRNENTRY =@JRNENTRY  AND GL20000.RCTRXSEQ = @l_RCTRXSEQ   AND GL20000.OPENYEAR = @l_YEAR1   AND GL20000.TRXSORCE = @l_aaGLTRXSource)  Begin  SET @k=1  SET  @j = 0  Select  @CntAA= count(aaGLHdrID) FROM AAG30002 WHERE aaGLHdrID = @aaGLHdrID and aaGLDistID>@CntGP  While  @CntAA > @k  Begin  if exists(select (aaGLDistID) from AAG30002 where aaGLHdrID=@aaGLHdrID and aaGLDistID=@k+@j)  Begin  SET @j=@j+1  continue   end   else  Begin  UPDATE AAG30002   SET aaGLDistID = @k+@j  WHERE aaGLHdrID = @aaGLHdrID and aaGLDistID=@CntGP+@k  UPDATE AAG30003  SET aaGLDistID = @k+@j  WHERE aaGLHdrID = @aaGLHdrID and aaGLDistID=@CntGP+@k  SET @k=@k+1   end   End  End   fetch next from CGLOpenseq into  @JRNENTRY,@aaGLHdrID, @l_RCTRXSEQ, @l_YEAR1, @l_aaGLTRXSource  End   CLOSE CGLOpenseq  DEALLOCATE CGLOpenseq  Begin   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP)   SELECT DISTINCT '+''''+@USERID + ''''+',''aaGLCode'',''aaGLHdrID=''+LTRIM(STR(A1.aaGLHdrID ))+SPACE(3)+''Journal Entry=''+LTRIM(STR(A.JRNENTRY)) ,4,1   FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(SOURCDOC)) = ''''   LEFT JOIN GL20000 GL   ON GL.JRNENTRY=A.JRNENTRY   AND A1.SEQNUMBR=GL.SEQNUMBR  AND GL.TRXSORCE =A.aaGLTRXSource   AND A.RCTRXSEQ = GL.RCTRXSEQ  AND A.YEAR1 = GL.OPENYEAR  AND GL.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''') AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   WHERE A1.aaGLDistID > (SELECT count(JRNENTRY) FROM GL20000 C   WHERE C.JRNENTRY = A.JRNENTRY   AND C.TRXSORCE =A.aaGLTRXSource   AND A.RCTRXSEQ = C.RCTRXSEQ  AND A.YEAR1 = C.OPENYEAR  AND C.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + '''))')    Delete AAG30001   FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(SOURCDOC)) = ''   LEFT JOIN GL20000 GL   ON GL.JRNENTRY=A.JRNENTRY   AND A1.SEQNUMBR=GL.SEQNUMBR  AND GL.TRXSORCE =A.aaGLTRXSource   AND A.RCTRXSEQ = GL.RCTRXSEQ  AND A.YEAR1 = GL.OPENYEAR  AND GL.SOURCDOC <> @l_cPROFIT_AND_LOSS   and GL.SOURCDOC <>  @l_cBalSheet   AND A1.ACTINDX = GL.ACTINDX   AND A1.CRDTAMNT  = GL.CRDTAMNT   AND A1.DEBITAMT = GL.DEBITAMT   WHERE A1.aaGLDistID > ( SELECT count(JRNENTRY) FROM GL20000 C   WHERE C.JRNENTRY = A.JRNENTRY   AND C.TRXSORCE =A.aaGLTRXSource   AND A.RCTRXSEQ = C.RCTRXSEQ  AND A.YEAR1 = C.OPENYEAR  AND C.SOURCDOC <> @l_cPROFIT_AND_LOSS   and C.SOURCDOC <>  @l_cBalSheet )   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP)   SELECT DISTINCT '+''''+@USERID + ''''+',''aaGLCode'',''aaGLHdrID=''+LTRIM(STR(A2.aaGLHdrID ))+SPACE(3)+''aaGLDistID=''+LTRIM(STR(A2.aaGLDistID)),4,1   from AAG30002 A2 where A2.aaGLDistID not in (select A1.aaGLDistID from   AAG30001 A1 where A1.aaGLHdrID=A2.aaGLHdrID)')   Delete AAG30002 from AAG30002 A2 where A2.aaGLDistID not in (select A1.aaGLDistID from   AAG30001 A1 where A1.aaGLHdrID=A2.aaGLHdrID)    EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP)   SELECT DISTINCT '+''''+@USERID + ''''+',''aaGLCode'',''aaGLHdrID=''+LTRIM(STR(A3.aaGLHdrID ))+SPACE(3)+''aaGLDistID=''+LTRIM(STR(A3.aaGLDistID)),4,1   FROM AAG30003 A3 WHERE A3.aaGLDistID NOT IN (SELECT A1.aaGLDistID FROM   AAG30001 A1 WHERE A1.aaGLHdrID=A3.aaGLHdrID)')   Delete AAG30003  from AAG30003 A3 where A3.aaGLDistID not in (select A1.aaGLDistID from   AAG30001 A1 where A1.aaGLHdrID=A3.aaGLHdrID)   End   set nocount off  END    
GO
GRANT EXECUTE ON  [dbo].[aagGenericGLOpenseq] TO [DYNGRP]
GO
