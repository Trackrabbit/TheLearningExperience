SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create           procedure [dbo].[aagSOP_DIST_DELETE]  @SOPType integer,   @SOPNumber char(21) ,   @HdrID integer ,  @nStatus integer out as begin  declare @SeqNumbr integer,  @Cnt integer,   @DistID integer,  @LaaSubLedgerDistID integer,   @LACTINDX integer,  @Cnt1 int   select @SeqNumbr = 0,  @Cnt = 0,   @DistID = 0,  @LaaSubLedgerDistID = 0,   @LACTINDX = 0,  @Cnt1 = 0   select @Cnt1 = count(*) from SOP10200 where SOPTYPE = @SOPType and   SOPNUMBE = @SOPNumber  if @Cnt1 = 0  begin  delete from AAG20001 where aaSubLedgerHdrID = @HdrID and aaSubLedgerDistID > 0  delete from AAG20002 where aaSubLedgerHdrID = @HdrID and aaSubLedgerDistID > 0   delete from AAG20003 where aaSubLedgerHdrID = @HdrID and aaSubLedgerDistID > 0   return  end   declare aaCSubLedgDist cursor fast_forward FOR  Select SEQNUMBR, aaSubLedgerDistID from AAG20001   where aaSubLedgerHdrID = @HdrID and aaSubLedgerDistID >= 0 and   aaFutureDist  = 0   order by SEQNUMBR   open aaCSubLedgDist  fetch next from aaCSubLedgDist into @SeqNumbr, @DistID   while @@fetch_status = 0  begin  Select @Cnt = count(*) from SOP10102   where SOPTYPE = @SOPType and  SOPNUMBE = @SOPNumber and  SEQNUMBR = @SeqNumbr  if @Cnt <> 1   begin  exec aagDelSubLedgerDist @HdrID,@DistID   end   fetch next from aaCSubLedgDist into @SeqNumbr, @DistID   end   close aaCSubLedgDist  deallocate aaCSubLedgDist   declare aaCAADIST cursor fast_forward for  Select aaSubLedgerDistID,ACTINDX from AAG20001  where aaSubLedgerHdrID = @HdrID and  aaSubLedgerDistID > 0 and aaFutureDist = 1   open aaCAADIST  fetch next from aaCAADIST into @LaaSubLedgerDistID , @LACTINDX  while @@fetch_status = 0  begin   if not exists(Select INVINDX ,CSLSINDX from SOP10200 where SOPTYPE = @SOPType and   SOPNUMBE = @SOPNumber and LNITMSEQ >= 0 and CMPNTSEQ >= 0 and   UNITCOST <> 0 and INVINDX = @LACTINDX or   CSLSINDX = @LACTINDX)  begin  delete from AAG20001 where aaSubLedgerHdrID = @HdrID and   aaSubLedgerDistID = @LaaSubLedgerDistID  delete from AAG20002 where aaSubLedgerHdrID = @HdrID and   aaSubLedgerDistID = @LaaSubLedgerDistID and   aaSubLedgerAssignID = 1   delete from AAG20003 where aaSubLedgerHdrID = @HdrID and   aaSubLedgerDistID = @LaaSubLedgerDistID and   aaSubLedgerAssignID = 1 and aaTrxDimID >=0   end   fetch next from aaCAADIST into @LaaSubLedgerDistID , @LACTINDX  end   close aaCAADIST  deallocate aaCAADIST  Select @Cnt = count(*) from SOP10200 where SOPTYPE = @SOPType and   SOPNUMBE = @SOPNumber and LNITMSEQ >= 0 and CMPNTSEQ >= 0 and   UNITCOST <> 0  if @Cnt = 0   begin  delete from AAG20003 where aaSubLedgerHdrID = @HdrID and   aaSubLedgerDistID in (Select aaSubLedgerDistID from AAG20001  where    aaSubLedgerHdrID = @HdrID and   aaSubLedgerDistID >0 and aaFutureDist = 1 )  and aaSubLedgerAssignID = 1 and aaTrxDimID >=0   delete from AAG20002 where aaSubLedgerHdrID = @HdrID and   aaSubLedgerDistID in (Select aaSubLedgerDistID from AAG20001  where    aaSubLedgerHdrID = @HdrID and   aaSubLedgerDistID >0 and aaFutureDist = 1 )  and  aaSubLedgerAssignID = 1   delete from AAG20001 where aaSubLedgerHdrID = @HdrID and   aaSubLedgerDistID >0 and aaFutureDist  = 1  end  end    
GO
GRANT EXECUTE ON  [dbo].[aagSOP_DIST_DELETE] TO [DYNGRP]
GO
