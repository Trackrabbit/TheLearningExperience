SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE Procedure [dbo].[SVC_RTV_Update_RMAProcessStatus]  (  @RTV char(15),  @RTVLine numeric(19,5),  @ProcessStatus char(3),  @Return_Disposition_Statu smallint,  @CMPNTSEQ int = 0 output ) as  declare @svcRMAComponentSeq int declare @RMANumber char(15),   @Line Numeric(19,5),  @ProcessQty numeric(19,5),  @FromQtyType smallint  if exists(select * from SVC05210 where SVC_Document_Number = @RTV and SVC_IV_SEQ_Number = @RTVLine  and SVC_Process_QTY > 0 and SVC_Process_Type = 2 )  begin  select @svcRMAComponentSeq = CMPNTSEQ, @RMANumber = RETDOCID, @Line = LNSEQNBR, @FromQtyType = QTYTYPE from SVC05210   where SVC_Document_Number = @RTV and SVC_IV_SEQ_Number = @RTVLine  and SVC_Process_QTY > 0 and SVC_Process_Type = 2  select @ProcessQty = sum(SVC_Process_QTY) from SVC05210   where SVC_Document_Number = @RTV and SVC_IV_SEQ_Number = @RTVLine and SVC_Process_QTY > 0 and SVC_Process_Type = 2  update SVC05210 with (rowlock) set SVC_Process_Status = @ProcessStatus,   Return_Disposition_Statu = @Return_Disposition_Statu  where SVC_Document_Number = @RTV and SVC_IV_SEQ_Number = @RTVLine  and SVC_Process_QTY > 0 and SVC_Process_Type = 2  if @Return_Disposition_Statu = 2 and exists(select 1 from SVC05200 where RETDOCID = @RMANumber and LNSEQNBR = @Line and svcRMAComponentSeq = @svcRMAComponentSeq)  update SVC05200 with (rowlock) set RMA_Status = 8  where RETDOCID = @RMANumber and LNSEQNBR = @Line and svcRMAComponentSeq = @svcRMAComponentSeq  if @FromQtyType > 1 and @Return_Disposition_Statu = 1   begin  update SVC05210 with (rowlock) set QTYTYPE = 1  where SVC_Document_Number = @RTV and SVC_IV_SEQ_Number = @RTVLine and SVC_Process_QTY > 0 and SVC_Process_Type = 2  if exists(select * from SVC05255 where RETDOCID = @RMANumber and LNSEQNBR = @Line and CMPNTSEQ = @svcRMAComponentSeq and QTYTYPE = @FromQtyType)  update SVC05255 with (rowlock) set QTYTYPE = 1  where RETDOCID = @RMANumber and LNSEQNBR = @Line and CMPNTSEQ = @svcRMAComponentSeq and QTYTYPE = @FromQtyType  if exists(select * from SVC05212 where RETDOCID = @RMANumber and LNSEQNBR = @Line and CMPNTSEQ = @svcRMAComponentSeq and QTYTYPE = @FromQtyType)  update SVC05212 with (rowlock) set QTYTYPE = 1  where RETDOCID = @RMANumber and LNSEQNBR = @Line and CMPNTSEQ = @svcRMAComponentSeq and QTYTYPE = @FromQtyType  update SVC05200 with (rowlock) set QTYONHND = QTYONHND + @ProcessQty,  QTYRTRND = case when @FromQtyType = 2 then QTYRTRND - @ProcessQty else QTYRTRND end ,  QTYINUSE = case when @FromQtyType = 3 then QTYINUSE - @ProcessQty else QTYINUSE end,  QTYINSVC = case when @FromQtyType = 4 then QTYINSVC - @ProcessQty else QTYINSVC end,  QTYDMGED = case when @FromQtyType = 5 then QTYDMGED - @ProcessQty else QTYDMGED end   where RETDOCID = @RMANumber and LNSEQNBR = @Line and svcRMAComponentSeq = @svcRMAComponentSeq  end  end select @CMPNTSEQ = isnull(@svcRMAComponentSeq,0)  return    
GO
GRANT EXECUTE ON  [dbo].[SVC_RTV_Update_RMAProcessStatus] TO [DYNGRP]
GO
