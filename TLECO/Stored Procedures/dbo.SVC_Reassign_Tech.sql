SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_Reassign_Tech] ( @Old_Tech char(11), @New_Tech char(11), @UpdateEquipment tinyint, @UpdateCustomer tinyint, @UpdateServiceCall tinyint ) AS  declare @count int declare @lineseq int declare @EQUIPID int declare @CALLNBR char(11)  if @UpdateEquipment = 1 begin  UPDATE SVC00300 SET TECHID =  @New_Tech where  TECHID = @Old_Tech   declare cursor_307 cursor for select distinct EQUIPID from SVC00307 where TECHID = @Old_Tech  open cursor_307  FETCH NEXT FROM cursor_307 INTO @EQUIPID  while @@FETCH_STATUS = 0  BEGIN  UPDATE SVC00307 SET TECHID = @New_Tech where EQUIPID = @EQUIPID and TECHID = @Old_Tech  select @count = count(*) from SVC00307 where EQUIPID = @EQUIPID and TECHID = @New_Tech  if @count > 1  begin   select @lineseq = LNITMSEQ from SVC00307 where EQUIPID = @EQUIPID and TECHID = @New_Tech  delete SVC00307 where EQUIPID = @EQUIPID and TECHID = @New_Tech and LNITMSEQ <> @lineseq  end  select @count = count(*) from SVC00307 where EQUIPID = @EQUIPID  if @count = 1  begin  delete SVC00307 where EQUIPID = @EQUIPID  update SVC00300 set TECHID = @New_Tech where EQUIPID = @EQUIPID  end  FETCH NEXT FROM cursor_307 INTO @EQUIPID  END  deallocate cursor_307 end  if @UpdateServiceCall = 1 begin  UPDATE SVC00200 SET SVC00200.TECHID = @New_Tech where SVC00200.SRVRECTYPE = 2 and SVC00200.TECHID = @Old_Tech   declare cursor_207 cursor for select distinct CALLNBR from SVC00207 where SRVRECTYPE = 2 and TECHID = @Old_Tech  open cursor_207  FETCH NEXT FROM cursor_207 INTO @CALLNBR  while @@FETCH_STATUS = 0  BEGIN  UPDATE SVC00207 SET TECHID = @New_Tech where SRVRECTYPE = 2 and CALLNBR = @CALLNBR and TECHID = @Old_Tech  select @count = count(*) from SVC00207 where SRVRECTYPE = 2 and CALLNBR = @CALLNBR and TECHID = @New_Tech  if @count > 1  begin   select @lineseq = LNITMSEQ from SVC00207 where SRVRECTYPE = 2 and CALLNBR = @CALLNBR and TECHID = @New_Tech  delete SVC00207 where SRVRECTYPE = 2 and CALLNBR = @CALLNBR and TECHID = @New_Tech and LNITMSEQ <> @lineseq  end  select @count = count(*) from SVC00207 where SRVRECTYPE = 2 and CALLNBR = @CALLNBR  if @count = 1  begin  delete SVC00207 where SRVRECTYPE = 2 and CALLNBR = @CALLNBR  update SVC00200 set TECHID = @New_Tech where SRVRECTYPE = 2 and CALLNBR = @CALLNBR  end  FETCH NEXT FROM cursor_207 INTO @CALLNBR  END  deallocate cursor_207 end  if @UpdateCustomer = 1 begin  UPDATE SVC00950 SET SVC00950.TECHID =  @New_Tech where  SVC00950.TECHID = @Old_Tech end   
GO
GRANT EXECUTE ON  [dbo].[SVC_Reassign_Tech] TO [DYNGRP]
GO
