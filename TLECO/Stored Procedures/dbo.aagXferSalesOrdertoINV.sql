SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aagXferSalesOrdertoINV]  @aaSubLedgerHdrID INT ,  @SOPTYPE INT ,  @SOPNUMBR VARCHAR(100) ,  @l_ErrorCode SMALLINT = NULL OUTPUT AS BEGIN   DECLARE @DocNo VARCHAR(100),   @DepIndx INT,   @aaSubLedgerDistID INT,   @ACTINDX INT,   @OldaaSubLedgerAssignID INT,  @NEWSubLedgerAssignID INT,  @OLDaaSubLedgerHdrID INT,  @DEBITAMT NUMERIC(19,5),   @CRDTAMNT NUMERIC(19,5),  @ORDBTAMT NUMERIC(19,5),   @ORCRDAMT NUMERIC(19,5),  @AssignID INT,  @AssignPercent INT   DECLARE CursorSubLedg CURSOR LOCAL FOR   SELECT aaSubLedgerDistID, ACTINDX, DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT FROM AAG20001 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND DISTTYPE = 21  OPEN CursorSubLedg  FETCH NEXT FROM CursorSubLedg INTO @aaSubLedgerDistID ,@ACTINDX, @DEBITAMT, @CRDTAMNT, @ORDBTAMT, @ORCRDAMT  WHILE @@FETCH_STATUS = 0  BEGIN  DELETE FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID  DELETE FROM AAG20003 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID   DECLARE  CursorSOPPayment  CURSOR LOCAL FOR SELECT DOCNUMBR FROM SOP10103 WHERE SOPNUMBE = @SOPNUMBR and SOPTYPE = @SOPTYPE AND DEPINDEX = @ACTINDX  open CursorSOPPayment  FETCH NEXT FROM CursorSOPPayment INTO @DocNo  WHILE @@FETCH_STATUS = 0  BEGIN  SELECT  @OLDaaSubLedgerHdrID = aaSubLedgerHdrID FROM AAG20000 WHERE DOCNUMBR = @DocNo AND DOCTYPE = @SOPTYPE   DECLARE CursorAAAssignment CURSOR LOCAL FOR SELECT aaSubLedgerAssignID FROM AAG20002 WHERE aaSubLedgerHdrID = @OLDaaSubLedgerHdrID and aaSubLedgerDistID = 2  open CursorAAAssignment  FETCH NEXT FROM CursorAAAssignment INTO @OldaaSubLedgerAssignID  WHILE @@FETCH_STATUS = 0  BEGIN  SELECT @NEWSubLedgerAssignID = ISNULL(MAX(aaSubLedgerAssignID),0) + 1 FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID   INSERT INTO AAG20002 ([aaSubLedgerHdrID], [aaSubLedgerDistID], [aaSubLedgerAssignID], [DEBITAMT], [ORDBTAMT], [CRDTAMNT], [ORCRDAMT], [aaAssignedPercent], [DistRef], [NOTEINDX], [aaAssignErrors], [aaAliasID])  SELECT @aaSubLedgerHdrID, @aaSubLedgerDistID, @NEWSubLedgerAssignID, [CRDTAMNT], [ORCRDAMT], [DEBITAMT], [ORDBTAMT], [aaAssignedPercent], [DistRef], [NOTEINDX], [aaAssignErrors], [aaAliasID]  FROM AAG20002  WHERE aaSubLedgerHdrID = @OLDaaSubLedgerHdrID AND aaSubLedgerDistID=2 AND aaSubLedgerAssignID = @OldaaSubLedgerAssignID   INSERT INTO AAG20003 ([aaSubLedgerHdrID], [aaSubLedgerDistID], [aaSubLedgerAssignID], [aaTrxDimID], [aaTrxCodeID], [aaCodeErrors])  SELECT @aaSubLedgerHdrID, @aaSubLedgerDistID, @NEWSubLedgerAssignID, [aaTrxDimID], [aaTrxCodeID], [aaCodeErrors]  FROM AAG20003  WHERE aaSubLedgerHdrID = @OLDaaSubLedgerHdrID AND aaSubLedgerDistID=2 AND aaSubLedgerAssignID = @OldaaSubLedgerAssignID   FETCH NEXT FROM CursorAAAssignment INTO @OldaaSubLedgerAssignID   END  CLOSE CursorAAAssignment  DEALLOCATE CursorAAAssignment   FETCH NEXT FROM CursorSOPPayment INTO @DocNo   END  CLOSE CursorSOPPayment  DEALLOCATE CursorSOPPayment  UPDATE AAG20002 SET aaAssignedPercent = ROUND(((ORDBTAMT+ORCRDAMT)* 10000)/(@ORDBTAMT+@ORCRDAMT),2)  WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID   SET @AssignID = (SELECT Max(A.aaSubLedgerAssignID) FROM AAG20002 A WHERE A.aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID )  SET @AssignPercent = (SELECT SUM(aaAssignedPercent) FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID)  IF @AssignPercent <> 0 AND @AssignPercent > 9990   BEGIN  UPDATE AAG20002 SET aaAssignedPercent = aaAssignedPercent + (10000 - @AssignPercent) FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND   aaSubLedgerDistID = @aaSubLedgerDistID AND aaSubLedgerAssignID = @AssignID  END   FETCH NEXT FROM CursorSubLedg INTO @aaSubLedgerDistID ,@ACTINDX, @DEBITAMT, @CRDTAMNT, @ORDBTAMT, @ORCRDAMT  END  CLOSE CursorSubLedg  DEALLOCATE CursorSubLedg END    
GO
GRANT EXECUTE ON  [dbo].[aagXferSalesOrdertoINV] TO [DYNGRP]
GO
