SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[rmCustomerCombinerMaster]  @I_charStartCustomer char(30),  @I_charEndCustomer char(30),  @O_iErrorState int=NULL  output  as  set transaction isolation level read uncommitted set nocount on  declare @ORTRXAMT numeric(19,5),  @CURTRXAM numeric(19,5),  @SLSAMNT numeric(19,5),  @COSTAMNT numeric(19,5),  @FRTAMNT numeric(19,5),  @MISCAMNT numeric(19,5),  @TAXAMNT numeric(19,5),  @COMDLRAM numeric(19,5),  @CASHAMNT numeric(19,5),  @DISTKNAM numeric(19,5),  @DISAVAMT numeric(19,5),  @DISAVTKN numeric(19,5),  @DISCRTND numeric(19,5),  @DSCDLRAM numeric(19,5),  @WROFAMNT numeric(19,5),  @PPSAMDED numeric(19,5),  @GSTDSAMT numeric(19,5),  @TRDISAMT numeric(19,5),  @LEN1 tinyint,  @LEN2 tinyint,  @BALNCTYP int,  @CUSTNMBR char (255),  @maxvalueCUST1 numeric(19,5),  @maxvalueCUST2 numeric(19,5),  @LASTAGED datetime,  @FRSTINDT datetime,  @LSTNSFCD datetime,  @LPYMTAMT numeric(19,5),  @LASTPYDT datetime,  @LSTTRXDT datetime,  @LSTTRXAM numeric(19,5),  @LSTFCHAM numeric(19,5),  @AVDTPLYR numeric(19,5),  @AVDTPLIF numeric(19,5),  @AVGDTPYR numeric(19,5),  @HIBALLYR numeric(19,5),  @HIBALYTD numeric(19,5),  @HIBALLTD numeric(19,5),  @LASTSTDT datetime,  @LSTSTAMT numeric (19,5),  @I_charADRSCODE char (30),  @tTransaction tinyint,  @iStatus int,  @cStartCustomer char (50),  @cEndCustomer char(50)  select @LEN1=0,  @LEN2=0,  @ORTRXAMT=0,  @CURTRXAM=0,  @SLSAMNT=0,  @COSTAMNT=0,  @FRTAMNT=0,  @MISCAMNT=0,  @TAXAMNT=0,  @COMDLRAM=0,  @CASHAMNT=0,  @DISTKNAM=0,  @DISAVAMT=0,  @DISAVTKN=0,  @DISCRTND=0,  @DSCDLRAM=0,  @WROFAMNT=0,  @PPSAMDED=0,  @GSTDSAMT=0,  @TRDISAMT=0  exec @iStatus=smFormatStringsForExecs  @I_vInputString=@I_charStartCustomer,  @O_cOutputString=@cStartCustomer output,  @O_iErrorState=@O_iErrorState output if @iStatus<>0 or @O_iErrorState<>0 begin  set @O_iErrorState=1  return end  exec @iStatus=smFormatStringsForExecs  @I_vInputString=@I_charEndCustomer,  @O_cOutputString=@cEndCustomer output,  @O_iErrorState=@O_iErrorState output if @iStatus<>0 or @O_iErrorState<>0 begin  set @O_iErrorState=2  return end  select @O_iErrorState=0  exec @iStatus=rmCustomerCombinerPre  @I_charStartCustomer output,  @I_charEndCustomer output,  @cStartCustomer output,  @cEndCustomer output,  @O_iErrorState output if @O_iErrorState<>0 or @@error<>0 begin  select @O_iErrorState=99  return end  if @I_charStartCustomer is NULL or  @I_charEndCustomer is NULL or  @cStartCustomer is NULL or  @cEndCustomer is NULL begin  select @O_iErrorState=3   return end  CREATE TABLE dbo.#tmpRM00104 (  PERIODID smallint NOT NULL,  YEAR1 smallint NOT NULL,  HISTTYPE smallint NOT NULL,  NUMOFINV int NOT NULL,  SMRYSALS numeric(19,5) NOT NULL,  SMRYCRCD numeric(19,5) NOT NULL,  SMRYCOST numeric(19,5) NOT NULL,  SMRYWROF numeric(19,5) NOT NULL,  SMRYDISC numeric(19,5) NOT NULL,  SMRYRTNG numeric(19,5) NOT NULL,  SMRYFCHR numeric(19,5) NOT NULL,  SMRYWFCH numeric(19,5) NOT NULL,  SMRYRTRN numeric(19,5) NOT NULL) if @@error<>0 begin  select @O_iErrorState=10   return end  update a set   a.TNSFCLIF=a.TNSFCLIF+b.TNSFCLIF,  a.NONSFLIF=a.NONSFLIF+b.NONSFLIF,  a.CUSTBLNC=a.CUSTBLNC+b.CUSTBLNC,   a.AGPERAMT_1=a.AGPERAMT_1+b.AGPERAMT_1,  a.AGPERAMT_2=a.AGPERAMT_2+b.AGPERAMT_2,  a.AGPERAMT_3=a.AGPERAMT_3+b.AGPERAMT_3,  a.AGPERAMT_4=a.AGPERAMT_4+b.AGPERAMT_4,  a.AGPERAMT_5=a.AGPERAMT_5+b.AGPERAMT_5,  a.AGPERAMT_6=a.AGPERAMT_6+b.AGPERAMT_6,  a.AGPERAMT_7=a.AGPERAMT_7+b.AGPERAMT_7,  a.UPFCHYTD=a.UPFCHYTD+b.UPFCHYTD,  a.NUMADTPY=a.NUMADTPY+b.NUMADTPY,  a.TDTKNYTD=a.TDTKNYTD+b.TDTKNYTD,  a.NUMADTPL=a.NUMADTPL+b.NUMADTPL,  a.TDTKNLYR=a.TDTKNLYR+b.TDTKNLYR,  a.TDTKNLTD=a.TDTKNLTD+b.TDTKNLTD,  a.TDISAYTD=a.TDISAYTD+b.TDISAYTD,  a.RETAINAG=a.RETAINAG+b.RETAINAG,  a.TNSFCYTD=a.TNSFCYTD+b.TNSFCYTD,  a.UNPSTDSA=a.UNPSTDSA+b.UNPSTDSA,  a.NONSFYTD=a.NONSFYTD+b.NONSFYTD,  a.UNPSTDCA=a.UNPSTDCA+b.UNPSTDCA,  a.UNPSTOSA=a.UNPSTOSA+b.UNPSTOSA,  a.UNPSTOCA=a.UNPSTOCA+b.UNPSTOCA,  a.NCSCHPMT=a.NCSCHPMT+b.NCSCHPMT,  a.TTLSLYTD=a.TTLSLYTD+b.TTLSLYTD,  a.TTLSLLTD=a.TTLSLLTD+b.TTLSLLTD,  a.TTLSLLYR=a.TTLSLLYR+b.TTLSLLYR,  a.TCOSTYTD=a.TCOSTYTD+b.TCOSTYTD,  a.TCOSTLTD=a.TCOSTLTD+b.TCOSTLTD,  a.TCOSTLYR=a.TCOSTLYR+b.TCOSTLYR,  a.TCSHRYTD=a.TCSHRYTD+b.TCSHRYTD,  a.TCSHRLTD=a.TCSHRLTD+b.TCSHRLTD,  a.TCSHRLYR=a.TCSHRLYR+b.TCSHRLYR,  a.TFNCHYTD=a.TFNCHYTD+b.TFNCHYTD,  a.TFNCHLTD=a.TFNCHLTD+b.TFNCHLTD,  a.TFNCHLYR=a.TFNCHLYR+b.TFNCHLYR,  a.FNCHCYTD=a.FNCHCYTD+b.FNCHCYTD,  a.FNCHLYRC=a.FNCHLYRC+b.FNCHLYRC,  a.TBDDTYTD=a.TBDDTYTD+b.TBDDTYTD,  a.TBDDTLYR=a.TBDDTLYR+b.TBDDTLYR,  a.TBDDTLTD=a.TBDDTLTD+b.TBDDTLTD,  a.TWVFCYTD=a.TWVFCYTD+b.TWVFCYTD,  a.TWVFCLTD=a.TWVFCLTD+b.TWVFCLTD,  a.TWVFCLYR=a.TWVFCLYR+b.TWVFCLYR,  a.TWROFYTD=a.TWROFYTD+b.TWROFYTD,  a.TWROFLTD=a.TWROFLTD+b.TWROFLTD,  a.TWROFLYR=a.TWROFLYR+b.TWROFLYR,  a.TTLINYTD=a.TTLINYTD+b.TTLINYTD,  a.TTLINLTD=a.TTLINLTD+b.TTLINLTD,  a.TTLINLYR=a.TTLINLYR+b.TTLINLYR,  a.TTLFCYTD=a.TTLFCYTD+b.TTLFCYTD,  a.TTLFCLTD=a.TTLFCLTD+b.TTLFCLTD,  a.TTLFCLYR=a.TTLFCLYR+b.TTLFCLYR,  a.WROFSLIF=a.WROFSLIF+b.WROFSLIF,  a.WROFSLYR=a.WROFSLYR+b.WROFSLYR,  a.WROFSYTD=a.WROFSYTD+b.WROFSYTD,  a.DEPRECV=a.DEPRECV+b.DEPRECV,  a.ONORDAMT=a.ONORDAMT+b.ONORDAMT,  a.TTLRTYTD=a.TTLRTYTD+b.TTLRTYTD,  a.TTLRTLTD=a.TTLRTLTD+b.TTLRTLTD,  a.TTLRTLYR=a.TTLRTLYR+b.TTLRTLYR  from RM00103 a, RM00103 b  where a.CUSTNMBR=@I_charEndCustomer and b.CUSTNMBR=@I_charStartCustomer if @@error<>0 begin  select @O_iErrorState=13   return end  insert into #tmpRM00104  select PERIODID,YEAR1,HISTTYPE,isnull(sum(NUMOFINV),0),isnull(sum(SMRYSALS),0),isnull(sum(SMRYCRCD),0),  isnull(sum(SMRYCOST),0),isnull(sum(SMRYWROF),0),isnull(sum(SMRYDISC),0),isnull(sum(SMRYRTNG),0),  isnull(sum(SMRYFCHR),0),isnull(sum(SMRYWFCH),0),isnull(sum(SMRYRTRN),0)   from RM00104 where CUSTNMBR=@I_charStartCustomer or CUSTNMBR=@I_charEndCustomer  group by PERIODID,YEAR1,HISTTYPE if @@error<>0 begin  select @O_iErrorState=14   return end  insert into RM00104  (CUSTNMBR,PERIODID,YEAR1,HISTTYPE,NUMOFINV,SMRYSALS,  SMRYCRCD,SMRYCOST,SMRYWROF,SMRYDISC,SMRYRTNG,SMRYFCHR,  SMRYWFCH,SMRYRTRN) select  @I_charEndCustomer,PERIODID,YEAR1,HISTTYPE,NUMOFINV,SMRYSALS,  SMRYCRCD,SMRYCOST,SMRYWROF,SMRYDISC,SMRYRTNG,SMRYFCHR,  SMRYWFCH,SMRYRTRN  from RM00104 a  where a.CUSTNMBR=@I_charStartCustomer and not exists   (select 1 from RM00104 b where b.CUSTNMBR=@I_charEndCustomer  and a.PERIODID=b.PERIODID and a.YEAR1=b.YEAR1 and a.HISTTYPE=b.HISTTYPE) if @@error<>0 begin  select @O_iErrorState=15   return end  update a set a.NUMOFINV=b.NUMOFINV,  a.SMRYSALS=b.SMRYSALS,  a.SMRYCRCD=b.SMRYCRCD,  a.SMRYCOST=b.SMRYCOST,  a.SMRYWROF=b.SMRYWROF,  a.SMRYDISC=b.SMRYDISC,  a.SMRYRTNG=b.SMRYRTNG,  a.SMRYFCHR=b.SMRYFCHR,  a.SMRYWFCH=b.SMRYWFCH,  a.SMRYRTRN=b.SMRYRTRN  from RM00104 a, #tmpRM00104 b where   a.PERIODID=b.PERIODID and a.YEAR1=b.YEAR1 and a.HISTTYPE=b.HISTTYPE and a.CUSTNMBR=@I_charEndCustomer if @@error<>0 begin  select @O_iErrorState=16   return end  delete #tmpRM00104 if @@error<>0 begin  select @O_iErrorState=17   return end  if exists(select * from tempdb.dbo.sysobjects where name='##MSCRM_Address_keys') drop table ##MSCRM_Address_keys select * into ##MSCRM_Address_keys from RM00102  where CUSTNMBR=@I_charStartCustomer and ADRSCODE  not in(select ADRSCODE from RM00102 where CUSTNMBR=@I_charEndCustomer) if @@error<>0 begin  select @O_iErrorState=81   return end  insert into RM00102 (CUSTNMBR,ADRSCODE,SLPRSNID,UPSZONE,SHIPMTHD,TAXSCHID,CNTCPRSN,ADDRESS1,ADDRESS2,ADDRESS3,  COUNTRY,CITY,STATE,ZIP,PHONE1,PHONE2,PHONE3,FAX,MODIFDT,CREATDDT,GPSFOINTEGRATIONID,INTEGRATIONSOURCE,INTEGRATIONID,  CCode,DECLID,LOCNCODE,SALSTERR,USERDEF1,USERDEF2)   select @I_charEndCustomer,ADRSCODE,SLPRSNID,UPSZONE,SHIPMTHD,TAXSCHID,CNTCPRSN,ADDRESS1,ADDRESS2,ADDRESS3,  COUNTRY,CITY,STATE,ZIP,PHONE1,PHONE2,PHONE3,FAX,MODIFDT,CREATDDT,GPSFOINTEGRATIONID,INTEGRATIONSOURCE,INTEGRATIONID,  CCode,DECLID,LOCNCODE,SALSTERR,USERDEF1,USERDEF2  from ##MSCRM_Address_keys if @@error<>0 begin  select @O_iErrorState=82   return end  if exists (select * from sysobjects where id=object_id('dbo.tcsSOPTB00007_Cust_Add')) begin  update tcsSOPTB00007_Cust_Add set CUSTNMBR=@I_charEndCustomer where CUSTNMBR=@I_charStartCustomer and ADRSCODE   not in(select ADRSCODE from tcsSOPTB00007_Cust_Add where CUSTNMBR=@I_charEndCustomer) end if @@error<>0 begin  select @O_iErrorState=118   return end  update VAT00300 set CUSTNMBR=@I_charEndCustomer where CUSTNMBR=@I_charStartCustomer and ADRSCODE   not in(select ADRSCODE from VAT00300 where CUSTNMBR=@I_charEndCustomer) if @@error<>0 begin  select @O_iErrorState=19   return end  update VAT10101 set CUSTNMBR=@I_charEndCustomer where CUSTNMBR=@I_charStartCustomer and ADRSCODE   not in(select ADRSCODE from VAT10101 where CUSTNMBR=@I_charEndCustomer) if @@error<>0 begin  select @O_iErrorState=20   return end  if exists (select * from sysobjects where id=object_id('dbo.ASI82615')) begin  update ASI82615 set CUSTNMBR=@I_charEndCustomer where CUSTNMBR=@I_charStartCustomer and ADRSCODE   not in(select ADRSCODE from ASI82615 where CUSTNMBR=@I_charEndCustomer) end if @@error<>0 begin  select @O_iErrorState=21   return end  update SY01200 set Master_ID=@I_charEndCustomer where Master_ID=@I_charStartCustomer   and Master_Type='CUS' and ADRSCODE   not in(select ADRSCODE from SY01200 where Master_ID=@I_charEndCustomer and Master_Type='CUS') if @@error<>0 begin  select @O_iErrorState=22   return end  delete SY01200 where Master_ID=@I_charStartCustomer and Master_Type='CUS' if @@error<>0 begin  select @O_iErrorState=23   return end  select @BALNCTYP=BALNCTYP from RM00101 where CUSTNMBR=@I_charStartCustomer   if @BALNCTYP=1   begin  if LEN(@I_charEndCustomer) > LEN(@I_charStartCustomer)  select @LEN1=(LEN(@I_charEndCustomer) - LEN(@I_charStartCustomer))  else if LEN(@I_charEndCustomer) < LEN(@I_charStartCustomer)  select @LEN2=(LEN(@I_charStartCustomer) - LEN(@I_charEndCustomer))   if exists(select 1 from RM20101 where CUSTNMBR=@I_charEndCustomer and RMDTYPAL=0)  and exists(select 1 from RM20101 where CUSTNMBR=@I_charStartCustomer and RMDTYPAL=0)  begin  select  @ORTRXAMT=ORTRXAMT,  @CURTRXAM=CURTRXAM,  @SLSAMNT=SLSAMNT,  @COSTAMNT=COSTAMNT,  @FRTAMNT=FRTAMNT,  @MISCAMNT=MISCAMNT,  @TAXAMNT=TAXAMNT,  @COMDLRAM=COMDLRAM,  @CASHAMNT=CASHAMNT,  @DISTKNAM=DISTKNAM,  @DISAVAMT=DISAVAMT,  @DISAVTKN=DISAVTKN,  @DISCRTND=DISCRTND,  @DSCDLRAM=DSCDLRAM,  @WROFAMNT=WROFAMNT,  @PPSAMDED=PPSAMDED,  @GSTDSAMT=GSTDSAMT,  @TRDISAMT=TRDISAMT  from RM20101 where CUSTNMBR=@I_charStartCustomer and RMDTYPAL=0   delete RM20101 where CUSTNMBR=@I_charStartCustomer and RMDTYPAL=0  if @@error<>0  begin  select @O_iErrorState=80   return  end   update RM20101 set   ORTRXAMT=@ORTRXAMT+ORTRXAMT,  CURTRXAM=@CURTRXAM+CURTRXAM,  SLSAMNT=@SLSAMNT+SLSAMNT,  COSTAMNT=@COSTAMNT+COSTAMNT,  FRTAMNT=@FRTAMNT+FRTAMNT,  MISCAMNT=@MISCAMNT+MISCAMNT,  TAXAMNT=@TAXAMNT+TAXAMNT,  COMDLRAM=@COMDLRAM+COMDLRAM,  CASHAMNT=@CASHAMNT+CASHAMNT,  DISTKNAM=@DISTKNAM+DISTKNAM,  DISAVAMT=@DISAVAMT+DISAVAMT,  DISAVTKN=@DISAVTKN+DISAVTKN,  DISCRTND=@DISCRTND+DISCRTND,  DSCDLRAM=@DSCDLRAM+DSCDLRAM,  WROFAMNT=@WROFAMNT+WROFAMNT,  PPSAMDED=@PPSAMDED+PPSAMDED,  GSTDSAMT=@GSTDSAMT+GSTDSAMT,  TRDISAMT=@TRDISAMT+TRDISAMT  where CUSTNMBR=@I_charEndCustomer and RMDTYPAL=0  if @@error<>0  begin  select @O_iErrorState=64   return  end  end  else  begin  update RM20101 set CUSTNMBR=@I_charEndCustomer, DOCNUMBR=  rtrim(@I_charEndCustomer)+  '^'+  replicate('0',@LEN2)+  substring(rtrim(DOCNUMBR),LEN(@I_charStartCustomer)+2+@LEN1,20)  where CUSTNMBR=@I_charStartCustomer and RMDTYPAL=0  if @@error<>0  begin  select @O_iErrorState=65   return  end  end   if exists(select 1 from RM00401 where CUSTNMBR=@I_charEndCustomer and RMDTYPAL=0 and DCSTATUS=2)  delete RM00401 where CUSTNMBR=@I_charStartCustomer and RMDTYPAL=0 and DCSTATUS=2  if @@error<>0  begin  select @O_iErrorState=65   return  end   if exists(select 1 from RM00401 where CUSTNMBR=@I_charEndCustomer and RMDTYPAL=0 and DCSTATUS=3)  delete RM00401 where CUSTNMBR=@I_charStartCustomer and RMDTYPAL=0 and DCSTATUS=3  if @@error<>0  begin  select @O_iErrorState=66   return  end   update RM00401 set CUSTNMBR=@I_charEndCustomer, DOCNUMBR=  rtrim(@I_charEndCustomer)+  '^'+  replicate('0',@LEN2)+  substring(rtrim(DOCNUMBR),LEN(@I_charStartCustomer)+2+@LEN1,20)  where CUSTNMBR=@I_charStartCustomer and RMDTYPAL=0  if @@error<>0  begin  select @O_iErrorState=67   return  end   if exists(select 1 from RM30101 where CUSTNMBR=@I_charEndCustomer and RMDTYPAL=0)  delete RM30101 where CUSTNMBR=@I_charStartCustomer and RMDTYPAL=0   if @@error<>0  begin  select @O_iErrorState=68   return  end   update RM30101 set CUSTNMBR=@I_charEndCustomer, DOCNUMBR=  rtrim(@I_charEndCustomer)+  '^'+  replicate('0',@LEN2)+  substring(rtrim(DOCNUMBR),LEN(@I_charStartCustomer)+2+@LEN1,20),  BALFWDNM =  rtrim(@I_charEndCustomer)+  '^'+  replicate('0',@LEN2)+  substring(rtrim(BALFWDNM),LEN(@I_charStartCustomer)+2+@LEN1,20)  where CUSTNMBR=@I_charStartCustomer and RMDTYPAL=0  if @@error<>0  begin  select @O_iErrorState=69   return  end   update RM30101 set CUSTNMBR=@I_charEndCustomer, BALFWDNM=  rtrim(@I_charEndCustomer)+  '^'+  replicate('0',@LEN2)+  substring(rtrim(BALFWDNM),LEN(@I_charStartCustomer)+2+@LEN1,20)  where CUSTNMBR=@I_charStartCustomer and RMDTYPAL<>0  if @@error<>0  begin  select @O_iErrorState=70   return  end  end  declare ta_CCCursor insensitive CURSOR for select 'update ['+o.name+'] set CUSTNMBR='+rtrim(@cEndCustomer) +  ' where CUSTNMBR='+rtrim(@cStartCustomer)  from sysobjects o, syscolumns c  where o.id=c.id  and o.type='U'  and c.name='CUSTNMBR'  and o.name<>'RM00101'  and o.name<>'RM00102'  and o.name<>'RM00103'  and o.name<>'RM00106'  and o.name<>'RM00104'  and o.name<>'ASI82615'  and o.name<>'CN00500'  and o.name<>'SVC00950'  and o.name<>'SVC00960'  and o.name<>'MDS00501'  and o.name<>'ASI82610'  and o.name<>'ASILOC50'  and o.name<>'ASI82650'  and o.name<>'CN00400'  and o.name<>'CN100100'  and o.name<>'CN100200'  and o.name<>'PA00010'  and o.name<>'PA00001'  and o.name<>'SOP10100'  and o.name<>'SOP60300'  and o.name<>'PA00501'  and o.name<>'PA00511'  and o.name<>'PA00521'  and o.name<>'PA00531'  and o.name<>'PA00532'  and o.name<>'PA50100'  and o.name<>'VAT00300'  and o.name<>'VAT10101'  and o.name<>'ME147214'  and o.name<>'RM30701'  and o.name<>'RM30702'  and o.name<>'SV00100'  and o.name<>'PA02301'  and o.name<>'SOP30200'  and o.name<>'SOP60200'  and o.name<>'tcsSOPTB00007_Cust_Add'  and o.name<>'gpItmCus'  and o.name<>'SC020330'  order by o.name set nocount on OPEN ta_CCCursor FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR WHILE (@@FETCH_STATUS<>-1) begin  exec (@CUSTNMBR)  if @@error<>0  begin  select @O_iErrorState=24   return  end  FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR end DEALLOCATE ta_CCCursor  if @O_iErrorState<>0  return  update a set ORMSTRID=@I_charEndCustomer from GL10001 a, GL10000 b  where  a.ORMSTRID=@I_charStartCustomer and  a.JRNENTRY=b.JRNENTRY and  b.SERIES=3 if @@error<>0 begin  select @O_iErrorState=25   return end  update GL20000 set ORMSTRID=@I_charEndCustomer where ORMSTRID=@I_charStartCustomer and SERIES=3 if @@error<>0 begin  select @O_iErrorState=26   return end  update GL30000 set ORMSTRID=@I_charEndCustomer where ORMSTRID=@I_charStartCustomer and SERIES=3 if @@error<>0 begin  select @O_iErrorState=27   return end  update PJOURNAL set ORMSTRID=@I_charEndCustomer where ORMSTRID=@I_charStartCustomer if @@error<>0 begin  select @O_iErrorState=28   return end  update CM20300 set CMLinkID=@I_charEndCustomer where CMLinkID=@I_charStartCustomer if @@error<>0 begin  select @O_iErrorState=29   return end  update MC10000 set StartCustOrVendID=@I_charEndCustomer where StartCustOrVendID=@I_charStartCustomer if @@error<>0 begin  select @O_iErrorState=30   return end  update MC10000 set EndCustOrVendID=@I_charEndCustomer where EndCustOrVendID=@I_charStartCustomer if @@error<>0 begin  select @O_iErrorState=31   return end  update SOP10100 set CUSTNMBR=@I_charEndCustomer where CUSTNMBR=@I_charStartCustomer and PROSPECT=0 if @@error<>0 begin  select @O_iErrorState=32   return end  update SOP30200 set CUSTNMBR=@I_charEndCustomer where CUSTNMBR=@I_charStartCustomer and PROSPECT=0 if @@error<>0 begin  select @O_iErrorState=33   return end  update CM20202 set CustomerVendor_ID=@I_charEndCustomer where CustomerVendor_ID=@I_charStartCustomer and SERIES=3 if @@error<>0 begin  select @O_iErrorState=34   return end  update TX20500 set CustomerVendor_ID=@I_charEndCustomer where CustomerVendor_ID=@I_charStartCustomer and SERIES=3 if @@error<>0 begin  select @O_iErrorState=36   return end  update TX30000 set CustomerVendor_ID=@I_charEndCustomer where CustomerVendor_ID=@I_charStartCustomer  if @@error<>0 begin  select @O_iErrorState=37   return end  update SY06000 set CustomerVendor_ID=@I_charEndCustomer where SERIES=3 and CustomerVendor_ID=@I_charStartCustomer  and ADRSCODE+cast(SERIES as varchar) not in (select ADRSCODE+cast(SERIES as varchar) from SY06000 (nolock) where CustomerVendor_ID=@I_charEndCustomer) if @@error<>0 begin  select @O_iErrorState=38   return end  delete SY06000 where CustomerVendor_ID=@I_charStartCustomer if @@error <> 0 begin  select @O_iErrorState=74   return end  if exists(select 1 from sysobjects (nolock) where name = 'EDCVAT26' and type = 'U') begin  update EDCVAT26 set CustomerVendor_ID = @I_charEndCustomer where CustomerVendor_ID = @I_charStartCustomer  if @@error <> 0   begin  select @O_iErrorState = 95   return  end end  if (exists (select 1 from sysobjects (nolock) where name='ASI82650')) begin  update ASI82650 set CUSTNMBR=@I_charEndCustomer  where CUSTNMBR=@I_charStartCustomer and ITEMNMBR   not in (select ITEMNMBR from ASI82650 (nolock) where CUSTNMBR=@I_charEndCustomer)  if @@error<>0  begin  select @O_iErrorState=39   return  end end  if (exists (select 1 from sysobjects (nolock) where name='ASILOC50')) begin  update ASILOC50 set CUSTNMBR=@I_charEndCustomer  where CUSTNMBR=@I_charStartCustomer and ITEMNMBR   not in (select ITEMNMBR from ASILOC50 (nolock) where CUSTNMBR=@I_charEndCustomer)  if @@error<>0  begin  select @O_iErrorState=40   return  end end  declare ta_CCCursor insensitive CURSOR for select 'update ['+o.name+'] set STCUSTID='+rtrim(@cEndCustomer) +  ' where STCUSTID='+rtrim(@cStartCustomer)  from sysobjects o, syscolumns c  where o.id=c.id  and o.type='U'  and c.name='STCUSTID'   order by o.name set nocount on OPEN ta_CCCursor FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR WHILE (@@FETCH_STATUS<>-1) begin  exec (@CUSTNMBR)  if @@error<>0  begin  select @O_iErrorState=41   return  end   FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR end DEALLOCATE ta_CCCursor  if @O_iErrorState<>0  return  declare ta_CCCursor insensitive CURSOR for select 'update ['+o.name+'] set ENCUSTID='+rtrim(@cEndCustomer) +  ' where ENCUSTID='+rtrim(@cStartCustomer)  from sysobjects o, syscolumns c  where o.id=c.id  and o.type='U'  and c.name='ENCUSTID'   order by o.name set nocount on OPEN ta_CCCursor FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR WHILE (@@FETCH_STATUS<>-1) begin  exec (@CUSTNMBR)  if @@error<>0  begin  select @O_iErrorState=42   return  end   FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR end DEALLOCATE ta_CCCursor  if @O_iErrorState<>0 return  delete RM00105 where CPRCSTNM=@I_charStartCustomer if @@error<>0 begin  select @O_iErrorState=43   return end  declare ta_CCCursor insensitive CURSOR for select 'update ['+o.name+'] set CPRCSTNM='+rtrim(@cEndCustomer) +  ' where CPRCSTNM='+rtrim(@cStartCustomer)  from sysobjects o, syscolumns c  where o.id=c.id  and o.type='U'  and c.name='CPRCSTNM'  order by o.name set nocount on OPEN ta_CCCursor FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR WHILE (@@FETCH_STATUS<>-1) begin  exec (@CUSTNMBR)  if @@error<>0  begin  select @O_iErrorState=44   return  end   FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR end DEALLOCATE ta_CCCursor  if @O_iErrorState<>0  return  declare ta_CCCursor insensitive CURSOR for select 'update ['+o.name+'] set Bill_To_Customer='+rtrim(@cEndCustomer) +  ' where Bill_To_Customer='+rtrim(@cStartCustomer)  from sysobjects o, syscolumns c  where o.id=c.id  and o.type='U'  and c.name='Bill_To_Customer'   order by o.name set nocount on OPEN ta_CCCursor FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR WHILE (@@FETCH_STATUS<>-1) begin  exec (@CUSTNMBR)  if @@error<>0  begin  select @O_iErrorState=45   return  end  FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR end DEALLOCATE ta_CCCursor  if @O_iErrorState<>0  return  if exists (select * from sysobjects where id=object_id('dbo.DOShopperInfo')  and sysstat & 0xf=3) begin  update DOShopperInfo set customer_id=@I_charEndCustomer  where customer_id=@I_charStartCustomer  and shopper_id not in (select shopper_id from DOShopperInfo (nolock) where customer_id=@I_charEndCustomer)  if @@error<>0  begin  select @O_iErrorState=46   return  end end  declare ta_CCCursor insensitive CURSOR for select 'delete ['+o.name+'] where rtrim(customer_id)='+rtrim(@cStartCustomer)  from sysobjects o, syscolumns c  where  o.id=c.id  and o.type='U'  and c.name='customer_id'  and o.name='DOCustomerLogin'  or o.name='DOShopperInfo'  order by o.name set nocount on OPEN ta_CCCursor FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR WHILE (@@FETCH_STATUS<>-1) begin  exec (@CUSTNMBR)  if @@error<>0  begin  select @O_iErrorState=47   return  end  FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR end DEALLOCATE ta_CCCursor  if @O_iErrorState<>0 return  declare ta_CCCursor insensitive CURSOR for select 'update ['+o.name+'] set Bill_Customer_Number ='+(@cEndCustomer) + ' where Bill_Customer_Number='+rtrim(@cStartCustomer)  from sysobjects o, syscolumns c  where o.id=c.id  and o.type='U'  and c.name='Bill_Customer_Number'   order by o.name set nocount on OPEN ta_CCCursor FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR WHILE (@@FETCH_STATUS<>-1) begin  exec (@CUSTNMBR)  if @@error<>0  begin  select @O_iErrorState=48   return  end  FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR end DEALLOCATE ta_CCCursor  if @O_iErrorState<>0  return  if exists (select * from sysobjects where id=object_id('dbo.CN00400')  and sysstat & 0xf=3) begin  update CN00400 set CUSTNMBR=@I_charEndCustomer  where CUSTNMBR=@I_charStartCustomer  and CNTCPRSN not in (select CNTCPRSN from CN00400 (nolock) where CUSTNMBR=@I_charEndCustomer)  if @@error<>0  begin  select @O_iErrorState=49   return  end end  if exists (select * from sysobjects where id=object_id('dbo.CN00500')  and sysstat & 0xf=3) begin  update CN00500 set CUSTNMBR=@I_charEndCustomer  where CUSTNMBR=@I_charStartCustomer  and not exists (select CUSTNMBR from CN00500 (nolock) where CUSTNMBR=@I_charEndCustomer)  if @@error<>0  begin  select @O_iErrorState=50   return  end end  if exists (select * from sysobjects where id = object_id('dbo.PP100100')  and sysstat & 0xf = 3) begin  update PP100100 set CUSTVNDR = @I_charEndCustomer where CUSTVNDR = @I_charStartCustomer  if @@error<>0  begin  select @O_iErrorState = 204   return  end end  if exists (select * from sysobjects where id=object_id('dbo.CN100100') and sysstat & 0xf=3) begin  update CN100100 set CUSTNMBR=@I_charEndCustomer  where CUSTNMBR=@I_charStartCustomer  and USERID not in (select USERID from CN100100 where CUSTNMBR=@I_charEndCustomer)  if @@error<>0  begin  select @O_iErrorState=51   return  end   update a set BALOVER=a.BALOVER+b.BALOVER, CUSTBLNC=a.CUSTBLNC+b.CUSTBLNC  from CN100100 a, CN100100 b  where a.USERID=b.USERID and  a.CUSTNMBR=@I_charEndCustomer and  b.CUSTNMBR=@I_charStartCustomer  if @@error<>0  begin  select @O_iErrorState=52   return  end end  if exists (select * from sysobjects where id=object_id('dbo.CN100200') and sysstat & 0xf=3) begin  update CN100200 set CUSTNMBR=@I_charEndCustomer  where CUSTNMBR=@I_charStartCustomer  and USERID not in (select USERID from CN100200 (nolock) where CUSTNMBR=@I_charEndCustomer)  if @@error<>0  begin  select @O_iErrorState=53   return  end end  if exists (select * from sysobjects where id=object_id('dbo.PA00010') and sysstat & 0xf=3) begin  update PA00010 set CUSTNMBR=@I_charEndCustomer  where CUSTNMBR=@I_charStartCustomer  and BANKNAME+BNKBRNCH not in (select BANKNAME+BNKBRNCH from PA00010 (nolock) where CUSTNMBR=@I_charEndCustomer)  if @@error<>0  begin  select @O_iErrorState=54   return  end end  if exists (select * from sysobjects where id=object_id('dbo.ME147214') and sysstat & 0xf=3) begin  update ME147214 set CUSTNMBR=@I_charEndCustomer  where CUSTNMBR=@I_charStartCustomer  and not exists (select CUSTNMBR from ME147214 where CUSTNMBR=@I_charEndCustomer)  if @@error<>0  begin  select @O_iErrorState=65   return  end end  if exists (select * from sysobjects where id=object_id('dbo.PA50100') and sysstat & 0xf=3) begin  update PA50100 set CUSTNMBR=@I_charEndCustomer  where CUSTNMBR=@I_charStartCustomer  and USERID not in (select USERID from PA50100 (nolock) where CUSTNMBR=@I_charEndCustomer)  if @@error<>0  begin  select @O_iErrorState=55   return  end end  if exists (select * from sysobjects where id=object_id('dbo.PA50105') and sysstat & 0xf=3) begin  update PA50105 set CustVenID=@I_charEndCustomer where CustVenID=@I_charStartCustomer  if @@error<>0  begin  select @O_iErrorState=56   return  end end  if exists (select * from sysobjects where id=object_id('dbo.PA00001') and sysstat & 0xf=3) begin  update PA00001 set CUSTNMBR=@I_charEndCustomer  where CUSTNMBR=@I_charStartCustomer  and not exists(select CUSTNMBR from PA00001 where CUSTNMBR=@I_charEndCustomer)  if @@error<>0  begin  select @O_iErrorState=57   return  end end  delete a from SY03900 a, RM00101 b  where b.CUSTNMBR=@I_charStartCustomer and  a.NOTEINDX=b.NOTEINDX if @@error<>0 begin  select @O_iErrorState=58   return end  if (exists(select * from sysobjects where id=object_id('dbo.gpItmCus') and sysstat & 0xf=3)) begin  update gpItmCus set CUSTNMBR=@I_charEndCustomer where CUSTNMBR=@I_charStartCustomer  and ITEMNMBR+UOFM not in(select ITEMNMBR+UOFM from gpItmCus where CUSTNMBR=@I_charEndCustomer)  if (@@error<>0)  begin  select @O_iErrorState=61   return  end end  update RM00500 set LINKCODE=@I_charEndCustomer  where LINKCODE=@I_charStartCustomer and PRODTCOD='C' and  PRODTCOD+PRCSHID not in(select PRODTCOD+PRCSHID from RM00500 where LINKCODE=@I_charEndCustomer and PRODTCOD = 'C') and  PRODTCOD+cast(SEQNUMBR as varchar) not in(select PRODTCOD+cast(SEQNUMBR as varchar) from RM00500 where LINKCODE=@I_charEndCustomer and PRODTCOD = 'C') if @@error<>0 begin  select @O_iErrorState=90   return end  delete RM00500 where LINKCODE=@I_charStartCustomer and PRODTCOD = 'C' if @@error<>0 begin  select @O_iErrorState=91   return end  update RM00106 set CUSTNMBR=@I_charEndCustomer where CUSTNMBR=@I_charStartCustomer  and cast(Email_Type as varchar)+Email_Recipient  not in(select cast(Email_Type as varchar)+Email_Recipient from RM00106 where CUSTNMBR=@I_charEndCustomer) if @@error<>0 begin  select @O_iErrorState=105   return end  update SOP10205 set LINKCODE=@I_charEndCustomer  where LINKCODE=@I_charStartCustomer and PRODTCOD = 'C'  and PRODTCOD not in(select PRODTCOD from SOP10205 where LINKCODE=@I_charEndCustomer and PRODTCOD = 'C') if @@error<>0 begin  select @O_iErrorState=92   return end  delete SOP10205 where LINKCODE=@I_charStartCustomer and PRODTCOD = 'C' if @@error<>0 begin  select @O_iErrorState=93   return end  if exists(select * from sysobjects where id=object_id('dbo.SVC00950') and sysstat & 0xf=3) begin  update SVC00950 set CUSTNMBR=@I_charEndCustomer where CUSTNMBR=@I_charStartCustomer and  ADRSCODE not in(select ADRSCODE from SVC00950 (nolock) where CUSTNMBR=@I_charEndCustomer)  if @@error<>0  begin  select @O_iErrorState=102   return  end end  if exists(select * from sysobjects where id=object_id('dbo.SVC00960') and sysstat & 0xf=3) begin  update SVC00960 set CUSTNMBR=@I_charEndCustomer where CUSTNMBR=@I_charStartCustomer and  ADRSCODE+LASTNAME+FRSTNAME not in(select ADRSCODE+LASTNAME+FRSTNAME from SVC00960 (nolock) where CUSTNMBR=@I_charEndCustomer)  if @@error<>0  begin  select @O_iErrorState=103   return  end end  if exists(select * from sysobjects where id=object_id('dbo.SC020330') and sysstat & 0xf=3) begin  update SC020330 set CUSTNMBR=@I_charEndCustomer where CUSTNMBR=@I_charStartCustomer and  PLANNAME_I not in(select PLANNAME_I from SC020330 (nolock) where CUSTNMBR=@I_charEndCustomer)  if @@error<>0  begin  select @O_iErrorState=104   return  end end  declare ta_CCCursor insensitive CURSOR for select 'update ['+o.name+'] set aaCustID='+rtrim(@cEndCustomer) +  ' where aaCustID='+rtrim(@cStartCustomer)  from sysobjects o, syscolumns c  where o.id=c.id  and o.type='U'  and c.name='aaCustID'   order by o.name set nocount on OPEN ta_CCCursor FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR WHILE (@@FETCH_STATUS<>-1) begin  exec (@CUSTNMBR)  if @@error<>0  begin  select @O_iErrorState=88   return  end   FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR end DEALLOCATE ta_CCCursor  if @O_iErrorState<>0 return  if exists (select * from sysobjects where id=object_id('dbo.PA00501') and sysstat & 0xf=3) begin  exec rmCustomerCombinerProject  @I_charStartCustomer,  @I_charEndCustomer,  @cStartCustomer,  @cEndCustomer,  @O_iErrorState output  if @O_iErrorState<>0 or @@error<>0  begin  select @O_iErrorState = 61  return  end end  declare ta_CCCursor insensitive CURSOR for select 'delete ['+o.name+'] where CUSTNMBR='+rtrim(@cStartCustomer)  from sysobjects o, syscolumns c  where (o.id=c.id  and o.type='U'  and c.name='CUSTNMBR')  and (o.name='RM00101'   or o.name='RM00102'  or o.name='RM00103'  or o.name='RM00104'  or o.name='RM00106'  or o.name='ASI82615'  or o.name='CN00500'  or o.name='SVC00950'  or o.name='SVC00960'  or o.name='MDS00501'  or o.name='ASI82610'  or o.name='ASILOC50'  or o.name='ASI82650'  or o.name='CN00400'  or o.name='CN100100'  or o.name='CN100200'  or o.name='PA00001'  or o.name='PA00010'  or o.name='PA00501'  or o.name='PA00511'  or o.name='PA00521'  or o.name='PA00531'  or o.name='PA00532'  or o.name='VAT00300'  or o.name='VAT10101'  or o.name='PA50100'  or o.name='ME147214'  or o.name='RM30701'  or o.name='RM30702'  or o.name='SV00100'  or o.name='PA02301'  or o.name='SOP60200'  or o.name='SOP60300'  or o.name='tcsSOPTB00007_Cust_Add'  or o.name='gpItmCus'  or o.name='SC020330')  order by o.name set nocount on OPEN ta_CCCursor FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR WHILE (@@FETCH_STATUS<>-1) begin  exec (@CUSTNMBR)  if @@error<>0  begin  select @O_iErrorState=60   return  end  FETCH NEXT FROM ta_CCCursor INTO @CUSTNMBR end DEALLOCATE ta_CCCursor  if @O_iErrorState<>0  return  exec @iStatus=rmCustomerCombinerPost  @I_charStartCustomer,  @I_charEndCustomer,  @cStartCustomer,  @cEndCustomer,   @O_iErrorState if @O_iErrorState<>0 or @@error<>0 begin  select @O_iErrorState = 77  return end  return   
GO
GRANT EXECUTE ON  [dbo].[rmCustomerCombinerMaster] TO [DYNGRP]
GO
