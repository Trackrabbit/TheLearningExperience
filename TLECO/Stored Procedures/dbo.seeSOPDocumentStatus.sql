SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[seeSOPDocumentStatus]  @SORTBY char(15),       @i_CUSTNMBR_RS char(15) = '',    @i_CUSTNMBR_RE char(15) = '',    @i_DOCDATE_RS datetime = '',    @i_DOCDATE_RE datetime = '',    @i_DOCNUMBR_RS char(21) = '',    @i_DOCNUMBR_RE char(21) = '',    @i_DOCTYPE_RS tinyint = 0,    @i_DOCTYPE_RE tinyint = 0,    @i_REQSHPDT_RS datetime = '',    @i_REQSHPDT_RE datetime = '',    @i_TYPEID_RS char(15) = '',     @i_TYPEID_RE char(15) = '',     @DETAIL tinyint = 0        as  set nocount on  declare @SOPNUMBE char(21),  @SOPTYPE tinyint,  @ITEMNMBR char(31), @MY_DEX_ROW int, @x varchar(1000)  set @x = ''  If OBJECT_ID('tempdb..#SOPDOCSTATUS') is  NULL  Begin  create table #SOPDOCSTATUS (  SOPNUMBE char(21) not null default '',  SOPTYPE char(15) not null default '',  DOCID char(15) not null default '',  SOPSTATUS char(31) not null default '',  DOCDATE datetime not null default '01/01/1900',  ReqShipDate datetime not null default '01/01/1900',  CUSTNMBR char(15) not null default '',  ITEMNMBR char(31) not null default '',  ITMTRKOP tinyint not null default 0,  LNITMSEQ int not null default 0,  CMPNTSEQ int not null default 0,  ITEMDESC char(65) not null default '',  LOCNCODE char(11) not null default '',  UofM char(9) not null default '',  QUANTITY numeric(19,5) not null default 0.00,  ATYALLOC numeric(19,5) not null default 0.00,  QTYREMAI numeric(19,5) not null default 0.00,  QTYFULFI numeric(19,5) not null default 0.00,  SERLTNUM char(1000) not null default '',  HIDEDETL tinyint not null default 0,  HIDESERL tinyint not null default 0,  USRDAT01 datetime not null default '01/01/1900',  USRDAT02 datetime not null default '01/01/1900',  USRTAB01 char(21) not null default '',  USRTAB09 char(21) not null default '',  USRTAB03 char(21) not null default '',  USERDEF1 char(21) not null default '',  USERDEF2 char(21) not null default '',  USRDEF03 char(21) not null default '',  USRDEF04 char(21) not null default '',  USRDEF05 char(21) not null default '',  USRDFPR1 char(21) not null default '',  USRDFPR2 char(21) not null default '',  USRDFPR3 char(21) not null default '',  USRDFPR4 char(21) not null default '',  USRDFPR5 char(21) not null default '',  USRDFPR6 char(21) not null default '',  USRDFPR7 char(21) not null default '',  USRDFPR8 char(21) not null default '',  USRDFPR9 char(21) not null default '',  USRDFP10 char(21) not null default '',  MY_DEX_ROW int Identity (1,1) )  End   delete #SOPDOCSTATUS   insert into #SOPDOCSTATUS (SOPNUMBE,SOPTYPE,DOCID,DOCDATE,ReqShipDate,CUSTNMBR,ITEMNMBR,LNITMSEQ,CMPNTSEQ,ITEMDESC,LOCNCODE,UofM,QUANTITY,ATYALLOC,QTYREMAI,QTYFULFI,SOPSTATUS )   select a.SOPNUMBE, a.SOPTYPE, a.DOCID, a.DOCDATE, a.ReqShipDate, a.CUSTNMBR, b.ITEMNMBR,b.LNITMSEQ,b.CMPNTSEQ, b.ITEMDESC, b.LOCNCODE, b.UOFM, b.QUANTITY, b.ATYALLOC, b.QTYREMAI, b.QTYFULFI,  case when a.SOPSTATUS = 1 then 'New'  when a.SOPSTATUS = 2 then 'Ready To Pick'  when a.SOPSTATUS = 3 then 'Unconfirmed Pick'  when a.SOPSTATUS = 4 then 'Ready to Pack'  when a.SOPSTATUS = 5 then 'Unconfirmed Pack'  when a.SOPSTATUS = 6 then 'Shipped'  when a.SOPSTATUS = 7 then 'Ready to Post'  when a.SOPSTATUS = 8 then 'In Process'  when a.SOPSTATUS = 9 then 'Completed'  else ''  end  from SOP10100 a, SOP10200 b  where a.SOPNUMBE = b.SOPNUMBE and  a.SOPTYPE = b.SOPTYPE and  b.QTYTOINV <> 0 and  ((b.QTYFULFI = 0) or (b.QTYFULFI <> b.ATYALLOC and b.ATYALLOC <> 0)) and  a.CUSTNMBR between @i_CUSTNMBR_RS and @i_CUSTNMBR_RE and  a.DOCDATE between @i_DOCDATE_RS and @i_DOCDATE_RE and  a.SOPNUMBE between @i_DOCNUMBR_RS and @i_DOCNUMBR_RE and  a.SOPTYPE between @i_DOCTYPE_RS and @i_DOCTYPE_RE and  a.ReqShipDate between @i_REQSHPDT_RS and @i_REQSHPDT_RE and  a.DOCID between @i_TYPEID_RS and @i_TYPEID_RE   insert into #SOPDOCSTATUS (SOPNUMBE,SOPTYPE,DOCID,DOCDATE,ReqShipDate,CUSTNMBR,SOPSTATUS, HIDEDETL )   select a.SOPNUMBE, a.SOPTYPE, a.DOCID, a.DOCDATE, a.ReqShipDate, a.CUSTNMBR,   case when a.SOPSTATUS = 1 then 'New'  when a.SOPSTATUS = 2 then 'Ready To Pick'  when a.SOPSTATUS = 3 then 'Unconfirmed Pick'  when a.SOPSTATUS = 4 then 'Ready to Pack'  when a.SOPSTATUS = 5 then 'Unconfirmed Pack'  when a.SOPSTATUS = 6 then 'Shipped'  when a.SOPSTATUS = 7 then 'Ready to Post'  when a.SOPSTATUS = 8 then 'In Process'  when a.SOPSTATUS = 9 then 'Completed'  else ''  end, 1  from SOP10100 a, SOP10200 b  where a.SOPNUMBE = b.SOPNUMBE and   a.SOPTYPE = b.SOPTYPE and  a.SOPNUMBE not in (select SOPNUMBE from #SOPDOCSTATUS) and  a.CUSTNMBR between @i_CUSTNMBR_RS and @i_CUSTNMBR_RE and  a.DOCDATE between @i_DOCDATE_RS and @i_DOCDATE_RE and  a.SOPNUMBE between @i_DOCNUMBR_RS and @i_DOCNUMBR_RE and  a.SOPTYPE between @i_DOCTYPE_RS and @i_DOCTYPE_RE and  a.ReqShipDate between @i_REQSHPDT_RS and @i_REQSHPDT_RE and  a.DOCID between @i_TYPEID_RS and @i_TYPEID_RE   update a set a.USRDAT01 = b.USRDAT01,  a.USRDAT02 = b.USRDAT02,  a.USRTAB01 = b.USRTAB01,  a.USRTAB09 = b.USRTAB09,  a.USRTAB03 = b.USRTAB03,  a.USERDEF1 = b.USERDEF1,  a.USERDEF2 = b.USERDEF2,  a.USRDEF03 = b.USRDEF03,  a.USRDEF04 = b.USRDEF04,  a.USRDEF05 = b.USRDEF05  from #SOPDOCSTATUS a, SOP10106 b  where a.SOPNUMBE = b.SOPNUMBE and  a.SOPTYPE = b.SOPTYPE   update a set a.USRDFPR1 = case when b.USRDFPR1 = '' then 'List 1:' else b.USRDFPR1 end,  a.USRDFPR2 = case when b.USRDRPR2 = '' then 'List 2:' else b.USRDRPR2 end,  a.USRDFPR3 = case when b.USRDRPR3 = '' then 'List 3:' else b.USRDRPR3 end,  a.USRDFPR4 = case when b.USRDRPR4 = '' then 'Text Field 1:' else b.USRDRPR4 end,  a.USRDFPR5 = case when b.USRDRPR5 = '' then 'Text Field 2:' else b.USRDRPR5 end,  a.USRDFPR6 = case when b.USRDRPR6 = '' then 'Text Field 3:' else b.USRDRPR6 end,  a.USRDFPR7 = case when b.USRDRPR7 = '' then 'Text Field 4:' else b.USRDRPR7 end,  a.USRDFPR8 = case when b.USRDRPR7 = '' then 'Text Field 5:' else b.USRDRPR8 end,  a.USRDFPR9 = case when b.USRDRPR8 = '' then 'Date Field 1:' else b.USRDRPR9 end,  a.USRDFP10 = case when b.USRDRP10 = '' then 'Date Field 2:' else b.USRDRP10 end  from #SOPDOCSTATUS a, SOP40100 b   update a set a.ITMTRKOP = b.ITMTRKOP  from #SOPDOCSTATUS a, IV00101 b  where a.ITEMNMBR = b.ITEMNMBR and   ((a.QTYFULFI = 0) or (a.QTYFULFI <> a.ATYALLOC and a.ATYALLOC <> 0))   DECLARE SERIAL_CHECK CURSOR FOR  SELECT distinct SOPNUMBE, SOPTYPE, ITEMNMBR, MY_DEX_ROW   FROM #SOPDOCSTATUS  where QTYFULFI <> 0  order by SOPNUMBE, SOPTYPE, ITEMNMBR   OPEN SERIAL_CHECK   FETCH NEXT FROM SERIAL_CHECK  INTO @SOPNUMBE, @SOPTYPE, @ITEMNMBR, @MY_DEX_ROW  WHILE @@FETCH_STATUS = 0  Begin   select @x = @x +  case   when @x = '' then rtrim(SERLTNUM)  else '; ' + rtrim(SERLTNUM)  end  from SOP10201 where SOPNUMBE = @SOPNUMBE and SOPTYPE = @SOPTYPE and ITEMNMBR = @ITEMNMBR  update #SOPDOCSTATUS set SERLTNUM = @x where MY_DEX_ROW = @MY_DEX_ROW   FETCH NEXT FROM SERIAL_CHECK INTO @SOPNUMBE, @SOPTYPE, @ITEMNMBR, @MY_DEX_ROW  End    CLOSE SERIAL_CHECK  DEALLOCATE SERIAL_CHECK   update #SOPDOCSTATUS set HIDESERL = 1 where SERLTNUM <> ''  select * from #SOPDOCSTATUS    
GO
GRANT EXECUTE ON  [dbo].[seeSOPDocumentStatus] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[seeSOPDocumentStatus] TO [rpt_customer service rep]
GO
GRANT EXECUTE ON  [dbo].[seeSOPDocumentStatus] TO [rpt_operations manager]
GO
GRANT EXECUTE ON  [dbo].[seeSOPDocumentStatus] TO [rpt_order processor]
GO
GRANT EXECUTE ON  [dbo].[seeSOPDocumentStatus] TO [rpt_power user]
GO
GRANT EXECUTE ON  [dbo].[seeSOPDocumentStatus] TO [rpt_sales manager]
GO
GRANT EXECUTE ON  [dbo].[seeSOPDocumentStatus] TO [rpt_shipping and receiving]
GO
GRANT EXECUTE ON  [dbo].[seeSOPDocumentStatus] TO [rpt_warehouse manager]
GO
