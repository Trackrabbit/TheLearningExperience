SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[seeRMReceivablesAgingMetric]  @CustomerNumber varchar(max) as  declare @numPeriods int       declare @Customers table (CUSTNMBR nvarchar(500))  select  @numPeriods = AGPERUSD from  dbo.RM40101 with (NOLOCK)  insert into @Customers select * from dbo.seeSplitString(@CustomerNumber, ',')  create table #ReceivablesAgingTemp (PeriodDescription char(15) not null,  AgingAmount numeric(19, 5) not null,  Filter char(15))  if (@CustomerNumber = '') begin  insert into #ReceivablesAgingTemp  (PeriodDescription,  AgingAmount,  Filter)  select  RMPERDSC as PeriodDescription,  SUM(AGPERAMT_1) as AgingAmount,  ''  as Filter  from  dbo.RM40201 with (NOLOCK)  INNER JOIN dbo.RM00103 with (NOLOCK)  ON INDEX1 = 1  where  INDEX1 <= @numPeriods  group by  RMPERDSC  insert into #ReceivablesAgingTemp  (PeriodDescription,  AgingAmount,  Filter)  select  RMPERDSC as PeriodDescription,  SUM(AGPERAMT_2) as AgingAmount,  ''  as Filter  from  dbo.RM40201 with (NOLOCK)  INNER JOIN dbo.RM00103 with (NOLOCK)  ON INDEX1 = 2  where  INDEX1 <= @numPeriods  group by  RMPERDSC   insert into #ReceivablesAgingTemp  (PeriodDescription,  AgingAmount,  Filter)  select  RMPERDSC as PeriodDescription,  SUM(AGPERAMT_3) as AgingAmount,  ''  as Filter  from  dbo.RM40201 with (NOLOCK)  INNER JOIN dbo.RM00103 with (NOLOCK)  ON INDEX1 = 3  where  INDEX1 <= @numPeriods  group by  RMPERDSC  insert into #ReceivablesAgingTemp  (PeriodDescription,  AgingAmount,  Filter)  select  RMPERDSC as PeriodDescription,  SUM(AGPERAMT_4) as AgingAmount,  ''  as Filter  from  dbo.RM40201 with (NOLOCK)  INNER JOIN dbo.RM00103 with (NOLOCK)  ON INDEX1 = 4  where  INDEX1 <= @numPeriods  group by  RMPERDSC  insert into #ReceivablesAgingTemp  (PeriodDescription,  AgingAmount,  Filter)  select  RMPERDSC as PeriodDescription,  SUM(AGPERAMT_5) as AgingAmount,  ''  as Filter  from  dbo.RM40201 with (NOLOCK)  INNER JOIN dbo.RM00103 with (NOLOCK)  ON INDEX1 = 5  where  INDEX1 <= @numPeriods  group by  RMPERDSC  insert into #ReceivablesAgingTemp  (PeriodDescription,  AgingAmount,  Filter)  select  RMPERDSC as PeriodDescription,  SUM(AGPERAMT_6) as AgingAmount,  ''  as Filter  from  dbo.RM40201 with (NOLOCK)  INNER JOIN dbo.RM00103 with (NOLOCK)  ON INDEX1 = 6  where  INDEX1 <= @numPeriods  group by  RMPERDSC  insert into #ReceivablesAgingTemp  (PeriodDescription,  AgingAmount,  Filter)  select  RMPERDSC as PeriodDescription,  SUM(AGPERAMT_7) as AgingAmount,  ''  as Filter  from  dbo.RM40201 with (NOLOCK)  INNER JOIN dbo.RM00103 with (NOLOCK)  ON INDEX1 = 7  where  INDEX1 <= @numPeriods  group by  RMPERDSC  end else begin   insert into #ReceivablesAgingTemp  (PeriodDescription,  AgingAmount,  Filter)  select  RMPERDSC as PeriodDescription,  SUM(AGPERAMT_1) as AgingAmount,  RM00103.CUSTNMBR  as Filter  from  dbo.RM40201 with (NOLOCK)   INNER JOIN dbo.RM00103 with (NOLOCK)   ON INDEX1 = 1  INNER JOIN @Customers a ON RM00103.CUSTNMBR = a.CUSTNMBR  where  INDEX1 <= @numPeriods  group by  RM00103.CUSTNMBR, RMPERDSC  insert into #ReceivablesAgingTemp  (PeriodDescription,  AgingAmount,  Filter)  select  RMPERDSC as PeriodDescription,  SUM(AGPERAMT_2) as AgingAmount,  RM00103.CUSTNMBR  as Filter  from  dbo.RM40201 with (NOLOCK)   INNER JOIN dbo.RM00103 with (NOLOCK)   ON INDEX1 = 2  INNER JOIN @Customers a ON RM00103.CUSTNMBR = a.CUSTNMBR  where  INDEX1 <= @numPeriods  group by  RM00103.CUSTNMBR, RMPERDSC   insert into #ReceivablesAgingTemp  (PeriodDescription,  AgingAmount,  Filter)  select  RMPERDSC as PeriodDescription,  SUM(AGPERAMT_3) as AgingAmount,  RM00103.CUSTNMBR  as Filter  from  dbo.RM40201 with (NOLOCK)   INNER JOIN dbo.RM00103 with (NOLOCK)   ON INDEX1 = 3  INNER JOIN @Customers a ON RM00103.CUSTNMBR = a.CUSTNMBR  where  INDEX1 <= @numPeriods  group by  RM00103.CUSTNMBR, RMPERDSC  insert into #ReceivablesAgingTemp  (PeriodDescription,  AgingAmount,  Filter)  select  RMPERDSC as PeriodDescription,  SUM(AGPERAMT_4) as AgingAmount,  RM00103.CUSTNMBR  as Filter  from  dbo.RM40201 with (NOLOCK)   INNER JOIN dbo.RM00103 with (NOLOCK)   ON INDEX1 = 4  INNER JOIN @Customers a ON RM00103.CUSTNMBR = a.CUSTNMBR  where  INDEX1 <= @numPeriods  group by  RM00103.CUSTNMBR, RMPERDSC  insert into #ReceivablesAgingTemp  (PeriodDescription,  AgingAmount,  Filter)  select  RMPERDSC as PeriodDescription,  SUM(AGPERAMT_5) as AgingAmount,  RM00103.CUSTNMBR  as Filter  from  dbo.RM40201 with (NOLOCK)   INNER JOIN dbo.RM00103 with (NOLOCK)   ON INDEX1 = 5  INNER JOIN @Customers a ON RM00103.CUSTNMBR = a.CUSTNMBR  where  INDEX1 <= @numPeriods  group by  RM00103.CUSTNMBR, RMPERDSC  insert into #ReceivablesAgingTemp  (PeriodDescription,  AgingAmount,  Filter)  select  RMPERDSC as PeriodDescription,  SUM(AGPERAMT_6) as AgingAmount,  RM00103.CUSTNMBR  as Filter  from  dbo.RM40201 with (NOLOCK)   INNER JOIN dbo.RM00103 with (NOLOCK)   ON INDEX1 = 6  INNER JOIN @Customers a ON RM00103.CUSTNMBR = a.CUSTNMBR  where  INDEX1 <= @numPeriods  group by  RM00103.CUSTNMBR, RMPERDSC  insert into #ReceivablesAgingTemp  (PeriodDescription,  AgingAmount,  Filter)  select  RMPERDSC as PeriodDescription,  SUM(AGPERAMT_7) as AgingAmount,  RM00103.CUSTNMBR  as Filter  from  dbo.RM40201 with (NOLOCK)   INNER JOIN dbo.RM00103 with (NOLOCK)   ON INDEX1 = 7  INNER JOIN @Customers a ON RM00103.CUSTNMBR = a.CUSTNMBR  where  INDEX1 <= @numPeriods  group by  RM00103.CUSTNMBR, RMPERDSC  end  select  * from  #ReceivablesAgingTemp with (NOLOCK)  drop table #ReceivablesAgingTemp    
GO
GRANT EXECUTE ON  [dbo].[seeRMReceivablesAgingMetric] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[seeRMReceivablesAgingMetric] TO [rpt_accounting manager]
GO
GRANT EXECUTE ON  [dbo].[seeRMReceivablesAgingMetric] TO [rpt_accounts receivable coordinator]
GO
GRANT EXECUTE ON  [dbo].[seeRMReceivablesAgingMetric] TO [rpt_bookkeeper]
GO
GRANT EXECUTE ON  [dbo].[seeRMReceivablesAgingMetric] TO [rpt_certified accountant]
GO
GRANT EXECUTE ON  [dbo].[seeRMReceivablesAgingMetric] TO [rpt_collections manager]
GO
GRANT EXECUTE ON  [dbo].[seeRMReceivablesAgingMetric] TO [rpt_executive]
GO
