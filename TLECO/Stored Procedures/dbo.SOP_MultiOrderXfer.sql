SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
 CREATE PROCEDURE [dbo].[SOP_MultiOrderXfer]   @UserID char(15), @CompanyName char(31), @New_Batch char(15), @Orders smallint, @From_Batch char(15), @To_Batch char(15), @From_Customer char(15), @To_Customer char(15), @From_DocID char(15), @To_DocID char(15), @From_SopNumber char(21), @ToSopNumber char(21), @From_DocDate char(15), @To_DocDate char(15), @From_UserDefined char(21), @To_UserDefined char(21), @From_SiteID char(11), @To_SiteID char(11), @From_ShipDate char(15), @To_ShipDate char(15), @From_ShipMethod char(16), @To_ShipMethod char(16), @From_Territory char(16), @To_Territory char(16), @From_Class char(15), @To_Class char(15), @From_Priority smallint, @To_Priority smallint, @UserDefinedFilled as smallint, @O_iErrorState int = NULL output AS  DECLARE  @BATCH char(15),  @BATCH_MarkDelete tinyint,  @BATCH_MarkPost tinyint,  @DocTotal decimal(19,5),  @DEX_ROW_ID integer,  @BATCH_SOURCE char(15),  @SOPNUMBE char(21),  @Module as bit  DECLARE Switch_Batch_Cursor cursor for SELECT DISTINCT ORD.BACHNUMB, BATCH.MKDTOPST, BATCH.DELBACH, ORD.ORDOCAMT, ORD.DEX_ROW_ID, ORD.BCHSOURC, ORD.SOPNUMBE  FROM SOP10100 as ORD  INNER JOIN RM00101 as CUST  ON ORD.CUSTNMBR = CUST.CUSTNMBR  INNER JOIN SY00500 as BATCH  ON ORD.BCHSOURC = BATCH.BCHSOURC and ORD.BACHNUMB = BATCH.BACHNUMB  LEFT OUTER JOIN SOP10106 AS USERDEFINED  ON ORD.SOPTYPE=USERDEFINED.SOPTYPE AND ORD.SOPNUMBE = USERDEFINED.SOPNUMBE  INNER JOIN SOP10200 AS LINE  ON ORD.SOPTYPE=LINE.SOPTYPE AND ORD.SOPNUMBE = LINE.SOPNUMBE  WHERE ORD.SOPTYPE = @Orders   AND ORD.BACHNUMB BETWEEN @From_Batch AND @To_Batch   AND ORD.CUSTNMBR BETWEEN @From_Customer AND @To_Customer   AND ORD.DOCID BETWEEN @From_DocID and @To_DocID   AND ORD.SOPNUMBE BETWEEN @From_SopNumber AND @ToSopNumber   AND ORD.DOCDATE BETWEEN @From_DocDate AND @To_DocDate   AND ((USERDEFINED.USRTAB01 BETWEEN @From_UserDefined AND @To_UserDefined) OR (USERDEFINED.USRTAB01 IS NULL AND @UserDefinedFilled = 1))   AND LINE.LOCNCODE BETWEEN @From_SiteID AND @To_SiteID   AND LINE.ReqShipDate BETWEEN @From_ShipDate AND @To_ShipDate   AND LINE.SHIPMTHD BETWEEN @From_ShipMethod AND @To_ShipMethod   AND LINE.SALSTERR BETWEEN @From_Territory AND @To_Territory   AND CUST.CUSTCLAS BETWEEN @From_Class and @To_Class   AND CUST.CUSTPRIORITY BETWEEN @From_Priority AND @To_Priority  OPEN Switch_Batch_Cursor  FETCH Switch_Batch_Cursor INTO  @BATCH,  @BATCH_MarkDelete,  @BATCH_MarkPost,  @DocTotal,  @DEX_ROW_ID,  @BATCH_SOURCE,  @SOPNUMBE  WHILE @@FETCH_STATUS = 0  BEGIN  IF @BATCH_MarkDelete = 0 and @BATCH_MarkPost = 0  BEGIN  IF (SELECT count(*) FROM DYNAMICS.dbo.SY00800 WHERE BCHSOURC = 'Sales Entry' and BACHNUMB = @BATCH and USERID = @UserID and CMPNYNAM = @CompanyName and WINTYPE = 6) = 0  BEGIN  INSERT INTO DYNAMICS.dbo.SY00800 (WINTYPE, USERID, CMPNYNAM, BCHSOURC, BACHNUMB, POSTING, TRXSOURC)  VALUES (6, @UserID, @CompanyName, 'Sales Entry', @BATCH, 0, 'Sales Transaction Entry')  END  ELSE  BEGIN  UPDATE DYNAMICS.dbo.SY00800 SET POSTING = 0, TRXSOURC = 'Sales Transaction Entry'  WHERE BCHSOURC = 'Sales Entry' and BACHNUMB =  @BATCH and USERID = @UserID and CMPNYNAM = @CompanyName and WINTYPE = 6  END   IF (SELECT count(*)  FROM tempdb.dbo.DEX_LOCK WHERE table_path_name = DB_NAME() + '.dbo.SOP10100' and row_id = @DEX_ROW_ID) = 0  BEGIN  BEGIN TRANSACTION  UPDATE SY00500 SET NUMOFTRX = NUMOFTRX - 1, BCHTOTAL = BCHTOTAL - @DocTotal  WHERE BCHSOURC = @BATCH_SOURCE and BACHNUMB = @BATCH  IF @@ERROR <> 0 or @@ROWCOUNT = 0  BEGIN  ROLLBACK TRANSACTION   END  ELSE  BEGIN  UPDATE SY00500 SET NUMOFTRX = NUMOFTRX + 1, BCHTOTAL = BCHTOTAL + @DocTotal  WHERE BCHSOURC = @BATCH_SOURCE and BACHNUMB = @New_Batch  IF @@ERROR <> 0 or @@ROWCOUNT = 0  BEGIN  ROLLBACK TRANSACTION   END  ELSE  BEGIN  UPDATE SOP10100 SET BACHNUMB = @New_Batch,DSTBTCH2=@New_Batch  WHERE SOPTYPE = @Orders and SOPNUMBE = @SOPNUMBE  IF @@ERROR <> 0 or @@ROWCOUNT = 0  BEGIN  ROLLBACK TRANSACTION   END  ELSE  BEGIN  COMMIT TRANSACTION   END  END  END  END  END  DELETE FROM  DYNAMICS.dbo.SY00800   WHERE BCHSOURC = 'Sales Entry' and BACHNUMB =  @BATCH and USERID = @UserID and CMPNYNAM = @CompanyName and WINTYPE = 6   FETCH Switch_Batch_Cursor INTO  @BATCH,  @BATCH_MarkDelete,  @BATCH_MarkPost,  @DocTotal,  @DEX_ROW_ID,  @BATCH_SOURCE,  @SOPNUMBE END  CLOSE Switch_Batch_Cursor DEALLOCATE Switch_Batch_Cursor    
GO
GRANT EXECUTE ON  [dbo].[SOP_MultiOrderXfer] TO [DYNGRP]
GO
