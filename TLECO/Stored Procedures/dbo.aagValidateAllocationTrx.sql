SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create      procedure [dbo].[aagValidateAllocationTrx] @JRNENTRY   int  , @aaGLWorkHdrID   int , @IO_nError tinyint output as begin   declare @ACTINDX int,  @ACCTTYPE  int,  @FXDORVAR  int,  @DSTINDX int,  @ClassID int,  @Cnt int,  @BrowseType int,  @aaGLWorkDistID int,  @SQNCLINE  numeric(19,5)   select  @ACTINDX  = 0,  @ACCTTYPE  = 0,  @FXDORVAR  = 0,  @DSTINDX = 0,  @ClassID = 0,   @Cnt  = 0,  @BrowseType = 0,  @aaGLWorkDistID = 0,  @SQNCLINE = 0   set @IO_nError = 1   declare CglAF cursor fast_forward for  Select ACTINDX, ACCTTYPE ,FXDORVAR,SQNCLINE from GL10001 where JRNENTRY = @JRNENTRY and ACCTTYPE = 3   union all  Select ACTINDX, ACCTTYPE ,FXDORVAR, SQNCLINE from GL10101 where JRNENTRY = @JRNENTRY and ACCTTYPE = 3   union all   Select OFFINDX, OFFACTYP, OFFPSTYP ,1200.00000 from GL10100 where JRNENTRY = @JRNENTRY and OFFACTYP = 3   open CglAF  fetch next from CglAF into @ACTINDX, @ACCTTYPE ,@FXDORVAR, @SQNCLINE  while @@fetch_status = 0  begin   SELECT @FXDORVAR = FXDORVAR from GL00100 where ACTINDX = @ACTINDX  Select @aaGLWorkDistID = aaGLWorkDistID from AAG10001   where aaGLWorkHdrID = @aaGLWorkHdrID and   aaGLWorkDistID > 0 and ACTINDX = @ACTINDX   and SQNCLINE = @SQNCLINE   delete AAG3000E where aaGLWorkHdrID = @aaGLWorkHdrID and aaGLWorkDistID = @aaGLWorkDistID   if @FXDORVAR = 1  begin  declare Callc cursor fast_forward for   select DSTINDX from GL00103 where ACTINDX = @ACTINDX  open Callc  fetch next from Callc into @DSTINDX  while @@fetch_status = 0  begin  exec aagGetClassIDBrowseType  @DSTINDX,   @ClassID output,  @BrowseType output   if @BrowseType > 1 and @Cnt = 0  begin  set @Cnt  = 1  set @IO_nError  = 0  if not exists(Select @aaGLWorkDistID from AAG3000E where aaGLWorkHdrID = @aaGLWorkHdrID and aaGLWorkDistID = @aaGLWorkDistID)  insert into AAG3000E  (aaGLWorkHdrID,aaGLWorkDistID,aaGLWorkAssignID,aaDisplayDistID,AADOCVAL,aaErrorNum,aaAcctClassID)  values(@aaGLWorkHdrID,@aaGLWorkDistID,1,@aaGLWorkDistID,1,601,0)   end   else if @BrowseType > 1  begin  if not exists(Select @aaGLWorkDistID from AAG3000E where aaGLWorkHdrID = @aaGLWorkHdrID and aaGLWorkDistID = @aaGLWorkDistID)  insert into AAG3000E  (aaGLWorkHdrID,aaGLWorkDistID,aaGLWorkAssignID,aaDisplayDistID,AADOCVAL,aaErrorNum,aaAcctClassID)  values(@aaGLWorkHdrID,@aaGLWorkDistID,1,@aaGLWorkDistID,1,601,0)   end  fetch next from Callc into @DSTINDX  end   close Callc  deallocate Callc  end   else if @FXDORVAR = 2   begin   declare Cfix cursor fast_forward for   select DSTINDX from GL00104 where ACTINDX = @ACTINDX  open Cfix  fetch next from Cfix into @DSTINDX  while @@fetch_status = 0  begin  exec  aagGetClassIDBrowseType  @DSTINDX,   @ClassID output,  @BrowseType output   if @BrowseType > 1 and @Cnt = 0  begin  set @Cnt  = 1  set @IO_nError  = 0  if not exists(Select @aaGLWorkDistID from AAG3000E where aaGLWorkHdrID = @aaGLWorkHdrID and aaGLWorkDistID = @aaGLWorkDistID)  insert into AAG3000E  (aaGLWorkHdrID,aaGLWorkDistID,aaGLWorkAssignID,aaDisplayDistID,AADOCVAL,aaErrorNum,aaAcctClassID)  values(@aaGLWorkHdrID,@aaGLWorkDistID,1,@aaGLWorkDistID,1,601,0)   end  else if @BrowseType > 1  begin  if not exists(Select @aaGLWorkDistID from AAG3000E where aaGLWorkHdrID = @aaGLWorkHdrID and aaGLWorkDistID = @aaGLWorkDistID)  insert into AAG3000E  (aaGLWorkHdrID,aaGLWorkDistID,aaGLWorkAssignID,aaDisplayDistID,AADOCVAL,aaErrorNum,aaAcctClassID)  values(@aaGLWorkHdrID,@aaGLWorkDistID,1,@aaGLWorkDistID,1,601,0)   end  fetch next from Cfix into @DSTINDX  end   close Cfix  deallocate Cfix   end   fetch next from CglAF into @ACTINDX, @ACCTTYPE ,@FXDORVAR, @SQNCLINE  end  close CglAF  deallocate CglAF  end    
GO
GRANT EXECUTE ON  [dbo].[aagValidateAllocationTrx] TO [DYNGRP]
GO
