SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 Create Procedure [dbo].[SVC_RMA_MarkPost_SerialLot] ( @RecType smallint,  @RMANumber char(15),  @Line Numeric(19,5),  @LotSequence int,  @Marked tinyint, @Posted tinyint, @UserID char(15), @CMPNTSEQ int = 0 )  as declare @original tinyint declare @NumberOfSerials numeric(19,5) declare @Return_Qty numeric(19,5) declare @Item char(31), @UOM char(9), @QtyInBase numeric(19,5)  select @Item = ITEMNMBR, @UOM = UOFM from SVC05200 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line and CMPNTSEQ = @CMPNTSEQ if (select ITMTRKOP from IV00101 where ITEMNMBR = @Item) = 1 and @Marked = 0 and @Posted = 0  Begin  delete from SVC05255 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line and CMPNTSEQ = @CMPNTSEQ  End  if @LotSequence = 0   begin  update SVC05255 set MARKED = @Marked, POSTED = @Posted where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line and CMPNTSEQ = @CMPNTSEQ  if @Marked = 0 and @Posted = 0   delete from SVC05255 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line and SVC_Original_Serial = 0 and CMPNTSEQ = @CMPNTSEQ  end else  begin  update SVC05255 set MARKED = @Marked, POSTED = @Posted where RETDOCID = @RMANumber and CMPNTSEQ = @CMPNTSEQ  and Return_Record_Type = @RecType and LNSEQNBR = @Line and SLTSQNUM = @LotSequence  if @Marked = 0 and @Posted = 0   delete from SVC05255 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line and CMPNTSEQ = @CMPNTSEQ  and SVC_Original_Serial = 0 and SLTSQNUM = @LotSequence  end  if @Marked = 1  begin  select @NumberOfSerials = isnull(sum(SERLTQTY),0) from SVC05255 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line and CMPNTSEQ = @CMPNTSEQ  exec SVC_Get_QtyInBase @Item,@UOM,1,@QtyInBase OUTPUT   select @Return_Qty = Return_QTY from SVC05015 where USERID = @UserID and RETDOCID = @RMANumber and LNSEQNBR = @Line   if @Return_Qty * @QtyInBase <> @NumberOfSerials  return 101  end return     
GO
GRANT EXECUTE ON  [dbo].[SVC_RMA_MarkPost_SerialLot] TO [DYNGRP]
GO
