SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aagCopyBudget] (  @aaBudgetID INT,  @aaSourceBudgetID INT,  @CalcMethod INT,  @PercOrAmount INT,  @Increase INT,  @IncOB    INT,  @CopyAcc   INT ) AS  BEGIN  DECLARE @ExecString CHAR(500)  SET NOCOUNT ON  SET TRANSACTION ISOLATION LEVEL READ COMMITTED  BEGIN TRANSACTION   SELECT * INTO #TEMP_COPYBUDGET  FROM AAG00904 WHERE aaBudgetID = @aaSourceBudgetID  SELECT * INTO #TEMP_COPYBUDGETACC  FROM AAG00905 WHERE aaBudgetID = @aaSourceBudgetID   UPDATE #TEMP_COPYBUDGET  SET Balance = CASE @CalcMethod  WHEN 1 THEN 0  WHEN 2 THEN Balance  WHEN 3 THEN (SELECT CASE @Increase  WHEN 0 THEN (Balance * ((100.00 - @PercOrAmount)/100.00))  WHEN 1 THEN (Balance * ((100.00 + @PercOrAmount)/100.00))  END)  WHEN 4 THEN Balance  END,  QUANTITY = CASE @CalcMethod  WHEN 1 THEN 0  WHEN 2 THEN QUANTITY  WHEN 3 THEN (SELECT CASE @Increase  WHEN 0 THEN (QUANTITY * ((100.00 - @PercOrAmount)/100.00))  WHEN 1 THEN (QUANTITY * ((100.00 + @PercOrAmount)/100.00))  END)  WHEN 4 THEN QUANTITY  END   UPDATE #TEMP_COPYBUDGETACC  SET Balance = CASE @CalcMethod  WHEN 1 THEN 0  WHEN 2 THEN Balance  WHEN 3 THEN (SELECT CASE @Increase  WHEN 0 THEN (Balance * ((100.00 - @PercOrAmount)/100.00))  WHEN 1 THEN (Balance * ((100.00 + @PercOrAmount)/100.00))  END)  END   UPDATE AAG00904  SET Balance = 0, QUANTITY = 0  WHERE aaBudgetID = @aaBudgetID   UPDATE DEST  SET DEST.Balance = SOURCE.Balance,   DEST.QUANTITY = SOURCE.QUANTITY  FROM #TEMP_COPYBUDGET SOURCE, AAG00904 DEST  WHERE  DEST.aaBudgetID = @aaBudgetID and  SOURCE.aaCodeSequence = DEST.aaCodeSequence and  SOURCE.aaFiscalPeriod = DEST.aaFiscalPeriod   IF @CopyAcc = 1  BEGIN  UPDATE AAG00905  SET Balance = 0  WHERE aaBudgetID = @aaBudgetID   IF NOT EXISTS (SELECT DEST.*   FROM #TEMP_COPYBUDGETACC SOURCE, AAG00905 DEST   WHERE DEST.aaBudgetID = @aaBudgetID and  SOURCE.aaCodeSequence = DEST.aaCodeSequence and  SOURCE.ACTINDX = DEST.ACTINDX and  SOURCE.aaFiscalPeriod = DEST.aaFiscalPeriod)  BEGIN  INSERT INTO AAG00905  SELECT   AAG00904.aaBudgetID,   AAG00904.aaCodeSequence,   AAG00905.ACTINDX,   AAG00904.PERIODDT,   AAG00904.aaFiscalPeriod,   AAG00904.aaActualPriliminary,   AAG00905.aaRange,   0,  AAG00904.YEAR1  FROM AAG00904, AAG00905  WHERE  AAG00904.aaBudgetID = @aaBudgetID AND  AAG00905.aaBudgetID = @aaSourceBudgetID AND  AAG00904.aaCodeSequence = AAG00905.aaCodeSequence AND  AAG00904.aaFiscalPeriod = AAG00905.aaFiscalPeriod   END   UPDATE DEST  SET DEST.Balance = SOURCE.Balance  FROM #TEMP_COPYBUDGETACC SOURCE, AAG00905 DEST  WHERE  DEST.aaBudgetID = @aaBudgetID and  SOURCE.aaCodeSequence = DEST.aaCodeSequence and  SOURCE.ACTINDX = DEST.ACTINDX and  SOURCE.aaFiscalPeriod = DEST.aaFiscalPeriod  END  IF @IncOB = 0  BEGIN  UPDATE AAG00904   SET Balance = 0.00   WHERE aaBudgetID = @aaBudgetID AND  aaFiscalPeriod = 0  UPDATE AAG00905   SET Balance = 0.00   WHERE aaBudgetID = @aaBudgetID AND  aaFiscalPeriod = 0  END   IF @@ERROR <> 0  BEGIN  ROLLBACK TRANSACTION  END  ELSE  BEGIN  COMMIT TRANSACTION  END  SET NOCOUNT OFF END    
GO
GRANT EXECUTE ON  [dbo].[aagCopyBudget] TO [DYNGRP]
GO
