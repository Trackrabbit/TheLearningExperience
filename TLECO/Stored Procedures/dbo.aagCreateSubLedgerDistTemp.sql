SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create      procedure [dbo].[aagCreateSubLedgerDistTemp] @I_nHdrID int = 0, @I_cTableDistTemp nvarchar(30) = null, @I_fPostedTrx tinyint = 0, @aaFutureDist tinyint=0, @Error tinyint =0  as BEGIN  declare  @TempTable VARCHAR (50),  @TempTableQuery VARCHAR (8000)   select @TempTable = '##aaSubLedgerDistTemp'  + REPLACE(system_user,'''','') + db_name()  select @TempTableQuery = 'drop table [' + @TempTable + ']'   If exists(select name from tempdb..sysobjects where name = @TempTable    and type = 'U')   exec (@TempTableQuery)   Begin   Declare @Min int,   @Str varchar(50)  Select   @Min = 0,  @Str = ''   If @Error = 1   set @Str = ''   Else  If @aaFutureDist = 1  set @Str = ' and aaFutureDist = 1'  Else   set @Str = ' and aaFutureDist = 0'    Exec('select [aaSubLedgerHdrID], [aaSubLedgerDistID], [INTERID], [CorrespondingUnit], [ACTINDX], [DISTTYPE], [ACCTTYPE], [aaBrowseType],   [DECPLACS], [DEBITAMT], [CRDTAMNT], [ORDBTAMT], [ORCRDAMT], [CURNCYID], [CURRNIDX], [RATETPID], [EXGTBLID], [XCHGRATE], [EXCHDATE],   [TIME1], [RTCLCMTD], [DENXRATE], [MCTRXSTT], [SEQNUMBR], [GLPOSTDT], [aaCustID], [aaVendID], [aaSiteID], [aaItemID], [aaCopyStatus],   [aaWinWasOpen], [POSTED], [HISTORY], [aaDistErrors], [APTVCHNM], [APTODCTY], [aaFutureDist], [aaOffsetAcct], [ITEMNMBR], [TRXLOCTN], [BINNMBR], [TRNSTLOC], [TRXQTY]  INTO [' + @TempTable + '] from AAG20001 where aaSubLedgerHdrID = ' + @I_nHdrID + ' and aaBrowseType <> 0 and aaBrowseType <> 3 and POSTED = ' + @I_fPostedTrx+ @Str)   If @aaFutureDist = 1   Begin  Select @Min = isnull(count(*),1) + 1  from AAG20001   where  aaSubLedgerHdrID = @I_nHdrID and   aaSubLedgerDistID >= 0 and aaBrowseType <> 0  and   aaFutureDist = 0   exec('alter table [' + @TempTable + '] add aaDistplayDistID int IDENTITY('+ @Min + ', 1)')  End   Else  Begin  exec('alter table [' + @TempTable + '] add aaDistplayDistID int IDENTITY(1, 1)')  End   Exec('truncate table ' + @I_cTableDistTemp)  Exec('Insert into ' + @I_cTableDistTemp + ' select * from [' + @TempTable + ']')  If (Select SERIES from AAG20000 Where aaSubLedgerHdrID =@I_nHdrID) =5 and  (Select DOCTYPE from AAG20000 Where aaSubLedgerHdrID =@I_nHdrID) =3  Exec('Update ' + @I_cTableDistTemp + ' Set TRXLOCTN = TRNSTLOC Where aaOffsetAcct =1')  exec(@TempTableQuery)  Return  End END    
GO
GRANT EXECUTE ON  [dbo].[aagCreateSubLedgerDistTemp] TO [DYNGRP]
GO
