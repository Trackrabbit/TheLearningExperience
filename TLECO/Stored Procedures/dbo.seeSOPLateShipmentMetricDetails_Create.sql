SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[seeSOPLateShipmentMetricDetails_Create] @iLanguageID int   as   set nocount on   declare @sqldropstring varchar(400),   @sqlstring1 varchar(8000),   @sqlstring2 varchar(8000),   @sqlstring3 varchar(8000),   @sqlstring4 varchar(8000),   @sqlstring5 varchar(8000),   @sqlstring6 varchar(8000),   @sqlstring7 varchar(8000),   @sqlstring8 varchar(8000),   @sqlstring9 varchar(8000),   @sqlstring10 varchar(8000),   @sqljoinstring varchar(8000),   @sqlaccessstring varchar(2000),   @tNumberSegments int,   @tSegment int,   @I_iDictID int,   @I_iLangID int,   @I_iMessageNumber int,   @I_iAliasMessageNumber int,   @I_iIntegerValue int,  @SOP_Type varchar(255), @SOP_Number varchar(255) select @I_iDictID = 1493 select @I_iMessageNumber = 22600 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgStringForProcs  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @SOP_Type output   select @I_iDictID = 1493 select @I_iMessageNumber = 22601 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgStringForProcs  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @SOP_Number output   select @sqldropstring =   'IF EXISTS (SELECT * FROM   sys.objects WHERE  object_id = OBJECT_ID(N''[dbo].[seeSOPLateShipmentMetricDetails]'') AND type in ( N''P'', N''PC'' ))  ' +   '  DROP PROCEDURE [dbo].[seeSOPLateShipmentMetricDetails]  '   select @sqlstring1 =   'create procedure dbo.seeSOPLateShipmentMetricDetails '+   '  @I_dEndDate datetime = NULL, '+   '  @I_iPeriodDays int   = NULL '+   'as '+    'select distinct '+   'DATEDIFF(day, T.ReqShipDate, T.ACTLSHIP) as DaysLate, '+   'T.SOPNUMBE, '+   'T.SOPTYPE, '+   'T.ReqShipDate, '+   'T.ACTLSHIP, '+   'V.* '+   'into #LateShipmentDetailsForOpen '+   'from SalesTransactions as V, dbo.SOP10200 as T '+   'where '+   ' (T.SOPTYPE = 2 or T.SOPTYPE = 3 or T.SOPTYPE = 6)  '+   ' and T.ReqShipDate < T.ACTLSHIP  '+   ' and (dbo.DYN_FUNC_SOP_Type(T.SOPTYPE) = V.['+@SOP_Type+'])  '+   ' and (T.SOPNUMBE = V.['+@SOP_Number+']) '+   'select distinct '+   'DATEDIFF(day, THeader.ReqShipDate, THeader.ACTLSHIP) as DaysLate, '+   'THeader.SOPNUMBE, '+   'THeader.SOPTYPE, '+   'TLine.ReqShipDate, '+   'TLine.ACTLSHIP, '+   'V.* '+   'into #LateShipmentDetailsForHistory '+   'from SalesTransactions as V,  '+   ' dbo.SOP30300 as TLine with (NOLOCK), '+   ' dbo.SOP30200 as THeader with (NOLOCK) '+   'where THeader.VOIDSTTS <> 1  '+   ' and THeader.SOPTYPE = 3  '+   ' and (THeader.SOPTYPE = TLine.SOPTYPE and THeader.SOPNUMBE = TLine.SOPNUMBE)  '+   ' and TLine.ReqShipDate < TLine.ACTLSHIP  '+   ' and (dbo.DYN_FUNC_SOP_Type(THeader.SOPTYPE) = V.['+@SOP_Type+']) '+   ' and (THeader.SOPNUMBE = V.['+@SOP_Number+']) '+   'select ForOpen.* '+   'into #LateShipmentDetails '+   'from #LateShipmentDetailsForOpen as ForOpen '+   'insert into #LateShipmentDetails '+   'select ForHistory.*  '+   'from #LateShipmentDetailsForHistory as ForHistory '+   'if @I_dEndDate is not null or @I_iPeriodDays is not null '+   ' select distinct * from #LateShipmentDetails '+   '  where ReqShipDate >= @I_dEndDate - @I_iPeriodDays + 1  '+   '   and ReqShipDate <= @I_dEndDate '+   'else '+   ' select distinct * from #LateShipmentDetails '+   'drop table #LateShipmentDetails '+   'drop table #LateShipmentDetailsForOpen '+   'drop table #LateShipmentDetailsForHistory '  select @sqlaccessstring =   'GRANT execute ON [dbo].[seeSOPLateShipmentMetricDetails] TO [rpt_shipping and receiving],[rpt_materials manager],[rpt_operations manager], '+  '  [rpt_warehouse manager],[rpt_executive] '  exec (@sqldropstring)   exec (@sqlstring1+' '+@sqlstring2+' '+@sqlstring3+' '+@sqlstring4+' '+@sqlstring5+' '+@sqlstring6+' '+@sqlstring7+' '+@sqlstring8+' '+@sqlstring9+' '+@sqlstring10)   exec (@sqlaccessstring)   set nocount off    
GO
GRANT EXECUTE ON  [dbo].[seeSOPLateShipmentMetricDetails_Create] TO [DYNGRP]
GO
