SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create PROCEDURE [dbo].[SVC_RET_CreateExpiredRevenue] (@User char(15),   @CHECKDATE datetime)  AS  declare @ContractNumber char(11) declare @Line numeric(19,5) declare @Customer char(15) declare @Amount numeric(19,5), @OrigAmount numeric(19,5) declare @Total numeric(19,5), @OrigTotal numeric(19,5) declare @TotalInvoiced numeric(19,5), @OrigTotalInvoiced numeric(19,5) declare @StartDate  datetime,  @EndDate    datetime,  @YEAR1      smallint,  @PERIODID   smallint,  @RevenueLine integer declare @SRVRECTYPE smallint, @Call char(11) declare @MinDate datetime  exec smGetMinDate @MinDate output exec SVC_GetFiscalPeriodDates @User, @CHECKDATE,@StartDate OUTPUT,  @EndDate OUTPUT, @YEAR1 OUTPUT, @PERIODID OUTPUT declare contract_revenue CURSOR for select CONTNBR from SVC00625  WHERE USERID = @User and MKDTOPST = 1 and CNTTYPE = 'Expired' OPEN contract_revenue fetch next from contract_revenue into @ContractNumber while @@FETCH_STATUS = 0  BEGIN  declare contract_line CURSOR for select LNSEQNBR, TOTAL, ORIGTOTAL from SVC00601  WHERE SVC00601.CONSTS = 2 and SVC00601.BILSTAT > 0 and SVC00601.SVC_Liability_Type> 1  and SVC00601.ENDDATE <= @CHECKDATE and CONTNBR = @ContractNumber and Contract_Line_Status <> 'C'  open contract_line  fetch next from contract_line into @Line, @Total, @OrigTotal  while @@FETCH_STATUS = 0  Begin  exec SVC_Check_Contract_OnCalls 2, @ContractNumber, @Line, @SRVRECTYPE output, @Call output  if not(@Call > '' and @SRVRECTYPE = 2)  begin  select @Amount = sum(SVC00604.Net_Transaction_Amount),  @OrigAmount = sum(SVC00604.OrigNetTransactionAmount),  @RevenueLine = max(LNITMSEQ) + 1  FROM SVC00604 where CONSTS = 2 and CONTNBR = @ContractNumber and LNSEQNBR = @Line  select @TotalInvoiced = SUM(IsNull(DOCAMNT,0) - IsNull(SVC_Invoice_Credit_Amoun,0))- SUM(isnull(DSCDLRAM,0)),  @OrigTotalInvoiced = SUM(IsNull(ORDOCAMT,0) - IsNull(OrigInvCreditAmt,0)) - SUM(isnull(ORDDLRAT,0))  from SVC00603 where CONSTS = 2 and CONTNBR = @ContractNumber and LNSEQNBR = @Line  select @Amount = @TotalInvoiced - isnull(@Amount,0),  @OrigAmount = @OrigTotalInvoiced - isnull(@OrigAmount,0),  @RevenueLine = isnull(@RevenueLine,1)  if @Amount > 0  insert into SVC00604 select  2, @ContractNumber, @Line, @YEAR1, @PERIODID, @RevenueLine, 0, @MinDate,  @CHECKDATE, @User, 0, 0, 'CAL',  CONVERT(varchar(1),2) + '-' + RTRIM(CONVERT(varchar(20),@ContractNumber)) + '-' +  CONVERT(varchar(20),@Line),  @Amount, @OrigAmount, @StartDate, @EndDate, 0, 0, 0, 0,  @Amount, @OrigAmount  end  fetch next from contract_line into @Line, @Total, @OrigTotal  End  DEALLOCATE contract_line   fetch next from contract_revenue into @ContractNumber  END DEALLOCATE contract_revenue  return   
GO
GRANT EXECUTE ON  [dbo].[SVC_RET_CreateExpiredRevenue] TO [DYNGRP]
GO
