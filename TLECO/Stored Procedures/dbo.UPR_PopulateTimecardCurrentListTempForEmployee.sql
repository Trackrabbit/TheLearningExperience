SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 Create Proc [dbo].[UPR_PopulateTimecardCurrentListTempForEmployee]  (@I_sListTempTableName char(30) = NULL, @I_sReportsToTableName char(30) = NULL, @I_nModule smallint = NULL, @EmployeeID varchar(15),  @OrderByColumn1 varchar(15),  @OrderByColumn2 varchar(15),  @OrderByColumn3 varchar(15),  @OrderByColumn4 varchar(15),   @OrderByColumn5 varchar(15),  @UserDate as varchar(20),  @UpdateType as smallint, @O_SQL_Error_State int= NULL output) as  declare   @iStatus int,  @iError int  select  @O_SQL_Error_State = 0,  @iStatus = 0,   @iError = 0  if (  @I_sListTempTableName is NULL or  @I_nModule is NULL or @I_sReportsToTableName is NULL or @OrderByColumn1 is NULL or  @OrderByColumn2 is NULL or  @OrderByColumn3 is NULL or  @OrderByColumn4 is NULL or  @OrderByColumn5 is NULL or  @UserDate is NULL or @UpdateType is NULL )  begin  select @O_SQL_Error_State = 26000  return end  if @I_nModule = 35  or @I_nModule = 0 BEGIN  DECLARE @SQLString varchar(8000), @IncludeInactive smallint, @IncludeInactiveString varchar(100),  @UPR_WF_Status_Str varchar(100)   SET @IncludeInactive = (SELECT INCINEMP FROM UPR40200 WHERE SETUPKEY = 1)  SET @IncludeInactiveString = ''  IF (@IncludeInactive = 0)  BEGIN  SET @IncludeInactiveString = ' AND E.INACTIVE = 0 '  END  IF EXISTS(SELECT TOP 1 1 FROM WF100002 WHERE Workflow_Type_Name = 'Payroll Timecard Approval' and ACTIVE = 1)  BEGIN  SET @UPR_WF_Status_Str = ' CASE ISNULL(TC.Workflow_Status, 0) WHEN 0 THEN 1 ELSE TC.Workflow_Status END '  END  ELSE  BEGIN  SET @UPR_WF_Status_Str = ' CASE ISNULL(TC.Workflow_Status, 0) WHEN 0 THEN 9 ELSE TC.Workflow_Status END '  END   if (@UpdateType = 1)   BEGIN  SET @SQLString = '  WITH MyCTE AS  (  SELECT   H.EMPLOYID, S.Pay_Schedule, S.YEAR1, S.PERIODID, S.PERNAME, S.STRTDATE, S.ENDDATE, H.Group_ID, H.LVLLABEL, H.LASTNAME, H.FRSTNAME, H.MIDLNAME, H.EMPLSUFF, H.Supervisor_Employee_ID, H.USERID,  H.SUPERVISORCODE_I, H.SUPERVISOR, H.PHONE1, H.PHONE2, LEFT(LTRIM(RTRIM(H.Supervisor_Last_Name)) + '', '' + LTRIM(RTRIM(H.Supervisor_First_Name)) + '' '' + LTRIM(RTRIM(H.Supervisor_Middle_Name)), 40) AS EMPLNAME,   ISNULL(SUM(TD.UNTSTOPY), 0) AS UNTSTOPY, SH.PAYPEROD, 0 AS InfoValue, 0 AS MKTOPROC, ' + @UPR_WF_Status_Str + ' AS Workflow_Status, SH.Current_Pay_Periods, ROW_NUMBER() OVER(PARTITION BY H.EMPLOYID, S.Pay_Schedule ORDER BY S.Pay_Schedule, S.YEAR1, S.PERIODID) AS Counter,  E.DEPRTMNT AS DEPRTMNT, E.JOBTITLE AS JOBTITLE, E.LOCATNID AS LOCATNID, E.DIVISIONCODE_I AS DIVISIONCODE_I, '''' AS CMMTTEXT  FROM UPR42101 AS S  LEFT OUTER JOIN UPR42100 AS SH ON S.Pay_Schedule = SH.Pay_Schedule  CROSS JOIN ' + @I_sReportsToTableName + ' AS H   LEFT OUTER JOIN UPR00100 AS E ON E.EMPLOYID = H.EMPLOYID  LEFT OUTER JOIN UPR10500 AS TC ON TC.EMPLOYID = H.EMPLOYID AND TC.Pay_Schedule = SH.Pay_Schedule AND TC.YEAR1 = S.YEAR1 AND TC.PERIODID = S.PERIODID  LEFT OUTER JOIN UPR10501 AS TD ON TC.EMPLOYID = TD.EMPLOYID AND TC.Pay_Schedule = TD.Pay_Schedule AND TC.YEAR1 = TD.YEAR1 AND TC.PERIODID = TD.PERIODID  LEFT OUTER JOIN UPR30500 HIST ON HIST.Pay_Schedule = S.Pay_Schedule AND HIST.YEAR1 = S.YEAR1 AND HIST.PERIODID = S.PERIODID AND HIST.EMPLOYID = H.EMPLOYID  WHERE H.EMPLOYID IN (SELECT EMPLOYID FROM ' + @I_sReportsToTableName + ')  AND S.Pay_Schedule IN (dbo.UPR_GetEmployeePaySchedule(H.EMPLOYID, SH.PAYPEROD, ''' + @OrderByColumn1 + ''', ''' + @OrderByColumn2 + ''', ''' + @OrderByColumn3 + ''', ''' + @OrderByColumn4 + ''', ''' + @OrderByColumn5 + ''')) ' + '  AND S.STRTDATE >= ''' + @UserDate + '''' + @IncludeInactiveString + '  AND HIST.EMPLOYID IS NULL  GROUP BY H.EMPLOYID, S.Pay_Schedule, S.YEAR1, S.PERIODID, S.PERNAME, S.STRTDATE, S.ENDDATE, H.Group_ID, H.LVLLABEL, H.LASTNAME, H.FRSTNAME, H.MIDLNAME, H.EMPLSUFF, H.Supervisor_Employee_ID, H.USERID,  H.SUPERVISORCODE_I, H.SUPERVISOR, H.PHONE1, H.PHONE2, H.Supervisor_Last_Name, H.Supervisor_First_Name, H.Supervisor_Middle_Name, SH.PAYPEROD, TC.Workflow_Status, SH.Current_Pay_Periods,  E.DEPRTMNT, E.JOBTITLE, E.LOCATNID, E.DIVISIONCODE_I  )  INSERT INTO ' + @I_sListTempTableName + '   (EMPLOYID, Pay_Schedule, YEAR1, PERIODID, PERNAME, STRTDATE, ENDDATE, Group_ID, LVLLABEL, LASTNAME, FRSTNAME, MIDLNAME, EMPLSUFF, Supervisor_Employee_ID, USERID,   SUPERVISORCODE_I, SUPERVISOR, PHONE1, PHONE2, EMPLNAME,   UNTSTOPY, PAYPEROD, InfoValue, MKTOPROC, Workflow_Status, DEPRTMNT, JOBTITLE, LOCATNID, DIVISIONCODE_I, CMMTTEXT, Workflow_Due_Date, Workflow_Due_Time, Workflow_Name, Workflow_Approver, Workflow_Originator, Workflow_Type_Name, WorkflowInstanceID, WorkflowStepInstanceID, Workflow_Step_Type)  SELECT EMPLOYID, Pay_Schedule, YEAR1, PERIODID, PERNAME, STRTDATE, ENDDATE, Group_ID, LVLLABEL, LASTNAME, FRSTNAME, MIDLNAME, EMPLSUFF, Supervisor_Employee_ID, USERID,  SUPERVISORCODE_I, SUPERVISOR, PHONE1, PHONE2, EMPLNAME,   UNTSTOPY, PAYPEROD, InfoValue, MKTOPROC, MyCTE.Workflow_Status, DEPRTMNT, JOBTITLE, LOCATNID, DIVISIONCODE_I, CMMTTEXT, convert(char(10), getdate(), 111) , '''', REPLICATE(''X'', 51), REPLICATE(''X'', 238), REPLICATE(''X'', 238),'''','''','''',0  FROM MyCTE  WHERE Counter <= Current_Pay_Periods'   exec(@SQLString)   SET @SQLString = '  WITH MyCTE AS  (  SELECT   H.EMPLOYID, S.Pay_Schedule, S.YEAR1, S.PERIODID, S.PERNAME, S.STRTDATE, S.ENDDATE, H.Group_ID, H.LVLLABEL, H.LASTNAME, H.FRSTNAME, H.MIDLNAME, H.EMPLSUFF, H.Supervisor_Employee_ID, H.USERID,  H.SUPERVISORCODE_I, H.SUPERVISOR, H.PHONE1, H.PHONE2, LEFT(LTRIM(RTRIM(H.Supervisor_Last_Name)) + '', '' + LTRIM(RTRIM(H.Supervisor_First_Name)) + '' '' + LTRIM(RTRIM(H.Supervisor_Middle_Name)), 40) AS EMPLNAME,   ISNULL(SUM(TD.UNTSTOPY), 0) AS UNTSTOPY, SH.PAYPEROD, 0 AS InfoValue, 0 AS MKTOPROC, ' + @UPR_WF_Status_Str + ' AS Workflow_Status, SH.Past_Pay_Periods, ROW_NUMBER() OVER(PARTITION BY H.EMPLOYID, S.Pay_Schedule ORDER BY S.Pay_Schedule, S.YEAR1 DESC, S.PERIODID DESC) AS Counter,  E.DEPRTMNT AS DEPRTMNT, E.JOBTITLE AS JOBTITLE, E.LOCATNID AS LOCATNID, E.DIVISIONCODE_I AS DIVISIONCODE_I, '''' AS CMMTTEXT  FROM UPR42101 AS S  LEFT OUTER JOIN UPR42100 AS SH  ON S.Pay_Schedule = SH.Pay_Schedule  CROSS JOIN ' + @I_sReportsToTableName + ' AS H   LEFT OUTER JOIN UPR00100 AS E ON E.EMPLOYID = H.EMPLOYID  LEFT OUTER JOIN UPR10500 AS TC ON TC.EMPLOYID = H.EMPLOYID AND TC.Pay_Schedule = SH.Pay_Schedule AND TC.YEAR1 = S.YEAR1 AND TC.PERIODID = S.PERIODID  LEFT OUTER JOIN UPR10501 AS TD ON TC.EMPLOYID = TD.EMPLOYID AND TC.Pay_Schedule = TD.Pay_Schedule AND TC.YEAR1 = TD.YEAR1 AND TC.PERIODID = TD.PERIODID  LEFT OUTER JOIN UPR30500 HIST ON HIST.Pay_Schedule = S.Pay_Schedule AND HIST.YEAR1 = S.YEAR1 AND HIST.PERIODID = S.PERIODID AND HIST.EMPLOYID = H.EMPLOYID  WHERE H.EMPLOYID IN (SELECT EMPLOYID FROM ' + @I_sReportsToTableName + ')  AND S.Pay_Schedule IN (dbo.UPR_GetEmployeePaySchedule(H.EMPLOYID, SH.PAYPEROD, ''' + @OrderByColumn1 + ''', ''' + @OrderByColumn2 + ''', ''' + @OrderByColumn3 + ''', ''' + @OrderByColumn4 + ''', ''' + @OrderByColumn5 + ''')) ' + '  AND S.STRTDATE < ''' + @UserDate + '''' + @IncludeInactiveString + '  AND HIST.EMPLOYID IS NULL  GROUP BY H.EMPLOYID, S.Pay_Schedule, S.YEAR1, S.PERIODID, S.PERNAME, S.STRTDATE, S.ENDDATE, H.Group_ID, H.LVLLABEL, H.LASTNAME, H.FRSTNAME, H.MIDLNAME, H.EMPLSUFF, H.Supervisor_Employee_ID, H.USERID,  H.SUPERVISORCODE_I, H.SUPERVISOR, H.PHONE1, H.PHONE2, H.Supervisor_Last_Name, H.Supervisor_First_Name, H.Supervisor_Middle_Name, SH.PAYPEROD, TC.Workflow_Status, SH.Past_Pay_Periods,  E.DEPRTMNT, E.JOBTITLE, E.LOCATNID, E.DIVISIONCODE_I  )  INSERT INTO ' + @I_sListTempTableName + '   (EMPLOYID, Pay_Schedule, YEAR1, PERIODID, PERNAME, STRTDATE, ENDDATE, Group_ID, LVLLABEL, LASTNAME, FRSTNAME, MIDLNAME, EMPLSUFF, Supervisor_Employee_ID, USERID,   SUPERVISORCODE_I, SUPERVISOR, PHONE1, PHONE2, EMPLNAME,   UNTSTOPY, PAYPEROD, InfoValue, MKTOPROC, Workflow_Status, DEPRTMNT, JOBTITLE, LOCATNID, DIVISIONCODE_I, CMMTTEXT, Workflow_Due_Date, Workflow_Due_Time, Workflow_Name, Workflow_Approver, Workflow_Originator, Workflow_Type_Name, WorkflowInstanceID, WorkflowStepInstanceID, Workflow_Step_Type)  SELECT EMPLOYID, Pay_Schedule, YEAR1, PERIODID, PERNAME, STRTDATE, ENDDATE, Group_ID, LVLLABEL, LASTNAME, FRSTNAME, MIDLNAME, EMPLSUFF, Supervisor_Employee_ID, USERID,  SUPERVISORCODE_I, SUPERVISOR, PHONE1, PHONE2, EMPLNAME,   UNTSTOPY, PAYPEROD, InfoValue, MKTOPROC, MyCTE.Workflow_Status, DEPRTMNT, JOBTITLE, LOCATNID, DIVISIONCODE_I, CMMTTEXT, convert(char(10), getdate(), 111) , '''', REPLICATE(''X'', 51), REPLICATE(''X'', 238), REPLICATE(''X'', 238),'''','''','''',0  FROM MyCTE  WHERE Counter <= Past_Pay_Periods'  exec(@SQLString)  END   if (@UpdateType = 2)   BEGIN  SET @SQLString = '  WITH MyCTE AS  (  SELECT E.EMPLOYID AS EMPLOYID, S.Pay_Schedule, S.YEAR1, S.PERIODID, S.PERNAME, S.STRTDATE, S.ENDDATE, 999 AS Group_ID,   ''Delegate'' AS LVLLABEL, E.LASTNAME, E.FRSTNAME, E.MIDLNAME, E.EMPLSUFF, ISNULL(H.EMPLOYID, '''') AS Supervisor_Employee_ID, E.USERID,  E.SUPERVISORCODE_I, ISNULL(H.SUPERVISOR, '''') AS SUPERVISOR, ISNULL(ADD1.PHONE1, ''00000000000000'') AS PHONE1, ISNULL(ADD2.PHONE1, ''00000000000000'') AS PHONE2,   LEFT(LTRIM(RTRIM(ISNULL(HE.LASTNAME, ''''))) + '', '' + LTRIM(RTRIM(ISNULL(HE.FRSTNAME, ''''))) + '' '' + LTRIM(RTRIM(ISNULL(HE.MIDLNAME, ''''))), 40) AS EMPLNAME,   ISNULL(SUM(TD.UNTSTOPY), 0) AS UNTSTOPY, SH.PAYPEROD, 0 AS InfoValue, 0 AS MKTOPROC, ' + @UPR_WF_Status_Str + ' AS Workflow_Status,   SH.Current_Pay_Periods, ROW_NUMBER() OVER(PARTITION BY E.EMPLOYID, S.Pay_Schedule ORDER BY S.Pay_Schedule, S.YEAR1, S.PERIODID) AS Counter,  E.DEPRTMNT AS DEPRTMNT, E.JOBTITLE AS JOBTITLE, E.LOCATNID AS LOCATNID, E.DIVISIONCODE_I AS DIVISIONCODE_I, '''' AS CMMTTEXT  FROM UPR42101 AS S  LEFT OUTER JOIN UPR42100 AS SH  ON S.Pay_Schedule = SH.Pay_Schedule  CROSS JOIN UPR00100 AS E   LEFT OUTER JOIN UPR00102 AS ADD1 ON E.EMPLOYID = ADD1.EMPLOYID AND E.ADRSCODE = ADD1.ADRSCODE  LEFT OUTER JOIN UPR41700 AS H ON E.SUPERVISORCODE_I = H.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 AS HE ON H.EMPLOYID = HE.EMPLOYID  LEFT OUTER JOIN UPR00102 AS ADD2 ON HE.EMPLOYID = ADD2.EMPLOYID AND HE.ADRSCODE = ADD2.ADRSCODE  LEFT OUTER JOIN UPR10500 AS TC ON TC.EMPLOYID = E.EMPLOYID AND TC.Pay_Schedule = SH.Pay_Schedule AND TC.YEAR1 = S.YEAR1 AND TC.PERIODID = S.PERIODID  LEFT OUTER JOIN UPR10501 AS TD ON TC.EMPLOYID = TD.EMPLOYID AND TC.Pay_Schedule = TD.Pay_Schedule AND TC.YEAR1 = TD.YEAR1 AND TC.PERIODID = TD.PERIODID  WHERE E.EMPLOYID IN (  SELECT E.EMPLOYID  FROM UPR00100 E  LEFT OUTER JOIN UPR00201 TOBDEPT ON TOBDEPT.DEPRTMNT = E.DEPRTMNT  LEFT OUTER JOIN UPR00202 TOBCLASS ON TOBCLASS.EMPLCLAS = E.EMPLCLAS  LEFT OUTER JOIN UPR00203 TOBEMP ON TOBEMP.Employee_ID_Assigned = E.EMPLOYID  LEFT OUTER JOIN UPR41700 SUP ON E.SUPERVISORCODE_I = SUP.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 EESUP ON SUP.EMPLOYID = EESUP.EMPLOYID  LEFT OUTER JOIN UPR00200 TOBHDR ON TOBDEPT.Time_on_Behalf_Code = TOBHDR.Time_on_Behalf_Code OR TOBCLASS.Time_on_Behalf_Code = TOBHDR.Time_on_Behalf_Code   OR TOBEMP.Time_on_Behalf_Code = TOBEMP.Time_on_Behalf_Code OR TOBHDR.Admin_Code = 1  LEFT OUTER JOIN ' + @I_sListTempTableName + ' LIST ON E.EMPLOYID = LIST.EMPLOYID  WHERE ((TOBDEPT.DEPRTMNT IS NOT NULL OR TOBCLASS.EMPLCLAS IS NOT NULL OR TOBEMP.EMPLOYID IS NOT NULL) OR TOBHDR.Admin_Code = 1) AND   (LIST.EMPLOYID IS NULL AND (TOBDEPT.EMPLOYID = ''' + @EmployeeID + ''' OR TOBCLASS.EMPLOYID = ''' + @EmployeeID + ''' OR TOBEMP.EMPLOYID = ''' + @EmployeeID + '''))) AND  (S.Pay_Schedule IN (dbo.UPR_GetEmployeePaySchedule(E.EMPLOYID, SH.PAYPEROD, ''' + @OrderByColumn1 + ''', ''' + @OrderByColumn2 + ''', ''' + @OrderByColumn3 + ''', ''' + @OrderByColumn4 + ''', ''' + @OrderByColumn5 + '''))) AND   S.STRTDATE >= ''' + @UserDate + '''' + @IncludeInactiveString + '  GROUP BY E.EMPLOYID, S.Pay_Schedule, S.YEAR1, S.PERIODID, S.PERNAME, S.STRTDATE, S.ENDDATE, E.LASTNAME, E.FRSTNAME, E.MIDLNAME, E.EMPLSUFF, H.EMPLOYID,   E.USERID, E.SUPERVISORCODE_I, H.SUPERVISOR, ADD1.PHONE1, ADD2.PHONE1, HE.LASTNAME, HE.FRSTNAME, HE.MIDLNAME, SH.PAYPEROD,   TC.Workflow_Status, SH.Current_Pay_Periods, E.DEPRTMNT, E.JOBTITLE, E.LOCATNID, E.DIVISIONCODE_I  )  INSERT INTO ' + @I_sListTempTableName + ' (EMPLOYID, Pay_Schedule, YEAR1, PERIODID, PERNAME, STRTDATE, ENDDATE, Group_ID,   LVLLABEL, LASTNAME, FRSTNAME, MIDLNAME, EMPLSUFF, Supervisor_Employee_ID, USERID,   SUPERVISORCODE_I, SUPERVISOR, PHONE1, PHONE2, EMPLNAME, UNTSTOPY, PAYPEROD, InfoValue, MKTOPROC, Workflow_Status, DEPRTMNT, JOBTITLE, LOCATNID, DIVISIONCODE_I, CMMTTEXT, Workflow_Due_Date, Workflow_Due_Time, Workflow_Name, Workflow_Approver, Workflow_Originator, Workflow_Type_Name, WorkflowInstanceID, WorkflowStepInstanceID, Workflow_Step_Type)  SELECT C.EMPLOYID, C.Pay_Schedule, C.YEAR1, C.PERIODID, PERNAME, STRTDATE, ENDDATE, Group_ID, LVLLABEL, LASTNAME, FRSTNAME, MIDLNAME, EMPLSUFF, Supervisor_Employee_ID, USERID,  SUPERVISORCODE_I, SUPERVISOR, PHONE1, PHONE2, EMPLNAME, UNTSTOPY, PAYPEROD, InfoValue, MKTOPROC, C.Workflow_Status, DEPRTMNT, JOBTITLE, LOCATNID, DIVISIONCODE_I, CMMTTEXT, convert(char(10), getdate(), 111) , '''', REPLICATE(''X'', 51), REPLICATE(''X'', 238), REPLICATE(''X'', 238),'''','''','''',0  FROM MyCTE C  LEFT OUTER JOIN UPR30500 HIST ON HIST.Pay_Schedule = C.Pay_Schedule AND HIST.YEAR1 = C.YEAR1 AND HIST.PERIODID = C.PERIODID AND HIST.EMPLOYID = C.EMPLOYID  WHERE Counter <= Current_Pay_Periods AND HIST.EMPLOYID IS NULL'   exec(@SQLString)   SET @SQLString = '  WITH MyCTE AS  (  SELECT E.EMPLOYID AS EMPLOYID, S.Pay_Schedule, S.YEAR1, S.PERIODID, S.PERNAME, S.STRTDATE, S.ENDDATE, 999 AS Group_ID,   ''Delegate'' AS LVLLABEL, E.LASTNAME, E.FRSTNAME, E.MIDLNAME, E.EMPLSUFF, ISNULL(H.EMPLOYID, '''') AS Supervisor_Employee_ID, E.USERID,  E.SUPERVISORCODE_I, ISNULL(H.SUPERVISOR, '''') AS SUPERVISOR, ISNULL(ADD1.PHONE1, ''00000000000000'') AS PHONE1, ISNULL(ADD2.PHONE1, ''00000000000000'') AS PHONE2,   LEFT(LTRIM(RTRIM(ISNULL(HE.LASTNAME, ''''))) + '', '' + LTRIM(RTRIM(ISNULL(HE.FRSTNAME, ''''))) + '' '' + LTRIM(RTRIM(ISNULL(HE.MIDLNAME, ''''))), 40) AS EMPLNAME,   ISNULL(SUM(TD.UNTSTOPY), 0) AS UNTSTOPY, SH.PAYPEROD, 0 AS InfoValue, 0 AS MKTOPROC, ' + @UPR_WF_Status_Str + ' AS Workflow_Status,   SH.Past_Pay_Periods, ROW_NUMBER() OVER(PARTITION BY E.EMPLOYID, S.Pay_Schedule ORDER BY S.Pay_Schedule, S.YEAR1 DESC, S.PERIODID DESC) AS Counter,  E.DEPRTMNT AS DEPRTMNT, E.JOBTITLE AS JOBTITLE, E.LOCATNID AS LOCATNID, E.DIVISIONCODE_I AS DIVISIONCODE_I, '''' AS CMMTTEXT  FROM UPR42101 AS S  LEFT OUTER JOIN UPR42100 AS SH  ON S.Pay_Schedule = SH.Pay_Schedule  CROSS JOIN UPR00100 AS E   LEFT OUTER JOIN UPR00102 AS ADD1 ON E.EMPLOYID = ADD1.EMPLOYID AND E.ADRSCODE = ADD1.ADRSCODE  LEFT OUTER JOIN UPR41700 AS H ON E.SUPERVISORCODE_I = H.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 AS HE ON H.EMPLOYID = HE.EMPLOYID  LEFT OUTER JOIN UPR00102 AS ADD2 ON HE.EMPLOYID = ADD2.EMPLOYID AND HE.ADRSCODE = ADD2.ADRSCODE  LEFT OUTER JOIN UPR10500 AS TC ON TC.EMPLOYID = E.EMPLOYID AND TC.Pay_Schedule = SH.Pay_Schedule AND TC.YEAR1 = S.YEAR1 AND TC.PERIODID = S.PERIODID  LEFT OUTER JOIN UPR10501 AS TD ON TC.EMPLOYID = TD.EMPLOYID AND TC.Pay_Schedule = TD.Pay_Schedule AND TC.YEAR1 = TD.YEAR1 AND TC.PERIODID = TD.PERIODID  WHERE E.EMPLOYID IN (  SELECT E.EMPLOYID  FROM UPR00100 E  LEFT OUTER JOIN UPR00201 TOBDEPT ON TOBDEPT.DEPRTMNT = E.DEPRTMNT  LEFT OUTER JOIN UPR00202 TOBCLASS ON TOBCLASS.EMPLCLAS = E.EMPLCLAS  LEFT OUTER JOIN UPR00203 TOBEMP ON TOBEMP.Employee_ID_Assigned = E.EMPLOYID  LEFT OUTER JOIN UPR41700 SUP ON E.SUPERVISORCODE_I = SUP.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 EESUP ON SUP.EMPLOYID = EESUP.EMPLOYID  LEFT OUTER JOIN UPR00200 TOBHDR ON TOBDEPT.Time_on_Behalf_Code = TOBHDR.Time_on_Behalf_Code OR TOBCLASS.Time_on_Behalf_Code = TOBHDR.Time_on_Behalf_Code   OR TOBEMP.Time_on_Behalf_Code = TOBEMP.Time_on_Behalf_Code OR TOBHDR.Admin_Code = 1  LEFT OUTER JOIN ' + @I_sListTempTableName + ' LIST ON E.EMPLOYID = LIST.EMPLOYID  WHERE ((TOBDEPT.DEPRTMNT IS NOT NULL OR TOBCLASS.EMPLCLAS IS NOT NULL OR TOBEMP.EMPLOYID IS NOT NULL) OR TOBHDR.Admin_Code = 1) AND   (LIST.EMPLOYID IS NOT NULL AND LIST.Group_ID = 999 AND (TOBDEPT.EMPLOYID = ''' + @EmployeeID + ''' OR TOBCLASS.EMPLOYID = ''' + @EmployeeID + ''' OR TOBEMP.EMPLOYID = ''' + @EmployeeID + '''))) AND  (S.Pay_Schedule IN (dbo.UPR_GetEmployeePaySchedule(E.EMPLOYID, SH.PAYPEROD, ''' + @OrderByColumn1 + ''', ''' + @OrderByColumn2 + ''', ''' + @OrderByColumn3 + ''', ''' + @OrderByColumn4 + ''', ''' + @OrderByColumn5 + '''))) AND   S.STRTDATE < ''' + @UserDate + '''' + @IncludeInactiveString + '  GROUP BY E.EMPLOYID, S.Pay_Schedule, S.YEAR1, S.PERIODID, S.PERNAME, S.STRTDATE, S.ENDDATE, E.LASTNAME, E.FRSTNAME, E.MIDLNAME, E.EMPLSUFF, H.EMPLOYID,   E.USERID, E.SUPERVISORCODE_I, H.SUPERVISOR, ADD1.PHONE1, ADD2.PHONE1, HE.LASTNAME, HE.FRSTNAME, HE.MIDLNAME, SH.PAYPEROD,   TC.Workflow_Status, SH.Past_Pay_Periods, E.DEPRTMNT, E.JOBTITLE, E.LOCATNID, E.DIVISIONCODE_I  )  INSERT INTO ' + @I_sListTempTableName + ' (EMPLOYID, Pay_Schedule, YEAR1, PERIODID, PERNAME, STRTDATE, ENDDATE, Group_ID,   LVLLABEL, LASTNAME, FRSTNAME, MIDLNAME, EMPLSUFF, Supervisor_Employee_ID, USERID,   SUPERVISORCODE_I, SUPERVISOR, PHONE1, PHONE2, EMPLNAME, UNTSTOPY, PAYPEROD, InfoValue, MKTOPROC, Workflow_Status, DEPRTMNT, JOBTITLE, LOCATNID, DIVISIONCODE_I, CMMTTEXT, Workflow_Due_Date, Workflow_Due_Time, Workflow_Name, Workflow_Approver, Workflow_Originator, Workflow_Type_Name, WorkflowInstanceID, WorkflowStepInstanceID, Workflow_Step_Type)  SELECT C.EMPLOYID, C.Pay_Schedule, C.YEAR1, C.PERIODID, PERNAME, STRTDATE, ENDDATE, Group_ID, LVLLABEL, LASTNAME, FRSTNAME, MIDLNAME, EMPLSUFF, Supervisor_Employee_ID, USERID,  SUPERVISORCODE_I, SUPERVISOR, PHONE1, PHONE2, EMPLNAME, UNTSTOPY, PAYPEROD, InfoValue, MKTOPROC, C.Workflow_Status, DEPRTMNT, JOBTITLE, LOCATNID, DIVISIONCODE_I, CMMTTEXT, convert(char(10), getdate(), 111) , '''', REPLICATE(''X'', 51), REPLICATE(''X'', 238), REPLICATE(''X'', 238),'''','''','''',0  FROM MyCTE C  LEFT OUTER JOIN UPR30500 HIST ON HIST.Pay_Schedule = C.Pay_Schedule AND HIST.YEAR1 = C.YEAR1 AND HIST.PERIODID = C.PERIODID AND HIST.EMPLOYID = C.EMPLOYID  WHERE Counter <= Past_Pay_Periods AND HIST.EMPLOYID IS NULL'    exec(@SQLString)  END  END   
GO
GRANT EXECUTE ON  [dbo].[UPR_PopulateTimecardCurrentListTempForEmployee] TO [DYNGRP]
GO
