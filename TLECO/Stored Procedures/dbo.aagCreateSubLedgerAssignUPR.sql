SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROC [dbo].[aagCreateSubLedgerAssignUPR]  @SubLedgerHdrID INT, @SubLedgerDistID INT, @AuditCtrlCode VARCHAR(15), @SeqNumbr INT, @EmployeeID VARCHAR(15), @Dept VARCHAR(7),  @JobTitle VARCHAR(7), @PayRolCode VARCHAR(7), @UPRActType SMALLINT, @DrAmt NUMERIC(19,5), @CrAmt NUMERIC(19,5), @IncludeEmployee SMALLINT,  @ClassID INT, @AcctIdx INT AS   DECLARE @SubLedgerAssignID INT, @AssignID INT, @AliasID INT, @AssignPercent INT, @nAmt NUMERIC(19,5), @nRemainAmt NUMERIC(19,5), @nPercent INT,  @I_nDECPLfunCUR INT, @RecordExists TINYINT, @MatchFound SMALLINT, @RemainPercent INT, @ResultCount INT  SET @SubLedgerAssignID = 0  SET @AssignID = 0  SET @MatchFound = 0  SET @RecordExists = 0   SET @nRemainAmt = 0  SET @RemainPercent = 0  SET @ResultCount = 0   IF @ClassID = 0   BEGIN  IF @DrAmt <> 0  BEGIN  INSERT INTO AAG20002(aaSubLedgerHdrID, aaSubLedgerDistID, aaSubLedgerAssignID, DEBITAMT, CRDTAMNT, aaAssignedPercent,   aaAliasID)  VALUES(@SubLedgerHdrID, @SubLedgerDistID, 1, @DrAmt, 0, 10000, 0)  END  ELSE  BEGIN  INSERT INTO AAG20002(aaSubLedgerHdrID, aaSubLedgerDistID, aaSubLedgerAssignID, DEBITAMT, CRDTAMNT, aaAssignedPercent,   aaAliasID)  VALUES(@SubLedgerHdrID, @SubLedgerDistID, 1, 0, @CrAmt, 10000, 0)  END  END   ELSE   BEGIN  SELECT @MatchFound = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG03000   WHERE UPRACTYP = @UPRActType AND LTRIM(RTRIM(EMPLOYID)) = LTRIM(RTRIM(@EmployeeID)) AND LTRIM(RTRIM(DEPRTMNT)) = LTRIM(RTRIM(@Dept)) AND   LTRIM(RTRIM(JOBTITLE)) = LTRIM(RTRIM(@JobTitle)) AND LTRIM(RTRIM(PAYROLCD)) = LTRIM(RTRIM(@PayRolCode))   IF @MatchFound <> 1   BEGIN  SELECT @MatchFound = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG03000   WHERE UPRACTYP = @UPRActType AND LTRIM(RTRIM(EMPLOYID)) = LTRIM(RTRIM(@EmployeeID)) AND   LTRIM(RTRIM(DEPRTMNT)) = LTRIM(RTRIM(@Dept)) AND LTRIM(RTRIM(JOBTITLE)) = LTRIM(RTRIM(@JobTitle)) AND   LTRIM(RTRIM(PAYROLCD)) = 'ALL'  IF @MatchFound = 1  BEGIN  SET @PayRolCode = 'ALL'  END  END  IF @MatchFound <> 1   BEGIN   SELECT @MatchFound = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG03000   WHERE UPRACTYP = @UPRActType AND LTRIM(RTRIM(EMPLOYID)) = LTRIM(RTRIM(@EmployeeID)) AND   LTRIM(RTRIM(DEPRTMNT)) = LTRIM(RTRIM(@Dept)) AND LTRIM(RTRIM(JOBTITLE)) = 'ALL' AND   LTRIM(RTRIM(PAYROLCD)) = LTRIM(RTRIM(@PayRolCode))   IF @MatchFound = 1  BEGIN  SET @JobTitle = 'ALL'  END  END  IF @MatchFound <> 1   BEGIN  SELECT @MatchFound = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG03000   WHERE UPRACTYP = @UPRActType AND LTRIM(RTRIM(EMPLOYID)) = LTRIM(RTRIM(@EmployeeID)) AND   LTRIM(RTRIM(DEPRTMNT)) = LTRIM(RTRIM(@Dept)) AND LTRIM(RTRIM(JOBTITLE)) = 'ALL' AND LTRIM(RTRIM(PAYROLCD)) = 'ALL'   IF @MatchFound = 1  BEGIN  SET @JobTitle = 'ALL'  SET @PayRolCode = 'ALL'   END  END  IF @MatchFound <> 1   BEGIN  SELECT @MatchFound = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG03000   WHERE UPRACTYP = @UPRActType AND LTRIM(RTRIM(EMPLOYID)) = LTRIM(RTRIM(@EmployeeID)) AND LTRIM(RTRIM(DEPRTMNT)) = 'ALL' AND   LTRIM(RTRIM(JOBTITLE)) = LTRIM(RTRIM(@JobTitle)) AND LTRIM(RTRIM(PAYROLCD)) = LTRIM(RTRIM(@PayRolCode))   IF @MatchFound = 1  BEGIN  SET @Dept = 'ALL'  END  END   IF @MatchFound <> 1  BEGIN  SELECT @MatchFound = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG03000   WHERE UPRACTYP = @UPRActType AND LTRIM(RTRIM(EMPLOYID)) = LTRIM(RTRIM(@EmployeeID)) AND LTRIM(RTRIM(DEPRTMNT)) = 'ALL' AND   LTRIM(RTRIM(JOBTITLE)) = LTRIM(RTRIM(@JobTitle)) AND LTRIM(RTRIM(PAYROLCD)) = 'ALL'  IF @MatchFound = 1  BEGIN  SET @Dept = 'ALL'  SET @PayRolCode = 'ALL'  END  END  IF @MatchFound <> 1  BEGIN  SELECT @MatchFound = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG03000   WHERE UPRACTYP = @UPRActType AND LTRIM(RTRIM(EMPLOYID)) = LTRIM(RTRIM(@EmployeeID)) AND LTRIM(RTRIM(DEPRTMNT)) = 'ALL' AND   LTRIM(RTRIM(JOBTITLE)) = 'ALL' AND LTRIM(RTRIM(PAYROLCD)) = LTRIM(RTRIM(@PayRolCode))   IF @MatchFound = 1  BEGIN  SET @Dept = 'ALL'  SET @JobTitle = 'ALL'  END  END  IF @MatchFound <> 1  BEGIN  SELECT @MatchFound = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG03000   WHERE UPRACTYP = @UPRActType AND LTRIM(RTRIM(EMPLOYID)) = LTRIM(RTRIM(@EmployeeID)) AND LTRIM(RTRIM(DEPRTMNT)) = 'ALL' AND   LTRIM(RTRIM(JOBTITLE)) = 'ALL' AND LTRIM(RTRIM(PAYROLCD)) = 'ALL'   IF @MatchFound = 1  BEGIN  SET @Dept = 'ALL'   SET @JobTitle = 'ALL'  SET @PayRolCode = 'ALL'  END  END  IF @MatchFound <> 1  BEGIN  SELECT @MatchFound = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG03000   WHERE UPRACTYP = @UPRActType AND LTRIM(RTRIM(EMPLOYID)) = 'ALL' AND LTRIM(RTRIM(DEPRTMNT)) = LTRIM(RTRIM(@Dept)) AND   LTRIM(RTRIM(JOBTITLE)) = LTRIM(RTRIM(@JobTitle)) AND LTRIM(RTRIM(PAYROLCD)) = LTRIM(RTRIM(@PayRolCode))   IF @MatchFound = 1  BEGIN  SET @EmployeeID = 'ALL'  END  END  IF @MatchFound <> 1  BEGIN  SELECT @MatchFound = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG03000   WHERE UPRACTYP = @UPRActType AND LTRIM(RTRIM(EMPLOYID)) = 'ALL' AND LTRIM(RTRIM(DEPRTMNT)) = LTRIM(RTRIM(@Dept)) AND   LTRIM(RTRIM(JOBTITLE)) = LTRIM(RTRIM(@JobTitle)) AND LTRIM(RTRIM(PAYROLCD)) = 'ALL'  IF @MatchFound = 1  BEGIN   SET @EmployeeID = 'ALL'  SET @PayRolCode = 'ALL'  END  END  IF @MatchFound <> 1  BEGIN  SELECT @MatchFound = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG03000   WHERE UPRACTYP = @UPRActType AND LTRIM(RTRIM(EMPLOYID)) = 'ALL' AND LTRIM(RTRIM(DEPRTMNT)) = LTRIM(RTRIM(@Dept)) AND   LTRIM(RTRIM(JOBTITLE)) = 'ALL' AND LTRIM(RTRIM(PAYROLCD)) = LTRIM(RTRIM(@PayRolCode))   IF @MatchFound = 1   BEGIN  SET @EmployeeID = 'ALL'  SET @JobTitle = 'ALL'  END  END  IF @MatchFound <> 1   BEGIN  SELECT @MatchFound = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG03000   WHERE UPRACTYP = @UPRActType AND LTRIM(RTRIM(EMPLOYID)) = 'ALL' AND LTRIM(RTRIM(DEPRTMNT)) = LTRIM(RTRIM(@Dept)) AND   LTRIM(RTRIM(JOBTITLE)) = 'ALL' AND LTRIM(RTRIM(PAYROLCD)) = 'ALL'  IF @MatchFound = 1   BEGIN  SET @EmployeeID = 'ALL'  SET @JobTitle = 'ALL'  SET @PayRolCode = 'ALL'  END  END  IF @MatchFound <> 1  BEGIN  SELECT @MatchFound = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG03000   WHERE UPRACTYP = @UPRActType AND LTRIM(RTRIM(EMPLOYID)) = 'ALL' AND LTRIM(RTRIM(DEPRTMNT)) = 'ALL' AND   LTRIM(RTRIM(JOBTITLE)) = LTRIM(RTRIM(@JobTitle)) AND LTRIM(RTRIM(PAYROLCD)) = LTRIM(RTRIM(@PayRolCode))   IF @MatchFound = 1  BEGIN  SET @EmployeeID = 'ALL'  SET @Dept = 'ALL'  END  END  IF @MatchFound <> 1  BEGIN  SELECT @MatchFound = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG03000   WHERE UPRACTYP = @UPRActType AND LTRIM(RTRIM(EMPLOYID)) = 'ALL' AND LTRIM(RTRIM(DEPRTMNT)) = 'ALL' AND   LTRIM(RTRIM(JOBTITLE)) = LTRIM(RTRIM(@JobTitle)) AND LTRIM(RTRIM(PAYROLCD)) = 'ALL'  IF @MatchFound = 1  BEGIN  SET @EmployeeID = 'ALL'  SET @Dept = 'ALL'  SET @PayRolCode = 'ALL'  END  END  IF @MatchFound <> 1  BEGIN  SELECT @MatchFound = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG03000   WHERE UPRACTYP = @UPRActType AND LTRIM(RTRIM(EMPLOYID)) = 'ALL' AND LTRIM(RTRIM(DEPRTMNT)) = 'ALL' AND   LTRIM(RTRIM(JOBTITLE)) = 'ALL' AND LTRIM(RTRIM(PAYROLCD)) = LTRIM(RTRIM(@PayRolCode))   IF @MatchFound = 1   BEGIN  SET @EmployeeID = 'ALL'  SET @Dept = 'ALL'  SET @JobTitle = 'ALL'  END  END  IF @MatchFound <> 1  BEGIN  SELECT @MatchFound = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG03000   WHERE UPRACTYP = @UPRActType AND LTRIM(RTRIM(EMPLOYID)) = 'ALL' AND LTRIM(RTRIM(DEPRTMNT)) = 'ALL' AND   LTRIM(RTRIM(JOBTITLE)) = 'ALL' AND LTRIM(RTRIM(PAYROLCD)) = LTRIM(RTRIM('ALL'))   IF @MatchFound = 1   BEGIN  SET @EmployeeID = 'ALL'  SET @Dept = 'ALL'   SET @JobTitle = 'ALL'   SET @PayRolCode = 'ALL'  END  END  SELECT @I_nDECPLfunCUR = DECPLCUR - 1 FROM DYNAMICS..MC40200 WHERE CURNCYID = (SELECT FUNLCURR FROM MC40000)  SELECT @ResultCount = COUNT(*) FROM AAG03000   WHERE LTRIM(RTRIM(EMPLOYID)) = LTRIM(RTRIM(@EmployeeID)) AND LTRIM(RTRIM(DEPRTMNT)) = LTRIM(RTRIM(@Dept)) AND  LTRIM(RTRIM(JOBTITLE)) = LTRIM(RTRIM(@JobTitle)) AND LTRIM(RTRIM(PAYROLCD)) = LTRIM(RTRIM(@PayRolCode)) AND   UPRACTYP = @UPRActType AND aaAssignedPercent > 0  IF @ResultCount = 0   BEGIN  IF @DrAmt <> 0  BEGIN  INSERT INTO AAG20002(aaSubLedgerHdrID, aaSubLedgerDistID, aaSubLedgerAssignID, DEBITAMT, CRDTAMNT, aaAssignedPercent,   aaAliasID)  VALUES(@SubLedgerHdrID, @SubLedgerDistID, 1, @DrAmt, 0, 10000, 0)  END  ELSE  BEGIN  INSERT INTO AAG20002(aaSubLedgerHdrID, aaSubLedgerDistID, aaSubLedgerAssignID, DEBITAMT, CRDTAMNT, aaAssignedPercent,   aaAliasID)  VALUES(@SubLedgerHdrID, @SubLedgerDistID, 1, 0, @CrAmt, 10000, 0)  END  EXEC aagCreateSubLedgerCodes @SubLedgerHdrID, @SubLedgerDistID, 1, @AuditCtrlCode, @SeqNumbr, 0, @AcctIdx  END   DECLARE CreateAssignRecords CURSOR FAST_FORWARD  FOR  SELECT aaAliasID, aaAssignedPercent FROM AAG03000   WHERE LTRIM(RTRIM(EMPLOYID)) = LTRIM(RTRIM(@EmployeeID)) AND LTRIM(RTRIM(DEPRTMNT)) = LTRIM(RTRIM(@Dept)) AND  LTRIM(RTRIM(JOBTITLE)) = LTRIM(RTRIM(@JobTitle)) AND LTRIM(RTRIM(PAYROLCD)) = LTRIM(RTRIM(@PayRolCode)) AND   UPRACTYP = @UPRActType AND aaAssignedPercent > 0  OPEN CreateAssignRecords   FETCH NEXT FROM CreateAssignRecords INTO @AliasID, @AssignPercent  WHILE @@FETCH_STATUS = 0  BEGIN  IF @DrAmt <> 0   BEGIN SET @nAmt = @DrAmt END  ELSE   BEGIN SET @nAmt = @CrAmt END  SET @nAmt = round(@nAmt * (@AssignPercent/10000.00),2)  SET @nRemainAmt = @nRemainAmt + @nAmt  SET @RemainPercent = @RemainPercent + @AssignPercent  SET @SubLedgerAssignID = @SubLedgerAssignID + 1  IF @DrAmt <> 0  BEGIN  INSERT INTO AAG20002(aaSubLedgerHdrID, aaSubLedgerDistID, aaSubLedgerAssignID, DEBITAMT, CRDTAMNT, aaAssignedPercent,   aaAliasID)  VALUES(@SubLedgerHdrID, @SubLedgerDistID, @SubLedgerAssignID, @nAmt, 0, @AssignPercent, @AliasID)  END  ELSE  BEGIN  INSERT INTO AAG20002(aaSubLedgerHdrID, aaSubLedgerDistID, aaSubLedgerAssignID, DEBITAMT, CRDTAMNT, aaAssignedPercent,   aaAliasID)  VALUES(@SubLedgerHdrID, @SubLedgerDistID, @SubLedgerAssignID, 0, @nAmt, @AssignPercent, @AliasID)  END  EXEC aagCreateSubLedgerCodes @SubLedgerHdrID, @SubLedgerDistID, @SubLedgerAssignID, @AuditCtrlCode, @SeqNumbr, @AliasID,   @AcctIdx  FETCH NEXT FROM CreateAssignRecords INTO @AliasID, @AssignPercent  END   CLOSE CreateAssignRecords  DEALLOCATE CreateAssignRecords  IF @ResultCount <> 0   BEGIN  IF @DrAmt <> 0   BEGIN  IF @DrAmt - @nRemainAmt <> 0 AND @RemainPercent = 10000  BEGIN  UPDATE AAG20002 SET DEBITAMT = (DEBITAMT + (@DrAmt - @nRemainAmt)) WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND   aaSubLedgerDistID = @SubLedgerDistID AND aaSubLedgerAssignID = @SubLedgerAssignID  END  END  ELSE   BEGIN  IF @CrAmt - @nRemainAmt <> 0 AND @RemainPercent = 10000  BEGIN  UPDATE AAG20002 SET CRDTAMNT = (CRDTAMNT + (@CrAmt - @nRemainAmt)) WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND   aaSubLedgerDistID = @SubLedgerDistID AND aaSubLedgerAssignID = @SubLedgerAssignID   END  END  END  END    
GO
GRANT EXECUTE ON  [dbo].[aagCreateSubLedgerAssignUPR] TO [DYNGRP]
GO
