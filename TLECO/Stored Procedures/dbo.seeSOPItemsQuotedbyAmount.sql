SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[seeSOPItemsQuotedbyAmount]  @UserDate datetime = NULL,  @NumDays int   = NULL,  @NumItems int   = NULL,  @Prospects varchar(max)   as set nocount ON  declare @dtStart datetime,   @dtEnd  datetime,  @Stmt  varchar(3000)  declare @ProspectsTemp table (CUSTNMBR nvarchar(500)) insert into @ProspectsTemp select * from dbo.seeSplitString(@Prospects, ',')   set dateformat ymd  select @UserDate = dbo.GetDateStripTime(@UserDate)   select  @dtEnd = @UserDate  select  @dtStart = @dtEnd - @NumDays  create table #TopProspectSalesItemsTemp (RemPrice numeric(19,5) not null,  ItemNumber char(31) not null,  Filter char(15)) create table #TopProspectSalesItems (RemPrice numeric(19,5) not null,  ItemNumber char(31) not null,  Filter char(15))  if (@Prospects = '') begin  insert into #TopProspectSalesItemsTemp (RemPrice,  ItemNumber,  Filter )  select TOP (select @NumItems) sum(Line.REMPRICE) as RemPrice, Line.ITEMNMBR as ItemNumber, '' as Filler  from SOP30200 as Header, SOP30300 as Line with (NOLOCK)   where ( Header.DOCDATE >= dbo.GetDateStripTime(@dtStart)  and   Header.DOCDATE <= dbo.GetDateStripTime(@dtEnd)) and   Header.SOPTYPE = 1 and Header.VOIDSTTS = 0 and Header.PROSPECT = 1 and  ( Header.SOPTYPE = Line.SOPTYPE and Header.SOPNUMBE = Line.SOPNUMBE) and   Line.REMPRICE > 0   group by Line.ITEMNMBR  order by RemPrice DESC end  if (@Prospects <> '') begin  insert into #TopProspectSalesItems (RemPrice,  ItemNumber,  Filter )  select TOP (select @NumItems) sum(Line.REMPRICE) as RemPrice, Line.ITEMNMBR as ItemNumber, '' as Filler  from SOP30200 as Header, SOP30300 as Line with (NOLOCK)   where ( Header.DOCDATE >= dbo.GetDateStripTime(@dtStart) and   Header.DOCDATE <= dbo.GetDateStripTime(@dtEnd)) and   Header.SOPTYPE = 1 and Header.VOIDSTTS = 0 and Header.PROSPECT = 1 and  ( Header.SOPTYPE = Line.SOPTYPE and Header.SOPNUMBE = Line.SOPNUMBE) and   Line.REMPRICE > 0   group by Line.ITEMNMBR   order by RemPrice DESC   insert into #TopProspectSalesItemsTemp (RemPrice,  ItemNumber,  Filter)   select sum(Line.REMPRICE) as RemPrice, Line.ITEMNMBR as ItemNumber, Header.CUSTNMBR as Filler  from SOP30200 as Header with (NOLOCK)  inner join SOP30300 as Line with (NOLOCK) on (Header.DOCDATE >= dbo.GetDateStripTime(@dtStart) and   Header.DOCDATE <= dbo.GetDateStripTime(@dtEnd)) and   Header.SOPTYPE = 1 and Header.VOIDSTTS = 0 and Header.PROSPECT = 1 and  ( Header.SOPTYPE = Line.SOPTYPE and Header.SOPNUMBE = Line.SOPNUMBE) and   Line.REMPRICE > 0  inner join @ProspectsTemp as ProspectList on ProspectList.CUSTNMBR = Header.CUSTNMBR  inner join #TopProspectSalesItems on #TopProspectSalesItems.ItemNumber = ItemNumber  group by Line.ITEMNMBR, Header.CUSTNMBR  order by RemPrice DESC end  select * from #TopProspectSalesItemsTemp with (nolock) drop table #TopProspectSalesItemsTemp drop table #TopProspectSalesItems    
GO
GRANT EXECUTE ON  [dbo].[seeSOPItemsQuotedbyAmount] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[seeSOPItemsQuotedbyAmount] TO [rpt_executive]
GO
GRANT EXECUTE ON  [dbo].[seeSOPItemsQuotedbyAmount] TO [rpt_materials manager]
GO
GRANT EXECUTE ON  [dbo].[seeSOPItemsQuotedbyAmount] TO [rpt_operations manager]
GO
