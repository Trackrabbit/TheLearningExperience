SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE procedure [dbo].[seeGLGrossProfitYTDMetricMultiCO] @UserDate datetime =  NULL  as   declare @iterator        int,   @startDate       datetime,   @endDate         datetime,   @I_iPeriodMonths int    select @UserDate = DATEADD(HOUR, -DATEPART(HOUR, @UserDate), @UserDate)    select @UserDate = DATEADD(MINUTE, -DATEPART(MINUTE, @UserDate), @UserDate)    select @UserDate = DATEADD(SECOND, -DATEPART(SECOND, @UserDate), @UserDate)    select @UserDate = DATEADD(MILLISECOND, -DATEPART(MILLISECOND, @UserDate),   @UserDate)    select @endDate = @UserDate    select @startDate = FSTFSCDY   from   SY40101   where  @UserDate between FSTFSCDY and LSTFSCDY    select @startDate = DATEADD(HOUR, -DATEPART(HOUR, @startDate), @startDate)    select @startDate = DATEADD(MINUTE, -DATEPART(MINUTE, @startDate), @startDate)    select @startDate = DATEADD(SECOND, -DATEPART(SECOND, @startDate), @startDate)    select @startDate = DATEADD(MILLISECOND, -DATEPART(MILLISECOND, @startDate),   @startDate   )    select @I_iPeriodMonths = isnull((select top 1 PERIODID   from   SY40100   where  PERIODDT between (select FSTFSCDY   from   SY40101   where   @UserDate between   FSTFSCDY and LSTFSCDY   )   and   @UserDate   group  by PERIODID   order  by PERIODID desc), 0)    create table #ProfitCounts   (   CoName       varchar(30) not null,   GrossProfit  numeric(19, 5) not null,   MonthDate    datetime not null,   PeriodMonths int not null   )    select @iterator = @I_iPeriodMonths - 1    insert #ProfitCounts   values(db_name(),  0,   DATEADD(day, -day(@UserDate) + 1, @UserDate),   @I_iPeriodMonths)    while ( @iterator >= 0 )   begin   insert #ProfitCounts   values(db_name(),  0,   DATEADD(month, -@iterator, DATEADD(day, -day(@UserDate) + 1,   @UserDate)),   @I_iPeriodMonths)    select @iterator = @iterator - 1   end    insert #ProfitCounts   (CoName,   GrossProfit,   MonthDate,   PeriodMonths)   select db_name()                                    as [CoName],   sum (t.CRDTAMNT - t.DEBITAMT)                as GrossProfit,   DATEADD(day, -DAY(t.TRXDATE) + 1, t.TRXDATE) as MonthDate,   @I_iPeriodMonths   from   GL20000 as t with (NOLOCK)   join GL00100 as m with (NOLOCK)   on t.ACTINDX = m.ACTINDX   where  ( m.ACCATNUM = 31   or m.ACCATNUM = 32   or m.ACCATNUM = 33 )   and ( t.TRXDATE >= @startDate   and t.TRXDATE <= @endDate )   group  by t.TRXDATE  select CoName, SUM(GrossProfit) as CurrentBalance from #ProfitCounts group by CoName    
GO
GRANT EXECUTE ON  [dbo].[seeGLGrossProfitYTDMetricMultiCO] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[seeGLGrossProfitYTDMetricMultiCO] TO [rpt_executive]
GO
