SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_Create_Tech_Queue_View] (@TableName char(40),  @SRVRECTYPE smallint,  @FromTech char(11),  @ToTech char(11),  @Office char(11),  @Type integer) AS  declare @ExecString varchar(255) declare @Quote char(1),@CALLTYPE char(1) select @Quote = CHAR(39),@CALLTYPE = CONVERT(varchar(1),@SRVRECTYPE) if @Type = 0   exec ('declare @b char(1) set @b = char(32) declare @CALLTYPE int set @CALLTYPE = '+@SRVRECTYPE+''+  'insert into ' + @TableName + '(SRVRECTYPE,CALLNBR,SRVSTAT,STSDESCR,TECHID,NAME,OFFID,OFFNAME,ETADTE,ETATME,COMPDTE,COMPTME,CUSTNMBR,CUSTNAME) select a.SRVRECTYPE, a.CALLNBR, a.SRVSTAT, IsNull(b.STSDESCR, ' + @Quote + @Quote + '), ' +   ' isnull(MultTech.TECHID,@b) TECHID, IsNull(c.NAME,' + @Quote + @Quote + ' ) ' + @Quote + 'NAME' + @Quote + ' ,a.OFFID,IsNull(d.OFFNAME,' + @Quote +  @Quote + ' ) ' + @Quote + 'OFFNAME' + @Quote + '  ,a.ETADTE, a.ETATME,a.COMPDTE, a.COMPTME,a.CUSTNMBR,IsNull(e.CUSTNAME,' + @Quote + @Quote + ')  from SVC00200 a ' +   ' left outer join SVC00913 b on ( a.SRVSTAT = b.SRVSTAT) ' +   ' left outer join SVC00902 d on (a.OFFID = d.OFFID) ' +   ' left outer join RM00101 e on (a.CUSTNMBR = e.CUSTNMBR) ' +   'left outer join ( select SRVRECTYPE, CALLNBR, TECHID from SVC00200 where SRVRECTYPE = @CALLTYPE and TECHID <> @b' +   '     union select distinct SRVRECTYPE, CALLNBR, TECHID from SVC00207 where SRVRECTYPE = @CALLTYPE' +   ' ) as MultTech on a.SRVRECTYPE = MultTech.SRVRECTYPE and a.CALLNBR = MultTech.CALLNBR' +   ' left outer join SVC00100 c on (MultTech.TECHID = c.TECHID) ' +  ' where a.SRVRECTYPE = ' + @CALLTYPE + ' order by a.TECHID, a.ETADTE ') else if @Type = 1   exec ('declare @b char(1) set @b = char(32) declare @CALLTYPE int set @CALLTYPE = '+@SRVRECTYPE+''+  'insert into ' + @TableName + '(SRVRECTYPE,CALLNBR,SRVSTAT,STSDESCR,TECHID,NAME,OFFID,OFFNAME,ETADTE,ETATME,COMPDTE,COMPTME,CUSTNMBR,CUSTNAME) select a.SRVRECTYPE, a.CALLNBR, a.SRVSTAT, IsNull(b.STSDESCR, ' + @Quote + @Quote + '), ' +   ' isnull(MultTech.TECHID,@b) TECHID, IsNull(c.NAME,' + @Quote + @Quote + ' ) ' + @Quote + 'NAME' + @Quote + ' ,a.OFFID,IsNull(d.OFFNAME,' + @Quote +  @Quote + ' ) ' + @Quote + 'OFFNAME' + @Quote + '  ,a.ETADTE, a.ETATME,a.COMPDTE, a.COMPTME,a.CUSTNMBR,IsNull(e.CUSTNAME,' + @Quote + @Quote + ')  from SVC00200 a ' +   ' left outer join SVC00913 b on ( a.SRVSTAT = b.SRVSTAT) ' +   ' left outer join SVC00902 d on (a.OFFID = d.OFFID) ' +   ' left outer join RM00101 e on (a.CUSTNMBR = e.CUSTNMBR) ' +   'left outer join ( select SRVRECTYPE, CALLNBR, TECHID from SVC00200 where SRVRECTYPE = @CALLTYPE and TECHID <> @b' +   '     union select distinct SRVRECTYPE, CALLNBR, TECHID from SVC00207 where SRVRECTYPE = @CALLTYPE' +   ' ) as MultTech on a.SRVRECTYPE = MultTech.SRVRECTYPE and a.CALLNBR = MultTech.CALLNBR' +   ' left outer join SVC00100 c on (MultTech.TECHID = c.TECHID) ' +  ' where a.SRVRECTYPE = ' + @CALLTYPE + ' and a.OFFID = ' + @Quote + @Office + @Quote + ' order by a.TECHID, a.ETADTE  ') else if @Type = 2  exec ('declare @b char(1) set @b = char(32) declare @CALLTYPE int set @CALLTYPE = '+@SRVRECTYPE+''+  'insert into ' + @TableName + '(SRVRECTYPE,CALLNBR,SRVSTAT,STSDESCR,TECHID,NAME,OFFID,OFFNAME,ETADTE,ETATME,COMPDTE,COMPTME,CUSTNMBR,CUSTNAME) select a.SRVRECTYPE, a.CALLNBR, a.SRVSTAT, IsNull(b.STSDESCR, ' + @Quote + @Quote + '), ' +   ' isnull(MultTech.TECHID,@b) TECHID, IsNull(c.NAME,' + @Quote + @Quote + ' ) ' + @Quote + 'NAME' + @Quote + ' ,a.OFFID,IsNull(d.OFFNAME,' + @Quote +  @Quote + ' ) ' + @Quote + 'OFFNAME' + @Quote + '  ,a.ETADTE, a.ETATME,a.COMPDTE, a.COMPTME,a.CUSTNMBR,IsNull(e.CUSTNAME,' + @Quote + @Quote + ')  from SVC00200 a ' +   ' left outer join SVC00913 b on ( a.SRVSTAT = b.SRVSTAT) ' +   ' left outer join SVC00902 d on (a.OFFID = d.OFFID) ' +   ' left outer join RM00101 e on (a.CUSTNMBR = e.CUSTNMBR) ' +   'left outer join ( select SRVRECTYPE, CALLNBR, TECHID from SVC00200 where SRVRECTYPE = @CALLTYPE and TECHID <> @b' +   '     union select distinct SRVRECTYPE, CALLNBR, TECHID from SVC00207 where SRVRECTYPE = @CALLTYPE' +   ' ) as MultTech on a.SRVRECTYPE = MultTech.SRVRECTYPE and a.CALLNBR = MultTech.CALLNBR' +   ' left outer join SVC00100 c on (MultTech.TECHID = c.TECHID) ' +  ' where a.SRVRECTYPE = ' + @CALLTYPE + ' and MultTech.TECHID >= ' + @Quote + @FromTech + @Quote + ' and MultTech.TECHID <= ' + @Quote + @ToTech + @Quote + ' order by a.TECHID, a.ETADTE ')   
GO
GRANT EXECUTE ON  [dbo].[SVC_Create_Tech_Queue_View] TO [DYNGRP]
GO
