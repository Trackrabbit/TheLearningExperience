SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_Set_Service_Line_Dist] @srvrectype int ,  @callnbr varchar(11) ,  @EquipLine integer,  @Line integer,  @LineType char(3),  @Amount numeric (19,2),  @OrigAmount numeric (19,2),  @iType smallint ,  @CMPNTSEQ int = 0    AS declare @SEQNUMBR integer declare @AccountIndex integer declare @oldAccountIndex1 integer declare @oldAccountIndex2 integer declare @oldAccountIndex4 integer declare @oldAccountIndex5 integer declare @SalesIndex integer declare @ReturnSalesIndex integer declare @COGSIndex integer declare @COGSDropShipIndex integer declare @CurrencyIndex smallint declare @DistType smallint declare @ServiceType char(11) declare @Customer char(15) declare @UseAccountFrom smallint declare @Item char(31), @LineItem char(31) declare  @CAmount numeric(19,2) declare  @OrigCAmount numeric (19,2) declare  @DAmount numeric(19,2) declare  @OrigDAmount numeric (19,2) declare @QtySold numeric(19,5) declare @ItemUseType char(3) declare @DropShipIndex integer declare @Cost numeric(19,2) declare @OrigCost numeric(19,2) declare @KTACCTSR smallint declare @MinDate datetime  exec smGetMinDate @MinDate output select @KTACCTSR = 0, @UseAccountFrom = USEACFRM from SOP40100  select @oldAccountIndex1 = ACTINDX from SVC00231 where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  and EQPLINE=@EquipLine and LNITMSEQ = @Line and LINITMTYP=@LineType and CMPNTSEQ = @CMPNTSEQ  and SVC_Distribution_Type=1 and POSTED = 0 select @oldAccountIndex2 = ACTINDX from SVC00231 where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  and EQPLINE=@EquipLine and LNITMSEQ = @Line and LINITMTYP=@LineType and CMPNTSEQ = @CMPNTSEQ  and SVC_Distribution_Type=2 and POSTED = 0 select @oldAccountIndex4 = ACTINDX from SVC00231 where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  and EQPLINE=@EquipLine and LNITMSEQ = @Line and LINITMTYP=@LineType and CMPNTSEQ = @CMPNTSEQ  and SVC_Distribution_Type=4 and POSTED = 0 select @oldAccountIndex5 = ACTINDX from SVC00231 where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  and EQPLINE=@EquipLine and LNITMSEQ = @Line and LINITMTYP=@LineType and CMPNTSEQ = @CMPNTSEQ  and SVC_Distribution_Type=5 and POSTED = 0  delete from SVC00231 where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  and EQPLINE=@EquipLine and LNITMSEQ = @Line and LINITMTYP=@LineType and CMPNTSEQ = @CMPNTSEQ  and SVC_Distribution_Type < 6 and POSTED = 0  if exists (select * from SVC00203 where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  and EQPLINE=@EquipLine and LNITMSEQ = @Line and LINITMTYP=@LineType and CMPNTSEQ = @CMPNTSEQ) BEGIN  select @Item = ITEMNMBR, @LineItem = ITEMNMBR, @Amount = XTNDPRCE,@OrigAmount=OXTNDPRC, @QtySold = QTYSOLD,  @ItemUseType = ITEMUSETYPE,@Cost = EXTDCOST, @OrigCost = OREXTCST  from SVC00203 where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  and EQPLINE=@EquipLine and LNITMSEQ = @Line and LINITMTYP=@LineType and CMPNTSEQ = @CMPNTSEQ select @Amount = XTNDPRCE,@OrigAmount=OXTNDPRC from SVC00203 where  SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  and EQPLINE=@EquipLine and LNITMSEQ = @Line and LINITMTYP=@LineType and CMPNTSEQ =0 select @CurrencyIndex = CURRNIDX from DYNAMICS..MC40200 where CURNCYID in   (select CURNCYID from SVC00200 where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr) select @ServiceType = SRVTYPE, @Customer = CUSTNMBR  from SVC00200 where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr if @CMPNTSEQ > 0   begin  select @LineItem = ITEMNMBR from SVC00203 where  SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  and EQPLINE=@EquipLine and LNITMSEQ = @Line and LINITMTYP=@LineType and CMPNTSEQ =0   select @KTACCTSR = KTACCTSR from IV00101 where ITEMNMBR = @LineItem  end  select  @SalesIndex =   case  when @LineType = 'L' then SVC_Sales_Index_Labor  when @LineType = 'P' and @ItemUseType <> 'R' and  @ItemUseType <> 'M' then SVC_Sales_Index_Part  when @LineType = 'P' and @ItemUseType = 'R' then SVC_Sales_Return_Index   when @LineType = 'P' and @ItemUseType = 'M' then SVC_Sales_Index_Misc  when @LineType = 'A' then SVC_Sales_Index_Misc  when @LineType = 'E' then SVC_Sales_Index_Expense  end,  @COGSDropShipIndex =   case  when @LineType = 'L' then SVC_COGS_Index_Labor  when @LineType = 'P' then SVC_COGS_Index_Part  when @LineType = 'A' then SVC_COGS_Index_Misc  when @LineType = 'E' then SVC_COGS_Index_Expense  end  from SVC00920 where SRVTYPE = @ServiceType  if @SalesIndex = 0 or @SalesIndex is null  begin  if @UseAccountFrom = 1  begin  if @LineType = 'P' and @ItemUseType = 'R'  select @SalesIndex = RMSORACC from RM00101 where CUSTNMBR = @Customer  else  select @SalesIndex = RMSLSACC from RM00101 where CUSTNMBR = @Customer  end  else  begin  if @LineType = 'P' and @ItemUseType = 'R'  select @SalesIndex = IVSLRNIX from IV00101 where ITEMNMBR = @Item  else  select @SalesIndex = IVSLSIDX from IV00101 where ITEMNMBR = @Item  end  end  if @COGSDropShipIndex = 0 or @COGSDropShipIndex is null  begin  if @UseAccountFrom = 1  select @COGSDropShipIndex = RMCOSACC from RM00101 where CUSTNMBR = @Customer  else  begin  if @KTACCTSR = 1    select @COGSDropShipIndex = IVCOGSIX from IV00101 where ITEMNMBR = @LineItem  else  select @COGSDropShipIndex = IVCOGSIX from IV00101 where ITEMNMBR = @Item  end  end if @COGSDropShipIndex = 0 or @COGSDropShipIndex is null  select @COGSDropShipIndex = ACTINDX from SY01100 where SERIES=5 and SEQNUMBR = 300  if @SalesIndex = 0 or @SalesIndex is null  begin  if @LineType = 'P' and @ItemUseType = 'R'  select @SalesIndex = ACTINDX from SY01100 where SERIES=3 and SEQNUMBR = 1200   else  select @SalesIndex = ACTINDX from SY01100 where SERIES=3 and SEQNUMBR = 1100  end  select @COGSIndex = RMARACC from RM00101 where CUSTNMBR = @Customer if @COGSIndex = 0 or @COGSIndex is null  select @COGSIndex = ACTINDX from SY01100 where SERIES=3 and SEQNUMBR = 100  if @iType = 1  begin  select @CAmount = @Amount, @OrigCAmount = @OrigAmount  select @DAmount = 0, @OrigDAmount = 0  end else  begin  select @CAmount = 0, @OrigCAmount = 0  select @DAmount = (-1) * @Amount, @OrigDAmount = (-1) * @OrigAmount  end if @oldAccountIndex1 > 0   select @SalesIndex = @oldAccountIndex1  if @srvrectype = 3  exec SVC_Set_Service_Reverse_Dist @srvrectype, @callnbr, @EquipLine, @Line,  @LineType, @Amount, @OrigAmount, @iType  if exists (select * from SVC00231 where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  and EQPLINE=@EquipLine and LNITMSEQ = @Line and LINITMTYP=@LineType and CMPNTSEQ = @CMPNTSEQ)  exec SVC_Dist_Get_SEQ_Service @callnbr,@srvrectype,@EquipLine,@Line,@LineType,1,@SEQNUMBR output else  select @SEQNUMBR = 16384  if @CMPNTSEQ = 0  Begin  if @QtySold <= 0 and @LineType = 'P'  exec SVC_Set_Service_HDR_Dist @callnbr,@srvrectype,1,@oldAccountIndex1,@SalesIndex,@CurrencyIndex  else  begin  insert SVC00231  select   @srvrectype,  @callnbr,  @EquipLine,  @Line,  @LineType,  @SEQNUMBR,  1,   '',  @SalesIndex,  @DAmount,@OrigDAmount,   @CAmount,   @OrigCAmount,  isnull(@CurrencyIndex,0),  '',  0,  @MinDate,  @CMPNTSEQ  exec SVC_Set_Service_HDR_Dist @callnbr,@srvrectype,1,@oldAccountIndex1,@SalesIndex,@CurrencyIndex  end   if @iType = 1  begin  select @DAmount = @Amount, @OrigDAmount = @OrigAmount  select @CAmount = 0, @OrigCAmount = 0  end  else  begin  select @DAmount = 0, @OrigDAmount = 0  select @CAmount = (-1) * @Amount, @OrigCAmount = (-1) * @OrigAmount  end  if @oldAccountIndex2 > 0   select @COGSIndex = @oldAccountIndex2   if @QtySold <= 0 and @LineType = 'P'  exec SVC_Set_Service_HDR_Dist @callnbr,@srvrectype,2,@oldAccountIndex2,@COGSIndex,@CurrencyIndex  else  begin  insert SVC00231  select   @srvrectype,  @callnbr,  @EquipLine,  @Line,  @LineType,  @SEQNUMBR,  2,   '',  @COGSIndex,  @DAmount,@OrigDAmount,   @CAmount,   @OrigCAmount,  isnull(@CurrencyIndex,0),  '',  0,  @MinDate,  @CMPNTSEQ  exec SVC_Set_Service_HDR_Dist @callnbr,@srvrectype,2,@oldAccountIndex2,@COGSIndex,@CurrencyIndex  end End    if (@LineType = 'P' and (@ItemUseType ='I' or @ItemUseType ='C' or @ItemUseType = 'N')) and @Cost > 0  begin  exec SVC_Get_ItemDropShipAccount @Item, @DropShipIndex OUTPUT  if @ItemUseType = 'N'  begin  select @DropShipIndex = ACTINDX from SY01100 where SERIES=3 and SEQNUMBR = 2400   select @COGSDropShipIndex = ACTINDX from SY01100 where SERIES=3 and SEQNUMBR = 200   end   exec SVC_Dist_Get_SEQ_Service @callnbr,@srvrectype,@EquipLine,@Line,@LineType,4,@SEQNUMBR output  insert SVC00231  select   @srvrectype,  @callnbr,  @EquipLine,  @Line,  @LineType,  @SEQNUMBR,  4,   '',  @DropShipIndex,  0,0,   @Cost,   @OrigCost,  isnull(@CurrencyIndex,0),  '',  0,  @MinDate,  @CMPNTSEQ  exec SVC_Set_Service_HDR_Dist @callnbr,@srvrectype,4,@oldAccountIndex4,@DropShipIndex,@CurrencyIndex  exec SVC_Dist_Get_SEQ_Service @callnbr,@srvrectype,@EquipLine,@Line,@LineType,5,@SEQNUMBR output  insert SVC00231  select   @srvrectype,  @callnbr,  @EquipLine,  @Line,  @LineType,  @SEQNUMBR,  5,   '',  @COGSDropShipIndex,  @Cost,   @OrigCost,  0,0,   isnull(@CurrencyIndex,0),  '',  0,  @MinDate,  @CMPNTSEQ  exec SVC_Set_Service_HDR_Dist @callnbr,@srvrectype,5,@oldAccountIndex5,@COGSDropShipIndex,@CurrencyIndex  end END  return    
GO
GRANT EXECUTE ON  [dbo].[SVC_Set_Service_Line_Dist] TO [DYNGRP]
GO
