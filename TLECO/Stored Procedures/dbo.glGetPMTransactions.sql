SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[glGetPMTransactions]  @iStartDate datetime,  @iEndDate datetime,  @iPMTempTable varchar(50)  AS  DECLARE  @lSQLError int,  @l_cINTERID char(5),  @l_nStatus int,  @l_nError int,  @O_nSQL_Error_State int,  @l_cPMTRX VARCHAR(15),  @l_cPMAPY VARCHAR(15),  @l_cPMVVR VARCHAR(15),  @l_cPMVPY VARCHAR(15),  @l_cPMRVL VARCHAR(15)   SELECT @l_cINTERID = db_name()   exec @l_nStatus = DYNAMICS.dbo.smGetMsgString 554, @l_cINTERID, @l_cPMTRX output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)  exec @l_nStatus = DYNAMICS.dbo.smGetMsgString 287, @l_cINTERID, @l_cPMAPY output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)  exec @l_nStatus = DYNAMICS.dbo.smGetMsgString 280, @l_cINTERID, @l_cPMVVR output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)   exec @l_nStatus = DYNAMICS.dbo.smGetMsgString 281, @l_cINTERID, @l_cPMVPY output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)   exec @l_nStatus = DYNAMICS.dbo.smGetMsgString 6544, @l_cINTERID, @l_cPMRVL output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)  SELECT @l_cPMTRX = RTRIM(@l_cPMTRX),  @l_cPMAPY = RTRIM(@l_cPMAPY),  @l_cPMVVR = RTRIM(@l_cPMVVR),  @l_cPMVPY = RTRIM(@l_cPMVPY),  @l_cPMRVL = RTRIM(@l_cPMRVL)  EXEC(  'INSERT INTO ' +  @iPMTempTable +  ' (PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  DOCNUMBR,  DOCTYPE,  STRVAL,  ACCTAMNT,  TRX_ID,  CNTRLTYP,  HISTRX,  VOIDED)  SELECT  PM10100.PSTGDATE,  PM10100.VENDORID,  PM10100.TRXSORCE,  PM10100.VCHRNMBR,  PM20000.DOCNUMBR,  PM20000.DOCTYPE,  '''',  (SUM(PM10100.CRDTAMNT) - SUM(PM10100.DEBITAMT)),  SUBSTRING(PM10100.TRXSORCE, 1, 5),  PM10100.CNTRLTYP,  1,  PM20000.VOIDED  FROM  PM10100 JOIN PM20000   ON  PM10100.TRXSORCE = PM20000.TRXSORCE  AND  PM10100.VCHRNMBR = PM20000.VCHRNMBR  AND   PM10100.CNTRLTYP = PM20000.CNTRLTYP  WHERE  PM10100.PSTGSTUS = 1  AND  (PM10100.DISTTYPE = 2 OR PM10100.DISTTYPE = 3)  AND  PM10100.PSTGDATE BETWEEN ' + '''' + @iStartDate + '''' + ' AND ' + '''' + @iEndDate + '''' +  ' GROUP BY  PM10100.PSTGDATE,  PM10100.VENDORID,  PM10100.TRXSORCE,  PM10100.VCHRNMBR,  PM20000.DOCNUMBR,  PM20000.DOCTYPE,  PM10100.CNTRLTYP,  PM20000.VOIDED ')  EXEC(  'INSERT INTO ' +  @iPMTempTable +  ' (PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  DOCNUMBR,  DOCTYPE,  STRVAL,  ACCTAMNT,  TRX_ID,  CNTRLTYP,  HISTRX,  VOIDED)  SELECT  PM30600.PSTGDATE,  PM30600.VENDORID,  PM30600.TRXSORCE,  PM30600.VCHRNMBR,  PM30200.DOCNUMBR,  PM30200.DOCTYPE,  '''',  (SUM(PM30600.CRDTAMNT) - SUM(PM30600.DEBITAMT)),  SUBSTRING(PM30600.TRXSORCE, 1, 5),  PM30600.CNTRLTYP,  1,  PM30200.VOIDED  FROM  PM30600 JOIN PM30200  ON  PM30600.TRXSORCE = PM30200.TRXSORCE  AND (PM30600.TRXSORCE NOT LIKE ''' + @l_cPMVVR + '%'' AND PM30600.TRXSORCE NOT LIKE ''' + @l_cPMVPY + '%'')  AND  PM30600.VCHRNMBR = PM30200.VCHRNMBR  AND  PM30600.DOCTYPE = PM30200.DOCTYPE  WHERE  PM30600.PSTGSTUS = 1   AND  (PM30600.DISTTYPE = 2 OR PM30600.DISTTYPE = 3)  AND  PM30600.PSTGDATE BETWEEN ' + '''' + @iStartDate + '''' + ' AND ' + '''' + @iEndDate + '''' +  ' GROUP BY  PM30600.PSTGDATE,  PM30600.VENDORID,  PM30600.TRXSORCE,  PM30600.VCHRNMBR,  PM30200.DOCNUMBR,  PM30200.DOCTYPE,  PM30600.CNTRLTYP,  PM30200.VOIDED ')   EXEC(  'SELECT   TRXSORCE,  VCHRNMBR,  CNTRLTYP,  ISNULL(SUM(CRDTAMNT - DEBITAMT),0) AS PYMNTAMNT  INTO  ##AccountAmountOpen  FROM  PM10100  WHERE  TRXSORCE LIKE ''' + @l_cPMTRX + '%''   AND  (DISTTYPE = 1 OR DISTTYPE = 4)  AND  PSTGSTUS = 1  AND  PSTGDATE BETWEEN ' + '''' + @iStartDate + '''' + ' AND ' + '''' + @iEndDate + '''' +  'GROUP BY  TRXSORCE,  VCHRNMBR,  CNTRLTYP ')  EXEC(  'SELECT   TRXSORCE,  VCHRNMBR,  CNTRLTYP,  ISNULL(SUM(CRDTAMNT - DEBITAMT),0) AS PYMNTAMNT  INTO  ##AccountAmountHistory  FROM  PM30600  WHERE  TRXSORCE LIKE ''' + @l_cPMTRX + '%''   AND  (DISTTYPE = 1 OR DISTTYPE = 4)  AND  PSTGSTUS = 1  AND  PSTGDATE BETWEEN ' + '''' + @iStartDate + '''' + ' AND ' + '''' + @iEndDate + '''' +  'GROUP BY  TRXSORCE,  VCHRNMBR,  CNTRLTYP ')  EXEC(  'UPDATE ' +  @iPMTempTable +  ' SET  ACCTAMNT = ACCTAMNT + PYMNTAMNT  FROM ' +  @iPMTempTable + ' JOIN ##AccountAmountOpen  ON ' +  @iPMTempTable + '.TRXSORCE = ##AccountAmountOpen.TRXSORCE  AND ' +  @iPMTempTable + '.VCHRNMBR = ##AccountAmountOpen.VCHRNMBR   AND ' +  @iPMTempTable + '.CNTRLTYP = ##AccountAmountOpen.CNTRLTYP ')  EXEC(  'UPDATE ' +  @iPMTempTable +  ' SET  ACCTAMNT = ACCTAMNT + PYMNTAMNT  FROM ' +  @iPMTempTable + ' JOIN ##AccountAmountHistory  ON ' +  @iPMTempTable + '.TRXSORCE = ##AccountAmountHistory.TRXSORCE  AND ' +  @iPMTempTable + '.VCHRNMBR = ##AccountAmountHistory.VCHRNMBR   AND ' +  @iPMTempTable + '.CNTRLTYP = ##AccountAmountHistory.CNTRLTYP ')  EXEC(  'INSERT INTO ' +  @iPMTempTable +  ' (PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  DOCNUMBR,  DOCTYPE,  STRVAL,  ACCTAMNT,  TRX_ID,  CNTRLTYP,  HISTRX,  VOIDED)  SELECT  PM10100.PSTGDATE,  PM10100.VENDORID,  PM10100.TRXSORCE,  PM30200.VCHRNMBR,  PM30200.DOCNUMBR,  PM30200.DOCTYPE,  '''',  -PM30200.DOCAMNT,  SUBSTRING(PM10100.TRXSORCE, 1, 5),   PM30200.CNTRLTYP,  0,  PM30200.VOIDED  FROM  PM10100   JOIN PM10200   ON  PM10100.VCHRNMBR = PM10200.APTVCHNM   and PM10100.CNTRLTYP = case when PM10200.APTODCTY between 1 and 5 then 0 else 1 end  JOIN PM30200   ON   PM10200.VCHRNMBR = PM30200.VCHRNMBR   AND PM10200.DOCTYPE = PM30200.DOCTYPE  WHERE  PM10100.TRXSORCE = PM30200.TRXSORCE  AND  PM10100.TRXSORCE LIKE ''' + @l_cPMTRX + '%''  AND  PM10100.PSTGSTUS = 1  AND  (PM10100.DISTTYPE = 2 OR PM10100.DISTTYPE = 3)  AND  PM30200.CNTRLTYP = 1  AND  PM10100.PSTGDATE BETWEEN ' + '''' + @iStartDate + '''' + ' AND ' + '''' + @iEndDate + '''' +  ' GROUP BY  PM10100.PSTGDATE,  PM10100.VENDORID,  PM10100.TRXSORCE,  PM30200.VCHRNMBR,  PM30200.DOCNUMBR,  PM30200.DOCTYPE,  PM30200.DOCAMNT,  PM30200.CNTRLTYP,  PM30200.VOIDED ')  EXEC(  'INSERT INTO ' +  @iPMTempTable +  ' (PSTGDATE,  VENDORID,  TRXSORCE,   VCHRNMBR,  DOCNUMBR,  DOCTYPE,  STRVAL,  ACCTAMNT,  TRX_ID,  CNTRLTYP,  HISTRX,  VOIDED)  SELECT  PM30600.PSTGDATE,  PM30600.VENDORID,  PM30600.TRXSORCE,  PM30200.VCHRNMBR,  PM30200.DOCNUMBR,  PM30200.DOCTYPE,  '''',  -PM30200.DOCAMNT,  SUBSTRING(PM30600.TRXSORCE, 1, 5),  PM30200.CNTRLTYP,  0,  PM30200.VOIDED  FROM  PM30600   JOIN PM30300   ON  PM30600.VCHRNMBR = PM30300.APTVCHNM   and PM30600.DOCTYPE = PM30300.APTODCTY  JOIN PM30200   ON   PM30300.VCHRNMBR = PM30200.VCHRNMBR   and PM30300.DOCTYPE = PM30200.DOCTYPE  WHERE  PM30600.TRXSORCE = PM30200.TRXSORCE  AND  PM30600.TRXSORCE LIKE ''' + @l_cPMTRX + '%''  AND  PM30600.PSTGSTUS = 1  AND  (PM30600.DISTTYPE = 2 OR PM30600.DISTTYPE = 3)  AND  PM30200.CNTRLTYP = 1  AND  PM30600.PSTGDATE BETWEEN ' + '''' + @iStartDate + '''' + ' AND ' + '''' + @iEndDate + '''' +  ' GROUP BY  PM30600.PSTGDATE,  PM30600.VENDORID,  PM30600.TRXSORCE,  PM30200.VCHRNMBR,  PM30200.DOCNUMBR,  PM30200.DOCTYPE,  PM30200.DOCAMNT,  PM30200.CNTRLTYP,  PM30200.VOIDED ')  EXEC(  'INSERT INTO ' +  @iPMTempTable +  ' (PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  DOCNUMBR,  DOCTYPE,  STRVAL,  ACCTAMNT,  TRX_ID,  CNTRLTYP,  HISTRX,  VOIDED)  SELECT  PM10100.PSTGDATE,  PM10100.VENDORID,  PM10100.TRXSORCE,  PM20000.VCHRNMBR,  ''Payments on Return'',  PM20000.DOCTYPE,  '''',  PM20000.TTLPYMTS,  SUBSTRING(PM10100.TRXSORCE, 1, 5),   2,  0,  PM20000.VOIDED  FROM  PM20000 JOIN PM10100   ON  PM20000.TRXSORCE = PM10100.TRXSORCE   AND   PM20000.VCHRNMBR = PM10100.VCHRNMBR   AND PM10100.CNTRLTYP = 0   WHERE  PM20000.DOCTYPE = 4  AND  PM10100.PSTGSTUS = 1  AND  (PM10100.DISTTYPE = 2 OR PM10100.DISTTYPE = 3)  AND  PM20000.TTLPYMTS <> 0  AND  PM10100.PSTGDATE BETWEEN ' + '''' + @iStartDate + '''' + ' AND ' + '''' + @iEndDate + '''' +  ' GROUP BY  PM10100.PSTGDATE,  PM10100.VENDORID,  PM10100.TRXSORCE,  PM20000.VCHRNMBR,  PM20000.DOCTYPE,  PM20000.TTLPYMTS,  PM20000.VOIDED ')  EXEC(  'INSERT INTO ' +  @iPMTempTable +  ' (PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  DOCNUMBR,  DOCTYPE,  STRVAL,  ACCTAMNT,  TRX_ID,  CNTRLTYP,  HISTRX,  VOIDED)  SELECT  PM30600.PSTGDATE,  PM30600.VENDORID,  PM30600.TRXSORCE,  PM30200.VCHRNMBR,  ''Payments on Return'',  PM30200.DOCTYPE,  '''',  PM30200.TTLPYMTS,  SUBSTRING(PM30600.TRXSORCE, 1, 5),   2,  1,  PM30200.VOIDED  FROM  PM30200 JOIN PM30600   ON  PM30200.TRXSORCE = PM30600.TRXSORCE   AND   PM30200.VCHRNMBR = PM30600.VCHRNMBR   AND PM30200.DOCTYPE = PM30600.DOCTYPE  WHERE  PM30200.DOCTYPE = 4  AND  PM30600.PSTGSTUS = 1  AND  (PM30600.DISTTYPE = 2 OR PM30600.DISTTYPE = 3)  AND  PM30200.TTLPYMTS <> 0  AND  PM30600.PSTGDATE BETWEEN ' + '''' + @iStartDate + '''' + ' AND ' + '''' + @iEndDate + '''' +  ' GROUP BY  PM30600.PSTGDATE,  PM30600.VENDORID,  PM30600.TRXSORCE,  PM30200.VCHRNMBR,  PM30200.DOCTYPE,  PM30200.TTLPYMTS,  PM30200.VOIDED ')  EXEC(  'INSERT INTO ' +  @iPMTempTable +  ' (PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  DOCNUMBR,  DOCTYPE,  STRVAL,  ACCTAMNT,  TRX_ID,  CNTRLTYP,  HISTRX,  VOIDED)  SELECT  PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  '''',  0,  ''Discount Taken'',  -SUM(CRDTAMNT - DEBITAMT),  SUBSTRING(TRXSORCE, 1, 5),  4,  0,  0  FROM  PM10100   WHERE  TRXSORCE LIKE ''' + @l_cPMTRX + '%''  AND  PSTGSTUS = 1  AND  DISTTYPE = 4   AND  PSTGDATE BETWEEN ' + '''' + @iStartDate + '''' + ' AND ' + '''' + @iEndDate + '''' +  ' GROUP BY  PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  CNTRLTYP ')  EXEC(  'INSERT INTO ' +  @iPMTempTable +  ' (PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  DOCNUMBR,  DOCTYPE,  STRVAL,  ACCTAMNT,  TRX_ID,  CNTRLTYP,  HISTRX,  VOIDED)  SELECT  PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  '''',  DOCTYPE,  ''Discount Taken'',  -SUM(CRDTAMNT - DEBITAMT),  SUBSTRING(TRXSORCE, 1, 5),  4,  0,  0  FROM  PM30600  WHERE  TRXSORCE LIKE ''' + @l_cPMTRX + '%''  AND  PSTGSTUS = 1  AND  DISTTYPE = 4   AND  PSTGDATE BETWEEN ' + '''' + @iStartDate + '''' + ' AND ' + '''' + @iEndDate + '''' +  ' GROUP BY  PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  DOCTYPE,  CNTRLTYP ')  EXEC(  'INSERT INTO ' +  @iPMTempTable +  ' (PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  DOCNUMBR,  DOCTYPE,  STRVAL,  ACCTAMNT,  TRX_ID,  CNTRLTYP,  HISTRX,  VOIDED)  SELECT  PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  '''',  0,  '''',  (SUM(CRDTAMNT) - SUM(DEBITAMT)),  SUBSTRING(PM10100.TRXSORCE, 1, 5),  CNTRLTYP,  0,  0  FROM  PM10100   WHERE  TRXSORCE LIKE ''' + @l_cPMAPY + '%''  AND  PSTGSTUS = 1  AND  (DISTTYPE = 2 OR DISTTYPE = 3)  AND  PSTGDATE BETWEEN ' + '''' + @iStartDate + '''' + ' AND ' + '''' + @iEndDate + '''' +  ' GROUP BY  PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  CNTRLTYP ')  EXEC(  'INSERT INTO ' +  @iPMTempTable +  ' (PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  DOCNUMBR,  DOCTYPE,  STRVAL,  ACCTAMNT,  TRX_ID,  CNTRLTYP,  HISTRX,  VOIDED)  SELECT  PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  '''',  0,  ''Revaluation'',  (SUM(CRDTAMNT) - SUM(DEBITAMT)),  SUBSTRING(PM10100.TRXSORCE, 1, 5),  CNTRLTYP,  0,  0  FROM  PM10100   WHERE  TRXSORCE LIKE ''' + @l_cPMRVL + '%''  AND  PSTGSTUS = 1  AND  (DISTTYPE = 2 OR DISTTYPE = 3)  AND  PSTGDATE BETWEEN ' + '''' + @iStartDate + '''' + ' AND ' + '''' + @iEndDate + '''' +  ' GROUP BY  PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  CNTRLTYP ')   EXEC(  'INSERT INTO ' +  @iPMTempTable +  ' (PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  DOCNUMBR,  DOCTYPE,  STRVAL,  ACCTAMNT,  TRX_ID,  CNTRLTYP,  HISTRX,  VOIDED)  SELECT  PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  '''',  DOCTYPE,  '''',  (SUM(CRDTAMNT) - SUM(DEBITAMT)),  SUBSTRING(PM30600.TRXSORCE, 1, 5),  CNTRLTYP,  1,  0  FROM  PM30600   WHERE  TRXSORCE LIKE ''' + @l_cPMAPY + '%''  AND  PSTGSTUS = 1  AND  (DISTTYPE = 2 OR DISTTYPE = 3)  AND  PSTGDATE BETWEEN ' + '''' + @iStartDate + '''' + ' AND ' + '''' +  @iEndDate + '''' +  ' GROUP BY  PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  DOCTYPE,  CNTRLTYP ')  EXEC(  'INSERT INTO ' +  @iPMTempTable +  ' (PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  DOCNUMBR,  DOCTYPE,  STRVAL,  ACCTAMNT,  TRX_ID,  CNTRLTYP,  HISTRX,  VOIDED)  SELECT  PM30600.PSTGDATE,  PM30600.VENDORID,  PM30600.TRXSORCE,  PM30600.VCHRNMBR,  PM30200.DOCNUMBR,  PM30200.DOCTYPE,  '''',  (SUM(PM30600.CRDTAMNT) - SUM(PM30600.DEBITAMT)),  SUBSTRING(PM30600.TRXSORCE, 1, 5),  PM30600.CNTRLTYP,  0,  0  FROM  PM30600,  PM30200   WHERE  (PM30600.TRXSORCE LIKE ''' + @l_cPMVVR + '%'' OR PM30600.TRXSORCE LIKE ''' + @l_cPMVPY + '%'')  AND  PM30600.VCHRNMBR = PM30200.VCHRNMBR  AND  PM30600.DOCTYPE = PM30200.DOCTYPE  AND  PM30600.PSTGSTUS = 1 and PM30200.VOIDED = 1  AND  (PM30600.DISTTYPE = 2 OR PM30600.DISTTYPE = 3)  AND  PM30600.PSTGDATE BETWEEN ' + '''' + @iStartDate + '''' + ' AND ' + '''' + @iEndDate + '''' +  ' GROUP BY  PM30600.PSTGDATE,  PM30600.VENDORID,  PM30600.TRXSORCE,  PM30600.VCHRNMBR,  PM30200.DOCNUMBR,  PM30200.DOCTYPE,  PM30600.CNTRLTYP ')  EXEC(  'INSERT INTO ' +  @iPMTempTable +  ' (PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  DOCNUMBR,  DOCTYPE,  STRVAL,  ACCTAMNT,  TRX_ID,  CNTRLTYP,  HISTRX,  VOIDED)  SELECT  PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  '''',  DOCTYPE,  ''Revaluation'',  (SUM(CRDTAMNT) - SUM(DEBITAMT)),  SUBSTRING(PM30600.TRXSORCE, 1, 5),  CNTRLTYP,  1,  0  FROM  PM30600   WHERE  TRXSORCE LIKE ''' + @l_cPMRVL + '%''  AND  PSTGSTUS = 1  AND  (DISTTYPE = 2 OR DISTTYPE = 3)  AND  PSTGDATE BETWEEN ' + '''' + @iStartDate + '''' + ' AND ' + '''' + @iEndDate + '''' +  ' GROUP BY  PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  DOCTYPE,  CNTRLTYP ')  EXEC(  'INSERT INTO ' +  @iPMTempTable +  ' (PSTGDATE,  VENDORID,  TRXSORCE,  VCHRNMBR,  DOCNUMBR,  DOCTYPE,  STRVAL,  ACCTAMNT,  TRX_ID,  CNTRLTYP,  HISTRX,  VOIDED)  SELECT  PM30200.PSTGDATE,  PM30600.VENDORID,  PM30200.TRXSORCE,  PM30600.VCHRNMBR,  PM30200.DOCNUMBR,  PM30200.DOCTYPE,  '''',  -PM30200.DOCAMNT,  SUBSTRING(PM30200.TRXSORCE, 1, 5),  PM30200.CNTRLTYP,  0,  0  FROM  PM30600,  PM30200   WHERE  PM30200.TRXSORCE LIKE ''' + @l_cPMTRX + '%''  AND  PM30600.VCHRNMBR = PM30200.VCHRNMBR  AND  PM30600.DOCTYPE = PM30200.DOCTYPE  AND  PM30600.VENDORID = PM30200.VENDORID  AND  PM30600.PSTGSTUS = 1   AND   PM30200.VOIDED = 1  AND  (PM30600.DISTTYPE = 2 OR PM30600.DISTTYPE = 3)  AND  PM30200.PSTGDATE BETWEEN ' + '''' + @iStartDate + '''' + ' AND ' + '''' + @iEndDate + '''' + '   AND NOT EXISTS  (SELECT TOP 1 1 FROM ['+ @iPMTempTable +'] a WHERE PM30200.TRXSORCE = a.TRXSORCE   AND  PM30200.VCHRNMBR = a.VCHRNMBR )  GROUP BY  PM30200.PSTGDATE,  PM30600.VENDORID,  PM30200.TRXSORCE,  PM30600.VCHRNMBR,  PM30200.DOCNUMBR,  PM30200.DOCTYPE,  PM30200.DOCAMNT,  PM30200.CNTRLTYP ')  DROP TABLE  ##AccountAmountOpen,  ##AccountAmountHistory  RETURN (@lSQLError)    
GO
GRANT EXECUTE ON  [dbo].[glGetPMTransactions] TO [DYNGRP]
GO
