SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[glSetRetainedEarningsStatus] @I_iSQLSessionID int  = NULL, @I_sAllocationType smallint = NULL, @I_tPosting tinyint = NULL, @I_mDebit numeric(19,5) = NULL, @I_mCredit numeric(19,5) = NULL, @I_sFuncDecimalPlaces smallint = NULL, @I_sMCTransaction smallint = NULL, @I_mOrigDebit numeric(19,5) = NULL, @I_mOrigCredit numeric(19,5) = NULL, @I_cOrigCurrencyID char(15) = NULL, @I_sOrigDecimalPlaces smallint = NULL,  @O_iError int  = NULL output, @O_bLineMessages binary(4) = NULL output, @O_bLineMessages2 binary(4) = NULL output,  @O_tDistributionsExist tinyint = NULL output, @O_iErrorState int  = NULL output  as  declare  @iAccountIndex int,  @iNextAccountIndex int,  @sAccountType smallint,  @MS_ITEM_6 int,  @MS_ITEM_22 int,  @MS_ITEM_23 int,  @MS_ITEM_24 int,  @MS_ITEM_25 int,  @MS_ITEM_26 int,  @MS_ITEM_27 int,  @MS_ITEM_28 int,  @MS_ITEM_32 int,  @ACTIVE smallint,    @BAL_SHEET    smallint,  @FALSE     tinyint,  @FIXED smallint,  @POST_ACCT    smallint,  @POST_ALLOC_ACCT smallint,  @PROFIT_AND_LOSS smallint,  @TRUE tinyint,  @YEAR_END_CLOSE smallint,  @iStatus int,  @iError int  select  @O_iErrorState = 0,  @O_bLineMessages = 0,  @O_bLineMessages2 = 0,  @O_iError = 0  select  @ACTIVE   = 1,  @BAL_SHEET  = 0,  @FALSE   = 0,  @FIXED   = 1,  @POST_ACCT  = 1,  @POST_ALLOC_ACCT = 3,  @PROFIT_AND_LOSS = 1,  @TRUE   = 1,  @YEAR_END_CLOSE = 3,  @MS_ITEM_6  = power(2,29),  @MS_ITEM_22  = power(2,13),  @MS_ITEM_23  = power(2,14),  @MS_ITEM_24  = power(2,15),  @MS_ITEM_25  = power(2,0),  @MS_ITEM_26  = power(2,1),  @MS_ITEM_27  = power(2,2),  @MS_ITEM_28  = power(2,3),  @MS_ITEM_32  = power(2,7)  if  @I_iSQLSessionID is NULL  or @I_sAllocationType is NULL  or @I_tPosting is NULL  or @I_mDebit is NULL  or @I_mCredit is NULL  or @I_sFuncDecimalPlaces is NULL  or @I_sMCTransaction is NULL  or @I_mOrigDebit is NULL  or @I_mOrigCredit is NULL  or @I_cOrigCurrencyID is NULL  or @I_sOrigDecimalPlaces is NULL begin  select @O_iErrorState = 20537  return end  if exists (  select  1  from  #RetainedEarn   where  tVerified = @FALSE  and ( ( sAccountType = @POST_ACCT  and sPostingType <> @BAL_SHEET )  or ( sAccountType = @POST_ALLOC_ACCT  and sFixedOrVariable <> @FIXED )  or ( sAccountType <> @POST_ACCT  and sAccountType <> @POST_ALLOC_ACCT )  ) )  begin  update  #RetainedEarn   set  bLineMessages = (bLineMessages | @MS_ITEM_32)  where  tVerified = @FALSE  and sAccountType = @POST_ACCT  and sPostingType <> @BAL_SHEET   if @@rowcount > 0  begin  select @O_iError = 3  select @O_bLineMessages = (@O_bLineMessages | @MS_ITEM_32)  if @I_tPosting = @TRUE  begin  select @O_iErrorState = 20432  return  end  end    update  #RetainedEarn   set  bLineMessages = (bLineMessages | @MS_ITEM_23)  where  tVerified = @FALSE  and sAccountType = @POST_ALLOC_ACCT  and sFixedOrVariable <> @FIXED   if @@rowcount > 0  begin  select @O_iError = 4  select @O_bLineMessages = (@O_bLineMessages | @MS_ITEM_23)  if @I_tPosting = @TRUE  begin  select @O_iErrorState = 20433  return  end  end    update  #RetainedEarn   set  bLineMessages = (bLineMessages | @MS_ITEM_22)  where  tVerified = @FALSE  and sAccountType <> @POST_ACCT  and sAccountType <> @POST_ALLOC_ACCT   if @@rowcount > 0  begin  select @O_iError = 2  select @O_bLineMessages = (@O_bLineMessages | @MS_ITEM_22)  if @I_tPosting = @TRUE  begin  select @O_iErrorState = 20431  return  end  end    end   update  #RetainedEarn  set  bLineMessages = (bLineMessages | @MS_ITEM_6) where  tVerified = @FALSE  and tActive <> @ACTIVE  if @@rowcount > 0 begin  select @O_iError = 10  select @O_bLineMessages = (@O_bLineMessages | @MS_ITEM_6)  if @I_tPosting = @TRUE  begin  select @O_iErrorState = 20434  return  end end   select  @iAccountIndex = min( iAccountIndex ) from  #RetainedEarn  where  tVerified = @FALSE  and sAccountType = @POST_ALLOC_ACCT  and sFixedOrVariable = @FIXED  while @iAccountIndex is not NULL begin  execute @iStatus = glpVerifyFixedAllocation  @I_iSQLSessionID,  @iAccountIndex,  @I_mDebit,  @I_mCredit,  @I_tPosting,  @I_sAllocationType,  @I_sFuncDecimalPlaces,  @I_sMCTransaction,  @I_mOrigDebit,  @I_mOrigCredit,  @I_cOrigCurrencyID,  @I_sOrigDecimalPlaces,  @O_bLineMessages output,  @O_bLineMessages2 output,  @sAccountType output,   @O_tDistributionsExist output,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  begin  select @iStatus = @iError  end   if @O_bLineMessages <> 0  begin  if (@O_bLineMessages & @MS_ITEM_28 ) = @MS_ITEM_28  select @O_iError = 9  else if (@O_bLineMessages & @MS_ITEM_27 ) = @MS_ITEM_27  select @O_iError = 8  else if (@O_bLineMessages & @MS_ITEM_26 ) = @MS_ITEM_26  select @O_iError = 7  else if (@O_bLineMessages & @MS_ITEM_25 ) = @MS_ITEM_25  select @O_iError = 6  else if (@O_bLineMessages & @MS_ITEM_24 ) = @MS_ITEM_24  select @O_iError = 5   update  #RetainedEarn   set  bLineMessages = @O_bLineMessages,  tDistributionsExist = @O_tDistributionsExist  where  tVerified = @FALSE  and iAccountIndex = @iAccountIndex   if @I_tPosting = @TRUE  return @iStatus  end    else  begin  update  #RetainedEarn   set  tDistributionsExist = @O_tDistributionsExist  where  tVerified = @FALSE  and iAccountIndex = @iAccountIndex   end    if @iStatus <> 0 or @O_iErrorState <> 0  return @iStatus   select  @iNextAccountIndex = min( iAccountIndex )  from  #RetainedEarn   where  tVerified = @FALSE  and iAccountIndex > @iAccountIndex  and sAccountType = @POST_ALLOC_ACCT  and sFixedOrVariable = @FIXED   select @iAccountIndex = @iNextAccountIndex  end   update  #RetainedEarn  set  tVerified = @TRUE where  tVerified = @FALSE  return    
GO
GRANT EXECUTE ON  [dbo].[glSetRetainedEarningsStatus] TO [DYNGRP]
GO
