SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create           procedure [dbo].[aagUpdateReportTableForBREditList]   @USERID char(15),  @DOCTYPE int,  @DOCNUMBR char(21),  @Master_ID char(31),  @PSTDATE datetime,  @Opt int output,   @Hdr nvarchar(30),  @Dist nvarchar(30),  @Assign nvarchar(30),  @I_UserID varchar(20),  @I_Right int  as begin  declare @aaSubLedgerHdrID int,  @lDocType int,  @DocNum char(21),  @isval tinyint,  @POSTED int  SELECT aaSubLedgerHdrID INTO #TEMP FROM AAG20000 WHERE 1 = 2   exec ('truncate table ' + @Hdr)  exec ('truncate table ' + @Dist)  exec ('truncate table ' + @Assign)  delete AAG2000E   from AAG2000E a  join AAG20000 b  on a.aaSubLedgerHdrID = b.aaSubLedgerHdrID  where b.DOCNUMBR = @DOCNUMBR  and b.DOCTYPE = @DOCTYPE  and b.Master_ID = @Master_ID   and b.SERIES = 2  if @Opt = 0   begin  declare  CHdr cursor fast_forward for  Select Hdr.aaSubLedgerHdrID, Hdr.DOCTYPE, Hdr.DOCNUMBR ,Dist.POSTED  from AAG20000 as Hdr , AAG20001 as Dist  where Dist.aaSubLedgerHdrID = Hdr.aaSubLedgerHdrID and  Hdr.DOCTYPE = 1  and  Dist.aaSubLedgerDistID = 1 and   SERIES = 2 and DOCTYPE = @DOCTYPE and  DOCNUMBR = @DOCNUMBR and Master_ID = @Master_ID  end  else if @Opt = 1 or @Opt = 2   begin  declare CHdr cursor fast_forward for  Select Hdr.aaSubLedgerHdrID, Hdr.DOCTYPE, Hdr.DOCNUMBR, Dist.POSTED  from AAG20000 as Hdr , AAG20001 as Dist  where  Dist.aaSubLedgerHdrID = Hdr.aaSubLedgerHdrID and  Hdr.DOCTYPE <> 1 and  Dist.aaSubLedgerDistID = 1 and   SERIES = 2 and DOCTYPE > 0 and  DOCNUMBR <> '' and Master_ID = @Master_ID and  Dist.POSTED = 0   end  open CHdr  fetch next from CHdr into @aaSubLedgerHdrID, @lDocType, @DocNum, @POSTED  while @@fetch_status = 0  begin   insert into #TEMP values (@aaSubLedgerHdrID)   Insert into AAG50000  (USERID, TRXBTCHSRC, aaSubLedgerHdrID,  SERIES, DOCTYPE, DOCNUMBR,PSTGDATE,aaOrder)   values(@USERID,0,@aaSubLedgerHdrID,2,@lDocType,@DocNum,@PSTDATE,0)  exec('insert into '+ @Hdr + '(USERID, TRXBTCHSRC, aaSubLedgerHdrID,  SERIES, DOCTYPE, DOCNUMBR,PSTGDATE,aaOrder)  select USERID, TRXBTCHSRC, aaSubLedgerHdrID,  SERIES, DOCTYPE, DOCNUMBR,PSTGDATE,0 from AAG50000')  delete AAG50000  if @Opt = 1  begin  exec aagInsertDistandAssignToReportTempTables  @aaSubLedgerHdrID,  @Dist,  @Assign,  0   end  exec aagValidateCodeSubLedHdr 'AAG20002', 'AAG20003',  'AAG2000E', @aaSubLedgerHdrID , @isval output,@I_UserID,@I_Right   fetch next from CHdr into @aaSubLedgerHdrID, @lDocType, @DocNum, @POSTED   end  close CHdr  deallocate CHdr  Select @Opt = count(*) from AAG2000E WHERE aaSubLedgerHdrID in (SELECT aaSubLedgerHdrID FROM #TEMP)   if @Opt > 0  begin  set @Opt = 5  end end    
GO
GRANT EXECUTE ON  [dbo].[aagUpdateReportTableForBREditList] TO [DYNGRP]
GO
