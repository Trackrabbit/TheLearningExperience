SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create  procedure [dbo].[aagValidateCodeGLWorkHdrForAdjustment] @I_cTableAssign nvarchar(30) = null, @I_cTableCode nvarchar(30) = null, @I_cTableError nvarchar(30) = null, @I_nHdrID int, @O_fValidCode tinyint = 1 output, @I_UserID varchar(20), @I_Right int  as begin  set nocount on  declare  @nDistID int,  @nDebitAmt numeric(19,5),  @nCreditAmt numeric(19,5),  @nActIndx int,  @nAcctClassID int,  @nErrorCount int,  @fValidCode tinyint,  @dAcctDate datetime,   @dTransDate datetime,   @aaBrowseType smallint  set @fValidCode = 1  set @O_fValidCode = 1  set @aaBrowseType = 0  exec ('declare aaGLWorkHdr cursor fast_forward FOR  select aaGLWorkDistID,aaBrowseType,DEBITAMT,CRDTAMNT,ACTINDX,convert(datetime,convert(char(12),aaChangeDate,102)+ convert(char(12),aaChangeTime,108))  from AAG10001  where aaGLWorkHdrID = str ('+@I_nHdrID + ')' )  open aaGLWorkHdr  fetch next from aaGLWorkHdr into @nDistID,@aaBrowseType,@nDebitAmt,@nCreditAmt,@nActIndx,@dTransDate  while @@fetch_status = 0  Begin  Set @fValidCode = 1  If exists(select aaAcctClassID from AAG00200 where ACTINDX = @nActIndx)  begin   select @nAcctClassID = aaAcctClassID from AAG00200 where ACTINDX = @nActIndx  select @dAcctDate = convert(datetime,convert(char(12),aaChangeDate,102)+ convert(char(12),aaChangeTime,108)) from AAG00200 where ACTINDX = @nActIndx  end  Else  set @nAcctClassID = 0   if @dAcctDate>@dTransDate  begin  Exec aagValidateCodeGLWorkDistForAdjustment  1,  @I_cTableAssign,  @I_cTableCode,  @I_cTableError,  @I_nHdrID,  @nDistID,  @nDebitAmt,  @nCreditAmt,  @nAcctClassID,  @nActIndx,  1,  @fValidCode output,  @I_UserID,  @I_Right   If @fValidCode = 0  set @O_fValidCode = 0  end  else set @fValidCode = 1   exec aagValidateCodeGLWorkDistForAdjustment  2,  @I_cTableAssign,  @I_cTableCode,  @I_cTableError,  @I_nHdrID,  @nDistID,  @nDebitAmt,  @nCreditAmt,  @nAcctClassID,  @nActIndx,  1,  @fValidCode output,  @I_UserID,  @I_Right   If @fValidCode = 0  set @O_fValidCode = 0  fetch next from aaGLWorkHdr into @nDistID,@aaBrowseType,@nDebitAmt,@nCreditAmt,@nActIndx,@dTransDate  End  close aaGLWorkHdr  deallocate aaGLWorkHdr  exec aagUpdateSLDistForBrowseTypeGLWork  @I_cTableError,  @I_nHdrID,  1  exec aagUpdateSLDistForBrowseTypeGLWork  @I_cTableError,  @I_nHdrID,  0  set nocount off  return end    
GO
GRANT EXECUTE ON  [dbo].[aagValidateCodeGLWorkHdrForAdjustment] TO [DYNGRP]
GO
