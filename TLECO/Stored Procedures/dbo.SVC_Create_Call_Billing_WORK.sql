SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_Create_Call_Billing_WORK]  (@USERID char(15),  @CompleteDate datetime,  @TechID char(11),  @Customer char(15),  @Office char(11),  @Type smallint,  @Error integer OUTPUT)  AS  declare @COMPSTAT char(3) declare @MinDate datetime  exec smGetMinDate @MinDate output  select @Error = 0 select @COMPSTAT = Ready_To_Invoice_Status  from SVC00998 IF @COMPSTAT is null or @COMPSTAT = ''  BEGIN  select @Error = -1  return 0 END delete from SVC00215 where USERID = @USERID IF @Type = 0 BEGIN  insert into SVC00215 select @USERID,SVC00200.SRVRECTYPE,SVC00200.CALLNBR,SVC00200.SRVSTAT,SVC00200.CUSTNMBR,SVC00200.TECHID,SVC00200.OFFID,'','','',SVC00200.SRVTYPE,SVC00200.SVCDESCR,SVC00200.PRETAXTOT,0,0,0,'',''  from SVC00200  WHERE  SVC00200.SRVRECTYPE = 2 AND  SVC00200.COMPDTE > @MinDate AND  SVC00200.COMPDTE <= @CompleteDate AND  SVC00200.SRVSTAT = @COMPSTAT  END ELSE IF @Type = 1 BEGIN  insert into SVC00215  select @USERID,SVC00200.SRVRECTYPE,SVC00200.CALLNBR,SVC00200.SRVSTAT,SVC00200.CUSTNMBR,SVC00200.TECHID,SVC00200.OFFID,'','','',SVC00200.SRVTYPE,SVC00200.SVCDESCR,SVC00200.PRETAXTOT,0,0,0,'','' from SVC00200 left join (select distinct SVC00200.SRVRECTYPE, SVC00200.CALLNBR   from SVC00200   LEFT OUTER join SVC00207 on SVC00200.SRVRECTYPE = SVC00207.SRVRECTYPE and SVC00200.CALLNBR = SVC00207.CALLNBR  where SVC00200.SRVRECTYPE = 2   and (   (@TechID = '' and SVC00200.TECHID = @TechID and SVC00207.TECHID is null)    or (@TechID <> '' and SVC00200.TECHID = @TechID or SVC00207.TECHID = @TechID)   ) ) as MultTech on SVC00200.SRVRECTYPE = MultTech.SRVRECTYPE and SVC00200.CALLNBR = MultTech.CALLNBR  WHERE  SVC00200.SRVRECTYPE = 2 AND  SVC00200.COMPDTE > @MinDate AND  SVC00200.COMPDTE <= @CompleteDate AND  SVC00200.SRVSTAT = @COMPSTAT AND  (MultTech.CALLNBR is not null)  END ELSE IF @Type = 2 BEGIN  insert into SVC00215  select @USERID,SVC00200.SRVRECTYPE,SVC00200.CALLNBR,SVC00200.SRVSTAT,SVC00200.CUSTNMBR,SVC00200.TECHID,SVC00200.OFFID,'','','',SVC00200.SRVTYPE,SVC00200.SVCDESCR,SVC00200.PRETAXTOT,0,0,0,'',''  from SVC00200  WHERE  SVC00200.SRVRECTYPE = 2 AND  SVC00200.COMPDTE > @MinDate AND  SVC00200.COMPDTE <= @CompleteDate AND  SVC00200.SRVSTAT = @COMPSTAT AND  SVC00200.OFFID = @Office  END ELSE IF @Type = 3 BEGIN  insert into SVC00215  select @USERID,SVC00200.SRVRECTYPE,SVC00200.CALLNBR,SVC00200.SRVSTAT,SVC00200.CUSTNMBR,SVC00200.TECHID,SVC00200.OFFID,'','','',SVC00200.SRVTYPE,SVC00200.SVCDESCR,SVC00200.PRETAXTOT,0,0,0,'',''  from SVC00200  WHERE  SVC00200.SRVRECTYPE = 2 AND  SVC00200.COMPDTE > @MinDate AND  SVC00200.COMPDTE <= @CompleteDate AND  SVC00200.SRVSTAT = @COMPSTAT AND  SVC00200.CUSTNMBR = @Customer END   
GO
GRANT EXECUTE ON  [dbo].[SVC_Create_Call_Billing_WORK] TO [DYNGRP]
GO
