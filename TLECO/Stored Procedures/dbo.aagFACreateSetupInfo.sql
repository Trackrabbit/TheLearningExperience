SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE PROC [dbo].[aagFACreateSetupInfo]( @ASSETINDEX INTEGER, @BOOKINDEX INTEGER, @aaAliasID INTEGER, @COMPANYID SMALLINT, @USERID VARCHAR(15), @aaFASetupID INTEGER OUTPUT ) AS BEGIN  DECLARE @ACTINDX INTEGER,  @Count INTEGER,  @ListID SMALLINT,  @aaBrowseType SMALLINT,  @AcctClassID INT,  @AcctType SMALLINT   SET @Count=0  SET @aaFASetupID=0  SELECT @Count=count(*) FROM AAG04000 WHERE aaAssetIndex=@ASSETINDEX and aaBookIndex=@BOOKINDEX  IF @Count>0  BEGIN   DELETE FROM  AAG04001 WHERE aaFASetupID in(Select aaFASetupID from AAG04000 where aaAssetIndex=@ASSETINDEX and aaBookIndex=@BOOKINDEX)  DELETE FROM  AAG04000 WHERE aaAssetIndex=@ASSETINDEX and aaBookIndex=@BOOKINDEX  END  EXEC DYNAMICS.dbo.aagGetNextID 20000,@COMPANYID,@aaFASetupID OUT   IF @aaFASetupID !=0   BEGIN  SET @ListID=1  DECLARE CREATEDIST CURSOR FAST_FORWARD FOR  SELECT ACT FROM (SELECT ASSETINDEX, DEPREXPACCTINDX, DEPRRESVACCTINDX, PRIORYRDEPRACCTINDX, ASSETCOSTACCTINDX, PROCEEDSACCTINDX, RECGAINLOSSACCTINDX,   NONRECGAINLOSSACCTINDX, CLEARINGACCTINDX FROM FA00400 WHERE ASSETINDEX = @ASSETINDEX) p  UNPIVOT (ACT FOR ASSETI in ( DEPREXPACCTINDX, DEPRRESVACCTINDX, PRIORYRDEPRACCTINDX, ASSETCOSTACCTINDX, PROCEEDSACCTINDX, RECGAINLOSSACCTINDX,   NONRECGAINLOSSACCTINDX, CLEARINGACCTINDX )) as a WHERE ASSETINDEX = @ASSETINDEX  OPEN CREATEDIST  FETCH NEXT FROM CREATEDIST INTO @ACTINDX  WHILE @@fetch_status = 0  BEGIN  SELECT @AcctType=ACCTTYPE FROM GL00100 WHERE ACTINDX=@ACTINDX  EXEC aagGetClassIDBrowseType @ACTINDX,@AcctClassID OUTPUT,@aaBrowseType OUTPUT  INSERT INTO AAG04000(aaFASetupID,ListID,INTERID,USERID,SERIES,ACTINDX,ACCTTYPE,aaBrowseType,aaAssetIndex,aaBookIndex,aaAliasID)   VALUES (@aaFASetupID,@ListID,DB_NAME(),@USERID,2,@ACTINDX,@AcctType,@aaBrowseType,@ASSETINDEX,@BOOKINDEX,@aaAliasID)  IF @AcctClassID !=0  BEGIN  IF @aaAliasID=0   BEGIN  IF EXISTS(SELECT TOP 1 1 FROM AAG04000 WHERE aaAssetIndex = @ASSETINDEX AND aaBookIndex = 0) AND @BOOKINDEX <> 0   INSERT INTO AAG04001 (aaFASetupID, ListID,aaTrxDimID, aaTrxDimCodeID)   SELECT @aaFASetupID,@ListID,aaTrxDimID,aaTrxDimCodeID   FROM AAG04001   WHERE aaFASetupID = (SELECT TOP 1 aaFASetupID FROM AAG04000 WHERE aaAssetIndex = @ASSETINDEX AND aaBookIndex = 0) AND  ListID = @ListID  ELSE  INSERT INTO AAG04001 (aaFASetupID, ListID,aaTrxDimID, aaTrxDimCodeID)   SELECT @aaFASetupID, @ListID,aaTrxDimID,aaTrxDimCodeIDDflt  FROM AAG00202 WHERE aaAcctClassID = @AcctClassID AND aaTrxDimID >=0   AND aaTrxDimID NOT IN (SELECT l.aaTrxDimID FROM AAG04001 l WHERE l.aaFASetupID = @aaFASetupID AND l.ListID = @ListID)   END  ELSE  BEGIN  INSERT INTO AAG04001 (aaFASetupID, ListID,aaTrxDimID, aaTrxDimCodeID)   SELECT @aaFASetupID, @ListID, aaTrxDimID,aaTrxDimCodeID  FROM AAG00801 WHERE aaAliasID=@aaAliasID and aaTrxDimID >=0   AND aaTrxDimID NOT IN (SELECT l.aaTrxDimID FROM AAG04001 l WHERE l.aaFASetupID = @aaFASetupID AND l.ListID = @ListID)  END  END  SET @ListID=@ListID+1  FETCH NEXT FROM CREATEDIST INTO @ACTINDX  END  CLOSE CREATEDIST  DEALLOCATE CREATEDIST  END END  SET QUOTED_IDENTIFIER OFF    
GO
GRANT EXECUTE ON  [dbo].[aagFACreateSetupInfo] TO [DYNGRP]
GO
