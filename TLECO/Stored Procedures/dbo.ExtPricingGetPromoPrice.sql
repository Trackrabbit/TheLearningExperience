SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[ExtPricingGetPromoPrice]  @piST_DorP char(1),      @piST_CustomerNumber char(15),   @piST_ItemNumber char(31),   @piST_UofM char(9),    @piDA_Date datetime,    @piDE_Qty decimal(19,5),     @piST_Currency char(16),    @poDE_Price decimal(19,5) OUTPUT,  @poDE_Value decimal(19,5) OUTPUT,  @poST_SchemeCode char(15) OUTPUT,  @poST_SchemeItemType char (1) OUTPUT,   @poIN_PromLevel integer OUTPUT,   @poIN_PromType integer OUTPUT,   @poST_SchemeGroup char(31) OUTPUT,   @poDE_QtyFrom decimal (19,5) OUTPUT,         @poDE_QtyTo decimal (19,5) OUTPUT,            @poIN_PromFound integer OUTPUT,  @poIN_CurrPriceFound integer  OUTPUT,  @QuantityFree decimal(19,5) OUTPUT, @StartDate datetime OUTPUT, @EndDate datetime OUTPUT, @Description char(50) OUTPUT  AS  DECLARE @loDE_Value decimal(19,5),  @loDE_EQUOMQTY decimal(19,5),  @loDA_StartDate datetime,  @loDA_EndDate datetime,  @loST_BaseUofM char(9),  @loDA_NextStartDate datetime,  @loDA_NextEndDate datetime,  @loIN_DecPlaces integer,  @loIN_DPQty integer,  @loST_SchemeCode char(15),  @loST_SchemeItemType char(1),  @loIN_PromLevel integer,  @loIN_PromType integer,  @loST_SchemeGroup char(31),  @loDE_QtyFrom decimal(19,5),  @loDE_QtyTo decimal(19,5),  @loDE_QtyFree decimal(19,5),  @loSM_CompanyID smallint,  @loST_FUNLCURR char(16),  @loIN_PricesNotReqd integer,  @loIN_ConvertFunctPrice integer,  @loST_Description char(50)  SELECT @loSM_CompanyID = CMPANYID FROM DYNAMICS..SY01500 WHERE INTERID = (select db_name())  SET @poIN_PromFound = 1  SELECT @loIN_DecPlaces = DECPLCUR - 1, @loIN_DPQty = DECPLQTY - 1  FROM IV00101 where ITEMNMBR = @piST_ItemNumber  IF @piDE_Qty = 0 BEGIN  RETURN 0 END  EXECUTE ExtPricingGetFunctionalCurrency @loST_FUNLCURR OUTPUT  IF @loST_FUNLCURR IS NULL BEGIN  SELECT @loST_FUNLCURR = '' END  SELECT @loIN_PricesNotReqd = SOP40100.Prices_Not_Required_In_Pr,  @loIN_ConvertFunctPrice = SOP40100.Convert_Functional_Price  FROM SOP40100  IF @piST_Currency = @loST_FUNLCURR BEGIN  GOTO FunctCurrencyRoutines END  IF (SELECT COUNT(*)   FROM IV00105  WHERE ITEMNMBR = @piST_ItemNumber AND  CURNCYID = @piST_Currency) > 0 BEGIN  SELECT  @loIN_DecPlaces = DECPLCUR - 1  FROM IV00105  WHERE ITEMNMBR = @piST_ItemNumber AND  CURNCYID = @piST_Currency END ELSE BEGIN  IF (@loIN_PricesNotReqd = 1) AND (@loIN_ConvertFunctPrice = 1)  BEGIN  GOTO FunctCurrencyRoutines  END  ELSE  BEGIN  RETURN 50031  END END   SET  @poIN_CurrPriceFound = 1  IF @piST_CustomerNumber IS NULL BEGIN  GOTO CurrBaseListProduct END  CurrCustomerProduct:  DECLARE scCurrCustomerProduct SCROLL CURSOR FOR  SELECT SWU.PSITMVAL,   SWU.EQUOMQTY,  SH.STRTDATE,   SH.ENDDATE,  SW.BASEUOFM,  SW.PRCSHID,  SW.EPITMTYP,  SW.PROMOLVL,  SW.PROMOTYP,  SWU.QTYFROM,  SWU.QTYTO,  SH.DESCEXPR  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  WHERE SL.PRODTCOD = @piST_DorP  AND SL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR = @piST_ItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @piST_Currency  AND SWU.UOFM = @piST_UofM  AND @piDE_Qty BETWEEN SWU.QTYFROM AND SWU.QTYTO  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE  OPEN scCurrCustomerProduct  FETCH FIRST FROM scCurrCustomerProduct  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description   IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scCurrCustomerProduct  DEALLOCATE scCurrCustomerProduct  GOTO CurrCustomerGroup END ELSE BEGIN  FETCH NEXT FROM  scCurrCustomerProduct  INTO  @loDE_Value,  @loDE_EQUOMQTY,  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description   IF @@FETCH_STATUS = 0  BEGIN  IF @loDA_StartDate = @loDA_NextStartDate and @loDA_EndDate = @loDA_NextEndDate  BEGIN  CLOSE scCurrCustomerProduct  DEALLOCATE scCurrCustomerProduct  IF (@loIN_PricesNotReqd = 1) AND (@loIN_ConvertFunctPrice = 1)  BEGIN  GOTO FunctCurrencyRoutines  END  ELSE  BEGIN  SET @poIN_PromFound = 0  RETURN 50001  END  END  END END  FETCH FIRST FROM scCurrCustomerProduct  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  CLOSE scCurrCustomerProduct DEALLOCATE scCurrCustomerProduct  SET @StartDate = @loDA_StartDate SET @EndDate = @loDA_EndDate SET @Description = @loST_Description  IF @loIN_PromType = 1 BEGIN  SELECT @poDE_Price = @loDE_Value * @loDE_EQUOMQTY  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 2 OR @loIN_PromType = 3 BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poDE_Value =  @loDE_Value  IF @loIN_PromType = 2  BEGIN  SELECT @poDE_Value =  @loDE_Value  END  ELSE  BEGIN  SELECT @poDE_Value =  @loDE_Value * @loDE_EQUOMQTY  END  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 4 BEGIN  SELECT @QuantityFree = @loDE_Value * @piDE_Qty  IF @QuantityFree <> 0  BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  SELECT @poST_SchemeGroup = ''  END  ELSE  BEGIN  SET @poIN_PromFound = 0  END  RETURN 0 END  CurrCustomerGroup:  DECLARE scCurrCustomerGroup SCROLL CURSOR FOR  SELECT SWU.PSITMVAL,  SWU.EQUOMQTY,  SH.STRTDATE,  SH.ENDDATE,   SW.BASEUOFM,  SW.PRCSHID,  SW.EPITMTYP,  SW.ITEMNMBR,  SW.PROMOLVL,  SW.PROMOTYP,  SWU.QTYFROM,  SWU.QTYTO,  SH.DESCEXPR  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  WHERE SL.PRODTCOD = @piST_DorP  AND SL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR = @piST_ItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @piST_Currency  AND SWU.UOFM = @piST_UofM  AND @piDE_Qty BETWEEN SWU.QTYFROM AND SWU.QTYTO  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE  OPEN scCurrCustomerGroup  FETCH FIRST FROM scCurrCustomerGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scCurrCustomerGroup  DEALLOCATE scCurrCustomerGroup  GOTO CurrPriceListProduct END ELSE BEGIN  FETCH NEXT FROM scCurrCustomerGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description   IF @@FETCH_STATUS = 0  BEGIN  IF @loDA_StartDate = @loDA_NextStartDate and @loDA_EndDate = @loDA_NextEndDate  BEGIN  CLOSE scCurrCustomerGroup  DEALLOCATE scCurrCustomerGroup  IF (@loIN_PricesNotReqd = 1) AND (@loIN_ConvertFunctPrice = 1)  BEGIN  GOTO FunctCurrencyRoutines  END  ELSE  BEGIN  SET @poIN_PromFound = 0  RETURN 50002  END  END  END END  FETCH FIRST FROM scCurrCustomerGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  CLOSE scCurrCustomerGroup DEALLOCATE scCurrCustomerGroup  SET @StartDate = @loDA_StartDate SET @EndDate = @loDA_EndDate SET @Description = @loST_Description SET @poST_SchemeGroup = @loST_SchemeGroup  IF @loIN_PromType = 1 BEGIN  SELECT @poDE_Price = @loDE_Value * @loDE_EQUOMQTY  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 2 OR @loIN_PromType = 3 BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poDE_Value =  @loDE_Value  IF @loIN_PromType = 2  BEGIN  SELECT @poDE_Value =  @loDE_Value  END  ELSE  BEGIN  SELECT @poDE_Value =  @loDE_Value * @loDE_EQUOMQTY  END  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 4 BEGIN  SELECT @QuantityFree = @loDE_Value * @piDE_Qty  IF @QuantityFree <> 0  BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  SELECT @poST_SchemeGroup = @loST_SchemeGroup  END  ELSE  BEGIN  SET @poIN_PromFound = 0  END  RETURN 0 END  CurrPriceListProduct:  DECLARE scCurrPriceListProduct SCROLL CURSOR FOR  SELECT SWU.PSITMVAL,  SWU.EQUOMQTY,  SH.STRTDATE,  SH.ENDDATE,  SW.BASEUOFM,  SW.PRCSHID,  SW.EPITMTYP,  SW.PROMOLVL,  SW.PROMOTYP,  SWU.QTYFROM,  SWU.QTYTO,  SH.DESCEXPR  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10205 as PL  ON PL.PRCBKID = SL.LINKCODE  WHERE SL.PRODTCOD = 'P'  AND PL.PRODTCOD = @piST_DorP  AND PL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR = @piST_ItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @piST_Currency  AND SWU.UOFM = @piST_UofM  AND @piDE_Qty BETWEEN SWU.QTYFROM AND SWU.QTYTO  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE  OPEN scCurrPriceListProduct  FETCH FIRST FROM scCurrPriceListProduct  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scCurrPriceListProduct  DEALLOCATE scCurrPriceListProduct  GOTO CurrPriceListGroup END ELSE BEGIN  FETCH NEXT FROM scCurrPriceListProduct  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description   IF @@FETCH_STATUS = 0  BEGIN  IF @loDA_StartDate = @loDA_NextStartDate and @loDA_EndDate = @loDA_NextEndDate  BEGIN  CLOSE scCurrPriceListProduct  DEALLOCATE scCurrPriceListProduct  IF (@loIN_PricesNotReqd = 1) AND (@loIN_ConvertFunctPrice = 1)  BEGIN  GOTO FunctCurrencyRoutines  END  ELSE  BEGIN  SET @poIN_PromFound = 0  RETURN 50003  END  END  END END  FETCH FIRST FROM scCurrPriceListProduct  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  CLOSE scCurrPriceListProduct DEALLOCATE scCurrPriceListProduct  SET @StartDate = @loDA_StartDate SET @EndDate = @loDA_EndDate SET @Description = @loST_Description  IF @loIN_PromType = 1 BEGIN  SELECT @poDE_Price = @loDE_Value * @loDE_EQUOMQTY  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 2 OR @loIN_PromType = 3 BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poDE_Value =  @loDE_Value  IF @loIN_PromType = 2  BEGIN  SELECT @poDE_Value =  @loDE_Value  END  ELSE  BEGIN  SELECT @poDE_Value =  @loDE_Value * @loDE_EQUOMQTY  END  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 4 BEGIN  SELECT @QuantityFree = @loDE_Value * @piDE_Qty  IF @QuantityFree <> 0  BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  SELECT @poST_SchemeGroup = ''  END  ELSE  BEGIN  SET @poIN_PromFound = 0  END  RETURN 0 END  CurrPriceListGroup:  DECLARE scCurrPriceListGroup SCROLL CURSOR FOR  SELECT SWU.PSITMVAL,  SWU.EQUOMQTY,   SH.STRTDATE,  SH.ENDDATE,  SW.BASEUOFM,  SW.PRCSHID,  SW.EPITMTYP,  SW.ITEMNMBR,  SW.PROMOLVL,  SW.PROMOTYP,  SWU.QTYFROM,  SWU.QTYTO,  SH.DESCEXPR  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  INNER JOIN SOP10205 as PL  ON PL.PRCBKID = SL.LINKCODE  WHERE SL.PRODTCOD = 'P'  AND PL.PRODTCOD = @piST_DorP  AND PL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR = @piST_ItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @piST_Currency  AND SWU.UOFM = @piST_UofM  AND @piDE_Qty BETWEEN SWU.QTYFROM AND SWU.QTYTO  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE  OPEN scCurrPriceListGroup  FETCH FIRST FROM scCurrPriceListGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scCurrPriceListGroup  DEALLOCATE scCurrPriceListGroup  GOTO CurrBaseListProduct END ELSE BEGIN  FETCH NEXT FROM scCurrPriceListGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description   IF @@FETCH_STATUS = 0  BEGIN  IF @loDA_StartDate = @loDA_NextStartDate and @loDA_EndDate = @loDA_NextEndDate  BEGIN  CLOSE scCurrPriceListGroup  DEALLOCATE scCurrPriceListGroup  IF (@loIN_PricesNotReqd = 1) AND (@loIN_ConvertFunctPrice = 1)  BEGIN  GOTO FunctCurrencyRoutines  END  ELSE  BEGIN  SET @poIN_PromFound = 0  RETURN 50004  END  END  END END  FETCH FIRST FROM scCurrPriceListGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  CLOSE scCurrPriceListGroup DEALLOCATE scCurrPriceListGroup  SET @StartDate = @loDA_StartDate SET @EndDate = @loDA_EndDate SET @Description = @loST_Description SET @poST_SchemeGroup = @loST_SchemeGroup  IF @loIN_PromType = 1 BEGIN  SELECT @poDE_Price = @loDE_Value * @loDE_EQUOMQTY  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 2 OR @loIN_PromType = 3 BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poDE_Value =  @loDE_Value  IF @loIN_PromType = 2  BEGIN  SELECT @poDE_Value =  @loDE_Value  END  ELSE  BEGIN  SELECT @poDE_Value =  @loDE_Value * @loDE_EQUOMQTY  END  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 4 BEGIN  SELECT @QuantityFree = @loDE_Value * @piDE_Qty  IF @QuantityFree <> 0  BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  SELECT @poST_SchemeGroup = @loST_SchemeGroup  END  ELSE  BEGIN  SET @poIN_PromFound = 0  END   RETURN 0 END  CurrBaseListProduct:  DECLARE scCurrBaseListProduct SCROLL CURSOR FOR  SELECT SWU.PSITMVAL,  SWU.EQUOMQTY,  SH.STRTDATE,  SH.ENDDATE,  SW.BASEUOFM,  SW.PRCSHID,  SW.EPITMTYP,  SW.PROMOLVL,  SW.PROMOTYP,  SWU.QTYFROM,  SWU.QTYTO,  SH.DESCEXPR  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10109 as PH  ON PH.PRCBKID = SL.LINKCODE  WHERE PH.ISBASE = 1  AND SL.PRODTCOD = 'P'  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR = @piST_ItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @piST_Currency  AND SWU.UOFM = @piST_UofM  AND @piDE_Qty BETWEEN SWU.QTYFROM AND SWU.QTYTO  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE  OPEN scCurrBaseListProduct  FETCH FIRST FROM scCurrBaseListProduct  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scCurrBaseListProduct  DEALLOCATE scCurrBaseListProduct  GOTO CurrBaseListGroup END ELSE BEGIN  FETCH NEXT FROM scCurrBaseListProduct  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description   IF @@FETCH_STATUS = 0  BEGIN  IF @loDA_StartDate = @loDA_NextStartDate and @loDA_EndDate = @loDA_NextEndDate  BEGIN  CLOSE scCurrBaseListProduct  DEALLOCATE scCurrBaseListProduct  IF (@loIN_PricesNotReqd = 1) AND (@loIN_ConvertFunctPrice = 1)  BEGIN  GOTO FunctCurrencyRoutines  END  ELSE  BEGIN  SET @poIN_PromFound = 0  RETURN 50005  END  END  END END  FETCH FIRST FROM scCurrBaseListProduct  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  CLOSE scCurrBaseListProduct DEALLOCATE scCurrBaseListProduct  SET @StartDate = @loDA_StartDate SET @EndDate = @loDA_EndDate SET @Description = @loST_Description  IF @loIN_PromType = 1 BEGIN  SELECT @poDE_Price = @loDE_Value * @loDE_EQUOMQTY  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 2 OR @loIN_PromType = 3 BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poDE_Value =  @loDE_Value  IF @loIN_PromType = 2  BEGIN  SELECT @poDE_Value =  @loDE_Value  END  ELSE  BEGIN  SELECT @poDE_Value =  @loDE_Value * @loDE_EQUOMQTY  END  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 4 BEGIN  SELECT @QuantityFree = @loDE_Value * @piDE_Qty  IF @QuantityFree <> 0  BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  SELECT @poST_SchemeGroup = ''  END  ELSE  BEGIN  SET @poIN_PromFound = 0  END   RETURN 0 END  CurrBaseListGroup:  DECLARE scCurrBaseListGroup SCROLL CURSOR FOR  SELECT SWU.PSITMVAL,   SWU.EQUOMQTY,  SH.STRTDATE,  SH.ENDDATE,  SW.BASEUOFM,  SW.PRCSHID,  SW.EPITMTYP,  SW.ITEMNMBR,  SW.PROMOLVL,  SW.PROMOTYP,  SWU.QTYFROM,  SWU.QTYTO,  SH.DESCEXPR  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10109 as PH  ON PH.PRCBKID = SL.LINKCODE  INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  WHERE PH.ISBASE = 1  AND SL.PRODTCOD = 'P'  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR = @piST_ItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @piST_Currency  AND SWU.UOFM = @piST_UofM  AND @piDE_Qty BETWEEN SWU.QTYFROM AND SWU.QTYTO  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE  OPEN scCurrBaseListGroup  FETCH FIRST FROM scCurrBaseListGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scCurrBaseListGroup  DEALLOCATE scCurrBaseListGroup  GOTO FunctCurrencyRoutines END ELSE BEGIN  FETCH NEXT FROM scCurrBaseListGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description   IF @@FETCH_STATUS = 0  BEGIN  IF @loDA_StartDate = @loDA_NextStartDate and @loDA_EndDate = @loDA_NextEndDate  BEGIN  CLOSE scCurrBaseListGroup  DEALLOCATE scCurrBaseListGroup  IF (@loIN_PricesNotReqd = 1) AND (@loIN_ConvertFunctPrice = 1)  BEGIN  GOTO FunctCurrencyRoutines  END  ELSE  BEGIN  SET @poIN_PromFound = 0  RETURN 50006  END  END  END END  FETCH FIRST FROM scCurrBaseListGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  CLOSE scCurrBaseListGroup DEALLOCATE scCurrBaseListGroup  SET @StartDate = @loDA_StartDate SET @EndDate = @loDA_EndDate SET @Description = @loST_Description SET @poST_SchemeGroup = @loST_SchemeGroup  IF @loIN_PromType = 1 BEGIN  SELECT @poDE_Price = @loDE_Value * @loDE_EQUOMQTY  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 2 OR @loIN_PromType = 3 BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poDE_Value =  @loDE_Value  IF @loIN_PromType = 2  BEGIN  SELECT @poDE_Value =  @loDE_Value  END  ELSE  BEGIN  SELECT @poDE_Value =  @loDE_Value * @loDE_EQUOMQTY  END  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 4 BEGIN  SELECT @QuantityFree = @loDE_Value * @piDE_Qty  IF @QuantityFree <> 0  BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  SELECT @poST_SchemeGroup = @loST_SchemeGroup  END  ELSE  BEGIN  SET @poIN_PromFound = 0  END   RETURN 0 END  FunctCurrencyRoutines:  SET @poIN_CurrPriceFound = 0 SET @poIN_PromFound = 0  IF @piST_Currency <>  @loST_FUNLCURR BEGIN  IF @loIN_PricesNotReqd = 0  BEGIN  RETURN 0  END  ELSE  BEGIN  IF @loIN_ConvertFunctPrice = 0  BEGIN  RETURN 0  END  END END  IF @piST_Currency <>  @loST_FUNLCURR BEGIN  SELECT  @loIN_DecPlaces = DECPLCUR - 1  FROM IV00101 where ITEMNMBR = @piST_ItemNumber END  SET @poIN_PromFound = 1  IF @piST_CustomerNumber IS NULL BEGIN  GOTO BaseListProduct END  CustomerProduct:  DECLARE scCustomerProduct SCROLL CURSOR FOR  SELECT SWU.PSITMVAL,   SWU.EQUOMQTY,  SH.STRTDATE,   SH.ENDDATE,  SW.BASEUOFM,  SW.PRCSHID,  SW.EPITMTYP,  SW.PROMOLVL,  SW.PROMOTYP,  SWU.QTYFROM,  SWU.QTYTO,  SH.DESCEXPR  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  WHERE SL.PRODTCOD = @piST_DorP  AND SL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR = @piST_ItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID =@loST_FUNLCURR  AND SWU.UOFM = @piST_UofM  AND @piDE_Qty BETWEEN SWU.QTYFROM AND SWU.QTYTO  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE  OPEN scCustomerProduct  FETCH FIRST FROM scCustomerProduct  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scCustomerProduct  DEALLOCATE scCustomerProduct  GOTO CustomerGroup END ELSE BEGIN  FETCH NEXT FROM  scCustomerProduct  INTO  @loDE_Value,  @loDE_EQUOMQTY,  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description   IF @@FETCH_STATUS = 0  BEGIN  IF @loDA_StartDate = @loDA_NextStartDate and @loDA_EndDate = @loDA_NextEndDate  BEGIN  CLOSE scCustomerProduct  DEALLOCATE scCustomerProduct  SET @poIN_PromFound = 0  RETURN 50001  END  END END  FETCH FIRST FROM scCustomerProduct  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  CLOSE scCustomerProduct DEALLOCATE scCustomerProduct  SET @StartDate = @loDA_StartDate SET @EndDate = @loDA_EndDate SET @Description = @loST_Description  IF @loIN_PromType = 1 BEGIN  SELECT @poDE_Price = @loDE_Value * @loDE_EQUOMQTY  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 2 OR @loIN_PromType = 3 BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poDE_Value =  @loDE_Value  IF @loIN_PromType = 2  BEGIN  SELECT @poDE_Value =  @loDE_Value  END  ELSE  BEGIN  SELECT @poDE_Value =  @loDE_Value * @loDE_EQUOMQTY  END  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 4 BEGIN  SELECT @QuantityFree = @loDE_Value * @piDE_Qty  IF @QuantityFree <> 0  BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  SELECT @poST_SchemeGroup = ''  END  ELSE  BEGIN  SET @poIN_PromFound = 0  END   RETURN 0 END  CustomerGroup:  DECLARE scCustomerGroup SCROLL CURSOR FOR  SELECT SWU.PSITMVAL,  SWU.EQUOMQTY,  SH.STRTDATE,  SH.ENDDATE,   SW.BASEUOFM,  SW.PRCSHID,  SW.EPITMTYP,  SW.ITEMNMBR,  SW.PROMOLVL,  SW.PROMOTYP,  SWU.QTYFROM,  SWU.QTYTO,  SH.DESCEXPR  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  WHERE SL.PRODTCOD = @piST_DorP  AND SL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR = @piST_ItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @loST_FUNLCURR  AND SWU.UOFM = @piST_UofM  AND @piDE_Qty BETWEEN SWU.QTYFROM AND SWU.QTYTO  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE  OPEN scCustomerGroup  FETCH FIRST FROM scCustomerGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scCustomerGroup  DEALLOCATE scCustomerGroup  GOTO PriceListProduct END ELSE BEGIN  FETCH NEXT FROM scCustomerGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description   IF @@FETCH_STATUS = 0  BEGIN  IF @loDA_StartDate = @loDA_NextStartDate and @loDA_EndDate = @loDA_NextEndDate  BEGIN  CLOSE scCustomerGroup  DEALLOCATE scCustomerGroup  SET @poIN_PromFound = 0  RETURN 50002  END  END END  FETCH FIRST FROM scCustomerGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  CLOSE scCustomerGroup DEALLOCATE scCustomerGroup  SET @StartDate = @loDA_StartDate SET @EndDate = @loDA_EndDate SET @Description = @loST_Description SET @poST_SchemeGroup = @loST_SchemeGroup  IF @loIN_PromType = 1 BEGIN  SELECT @poDE_Price = @loDE_Value * @loDE_EQUOMQTY  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 2 OR @loIN_PromType = 3 BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poDE_Value =  @loDE_Value  IF @loIN_PromType = 2  BEGIN  SELECT @poDE_Value =  @loDE_Value  END  ELSE  BEGIN  SELECT @poDE_Value =  @loDE_Value * @loDE_EQUOMQTY  END  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 4 BEGIN  SELECT @QuantityFree = @loDE_Value * @piDE_Qty  IF @QuantityFree <> 0  BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  SELECT @poST_SchemeGroup = @loST_SchemeGroup  END  ELSE  BEGIN  SET @poIN_PromFound = 0  END   RETURN 0 END  PriceListProduct:  DECLARE scPriceListProduct SCROLL CURSOR FOR  SELECT SWU.PSITMVAL,  SWU.EQUOMQTY,  SH.STRTDATE,  SH.ENDDATE,  SW.BASEUOFM,  SW.PRCSHID,  SW.EPITMTYP,  SW.PROMOLVL,  SW.PROMOTYP,  SWU.QTYFROM,  SWU.QTYTO,  SH.DESCEXPR  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10205 as PL  ON PL.PRCBKID = SL.LINKCODE  WHERE SL.PRODTCOD = 'P'  AND PL.PRODTCOD = @piST_DorP  AND PL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR = @piST_ItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @loST_FUNLCURR  AND SWU.UOFM = @piST_UofM  AND @piDE_Qty BETWEEN SWU.QTYFROM AND SWU.QTYTO  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE  OPEN scPriceListProduct  FETCH FIRST FROM scPriceListProduct  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scPriceListProduct  DEALLOCATE scPriceListProduct  GOTO PriceListGroup END ELSE BEGIN  FETCH NEXT FROM scPriceListProduct  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description   IF @@FETCH_STATUS = 0  BEGIN  IF @loDA_StartDate = @loDA_NextStartDate and @loDA_EndDate = @loDA_NextEndDate  BEGIN  CLOSE scPriceListProduct  DEALLOCATE scPriceListProduct  SET @poIN_PromFound = 0  RETURN 50003  END  END END  FETCH FIRST FROM scPriceListProduct  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  CLOSE scPriceListProduct DEALLOCATE scPriceListProduct  SET @StartDate = @loDA_StartDate SET @EndDate = @loDA_EndDate SET @Description = @loST_Description  IF @loIN_PromType = 1 BEGIN  SELECT @poDE_Price = @loDE_Value * @loDE_EQUOMQTY  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 2 OR @loIN_PromType = 3 BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poDE_Value =  @loDE_Value  IF @loIN_PromType = 2  BEGIN  SELECT @poDE_Value =  @loDE_Value  END  ELSE  BEGIN  SELECT @poDE_Value =  @loDE_Value * @loDE_EQUOMQTY  END  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 4 BEGIN  SELECT @QuantityFree = @loDE_Value * @piDE_Qty  IF @QuantityFree <> 0  BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  SELECT @poST_SchemeGroup = ''  END  ELSE  BEGIN  SET @poIN_PromFound = 0  END   RETURN 0 END  PriceListGroup:  DECLARE scPriceListGroup SCROLL CURSOR FOR  SELECT SWU.PSITMVAL,  SWU.EQUOMQTY,   SH.STRTDATE,  SH.ENDDATE,  SW.BASEUOFM,  SW.PRCSHID,  SW.EPITMTYP,  SW.ITEMNMBR,  SW.PROMOLVL,  SW.PROMOTYP,  SWU.QTYFROM,  SWU.QTYTO,  SH.DESCEXPR  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  INNER JOIN SOP10205 as PL  ON PL.PRCBKID = SL.LINKCODE  WHERE SL.PRODTCOD = 'P'  AND PL.PRODTCOD = @piST_DorP  AND PL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR = @piST_ItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @loST_FUNLCURR  AND SWU.UOFM = @piST_UofM  AND @piDE_Qty BETWEEN SWU.QTYFROM AND SWU.QTYTO  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE  OPEN scPriceListGroup  FETCH FIRST FROM scPriceListGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scPriceListGroup  DEALLOCATE scPriceListGroup  GOTO BaseListProduct END ELSE BEGIN  FETCH NEXT FROM scPriceListGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description   IF @@FETCH_STATUS = 0  BEGIN  IF @loDA_StartDate = @loDA_NextStartDate and @loDA_EndDate = @loDA_NextEndDate  BEGIN  CLOSE scPriceListGroup  DEALLOCATE scPriceListGroup  SET @poIN_PromFound = 0  RETURN 50004  END  END END  FETCH FIRST FROM scPriceListGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  CLOSE scPriceListGroup DEALLOCATE scPriceListGroup  SET @StartDate = @loDA_StartDate SET @EndDate = @loDA_EndDate SET @Description = @loST_Description SET @poST_SchemeGroup = @loST_SchemeGroup  IF @loIN_PromType = 1 BEGIN  SELECT @poDE_Price = @loDE_Value * @loDE_EQUOMQTY  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 2 OR @loIN_PromType = 3 BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poDE_Value =  @loDE_Value  IF @loIN_PromType = 2  BEGIN  SELECT @poDE_Value =  @loDE_Value  END  ELSE  BEGIN  SELECT @poDE_Value =  @loDE_Value * @loDE_EQUOMQTY  END  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 4 BEGIN  SELECT @QuantityFree = @loDE_Value * @piDE_Qty  IF @QuantityFree <> 0  BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  SELECT @poST_SchemeGroup = @loST_SchemeGroup  END  ELSE  BEGIN  SET @poIN_PromFound = 0  END   RETURN 0 END  BaseListProduct:  DECLARE scBaseListProduct SCROLL CURSOR FOR  SELECT SWU.PSITMVAL,  SWU.EQUOMQTY,  SH.STRTDATE,  SH.ENDDATE,  SW.BASEUOFM,  SW.PRCSHID,  SW.EPITMTYP,  SW.PROMOLVL,  SW.PROMOTYP,  SWU.QTYFROM,  SWU.QTYTO,  SH.DESCEXPR  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10109 as PH  ON PH.PRCBKID = SL.LINKCODE  WHERE PH.ISBASE = 1  AND SL.PRODTCOD = 'P'  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR = @piST_ItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @loST_FUNLCURR  AND SWU.UOFM = @piST_UofM  AND @piDE_Qty BETWEEN SWU.QTYFROM AND SWU.QTYTO  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE  OPEN scBaseListProduct  FETCH FIRST FROM scBaseListProduct  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scBaseListProduct  DEALLOCATE scBaseListProduct  GOTO BaseListGroup END ELSE BEGIN  FETCH NEXT FROM scBaseListProduct  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description   IF @@FETCH_STATUS = 0  BEGIN  IF @loDA_StartDate = @loDA_NextStartDate and @loDA_EndDate = @loDA_NextEndDate  BEGIN  CLOSE scBaseListProduct  DEALLOCATE scBaseListProduct  SET @poIN_PromFound = 0  RETURN 50005  END  END END  FETCH FIRST FROM scBaseListProduct  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  CLOSE scBaseListProduct DEALLOCATE scBaseListProduct  SET @StartDate = @loDA_StartDate SET @EndDate = @loDA_EndDate SET @Description = @loST_Description  IF @loIN_PromType = 1 BEGIN  SELECT @poDE_Price = @loDE_Value * @loDE_EQUOMQTY  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 2 OR @loIN_PromType = 3 BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poDE_Value =  @loDE_Value  IF @loIN_PromType = 2  BEGIN  SELECT @poDE_Value =  @loDE_Value  END  ELSE  BEGIN  SELECT @poDE_Value =  @loDE_Value * @loDE_EQUOMQTY  END  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 4 BEGIN  SELECT @QuantityFree = @loDE_Value * @piDE_Qty  IF @QuantityFree <> 0  BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  SELECT @poST_SchemeGroup = ''  END  ELSE  BEGIN  SET @poIN_PromFound = 0  END   RETURN 0 END  BaseListGroup:  DECLARE scBaseListGroup SCROLL CURSOR FOR  SELECT SWU.PSITMVAL,   SWU.EQUOMQTY,  SH.STRTDATE,  SH.ENDDATE,  SW.BASEUOFM,  SW.PRCSHID,  SW.EPITMTYP,  SW.ITEMNMBR,  SW.PROMOLVL,  SW.PROMOTYP,  SWU.QTYFROM,  SWU.QTYTO,  SH.DESCEXPR  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10109 as PH  ON PH.PRCBKID = SL.LINKCODE  INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  WHERE PH.ISBASE = 1  AND SL.PRODTCOD = 'P'  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR = @piST_ItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @loST_FUNLCURR  AND SWU.UOFM = @piST_UofM  AND @piDE_Qty BETWEEN SWU.QTYFROM AND SWU.QTYTO  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE  OPEN scBaseListGroup  FETCH FIRST FROM scBaseListGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scBaseListGroup  DEALLOCATE scBaseListGroup  SET @poIN_PromFound = 0  RETURN 0 END ELSE BEGIN  FETCH NEXT FROM scBaseListGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description   IF @@FETCH_STATUS = 0  BEGIN  IF @loDA_StartDate = @loDA_NextStartDate and @loDA_EndDate = @loDA_NextEndDate  BEGIN  CLOSE scBaseListGroup  DEALLOCATE scBaseListGroup  SET @poIN_PromFound = 0  RETURN 50006  END  END END  FETCH FIRST FROM scBaseListGroup  INTO @loDE_Value,  @loDE_EQUOMQTY,  @loDA_StartDate,  @loDA_EndDate,  @loST_BaseUofM,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_SchemeGroup,  @loIN_PromLevel,  @loIN_PromType,  @loDE_QtyFrom,  @loDE_QtyTo,  @loST_Description  CLOSE scBaseListGroup DEALLOCATE scBaseListGroup  SET @StartDate = @loDA_StartDate SET @EndDate = @loDA_EndDate SET @Description = @loST_Description SET @poST_SchemeGroup = @loST_SchemeGroup  IF @loIN_PromType = 1 BEGIN  SELECT @poDE_Price = @loDE_Value * @loDE_EQUOMQTY  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 2 OR @loIN_PromType = 3 BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poDE_Value =  @loDE_Value  IF @loIN_PromType = 2  BEGIN  SELECT @poDE_Value =  @loDE_Value  END  ELSE  BEGIN  SELECT @poDE_Value =  @loDE_Value * @loDE_EQUOMQTY  END  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  RETURN 0 END IF @loIN_PromType = 4 BEGIN  SELECT @QuantityFree = @loDE_Value * @piDE_Qty  IF @QuantityFree <> 0  BEGIN  SELECT @poIN_PromType = @loIN_PromType  SELECT @poIN_PromLevel = @loIN_PromLevel  SELECT @poST_SchemeCode = @loST_SchemeCode  SELECT @poST_SchemeItemType = @loST_SchemeItemType  SELECT @poDE_QtyFrom = @loDE_QtyFrom  SELECT  @poDE_QtyTo = @loDE_QtyTo  SELECT @poST_SchemeGroup = @loST_SchemeGroup  END  ELSE  BEGIN  SET @poIN_PromFound = 0  END   RETURN 0 END  SET @poIN_PromFound = 0 RETURN 0    
GO
GRANT EXECUTE ON  [dbo].[ExtPricingGetPromoPrice] TO [DYNGRP]
GO
