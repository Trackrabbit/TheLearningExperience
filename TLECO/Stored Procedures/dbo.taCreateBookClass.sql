SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[taCreateBookClass] @I_vBOOKID char(15),    @I_vASSETCLASSID char(15),   @I_vDEPRECIATIONMETHOD smallint,    @I_vAVERAGINGCONV smallint,    @I_vAMORTIZATIONCODE smallint = 0,   @I_vAMORTIZATIONAMOUNT  numeric(19,5) = 0,  @I_vSWITCHOVER smallint = 1,   @I_vORIGINALLIFEYEARS smallint = 0,   @I_vORIGINALLIFEDAYS smallint = 0,   @I_vInitial_Allowance_Perc smallint = 0,  @I_vSPECDEPRALLOW smallint = 1,   @I_vSPECDEPRALLOWPCT smallint = 0,   @I_vSALVAGEPCT numeric(19,5) = 0,  @I_vSALVAGEEST tinyint = 0,   @I_vLUXAUTOIND smallint = 1,   @I_vTEFRAFLAG smallint = 1,   @I_vUSRDEFND1   char(50) = '',       @I_vUSRDEFND2   char(50) = '',       @I_vUSRDEFND3   char(50) = '',       @I_vUSRDEFND4   varchar(8000) = '',  @I_vUSRDEFND5   varchar(8000) = '',  @O_iErrorState   int output,   @oErrString   varchar(255) output   with encryption as  set transaction isolation level read uncommitted set nocount on  declare   @BOOKCLASSINDX int,    @NOTEINDX numeric(19,5),  @CMPANYID smallint,  @iGetNextNoteIdxErrState int,  @iAddCodeErrState int,    @O_iNumErrorState int,  @iStatus int,  @iCustomState int,  @iCustomErrString varchar(255),  @O_oErrorState int,  @iError int     select  @BOOKCLASSINDX = 0,    @CMPANYID = 0,  @iStatus = 0,  @O_iErrorState = 0    if (@oErrString is NULL) begin  select @oErrString = '' end  exec @iStatus = taCreateBookClassPre  @I_vBOOKID output,  @I_vASSETCLASSID output,  @I_vDEPRECIATIONMETHOD output,  @I_vAVERAGINGCONV output,  @I_vAMORTIZATIONCODE output,  @I_vAMORTIZATIONAMOUNT output,  @I_vSWITCHOVER output,  @I_vORIGINALLIFEYEARS output,  @I_vORIGINALLIFEDAYS output,  @I_vInitial_Allowance_Perc output,  @I_vSPECDEPRALLOW output,  @I_vSPECDEPRALLOWPCT output,  @I_vSALVAGEPCT output,  @I_vSALVAGEEST output,  @I_vLUXAUTOIND output,  @I_vTEFRAFLAG output,  @I_vUSRDEFND1 output,  @I_vUSRDEFND2 output,  @I_vUSRDEFND3 output,  @I_vUSRDEFND4 output,  @I_vUSRDEFND5 output,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if @iStatus = 0 and @iError <> 0 begin  select @iStatus = @iError end if (@iStatus <> 0) or (@iCustomState <> 0) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  select @O_iErrorState = 3175    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if(  @I_vBOOKID is NULL or   @I_vASSETCLASSID is NULL or  @I_vDEPRECIATIONMETHOD is NULL or  @I_vAVERAGINGCONV is NULL or  @I_vAMORTIZATIONCODE is NULL or  @I_vAMORTIZATIONAMOUNT is NULL or  @I_vSWITCHOVER is NULL or  @I_vORIGINALLIFEYEARS is NULL or  @I_vORIGINALLIFEDAYS is NULL or  @I_vInitial_Allowance_Perc is NULL or  @I_vSPECDEPRALLOW is NULL or  @I_vSPECDEPRALLOWPCT is NULL or  @I_vSALVAGEPCT is NULL or  @I_vSALVAGEEST is NULL or  @I_vLUXAUTOIND is NULL or  @I_vTEFRAFLAG is NULL or  @I_vUSRDEFND1 is NULL or  @I_vUSRDEFND2 is NULL or  @I_vUSRDEFND3 is NULL or  @I_vUSRDEFND4 is NULL or  @I_vUSRDEFND5 is NULL   ) begin  select @O_iErrorState = 3176    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  select  @I_vBOOKID = UPPER(@I_vBOOKID),  @I_vASSETCLASSID = UPPER(@I_vASSETCLASSID)  select @CMPANYID = CMPANYID from DYNAMICS..SY01500 (nolock) where INTERID = db_name()  if (@BOOKCLASSINDX = 0)   begin  exec @iStatus = taGetBookClassIndex  @I_tInc_Dec = 1,   @O_vBookClassIndex = @BOOKCLASSINDX output,  @O_iErrorState = @O_iNumErrorState output  select @iError = @@error  if ((@iStatus <> 0) or (@O_iNumErrorState <> 0) or (@iError <> 0))  begin  select @O_iErrorState = 9157   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end  exec @iStatus = DYNAMICS..tasmGetNextNoteIndex  @I_sCompanyID   = @CMPANYID,  @I_iSQLSessionID = 0,  @I_noteincrement  = 1,  @O_mNoteIndex   = @NOTEINDX output,  @O_iErrorState  = @iGetNextNoteIdxErrState output select @iError = @@error if @iStatus = 0 and @iError <> 0 begin  select @iStatus = @iError end if (@iStatus <> 0) or (@iGetNextNoteIdxErrState <> 0) begin  if (@iGetNextNoteIdxErrState <> 0)  begin  exec @iStatus = taUpdateString  @iGetNextNoteIdxErrState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  select @O_iErrorState = 3177   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vBOOKID = '' ) begin  select @O_iErrorState = 3178    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output end  if  ( @I_vBOOKID <> '' ) begin  if (not exists(select 1 from FA40200 (nolock) where BOOKID = @I_vBOOKID))  begin  select @O_iErrorState = 3179    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if  ( @I_vASSETCLASSID = '' ) begin  select @O_iErrorState = 3180    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output end  if  ( @I_vASSETCLASSID <> '' ) begin  if (not exists(select 1 from FA40201 (nolock) where ASSETCLASSID = @I_vASSETCLASSID))  begin  select @O_iErrorState = 3181    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if  ( @I_vDEPRECIATIONMETHOD < 1 or @I_vDEPRECIATIONMETHOD > 16 ) begin  select @O_iErrorState = 3182    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vAVERAGINGCONV < 1 or @I_vAVERAGINGCONV > 13 ) begin  select @O_iErrorState = 3183    exec @iStatus = taUpdateString   @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vSWITCHOVER < 1 or @I_vSWITCHOVER > 2 ) begin  select @O_iErrorState = 3184     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vORIGINALLIFEYEARS < 0 or @I_vORIGINALLIFEYEARS > 99 ) begin  select @O_iErrorState = 3185     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vORIGINALLIFEDAYS < 0 or @I_vORIGINALLIFEDAYS > 999 ) begin  select @O_iErrorState = 3186     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vSPECDEPRALLOW < 1 or @I_vSPECDEPRALLOW > 2 ) begin  select @O_iErrorState = 3187     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vSALVAGEPCT < 0 or @I_vSALVAGEPCT > 327.67 ) begin  select @O_iErrorState = 3188     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vSALVAGEEST < 0 or @I_vSALVAGEEST > 1 ) begin  select @O_iErrorState = 3189     exec @iStatus = taUpdateString   @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vLUXAUTOIND < 1 or @I_vLUXAUTOIND > 2 ) begin  select @O_iErrorState = 3190     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vTEFRAFLAG < 1 or @I_vTEFRAFLAG > 4 ) begin  select @O_iErrorState = 3191     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vDEPRECIATIONMETHOD not in (9,16)) and ( @I_vAMORTIZATIONCODE <> 0 ) begin  select @O_iErrorState = 3192     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vDEPRECIATIONMETHOD not in (9,16)) and ( @I_vAMORTIZATIONAMOUNT <> 0 ) begin  select @O_iErrorState = 3193     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vDEPRECIATIONMETHOD <> 16 ) and ( @I_vInitial_Allowance_Perc <> 0 ) begin  select @O_iErrorState = 3194     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vDEPRECIATIONMETHOD = 16 ) and ( @I_vAMORTIZATIONCODE <> 6 ) begin  select @O_iErrorState = 3195     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vDEPRECIATIONMETHOD = 9 ) and ( @I_vAMORTIZATIONCODE <= 0  or @I_vAMORTIZATIONCODE > 7) begin  select @O_iErrorState = 3196     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vDEPRECIATIONMETHOD = 9 ) and ( @I_vAMORTIZATIONAMOUNT = 0 ) begin  select @O_iErrorState = 3197     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vAMORTIZATIONCODE = 6 or @I_vAMORTIZATIONCODE = 7 ) and ( @I_vAMORTIZATIONAMOUNT <= 0 or @I_vAMORTIZATIONAMOUNT > 100 ) begin  select @O_iErrorState = 3198     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vSALVAGEPCT < 0 ) begin  select @O_iErrorState = 3199     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vInitial_Allowance_Perc < 0 ) begin  select @O_iErrorState = 3200     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vAMORTIZATIONAMOUNT < 0 ) begin  select @O_iErrorState = 3201     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vSALVAGEPCT > 327.67 ) begin  select @O_iErrorState = 3202     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vInitial_Allowance_Perc > 32767 ) begin  select @O_iErrorState = 3203     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vAMORTIZATIONAMOUNT > 32767 ) begin  select @O_iErrorState = 3204     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if  ( @I_vSPECDEPRALLOWPCT < 0 or @I_vSPECDEPRALLOWPCT > 100 ) begin  select @O_iErrorState = 3205     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@O_iErrorState = 0) begin  if not exists( select 1 from FA40202 (nolock) where  BOOKID = @I_vBOOKID and ASSETCLASSID = @I_vASSETCLASSID )  begin  insert into FA40202 ( BOOKCLASSINDX,  BOOKID,  ASSETCLASSID,  EFFECTDATEBEGIN,  EFFECTDATEEND,  DEPRECIATIONMETHOD,  AVERAGINGCONV,  AMORTIZATIONCODE,  AMORTIZATIONAMOUNT,  ORIGINALLIFEYEARS,  ORIGINALLIFEDAYS,  SWITCHOVER,  SALVAGEEST,  SALVAGEPCT,  TEFRAFLAG,  LUXAUTOIND,  Initial_Allowance_Perc,  SPECDEPRALLOW,  SPECDEPRALLOWPCT,  NOTEINDX,  LASTMNTDDATE,  LASTMNTDTIME,  LASTMNTDUSERID  )  select   @BOOKCLASSINDX,      @I_vBOOKID,      @I_vASSETCLASSID,     '',       '',       @I_vDEPRECIATIONMETHOD,     @I_vAVERAGINGCONV,     @I_vAMORTIZATIONCODE,     @I_vAMORTIZATIONAMOUNT,     @I_vORIGINALLIFEYEARS,     @I_vORIGINALLIFEDAYS,     @I_vSWITCHOVER,      @I_vSALVAGEEST,      @I_vSALVAGEPCT * 100,     @I_vTEFRAFLAG,      @I_vLUXAUTOIND,      @I_vInitial_Allowance_Perc * 100,   @I_vSPECDEPRALLOW,     @I_vSPECDEPRALLOWPCT * 100,    @NOTEINDX,      convert(varchar(12),getdate()),    '',       'eConnect'      if @@error <> 0  begin  select @O_iErrorState = 3206    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end  end  else  begin  select @O_iErrorState = 3207    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end  if (@O_iErrorState <> 0)  return (@O_iErrorState)  exec @iStatus = taCreateBookClassPost  @I_vBOOKID,  @I_vASSETCLASSID,  @I_vDEPRECIATIONMETHOD,  @I_vAVERAGINGCONV,  @I_vAMORTIZATIONCODE,  @I_vAMORTIZATIONAMOUNT,  @I_vSWITCHOVER,  @I_vORIGINALLIFEYEARS,  @I_vORIGINALLIFEDAYS,  @I_vInitial_Allowance_Perc,  @I_vSPECDEPRALLOW,  @I_vSPECDEPRALLOWPCT,  @I_vSALVAGEPCT,  @I_vSALVAGEEST,  @I_vLUXAUTOIND,  @I_vTEFRAFLAG,  @I_vUSRDEFND1,  @I_vUSRDEFND2,  @I_vUSRDEFND3,  @I_vUSRDEFND4,  @I_vUSRDEFND5,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if @iStatus = 0 and @iError <> 0 begin  select @iStatus = @iError end if (@iStatus <> 0) or (@iCustomState <> 0) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  select @O_iErrorState = 3208    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  return (@O_iErrorState)   
GO
GRANT EXECUTE ON  [dbo].[taCreateBookClass] TO [DYNGRP]
GO
