SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_Contract_Line_ReSequence] ( @ContractNumber char(11),  @ContractType integer) AS declare @NewSeq numeric(19,5) declare @MaxNumber numeric(19,5) declare @MinNumber numeric(19,5) declare @LineNumber numeric(19,5) declare @LineCount integer declare @asc tinyint alter table SVC00601 disable trigger all  select @MaxNumber = Max(LNSEQNBR),@MinNumber = Min(LNSEQNBR),@LineCount = COUNT(*)  from SVC00601 where CONSTS=@ContractType and CONTNBR = @ContractNumber select @NewSeq = (@LineCount * 100.0)   if @MinNumber > @NewSeq +100.0  begin  select @NewSeq = 100.0  end  else  begin  if @MaxNumber >= @NewSeq  select @NewSeq = @MaxNumber +100.0  end declare Cont_seq cursor for select LNSEQNBR from SVC00601 where CONSTS=@ContractType and CONTNBR = @ContractNumber order by LNSEQNBR ASC BEGIN TRANSACTION  open Cont_seq   fetch next from Cont_seq into @LineNumber   while @@FETCH_STATUS = 0 and @LineCount <> 0  BEGIN  update SVC00603 set LNSEQNBR = @NewSeq where CONSTS = @ContractType and CONTNBR = @ContractNumber and LNSEQNBR = @LineNumber  if @@error <> 0 goto badentry  update SVC00604 set LNSEQNBR = @NewSeq where CONSTS = @ContractType and CONTNBR = @ContractNumber and LNSEQNBR = @LineNumber  if @@error <> 0 goto badentry  update SVC00606 set LNSEQNBR = @NewSeq where CONSTS = @ContractType and CONTNBR = @ContractNumber and LNSEQNBR = @LineNumber  if @@error <> 0 goto badentry  update SVC00607 set LNSEQNBR = @NewSeq where CONSTS = @ContractType and CONTNBR = @ContractNumber and LNSEQNBR = @LineNumber  if @@error <> 0 goto badentry  update SVC00609 set LNSEQNBR = @NewSeq where CONSTS = @ContractType and CONTNBR = @ContractNumber and LNSEQNBR = @LineNumber  if @@error <> 0 goto badentry  update SVC00610 set LNSEQNBR = @NewSeq where CONSTS = @ContractType and CONTNBR = @ContractNumber and LNSEQNBR = @LineNumber  if @@error <> 0 goto badentry  update SVC00620 set SVC_Contract_Line_SEQ = @NewSeq where CONSTS = @ContractType and CONTNBR = @ContractNumber and SVC_Contract_Line_SEQ = @LineNumber  if @@error <> 0 goto badentry  update SVC00652 set LNSEQNBR = @NewSeq where CONSTS = @ContractType and CONTNBR = @ContractNumber and LNSEQNBR = @LineNumber  if @@error <> 0 goto badentry  update SVC00350 set LNSEQNBR = @NewSeq where CONTNBR = @ContractNumber and LNSEQNBR = @LineNumber  if @@error <> 0 goto badentry  update SVC00200 set SVC_Contract_Line_SEQ = @NewSeq where CONSTS = @ContractType and CONTNBR = @ContractNumber and SVC_Contract_Line_SEQ = @LineNumber  if @@error <> 0 goto badentry  update SVC00601 set LNSEQNBR = @NewSeq where CONSTS = @ContractType and CONTNBR = @ContractNumber and LNSEQNBR = @LineNumber  if @@error <> 0 goto badentry  select @NewSeq = @NewSeq + 100.0  select @LineCount = @LineCount - 1  fetch next from Cont_seq into @LineNumber   END COMMIT TRANSACTION deallocate Cont_seq  alter table SVC00601 enable trigger all  return(0) badentry:  rollback transaction  deallocate Cont_seq  alter table SVC00601 enable trigger all  return(99)    
GO
GRANT EXECUTE ON  [dbo].[SVC_Contract_Line_ReSequence] TO [DYNGRP]
GO
