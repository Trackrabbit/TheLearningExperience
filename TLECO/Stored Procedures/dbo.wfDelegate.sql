SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[wfDelegate]  @ChangedDocument tinyint,  @WorkflowStepInstanceID char(37),  @Workflow_User char(85),  @Delegated_Users char(37),  @Workflow_Comments char(500),  @TempFilePath nvarchar(300) = '',  @Workflow_Error int OUTPUT AS  BEGIN   declare @WorkflowInstanceID char(37), @Workflow_Step_Assign_To char(37)  declare @Workflow_Step_Name char(51), @Workflow_Name char(51)  declare @Workflow_Version int  declare @DueDate datetime, @DueTime datetime,  @Workflow_Completion_Date datetime, @Workflow_Completion_Time datetime  declare @Delegate_User char(85), @display_name char(85)  declare @assignment_status tinyint  declare @calculate_due_date tinyint, @approval_tasks_created tinyint  declare @CMPANYID smallint, @server_name nvarchar(128), @SystemDB nvarchar(6)   declare @WFIncludeDocumentAttach tinyint  declare @Workflow_Type_Name char(51)  declare @WfBusObjKey varchar(201)   select @WorkflowStepInstanceID=UPPER(@WorkflowStepInstanceID)  select @Delegated_Users=UPPER(@Delegated_Users)  select @Workflow_User=UPPER(@Workflow_User)   select TOP 1 @WorkflowInstanceID=WorkflowInstanceID, @Workflow_Step_Name=Workflow_Step_Name,  @Workflow_Name=Workflow_Name,@Workflow_Version=Workflow_Version,  @DueDate=Workflow_Due_Date, @DueTime=Workflow_Due_Time  from WFI10004 with (nolock, index=AK2WFI10004)   where WorkflowStepInstanceID=@WorkflowStepInstanceID    select @Workflow_Completion_Date=cast(SYSDATETIME() as date),@Workflow_Completion_Time=cast(SYSDATETIME() as time)   select @display_name = (select isnull((select top 1 ADDisplayName from WF40200 where UsersListGuid=@Delegated_Users),''))  select @Workflow_Comments='Delegated to: '+rtrim(@display_name)+'. '+@Workflow_Comments  select @Workflow_Step_Assign_To = Workflow_Step_Assign_To from WFI10003 where WorkflowStepInstanceID=@WorkflowStepInstanceID  exec wfCreateHistoryRecord @WorkflowInstanceID,  @WorkflowStepInstanceID,  @Workflow_User,  @Workflow_Name,  @Workflow_Step_Name,  @Delegated_Users,  6,  @DueDate,  @DueTime,  @Workflow_Completion_Date,  @Workflow_Completion_Time,  @Workflow_Comments,  @Workflow_Error OUTPUT   select @WFIncludeDocumentAttach = WFIncludeDocumentAttach from WF100003  where Workflow_Name = @Workflow_Name and Workflow_Step_Name = @Workflow_Step_Name   if @WFIncludeDocumentAttach = 1   begin  select @WfBusObjKey = WF2.WfBusObjKey,@Workflow_Type_Name= WF2.Workflow_Type_Name from WFI10002 WF2 inner join WFI10003 WFI3 on WF2.WorkflowInstanceID = WFI3.WorkflowInstanceID   where WFI3.WorkflowStepInstanceID = @WorkflowStepInstanceID  exec wfDocAttach @Workflow_Type_Name, @WfBusObjKey, @WorkflowStepInstanceID  end    exec wfAssignTasks @WorkflowStepInstanceID, @Delegated_Users, @Workflow_User, @calculate_due_date, 0, @TempFilePath,  @assignment_status OUTPUT, @approval_tasks_created OUTPUT   if @assignment_status = 0  begin  if @WFIncludeDocumentAttach = 1  insert into CO00104 select BusObjKey,Attachment_ID,'Workflow Message',CONVERT (date, SYSDATETIME()),  CONVERT (time, SYSDATETIME()),CRUSRID from CO00102 where WorkflowStepInstanceID = @WorkflowStepInstanceID  end    if (select count(WorkflowStepInstanceID) from WFI10004 where WorkflowStepInstanceID=@WorkflowStepInstanceID)>1  begin  delete from WFI10004 where WorkflowStepInstanceID=@WorkflowStepInstanceID and UPPER(WorkflowTaskAssignedTo)=@Workflow_User  end   if @assignment_status>0 and @assignment_status<>3   begin  select @Workflow_User='System'  select @Workflow_Comments='The workflow was automatically rejected by the system.  Alternate final approval was required, but no approver was found.'  exec wfReject @WorkflowStepInstanceID,@Workflow_User,1,@Workflow_Comments,@Workflow_Error OUTPUT  end END   
GO
GRANT EXECUTE ON  [dbo].[wfDelegate] TO [DYNGRP]
GO
