SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
create procedure [dbo].[ncMatchAccountToTemplate] 	@I_iAccountIndex int = NULL, 	@O_cSrcAccount char(129) = NULL output, 	@O_cSrcICAccount char(129) = NULL output, 	@O_cDestAccount char(129) = NULL output, 	@O_cDestICAccount char(129) = NULL output, 	@O_cDestCompany char(10) = NULL output, 	@O_iCopyMDA int = NULL output, 	@O_iReverseMDA int = NULL output, 	@O_iFoundOne int = NULL output, 	@O_iRemoteDest int = NULL output, 	@O_iErrorState int = NULL output as declare 	@iError int, 	@iStatus int, 	@tLoop tinyint, 	@tTransaction tinyint, 	@cStatement char(255), 	@cTemplate char(129), 	@cTemplateSQL char(129),	/* PJB, 10/04/06 */ 	@cSrcTemplate char(129), 	@cSrcICTemplate char(129), 	@cDestTemplate char(129), 	@cDestICTemplate char(129), 	@cTemplateAccount char(129), 	@cDestCompany char(10), 	@iExists int, 	/* Start of modifications - 09/03/05 - pjsparrow */ 	@iCompanyID int, 	/* End of modifications - 09/03/05 - pjsparrow */ 	@iINTRAcompany int,	/* 24/02/06 - pboniface */ 	/* Start of modifications - 29/06/06 - pjsparrow */ 	@tAccountType tinyint 	/* End of modifications - 29/06/06 - pjsparrow */ set nocount on select 	@O_iErrorState = 0, 	@iStatus = 0 /* IB - 20/06/06, Added Intercompany Log table */ exec dbo.ncWriteInterLog 'ncMatchAccountToTemplate started' if (select NC_Process_Templates from NCIC3000)=0 return  if @@trancount = 0 begin 	select @tTransaction = 1 	begin transaction end while (@tLoop is NULL) begin 	select @tLoop = 1 	if @I_iAccountIndex = NULL 	begin 		select @O_iErrorState = 20030 		break 	end 	 	/* Start of modifications - 29/06/06 - pjsparrow */ 	select @tAccountType = ACCTTYPE from GL00100 					where ACTINDX = @I_iAccountIndex 	 	/* Following was the original command*/ 	/* 	if (@tAccountType = 2) or (@tAccountType = 4) 		break  */ 	/* Original Command over*/ 	/* start of modifications prasad */ 	if (@tAccountType = 2) or (@tAccountType = 4) /* These are unit accounts. */ 	begin 		if (select top 1 options_1 from ncic3025) = 0 break 	end 	/* end of moidfications prasad */ 	/* End of modifications - 29/06/06 - pjsparrow */ 	select @O_iFoundOne = 0, @O_iRemoteDest = 0 	select @cTemplateAccount = ACTNUMST from GL00105 where ACTINDX = @I_iAccountIndex 	/* PJB, 22/07/2003, Updated to handle BOTH wildcards */ 	/* PJB, 10/04/2006, And again, to handle them correctly */ 	declare TemplateCursor 		cursor for select REPLACE(REPLACE(NCTPTrigASTR,'?','_'),'*','_'), 				NCTPTrigASTR, 				NCTPSACCS, 				NCTPSICASTR, 				INTERID, 				NCTPDASTR, 				NCTPDICASTR, 				CMPANYID, 				NC_Copy_MDA_CB, NC_Reverse_MDA_CB from NCIC1500 	/* old cursor ... 		cursor for select REPLACE(REPLACE(NCTPTrigASTR,'?','_'),'*','_'), 				  REPLACE(REPLACE(NCTPSACCS,'?','_'),'*','_'), 				  REPLACE(REPLACE(NCTPSICASTR,'?','_'),'*','_'), 				  INTERID, 				  REPLACE(REPLACE(NCTPDASTR,'?','_'),'*','_'), 				  REPLACE(REPLACE(NCTPDICASTR,'?','_'),'*','_'), 				  CMPANYID, 				  NC_Copy_MDA_CB, NC_Reverse_MDA_CB from NCIC1500	 	... */ 	open TemplateCursor 	fetch next from TemplateCursor into @cTemplateSQL, /* PJB, 10/04/2006, pick up SQL mask and actual masks separately */ 			@cTemplate, @cSrcTemplate, @cSrcICTemplate, 			@O_cDestCompany, @cDestTemplate, @cDestICTemplate, 			@iCompanyID, 			@O_iCopyMDA, @O_iReverseMDA 	while ((@@fetch_status <> -1) and (@O_iFoundOne = 0)) 	begin 		if exists( select 1 from GL00105 where ACTNUMST like RTRIM(@cTemplateSQL)	/* PJB */ 				     and ACTNUMST = RTRIM(@cTemplateAccount) ) 		begin 			/* found a template matching the account - see if derived accounts are valid */ 			/* built src company accounts */ 			exec @iStatus = ncBuildAccountString 				@cSrcTemplate, 				@cTemplate, 				@cTemplateAccount, 				@O_cSrcAccount output, 				@O_iErrorState output 	 			/* if the above stored proc failed, bail out */ 			select @iError = @@error 			if @iStatus = 0 and @iError <> 0 				select @iStatus = @iError 			if @iStatus <> 0 or @O_iErrorState <> 0 				break 				 			exec @iStatus = ncBuildAccountString 				@cSrcICTemplate, 				@cTemplate, 				@cTemplateAccount, 				@O_cSrcICAccount output, 				@O_iErrorState output 	 			/* if the above stored proc failed, bail out */ 			select @iError = @@error 			if @iStatus = 0 and @iError <> 0 				select @iStatus = @iError 			if @iStatus <> 0 or @O_iErrorState <> 0 				break 	 			/* built dest company accounts */ 			exec @iStatus = ncBuildAccountString 				@cDestTemplate, 				@cTemplate, 				@cTemplateAccount, 				@O_cDestAccount output, 				@O_iErrorState output 	 			/* if the above stored proc failed, bail out */ 			select @iError = @@error 			if @iStatus = 0 and @iError <> 0 				select @iStatus = @iError 			if @iStatus <> 0 or @O_iErrorState <> 0 				break 				 			exec @iStatus = ncBuildAccountString 				@cDestICTemplate, 				@cTemplate, 				@cTemplateAccount, 				@O_cDestICAccount output, 				@O_iErrorState output 	 			/* if the above stored proc failed, bail out */ 			select @iError = @@error 			if @iStatus = 0 and @iError <> 0 				select @iStatus = @iError 			if @iStatus <> 0 or @O_iErrorState <> 0 				break 			/* see if they exist */ 			if exists( select 1 from GL00105 where ACTNUMST = @O_cSrcAccount ) 			begin 				if exists( select 1 from GL00105 where ACTNUMST = @O_cSrcICAccount ) 				begin 					/* check if dest company exists */ 					select @cDestCompany = @O_cDestCompany 					/* Start of modifications - 09/03/05 - pjsparrow */ 					/*if exists( select 1 from DYNAMICS..SY01500 where INTERID = @O_cDestCompany)*/ 					if exists( select 1 from DYNAMICS..SY01500 where INTERID = @O_cDestCompany and CMPANYID = @iCompanyID) 					/* End of modifications - 09/03/05 - pjsparrow */ 					begin 	 						/* see if they exist */ 						create table #RemoteAccounts ( 							ACTINDX int, 							ACTNUMST char(129) 						) 						 						select @cStatement = 'insert into #RemoteAccounts select ACTINDX, ACTNUMST from ' 							+ RTRIM(@cDestCompany) + '..GL00105 where ACTNUMST = ''' 							+ RTRIM(@O_cDestAccount) +'''' 						exec( @cStatement ) 						select @cStatement =  'insert into #RemoteAccounts select ACTINDX, ACTNUMST from ' 							+ RTRIM(@cDestCompany) + '..GL00105 where ACTNUMST = ''' 							+ RTRIM(@O_cDestICAccount) + '''' 						exec( @cStatement ) 						if exists( select 1 from #RemoteAccounts  								where ACTNUMST = RTRIM(@O_cDestAccount) ) 						begin 							if exists( select 1 from #RemoteAccounts  									where ACTNUMST = RTRIM(@O_cDestICAccount) ) 							begin 								select @O_iFoundOne = 1 							end 						end 						drop table #RemoteAccounts 					end  					else begin 						/* 24/02/2006 - pboniface - encode IntraCompany flag into RemoteDest flag */ 						select @O_iFoundOne = 1, @O_iRemoteDest = (case when @iINTRAcompany = 0 then 1 else -1 end) 					end 				end 			end 		end 	 		if (@O_iFoundOne = 0) 		begin 			fetch next from TemplateCursor into @cTemplateSQL, /* PJB */ 				@cTemplate, @cSrcTemplate, @cSrcICTemplate, 				@O_cDestCompany, @cDestTemplate, @cDestICTemplate, 				@iCompanyID, 				@O_iCopyMDA, @O_iReverseMDA 		end 	end 	deallocate TemplateCursor 	 end if @iStatus <> 0 or @O_iErrorState <> 0 begin 	if @tTransaction = 1 		rollback transaction end else if @tTransaction = 1 	commit transaction return (@iStatus)  
GO
GRANT EXECUTE ON  [dbo].[ncMatchAccountToTemplate] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[ncMatchAccountToTemplate] TO [public]
GO
