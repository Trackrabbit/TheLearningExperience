SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE Procedure [dbo].[SVC_Gen_Escalation_Comment]  (  @CallNumber char(11),   @SrvRecType smallint,   @LineSeq int,  @EscTechID char(11),  @SrvType char(11),  @Comment varchar(60) OUTPUT  ) AS declare @Escalation_Type smallint,  @Who varchar(11),  @ManagerLevel smallint,  @Priority_Boost smallint,  @MultiTech bit  select  @Comment = '',  @Who = '',  @ManagerLevel = 0,  @Escalation_Type = 0,  @Priority_Boost = 0  select  @CallNumber = isnull(@CallNumber, ''),  @SrvRecType = isnull(@SrvRecType, 0),  @LineSeq = isnull(@LineSeq, 0),  @EscTechID = isnull(@EscTechID, ''),  @SrvType = isnull(@SrvType, ''),  @Comment = ''  if @EscTechID = '' begin  select @EscTechID = TECHID  from SVC00200  where @CallNumber = CALLNBR and @SrvRecType = SRVRECTYPE end  select  @Escalation_Type = ESCTYPE,   @Who = TECHID,   @ManagerLevel = svcManagerLevel,  @Priority_Boost = priorityLevel  from SVC00922  where @LineSeq = LNITMSEQ and @SrvType = SRVTYPE  if ltrim(rtrim(@Who)) = 'MANAGER' begin  select @Who = isnull(TECHID, '')  from SVC00100   where TECHID = case   when @ManagerLevel = 0 then (select case   when mgr.MANAGER is null or mgr.MANAGER = '' then mgr.TECHID   else mgr.MANAGER  end  from SVC00100 mgr where TECHID = @EscTechID)   when @ManagerLevel = 1 then (select case   when mgr2.MANAGER is null or mgr2.MANAGER = '' then mgr2.TECHID   else mgr2.MANAGER  end  from SVC00100 mgr2 where TECHID =  (select case   when mgr3.MANAGER is null or mgr3.MANAGER = '' then mgr3.TECHID   else mgr3.MANAGER  end  from SVC00100 mgr3 where TECHID = @EscTechID))   when @ManagerLevel = 2 then (select case   when mgr4.MANAGER is null or mgr4.MANAGER = '' then mgr4.TECHID   else mgr4.MANAGER  end  from SVC00100 mgr4 where TECHID =  (select case   when mgr5.MANAGER is null or mgr5.MANAGER = '' then mgr5.TECHID   else mgr5.MANAGER  end  from SVC00100 mgr5 where TECHID =   (select case   when mgr6.MANAGER is null or mgr6.MANAGER = '' then mgr6.TECHID   else mgr6.MANAGER  end  from SVC00100 mgr6 where TECHID = @EscTechID)))   else @EscTechID  end end  select @Who = rtrim(isnull(@Who, ''))  if @Escalation_Type = 1  begin  if (rtrim(@Who) <> '')  begin  select @Comment = 'Escalate call to: ' + rtrim(isnull(@Who,''))  end  else   begin  select @Comment = 'Change Status on call to: ' + isnull(SRVSTAT,'')  from SVC00200 WITH (NOLOCK)  where CALLNBR = @CallNumber and SRVRECTYPE = @SrvRecType  end end  if (@Who is null or @Who = '')  begin  exec SVC_ServiceCall_IsMultiTech   1,   @SrvRecType,   @CallNumber,   @MultiTech OUTPUT   if @MultiTech = 0  select @Who = isnull(@EscTechID,'') end  if not exists(select * from SVC00100 where TECHID = @Who)  set @Who = rtrim(@EscTechID)  if @Escalation_Type = 2  begin  select  @Comment = 'Page: ' + rtrim(@Who) + ' at: ' + isnull(PAGER1,'')  from SVC00100 WITH (NOLOCK)   where TECHID = @Who end  if @Escalation_Type = 3  begin  select @Comment = 'E-Mail: ' + rtrim(@Who) + ' at: ' + isnull(TECHEMAIL,'')  from SVC00100 WITH (NOLOCK)   where TECHID = @Who end  if @Escalation_Type = 4  begin  select @Comment = 'Callback: ' + rtrim(@Who) + ' at: ' + isnull(TECHEMAIL,'')  from SVC00100 WITH (NOLOCK)   where TECHID = @Who end  if @Priority_Boost > 0  begin  select @Comment = @Comment + ' Boost Priority by: ' + convert(varchar(2),@Priority_Boost) end  RETURN   
GO
GRANT EXECUTE ON  [dbo].[SVC_Gen_Escalation_Comment] TO [DYNGRP]
GO
