SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[pmCLEmailDetails]  @I_cUserID char(15) = NULL,  @I_cFileName1 varchar(40) = NULL,  @I_cSearchString1 char(2)  = NULL,  @O_iErrorState int  = NULL output as  declare  @iError int,   @iStatus int,   @tLoop tinyint,  @PM_DOC_PAYMENT tinyint,  @PM_MODULE tinyint,  @DYNPROD_ID tinyint  select  @O_iErrorState = 0,  @iStatus  = 0  while (@tLoop is NULL) begin  select @tLoop = 1   if  @I_cUserID is NULL  or @I_cFileName1 is NULL  or @I_cSearchString1 is NULL  begin  select @O_iErrorState = 20846  break  end   exec @iStatus = DYNAMICS.dbo.smGetConstantInt  'PM',  @PM_MODULE output,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   exec @iStatus = DYNAMICS.dbo.smGetConstantInt  'PRODID_DYNAMICS',  @DYNPROD_ID output,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   exec @iStatus = DYNAMICS.dbo.smGetConstantInt  'PM_DOC_PAYMENT',  @PM_DOC_PAYMENT output,  @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   insert into  #CNTRLNUMTEMP(  CNTRLNUM,  DOCTYPE,  VENDORID )  select distinct  DOCNUMBR,  DOCTYPE,  Master_ID from  SY04910 where  DICTRYID = @DYNPROD_ID AND  MODULE1 = @PM_MODULE AND  NOT EXISTS  (select  1  from  PM20000  where  PM20000.VCHRNMBR = SY04910.DOCNUMBR  and  PM20000.DOCTYPE = SY04910.DOCTYPE )   AND NOT EXISTS  (select  1  from  PM30200  where  PM30200.VCHRNMBR = SY04910.DOCNUMBR  and  PM30200.DOCTYPE = SY04910.DOCTYPE )   AND NOT EXISTS  (select  1  from  PM10300  where  PM10300.VCHRNMBR = SY04910.DOCNUMBR  and  PM10300.DOCTYPE = SY04910.DOCTYPE )   if @@rowcount <> 0  begin  delete  SY04910  from  SY04910  where  DICTRYID = @DYNPROD_ID AND  MODULE1 = @PM_MODULE AND  NOT EXISTS  (select  1  from  PM20000  where  PM20000.VCHRNMBR = SY04910.DOCNUMBR  and PM20000.DOCTYPE = SY04910.DOCTYPE )  AND NOT EXISTS  (select  1  from  PM30200  where  PM30200.VCHRNMBR = SY04910.DOCNUMBR  and PM30200.DOCTYPE = SY04910.DOCTYPE )   AND NOT EXISTS  (select  1  from  PM10300  where  PM10300.VCHRNMBR = SY04910.DOCNUMBR  and PM10300.DOCTYPE = SY04910.DOCTYPE )   exec @iStatus = smCreateErrorLogRecord  @I_cUserID,  @I_cFileName1,  @I_cSearchString1,  9734,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  begin  select @iStatus = @iError  end   if @iStatus <> 0 or @O_iErrorState <> 0  begin  return @iStatus  end  end end  return(@iStatus)    
GO
GRANT EXECUTE ON  [dbo].[pmCLEmailDetails] TO [DYNGRP]
GO
