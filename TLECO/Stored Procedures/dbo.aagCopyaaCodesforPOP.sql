SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[aagCopyaaCodesforPOP] @I_newSubLedHdrID INT,  @I_SERIES SMALLINT, @I_PONumber CHAR(21), @I_DOCTYPE SMALLINT, @I_OldSeqNo INT, @O_fSuccess TINYINT = 1 OUTPUT AS  BEGIN   DECLARE @OldaaSubLedgerDistID INT,  @aaSubLedgerDistID INT,  @OldaaSubLedHdrID INT,  @aaSequenceNo BIGINT,  @aaSubLedgerAssignID INT,  @ACTINDX INT,  @aaBrowseTypeNew SMALLINT,  @ClassID INT,  @oRequiredFieldEmpty TINYINT,  @DEBITAMNT NUMERIC(19,5),  @ORDEBITAMNT NUMERIC(19,5),  @CURNCYID CHAR(15),  @CURRNIDX SMALLINT,  @XCHGRATE NUMERIC(19,7),  @DENXRATE NUMERIC(19,7)   SELECT @OldaaSubLedHdrID = aaSubLedgerHdrID FROM AAG20000 WHERE DOCNUMBR = LTRIM(RTRIM(@I_PONumber)) and SERIES = @I_SERIES    SELECT @OldaaSubLedgerDistID = aaSubLedgerDistID FROM AAG20001 WHERE aaSubLedgerHdrID = @OldaaSubLedHdrID and SEQNUMBR = @I_OldSeqNo   SELECT @DEBITAMNT= EXTDCOST,@ORDEBITAMNT = OREXTCST ,@CURNCYID=CURNCYID,@CURRNIDX=CURRNIDX,@XCHGRATE=XCHGRATE,@DENXRATE=DENXRATE FROM POP10110 WHERE PONUMBER = (SELECT TOP 1 DOCNUMBR FROM AAG20000 WHERE aaSubLedgerHdrID = @I_newSubLedHdrID)   SELECT @aaSubLedgerDistID = ISNULL(MAX(aaSubLedgerDistID),0)+1 FROM AAG20001 WHERE aaSubLedgerHdrID = @I_newSubLedHdrID  SELECT @aaSequenceNo = ISNULL(MAX(SEQNUMBR),0)+16384 FROM AAG20001 WHERE aaSubLedgerHdrID = @I_newSubLedHdrID  INSERT INTO AAG20001(aaSubLedgerHdrID,aaSubLedgerDistID,INTERID,CorrespondingUnit,ACTINDX,ACCTTYPE,aaBrowseType,DECPLACS,   DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,CURNCYID,CURRNIDX,RATETPID,EXGTBLID,  XCHGRATE,EXCHDATE,TIME1,RTCLCMTD,DENXRATE,MCTRXSTT,SEQNUMBR,  aaCustID,aaVendID,aaSiteID,aaItemID,aaCopyStatus,aaWinWasOpen,aaChangeDate, aaChangeTime)  SELECT @I_newSubLedHdrID,@aaSubLedgerDistID,INTERID,CorrespondingUnit,ACTINDX,ACCTTYPE,1,DECPLACS,   @DEBITAMNT,CRDTAMNT,@ORDEBITAMNT,ORCRDAMT,@CURNCYID,@CURRNIDX,RATETPID,EXGTBLID,  @XCHGRATE,EXCHDATE,TIME1,RTCLCMTD,@DENXRATE,MCTRXSTT,ISNULL(@aaSequenceNo,SEQNUMBR),  aaCustID,aaVendID,aaSiteID,aaItemID,aaCopyStatus,aaWinWasOpen,CONVERT(CHAR(12), GETDATE(), 102), CONVERT(CHAR(12), GETDATE(), 108)  FROM AAG20001 WHERE aaSubLedgerHdrID = @OldaaSubLedHdrID and aaSubLedgerDistID = @OldaaSubLedgerDistID   INSERT INTO AAG20002(aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,aaAssignedPercent,DistRef,NOTEINDX,aaAliasID)  SELECT @I_newSubLedHdrID,@aaSubLedgerDistID,aaSubLedgerAssignID,  @DEBITAMNT*aaAssignedPercent/10000,CRDTAMNT,@ORDEBITAMNT*aaAssignedPercent/10000,ORCRDAMT,aaAssignedPercent,DistRef,NOTEINDX,aaAliasID  FROM AAG20002 WHERE aaSubLedgerHdrID = @OldaaSubLedHdrID and aaSubLedgerDistID = @OldaaSubLedgerDistID   DECLARE C2 CURSOR FAST_FORWARD FOR (SELECT aaSubLedgerAssignID,(SELECT TOP 1 ACTINDX FROM AAG20001 WHERE aaSubLedgerHdrID = @I_newSubLedHdrID AND aaSubLedgerDistID=@aaSubLedgerDistID ) FROM AAG20002 WHERE aaSubLedgerHdrID = @OldaaSubLedHdrID and aaSubLedgerDistID = @OldaaSubLedgerDistID )  OPEN C2  FETCH NEXT FROM C2 INTO @aaSubLedgerAssignID,@ACTINDX  WHILE @@FETCH_STATUS = 0  BEGIN  EXEC aagGetClassIDBrowseType   @ACTINDX,   @ClassID output,   @aaBrowseTypeNew output   IF @aaBrowseTypeNew <> 0   AND NOT EXISTS  (SELECT 1 FROM AAG20003  WHERE aaSubLedgerHdrID = @I_newSubLedHdrID  AND aaSubLedgerDistID = @aaSubLedgerDistID  AND aaSubLedgerAssignID = @aaSubLedgerAssignID)  BEGIN   EXEC aagSubWorkCodeUpdate   @I_newSubLedHdrID,   @aaSubLedgerDistID,   @aaSubLedgerAssignID,   @ClassID,   @oRequiredFieldEmpty output    SET @aaBrowseTypeNew = 0   END    UPDATE AAG20001 SET aaBrowseType = 1  WHERE aaSubLedgerHdrID = @I_newSubLedHdrID and  aaSubLedgerDistID = @aaSubLedgerDistID   UPDATE AAG20003 SET AAG20003.aaTrxCodeID = A3.aaTrxCodeID FROM AAG20003 INNER JOIN (SELECT aaSubLedgerHdrID,aaSubLedgerAssignID,aaTrxDimID,aaTrxCodeID FROM AAG20003 WHERE aaSubLedgerHdrID = @OldaaSubLedHdrID and   aaSubLedgerDistID = @OldaaSubLedgerDistID AND aaSubLedgerAssignID=@aaSubLedgerAssignID) A3 on   AAG20003.aaSubLedgerAssignID=A3.aaSubLedgerAssignID AND AAG20003.aaTrxDimID=A3.aaTrxDimID   AND AAG20003.aaSubLedgerHdrID=@I_newSubLedHdrID AND AAG20003.aaSubLedgerDistID = @aaSubLedgerDistID   AND AAG20003.aaSubLedgerAssignID=@aaSubLedgerAssignID   FETCH NEXT FROM C2 INTO @aaSubLedgerAssignID,@ACTINDX  END   CLOSE C2  DEALLOCATE C2  END    
GO
GRANT EXECUTE ON  [dbo].[aagCopyaaCodesforPOP] TO [DYNGRP]
GO
