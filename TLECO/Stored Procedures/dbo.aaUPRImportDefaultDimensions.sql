SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aaUPRImportDefaultDimensions]  @@aaUPRImportDefaultDimTemp as varchar(255),  @@aaUPRImprtDefDimLogFile as varchar(255) AS BEGIN   DECLARE @InterID AS VARCHAR(5),  @USERID AS VARCHAR(255),  @ALL AS VARCHAR(255),  @l_Code AS INT,  @l_n AS INT,   @O_nSQL_State AS INT   SELECT @InterID =DB_NAME(), @USERID = SYSTEM_USER   exec    @l_Code = DYNAMICS.dbo.smGetMsgString 19154, @InterID, @ALL output, @O_nSQL_State output   SELECT @l_n = @@ERROR  IF @l_Code = 0 and @l_n <> 0   SELECT @l_Code = @l_n   IF ( (@l_Code <> 0) or (@O_nSQL_State <> 0) )   return (@l_Code)   EXEC('INSERT INTO '+ @@aaUPRImprtDefDimLogFile+'(UPRACTYP,EMPLOYID,aaErrorNum,ERMSGTXT,ROWNMBR)  SELECT A.UPRACTYP, A.EMPLOYID, 8 ,'''', A.ROWNMBR  FROM '+@@aaUPRImportDefaultDimTemp+' A  INNER JOIN AAG03000 ON A.EMPLOYID = AAG03000.EMPLOYID AND A.UPRACTYP=AAG03000.UPRACTYP ')   EXEC('INSERT INTO '+@@aaUPRImprtDefDimLogFile+'(UPRACTYP,EMPLOYID,aaErrorNum,ERMSGTXT,ROWNMBR)  SELECT UPRACTYP,EMPLOYID,3,'''',ROWNMBR  FROM '+@@aaUPRImportDefaultDimTemp+'  WHERE (EMPLOYID <> '''+@ALL+''') AND EMPLOYID NOT IN(SELECT EMPLOYID FROM UPR00100)')    EXEC('INSERT INTO '+@@aaUPRImprtDefDimLogFile+'(UPRACTYP,EMPLOYID,aaErrorNum,ERMSGTXT,ROWNMBR)   SELECT UPRACTYP,DEPRTMNT,4,'''' ,ROWNMBR  FROM '+@@aaUPRImportDefaultDimTemp+'  WHERE (DEPRTMNT <> '''+@ALL+''') AND DEPRTMNT NOT IN(SELECT DEPRTMNT FROM UPR40300)')    EXEC('INSERT INTO '+@@aaUPRImprtDefDimLogFile+'(UPRACTYP,EMPLOYID,aaErrorNum,ERMSGTXT,ROWNMBR)  SELECT UPRACTYP,JOBTITLE,5,'''' ,ROWNMBR  FROM '+@@aaUPRImportDefaultDimTemp+'  WHERE (JOBTITLE <> '''+@ALL+''') AND JOBTITLE NOT IN(SELECT JOBTITLE FROM UPR40301)')    EXEC('INSERT INTO '+@@aaUPRImprtDefDimLogFile+'(UPRACTYP,EMPLOYID,aaErrorNum,ERMSGTXT,ROWNMBR)  SELECT UPRACTYP,JOBTITLE,6,'''' ,ROWNMBR  FROM  '+@@aaUPRImportDefaultDimTemp+'  WHERE (PAYROLCD <> '''+@ALL+''') AND   ((UPRACTYP = 1 AND PAYROLCD NOT IN(SELECT PAYRCORD FROM UPR40600)) OR   (UPRACTYP = 2 AND PAYROLCD NOT IN(SELECT TAXEXWTH FROM UPR40501 WHERE TXEXOWTH = 1)) OR   (UPRACTYP = 6 AND PAYROLCD NOT IN(SELECT TAXEXWTH FROM UPR40501 WHERE TXEXOWTH = 0 AND TAXEXWTH NOT IN (''SUTA'',''FUTA''))) OR   (UPRACTYP = 3 AND PAYROLCD NOT IN(SELECT STATECD FROM UPR41100)) OR   (UPRACTYP = 4 AND PAYROLCD NOT IN(SELECT LOCALTAX FROM UPR41400)) OR   (UPRACTYP = 5 AND PAYROLCD NOT IN(SELECT DEDUCTON FROM UPR40900)) OR   (UPRACTYP IN(7,8,9,10) AND PAYROLCD NOT IN(SELECT BENEFIT FROM UPR40800))   )')    EXEC('INSERT INTO  '+@@aaUPRImprtDefDimLogFile+'(UPRACTYP,EMPLOYID,aaErrorNum,ERMSGTXT,ROWNMBR)  SELECT UPRACTYP,aaAlias,7,'''' ,ROWNMBR FROM  '+@@aaUPRImportDefaultDimTemp+'  WHERE aaAlias NOT IN(SELECT aaAlias FROM AAG00800)')    EXEC('UPDATE '+@@aaUPRImportDefaultDimTemp+ ' SET '+@@aaUPRImportDefaultDimTemp+'.aaAliasID = ISNULL((SELECT aaAliasID  FROM AAG00800  WHERE (AAG00800.aaAlias = '+ @@aaUPRImportDefaultDimTemp+'.aaAlias)),'''')')   EXEC('INSERT INTO '+@@aaUPRImprtDefDimLogFile+'(UPRACTYP,EMPLOYID,aaErrorNum,ERMSGTXT,ROWNMBR)  SELECT UPRACTYP,EMPLOYID,1,'''', MAX(ROWNMBR) FROM '+@@aaUPRImportDefaultDimTemp+'  GROUP BY UPRACTYP,EMPLOYID, DEPRTMNT, JOBTITLE, PAYROLCD, aaAliasID HAVING COUNT(*) > 1 ORDER BY UPRACTYP ')    EXEC('INSERT INTO '+@@aaUPRImprtDefDimLogFile+'(UPRACTYP,EMPLOYID,aaErrorNum,ERMSGTXT,ROWNMBR)  SELECT UPRACTYP, EMPLOYID, 2,'''' , MAX(ROWNMBR) FROM '+@@aaUPRImportDefaultDimTemp+'   GROUP BY EMPLOYID,UPRACTYP, DEPRTMNT,JOBTITLE,PAYROLCD HAVING sum(aaAssignedPercent) >10000 order by UPRACTYP')    EXEC('DELETE FROM  '+ @@aaUPRImportDefaultDimTemp+ '   WHERE UPRACTYP IN (SELECT UPRACTYP FROM  '+@@aaUPRImprtDefDimLogFile+')')   EXEC('if exists (SELECT TOP 1 1 FROM '+ @@aaUPRImportDefaultDimTemp+' )  INSERT INTO AAG03000(EMPLOYID,DEPRTMNT,JOBTITLE,PAYROLCD,UPRACTYP,aaAliasID,aaAssignedPercent)   SELECT EMPLOYID,DEPRTMNT,JOBTITLE,PAYROLCD,UPRACTYP,aaAliasID,aaAssignedPercent FROM '+@@aaUPRImportDefaultDimTemp)  EXEC('if not exists (SELECT TOP 1 1 FROM '+ @@aaUPRImprtDefDimLogFile +') INSERT INTO '+@@aaUPRImprtDefDimLogFile+'(UPRACTYP,EMPLOYID,aaErrorNum,ERMSGTXT,ROWNMBR) VALUES (1,''@ALL'',0,'''',0)')   END   
GO
GRANT EXECUTE ON  [dbo].[aaUPRImportDefaultDimensions] TO [DYNGRP]
GO
