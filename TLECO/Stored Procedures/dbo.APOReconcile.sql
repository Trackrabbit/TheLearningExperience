SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
create procedure [dbo].[APOReconcile] @O_SQL_Error_State 		int = 0	output with encryption as set transaction isolation level read uncommitted set nocount on if exists(select 1 from sysobjects where name = 'PO20202') begin update IV00102 set QTYONORD = 0 where QTYONORD <> 0 update IV00103 set QTYONORD = 0 where QTYONORD <> 0 if exists (select name from tempdb..sysobjects where name = '#ItemPOQtys') begin drop table #ItemPOQtys end create table #ItemPOQtys(ITEMNMBR char(31) null, LOCNCODE char(11), QTYORDandFFQSum numeric(19,5), QTYRECandFFQSum numeric(19,5)) create nonclustered index AK1ItemPOQtys on #ItemPOQtys(ITEMNMBR,LOCNCODE) insert #ItemPOQtys select ITMNUM,LOCNCODE,sum(QYORD*FFQ),sum(QTYREC*FFQ) from PO20202 where QTYREC < QYORD group by ITMNUM, LOCNCODE update i set i.QTYONORD = p.QTYORDandFFQSum - p.QTYRECandFFQSum from IV00102 i, #ItemPOQtys p where i.ITEMNMBR = p.ITEMNMBR and i.LOCNCODE = p.LOCNCODE and i.RCRDTYPE = 2 if exists (select name from tempdb..sysobjects where name = '#ItemQtys') begin drop table #ItemQtys end create table #ItemQtys(ITEMNMBR char(31) null, LOCNCODE char(11), QTYONORDSum numeric(19,5)) create nonclustered index AK1ItemQtys on #ItemQtys(ITEMNMBR,LOCNCODE) if exists (select name from tempdb..sysobjects where name = '#ItemQtysSum') begin drop table #ItemQtysSum end create table #ItemQtysSum(ITEMNMBR char(31) null, QTYONORDSum numeric(19,5)) create nonclustered index AK1ItemQtysSum on #ItemQtysSum(ITEMNMBR) insert #ItemQtys  select 	ITEMNMBR,LOCNCODE,sum(QTYONORD) from IV00102 where RCRDTYPE = 2 and QTYONORD <> 0 group by ITEMNMBR,LOCNCODE insert #ItemQtysSum select ITEMNMBR,sum(QTYONORDSum) from #ItemQtys group by ITEMNMBR update a set a.QTYONORD = b.QTYONORDSum from IV00102 a, #ItemQtysSum b where a.ITEMNMBR = b.ITEMNMBR and a.LOCNCODE = '' and a.RCRDTYPE = 1 update i set i.QTYONORD = i.QTYONORD + (p.QYORD * p.FFQ) - (p.QTYREC * FFQ) from IV00103 i, PO20202 p where i.ITEMNMBR = p.ITMNUM and i.VENDORID = p.VENDORID and p.QTYREC < QYORD end return 
GO
GRANT EXECUTE ON  [dbo].[APOReconcile] TO [DYNGRP]
GO
