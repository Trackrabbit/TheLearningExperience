SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[glCLAccountMSTRVerifyLedger]  @I_cUser_ID char(15)  = NULL,  @I_SumMstrName char(255)  = NULL,  @I_SumHistMaster char(255)  = NULL,  @I_ErrorMsg char(255)  = NULL,  @IO_UseReportingLedgers binary(4)  = NULL OUTPUT as   DECLARE   @BaseLedger int,  @IfrsLedger int,  @LocalLedger int  if (  @I_cUser_ID is NULL or  @I_SumMstrName is NULL or  @I_SumHistMaster is NULL or  @I_ErrorMsg is NULL or  @IO_UseReportingLedgers is NULL   )  begin  return end  CREATE TABLE #Errors(  [USERID] [char](15) NOT NULL,  [INDXLONG] [int] IDENTITY(1,1) NOT NULL,  [FILENAME] [char](45) NOT NULL,  [ERMSGTXT] [char](255) NOT NULL)  select @BaseLedger  = power (2,24), @IfrsLedger  = power (2,25), @LocalLedger = power (2,26)  insert into  #Errors  select  @I_cUser_ID,  @I_SumMstrName,  REPLACE(@I_ErrorMsg, '%1', ltrim(rtrim(str(Invalid.ACTINDX))))  from (select distinct GL10110.ACTINDX from GL10110  where Ledger_ID not in (1,2,3))Invalid  Update GL10110 set Ledger_ID = 1 where Ledger_ID not in (1,2,3) and ACTINDX not in (select ACTINDX from GL10110 a where a.ACTINDX = GL10110.ACTINDX and a.YEAR1 = GL10110.YEAR1 and a.PERIODID = GL10110.PERIODID and a.Ledger_ID = 1)  Update GL10110 set PERDBLNC = total.PERDBLNC from (select ACTINDX, YEAR1, PERIODID, SUM(PERDBLNC) as PERDBLNC  from GL10110 where Ledger_ID not in (2,3) group by ACTINDX, YEAR1, PERIODID) total where total.ACTINDX = GL10110.ACTINDX and total.YEAR1 = GL10110.YEAR1 and total.PERIODID = GL10110.PERIODID and GL10110.Ledger_ID = 1  delete from GL10110 where Ledger_ID not in (1,2,3)  insert into  #Errors  select  @I_cUser_ID,  @I_SumHistMaster,  REPLACE(@I_ErrorMsg, '%1', ltrim(rtrim(str(Invalid.ACTINDX))))  from (select distinct GL10111.ACTINDX from GL10111  where Ledger_ID not in (1,2,3))Invalid  Update GL10111 set Ledger_ID = 1 where Ledger_ID not in (1,2,3) and ACTINDX not in (select ACTINDX from GL10111 a where a.ACTINDX = GL10111.ACTINDX and a.YEAR1 = GL10111.YEAR1 and a.PERIODID = GL10111.PERIODID and a.Ledger_ID = 1)  Update GL10111 set PERDBLNC = total.PERDBLNC from (select ACTINDX, YEAR1, PERIODID, SUM(PERDBLNC) as PERDBLNC  from GL10111 where Ledger_ID not in (2,3) group by ACTINDX, YEAR1, PERIODID) total where total.ACTINDX = GL10111.ACTINDX and total.YEAR1 = GL10111.YEAR1 and total.PERIODID = GL10111.PERIODID and GL10111.Ledger_ID = 1  delete from GL10111 where Ledger_ID not in (1,2,3)  insert into  SY03400  select  USERID,  INDXLONG,  FILENAME,  ERMSGTXT,  '' as ERMSGTXT2  from #Errors  select @IO_UseReportingLedgers = (@IO_UseReportingLedgers | @BaseLedger)  if (select COUNT(*)   from (  select Ledger_ID   from GL10110 where Ledger_ID in (2, 3)  union   select Ledger_ID   from GL10110 where Ledger_ID in (2, 3)) Ledgers  ) > 0 begin  select @IO_UseReportingLedgers = (@IO_UseReportingLedgers | @IfrsLedger)  select @IO_UseReportingLedgers = (@IO_UseReportingLedgers | @LocalLedger) end    
GO
GRANT EXECUTE ON  [dbo].[glCLAccountMSTRVerifyLedger] TO [DYNGRP]
GO
