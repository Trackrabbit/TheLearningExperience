SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE procedure [dbo].[uprLoadSUTATempTableE]  @I_vTableName varchar(25) = NULL,  @O_iErrorState          int             = NULL output  as  declare @iStatus int,  @iError int  select @iStatus = 0  select @O_iErrorState = 0  if( @I_vTableName is NULL) begin  select          @O_iErrorState = 21022  return end  exec    ('declare @SUTASTAT char(3),@DEPRTMNT char(8), @JOBTITLE char(8) '  + ' declare @dexrowid int,@prevdexrowid int, @FUSUTXRT  dec(19,5), @MTDTXBWG  dec(19,5), @SUTAMTDT dec(19,5) '  + ' declare @l_St char(3),@l_Dept char(8), @l_JTit char(8), @l_Done dec(19,5), @l_EOF dec(19,5)  '  + 'declare @l_SUTA_Rate dec(19,7), @l_Mo_DJ_Txbl dec(19,5), @l_Mo_St_Txbl dec(19,5), @l_Mo_DJ_Tax dec(19,5), '  + ' @l_Mo_St_Tax dec(19,5), @l_Calc dec(19,5), @l_suta_mtd_tax dec(19,5) '  + ' select @l_St='''',@l_Dept='''',@l_JTit='''', @l_Done= 0, @l_EOF= 0 '  + ' select @l_Mo_DJ_Txbl=0,@l_Mo_DJ_Tax=0,@l_Mo_St_Txbl=0,@l_Mo_St_Tax=0,@l_SUTA_Rate=0 '  + ' DECLARE t_cursor SCROLL CURSOR for '  + ' select DEX_ROW_ID,SUTASTAT,DEPRTMNT,JOBTITLE,FUSUTXRT,MTDTXBWG,SUTAMTDT from ' + @I_vTableName + ' WHERE SUTASTAT >= ''AA''  '  + '  ORDER BY SUTASTAT ASC ,DEPRTMNT ASC ,JOBTITLE ASC ,DEX_ROW_ID ASC '  + ' set NOCOUNT on '  + ' open t_cursor '  + ' FETCH NEXT FROM t_cursor INTO @dexrowid,@SUTASTAT,@DEPRTMNT,@JOBTITLE,@FUSUTXRT,@MTDTXBWG,@SUTAMTDT '  + ' while (@@fetch_status = 0) '    + 'begin'    + ' if   (@@fetch_status = -1) '  + 'begin'  + ' select @l_EOF = 1 '  + 'end'  + ' while (@l_Done = 0 ) '  + ' begin '  + '  if (@l_St = '''') '  + '  begin '  + '   select @l_St =@SUTASTAT, @l_Dept=@DEPRTMNT, @l_JTit=@JOBTITLE '  + '   end  '  + '  if(@l_EOF = 1) '  + '  begin '  + '   select @l_Done = 1 '  + '   end  '  + '  if  (@l_St =@SUTASTAT and @l_Dept=@DEPRTMNT and @l_JTit=@JOBTITLE and @l_Done = 0) '  + '  begin   '  + '   select  @l_SUTA_Rate = (@FUSUTXRT/10000000.00), '  + '    @l_Mo_DJ_Txbl = @l_Mo_DJ_Txbl + @MTDTXBWG, '  + '    @l_Mo_St_Txbl = @l_Mo_St_Txbl + @MTDTXBWG '  + '   select @l_suta_mtd_tax = @MTDTXBWG * @l_SUTA_Rate '  + '   select @l_suta_mtd_tax = round(@l_suta_mtd_tax,5) '  + '   select @SUTAMTDT = @l_suta_mtd_tax '  + '   select  @l_Mo_DJ_Tax = @l_Mo_DJ_Tax + @SUTAMTDT, '  + '    @l_Mo_St_Tax = @l_Mo_St_Tax + @SUTAMTDT  '   + '  if @SUTAMTDT < 0 and @MTDTXBWG =0 '   + '  begin '  +'   select @SUTAMTDT = 0 '  + '  end '  + '   update ' + @I_vTableName + ' set SUTAMTDT = @SUTAMTDT where DEX_ROW_ID = @dexrowid '  + '  end '  + '  else if (@l_St =@SUTASTAT and @l_Done = 0) '  + '  begin '  + '   select @l_St =@SUTASTAT, @l_Dept=@DEPRTMNT, @l_JTit=@JOBTITLE  '  + '   FETCH PRIOR FROM t_cursor into  @dexrowid,@SUTASTAT,@DEPRTMNT,@JOBTITLE,@FUSUTXRT,@MTDTXBWG,@SUTAMTDT'  + '   select @l_suta_mtd_tax = @l_Mo_DJ_Txbl * @l_SUTA_Rate '  + '   select @l_suta_mtd_tax = round(@l_suta_mtd_tax,5) '  + '   select @SUTAMTDT = @SUTAMTDT+ @l_suta_mtd_tax - @l_Mo_DJ_Tax '  + '   select @l_Mo_St_Tax = @l_Mo_St_Tax + @l_suta_mtd_tax - @l_Mo_DJ_Tax '  + '  if @SUTAMTDT < 0 and @MTDTXBWG =0 '   + '  begin '  +'   select @SUTAMTDT = 0 '  + '  end '  + '   update  ' + @I_vTableName + ' set  SUTAMTDT = @SUTAMTDT '  + '     where CURRENT OF t_cursor '  + '   select @l_Mo_DJ_Txbl=0,@l_Mo_DJ_Tax=0 '  + '  end '  + '  else '  + '  begin '  + '   select @l_St =@SUTASTAT, @l_Dept=@DEPRTMNT, @l_JTit=@JOBTITLE '  + '   if  (@@fetch_status = -1) '  + '   begin '  + '    FETCH LAST FROM t_cursor into  @dexrowid,@SUTASTAT,@DEPRTMNT,@JOBTITLE,@FUSUTXRT,@MTDTXBWG,@SUTAMTDT '  + '   end '  + '   else '  + '   begin '  + '    FETCH PRIOR FROM t_cursor into  @dexrowid,@SUTASTAT,@DEPRTMNT,@JOBTITLE,@FUSUTXRT,@MTDTXBWG,@SUTAMTDT '  + '   end  '   + '   select @l_suta_mtd_tax = @l_Mo_St_Txbl * @l_SUTA_Rate '  + '   select @l_suta_mtd_tax = round(@l_suta_mtd_tax,5) '  + '   select @SUTAMTDT = @SUTAMTDT+ @l_suta_mtd_tax - @l_Mo_St_Tax '  + '  if @SUTAMTDT < 0 and @MTDTXBWG =0 '   + '  begin '  +'   select @SUTAMTDT = 0 '  + '  end '  + '   update ' + @I_vTableName + ' set  SUTAMTDT = @SUTAMTDT '  + '     where CURRENT OF t_cursor '  + '   select @l_Mo_DJ_Txbl=0,@l_Mo_DJ_Tax=0,@l_Mo_St_Txbl=0,@l_Mo_St_Tax=0 '  + '  end  '  + '  FETCH NEXT FROM t_cursor into  @dexrowid,@SUTASTAT,@DEPRTMNT,@JOBTITLE,@FUSUTXRT,@MTDTXBWG,@SUTAMTDT '  + ' if   (@@fetch_status = -1) '  + 'begin'  + ' select @l_EOF = 1 '  + 'end'  + ' end '  + ' end '   + '  DEALLOCATE t_cursor '  )   return(@iStatus)    
GO
GRANT EXECUTE ON  [dbo].[uprLoadSUTATempTableE] TO [DYNGRP]
GO
