SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[glCalcCMBeginningBalance]   @iStartDate VARCHAR(25),   @CHEKBKID CHAR(15),   @oBeginBal MONEY OUTPUT AS  BEGIN  DECLARE @lSQLError INT,  @l_nStatus INT,  @l_nError INT,  @l_cTransferTo VARCHAR(255),  @l_cTransferFrom VARCHAR(255)  IF (SELECT CURNCYID FROM CM00100 WHERE CHEKBKID = @CHEKBKID ) = (SELECT FUNLCURR FROM MC40000)  BEGIN  SET @iStartDate = DATEADD(DAY,-1,@iStartDate)  EXEC cmGetAsOfBalance @CHEKBKID, @iStartDate, @oBeginBal OUTPUT,@lSQLError OUTPUT  END  ELSE  BEGIN  SELECT @l_cTransferTo = SQL_MSG FROM DYNAMICS..MESSAGES WHERE MSGNUM = 2122 AND Language_ID = 0  SELECT @l_cTransferFrom = SQL_MSG FROM DYNAMICS..MESSAGES WHERE MSGNUM = 2123 AND Language_ID = 0   SELECT  SRCDOCNUM, AUDITTRAIL, SUM(TRXAMNT) AS ONACCOUNT INTO  #BEGINBAL FROM  CM20200   WHERE CHEKBKID = @CHEKBKID AND CMTrxType IN (1,5,101,102) AND (VOIDED = 0 OR (VOIDED = 1 AND VOIDDATE >= @iStartDate)) AND TRXDATE < @iStartDate  GROUP BY  SRCDOCNUM, AUDITTRAIL    INSERT INTO  #BEGINBAL SELECT  SRCDOCNUM, AUDITTRAIL, 0 - SUM(TRXAMNT) AS ONACCOUNT FROM CM20200   WHERE CHEKBKID = @CHEKBKID AND CMTrxType IN (3,4,6,103,104) AND (VOIDED = 0 OR (VOIDED = 1 AND VOIDDATE >= @iStartDate)) AND TRXDATE < @iStartDate  GROUP BY  SRCDOCNUM, AUDITTRAIL    INSERT INTO  #BEGINBAL SELECT  SRCDOCNUM, AUDITTRAIL, 0 - SUM(TRXAMNT) AS ONACCOUNT FROM CM20200   WHERE CHEKBKID = @CHEKBKID AND CMTrxType IN (7) AND (VOIDED = 0 OR (VOIDED = 1 AND VOIDDATE >= @iStartDate)) AND   paidtorcvdfrom LIKE SUBSTRING(LTRIM(RTRIM(@l_cTransferTo)), 1 , LEN(LTRIM(RTRIM(@l_cTransferTo))) - 1 ) AND TRXDATE < @iStartDate  GROUP BY  SRCDOCNUM, AUDITTRAIL    INSERT INTO  #BEGINBAL SELECT  SRCDOCNUM, AUDITTRAIL, SUM(TRXAMNT) AS ONACCOUNT FROM CM20200   WHERE CHEKBKID = @CHEKBKID AND CMTrxType IN (7) AND (VOIDED = 0 OR (VOIDED = 1 AND VOIDDATE >= @iStartDate)) AND  paidtorcvdfrom LIKE SUBSTRING(LTRIM(RTRIM(@l_cTransferFrom)), 1 , LEN(LTRIM(RTRIM(@l_cTransferFrom))) - 1 ) AND TRXDATE < @iStartDate  GROUP BY  SRCDOCNUM, AUDITTRAIL    SELECT  @oBeginBal = SUM(ISNULL(ONACCOUNT,0)) FROM  #BEGINBAL   END  RETURN (@lSQLError)  END    
GO
GRANT EXECUTE ON  [dbo].[glCalcCMBeginningBalance] TO [DYNGRP]
GO
