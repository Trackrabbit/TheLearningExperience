SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create           procedure [dbo].[aagBuildBudgetTree]   @aaBudgetTreeID int,   @TRXTable nvarchar(30),   @CodeTable nvarchar(30)  as  begin   set nocount on   declare @aaTrxDimCodeID int,   @MaxaaOrder int,   @aaCodeSequence int,   @Cnt int,   @aaTrxDimCodeFr char(31),   @aaTrxDimCodeTo char(31),   @aaLvlCodeString char(50),   @str nvarchar(500)   select @aaTrxDimCodeID  =0,   @MaxaaOrder  =0,   @aaCodeSequence  =100,   @Cnt   =0,   @aaTrxDimCodeFr  =0,   @aaTrxDimCodeTo  =0,   @aaLvlCodeString =null   exec('delete from '+ @CodeTable + ' where aaBudgetTreeID = ' + @aaBudgetTreeID )   exec ('insert into ' + @CodeTable + '(aaBudgetTreeID,aaTrxDimCodeID,   aaTrxDimParCodeID,aaCodeSequence,aaLevel,aaLvlCodeString,aaTrxDimCodeDescr1)   values (' + @aaBudgetTreeID +',0,0,'+ @aaCodeSequence +',0,space(1),space(1))')   exec('declare CMax cursor fast_forward for   select  max(aaOrder) from '  + @TRXTable  + '   where aaBudgetTreeID = ' + @aaBudgetTreeID + ' and aaSelectOpt in (0,1)')   open CMax   fetch next from CMax into @MaxaaOrder   close CMax   deallocate CMax   exec aagGetCodeFrAndTo @aaBudgetTreeID, 1, @TRXTable, @aaTrxDimCodeFr output ,@aaTrxDimCodeTo output   set @aaTrxDimCodeFr=replace(@aaTrxDimCodeFr,'''','''''')   set @aaTrxDimCodeTo=replace(@aaTrxDimCodeTo,'''','''''')   exec('declare CABROOT cursor fast_forward for   select aaTrxDimCodeID   from AAG00401   where aaTrxDimID in (select aaTrxDimID from '  + @TRXTable  + '   where aaBudgetTreeID = ' + @aaBudgetTreeID + ' and   aaOrder = 1  ) and   aaTrxDimCode >= ''' + @aaTrxDimCodeFr + '''  and   aaTrxDimCode <= ''' + @aaTrxDimCodeTo + '''   and INACTIVE = 0  order by aaTrxDimCode')   open CABROOT   fetch next from CABROOT into @aaTrxDimCodeID   while @@fetch_status =0   begin   set @aaLvlCodeString  = null   exec('declare CSeq cursor fast_forward for   select  max(aaCodeSequence) + 100   from ' + @CodeTable + ' where aaBudgetTreeID = '+ @aaBudgetTreeID)   open CSeq   fetch next from CSeq into @aaCodeSequence   close CSeq   deallocate CSeq   set @aaLvlCodeString = ltrim(str(@aaTrxDimCodeID))      exec('insert into ' + @CodeTable + '(aaBudgetTreeID,aaTrxDimCodeID,   aaTrxDimParCodeID,aaCodeSequence,aaLevel,aaLvlCodeString,aaTrxDimCodeDescr1)  (select '+ @aaBudgetTreeID +   ','+@aaTrxDimCodeID + ',0,'+@aaCodeSequence+',1,'+@aaLvlCodeString+', AAG00401.aaTrxDimCodeDescr from  AAG00401 WHERE AAG00401.aaTrxDimCodeID ='+ @aaTrxDimCodeID +')')  exec aagBuildBudgetTreeSubNodes @aaBudgetTreeID, @TRXTable, @CodeTable,   @aaTrxDimCodeID, @aaLvlCodeString output,1,@MaxaaOrder   fetch next from CABROOT into @aaTrxDimCodeID   end   close CABROOT   deallocate CABROOT   set nocount off  end     
GO
GRANT EXECUTE ON  [dbo].[aagBuildBudgetTree] TO [DYNGRP]
GO
