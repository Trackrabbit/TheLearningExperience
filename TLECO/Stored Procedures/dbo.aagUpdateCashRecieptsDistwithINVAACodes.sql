SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aagUpdateCashRecieptsDistwithINVAACodes]  @aaSubLedgerHdrID INT,  @CompanyID SMALLINT,  @SqlSessionID INT AS  BEGIN  DECLARE @APFRDCNM CHAR(17),  @APTODCNM CHAR(17),  @APTVCHNM CHAR(17),  @ACTINDX INT,  @aaSubLedgerDistID INT,  @aaSubLedgerAssignID INT,  @NOTEINDX NUMERIC(19,5),  @APPTOAMT NUMERIC(19,5),  @ORAPTOAM NUMERIC(19,5),  @CRDTAMNT NUMERIC(19,5),   @ORCRDAMT NUMERIC(19,5),  @DEBITAMT     NUMERIC(19,5),   @ORDBTAMT     NUMERIC(19,5),   @OLDaaSubLedgerHdrID INT,  @OLDaaSubLedgerDistID INT,  @OLDaaSubLedgerAssignID INT,  @OLDaaAssignedPercent INT,  @AssignPercent INT,  @TotalORCRDTAMT   NUMERIC(19,5),  @TotalCRDTAMT    NUMERIC(19,5),  @TotalORDBTAMT    NUMERIC(19,5),  @TotalDEBITAMT    NUMERIC(19,5),  @TotalPrec INT,  @aaBrowseTypeNew SMALLINT,  @ClassID INT,  @oRequiredFieldEmpty TINYINT,  @DISTTYPE INT,  @DISAVTKN     NUMERIC(19,5),  @ORDISTKN     NUMERIC(19,5),  @DummyDBTAMT NUMERIC(19,5),  @DummyCRDTAMT NUMERIC(19,5),  @DummyORDBTAMT    NUMERIC(19,5),   @DummyORCRDTAMT NUMERIC(19,5),  @AssignCRDTAMNT NUMERIC(19,5),  @AssignDEBITAMT NUMERIC(19,5),  @AssignORCRDTAMNT NUMERIC(19,5),   @AssignORDBTAMT    NUMERIC(19,5)   SELECT A2.aaSubLedgerHdrID HdrID, A2.aaSubLedgerDistID DistID, A2.aaSubLedgerAssignID AssignID, A1.ACTINDX, 0 DISTTYPE,0 aaPerc, A2.CRDTAMNT, A2.DEBITAMT, A2.ORCRDAMT, A2.ORDBTAMT INTO #Distribution FROM AAG20002 A2  INNER JOIN AAG20001 A1 on A2.aaSubLedgerHdrID = A1.aaSubLedgerHdrID AND A1.aaSubLedgerDistID = A2.aaSubLedgerDistID  WHERE 1 = 2  SELECT @APFRDCNM = DOCNUMBR FROM AAG20000 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID   DECLARE Cursor1 CURSOR LOCAL FAST_FORWARD FOR   SELECT APTODCNM, APPTOAMT, ORAPTOAM, DISAVTKN, ORDISTKN FROM RM20201 WHERE APFRDCNM = @APFRDCNM   OPEN Cursor1  FETCH NEXT FROM Cursor1 INTO @APTODCNM, @APPTOAMT, @ORAPTOAM, @DISAVTKN, @ORDISTKN  WHILE @@FETCH_STATUS = 0  BEGIN  IF EXISTS (SELECT TOP 1 1 FROM RM20101 WHERE DOCNUMBR = @APTODCNM AND BCHSOURC = 'Sales Entry')  BEGIN  IF @APPTOAMT > 0  INSERT INTO #Distribution SELECT A2.aaSubLedgerHdrID, A2.aaSubLedgerDistID, A2.aaSubLedgerAssignID, A1.ACTINDX, 3,0, A2.CRDTAMNT, A2.DEBITAMT, A2.ORCRDAMT, A2.ORDBTAMT FROM AAG20002 A2  INNER JOIN AAG20001 A1 on A2.aaSubLedgerHdrID = A1.aaSubLedgerHdrID AND A1.aaSubLedgerDistID = A2.aaSubLedgerDistID  WHERE A2.aaSubLedgerHdrID =   (  SELECT aaSubLedgerHdrID FROM AAG20000 WHERE SERIES = 3 and DOCTYPE = 1 AND DOCNUMBR = @APTODCNM  )   AND DISTTYPE = 2   IF @DISAVTKN > 0  INSERT INTO #Distribution SELECT A2.aaSubLedgerHdrID, A2.aaSubLedgerDistID, A2.aaSubLedgerAssignID, A1.ACTINDX, 5,0, A2.CRDTAMNT, A2.DEBITAMT, A2.ORCRDAMT, A2.ORDBTAMT FROM AAG20002 A2  INNER JOIN AAG20001 A1 on A2.aaSubLedgerHdrID = A1.aaSubLedgerHdrID AND A1.aaSubLedgerDistID = A2.aaSubLedgerDistID  WHERE A2.aaSubLedgerHdrID =   (  SELECT aaSubLedgerHdrID FROM AAG20000 WHERE SERIES = 3 and DOCTYPE = 1 AND DOCNUMBR = @APTODCNM  )   AND DISTTYPE = 5  END  ELSE  BEGIN  IF @APPTOAMT > 0  INSERT INTO #Distribution SELECT A2.aaSubLedgerHdrID, A2.aaSubLedgerDistID, A2.aaSubLedgerAssignID, A1.ACTINDX, 3,0, A2.CRDTAMNT, A2.DEBITAMT, A2.ORCRDAMT, A2.ORDBTAMT FROM AAG20002 A2  INNER JOIN AAG20001 A1 on A2.aaSubLedgerHdrID = A1.aaSubLedgerHdrID AND A1.aaSubLedgerDistID = A2.aaSubLedgerDistID  WHERE   A2.aaSubLedgerHdrID = (SELECT TOP 1 aaSubLedgerHdrID FROM AAG20000 WHERE SERIES = 3 and DOCTYPE IN (1,3,4,5) AND DOCNUMBR = @APTODCNM)   AND DISTTYPE = 3   IF @DISAVTKN > 0  INSERT INTO #Distribution SELECT A2.aaSubLedgerHdrID, A2.aaSubLedgerDistID, A2.aaSubLedgerAssignID, A1.ACTINDX, 5,0, A2.CRDTAMNT, A2.DEBITAMT, A2.ORCRDAMT, A2.ORDBTAMT FROM AAG20002 A2  INNER JOIN AAG20001 A1 on A2.aaSubLedgerHdrID = A1.aaSubLedgerHdrID AND A1.aaSubLedgerDistID = A2.aaSubLedgerDistID  WHERE   A2.aaSubLedgerHdrID = (SELECT TOP 1 aaSubLedgerHdrID FROM AAG20000 WHERE SERIES = 3 and DOCTYPE IN (1,3,4,5) AND DOCNUMBR = @APTODCNM)  AND DISTTYPE = 5  END   FETCH NEXT FROM Cursor1 INTO @APTODCNM, @APPTOAMT, @ORAPTOAM, @DISAVTKN, @ORDISTKN  END  CLOSE Cursor1  DEALLOCATE Cursor1   UPDATE #Distribution SET aaPerc =   CASE (a.ORCRDAMT+a.ORDBTAMT)   WHEN 0 THEN   (a.CRDTAMNT+a.DEBITAMT) * 10000/(SELECT SUM(b.CRDTAMNT+b.DEBITAMT)   FROM #Distribution b WHERE b.ACTINDX= a.ACTINDX and b.DISTTYPE =a.DISTTYPE GROUP BY ACTINDX, DISTTYPE)   ELSE (a.ORCRDAMT+a.ORDBTAMT) * 10000/(SELECT SUM(b.ORCRDAMT+b.ORDBTAMT)   FROM #Distribution b WHERE b.ACTINDX= a.ACTINDX and b.DISTTYPE =a.DISTTYPE GROUP BY ACTINDX, DISTTYPE)   END  FROM #Distribution a    DECLARE Cursor2 CURSOR LOCAL FAST_FORWARD FOR   SELECT aaSubLedgerDistID, ACTINDX, CRDTAMNT, DEBITAMT, ORCRDAMT, ORDBTAMT, DISTTYPE FROM AAG20001 where aaSubLedgerHdrID = @aaSubLedgerHdrID AND DISTTYPE IN (3,5) AND CRDTAMNT <> 0.01 AND DEBITAMT <> 0.01  OPEN Cursor2  FETCH NEXT FROM Cursor2 INTO @aaSubLedgerDistID, @ACTINDX, @CRDTAMNT, @DEBITAMT, @ORCRDAMT, @ORDBTAMT, @DISTTYPE  WHILE @@FETCH_STATUS = 0  BEGIN  EXEC aagGetClassIDBrowseType   @ACTINDX,   @ClassID OUTPUT,   @aaBrowseTypeNew OUTPUT    DELETE FROM AAG20003 where aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID  DELETE FROM AAG20002 where aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID   DECLARE Assign CURSOR LOCAL FOR  SELECT HdrID, DistID, AssignID, aaPerc, CRDTAMNT, DEBITAMT, ORCRDAMT, ORDBTAMT FROM #Distribution WHERE ACTINDX= @ACTINDX and DISTTYPE = @DISTTYPE ORDER BY ACTINDX, DISTTYPE ASC  OPEN Assign  FETCH NEXT FROM Assign INTO @OLDaaSubLedgerHdrID, @OLDaaSubLedgerDistID, @OLDaaSubLedgerAssignID, @OLDaaAssignedPercent, @AssignCRDTAMNT, @AssignDEBITAMT, @AssignORCRDTAMNT, @AssignORDBTAMT  WHILE @@FETCH_STATUS = 0   BEGIN   SELECT @aaSubLedgerAssignID = ISNULL(MAX(A22.aaSubLedgerAssignID),0) + 1 FROM AAG20002 A22  WHERE A22.aaSubLedgerHdrID = @aaSubLedgerHdrID AND A22.aaSubLedgerDistID = @aaSubLedgerDistID   IF (@CRDTAMNT + @DEBITAMT) < (SELECT SUM(b.CRDTAMNT+b.DEBITAMT) FROM #Distribution b WHERE b.ACTINDX= @ACTINDX and b.DISTTYPE = @DISTTYPE GROUP BY ACTINDX, DISTTYPE)  BEGIN  SELECT @DummyDBTAMT =  @AssignCRDTAMNT, @DummyCRDTAMT =  @AssignDEBITAMT, @DummyORDBTAMT =  @AssignORCRDTAMNT, @DummyORCRDTAMT =  @AssignORDBTAMT   INSERT INTO AAG20002  (aaSubLedgerHdrID, aaSubLedgerDistID, aaSubLedgerAssignID, DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT,   aaAssignedPercent, DistRef, NOTEINDX, aaAssignErrors, aaAliasID)  SELECT @aaSubLedgerHdrID, @aaSubLedgerDistID, @aaSubLedgerAssignID,  CASE @DEBITAMT WHEN 0 then 0 else ISNULL(ROUND(@DEBITAMT*@OLDaaAssignedPercent/10000,2),0) END,   CASE @CRDTAMNT WHEN 0 then 0 else ISNULL(ROUND(@CRDTAMNT*@OLDaaAssignedPercent/10000,2),0) END,   CASE @ORDBTAMT WHEN 0 then 0 else ISNULL(ROUND(@ORDBTAMT*@OLDaaAssignedPercent/10000,2),0) END,   CASE @ORCRDAMT WHEN 0 then 0 else ISNULL(ROUND(@ORCRDAMT*@OLDaaAssignedPercent/10000,2),0) END,   0, DistRef, NOTEINDX, aaAssignErrors, aaAliasID   FROM AAG20002   WHERE aaSubLedgerHdrID = @OLDaaSubLedgerHdrID AND aaSubLedgerDistID=@OLDaaSubLedgerDistID AND aaSubLedgerAssignID = @OLDaaSubLedgerAssignID  END  ELSE IF(@CRDTAMNT + @DEBITAMT) >= (SELECT SUM(b.CRDTAMNT+b.DEBITAMT) FROM #Distribution b WHERE b.ACTINDX= @ACTINDX and b.DISTTYPE = @DISTTYPE GROUP BY ACTINDX, DISTTYPE)  BEGIN  SELECT @DummyDBTAMT =  @AssignCRDTAMNT, @DummyCRDTAMT =  @AssignDEBITAMT, @DummyORDBTAMT =  @AssignORCRDTAMNT, @DummyORCRDTAMT =  @AssignORDBTAMT   INSERT INTO AAG20002  (aaSubLedgerHdrID, aaSubLedgerDistID, aaSubLedgerAssignID, DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT,   aaAssignedPercent, DistRef, NOTEINDX, aaAssignErrors, aaAliasID)  SELECT @aaSubLedgerHdrID, @aaSubLedgerDistID, @aaSubLedgerAssignID,  CASE @DEBITAMT WHEN 0 then 0 else ISNULL(@DummyDBTAMT,0) END,   CASE @CRDTAMNT WHEN 0 then 0 else ISNULL(@DummyCRDTAMT,0) END,   CASE @ORDBTAMT WHEN 0 then 0 else ISNULL(@DummyORDBTAMT,0) END,   CASE @ORCRDAMT WHEN 0 then 0 else ISNULL(@DummyORCRDTAMT,0) END,   0, DistRef, NOTEINDX, aaAssignErrors, aaAliasID   FROM AAG20002   WHERE aaSubLedgerHdrID = @OLDaaSubLedgerHdrID AND aaSubLedgerDistID=@OLDaaSubLedgerDistID AND aaSubLedgerAssignID = @OLDaaSubLedgerAssignID   END  INSERT INTO AAG20003 ([aaSubLedgerHdrID], [aaSubLedgerDistID], [aaSubLedgerAssignID], [aaTrxDimID], [aaTrxCodeID], [aaCodeErrors])  SELECT @aaSubLedgerHdrID, @aaSubLedgerDistID, @aaSubLedgerAssignID, [aaTrxDimID], [aaTrxCodeID], [aaCodeErrors]  FROM AAG20003  WHERE aaSubLedgerHdrID = @OLDaaSubLedgerHdrID AND aaSubLedgerDistID=@OLDaaSubLedgerDistID AND aaSubLedgerAssignID = @OLDaaSubLedgerAssignID   FETCH NEXT FROM Assign INTO @OLDaaSubLedgerHdrID, @OLDaaSubLedgerDistID, @OLDaaSubLedgerAssignID, @OLDaaAssignedPercent, @AssignCRDTAMNT, @AssignDEBITAMT, @AssignORCRDTAMNT, @AssignORDBTAMT  END  CLOSE Assign  DEALLOCATE Assign   UPDATE AAG20002 SET aaAssignedPercent = CASE (ORCRDAMT+ORDBTAMT)   WHEN 0 THEN ROUND(((CRDTAMNT+DEBITAMT)* 10000)/(@CRDTAMNT+@DEBITAMT),2)  ELSE ROUND(((ORCRDAMT+ORDBTAMT)* 10000)/(@ORCRDAMT+@ORDBTAMT),2)   END  WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID  SET @AssignPercent = (SELECT SUM(aaAssignedPercent) FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID)  IF @AssignPercent <> 0 AND @AssignPercent > 9900   UPDATE AAG20002 SET aaAssignedPercent = aaAssignedPercent + (10000 - @AssignPercent),  CRDTAMNT= CRDTAMNT+(SELECT a1.CRDTAMNT - SUM(a2.CRDTAMNT) FROM AAG20002 a2 Inner JOIN AAG20001 a1 ON a2.aaSubLedgerHdrID = a1.aaSubLedgerHdrID AND a2.aaSubLedgerDistID = a1.aaSubLedgerDistID AND a2.aaSubLedgerHdrID = @aaSubLedgerHdrID AND a2.aaSubLedgerDistID=@aaSubLedgerDistID GROUP BY a1.CRDTAMNT),  ORCRDAMT= ORCRDAMT+(SELECT a1.ORCRDAMT - SUM(a2.ORCRDAMT) FROM AAG20002 a2 Inner JOIN AAG20001 a1 ON a2.aaSubLedgerHdrID = a1.aaSubLedgerHdrID AND a2.aaSubLedgerDistID = a1.aaSubLedgerDistID AND a2.aaSubLedgerHdrID = @aaSubLedgerHdrID AND a2.aaSubLedgerDistID=@aaSubLedgerDistID GROUP BY a1.ORCRDAMT),  DEBITAMT= DEBITAMT+(SELECT a1.DEBITAMT - SUM(a2.DEBITAMT) FROM AAG20002 a2 Inner JOIN AAG20001 a1 ON a2.aaSubLedgerHdrID = a1.aaSubLedgerHdrID AND a2.aaSubLedgerDistID = a1.aaSubLedgerDistID AND a2.aaSubLedgerHdrID = @aaSubLedgerHdrID AND a2.aaSubLedgerDistID=@aaSubLedgerDistID GROUP BY a1.DEBITAMT),  ORDBTAMT= ORDBTAMT+(SELECT a1.ORDBTAMT - SUM(a2.ORDBTAMT) FROM AAG20002 a2 Inner JOIN AAG20001 a1 ON a2.aaSubLedgerHdrID = a1.aaSubLedgerHdrID AND a2.aaSubLedgerDistID = a1.aaSubLedgerDistID AND a2.aaSubLedgerHdrID = @aaSubLedgerHdrID AND a2.aaSubLedgerDistID=@aaSubLedgerDistID GROUP BY a1.ORDBTAMT)  FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND   aaSubLedgerDistID = @aaSubLedgerDistID AND aaSubLedgerAssignID = @aaSubLedgerAssignID    ELSE IF (@AssignPercent > 0 AND @AssignPercent < 9900) or @AssignPercent is null  BEGIN  SELECT @aaSubLedgerAssignID = ISNULL(MAX(A22.aaSubLedgerAssignID),0) + 1 FROM AAG20002 A22  WHERE A22.aaSubLedgerHdrID = @aaSubLedgerHdrID AND A22.aaSubLedgerDistID = @aaSubLedgerDistID   SELECT @TotalORCRDTAMT = ISNULL(SUM(ORCRDAMT),0), @TotalCRDTAMT = ISNULL(SUM(CRDTAMNT),0), @TotalPrec = ISNULL(SUM(aaAssignedPercent),0),  @TotalORDBTAMT = ISNULL(SUM(ORDBTAMT),0), @TotalDEBITAMT = ISNULL(SUM(DEBITAMT),0) FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID=@aaSubLedgerDistID  EXEC DYNAMICS.dbo.smGetNextNoteIndex @CompanyID, @SqlSessionID, @NOTEINDX output   INSERT INTO AAG20002 ([aaSubLedgerHdrID], [aaSubLedgerDistID], [aaSubLedgerAssignID], [DEBITAMT], [CRDTAMNT],   [ORDBTAMT], [ORCRDAMT], [aaAssignedPercent], [DistRef], [NOTEINDX], [aaAssignErrors])  VALUES(@aaSubLedgerHdrID, @aaSubLedgerDistID, @aaSubLedgerAssignID, @DEBITAMT- @TotalDEBITAMT, @CRDTAMNT- @TotalCRDTAMT,   @ORDBTAMT - @TotalORDBTAMT, @ORCRDAMT- @TotalORCRDTAMT, 10000 - @TotalPrec, '', @NOTEINDX, 0)   IF @aaBrowseTypeNew <> 0   AND NOT EXISTS  (SELECT 1 FROM AAG20003  WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID  AND aaSubLedgerDistID = @aaSubLedgerDistID  AND aaSubLedgerAssignID = @aaSubLedgerAssignID)  BEGIN   EXEC aagSubWorkCodeUpdate   @aaSubLedgerHdrID,   @aaSubLedgerDistID,   @aaSubLedgerAssignID,   @ClassID,   @oRequiredFieldEmpty OUTPUT   END  END  DELETE FROM #Distribution WHERE ACTINDX= @ACTINDX and DISTTYPE = @DISTTYPE   FETCH NEXT FROM Cursor2 INTO @aaSubLedgerDistID, @ACTINDX, @CRDTAMNT, @DEBITAMT, @ORCRDAMT, @ORDBTAMT, @DISTTYPE  END  CLOSE Cursor2  DEALLOCATE Cursor2 DROP TABLE #Distribution END   
GO
GRANT EXECUTE ON  [dbo].[aagUpdateCashRecieptsDistwithINVAACodes] TO [DYNGRP]
GO
