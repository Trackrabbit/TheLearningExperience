SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_util_Fix_Liab_Month] AS declare @ContractNumber char(11) declare @LIABILITYTYPE smallint declare @BILCYC smallint declare @LIABILITY tinyint declare @Total numeric(19,5) declare @LiabilityAmount numeric(19,5) declare @LiabilityLeft numeric(19,5) declare @LiabilityBilled numeric(19,5) declare @LiabilityMonths smallint declare @LiabilityMonthsBilled smallint declare @LiabilityMonthsRemaining smallint declare @LiabilityDate datetime  declare @NextLiabilityDate datetime  declare @LastLiabilityDate datetime declare @ContractStartDate datetime declare @ContractEndDate datetime declare @Discount numeric(19,5) declare @DiscountNext numeric(19,5) declare @LineSeq numeric(19,5) declare @OrigTotal numeric(19,5) declare @OrigLiabilityAmount numeric(19,5) declare @OrigLiabilityBilled numeric(19,5) declare @OrigTotLiabilityAmount numeric(19,5) declare @OrigDiscount numeric(19,5) declare @OrigDiscountNext numeric(19,5)  update SVC00601 set Liability_Amount = (TOTAL - Total_Liability_Billed) ,  Total_Liability_Amount = (TOTAL - Total_Liability_Billed)  where CONSTS=2 and SVC_Liability_Type = 1 and BILCYC > 1 and Contract_Line_Status > 'E'  and Liability_Months = 1 and (TOTAL <> (Liability_Amount + Total_Liability_Billed)) and TOTAL > 0   declare Cont_Liab cursor for   select CONTNBR,LNSEQNBR,SVC_Liability_Type,BILCYC,Liabiltiy_Reduction,TOTAL,Liability_Amount,  Total_Liability_Amount,Total_Liability_Billed,Liability_Months, Next_Liability_Date,  Last_Liability_Date,STRTDATE,ENDDATE,DSCDLRAM,  ORIGTOTAL,Orig_Liability_Amount,OrigTotLiabilityAmount,OrigTotLiabBilled,ORDDLRAT,OrigDiscountNext  from SVC00601 where CONSTS=2 and SVC_Liability_Type = 1 and BILCYC > 1 and Contract_Line_Status > 'E'   and TOTAL > 0.0 and (Liabiltiy_Reduction = 0 or Liability_Months = 0 or Liability_Amount = 0.0) and Total_Liability_Billed < TOTAL  open Cont_Liab   fetch next from Cont_Liab into @ContractNumber,@LineSeq,@LIABILITYTYPE, @BILCYC,  @LIABILITY,@Total,@LiabilityAmount,@LiabilityLeft,@LiabilityBilled,@LiabilityMonths,  @NextLiabilityDate,@LastLiabilityDate,@ContractStartDate,@ContractEndDate,@Discount,  @OrigTotal, @OrigLiabilityAmount,@OrigTotLiabilityAmount,@OrigLiabilityBilled,@OrigDiscount,@OrigDiscountNext  while @@FETCH_STATUS = 0  BEGIN  if (@LiabilityAmount = 0 or @LiabilityMonths = 0) and @LiabilityBilled < @Total   BEGIN  exec SVC_GetLiabilityMonths @ContractStartDate,@ContractEndDate,@LiabilityMonths OUTPUT  exec SVC_GetLiabilityMonths @ContractStartDate,@LastLiabilityDate,@LiabilityMonthsBilled OUTPUT  if @LastLiabilityDate = '1900-01-01'   BEGIN  select  @LiabilityMonthsBilled = 0  select @LiabilityDate = @ContractStartDate   exec SVC_EOM @LiabilityDate output   select @NextLiabilityDate = @LiabilityDate  END  else  BEGIN  select @NextLiabilityDate = DATEADD(mm,1,@LastLiabilityDate)  END  select @LiabilityMonthsRemaining = @LiabilityMonths - @LiabilityMonthsBilled  select @LiabilityLeft = @Total - @LiabilityBilled  select @OrigTotLiabilityAmount = @OrigTotal - @OrigLiabilityBilled  if @LiabilityMonthsRemaining = 0   select @LiabilityMonthsRemaining = 1    select @LiabilityAmount = Round((@LiabilityLeft / @LiabilityMonthsRemaining),2)  select @OrigLiabilityAmount = Round((@OrigTotLiabilityAmount / @LiabilityMonthsRemaining),2)   select @DiscountNext = round((@Discount / @LiabilityMonths),2)  select @OrigLiabilityAmount = Round((@OrigTotal / @LiabilityMonths),2)  select @OrigDiscountNext = Round((@OrigDiscount / @LiabilityMonths),2)  select @LiabilityMonths =  round((@LiabilityLeft / @LiabilityAmount),0)  UPDATE SVC00601 SET   Liabiltiy_Reduction = 1,  Liability_Amount = @LiabilityAmount,  Orig_Liability_Amount = @OrigLiabilityAmount,  Liability_Months = @LiabilityMonthsRemaining,  Next_Liability_Date = @NextLiabilityDate,  SVC_Discount_Next = @DiscountNext,  Total_Liability_Amount = @LiabilityLeft,  OrigTotLiabilityAmount = @OrigTotLiabilityAmount,  OrigDiscountNext = @OrigDiscountNext  where CONSTS = 2 and CONTNBR = @ContractNumber and LNSEQNBR = @LineSeq   END  fetch next from Cont_Liab into @ContractNumber,@LineSeq,@LIABILITYTYPE, @BILCYC,  @LIABILITY,@Total,@LiabilityAmount,@LiabilityLeft,@LiabilityBilled,@LiabilityMonths,  @NextLiabilityDate,@LastLiabilityDate,@ContractStartDate,@ContractEndDate,@Discount,  @OrigTotal, @OrigLiabilityAmount,@OrigTotLiabilityAmount,@OrigLiabilityBilled,@OrigDiscount,@OrigDiscountNext  END  deallocate Cont_Liab     
GO
GRANT EXECUTE ON  [dbo].[SVC_util_Fix_Liab_Month] TO [DYNGRP]
GO
