SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[wfFillInfobarTempTable]  @WorkflowInstanceID char(37),  @Workflow_User char(85),  @Workflow_Document_Table varchar(128),  @Workflow_Type_Name char(51),  @WfBusObjKey char(201),  @Record_Count int OUTPUT,  @Workflow_Error int OUTPUT  AS  BEGIN SET NOCOUNT ON   declare @number_of_assignees int  declare @is_user_assigned_task tinyint  declare @WorkflowStepInstanceID char(37)  declare @WorkflowTaskAssignedTo char(85)  declare @Workflow_Name char(51), @Workflow_Step_Name char(51)  declare @SQL_Text1 varchar(8000),  @SQL_Text2 varchar(8000)  declare @Workflow_Due_Date datetime, @Workflow_Due_Time datetime   select @WorkflowInstanceID=UPPER(@WorkflowInstanceID)  select @Workflow_User=UPPER(@Workflow_User)  select @SQL_Text1='', @SQL_Text2='', @Workflow_Error=0  create table #doc_steps_table  (Workflow_User char(85), WorkflowInstanceID char(37),  WorkflowStepInstanceID char(37),   Workflow_Name char(51), Workflow_Step_Name char(51),  WF_Step_Predecessor char(51), Workflow_Step_Sequence int,  Workflow_Task_Assigned tinyint, Number_of_Assignees int,   Workflow_Due_Date datetime, Workflow_Due_Time datetime,  WorkflowTaskAssignedTo char(85), Workflow_Type_Name char(51), WfBusObjKey char(201))   insert into #doc_steps_table   select @Workflow_User as Workflow_User,  @WorkflowInstanceID as WorkflowInstanceID,  WorkflowStepInstanceID as WorkflowStepInstanceID,  Workflow_Name as Workflow_Name,  Workflow_Step_Name as Workflow_Step_Name,  WF_Step_Predecessor as WF_Step_Predecessor,   Workflow_Step_Sequence as Workflow_Step_Sequence,  0 as Workflow_Task_Assigned, 0 as Number_of_Assignees,  '' as Workflow_Due_Date, '' as Workflow_Due_Time, '' as WorkflowTaskAssignedTo,  @Workflow_Type_Name as Workflow_Type_Name,  @WfBusObjKey as WfBusObjKey  from WFI10003   where WorkflowInstanceID=@WorkflowInstanceID and Workflow_Step_Status=2   declare DOC_STEPS cursor local fast_forward  for  select Workflow_User, WorkflowStepInstanceID, Workflow_Step_Name from #doc_steps_table  open DOC_STEPS  fetch next from DOC_STEPS into @Workflow_User, @WorkflowStepInstanceID, @Workflow_Step_Name  while @@FETCH_STATUS=0  begin  select @is_user_assigned_task=0  select @number_of_assignees=COUNT(WorkflowStepInstanceID) from WFI10004   where WorkflowStepInstanceID=@WorkflowStepInstanceID and Workflow_Action_Date=''   if (select COUNT(WorkflowStepInstanceID) from WFI10004   where WorkflowStepInstanceID=@WorkflowStepInstanceID and Workflow_Action_Date=''  and UPPER(WorkflowTaskAssignedTo)=@Workflow_User)>0  begin  select @is_user_assigned_task=1  end   if @number_of_assignees>0  begin  if @number_of_assignees=1  begin  select top 1 @Workflow_Due_Date=Workflow_Due_Date,@Workflow_Due_Time=Workflow_Due_Time,  @WorkflowTaskAssignedTo=WorkflowTaskAssignedTo from WFI10004  where WorkflowStepInstanceID=@WorkflowStepInstanceID and Workflow_Action_Date=''  end  else  begin  select top 1 @Workflow_Due_Date=Workflow_Due_Date,@Workflow_Due_Time=Workflow_Due_Time  from WFI10004  where WorkflowStepInstanceID=@WorkflowStepInstanceID and Workflow_Action_Date=''  select @WorkflowTaskAssignedTo=''  end  update #doc_steps_table set Workflow_Task_Assigned=@is_user_assigned_task, Number_of_Assignees=@number_of_assignees,  Workflow_Due_Date=@Workflow_Due_Date, Workflow_Due_Time=@Workflow_Due_Time,  WorkflowTaskAssignedTo=@WorkflowTaskAssignedTo  where UPPER(Workflow_User)=@Workflow_User and WorkflowStepInstanceID=@WorkflowStepInstanceID  end  else  begin  update #doc_steps_table set Workflow_Task_Assigned=@is_user_assigned_task, Number_of_Assignees=@number_of_assignees  where UPPER(Workflow_User)=@Workflow_User and WorkflowStepInstanceID=@WorkflowStepInstanceID  end   fetch next from DOC_STEPS into @Workflow_User, @WorkflowStepInstanceID, @Workflow_Step_Name  end  close DOC_STEPS  deallocate DOC_STEPS   select @Record_Count = COUNT(*) from #doc_steps_table   select @SQL_Text1 = 'delete from '+@Workflow_Document_Table+' where Workflow_User = '''+rtrim(@Workflow_User)+''' '  select @SQL_Text2 = 'insert into '+@Workflow_Document_Table+  ' select Workflow_User, WorkflowInstanceID, WorkflowStepInstanceID, '+  ' Workflow_Name, Workflow_Step_Name, '+  ' WF_Step_Predecessor, Workflow_Step_Sequence, '+  ' Workflow_Task_Assigned, Number_of_Assignees, '+  ' Workflow_Due_Date, Workflow_Due_Time, WorkflowTaskAssignedTo, '+  ' Workflow_Type_Name, WfBusObjKey from #doc_steps_table '+  ' order by Workflow_User, Workflow_Task_Assigned desc, Workflow_Due_Date, Workflow_Due_Time, '+  ' WF_Step_Predecessor, Workflow_Step_Sequence '   exec (@SQL_Text1)  exec (@SQL_Text2)  if object_id('tempdb..#doc_steps_table') is not null drop table #doc_steps_table END   
GO
GRANT EXECUTE ON  [dbo].[wfFillInfobarTempTable] TO [DYNGRP]
GO
