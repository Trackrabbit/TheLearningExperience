SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[rmHistoricalAgedTrialBalance]  @I_cCustomerTemp char(25)        = NULL,  @I_cDocumentTemp char(25)        = NULL,  @I_cApplyTemp char(25)        = NULL,  @I_cCustListTemp char(25) = NULL,  @I_dAgingDate datetime = NULL,  @I_cStartCustomerNumber         char(15)        = NULL,  @I_cEndCustomerNumber     char(15)        = NULL,  @I_cStartCustomerName           char(65) = NULL,  @I_cEndCustomerName             char(65) = NULL,  @I_cStartClassID                char(15) = NULL,  @I_cEndClassID                  char(15) = NULL,  @I_cStartSalesPersonID char(15) = NULL,  @I_cEndSalesPersonID char(15) = NULL,  @I_cStartSalesTerritory char(15) = NULL,  @I_cEndSalesTerritory char(15) = NULL,  @I_cStartShortName char(15) = NULL,  @I_cEndShortName char(15) = NULL,  @I_cStartState char(5)  = NULL,  @I_cEndState char(5)  = NULL,  @I_cStartZipCode char(11) = NULL,  @I_cEndZipCode char(11) = NULL,  @I_cStartPhoneNumber char(21) = NULL,  @I_cEndPhoneNumber char(21) = NULL,  @I_cStartUserDefined     char(15)        = NULL,  @I_cEndUserDefined              char(15)        = NULL,  @I_sCustomerSort smallint = NULL,  @I_sDocumentSort smallint = NULL,  @I_tUsingDocumentDate tinyint  = NULL,  @I_dStartDate datetime = NULL,  @I_dEndDate datetime = NULL,  @I_sIncludeBalanceTypes smallint = NULL,  @I_tExcludeNoActivity tinyint  = NULL,  @I_tExcludeMultiCurrency tinyint  = NULL,  @I_tExcludeZeroBalanceCustomer tinyint  = NULL,  @I_tExcludeFullyPaidTrxs tinyint  = NULL,  @I_tExcludeCreditBalance tinyint  = NULL,  @I_tExcludeUnpostedAppldCrDocs  tinyint  = NULL,  @I_tConsolidateNAActivity tinyint  = NULL,  @I_cFunctionalCurrency char(15) = NULL,  @I_tMCRegistered tinyint  = NULL,  @I_sPrintCurrencyIn smallint = NULL,  @I_nReportingExchangeRate numeric(15,7) = NULL,  @I_sReportingRateCalcMethod smallint = NULL,  @I_sReportingDecimalPlaces smallint = NULL,  @I_tEuroEnabled tinyint  = NULL,  @O_iErrorState                  int             = NULL output as  declare  @TRUE smallint,  @cStartCustomerNumber char(32),  @cEndCustomerNumber char(32),  @cStartCustomerName char(132),  @cEndCustomerName char(132),  @cStartClassID char(32),  @cEndClassID char(32),  @cStartSalesPersonID char(32),  @cEndSalesPersonID char(32),  @cStartSalesTerritory char(32),  @cEndSalesTerritory char(32),  @cStartShortName char(32),  @cEndShortName char(32),  @cStartState char(12),  @cEndState char(12),  @cStartZipCode char(24),  @cEndZipCode char(24),  @cStartPhoneNumber char(44),  @cEndPhoneNumber char(44),  @cStartUserDefined char(32),  @cEndUserDefined char(32),  @tLoopControl           tinyint,  @iStatus                int,  @iError                 int  select  @iStatus = 0,  @O_iErrorState = 0  select  @TRUE  = 1  create table #TransactionTEMP(  CustomerNumber char(15) not null,  ChildCustomerNumber  char(15) not null,  DocumentNumber char(21) not null,  RMDocumentTypeAll smallint not null,  CurrentTrxAmount numeric(19,5) not null,  OriginalTrxAmount numeric(19,5) not null,  DiscountTakenAmount numeric(19,5) not null,  DiscountAvailableAmount numeric(19,5) not null,  WriteoffAmount numeric(19,5) not null,  SalesAmount numeric(19,5) not null,  CostAmount numeric(19,5) not null,  FreightAmount numeric(19,5) not null,  MiscAmount numeric(19,5) not null,  TaxAmount numeric(19,5) not null,  CommissionDollarAmount numeric(19,5) not null,  CashAmount numeric(19,5) not null,  RevalDocAmountAdj numeric(19,5) not null,  RevalDiscAmountAvailAdj numeric(19,5) not null,  RevalCurrentTrxAmountAdj numeric(19,5) not null,  DocumentDate datetime not null,  DueDate datetime not null,  DiscountDate datetime not null,  PostDate datetime not null,  GLPostingDate datetime not null,  DateInvoicePaidOff datetime not null,  CheckNumber char(21) not null,  TransactionDescription char(31) not null,  CustPurchaseOrderNumber char(21) not null,  SalesPersonID char(15) not null,  SalesTerritoryCode char(15) not null,  Description char(31) not null,  CurrencyID char(15) not null,  CurrencyIndex smallint not null,  ExchangeRate numeric(15,7) not null,  DenominationExchangeRate numeric(15,7) not null,  MCTransactionState smallint not null,  OrigOriginalTrxAmount numeric(19,5) not null,  OrigDiscTakenAmount numeric(19,5) not null,  OrigCurrentTrxAmount numeric(19,5) not null,  OrigDiscAvailableAmount numeric(19,5) not null,  OrigWriteoffAmount numeric(19,5) not null,  OrigSalesAmount numeric(19,5) not null,  OrigCostAmount numeric(19,5) not null,  OrigFreightAmount numeric(19,5) not null,  OrigMiscAmount numeric(19,5) not null,  OrigTaxAmount numeric(19,5) not null,  OrigCashAmount numeric(19,5) not null,  OrigApplyToRndAmt numeric(19,5) not null,  CustomerType tinyint not null,  Status tinyint not null,  AgingPeriod smallint not null,  VoidStatus tinyint not null )  create table #AppliedTEMP(  ApplyToDocumentNumber char(21) not null,  ApplyToDocumentTypeAll smallint not null,  DocumentNumber char(21) not null,  RMDocumentTypeAll smallint not null,  DocumentDate datetime not null,  AppliedAmount numeric(19,5) not null,  RealizedGainLossAmount numeric(19,5) not null,  OrigAppliedAmount numeric(19,5) not null,  OrigDiscTakenAmount numeric(19,5) not null,  OrigWriteoffAmount numeric(19,5) not null,  OrigApplyToRndAmt numeric(19,5) not null,  CurrencyID char(15) not null,  CurrencyIndex smallint not null,  ExchangeRate numeric(15,7) not null,  DenominationExchangeRate numeric(15,7) not null,  MCTransactionState smallint not null,  DiscountTakenAmount numeric(19,5) not null,  GSTDiscountAmount numeric(19,5) not null,  WriteoffAmount numeric(19,5) not null,  PPSAmount numeric(19,5) not null,  AgingPeriod smallint not null,  Posted tinyint not null,  MCSpecialCase tinyint not null)  create table #EndingPeriodDates (  PERIODID  int   not null,  BALANCETYPE tinyint not null,  STARTDATE datetime not null,  ENDDATE datetime not null)  while @tLoopControl is NULL begin  select @tLoopControl = 1   if @I_cCustomerTemp is NULL or  @I_cDocumentTemp is NULL or  @I_cApplyTemp is NULL or  @I_cCustListTemp is NULL or  @I_dAgingDate is NULL or  @I_cStartCustomerNumber is NULL or  @I_cEndCustomerNumber is NULL or  @I_cStartCustomerName is NULL or  @I_cEndCustomerName is NULL or  @I_cStartClassID                is NULL or  @I_cEndClassID is NULL or  @I_cStartSalesPersonID is NULL or  @I_cEndSalesPersonID is NULL or  @I_cStartSalesTerritory is NULL or  @I_cEndSalesTerritory is NULL or  @I_cStartShortName is NULL or  @I_cEndShortName is NULL or  @I_cStartState is NULL or  @I_cEndState is NULL or  @I_cStartZipCode is NULL or  @I_cEndZipCode is NULL or  @I_cStartPhoneNumber is NULL or  @I_cEndPhoneNumber is NULL or  @I_cStartUserDefined     is NULL or  @I_cEndUserDefined              is NULL or  @I_sCustomerSort is NULL or  @I_sDocumentSort is NULL or  @I_tUsingDocumentDate is NULL or  @I_dStartDate is NULL or  @I_dEndDate is NULL or  @I_sIncludeBalanceTypes is NULL or  @I_tExcludeNoActivity is NULL or  @I_tExcludeMultiCurrency is NULL or  @I_tExcludeZeroBalanceCustomer is NULL or  @I_tExcludeFullyPaidTrxs is NULL or  @I_tExcludeCreditBalance is NULL or  @I_tExcludeUnpostedAppldCrDocs is NULL or  @I_tConsolidateNAActivity is NULL or  @I_cFunctionalCurrency is NULL or  @I_tMCRegistered is NULL or  @I_sPrintCurrencyIn is NULL or  @I_nReportingExchangeRate is NULL or  @I_sReportingRateCalcMethod is NULL or  @I_sReportingDecimalPlaces is NULL or  @I_tEuroEnabled is NULL  begin  select @O_iErrorState = 20969  break  end    Exec @iStatus = rmHATBFormatStringsForExecs  @I_cStartCustomerNumber,  @I_cEndCustomerNumber,  @I_cStartCustomerName,  @I_cEndCustomerName,  @I_cStartClassID,  @I_cEndClassID,  @I_cStartSalesPersonID,  @I_cEndSalesPersonID,  @I_cStartSalesTerritory,  @I_cEndSalesTerritory,  @I_cStartShortName,  @I_cEndShortName,  @I_cStartState,  @I_cEndState,  @I_cStartZipCode,  @I_cEndZipCode,  @I_cStartPhoneNumber,  @I_cEndPhoneNumber,  @I_cStartUserDefined,  @I_cEndUserDefined,  @cStartCustomerNumber output,  @cEndCustomerNumber output,  @cStartCustomerName output,  @cEndCustomerName output,  @cStartClassID output,  @cEndClassID output,  @cStartSalesPersonID output,  @cEndSalesPersonID output,  @cStartSalesTerritory output,  @cEndSalesTerritory output,  @cStartShortName output,  @cEndShortName output,  @cStartState output,  @cEndState output,  @cStartZipCode output,  @cEndZipCode output,  @cStartPhoneNumber output,  @cEndPhoneNumber output,  @cStartUserDefined output,  @cEndUserDefined output,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   Exec @iStatus = rmCreateAgingPeriodTable  @I_dAgingDate,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   if @I_tExcludeMultiCurrency = @TRUE  Exec @iStatus = rmHATBGetDocuments  @I_cCustListTemp,  @I_dAgingDate,  @I_tUsingDocumentDate,  @I_dStartDate,  @I_dEndDate,  @I_sIncludeBalanceTypes,  @I_sCustomerSort,  @cStartCustomerNumber,  @cEndCustomerNumber,  @cStartCustomerName,  @cEndCustomerName,  @cStartClassID,  @cEndClassID,  @cStartSalesPersonID,  @cEndSalesPersonID,  @cStartSalesTerritory,  @cEndSalesTerritory,  @cStartShortName,  @cEndShortName,  @cStartState,  @cEndState,  @cStartZipCode,  @cEndZipCode,  @cStartPhoneNumber,  @cEndPhoneNumber,  @cStartUserDefined,  @cEndUserDefined,  @I_tMCRegistered,  @I_sPrintCurrencyIn,  @I_nReportingExchangeRate,  @I_sReportingRateCalcMethod,  @I_sReportingDecimalPlaces,  @I_tConsolidateNAActivity,  @O_iErrorState output  else  Exec @iStatus = rmMCHATBGetDocuments  @I_cCustListTemp,  @I_dAgingDate,  @I_tUsingDocumentDate,  @I_dStartDate,  @I_dEndDate,  @I_sIncludeBalanceTypes,  @I_sCustomerSort,  @cStartCustomerNumber,  @cEndCustomerNumber,  @cStartCustomerName,  @cEndCustomerName,  @cStartClassID,  @cEndClassID,  @cStartSalesPersonID,  @cEndSalesPersonID,  @cStartSalesTerritory,  @cEndSalesTerritory,  @cStartShortName,  @cEndShortName,  @cStartState,  @cEndState,  @cStartZipCode,  @cEndZipCode,  @cStartPhoneNumber,  @cEndPhoneNumber,  @cStartUserDefined,  @cEndUserDefined,  @I_cFunctionalCurrency,  @I_tMCRegistered,  @I_sPrintCurrencyIn,  @I_nReportingExchangeRate,  @I_sReportingRateCalcMethod,  @I_sReportingDecimalPlaces,  @I_tConsolidateNAActivity,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   if @I_tExcludeFullyPaidTrxs = 1  begin  exec rmHATBRemoveSchpDocs  @I_dAgingDate,  @O_iErrorState   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break  end   if @I_tExcludeMultiCurrency = @TRUE  Exec @iStatus = rmHATBGetApplies  @I_tUsingDocumentDate,  @I_dStartDate,  @I_dEndDate,  @I_tExcludeUnpostedAppldCrDocs,  @I_tMCRegistered,  @I_sPrintCurrencyIn,  @I_nReportingExchangeRate,  @I_sReportingRateCalcMethod,  @I_sReportingDecimalPlaces,  @O_iErrorState output  else  Exec @iStatus = rmMCHATBGetApplies  @I_tUsingDocumentDate,  @I_dStartDate,  @I_dEndDate,  @I_tExcludeUnpostedAppldCrDocs,  @I_cFunctionalCurrency,  @I_tMCRegistered,  @I_sPrintCurrencyIn,  @I_nReportingExchangeRate,  @I_sReportingRateCalcMethod,  @I_sReportingDecimalPlaces,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   Exec @iStatus = rmHATBCalculateTotals  @I_tUsingDocumentDate,  @I_dStartDate,  @I_dEndDate,  @I_dAgingDate,  @I_tExcludeUnpostedAppldCrDocs,  @I_cFunctionalCurrency,  @I_tMCRegistered,  @I_sPrintCurrencyIn,  @I_nReportingExchangeRate,  @I_sReportingRateCalcMethod,  @I_sReportingDecimalPlaces,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   Exec @iStatus = rmHATBLoadDexTempTables  @I_cCustomerTemp,  @I_cDocumentTemp,  @I_cApplyTemp,  @I_cCustListTemp,  @I_sCustomerSort,  @I_sDocumentSort,  @I_sIncludeBalanceTypes,  @cStartCustomerNumber,  @cEndCustomerNumber,  @cStartCustomerName,  @cEndCustomerName,  @cStartClassID,  @cEndClassID,  @cStartSalesPersonID,  @cEndSalesPersonID,  @cStartSalesTerritory,  @cEndSalesTerritory,  @cStartShortName,  @cEndShortName,  @cStartState,  @cEndState,  @cStartZipCode,  @cEndZipCode,  @cStartPhoneNumber,  @cEndPhoneNumber,  @cStartUserDefined,  @cEndUserDefined,  @I_tExcludeNoActivity,  @I_tExcludeZeroBalanceCustomer,  @I_tExcludeFullyPaidTrxs,  @I_tExcludeCreditBalance,  @I_tExcludeMultiCurrency,  @I_tConsolidateNAActivity,  @O_iErrorState output  select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break  end   drop table #EndingPeriodDates  return (@iStatus)   
GO
GRANT EXECUTE ON  [dbo].[rmHistoricalAgedTrialBalance] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[rmHistoricalAgedTrialBalance] TO [rpt_accounting manager]
GO
GRANT EXECUTE ON  [dbo].[rmHistoricalAgedTrialBalance] TO [rpt_accounts receivable coordinator]
GO
GRANT EXECUTE ON  [dbo].[rmHistoricalAgedTrialBalance] TO [rpt_bookkeeper]
GO
GRANT EXECUTE ON  [dbo].[rmHistoricalAgedTrialBalance] TO [rpt_collections manager]
GO
GRANT EXECUTE ON  [dbo].[rmHistoricalAgedTrialBalance] TO [rpt_power user]
GO
