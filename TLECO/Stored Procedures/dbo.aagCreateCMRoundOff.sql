SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 Create PROCEDURE [dbo].[aagCreateCMRoundOff] @aaSubLedgerHdrID INT, @aaSEQNUMBR    INT, @ACTINDX INT AS BEGIN   DECLARE   @DEBITSUM NUMERIC(19,5),  @CRDTSUM NUMERIC(19,5),  @ROUNDDIFF NUMERIC(19,5),  @aaBrowseType smallint  SELECT   @DEBITSUM=SUM(DEBITAMT),  @CRDTSUM = SUM(CRDTAMNT)   FROM   AAG20001   WHERE   aaSubLedgerHdrID= @aaSubLedgerHdrID  if not exists(select 1 from AAG00200 where ACTINDX = @ACTINDX AND aaAcctClassID <> 0)  SELECT @aaBrowseType = 0  else  begin  if not exists(Select top 1 aaAcctClassID from AAG00202 where aaAcctClassID   in(select aaAcctClassID from AAG00200 where ACTINDX = @ACTINDX )  and aaTrxDimCodeIDDflt = 0 and aaDataEntry <> 1)  SELECT @aaBrowseType = 1  else  SELECT @aaBrowseType = 2  end  SET @ROUNDDIFF = @DEBITSUM - @CRDTSUM  IF @ROUNDDIFF < 0  BEGIN  INSERT INTO AAG20001  (aaSubLedgerHdrID,aaSubLedgerDistID,INTERID,CorrespondingUnit,ACTINDX,  DISTTYPE,ACCTTYPE,aaBrowseType,DECPLACS,DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,  SEQNUMBR,GLPOSTDT,aaCustID,aaVendID,aaSiteID,aaItemID,aaCopyStatus,  aaWinWasOpen,POSTED,HISTORY,aaDistErrors,APTVCHNM,APTODCTY,aaFutureDist,aaOffsetAcct,  ITEMNMBR,TRXLOCTN,BINNMBR,TRNSTLOC,TRXQTY,aaChangeDate,aaChangeTime)   (SELECT aaSubLedgerHdrID,aaSubLedgerDistID +1 ,INTERID,CorrespondingUnit,  @ACTINDX,DISTTYPE,1 as ACCTTYPE,@aaBrowseType,DECPLACS,ABS(@ROUNDDIFF),0,0,0,  @aaSEQNUMBR,GLPOSTDT,aaCustID,aaVendID,  aaSiteID,aaItemID,aaCopyStatus,aaWinWasOpen,POSTED,HISTORY,aaDistErrors,APTVCHNM,APTODCTY,aaFutureDist,  aaOffsetAcct,ITEMNMBR,TRXLOCTN,BINNMBR,TRNSTLOC,TRXQTY,aaChangeDate,aaChangeTime FROM AAG20001   WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID and  aaSubLedgerDistID =(SELECT MAX(aaSubLedgerDistID)FROM AAG20001 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID))   INSERT INTO AAG20002  (aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID,DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,  aaAssignedPercent,DistRef,NOTEINDX,aaAssignErrors,aaAliasID)  (SELECT Top 1 aaSubLedgerHdrID,aaSubLedgerDistID + 1,1 aaSubLedgerAssignID,ABS(@ROUNDDIFF),0,0,0,  10000 aaAssignedPercent,DistRef,NOTEINDX+1,aaAssignErrors, 0 aaAliasID FROM AAG20002   WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID and  aaSubLedgerDistID =(SELECT MAX(aaSubLedgerDistID)FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID))  END   ELSE IF @ROUNDDIFF > 0  BEGIN  INSERT INTO AAG20001  (aaSubLedgerHdrID,aaSubLedgerDistID,INTERID,CorrespondingUnit,ACTINDX,  DISTTYPE,ACCTTYPE,aaBrowseType,DECPLACS,DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,  SEQNUMBR,GLPOSTDT,aaCustID,aaVendID,aaSiteID,aaItemID,aaCopyStatus,  aaWinWasOpen,POSTED,HISTORY,aaDistErrors,APTVCHNM,APTODCTY,aaFutureDist,aaOffsetAcct,  ITEMNMBR,TRXLOCTN,BINNMBR,TRNSTLOC,TRXQTY,aaChangeDate,aaChangeTime)   (SELECT aaSubLedgerHdrID,aaSubLedgerDistID +1 ,INTERID,CorrespondingUnit,  @ACTINDX,DISTTYPE,1 as ACCTTYPE,@aaBrowseType,DECPLACS,0,@ROUNDDIFF,0,0,  @aaSEQNUMBR,GLPOSTDT,aaCustID,aaVendID,  aaSiteID,aaItemID,aaCopyStatus,aaWinWasOpen,POSTED,HISTORY,aaDistErrors,APTVCHNM,APTODCTY,aaFutureDist,  aaOffsetAcct,ITEMNMBR,TRXLOCTN,BINNMBR,TRNSTLOC,TRXQTY,aaChangeDate,aaChangeTime FROM AAG20001   WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID and  aaSubLedgerDistID =(SELECT MAX(aaSubLedgerDistID)FROM AAG20001 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID))   INSERT INTO AAG20002  (aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID,DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,  aaAssignedPercent,DistRef,NOTEINDX,aaAssignErrors,aaAliasID)  (SELECT Top 1 aaSubLedgerHdrID,aaSubLedgerDistID + 1,1 aaSubLedgerAssignID,0,@ROUNDDIFF,0,0,  10000 aaAssignedPercent,DistRef,NOTEINDX+1,aaAssignErrors, 0 aaAliasID FROM AAG20002   WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID and  aaSubLedgerDistID =(SELECT MAX(aaSubLedgerDistID)FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID))  END  END    
GO
GRANT EXECUTE ON  [dbo].[aagCreateCMRoundOff] TO [DYNGRP]
GO
