SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE Procedure [dbo].[SVC_Depot_Labor_Post]  (@WORECTYPE smallint,  @WORKORDNUM char(11),  @USERID char(15),  @RETERROR integer OUTPUT,  @RETERRTYPE integer OUTPUT) As declare @TECHID char(11) declare @STATIONID char(11) declare @NEXTSTATIONID char(11) declare @STARTDATE datetime declare @STARTTIME datetime declare @ENDDATE datetime declare @ENDTIME datetime declare @vSTARTDATETIME datetime declare @vENDDATETIME datetime declare @NEXTSTARTDATE datetime declare @NEXTSTARTTIME datetime declare @vNextStartTime datetime declare @WOSTAT char(3) declare @NEXTSEQUENCE numeric(19,5) declare @RETCODE integer declare @ERROR integer declare @ERRORTYPE integer declare @COMPSTAT char(3) declare @NOTEINDX numeric(19,5) declare @msg varchar(255) declare @NEXTRouteSEQUENCE numeric(19,5) if @WORECTYPE is null or @WORKORDNUM is null or @WORKORDNUM = ''  goto NO_WO if not exists(select * from SVC06103 where WORECTYPE = @WORECTYPE and   WORKORDNUM = @WORKORDNUM)   goto NO_WO select @WORKORDNUM = RTRIM(@WORKORDNUM) select @COMPSTAT = WOCOMPSTAT  from SVC00998 if @COMPSTAT is null  select @COMPSTAT = '' select @TECHID = TECHID,  @STATIONID = STATIONID,  @STARTDATE = STRTDATE,  @STARTTIME = STRTTIME,  @ENDDATE = ENDDATE,  @ENDTIME = ENDTIME,  @NOTEINDX = NOTEINDX   from SVC06103   where WORECTYPE = @WORECTYPE and  WORKORDNUM = @WORKORDNUM select @WOSTAT = WOSTAT  from SVC06100  where WORECTYPE = @WORECTYPE and  WORKORDNUM = @WORKORDNUM select count(*) from SVC00100 WHERE TECHID = @TECHID if @@ERROR <> 0 or @@ROWCOUNT = 0  goto NO_TECH select count(*) from SVC06001 WHERE STATIONID = @STATIONID if @@ERROR <> 0 or @@ROWCOUNT = 0  goto NO_STATION exec SVC_util_combine_date_time @STARTDATE, @STARTTIME, @vSTARTDATETIME OUTPUT exec SVC_util_combine_date_time @ENDDATE, @ENDTIME, @vENDDATETIME OUTPUT if @vENDDATETIME < @vSTARTDATETIME   goto BAD_TIME  BEGIN TRANSACTION  exec SVC_Create_Depot_Audit @WORECTYPE,  @WORKORDNUM,  @TECHID,  @WOSTAT,  @WOSTAT,  @STATIONID,  @USERID,  'Labor Posting'  update SVC06105 set Status = 3,  STRTDATE = @STARTDATE,   STRTTIME = @STARTTIME,   ENDDATE = @ENDDATE,   ENDTIME = @ENDTIME   where WORECTYPE = @WORECTYPE and   WORKORDNUM = @WORKORDNUM and   STATIONID = @STATIONID and  Status = 2  if @@ERROR <> 0 goto MISC_ERROR  delete SVC06300  where WORECTYPE = @WORECTYPE and   WORKORDNUM = @WORKORDNUM and   STATIONID = @STATIONID and  Status = 2  select @NEXTSTATIONID = STATIONID,   @NEXTSEQUENCE = SEQUENCE1,   @NEXTSTARTDATE = ETADTE,   @NEXTSTARTTIME = ETATME   from SVC06105   where WORECTYPE = @WORECTYPE and   WORKORDNUM = @WORKORDNUM and  SEQUENCE1 = (select MIN(SEQUENCE1)   from SVC06105 T2  where T2.WORECTYPE = @WORECTYPE and   T2.WORKORDNUM = @WORKORDNUM and   T2.Status <= 1)     update SVC06105 set Status = 1  where WORECTYPE = @WORECTYPE and   WORKORDNUM = @WORKORDNUM and   Status = 0 and   SEQUENCE1 = @NEXTSEQUENCE   UPDATE SVC06300 set Status = 1   where WORECTYPE = @WORECTYPE and   WORKORDNUM = @WORKORDNUM and  Route_Sequence = @NEXTSEQUENCE   if @NEXTSTATIONID is null   begin  select @NEXTSTATIONID = ''  update SVC06100 set WOSTAT = @COMPSTAT,  COMPDTE = @ENDDATE,  COMPTME = @ENDTIME  where WORECTYPE = @WORECTYPE and WORKORDNUM = @WORKORDNUM  if @@ERROR <> 0 goto MISC_ERROR  end   update SVC06100 set STATIONID = @NEXTSTATIONID  where WORECTYPE = @WORECTYPE and   WORKORDNUM = @WORKORDNUM  if @@ERROR <> 0 goto MISC_ERROR  COMMIT TRANSACTION return(0) NO_WO:  select @RETERROR = -1, @RETERRTYPE = 1000  return NO_TECH:  select @RETERROR = -1, @RETERRTYPE = 1001  return NO_STATION:  select @RETERROR = -1, @RETERRTYPE = 1002  return BAD_TIME:  select @RETERROR = -1, @RETERRTYPE = 1004  return MISC_ERROR:  ROLLBACK TRANSACTION  select @RETERROR = -1, @RETERRTYPE = 1010  return    
GO
GRANT EXECUTE ON  [dbo].[SVC_Depot_Labor_Post] TO [DYNGRP]
GO
