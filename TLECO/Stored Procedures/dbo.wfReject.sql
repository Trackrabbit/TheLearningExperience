SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[wfReject]  @WorkflowStepInstanceID char(37),  @Workflow_User char(85),  @Workflow_Rejection_Type tinyint,   @Workflow_Comments char(2000),  @Workflow_Error int OUTPUT  AS  BEGIN   declare @WorkflowInstanceID char(37), @Workflow_Step_Assign_To char(37)  declare @Workflow_Step_Name char(51), @Workflow_Name char(51)  declare @DueDate datetime, @DueTime datetime,  @Workflow_Completion_Date datetime, @Workflow_Completion_Time datetime  declare @CMPANYID smallint, @server_name nvarchar(128), @SystemDB nvarchar(6)  set NOCOUNT ON   select @WorkflowStepInstanceID=UPPER(@WorkflowStepInstanceID)  select @Workflow_User=UPPER(@Workflow_User)   if (select COUNT(WorkflowInstanceID) from WFI10004 where WorkflowStepInstanceID=@WorkflowStepInstanceID)>0  begin  select TOP 1 @WorkflowInstanceID=WorkflowInstanceID, @Workflow_Step_Name=Workflow_Step_Name,  @Workflow_Name=Workflow_Name, @DueDate=Workflow_Due_Date, @DueTime=Workflow_Due_Time   from WFI10004 with (nolock, index=AK2WFI10004)   where WorkflowStepInstanceID=@WorkflowStepInstanceID   end  else  begin  select @WorkflowInstanceID=WorkflowInstanceID, @Workflow_Step_Name=Workflow_Step_Name,  @Workflow_Name=Workflow_Name, @DueDate='', @DueTime=''   from WFI10003 where WorkflowStepInstanceID=@WorkflowStepInstanceID  end   update WFI10002 set Workflow_Status=7  where WorkflowInstanceID=@WorkflowInstanceID   update WFI10003 set Workflow_Step_Status=3    where Workflow_Step_Status=2 and WorkflowInstanceID=@WorkflowInstanceID   update WFI10004 set Workflow_Action_Date=cast(SYSDATETIME() as date),  Workflow_Action_Time=cast(SYSDATETIME() as time)  where WorkflowInstanceID=@WorkflowInstanceID and WorkflowStepInstanceID=@WorkflowStepInstanceID  and UPPER(WorkflowTaskAssignedTo)=@Workflow_User   delete from WFI10004 where WorkflowInstanceID=@WorkflowInstanceID and Workflow_Action_Date=''   exec wfUpdateDocument @WorkflowInstanceID,1,7,'','',@Workflow_Error OUTPUT   select @Workflow_Completion_Date=cast(SYSDATETIME() as date),@Workflow_Completion_Time=cast(SYSDATETIME() as time)  select @Workflow_Step_Assign_To = Workflow_Step_Assign_To from WFI10003 where WorkflowStepInstanceID=@WorkflowStepInstanceID  exec wfCreateHistoryRecord @WorkflowInstanceID,  @WorkflowStepInstanceID,  @Workflow_User,  @Workflow_Name,  @Workflow_Step_Name,  @Workflow_Step_Assign_To,  5,  @DueDate,  @DueTime,  @Workflow_Completion_Date,  @Workflow_Completion_Time,  @Workflow_Comments,  @Workflow_Error OUTPUT END   
GO
GRANT EXECUTE ON  [dbo].[wfReject] TO [DYNGRP]
GO
