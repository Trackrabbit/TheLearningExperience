SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
create procedure [dbo].[taPMTransactionInsert]  @I_vBACHNUMB char(15),    @I_vVCHNUMWK char(17),    @I_vVENDORID char(15),    @I_vDOCNUMBR char(20),    @I_vDOCTYPE  smallint,    @I_vDOCAMNT  numeric(19,5),   @I_vDOCDATE  datetime,    @I_vPSTGDATE datetime = '',   @I_vVADCDTRO char(15) = '',   @I_vVADDCDPR char(15) = '',   @I_vPYMTRMID char(20) = NULL,   @I_vTAXSCHID char(15) = '',   @I_vDUEDATE  datetime = '',   @I_vDSCDLRAM numeric(19,5) = NULL,  @I_vDISCDATE datetime = '',   @I_vPRCHAMNT numeric(19,5) = 0,   @I_vCHRGAMNT numeric(19,5) = 0,   @I_vCASHAMNT numeric(19,5) = 0,   @I_vCAMCBKID char(15) = '',   @I_vCDOCNMBR char(20) = '',   @I_vCAMTDATE datetime = '',   @I_vCAMPMTNM char(20) = '',   @I_vCHEKAMNT numeric(19,5) = 0,   @I_vCHAMCBID char(15) = '',   @I_vCHEKDATE datetime = '',   @I_vCAMPYNBR char(20) = '',   @I_vCRCRDAMT numeric(19,5) = 0,   @I_vCCAMPYNM char(20) = '',   @I_vCHEKNMBR char(20) = '',   @I_vCARDNAME char(15) = '',   @I_vCCRCTNUM char(20) = '',   @I_vCRCARDDT datetime = '',   @I_vCHEKBKID char(15) = '',   @I_vTRXDSCRN char(30) = '',   @I_vTRDISAMT numeric(19,5) = 0,   @I_vTAXAMNT numeric(19,5) = 0,   @I_vFRTAMNT numeric(19,5) = 0,   @I_vTEN99AMNT numeric(19,5) = 0,  @I_vMSCCHAMT numeric(19,5) = 0,   @I_vPORDNMBR char(20) = '',   @I_vSHIPMTHD char(15) = NULL,   @I_vDISAMTAV numeric(19,5) = NULL,  @I_vDISTKNAM numeric(19,5) = 0,   @I_vAPDSTKAM numeric(19,5) = 0,   @I_vMDFUSRID char(15) = '',   @I_vPOSTEDDT datetime = '',   @I_vPTDUSRID char(15) = '',   @I_vPCHSCHID char(15) = '',   @I_vFRTSCHID char(15) = '',   @I_vMSCSCHID char(15) = '',   @I_vPRCTDISC numeric(19,2) = NULL,  @I_vTax_Date datetime = '',   @I_vCURNCYID char(15) = '',   @I_vXCHGRATE numeric(19,7) = 0,   @I_vRATETPID char(15) = '',   @I_vEXPNDATE datetime = '',   @I_vEXCHDATE datetime = '',   @I_vEXGTBDSC char(30) = '',   @I_vEXTBLSRC char(50) = '',   @I_vRATEEXPR smallint = -1,   @I_vDYSTINCR smallint = -1,   @I_vRATEVARC numeric(19,7) = 0,   @I_vTRXDTDEF smallint = -1,   @I_vRTCLCMTD smallint = -1,   @I_vPRVDSLMT smallint = 0,   @I_vDATELMTS smallint = 0,   @I_vTIME1 datetime = '',   @I_vBatchCHEKBKID char(15) = '',  @I_vCREATEDIST smallint = 1,   @I_vRequesterTrx smallint = 0,   @I_vUSRDEFND1  char(50) = '',   @I_vUSRDEFND2  char(50) = '',   @I_vUSRDEFND3  char(50) = '',   @I_vUSRDEFND4  varchar(8000) = '',  @I_vUSRDEFND5  varchar(8000) = '',  @O_iErrorState int output,   @oErrString varchar(255) output    with encryption as  set transaction isolation level read uncommitted set nocount on  declare   @CMPANYID smallint,     @NOTEINDX numeric(19,5),    @FUNLCURR char(15),     @EXGTBLID char(15),     @ISMCTRX int,      @ORDISTKN numeric(19,5),  @ORDDLRAT numeric(19,5),  @ORTDISAM numeric(19,5),  @OCHGAMT numeric(19,5),  @OR1099AM numeric(19,5),  @ORCTRXAM numeric(19,5),    @ORCASAMT numeric(19,5),    @ORCHKAMT numeric(19,5),    @ORCCDAMT numeric(19,5),    @OMISCAMT numeric(19,5),    @ORFRTAMT numeric(19,5),    @ORTAXAMT numeric(19,5),    @OPURAMT numeric(19,5),     @ORDOCAMT numeric(19,5),    @ODISAMTAV numeric(19,5),    @DECPLCUR smallint,     @PRCHAMNT numeric(19,5),    @CURTRXAM numeric(19,5),  @DCSTATUS tinyint,  @CNTRLTYP tinyint,  @TAXAMNT numeric(19,5),  @BCHSOURC char(15),  @ADUPINNM int,  @DSCLCTYP smallint,  @DSCPCTAM numeric(19,5),  @DSCDLRAM numeric(19,5),  @dDISCDATE datetime,  @dDUEDATE datetime,  @iCalcDueDateErrState int,  @iCalcDueDateErrString varchar(255),  @iCustomState int,  @iCustomErrString varchar(255),  @iStatement int,     @iStatus int,      @iAddBatchErrState int,     @iAddShippingErrState int,    @iAddShippingErrString varchar(255),   @iCreateBatchErrString varchar(255),   @CURRNIDX smallint,     @iAddCodeErrState int,     @iError int,      @iUpdDistErrState int,     @O_oErrorState int,  @CreditCardVendorID char(15),    @O_iInitErrorState int,     @oInitErrString varchar(255),    @SALPURCH smallint,  @DISCNTCB smallint,  @FREIGHT smallint,  @MISC smallint,  @TAX smallint,  @PymtTermAmnt numeric(19,5),  @ORDECPLCUR smallint,  @iGetNextNoteIdxErrState int,  @round numeric(19,5),  @SEQNUMB int,  @ROUNDACCT int,  @FUNLCURRINDEX int,  @INTERID char(5),  @BKTPURAM numeric(19,5),    @MCINSTALLED tinyint,  @TEN99TYPE smallint,     @TEN99BOXNUMBER smallint,    @OBKPURAMT numeric(19,5),  @BKTFRTAM numeric(19,5),  @BKTMSCAM numeric(19,5),  @ORBKTFRT numeric(19,5),  @ORBKTMSC numeric(19,5),  @PYBLGRBX tinyint,  @BACHNUMB char(15),  @checkbookid char(15),  @BatchExists tinyint,  @RCVBGRBX tinyint,       @Workflow_Status smallint    select   @CURTRXAM = 0,  @CMPANYID = 0,     @FUNLCURR = '',     @EXGTBLID = '',     @ISMCTRX = 0,     @ORDISTKN = 0,  @ORCTRXAM = 0,  @ORDDLRAT = 0,  @ORTDISAM = 0,  @OCHGAMT = 0,  @OR1099AM = 0,  @ORCASAMT = 0,     @ORCHKAMT = 0,     @ORCCDAMT = 0,     @OMISCAMT = 0,     @ORFRTAMT = 0,     @ORTAXAMT = 0,     @OPURAMT = 0,     @ORDOCAMT = 0,     @ODISAMTAV = 0,     @DECPLCUR = 0,     @PRCHAMNT = @I_vPRCHAMNT,    @DCSTATUS = 1,  @TAXAMNT  = 0,  @CNTRLTYP = 0,  @ADUPINNM = 0,  @DSCLCTYP = 0,  @DSCPCTAM = 0,  @DSCDLRAM = 0,  @dDISCDATE = '',  @dDUEDATE = '',  @CURRNIDX = 0,  @BCHSOURC = 'PM_Trxent',  @iError   = 0,  @iAddBatchErrState = 0,  @iAddCodeErrState  = 0,  @iUpdDistErrState  = 0,  @iCalcDueDateErrState = 0,  @iCalcDueDateErrString = '',  @iStatus = 0,  @oErrString = '',  @O_oErrorState = 0,  @iStatement    = 0,    @O_iErrorState = 0,    @SALPURCH = 1,  @DISCNTCB = 1,  @FREIGHT = 1,  @MISC = 1,  @TAX = 1,  @PymtTermAmnt = 0,  @ORDECPLCUR = 0,  @round = 0,  @SEQNUMB = 0,  @ROUNDACCT = 0,  @FUNLCURRINDEX = 0,  @INTERID = '',  @MCINSTALLED = 1,  @BKTPURAM = 0,  @INTERID = '',  @TEN99TYPE = 0,  @TEN99BOXNUMBER = 0,  @OBKPURAMT = 0,  @BKTFRTAM = 0,  @BKTMSCAM = 0,  @ORBKTFRT = 0,  @ORBKTMSC = 0,  @PYBLGRBX = 0,  @BACHNUMB = '',  @checkbookid = '',  @BatchExists = 0,  @RCVBGRBX = 0,     @Workflow_Status = 0  exec @iStatus = taPMTransactionInsertPre  @I_vBACHNUMB output,  @I_vVCHNUMWK output,  @I_vVENDORID output,  @I_vDOCNUMBR output,  @I_vDOCTYPE  output,  @I_vDOCAMNT  output,  @I_vDOCDATE  output,  @I_vPSTGDATE output,  @I_vVADCDTRO output,    @I_vVADDCDPR output,  @I_vPYMTRMID output,  @I_vTAXSCHID output,  @I_vDUEDATE  output,  @I_vDSCDLRAM output,  @I_vDISCDATE output,  @I_vPRCHAMNT output,  @I_vCHRGAMNT output,  @I_vCASHAMNT output,  @I_vCAMCBKID output,  @I_vCDOCNMBR output,  @I_vCAMTDATE output,  @I_vCAMPMTNM output,  @I_vCHEKAMNT output,  @I_vCHAMCBID output,  @I_vCHEKDATE output,  @I_vCAMPYNBR output,  @I_vCRCRDAMT output,  @I_vCCAMPYNM output,  @I_vCHEKNMBR output,  @I_vCARDNAME output,  @I_vCCRCTNUM output,  @I_vCRCARDDT output,  @I_vCHEKBKID output,  @I_vTRXDSCRN output,  @I_vTRDISAMT output,  @I_vTAXAMNT output,  @I_vFRTAMNT output,  @I_vTEN99AMNT output,  @I_vMSCCHAMT output,  @I_vPORDNMBR output,  @I_vSHIPMTHD output,  @I_vDISAMTAV output,  @I_vDISTKNAM output,  @I_vAPDSTKAM output,  @I_vMDFUSRID output,  @I_vPOSTEDDT output,  @I_vPTDUSRID output,  @I_vPCHSCHID output,  @I_vFRTSCHID output,  @I_vMSCSCHID output,  @I_vPRCTDISC output,  @I_vTax_Date output,  @I_vCURNCYID output,      @I_vXCHGRATE output,      @I_vRATETPID output,      @I_vEXPNDATE output,      @I_vEXCHDATE output,      @I_vEXGTBDSC output,      @I_vEXTBLSRC output,      @I_vRATEEXPR output,       @I_vDYSTINCR output,       @I_vRATEVARC output,      @I_vTRXDTDEF output,      @I_vRTCLCMTD output,      @I_vPRVDSLMT output,      @I_vDATELMTS output,      @I_vTIME1 output,      @I_vBatchCHEKBKID output,  @I_vCREATEDIST output,  @I_vRequesterTrx output,  @I_vUSRDEFND1 output,  @I_vUSRDEFND2 output,  @I_vUSRDEFND3 output,  @I_vUSRDEFND4 output,  @I_vUSRDEFND5 output,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if ((@iStatus = 0) and (@iError <> 0)) begin  select @iStatus = @iError end if ((@iStatus <> 0) or (@iCustomState <> 0)) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  select @O_iErrorState = 153    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  while (@iStatement = 0) begin  if( @I_vBACHNUMB is NULL or  @I_vVCHNUMWK is NULL or  @I_vVENDORID is NULL or  @I_vDOCNUMBR is NULL or  @I_vDOCTYPE  is NULL or  @I_vDOCAMNT  is NULL or  @I_vDOCDATE  is NULL or  @I_vPSTGDATE is NULL or  @I_vVADCDTRO is NULL or     @I_vVADDCDPR is NULL or  @I_vDUEDATE  is NULL or  @I_vDISCDATE is NULL or  @I_vPRCHAMNT is NULL or  @I_vCHRGAMNT is NULL or  @I_vCASHAMNT is NULL or  @I_vCAMCBKID is NULL or  @I_vCDOCNMBR is NULL or  @I_vCAMTDATE is NULL or  @I_vCAMPMTNM is NULL or  @I_vCHEKAMNT is NULL or  @I_vCHAMCBID is NULL or  @I_vCHEKDATE is NULL or  @I_vCAMPYNBR is NULL or  @I_vCRCRDAMT is NULL or  @I_vCCAMPYNM is NULL or  @I_vCHEKNMBR is NULL or  @I_vCARDNAME is NULL or  @I_vCCRCTNUM is NULL or  @I_vCRCARDDT is NULL or  @I_vCHEKBKID is NULL or  @I_vTRXDSCRN is NULL or  @I_vTRDISAMT is NULL or  @I_vTAXAMNT  is NULL or  @I_vFRTAMNT  is NULL or  @I_vTEN99AMNT is NULL or  @I_vMSCCHAMT is NULL or  @I_vPORDNMBR is NULL or     @I_vDISTKNAM is NULL or  @I_vAPDSTKAM is NULL or  @I_vMDFUSRID is NULL or  @I_vPOSTEDDT is NULL or  @I_vPTDUSRID is NULL or  @I_vPCHSCHID is NULL or  @I_vFRTSCHID is NULL or  @I_vMSCSCHID is NULL or  @I_vCURNCYID is NULL or  @I_vXCHGRATE is NULL or  @I_vRATETPID is NULL or  @I_vEXPNDATE is NULL or  @I_vEXCHDATE is NULL or  @I_vEXGTBDSC is NULL or  @I_vEXTBLSRC is NULL or  @I_vRATEEXPR is NULL or  @I_vDYSTINCR is NULL or  @I_vRATEVARC is NULL or  @I_vTRXDTDEF is NULL or  @I_vRTCLCMTD is NULL or  @I_vPRVDSLMT is NULL or  @I_vDATELMTS is NULL or  @I_vTIME1 is NULL or  @I_vBatchCHEKBKID is NULL or  @I_vCREATEDIST is NULL or  @I_vRequesterTrx is NULL)  begin  select @O_iErrorState = 481    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if(  (@I_vPRCHAMNT < 0) or  (@I_vCHRGAMNT < 0) or  (@I_vCASHAMNT < 0) or  (@I_vCHEKAMNT < 0) or   (@I_vCRCRDAMT < 0) or  (@I_vTRDISAMT < 0) or   (@I_vFRTAMNT < 0) or   (@I_vTEN99AMNT < 0) or   (@I_vTEN99AMNT < 0) or   (@I_vXCHGRATE < 0) or   (@I_vRATEVARC < 0) or  (@I_vDSCDLRAM < 0)  )  begin  select @O_iErrorState = 5631    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end   select  @I_vVENDORID = UPPER(@I_vVENDORID),  @I_vBACHNUMB = UPPER(@I_vBACHNUMB),  @I_vDOCNUMBR = UPPER(@I_vDOCNUMBR),  @I_vTAXSCHID = UPPER(@I_vTAXSCHID),  @I_vCHEKBKID = UPPER(@I_vCHEKBKID),  @I_vPCHSCHID = UPPER(@I_vPCHSCHID),  @I_vFRTSCHID = UPPER(@I_vFRTSCHID),  @I_vMSCSCHID = UPPER(@I_vMSCSCHID),  @I_vCAMCBKID = UPPER(@I_vCAMCBKID),  @I_vCHAMCBID = UPPER(@I_vCHAMCBID),  @I_vCURNCYID = UPPER(@I_vCURNCYID),  @I_vSHIPMTHD = UPPER(@I_vSHIPMTHD),  @I_vBatchCHEKBKID = UPPER(@I_vBatchCHEKBKID)   if ( (not exists(select top 1 CURNCYID from IV00105 (nolock) where CURNCYID <> '')) and  (not exists(select top 1 CURNCYID from CM00100 (nolock) where CURNCYID <> '')))  begin  select @MCINSTALLED = 0  end   if (@I_vCURNCYID = '')  begin  select @I_vCURNCYID = isnull(CURNCYID,'') from PM00200 (nolock) where VENDORID = @I_vVENDORID   if (@I_vCURNCYID = '')  select @I_vCURNCYID = isnull(FUNLCURR,''), @CURRNIDX = isnull(FUNCRIDX,0) from MC40000 (nolock)  end   select @CURRNIDX = isnull(CURRNIDX,0) from DYNAMICS..MC40200 (nolock) where CURNCYID = @I_vCURNCYID   if ((@CURRNIDX = 0) or (@I_vCURNCYID = ''))  begin  select @O_iErrorState = 761     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if (@I_vXCHGRATE < 0)   begin  select @O_iErrorState = 5597     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end   if ((@I_vDSCDLRAM > @I_vPRCHAMNT) or (@I_vDSCDLRAM < 0))  begin  select @O_iErrorState = 4608     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vDSCDLRAM > 0) and (@I_vPRCTDISC > 0))  begin  select @O_iErrorState = 4637     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vDISAMTAV > @I_vPRCHAMNT) or (@I_vDISAMTAV < 0))  begin  select @O_iErrorState = 4609     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   select @FUNLCURR = FUNLCURR from MC40000 (nolock)  select @DECPLCUR = DECPLCUR - 1 from DYNAMICS..MC40200 (nolock) where CURNCYID = @FUNLCURR  select @ORDECPLCUR = DECPLCUR - 1 from DYNAMICS..MC40200 (nolock) where CURNCYID = @I_vCURNCYID   if  (@I_vCURNCYID <> '') and (@I_vCURNCYID <> @FUNLCURR)  begin  select @ISMCTRX = 1   if ( (@I_vCAMTDATE <> '' and @I_vCAMTDATE <> @I_vDOCDATE) or  (@I_vCHEKDATE <> '' and @I_vCHEKDATE <> @I_vDOCDATE) or  (@I_vCRCARDDT <> '' and @I_vCRCARDDT <> @I_vDOCDATE))  begin  select @O_iErrorState = 1323     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  break  end   exec @iStatus = taMCCurrencyValidate  @I_vMASTERID = @I_vVENDORID,  @I_vDOCDATE = @I_vDOCDATE,              @I_vCURNCYID = @I_vCURNCYID,  @I_vEXGTBDSC = @I_vEXGTBDSC,  @I_vEXTBLSRC = @I_vEXTBLSRC,  @I_vRATEEXPR = @I_vRATEEXPR output,  @I_vDYSTINCR = @I_vDYSTINCR output,  @I_vRATEVARC = @I_vRATEVARC,  @I_vTRXDTDEF = @I_vTRXDTDEF,  @I_vPRVDSLMT = @I_vPRVDSLMT,  @I_vDATELMTS = @I_vDATELMTS,  @I_vMODULE = 0,  @I_vEXCHDATE = @I_vEXCHDATE output,  @I_vTIME1 = @I_vTIME1 output,  @I_vXCHGRATE = @I_vXCHGRATE output,  @I_vEXPNDATE = @I_vEXPNDATE output,  @I_vRATETPID = @I_vRATETPID output,  @I_vRTCLCMTD = @I_vRTCLCMTD output,  @I_vEXGTBLID = @EXGTBLID output,  @oErrString = @oErrString output,  @O_iErrorState = @iUpdDistErrState output  select @iError = @@error  if ((@iStatus = 0) and (@iError <> 0))  select @iStatus = @iError  if (@iStatus <> 0) or (@iUpdDistErrState <> 0)  begin  select @O_iErrorState = 265   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end  if (@@error <> 0)  begin  select @O_iErrorState = 266   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end  end  else  begin  select @ISMCTRX = 0, @I_vRATEEXPR = 0, @I_vDYSTINCR = 0, @I_vXCHGRATE = 1   end   if  (@I_vDOCTYPE not in (4,5))  begin  if (@I_vPYMTRMID is null)  begin  select @I_vPYMTRMID = PYMTRMID from PM00200 (nolock) where VENDORID = @I_vVENDORID  select @I_vPYMTRMID = isnull(@I_vPYMTRMID,'')  end   select @SALPURCH = SALPURCH,  @DISCNTCB = DISCNTCB,  @FREIGHT = FREIGHT,  @MISC = MISC,  @TAX = TAX  from SY03300 (nolock) where PYMTRMID = @I_vPYMTRMID   select @PymtTermAmnt = @PymtTermAmnt + (@I_vPRCHAMNT * @SALPURCH),  @PymtTermAmnt = @PymtTermAmnt - (@I_vTRDISAMT * @DISCNTCB),  @PymtTermAmnt = @PymtTermAmnt + (@I_vFRTAMNT * @FREIGHT),  @PymtTermAmnt = @PymtTermAmnt + (@I_vMSCCHAMT * @MISC),  @PymtTermAmnt = @PymtTermAmnt + (@I_vTAXAMNT * (@TAX))   if ((@I_vPYMTRMID = '') and (@I_vDISAMTAV is null) and (@I_vDSCDLRAM is null) and (@I_vPRCTDISC is null))  select @I_vDISAMTAV = 0, @I_vDSCDLRAM = 0, @I_vPRCTDISC = 0   if ((@I_vDISAMTAV is not null) and (@I_vDSCDLRAM is null or @I_vDSCDLRAM <> @I_vDISAMTAV))   select @I_vDSCDLRAM = 0   if ((@I_vDISAMTAV is not null) and (@I_vPRCTDISC is null or round((@I_vPRCTDISC / 100) * @PymtTermAmnt, @ORDECPLCUR) <> @I_vDISAMTAV))   select @I_vPRCTDISC = 0   if ((@I_vDSCDLRAM is not null and @I_vDSCDLRAM <> 0) and (@I_vPRCTDISC is not null and @I_vPRCTDISC <> 0))  begin  select @O_iErrorState = 4611     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vDSCDLRAM is not null) and (@I_vDISAMTAV is null))  select @I_vDISAMTAV = @I_vDSCDLRAM,  @I_vPRCTDISC = 0   if ((@I_vPRCTDISC is not null) and (@I_vDISAMTAV is null))  select @I_vDISAMTAV = ((@I_vPRCTDISC / 100) * @PymtTermAmnt),  @I_vDSCDLRAM = 0   if ((@I_vPYMTRMID <> '') and (@I_vDISAMTAV is null) and (@I_vDSCDLRAM is null) and (@I_vPRCTDISC is null))  begin  select @DSCLCTYP = DSCLCTYP, @DSCDLRAM = DSCDLRAM, @DSCPCTAM = DSCPCTAM from SY03300 (nolock) where PYMTRMID = @I_vPYMTRMID   if (@DSCLCTYP = 1)   begin  select @I_vPRCTDISC = @DSCPCTAM / 100,  @I_vDSCDLRAM = 0   if (@ISMCTRX = 1)   begin  select @ODISAMTAV = round((@I_vPRCTDISC / 100) * @PymtTermAmnt, @ORDECPLCUR)  select @ORDDLRAT = 0  select @I_vDISAMTAV =  case  when (@I_vRTCLCMTD = 0)  then round(@ODISAMTAV * @I_vXCHGRATE, @DECPLCUR)  when (@I_vRTCLCMTD = 1)  then round(@ODISAMTAV / @I_vXCHGRATE, @DECPLCUR)  else 0  end  end  else  begin  select @I_vDISAMTAV = round((@I_vPRCTDISC / 100) * @PymtTermAmnt, @DECPLCUR)  select @ODISAMTAV = 0  end  end  else  if (@DSCLCTYP = 2)     begin  select @I_vPRCTDISC = 0   if (@ISMCTRX = 1)   begin  select @I_vDISAMTAV = @DSCDLRAM,  @I_vDSCDLRAM = @DSCDLRAM   select @ODISAMTAV =  case  when (@I_vRTCLCMTD = 0)  then round(@I_vDISAMTAV / @I_vXCHGRATE, @ORDECPLCUR)  when (@I_vRTCLCMTD = 1)  then round(@I_vDISAMTAV * @I_vXCHGRATE, @ORDECPLCUR)  else 0  end   select @ORDDLRAT = @ODISAMTAV  end  else  begin  select @I_vDSCDLRAM = @DSCDLRAM,  @I_vDISAMTAV = @DSCDLRAM   select @ORDDLRAT = 0,  @ODISAMTAV = 0  end  end  end  else  if (@ISMCTRX = 1)    begin  select @ODISAMTAV = @I_vDISAMTAV    select @I_vDISAMTAV =   case   when (@I_vRTCLCMTD = 0)  then round(@ODISAMTAV * @I_vXCHGRATE, @DECPLCUR)  when (@I_vRTCLCMTD = 1)  then round(@ODISAMTAV / @I_vXCHGRATE, @DECPLCUR)  else 0  end   select @ODISAMTAV = round(@ODISAMTAV,@ORDECPLCUR)  if (@I_vPRCTDISC = 0)  begin  select @ORDDLRAT = @ODISAMTAV,  @I_vDSCDLRAM = @I_vDISAMTAV  end  end  else   begin  select @I_vDISAMTAV = round(@I_vDISAMTAV,@DECPLCUR)  if (@I_vPRCTDISC = 0)  begin  select @I_vDSCDLRAM = @I_vDISAMTAV  end  end  end  else  begin   select @I_vPYMTRMID = '', @I_vDISAMTAV = 0, @I_vDSCDLRAM = 0, @I_vPRCTDISC = 0  end   if (@ISMCTRX = 1)   select  @ORCTRXAM = @I_vCHRGAMNT,   @OPURAMT  = @I_vPRCHAMNT,   @ORFRTAMT = @I_vFRTAMNT,   @OMISCAMT = @I_vMSCCHAMT,   @ORTAXAMT = @I_vTAXAMNT,   @ORCASAMT = @I_vCASHAMNT,   @ORCHKAMT = @I_vCHEKAMNT,   @ORCCDAMT = @I_vCRCRDAMT,   @ORDISTKN = @I_vDISTKNAM,   @ORTDISAM = @I_vTRDISAMT,   @OCHGAMT =  @I_vCHRGAMNT,    @ORDOCAMT = @I_vDOCAMNT,   @OR1099AM = @I_vTEN99AMNT    select @INTERID = INTERID, @CMPANYID = CMPANYID from DYNAMICS..SY01500 (nolock) where INTERID = db_name()   exec @iStatus = DYNAMICS..tasmGetNextNoteIndex  @I_sCompanyID   = @CMPANYID,  @I_iSQLSessionID = 0,  @I_noteincrement  = 1,  @O_mNoteIndex   = @NOTEINDX output,  @O_iErrorState  = @iGetNextNoteIdxErrState output  select @iError = @@error  if @iStatus = 0 and @iError <> 0  begin  select @iStatus = @iError  end  if (@iStatus <> 0) or (@iGetNextNoteIdxErrState <> 0)  begin  if (@iGetNextNoteIdxErrState <> 0)  begin  exec @iStatus = taUpdateString  @iGetNextNoteIdxErrState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  select @O_iErrorState = 5373   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end   if ((@I_vDOCTYPE < 1) or (@I_vDOCTYPE > 5))  begin  select @O_iErrorState = 300    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vDOCTYPE = 5) and (@I_vPYMTRMID <> '' or @I_vCASHAMNT <> 0 or @I_vCHEKAMNT <> 0 or  @I_vCRCRDAMT <> 0 or @I_vDISAMTAV <> 0 or @I_vDISTKNAM <> 0))  begin  select @O_iErrorState = 480     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vDOCTYPE = 4) and (@I_vPYMTRMID <> ''))  begin  select @O_iErrorState = 1100     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if (@I_vRequesterTrx not in (0,1))  begin  select @O_iErrorState = 3725     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   select @ADUPINNM = isnull(ADUPINNM,0) from PM40100 (nolock) where UNIQKEY = '1'   if (@I_vPSTGDATE = '')  select @I_vPSTGDATE = @I_vDOCDATE  if ((@I_vDUEDATE = '') and (@I_vPYMTRMID = '') and (@I_vDOCTYPE not in (4,5)))  select @I_vDUEDATE = @I_vDOCDATE   if (@I_vTax_Date = '')  select @I_vTax_Date = @I_vDOCDATE   select  @I_vPCHSCHID =  case  when (@I_vPCHSCHID = '') then PCHSCHID  else @I_vPCHSCHID  end,  @I_vMSCSCHID =  case  when (@I_vMSCSCHID = '') then MSCSCHID  else @I_vMSCSCHID  end,  @I_vFRTSCHID =  case  when (@I_vFRTSCHID = '') then FRTSCHID  else @I_vFRTSCHID  end  from PM40100 (nolock) where UNIQKEY = '1'   select @CURTRXAM = @I_vCHRGAMNT     if (@I_vVENDORID  = '')  begin  select @O_iErrorState = 255    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if not exists (select 1 from PM00200 (nolock) where VENDORID = @I_vVENDORID)  begin  select @O_iErrorState = 372    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if (@I_vDOCNUMBR = '')  begin  select @O_iErrorState = 257    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@ADUPINNM = 1) or (@ADUPINNM = 2))   begin   if exists(select 1 from PM00400 a (nolock) where a.VENDORID = @I_vVENDORID and a.DOCNUMBR = @I_vDOCNUMBR and a.DOCTYPE <> 6) or   exists(select 1 from PM20000 a (nolock) where a.VENDORID = @I_vVENDORID and a.DOCNUMBR = @I_vDOCNUMBR and a.DOCTYPE <> 6) or   exists(select 1 from PM10000 a (nolock) where a.VENDORID = @I_vVENDORID and a.DOCNUMBR = @I_vDOCNUMBR and a.DOCTYPE <> 6) or   exists(select 1 from PM30200 a (nolock) where a.VENDORID = @I_vVENDORID and a.DOCNUMBR = @I_vDOCNUMBR and a.DOCTYPE <> 6) or   exists(select 1 from POP10300 a (nolock) where a.VENDORID = @I_vVENDORID and a.VNDDOCNM = @I_vDOCNUMBR) or   exists(select 1 from MC020103 a (nolock) where a.DOCTYPE = @I_vDOCTYPE and a.VCHRNMBR = @I_vVCHNUMWK)  begin  select @O_iErrorState = 305    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end   if exists(select 1 from PM00400 a (nolock) where a.CNTRLTYP = @CNTRLTYP and a.CNTRLNUM = @I_vVCHNUMWK)    begin  select @O_iErrorState = 306    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if (@I_vDOCAMNT < 0)  begin  select @O_iErrorState = 307     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if (@I_vDOCAMNT <> @I_vMSCCHAMT + @I_vPRCHAMNT + @I_vTAXAMNT + @I_vFRTAMNT - @I_vTRDISAMT)  begin  select @O_iErrorState = 308      exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if (@I_vCHRGAMNT <> @I_vDOCAMNT - @I_vCASHAMNT - @I_vCHEKAMNT - @I_vCRCRDAMT - @I_vDISTKNAM)  begin  select @O_iErrorState = 399     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if (@I_vTAXSCHID <> '')  begin  if not exists(select 1 from TX00102 (nolock) where TAXSCHID = @I_vTAXSCHID)  begin  select @O_iErrorState = 309     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  end   if (@I_vPCHSCHID <> '')  begin  if not exists(select 1 from TX00102 (nolock) where TAXSCHID = @I_vPCHSCHID)  begin   select @O_iErrorState = 310     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  end   if (@I_vMSCSCHID <> '')  begin  if not exists(select 1 from TX00102 (nolock) where TAXSCHID = @I_vMSCSCHID)  begin  select @O_iErrorState = 311     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  end   if (@I_vFRTSCHID <> '')  begin  if not exists(select 1 from TX00102 (nolock) where TAXSCHID = @I_vFRTSCHID)  begin   select @O_iErrorState = 312     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  end   select @TAXAMNT = isnull(sum(TAXAMNT),0.00) from PM10500 (nolock) where DOCTYPE = @I_vDOCTYPE and VCHRNMBR = @I_vVCHNUMWK and BKOUTTAX <> 1    if (@TAXAMNT <> @I_vTAXAMNT)  begin  select @O_iErrorState = 313     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end   if exists(select 1 from PM10500 (nolock) where DOCTYPE = @I_vDOCTYPE and VCHRNMBR = @I_vVCHNUMWK and BKOUTTAX = 1)  begin  select @BKTPURAM = isnull(sum(PCTAXAMT),0),  @BKTFRTAM = isnull(sum(FRTTXAMT),0),  @BKTMSCAM = isnull(sum(MSCTXAMT),0)  from PM10500 (nolock) where DOCTYPE = @I_vDOCTYPE and VCHRNMBR = @I_vVCHNUMWK and BKOUTTAX = 1   if (@ISMCTRX = 1)  begin  select @OBKPURAMT = @I_vPRCHAMNT - @BKTPURAM,  @ORBKTFRT = @I_vFRTAMNT - @BKTFRTAM,  @ORBKTMSC = @I_vMSCCHAMT - @BKTMSCAM  end  end   if (@I_vBACHNUMB  = '')  begin  select @O_iErrorState = 314    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if (exists(select 1 from SY00500 (nolock) where BACHNUMB = @I_vBACHNUMB and MKDTOPST <> 0 and BCHSOURC = @BCHSOURC))  begin  select @O_iErrorState = 316    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ( @I_vBACHNUMB <> '' )   begin  if exists(select 1 from SY00500 a (nolock) where a.BACHNUMB = @I_vBACHNUMB and APPROVL = 1)  begin  select @O_iErrorState = 5626     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  end   if (@I_vDOCDATE = '')  begin  select @O_iErrorState = 317    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if (@I_vVADDCDPR <> '')  begin  if not exists(select 1 from PM00300 (nolock) where VENDORID = @I_vVENDORID and ADRSCODE = @I_vVADDCDPR)  begin  select @O_iErrorState = 318     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end  else  begin  select @I_vVADDCDPR = VADDCDPR from PM00200 (nolock) where VENDORID = @I_vVENDORID  end   if (@I_vVADCDTRO <> '')  begin  if not exists(select 1 from PM00300 (nolock) where VENDORID = @I_vVENDORID and ADRSCODE = @I_vVADCDTRO)  begin  select @O_iErrorState = 9286     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end  else  begin  select @I_vVADCDTRO = VADCDTRO from PM00200 (nolock) where VENDORID = @I_vVENDORID  end   if (@I_vPYMTRMID <> '')   begin  if (not exists(select 1 from SY03300 a (nolock) where a.PYMTRMID = @I_vPYMTRMID))  begin  select @O_iErrorState = 319      exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end   if ((@I_vPYMTRMID <> '') and (@I_vDUEDATE = '' or @I_vDISCDATE = ''))  begin  exec @iStatus = taCalcDueDatePM  @I_vVENDORID = @I_vVENDORID,  @I_vPYMTRMID = @I_vPYMTRMID,  @I_vDOCDATE  = @I_vDOCDATE,  @O_dDISCDATE = @dDISCDATE output,  @O_dDUEDATE  = @dDUEDATE output,  @O_iErrorState = @iCalcDueDateErrState output,  @oErrString = @iCalcDueDateErrString output  select @iError = @@error  if @iStatus = 0 and @iError <> 0  begin  select @iStatus = @iError  end  if (@iStatus <> 0) or (@iCalcDueDateErrState <> 0 or @dDISCDATE = NULL or @dDUEDATE = NULL )  begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCalcDueDateErrString))  select @O_iErrorState = 4610    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState)  end   if (@I_vDUEDATE = '')  select @I_vDUEDATE = @dDUEDATE   if (@I_vDISCDATE = '')  select @I_vDISCDATE = @dDISCDATE  end   if ((@I_vPRCTDISC > 100) or (@I_vPRCTDISC < 0))  begin  select @O_iErrorState = 4607      exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if (@I_vBatchCHEKBKID <> '')  begin  if (not exists(select 1 from CM00100 (nolock) where CHEKBKID = @I_vBatchCHEKBKID))  begin  select @O_iErrorState = 361     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if (exists(select 1 from CM00100 (nolock) where CHEKBKID = @I_vBatchCHEKBKID and INACTIVE = 1))  begin  select @O_iErrorState = 9518     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end   if (@I_vCAMCBKID <> '')  begin  if (not exists(select 1 from CM00100 (nolock) where CHEKBKID = @I_vCAMCBKID))  begin  select @O_iErrorState = 320     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if (exists(select 1 from CM00100 (nolock) where CHEKBKID = @I_vCAMCBKID and INACTIVE = 1))  begin  select @O_iErrorState = 9519     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end   if (@I_vCHAMCBID <> '')  begin  if (not exists(select 1 from CM00100 (nolock) where CHEKBKID = @I_vCHAMCBID))  begin  select @O_iErrorState = 322     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if (exists(select 1 from CM00100 (nolock) where CHEKBKID = @I_vCHAMCBID and INACTIVE = 1))  begin  select @O_iErrorState = 9520     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end   if (@I_vCHEKBKID <> '')  begin  if (not exists(select 1 from CM00100 (nolock) where CHEKBKID = @I_vCHEKBKID))  begin  select @O_iErrorState = 324     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if (exists(select 1 from CM00100 (nolock) where CHEKBKID = @I_vCHEKBKID and INACTIVE = 1))  begin  select @O_iErrorState = 9521     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end   if (@I_vSHIPMTHD is null)   begin  select @I_vSHIPMTHD = SHIPMTHD from PM00200 (nolock) where VENDORID = @I_vVENDORID  select @I_vSHIPMTHD = isnull(@I_vSHIPMTHD, '')  end    if (@I_vSHIPMTHD <> '')  begin  if (not exists (select 1 from SY03000 (nolock) where SHIPMTHD = @I_vSHIPMTHD))  begin  exec @iStatus = taCreateShippingMethod  @I_vSHIPMTHD = @I_vSHIPMTHD,  @I_vUpdateIfExists = 0,  @O_iErrorState = @iAddShippingErrState output,  @oErrString = @iAddShippingErrString output  select @iError = @@error  if ((@iStatus = 0) and (@iError <> 0))  begin  select @iStatus = @iError  end  if ((@iStatus <> 0) or (@iAddShippingErrState <> 0))  begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iAddShippingErrString))  select @O_iErrorState = 326   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end  end   if ((@I_vCASHAMNT > 0) and (@I_vCAMCBKID = ''))  begin  select @O_iErrorState = 327     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vCASHAMNT > 0) and (@I_vCAMTDATE = ''))  begin  select @O_iErrorState = 328     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vCASHAMNT > 0) and (@I_vCDOCNMBR = ''))  begin  select @O_iErrorState = 329     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vCASHAMNT > 0) and (@I_vCAMPMTNM = ''))  begin  select @O_iErrorState = 330     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vCASHAMNT > 0) and (@I_vCAMPMTNM <> ''))  begin  if (exists(select 1 from PM00400 (nolock) where CNTRLTYP = 1 and CNTRLNUM = @I_vCAMPMTNM))  begin  select @O_iErrorState = 331     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end   if ((@I_vCASHAMNT = 0) and (@I_vCAMCBKID <> '' or @I_vCAMPMTNM <> '' or @I_vCAMTDATE <> '' or @I_vCDOCNMBR <> ''))  begin  select @O_iErrorState = 332     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vCHEKAMNT > 0) and (@I_vCHAMCBID = ''))  begin  select @O_iErrorState = 333     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vCHEKAMNT > 0) and (@I_vCHEKDATE = ''))  begin  select @O_iErrorState = 334     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vCHEKAMNT > 0) and (@I_vCAMPYNBR = ''))  begin  select @O_iErrorState = 335     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vCHEKAMNT > 0) and (@I_vCHEKNMBR = ''))  begin  select @O_iErrorState = 336     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vCHEKAMNT > 0) and (@I_vCAMPYNBR <> ''))  begin  if (exists(select 1 from PM00400 (nolock) where CNTRLTYP = 1 and CNTRLNUM = @I_vCAMPYNBR))  begin  select @O_iErrorState = 337     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if (exists (select 1 from CM00100 (nolock) where DUPCHNUM = 0 and CHEKBKID = @I_vCHAMCBID))  begin  if (exists(select 1 from PM00400 (nolock) where DOCTYPE = 6 and VENDORID = @I_vVENDORID and DOCNUMBR = @I_vCHEKNMBR and CHEKBKID = @I_vCHAMCBID))  begin  select @O_iErrorState = 1643     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end   end   if ((@I_vCHEKAMNT = 0) and (@I_vCHAMCBID <> '' or @I_vCHEKNMBR <> '' or @I_vCHEKDATE <> '' or @I_vCAMPYNBR <> ''))  begin  select @O_iErrorState = 338     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vCRCRDAMT > 0) and (@I_vCARDNAME = ''))  begin  select @O_iErrorState = 339     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vCRCRDAMT > 0) and (@I_vCRCARDDT = ''))  begin  select @O_iErrorState = 340      exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vCRCRDAMT > 0) and (@I_vCCRCTNUM = ''))  begin  select @O_iErrorState = 341      exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vCRCRDAMT > 0) and (@I_vCCAMPYNM = ''))  begin  select @O_iErrorState = 342      exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vCRCRDAMT > 0) and (@I_vCCAMPYNM <> ''))  begin  if (exists(select 1 from PM00400 (nolock) where CNTRLTYP = 0 and CNTRLNUM = @I_vCCAMPYNM))  begin  select @O_iErrorState = 343     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end   if (@I_vCARDNAME <> '')   begin  if (not exists(select 1 from SY03100 (nolock) where CARDNAME = @I_vCARDNAME))  begin  select @O_iErrorState = 344     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end   if (@I_vRATETPID <> '')  begin  if (not exists(select 1 from MC40100 (nolock) where RATETPID = @I_vRATETPID))  begin  select @O_iErrorState = 560     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end   if (@I_vTEN99AMNT > 0)  begin  if (exists(select 1 from PM00200 (nolock) where VENDORID = @I_vVENDORID and TEN99TYPE < 2))  begin  select @O_iErrorState = 713     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end   if (@I_vTEN99AMNT > 0) and (@I_vPRCHAMNT - @I_vTRDISAMT < @I_vTEN99AMNT)  begin  select @O_iErrorState = 714     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   If (@I_vDOCTYPE <> 5)    Begin  select  @TEN99TYPE = TEN99TYPE,  @TEN99BOXNUMBER = TEN99BOXNUMBER  from PM00200 (nolock) where VENDORID = @I_vVENDORID  End  if (@O_iErrorState <> 0)  begin  break  end   insert PM00400  (  CNTRLNUM,  CNTRLTYP,  DCSTATUS,  DOCTYPE,  VENDORID,  DOCNUMBR,  TRXSORCE,   CHEKBKID,  DUEDATE,  DISCDATE,  BCHSOURC,  DOCDATE,  USERID   )  select  @I_vVCHNUMWK,    @CNTRLTYP,     @DCSTATUS,     @I_vDOCTYPE,    @I_vVENDORID,    @I_vDOCNUMBR,   '',        '',       @I_vDUEDATE,    @I_vDISCDATE,    @BCHSOURC,     @I_vDOCDATE,    @I_vMDFUSRID     if (@@error <> 0)  begin  select @O_iErrorState = 345     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end   if (@I_vCAMPMTNM <> '')  begin  insert PM00400  (  CNTRLNUM,   CNTRLTYP,   DCSTATUS,   DOCTYPE,   VENDORID,   DOCNUMBR,   TRXSORCE,  CHEKBKID,   BCHSOURC,   DOCDATE,   USERID   )  select  @I_vCAMPMTNM,   1,       @DCSTATUS,    6,      @I_vVENDORID,   @I_vCDOCNMBR,   '',      @I_vCAMCBKID,   @BCHSOURC,    @I_vCAMTDATE,   @I_vMDFUSRID    if (@@error <> 0)  begin  select @O_iErrorState = 346     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end  end   if (@I_vCAMPYNBR <> '')  begin  insert PM00400  (  CNTRLNUM,  CNTRLTYP,  DCSTATUS,  DOCTYPE,  VENDORID,  DOCNUMBR,  TRXSORCE,  CHEKBKID,  BCHSOURC,  DOCDATE,  USERID   )  select  @I_vCAMPYNBR,   1,       @DCSTATUS,    6,      @I_vVENDORID,   @I_vCHEKNMBR,   '',      @I_vCHAMCBID,   @BCHSOURC,    @I_vCHEKDATE,   @I_vMDFUSRID    if (@@error <> 0)  begin  select @O_iErrorState = 347     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end  end   select @CreditCardVendorID = VENDORID,  @PYBLGRBX = PYBLGRBX,  @RCVBGRBX = RCVBGRBX from SY03100 (nolock) where CARDNAME = @I_vCARDNAME   if ((@I_vDOCTYPE in (1,2,3,4)) and (@I_vCCAMPYNM <> ''))   begin  insert PM00400  (  CNTRLNUM,  CNTRLTYP,  DCSTATUS,  DOCTYPE,  VENDORID,  DOCNUMBR,  TRXSORCE,  CHEKBKID,  BCHSOURC,  DOCDATE,  USERID,     DUEDATE  )  select  @I_vCCAMPYNM,     case                 when @PYBLGRBX = 1  then 1  else 0  end,  @DCSTATUS,    case     when @I_vDOCTYPE = 4 and @PYBLGRBX = 0  then 5  when @PYBLGRBX = 1   then 6  else 1  end,   case         when @CreditCardVendorID <> ''  then @CreditCardVendorID  else @I_vVENDORID  end,  @I_vCCRCTNUM,    '',        '',     @BCHSOURC,       @I_vDOCDATE,  @I_vMDFUSRID,     @I_vDOCDATE  if (@@error <> 0)  begin  select @O_iErrorState = 348     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end  end   if (@I_vRequesterTrx=0)  begin  exec @iStatus = eConnectOutVerify  @I_vDOCTYPE='Payables_Transaction',  @I_vINDEX1=@I_vVCHNUMWK,  @I_vINDEX2=@I_vBACHNUMB,  @I_vINDEX3='',  @I_vINDEX4='',  @I_vINDEX5='',  @I_vINDEX6='',  @I_vINDEX7='',  @I_vINDEX8='',  @I_vINDEX9='',  @I_vINDEX10='',  @I_vINDEX11='',  @I_vINDEX12='',  @I_vINDEX13='',  @I_vINDEX14='',  @I_vINDEX15='',  @I_vDelete = 0,  @O_iErrorState = @iCustomState output  select @iError = @@error  if ((@iStatus = 0) and (@iError <> 0))  begin  select @iStatus = @iError  end  if ((@iStatus <> 0) or (@iCustomState <> 0))  begin  select @O_iErrorState = 1292   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  break  end  end   if (@ISMCTRX = 1)  begin  insert MC020103  (  DCSTATUS,  DOCTYPE,  VCHRNMBR,  PMNTNMBR,  DOCDATE,  VENDORID,  CURNCYID,  CURRNIDX,  RATETPID,  EXGTBLID,  XCHGRATE,  EXCHDATE,  TIME1,  RTCLCMTD,  ORCTRXAM,  OPURAMT,  ORFRTAMT,  OMISCAMT,  ORTAXAMT,  ORCASAMT,  ORCHKAMT,  ORCHKTTL,  ORCCDAMT,  ORAPPAMT,  ORDISTKN,  ORDATKN,  ORDDLRAT,  ORTDISAM,  ORWROFAM,  OBKPURAMT,  ORBKTFRT,  ORBKTMSC,  UNGANLOS,  RMMCERRS,  OCHGAMT,  ORDOCAMT,  ODISAMTAV,  ORGAPDISCTKN,  OTOTPAY,  OR1099AM,  DENXRATE,  MCTRXSTT,  OrigBackoutTradeDisc  )  select  1,     @I_vDOCTYPE,    @I_vVCHNUMWK,    '',     @I_vDOCDATE,    @I_vVENDORID,    @I_vCURNCYID,    @CURRNIDX,    @I_vRATETPID,    @EXGTBLID,    @I_vXCHGRATE,    @I_vEXCHDATE,    @I_vTIME1,    @I_vRTCLCMTD,    @ORCTRXAM,    @OPURAMT,    @ORFRTAMT,    @OMISCAMT,    @ORTAXAMT,    @ORCASAMT,    @ORCHKAMT,    0,     @ORCCDAMT,    0,     @ORDISTKN,    0,     @ORDDLRAT,    @ORTDISAM,    0,      @OBKPURAMT,    @ORBKTFRT,    @ORBKTMSC,    0,     0,     @OCHGAMT,    @ORDOCAMT,    @ODISAMTAV,    0,     0,     @OR1099AM,    0,     0,     0     if (@@error <> 0)  begin  select @O_iErrorState = 264    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end   if (@I_vXCHGRATE = 0)  begin  select @O_iErrorState = 552   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end   if ((@ISMCTRX = 1) and (@I_vRTCLCMTD = 0))     begin  select @I_vDOCAMNT = round((@I_vMSCCHAMT + @I_vPRCHAMNT + @I_vTAXAMNT + @I_vFRTAMNT - @I_vTRDISAMT)*@I_vXCHGRATE, @DECPLCUR)   select @I_vPRCHAMNT = round(@I_vPRCHAMNT * @I_vXCHGRATE, @DECPLCUR),   @BKTPURAM = round(@BKTPURAM * @I_vXCHGRATE, @DECPLCUR),  @I_vCASHAMNT = round(@I_vCASHAMNT * @I_vXCHGRATE, @DECPLCUR),    @I_vCHEKAMNT = round(@I_vCHEKAMNT * @I_vXCHGRATE, @DECPLCUR),   @I_vCRCRDAMT = round(@I_vCRCRDAMT * @I_vXCHGRATE, @DECPLCUR),   @I_vTRDISAMT = round(@I_vTRDISAMT * @I_vXCHGRATE, @DECPLCUR),   @I_vFRTAMNT =round(@I_vFRTAMNT * @I_vXCHGRATE, @DECPLCUR),   @BKTFRTAM = round(@BKTFRTAM * @I_vXCHGRATE, @DECPLCUR),  @I_vMSCCHAMT = round(@I_vMSCCHAMT * @I_vXCHGRATE, @DECPLCUR),   @BKTMSCAM =  round(@BKTMSCAM * @I_vXCHGRATE, @DECPLCUR),  @I_vDISTKNAM = round(@I_vDISTKNAM * @I_vXCHGRATE, @DECPLCUR),   @I_vTAXAMNT =round(@I_vTAXAMNT * @I_vXCHGRATE, @DECPLCUR),  @CURTRXAM = round(@CURTRXAM * @I_vXCHGRATE, @DECPLCUR)  end  else  if ((@ISMCTRX = 1) and (@I_vRTCLCMTD = 1))     begin  select @I_vDOCAMNT = round((@I_vMSCCHAMT + @I_vPRCHAMNT + @I_vTAXAMNT + @I_vFRTAMNT - @I_vTRDISAMT)/@I_vXCHGRATE, @DECPLCUR)  select @I_vPRCHAMNT = round(@I_vPRCHAMNT / @I_vXCHGRATE, @DECPLCUR),   @BKTPURAM = round(@BKTPURAM / @I_vXCHGRATE, @DECPLCUR),  @I_vCASHAMNT = round(@I_vCASHAMNT / @I_vXCHGRATE, @DECPLCUR),     @I_vCHEKAMNT = round(@I_vCHEKAMNT / @I_vXCHGRATE, @DECPLCUR),     @I_vCRCRDAMT = round(@I_vCRCRDAMT / @I_vXCHGRATE, @DECPLCUR),     @I_vTRDISAMT = round(@I_vTRDISAMT / @I_vXCHGRATE, @DECPLCUR),     @I_vFRTAMNT = round(@I_vFRTAMNT / @I_vXCHGRATE, @DECPLCUR),       @BKTFRTAM = round(@BKTFRTAM / @I_vXCHGRATE, @DECPLCUR),  @I_vMSCCHAMT = round(@I_vMSCCHAMT / @I_vXCHGRATE, @DECPLCUR),     @BKTMSCAM =  round(@BKTMSCAM / @I_vXCHGRATE, @DECPLCUR),  @I_vDISTKNAM = round(@I_vDISTKNAM / @I_vXCHGRATE, @DECPLCUR),     @I_vTAXAMNT = round(@I_vTAXAMNT / @I_vXCHGRATE, @DECPLCUR),  @CURTRXAM = round(@CURTRXAM / @I_vXCHGRATE,  @DECPLCUR)  end   if(@I_vDOCAMNT < 0.00)  Begin  select @I_vDOCAMNT = 0.00   End   select @I_vCHRGAMNT = @I_vDOCAMNT - @I_vCASHAMNT - @I_vCHEKAMNT - @I_vCRCRDAMT - @I_vDISTKNAM   if ((@ISMCTRX = 1) and (@I_vRTCLCMTD = 0))    begin  update PM10500 set  TAXAMNT  = round(TAXAMNT * @I_vXCHGRATE, @DECPLCUR),  ORTAXAMT = TAXAMNT,  PCTAXAMT = round(PCTAXAMT * @I_vXCHGRATE, @DECPLCUR), ORPURTAX = PCTAXAMT,  FRTTXAMT = round(FRTTXAMT * @I_vXCHGRATE, @DECPLCUR), ORFRTTAX = FRTTXAMT,  MSCTXAMT = round(MSCTXAMT * @I_vXCHGRATE, @DECPLCUR), ORMSCTAX = MSCTXAMT,   TDTTXPUR =  case  when TDTTXPUR <> 0 then round(TDTTXPUR * @I_vXCHGRATE, @DECPLCUR)   else round(@PRCHAMNT * @I_vXCHGRATE, @DECPLCUR)  end,  ORTXBPUR = case when ORTXBPUR <> 0 then ORTXBPUR else @PRCHAMNT end,  TXDTTPUR =  case  when TXDTTPUR <> 0 then round(TXDTTPUR * @I_vXCHGRATE, @DECPLCUR)  else round(@PRCHAMNT * @I_vXCHGRATE, @DECPLCUR)  end,  ORTOTPUR = case when ORTOTPUR <> 0 then ORTOTPUR else @PRCHAMNT end,  CURRNIDX = @CURRNIDX   where  VCHRNMBR = @I_vVCHNUMWK  if (@@error <> 0)  begin  select @O_iErrorState = 542   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end   update PM10100 set  DEBITAMT = round(DEBITAMT * @I_vXCHGRATE, @DECPLCUR),  ORDBTAMT = DEBITAMT,  CRDTAMNT = round(CRDTAMNT * @I_vXCHGRATE, @DECPLCUR),  ORCRDAMT = CRDTAMNT,  RATETPID = @I_vRATETPID,  EXGTBLID = @EXGTBLID,  XCHGRATE = @I_vXCHGRATE,  EXCHDATE = @I_vEXCHDATE,  TIME1 = @I_vTIME1,  RTCLCMTD = @I_vRTCLCMTD,  CURNCYID =   case  when @MCINSTALLED = 1  then @I_vCURNCYID  else ''  end,  CURRNIDX = @CURRNIDX  where VCHRNMBR = @I_vVCHNUMWK  if (@@error <> 0)  begin  select @O_iErrorState = 934    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end   end  else  if ((@ISMCTRX = 1) and (@I_vRTCLCMTD = 1))    begin  update PM10500  set  TAXAMNT  = round(TAXAMNT / @I_vXCHGRATE, @DECPLCUR),  ORTAXAMT = TAXAMNT,  PCTAXAMT = round(PCTAXAMT / @I_vXCHGRATE, @DECPLCUR), ORPURTAX = PCTAXAMT,  FRTTXAMT = round(FRTTXAMT / @I_vXCHGRATE, @DECPLCUR), ORFRTTAX = FRTTXAMT,  MSCTXAMT = round(MSCTXAMT / @I_vXCHGRATE, @DECPLCUR), ORMSCTAX = MSCTXAMT,  TDTTXPUR =  case  when TDTTXPUR <> 0 then round(TDTTXPUR / @I_vXCHGRATE, @DECPLCUR)   else round(@PRCHAMNT / @I_vXCHGRATE, @DECPLCUR)  end,  ORTXBPUR = case when ORTXBPUR <> 0 then ORTXBPUR else @PRCHAMNT end,  TXDTTPUR =  case  when TXDTTPUR <> 0 then round(TXDTTPUR / @I_vXCHGRATE, @DECPLCUR)  else round(@PRCHAMNT / @I_vXCHGRATE, @DECPLCUR)  end,  ORTOTPUR = case when ORTOTPUR <> 0 then ORTOTPUR else @PRCHAMNT end,  CURRNIDX = @CURRNIDX  where VCHRNMBR = @I_vVCHNUMWK  if (@@error <> 0)  begin  select @O_iErrorState = 543    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end   update PM10100 set  DEBITAMT = round(DEBITAMT / @I_vXCHGRATE, @DECPLCUR),  ORDBTAMT = DEBITAMT,  CRDTAMNT = round(CRDTAMNT / @I_vXCHGRATE, @DECPLCUR),  ORCRDAMT = CRDTAMNT,  RATETPID = @I_vRATETPID,  EXGTBLID = @EXGTBLID,  XCHGRATE = @I_vXCHGRATE,  EXCHDATE = @I_vEXCHDATE,  TIME1 = @I_vTIME1,  RTCLCMTD = @I_vRTCLCMTD,  CURNCYID =   case   when @MCINSTALLED = 1  then @I_vCURNCYID  else ''  end,  CURRNIDX = @CURRNIDX  where VCHRNMBR = @I_vVCHNUMWK  if (@@error <> 0)  begin  select @O_iErrorState = 935    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end  end   select @I_vTAXAMNT = isnull(sum(TAXAMNT),0) from PM10500 (nolock) where VCHRNMBR = @I_vVCHNUMWK and DOCTYPE = @I_vDOCTYPE and BKOUTTAX <> 1   update PM10000 set TAXAMNT = @I_vTAXAMNT where VCHNUMWK = @I_vVCHNUMWK and BACHNUMB = @I_vBACHNUMB  if (@@error <> 0)  begin  select @O_iErrorState = 4018    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end  end  else  begin   if (not exists(select 1 from PM00200 (nolock) where VENDORID=@I_vVENDORID and (CURNCYID = @I_vCURNCYID or CURNCYID = '')))  begin  update PM10100 set  CURNCYID = @I_vCURNCYID,  CURRNIDX = @CURRNIDX  where VCHRNMBR = @I_vVCHNUMWK  if (@@error <> 0)  begin  select @O_iErrorState = 4019    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end   update PM10500 set  CURRNIDX = @CURRNIDX  where VCHRNMBR = @I_vVCHNUMWK  if (@@error <> 0)  begin  select @O_iErrorState = 4020    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end  end  end   if ((not exists(select top 1 CURNCYID from IV00105 (nolock) where CURNCYID <> '')) and  (not exists(select top 1 CURNCYID from CM00100 (nolock) where CURNCYID <> '')))  begin  select @I_vCURNCYID = '', @CURRNIDX = 0  end   exec @iStatus = taPMDistributionCreate  @I_vDOCTYPE = @I_vDOCTYPE,  @I_vVCHNUMWK = @I_vVCHNUMWK,  @I_vVENDORID = @I_vVENDORID,  @I_vCURRNIDX = @CURRNIDX,  @I_vCURNCYID = @I_vCURNCYID,    @I_vDECPLCUR = @DECPLCUR,    @I_vPTDUSRID = @I_vPTDUSRID,  @I_vPRCHAMNT = @I_vPRCHAMNT,  @I_vTRDISAMT = @I_vTRDISAMT,  @I_vFRTAMNT = @I_vFRTAMNT,  @I_vMSCCHAMT = @I_vMSCCHAMT,  @I_vDISTKNAM = @I_vDISTKNAM,  @I_vCASHAMNT = @I_vCASHAMNT,  @I_vCHEKAMNT = @I_vCHEKAMNT,  @I_vCRCRDAMT = @I_vCRCRDAMT,  @I_vDOCAMNT = @I_vDOCAMNT,  @I_vDISAMTAV = @I_vDISAMTAV,  @I_vGSTDSAMT = 0,  @I_vCAMCBKID = @I_vCAMCBKID,  @I_vCHAMCBID = @I_vCHAMCBID,  @I_vCARDNAME = @I_vCARDNAME,  @I_vRATETPID = @I_vRATETPID,  @I_vXCHGRATE = @I_vXCHGRATE,  @I_vEXCHDATE = @I_vEXCHDATE,  @I_vEXPNDATE = @I_vEXPNDATE,  @I_vEXGTBLID = @EXGTBLID,  @I_vTIME1 = @I_vTIME1,  @I_vORCASHAMNT = @ORCASAMT,  @I_vORCHEKAMNT = @ORCHKAMT,  @I_vORCRCRDAMT = @ORCCDAMT,  @I_vORDISTKNAM = @ORDISTKN,  @I_vORTRDISAMT = @ORTDISAM,  @I_vORMSCCHAMT = @OMISCAMT,  @I_vORFRTAMNT = @ORFRTAMT,  @I_vORTAXAMNT = @ORTAXAMT,  @I_vORPRCHAMNT = @OPURAMT,  @I_vORDOCAMNT = @ORDOCAMT,  @I_vORDISAMTAV = @ODISAMTAV,  @I_vRTCLCMTD = @I_vRTCLCMTD,     @I_vCMPANYID = @CMPANYID,     @I_vINTERID = @INTERID,      @I_vCREATEDIST = @I_vCREATEDIST,    @O_iErrorState = @iUpdDistErrState output,  @oErrString = @oErrString output  select @iError = @@error  if ((@iStatus = 0) and (@iError <> 0))  select @iStatus = @iError  if (@iStatus <> 0) or (@iUpdDistErrState <> 0)  begin  if (@iUpdDistErrState <> 0)  begin  exec @iStatus = taUpdateString  @iUpdDistErrState,   @oErrString,  @oErrString output,  @iAddCodeErrState output  end  select @O_iErrorState = 349   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end  if (@@error <> 0)  begin  select @O_iErrorState = 350   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end   Begin  if exists (select Workflow_Type_Name from WF100001 where FormID = 252 ) and  exists (select 1 from WF100002 where WF100002.ACTIVE = 1 and Workflow_Type_Name = (select Workflow_Type_Name from WF100001 where FormID = 252 ))  select @Workflow_Status = 1   else  select @Workflow_Status = 9     end  insert PM10000  (  BACHNUMB,  BCHSOURC,  VCHNUMWK,  VENDORID,  DOCNUMBR,  DOCTYPE,  SOURCDOC,  DOCAMNT,  DOCDATE,  PSTGDATE,  VADCDTRO,     VADDCDPR,  PYMTRMID,  TAXSCHID,  DUEDATE,  DSCDLRAM,  DISCDATE,  PRCHAMNT,  CHRGAMNT,  CASHAMNT,  CAMCBKID,  CDOCNMBR,  CAMTDATE,  CAMPMTNM,  CHEKAMNT,  CHAMCBID,  CHEKDATE,  CAMPYNBR,  CRCRDAMT,  CCAMPYNM,  CHEKNMBR,  CARDNAME,  CCRCTNUM,  CRCARDDT,  CURNCYID,  CHEKBKID,  TRXDSCRN,  TRDISAMT,  TAXAMNT,  FRTAMNT,  TEN99AMNT,  UN1099AM,  MSCCHAMT,  PORDNMBR,  SHIPMTHD,  DISAMTAV,  DISTKNAM,  APDSTKAM,  WROFAMNT,  CURTRXAM,  TXENGCLD,  GSTDSAMT,  PGRAMSBJ,  PPSAMDED,  PPSTAXRT,  POSTED,  PSTGSTUS,  APPLDAMT,  VCHRNMBR,  CNTRLTYP,  MODIFDT,  MDFUSRID,  POSTEDDT,  PTDUSRID,  NOTEINDX,    BKTFRTAM,  BKTMSCAM,  BKTPURAM,  PCHSCHID,  FRTSCHID,  MSCSCHID,  PRINTED,  PRCTDISC,  RETNAGAM,  ICTRX,  ICDISTS,  Tax_Date,  PRCHDATE,  CORRCTN,  SIMPLIFD,  CORRNXST,  VCHRNCOR,  BNKRCAMT,  APLYWITH,  Electronic,  ECTRX,  DocPrinted,  TaxInvReqd,  BackoutTradeDisc,  CBVAT,      TEN99TYPE,  TEN99BOXNUMBER,  Workflow_Status  )  select  @I_vBACHNUMB,     @BCHSOURC,     @I_vVCHNUMWK,     @I_vVENDORID,     @I_vDOCNUMBR,     @I_vDOCTYPE,     '',      @I_vDOCAMNT,     @I_vDOCDATE,     @I_vPSTGDATE,     case       when @I_vDOCTYPE in (4,5)    then ''  else @I_vVADCDTRO  end,   @I_vVADDCDPR,     @I_vPYMTRMID,     @I_vTAXSCHID,     @I_vDUEDATE,     @I_vDSCDLRAM,     @I_vDISCDATE,     @I_vPRCHAMNT,     @I_vCHRGAMNT,     @I_vCASHAMNT,     @I_vCAMCBKID,     @I_vCDOCNMBR,     @I_vCAMTDATE,     @I_vCAMPMTNM,     @I_vCHEKAMNT,     @I_vCHAMCBID,     @I_vCHEKDATE,     @I_vCAMPYNBR,     @I_vCRCRDAMT,     @I_vCCAMPYNM,     @I_vCHEKNMBR,     @I_vCARDNAME,     @I_vCCRCTNUM,     @I_vCRCARDDT,     case       when @MCINSTALLED = 1  then @I_vCURNCYID  else ''  end,  @I_vCHEKBKID,     @I_vTRXDSCRN,     @I_vTRDISAMT,     @I_vTAXAMNT,     @I_vFRTAMNT,     @I_vTEN99AMNT,     @I_vTEN99AMNT,     @I_vMSCCHAMT,     @I_vPORDNMBR,     @I_vSHIPMTHD,     @I_vDISAMTAV,     @I_vDISTKNAM,     @I_vAPDSTKAM,     0,        @CURTRXAM,     1,      0,       0,      0,      0,      0,       20,      0,      @I_vVCHNUMWK,     @CNTRLTYP,     convert(varchar(12),getdate()),   @I_vMDFUSRID,     '',      @I_vPTDUSRID,     @NOTEINDX,     case      when @BKTFRTAM > 0  then @I_vFRTAMNT - @BKTFRTAM  else 0  end,  case      when @BKTMSCAM > 0  then @I_vMSCCHAMT - @BKTMSCAM  else 0  end,  case      when @BKTPURAM > 0   then @I_vPRCHAMNT - @BKTPURAM  else 0  end,   @I_vPCHSCHID,     @I_vFRTSCHID,     @I_vMSCSCHID,     0,      @I_vPRCTDISC * 100.0,    0,      0,      0,      @I_vTax_Date,     '',      0,      0,      0,      '',      0,      0,      0,       0,      0,       0,      0,      0,      @TEN99TYPE,     @TEN99BOXNUMBER,    @Workflow_Status  if (@@error <> 0)  begin  select @O_iErrorState = 351    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end  select @BACHNUMB = BACHNUMB from SY00500 (nolock) where BACHNUMB = @I_vBACHNUMB and BCHSOURC = 'PM_Trxent'  if (@BACHNUMB <> '')  begin  select @BatchExists = 1  end  if (@BatchExists = 1)  begin  if (@I_vBACHNUMB <> '' and @I_vBatchCHEKBKID = '')  begin  select @checkbookid = CHEKBKID from SY00500 (nolock) where BACHNUMB = @I_vBACHNUMB and BCHSOURC = 'PM_Trxent'  select @I_vBatchCHEKBKID = @checkbookid  end  else  begin  select @checkbookid = CHEKBKID from SY00500 (nolock) where BACHNUMB = @I_vBACHNUMB and BCHSOURC = 'PM_Trxent'  end  end else  begin  If @I_vBatchCHEKBKID = ''  begin   select @I_vBatchCHEKBKID = CHEKBKID from PM40100(nolock) where UNIQKEY = '1'  select @checkbookid = @I_vBatchCHEKBKID  begin  If (@I_vBatchCHEKBKID='')  begin  select @O_iErrorState = 11479     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end  end   end  else  begin  select @checkbookid = @I_vBatchCHEKBKID  end  end  if (@I_vBatchCHEKBKID <> @checkbookid)  begin  select @O_iErrorState = 11986     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   exec @iStatus = taCreateUpdateBatchHeaderRcd  @I_vBACHNUMB = @I_vBACHNUMB,  @I_vSERIES = 4,  @I_vGLPOSTDT = @I_vPSTGDATE,     @I_vBCHSOURC = 'PM_Trxent',  @I_vDOCAMT = @I_vDOCAMNT,   @I_vORIGIN = 1,  @I_vNUMOFTRX = 1,  @I_vCHEKBKID = @I_vBatchCHEKBKID,  @O_iErrorState = @iAddBatchErrState output,  @oErrString = @iCreateBatchErrString output  if ((@iAddBatchErrState <> 0) or (@iStatus <> 0))  begin  if (@iAddBatchErrState = 12012)   begin  exec @iStatus = taUpdateString  @iAddBatchErrState,  @oErrString,  @oErrString output,  @O_oErrorState output  end   select @O_iErrorState = 352    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  break  end  select @iStatement = 1  break end  if (@O_iErrorState <> 0)  return (@O_iErrorState)  exec @iStatus = taPMTransactionInsertPost  @I_vBACHNUMB,  @I_vVCHNUMWK,  @I_vVENDORID,  @I_vDOCNUMBR,  @I_vDOCTYPE,  @I_vDOCAMNT,  @I_vDOCDATE,  @I_vPSTGDATE,  @I_vVADCDTRO,      @I_vVADDCDPR,  @I_vPYMTRMID,  @I_vTAXSCHID,  @I_vDUEDATE,  @I_vDSCDLRAM,  @I_vDISCDATE,  @I_vPRCHAMNT,  @I_vCHRGAMNT,  @I_vCASHAMNT,  @I_vCAMCBKID,  @I_vCDOCNMBR,  @I_vCAMTDATE,  @I_vCAMPMTNM,  @I_vCHEKAMNT,  @I_vCHAMCBID,  @I_vCHEKDATE,  @I_vCAMPYNBR,  @I_vCRCRDAMT,  @I_vCCAMPYNM,  @I_vCHEKNMBR,  @I_vCARDNAME,  @I_vCCRCTNUM,  @I_vCRCARDDT,  @I_vCHEKBKID,  @I_vTRXDSCRN,  @I_vTRDISAMT,  @I_vTAXAMNT,  @I_vFRTAMNT,  @I_vTEN99AMNT,  @I_vMSCCHAMT,  @I_vPORDNMBR,  @I_vSHIPMTHD,  @I_vDISAMTAV,  @I_vDISTKNAM,  @I_vAPDSTKAM,  @I_vMDFUSRID,  @I_vPOSTEDDT,  @I_vPTDUSRID,  @I_vPCHSCHID,  @I_vFRTSCHID,  @I_vMSCSCHID,  @I_vPRCTDISC,  @I_vTax_Date,  @I_vCURNCYID,  @I_vXCHGRATE,  @I_vRATETPID,  @I_vEXPNDATE,  @I_vEXCHDATE,  @I_vEXGTBDSC,  @I_vEXTBLSRC,  @I_vRATEEXPR,  @I_vDYSTINCR,  @I_vRATEVARC,  @I_vTRXDTDEF,  @I_vRTCLCMTD,  @I_vPRVDSLMT,  @I_vDATELMTS,  @I_vTIME1,  @I_vBatchCHEKBKID,  @I_vCREATEDIST,  @I_vRequesterTrx,  @I_vUSRDEFND1,  @I_vUSRDEFND2,  @I_vUSRDEFND3,  @I_vUSRDEFND4,  @I_vUSRDEFND5,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if ((@iStatus = 0) and (@iError <> 0)) begin  select @iStatus = @iError end if (@iStatus <> 0) or (@iCustomState <> 0) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  select @O_iErrorState = 154    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if (@I_vRequesterTrx = 0) begin  exec @iStatus = eConnectOutVerify  @I_vDOCTYPE = 'Payables_Transaction',  @I_vINDEX1 = @I_vVCHNUMWK,  @I_vINDEX2 = @I_vBACHNUMB,  @I_vINDEX3 = '',  @I_vINDEX4 = '',  @I_vINDEX5 = '',  @I_vINDEX6 = '',  @I_vINDEX7 = '',  @I_vINDEX8 = '',  @I_vINDEX9 = '',  @I_vINDEX10 = '',  @I_vINDEX11 = '',  @I_vINDEX12 = '',  @I_vINDEX13 = '',  @I_vINDEX14 = '',  @I_vINDEX15 = '',  @I_vDelete = 1,  @O_iErrorState = @iCustomState output  select @iError = @@error  if ((@iStatus = 0) and (@iError <> 0))  begin  select @iStatus = @iError  end  if (@iStatus <> 0) or (@iCustomState <> 0)  begin  select @O_iErrorState = 3343   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end  return (@O_iErrorState)   
GO
GRANT EXECUTE ON  [dbo].[taPMTransactionInsert] TO [DYNGRP]
GO
