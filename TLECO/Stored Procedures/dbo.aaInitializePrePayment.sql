SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aaInitializePrePayment]  @PONUMBER CHAR(21),  @CompanyID SMALLINT,  @SqlSessionID INTEGER,  @AcctIndxPrePay INTEGER,  @AcctIndxCash INTEGER,  @Flag TINYINT,  @aaSubLedgerHdrID INTEGER OUTPUT,  @l_ErrorCode SMALLINT = NULL OUTPUT AS  BEGIN   DECLARE   @SEQNUMBR INTEGER,  @SERIES SMALLINT,  @DISTTYPE SMALLINT,  @CURNCYID CHAR(15),  @CURRNIDX SMALLINT,  @RATETPID CHAR(15),  @XCHGRATE NUMERIC(19,7), @RATECALC SMALLINT,  @GLPOSTDT DATETIME,  @CURTRXAM NUMERIC(19,7),  @ORCTRXAM NUMERIC(19,7), @PrePayAcctIndx INTEGER,  @CshActIndx INTEGER,  @aaSubLedgerDistID INTEGER,  @ACTINDX INTEGER,  @ACCTTYPE SMALLINT,  @ClassID INTEGER,  @aaBrowseType SMALLINT,  @DECPLCUR SMALLINT,  @DEBITAMT NUMERIC(19,7),  @ORGDBTAMT NUMERIC(19,7), @CRDTAMT NUMERIC(19,7),  @ORGCRDTAMT NUMERIC(19,7), @NOTEINDX NUMERIC(19,5),  @oRequiredFieldEmpty TINYINT,  @EXCHDATE DATETIME,  @TIME1 DATETIME,  @DENXRATE NUMERIC(19,5),  @MCTRXSTT SMALLINT,  @EXGTBLID CHAR(15)  SELECT @SERIES = 4, @aaSubLedgerDistID = 1, @SEQNUMBR = 16384,@aaSubLedgerHdrID = 0  SELECT TOP 1  @DISTTYPE = PYENTTYP, @CURNCYID = CURNCYID, @CURRNIDX = CURRNIDX, @RATETPID = RATETPID, @EXGTBLID = EXGTBLID,@XCHGRATE = XCHGRATE,  @EXCHDATE = EXCHDATE, @TIME1 = TIME1, @RATECALC = RATECALC, @DENXRATE = DENXRATE, @MCTRXSTT = MCTRXSTT,  @GLPOSTDT = GLPOSTDT, @CURTRXAM = PrepaymentAmount, @ORCTRXAM = OriginatingPrepaymentAmt, @PrePayAcctIndx = PrepaymentAccountIndex , @CshActIndx = Cash_Account_Index  FROM POP10170 where PONUMBER = @PONUMBER    if @Flag = 1  SELECT @AcctIndxPrePay = @PrePayAcctIndx , @AcctIndxCash = @CshActIndx   SELECT @aaSubLedgerHdrID = ISNULL(aaSubLedgerHdrID,0) FROM AAG20000 WHERE DOCNUMBR = @PONUMBER AND DOCTYPE = 1 AND SERIES = @SERIES  IF @aaSubLedgerHdrID = 0   BEGIN  EXEC DYNAMICS.dbo.aagGetNextID 20000, @CompanyID, @aaSubLedgerHdrID output    INSERT INTO AAG20000  (aaSubLedgerHdrID,SERIES,DOCTYPE,DOCNUMBR,Master_ID,aaHdrErrors)  values   (@aaSubLedgerHdrID,@SERIES,1,@PONUMBER,'',0)   END   SELECT TOP 1 @DECPLCUR = A.DECPLCUR-1 FROM DYNAMICS..MC40200 A WHERE A.CURNCYID = @CURNCYID   While @aaSubLedgerDistID <= 2  BEGIN  IF @aaSubLedgerDistID = 1  BEGIN  SELECT @ACTINDX = @AcctIndxPrePay,  @DEBITAMT   = @CURTRXAM,   @ORGDBTAMT  = @ORCTRXAM,   @CRDTAMT    = 0,   @ORGCRDTAMT = 0  END  ELSE  BEGIN  SELECT @ACTINDX = @AcctIndxCash,  @DEBITAMT   = 0,   @ORGDBTAMT  = 0,   @CRDTAMT    = @CURTRXAM,   @ORGCRDTAMT = @ORCTRXAM  END   IF NOT EXISTS (SELECT TOP 1 1 FROM AAG20001 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID   AND aaSubLedgerDistID = @aaSubLedgerDistID   AND ACTINDX = @ACTINDX   AND ((DEBITAMT = @CURTRXAM and ORDBTAMT = @ORCTRXAM)   OR (ORCRDAMT = @ORCTRXAM AND CRDTAMNT = @CURTRXAM)  )  AND CURNCYID = @CURNCYID AND CURRNIDX = @CURRNIDX AND RATETPID = @RATETPID   AND EXGTBLID = @EXGTBLID AND XCHGRATE = @XCHGRATE AND EXCHDATE = @EXCHDATE   AND TIME1 = @TIME1 AND RTCLCMTD = @RATECALC AND DENXRATE = @DENXRATE   AND MCTRXSTT = @MCTRXSTT AND GLPOSTDT = @GLPOSTDT  )  BEGIN  DELETE FROM AAG20001 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID  DELETE FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID  DELETE FROM AAG20003 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID  END  ELSE  BEGIN  SET @aaSubLedgerDistID = @aaSubLedgerDistID + 1  SET @SEQNUMBR = @SEQNUMBR + 16384  CONTINUE  END   IF @ACTINDX = 0  BEGIN  SET @aaSubLedgerDistID = @aaSubLedgerDistID + 1  SET @SEQNUMBR = @SEQNUMBR + 16384  CONTINUE  END   SELECT TOP 1 @ACCTTYPE = ACCTTYPE FROM GL00100 WHERE @ACTINDX = @ACTINDX  EXEC aagGetClassIDBrowseType   @ACTINDX,   @ClassID OUTPUT,   @aaBrowseType OUTPUT    EXEC DYNAMICS.dbo.smGetNextNoteIndex @CompanyID, @SqlSessionID, @NOTEINDX OUTPUT   INSERT INTO AAG20001 (  [aaSubLedgerHdrID], [aaSubLedgerDistID], [INTERID], [CorrespondingUnit], [ACTINDX], [DISTTYPE], [SEQNUMBR],  [ACCTTYPE], [aaBrowseType], [DECPLACS], [DEBITAMT], [ORDBTAMT], [CRDTAMNT],  [ORCRDAMT], [CURNCYID], [CURRNIDX],   [RATETPID], [EXGTBLID], [XCHGRATE], [EXCHDATE], [TIME1], [RTCLCMTD], [DENXRATE], [MCTRXSTT],  [GLPOSTDT], [aaCopyStatus], [aaWinWasOpen],  [aaChangeDate],[aaChangeTime])  VALUES (   @aaSubLedgerHdrID, @aaSubLedgerDistID, DB_NAME(), '', @ACTINDX, @DISTTYPE, @SEQNUMBR,   ISNULL(@ACCTTYPE,0), @aaBrowseType, ISNULL( @DECPLCUR,0), @DEBITAMT, @ORGDBTAMT, @CRDTAMT, @ORGCRDTAMT, @CURNCYID, @CURRNIDX,  @RATETPID, @EXGTBLID, @XCHGRATE, @EXCHDATE, @TIME1, @RATECALC, @DENXRATE, @MCTRXSTT,  @GLPOSTDT, 8, 0, CONVERT(CHAR(12), GETDATE(), 102), CONVERT(CHAR(12), GETDATE(), 108))   INSERT INTO AAG20002 ([aaSubLedgerHdrID], [aaSubLedgerDistID], [aaSubLedgerAssignID], [DEBITAMT], [ORDBTAMT], [CRDTAMNT],  [ORCRDAMT], [aaAssignedPercent],[NOTEINDX])  VALUES( @aaSubLedgerHdrID, @aaSubLedgerDistID, 1, @DEBITAMT, @ORGDBTAMT, @CRDTAMT, @ORGCRDTAMT, 10000, @NOTEINDX)   IF @aaBrowseType <> 0   AND NOT EXISTS  (SELECT 1 FROM AAG20003  WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID  AND aaSubLedgerDistID = @aaSubLedgerDistID   AND aaSubLedgerAssignID = 1)  BEGIN   EXEC aagSubWorkCodeUpdate   @aaSubLedgerHdrID,   @aaSubLedgerDistID,   1,   @ClassID,   @oRequiredFieldEmpty OUTPUT  END  SET @aaSubLedgerDistID = @aaSubLedgerDistID + 1  SET @SEQNUMBR = @SEQNUMBR + 16384  END  END   
GO
GRANT EXECUTE ON  [dbo].[aaInitializePrePayment] TO [DYNGRP]
GO
