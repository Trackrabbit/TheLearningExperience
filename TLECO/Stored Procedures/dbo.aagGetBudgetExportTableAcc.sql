SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aagGetBudgetExportTableAcc] ( @aaBudgetID INTEGER   , @InStrAcc CHAR(30)  , @InStrDes CHAR(30)  , @InStrPer CHAR(30)  , @InStrOpBal CHAR(30)  )  AS  BEGIN SET NOCOUNT ON DECLARE @aaTrxCount INTEGER, @aaPerCount INTEGER , @aaBudgetTreeID INTEGER, @nColCount INTEGER , @nRowCount INTEGER, @nCodeCount INTEGER , @ExecString VARCHAR(8000),@aaLvlCodeString VARCHAR(51), @nCount INTEGER, @aaCodeSequence INTEGER,  @RetString CHAR(6000), @aaRetPeriod VARCHAR(6000),  @aaFieldString VARCHAR(8000) , @aaBudgetTree VARCHAR(51), @aaFieldString1 VARCHAR(8000), @aaBlankString VARCHAR(6000), @aaFieldString_A VARCHAR(8000),  @aaFieldString1_A VARCHAR(8000), @aaFieldStringNum1 VARCHAR(8000),@aaFieldStringNum VARCHAR(8000), @TempTable VARCHAR(50), @TempTable_Temp VARCHAR(50), @TempTableQuery VARCHAR(8000), @TempTableQuery_Temp VARCHAR(8000)  SELECT @aaBudgetTreeID = aaBudgetTreeID FROM AAG00903  WHERE aaBudgetID = @aaBudgetID SELECT @aaBudgetTree = aaBudgetTree FROM AAG00900 WHERE aaBudgetTreeID = @aaBudgetTreeID SELECT @aaTrxCount = COUNT ( * ) FROM AAG00901 WHERE aaBudgetTreeID = @aaBudgetTreeID   SELECT @aaPerCount = COUNT ( PERIODDT ) FROM AAG00904 WHERE aaBudgetID = @aaBudgetID and aaCodeSequence = 1   SELECT @nColCount = ( 1 + @aaTrxCount + ( @aaPerCount * 2 ) + 1 ) SELECT @nCodeCount = COUNT ( DISTINCT aaCodeSequence ) FROM AAG00904 WHERE aaBudgetID = @aaBudgetID  SELECT @nRowCount = 3 + @nCodeCount + 1 SELECT @ExecString = ''  select @TempTable = '##TEMP_TEMP'  + REPLACE(system_user,'''','') + db_name() select @TempTable_Temp = '##TEMPTEST_TEMP'  + REPLACE(system_user,'''','') + db_name() select @TempTableQuery = 'DROP TABLE [' +  @TempTable + ']' select @TempTableQuery_Temp = 'DROP TABLE [' + @TempTable_Temp + ']'  IF EXISTS (SELECT [name] FROM tempdb.dbo.sysobjects WHERE [name]  = @TempTable )  exec (@TempTableQuery)  EXEC aagGetFieldNameStringAcc  @aaBudgetID,  @InStrAcc,  @InStrDes,  @InStrPer, @InStrOpBal,  @aaFieldString OUTPUT,  @aaFieldString_A OUTPUT, @aaFieldString1 OUTPUT, @aaFieldString1_A OUTPUT  EXEC aagGetExpFieldNameString @aaBudgetID, @InStrAcc, @InStrDes, @aaFieldStringNum OUTPUT, @aaFieldStringNum1 OUTPUT   SELECT @ExecString = @aaFieldString + @aaFieldString_A + ' INTO [' + @TempTable + '] ' EXEC ( @ExecString )   SELECT @ExecString = 'INSERT INTO [' + @TempTable + '] ' + @aaFieldString1 + @aaFieldString1_A EXEC ( @ExecString )   SELECT @ExecString = ''  Declare CodeSeqence cursor fast_forward for SELECT aaCodeSequence, LTRIM(RTRIM(aaLvlCodeString))  FROM AAG00902  WHERE aaBudgetTreeID = @aaBudgetTreeID  ORDER BY aaCodeSequence open CodeSeqence fetch next from CodeSeqence into @aaCodeSequence, @aaLvlCodeString WHILE @@fetch_status = 0  BEGIN EXEC aagGetTrxDescrSet  @aaLvlCodeString,  @aaTrxCount,  @aaCodeSequence,  @aaBudgetTree, @RetString OUTPUT   EXEC aagGetPeriodBalanceStringAcc  @aaBudgetID,  @aaCodeSequence,  @aaRetPeriod OUTPUT  SET @ExecString = LTRIM(RTRIM(@RetString)) + LTRIM( RTRIM( @aaRetPeriod ) )   EXEC ('INSERT INTO [' + @TempTable + '] ' + @ExecString) EXEC aagGetTrxDescrSet '',  @aaTrxCount,  @aaCodeSequence,  '',  @aaBlankString OUTPUT   EXEC aagGetPeriodAccountsString  @aaBudgetID,  @aaCodeSequence,  @aaBlankString  fetch next from CodeSeqence into @aaCodeSequence, @aaLvlCodeString END close CodeSeqence deallocate CodeSeqence  IF EXISTS (SELECT [name] FROM tempdb.dbo.sysobjects WHERE [name]  = @TempTable_Temp )   exec (@TempTableQuery_Temp)  SELECT @ExecString = @aaFieldStringNum + @aaFieldStringNum1 +  ' INTO [' + @TempTable_Temp + '] from [' + @TempTable + '] where RowID > 2 order by RowID  ' EXEC ( @ExecString )  RETURN SET NOCOUNT OFF END     
GO
GRANT EXECUTE ON  [dbo].[aagGetBudgetExportTableAcc] TO [DYNGRP]
GO
