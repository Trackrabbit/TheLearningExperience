SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[rmnaUpdateCustomer]  @I_sAction           smallint        = NULL,  @I_tApplyInactiveStatus tinyint         = NULL,   @I_cCustomerID char(15) = NULL,  @I_cParentID char(15) = NULL,  @O_sUpdateStatus        smallint = NULL  output,  @O_iErrorState          int             = NULL  output as  declare  @sADOPT    smallint,  @sRELEASE   smallint,  @sOPENUPDFAILED   smallint,  @sWORKOPENEXIST    smallint,  @sAPPLYEXIST smallint,  @sCUSTUPDFAILED   smallint,  @sALREADYNA    smallint,  @iStatus    int,  @tTransaction tinyint,  @tLoop tinyint,  @TRUE tinyint,  @tInactiveParent tinyint,  @sOPEN smallint,  @sWORK    smallint,  @iError int,  @iRowCount int,  @cCustomer char(15)  select   @O_iErrorState   = 0,  @O_sUpdateStatus  = 0,  @sADOPT   = 2,  @sRELEASE    = 3,  @sWORKOPENEXIST    = 1,  @sAPPLYEXIST  = 2,  @sCUSTUPDFAILED   = 3,  @sALREADYNA    = 4,  @sOPENUPDFAILED   = 5,  @iStatus  = 0,  @TRUE   = 1,  @tInactiveParent  = 0,  @sOPEN   = 2,  @sWORK    = 1  while (@tLoop is NULL) begin  select @tLoop = 1   if  @I_sAction           is NULL or  @I_cCustomerID is NULL or  @I_tApplyInactiveStatus is NULL or  @I_cParentID is NULL  begin  select @O_iErrorState = 21058  break   end   if  @I_sAction <> @sADOPT  and   @I_sAction <> @sRELEASE and  @I_tApplyInactiveStatus <> 0 and  @I_tApplyInactiveStatus <> 1  begin  select @O_iErrorState = 21059  break   end   if @@trancount = 0  begin  select @tTransaction = 1  begin transaction  end    if @I_sAction = @sADOPT   begin  if (@I_cParentID <> @I_cCustomerID)  begin   if @I_tApplyInactiveStatus = @TRUE   begin  select   @tInactiveParent = INACTIVE   from   RM00101 with (NOLOCK)   where   CUSTNMBR = @I_cParentID   if @tInactiveParent = @TRUE  begin   select   @O_sUpdateStatus = @sWORKOPENEXIST   where exists(  select   1   from   RM00401 with (NOLOCK)   where   CUSTNMBR = @I_cCustomerID  and (DCSTATUS = @sOPEN or   DCSTATUS = @sWORK)   )   if @O_sUpdateStatus <> 0   break    end  end  end  select   @cCustomer =  CUSTNMBR   from  RM00101 with (NOLOCK)  where  CUSTNMBR = @I_cCustomerID   and CPRCSTNM <> ''  and CPRCSTNM <> @I_cParentID   select  @iRowCount = @@rowcount    if (@iRowCount = 1)   begin  select @O_sUpdateStatus = @sALREADYNA   break  end   update  RM00101  set   CPRCSTNM = @I_cParentID  where  CUSTNMBR = @I_cCustomerID   and CPRCSTNM = ''   select @iError = @@error   if  (@iError <> 0)  begin  select @O_sUpdateStatus = @sCUSTUPDFAILED   select @iStatus = @iError  break  end   update   RM20101  set   CPRCSTNM = @I_cParentID  where  CUSTNMBR = @I_cCustomerID  select @iError = @@error  if  (@iError <> 0)  begin  select @O_sUpdateStatus = @sOPENUPDFAILED   select @iStatus = @iError  break   end    update   RM30101  set   CPRCSTNM = @I_cParentID  where  CUSTNMBR = @I_cCustomerID  select @iError = @@error  if  (@iError <> 0)  begin  select @O_sUpdateStatus = @sOPENUPDFAILED   select @iStatus = @iError  break   end    end  else  begin  if @I_cParentID <> @I_cCustomerID  begin  select   @O_sUpdateStatus = @sAPPLYEXIST   where exists(  select   1   from   RM20201 with (NOLOCK)   where   CPRCSTNM = @I_cParentID   and CUSTNMBR = @I_cCustomerID  )  if @O_sUpdateStatus <> 0   break  select   @O_sUpdateStatus = @sAPPLYEXIST   where exists(  select   1   from   RM30201 with (NOLOCK)   where   CPRCSTNM = @I_cParentID   and CUSTNMBR = @I_cCustomerID  )  if @O_sUpdateStatus <> 0   break  end   update  RM00101  set   CPRCSTNM = ''   where  CUSTNMBR = @I_cCustomerID   select @iError = @@error   if (@@rowcount <> 1) or (@iError <> 0)  begin  select @iStatus = @iError  break  end   update   RM20101  set   CPRCSTNM = ''  where  CUSTNMBR = @I_cCustomerID   select @iError = @@error   if  (@iError <> 0)  begin  select @O_sUpdateStatus = @sOPENUPDFAILED   select @iStatus = @iError  break  end    update   RM30101  set   CPRCSTNM = ''  where  CUSTNMBR = @I_cCustomerID   select @iError = @@error   if  (@iError <> 0)  begin  select @O_sUpdateStatus = @sOPENUPDFAILED   select @iStatus = @iError  break  end    end   end   if @iStatus <> 0 or @O_iErrorState <> 0  or @O_sUpdateStatus <> 0  begin  if @tTransaction = 1  rollback transaction  end else if @tTransaction = 1  commit transaction  return (@iStatus)   
GO
GRANT EXECUTE ON  [dbo].[rmnaUpdateCustomer] TO [DYNGRP]
GO
