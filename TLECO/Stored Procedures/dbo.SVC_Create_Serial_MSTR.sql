SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_Create_Serial_MSTR]  @SerialNumber char(21),  @ItemNumber char(31),  @CustomerNumber char(15),  @AddressCode char(15),  @UserID char(15),  @VendorID char(15),  @EquipID integer OUTPUT,  @ReferenceFrom smallint = 0,  @Reference char(31) = '',  @AssetTag char(21) = '' As declare @SERLNMBR char(21)  declare @ITEMNMBR char(31)  declare @SRLSTAT char(11)  declare @INSTDTE datetime  declare @CUSTNMBR char(15)  declare @ADRSCODE char(15)  declare @ADDRESS1 char(31)  declare @ADDRESS2 char(31)  declare @ADDRESS3 char(31)  declare @CITY char(31)  declare @STATECD char(30)  declare @ZIP char(11)  declare @COUNTRY char(21)  declare @CNTCPRSN char(31)  declare @TECHID char(11)  declare @OFFID char(11)  declare @SVCAREA char(11)  declare @TIMEZONE char(3)  declare @WARRCDE char(11)  declare @WARREND datetime  declare @WARRSTART datetime  declare @SLRWARR char(11)  declare @SLRWEND datetime  declare @SLRWSTART datetime declare @WarrantyDays integer declare @Do_Seller_Warranty smallint declare @Do_Vendor_Warranty smallint declare @PM_Month smallint declare @PM_Day smallint declare @MinDate datetime declare @AuditDesc char(30) declare @SOPNumber char(20) declare @EquipReference char(31) declare @Qty numeric(19,5)  exec smGetMinDate @MinDate output   select @VendorID = isnull(@VendorID,''),  @EquipID = 0,  @SERLNMBR = '',  @AuditDesc = '',  @Qty = 1  select @EquipID = EQUIPID from SVC00300 where  SERLNMBR = @SerialNumber and  ITEMNMBR = @ItemNumber and  CUSTNMBR = @CustomerNumber if @EquipID = 0 BEGIN  if @CustomerNumber is NULL or @AddressCode is NULL   return   select @EquipID = EQUIPID from SVC00300 where SERLNMBR = @SerialNumber and ITEMNMBR = @ItemNumber  if @EquipID > 0  return   IF @VendorID = ''   begin  select @VendorID = VENDORID from SVC00951 where ITEMNMBR = @ItemNumber  select @VendorID = isnull(@VendorID,'')  end  exec SVC_New_Equip_ID @EquipID OUTPUT  select @Do_Seller_Warranty = SVC_Seller_Warranty_Flag,  @Do_Vendor_Warranty = SVC_Vendor_Warranty_Flag from SVC00998  select @WARRCDE = WARRCDE,  @SLRWARR = SLRWARR  from SVC00951 where ITEMNMBR = @ItemNumber   if (@SLRWARR > '') and @Do_Seller_Warranty > 1   BEGIN  select @WarrantyDays = WRNTYDYS from SVC00906 where WARRCDE = @SLRWARR and VENDORID = ''   select @WarrantyDays = isnull(@WarrantyDays,0)  if (@Do_Seller_Warranty = 2 and  @ReferenceFrom = 4)   begin  select @SLRWSTART = @MinDate  select @SLRWEND = @MinDate  end  else  begin  select @SLRWSTART = DATERECD from IV00200 where ITEMNMBR = @ItemNumber and SERLNMBR = @SerialNumber   select @SLRWSTART = isnull(@SLRWSTART,CONVERT(varchar(10),GETDATE(),102))  select @SLRWEND = DATEADD(day,@WarrantyDays,@SLRWSTART )  end  END  else  BEGIN  select @SLRWARR = ''  select @SLRWSTART = @MinDate  select @SLRWEND = @MinDate  END  if @Do_Vendor_Warranty > 1 and (@WARRCDE > '')  BEGIN  select @WarrantyDays = WRNTYDYS  from SVC00906 where WARRCDE = @WARRCDE and VENDORID = @VendorID   select @WarrantyDays = isnull(@WarrantyDays,0)  select @WARRSTART = DATERECD from IV00200 where ITEMNMBR = @ItemNumber and SERLNMBR = @SerialNumber  select @WARRSTART = isnull(@WARRSTART,CONVERT(varchar(10),GETDATE(),102))  select @WARREND = DATEADD(day,@WarrantyDays,@WARRSTART )  END  else  BEGIN  select @WARRCDE = ''  select @WARRSTART = @MinDate  select @WARREND = @MinDate  END  select @CNTCPRSN = CNTCPRSN,  @ADDRESS1 = ADDRESS1,  @ADDRESS2 = ADDRESS2,  @ADDRESS3 = ADDRESS3,  @CITY = CITY,  @STATECD = STATE,  @COUNTRY = COUNTRY,  @ZIP = ZIP  from RM00102  where CUSTNMBR = @CustomerNumber and ADRSCODE = @AddressCode  if exists (select * from SVC00950 where CUSTNMBR = @CustomerNumber and ADRSCODE = @AddressCode)  BEGIN  select @SVCAREA = SVCAREA,  @OFFID = OFFID,  @TECHID = TECHID,  @PM_Month = SVC_PM_Date,  @PM_Day = SVC_PM_Day,  @TIMEZONE = TIMEZONE  from SVC00950   where CUSTNMBR = @CustomerNumber and ADRSCODE = @AddressCode  END  else  BEGIN  select @OFFID = OFFID, @TIMEZONE = TIMEZONE,  @SRLSTAT = SRLSTAT  from SVC00998  END  select @SRLSTAT = SRLSTAT from SVC00998 if (select ITMTRKOP from IV00101 where ITEMNMBR = @ItemNumber) = 2  select @SERLNMBR = @SerialNumber  else if @ReferenceFrom = 7 and exists(select 1 from MOP1041 where MOPDOCNUM = @AssetTag and MANUFACTUREORDER_I = @Reference and ITEMNMBR = @ItemNumber)  select @Qty = QUANTITY from MOP1041 where MOPDOCNUM = @AssetTag and MANUFACTUREORDER_I = @Reference and ITEMNMBR = @ItemNumber  if @ReferenceFrom = 3   select @SOPNumber = substring(@Reference,1,20) if @ReferenceFrom = 7   select @EquipReference = @Reference else  select @EquipReference = ''  insert SVC00300   select  @EquipID,  @SerialNumber,   @ItemNumber,   @EquipReference,   '',   isnull(@SRLSTAT,''),  CONVERT(varchar(10),GETDATE(),102) + ' 00:00:00',  @CustomerNumber,   isnull(@AddressCode,''),  isnull(@ADDRESS1,''),  isnull(@ADDRESS2,''),   isnull(@CITY,''),  isnull(@STATECD,''),   isnull(@ZIP,''),   isnull(@COUNTRY,''),   isnull(@CNTCPRSN,''),  @MinDate,   @MinDate,   isnull(@TECHID,''),   '',   isnull(@OFFID,''),  isnull(@SVCAREA,''),   isnull(@TIMEZONE,''),  isnull(@WARRCDE,''),  isnull(@WARREND,@MinDate),   isnull(@WARRSTART,@MinDate),  isnull(@SLRWARR,''),  isnull(@SLRWEND,@MinDate),   isnull(@SLRWSTART,@MinDate),  0,   0.0,   0.0,   0.0,   @MinDate,   0,   0,   0,   0,   0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0,   0,   0,   0,   0,   isnull(@PM_Month,0),   isnull(@PM_Day,0),  isnull(@VendorID,''),  isnull(@ADDRESS3,''),  '',  '',  '',  '',  '',  @SERLNMBR,  @Qty,  @AssetTag,   CONVERT(varchar(10),GETDATE(),102) + ' 00:00:00',  @MinDate  ,  isnull(@SOPNumber,'')  if (@Reference is null or @Reference = '' or @ReferenceFrom = 0)  set @AuditDesc = 'Added via Instl/Cont/SOP/PO/TA' else  select @AuditDesc = case  when @ReferenceFrom = 1 then 'Via Install: ' + @Reference  when @ReferenceFrom = 2 then 'Via Cont: ' + @Reference  when @ReferenceFrom = 3 then 'Via SOP: ' + @Reference  when @ReferenceFrom = 4 then 'Via PO: ' + @Reference  when @ReferenceFrom = 5 then 'Via Xfer: ' + @Reference  when @ReferenceFrom = 6 then 'Via SVC: ' + @Reference  when @ReferenceFrom = 7 then 'Created From MO Receiving'   else 'Added via Instl/Cont/SOP/PO'  end  select @AuditDesc = SUBSTRING(@AuditDesc, 1, 30) exec SVC_Create_Serial_Audit   @EquipID,  '',  '',  '',  @AuditDesc,  @UserID END  else  Begin  if (select ADRSCODE from SVC00300 where EQUIPID = @EquipID) <> @AddressCode  Begin  select @CNTCPRSN = CNTCPRSN,  @ADDRESS1 = ADDRESS1,  @ADDRESS2 = ADDRESS2,  @ADDRESS3 = ADDRESS3,  @CITY = CITY,  @STATECD = STATE,  @COUNTRY = COUNTRY,  @ZIP = ZIP,  @SVCAREA = SVCAREA,  @OFFID = OFFID,  @TECHID = TECHID,  @PM_Month = SVC_PM_Date,  @PM_Day = SVC_PM_Day,  @TIMEZONE = TIMEZONE  from RM00102   left join SVC00950 on RM00102.CUSTNMBR = SVC00950.CUSTNMBR and RM00102.ADRSCODE = SVC00950.ADRSCODE  where RM00102.CUSTNMBR = @CustomerNumber and RM00102.ADRSCODE = @AddressCode  update SVC00300 with (rowlock)  set CNTCPRSN = @CNTCPRSN, ADDRESS1 = @ADDRESS1, ADDRESS2 = @ADDRESS2, ADDRESS3 = @ADDRESS3,  CITY = @CITY,STATE = @STATECD,COUNTRY = @COUNTRY,ZIP = @ZIP, ADRSCODE = @AddressCode,  SVCAREA = isnull(@SVCAREA,''),OFFID = isnull(@OFFID,''), TECHID = isnull(@TECHID, ''),   SVC_PM_Date =  isnull(@PM_Month,0),   SVC_PM_Day = isnull(@PM_Day,0), TIMEZONE = isnull(@TIMEZONE, TIMEZONE)  where EQUIPID = @EquipID   if @ReferenceFrom = 7   select @AuditDesc = 'Updated From MO Receiving'   exec SVC_Create_Serial_Audit   @EquipID,  '',  '',  '',  @AuditDesc,  @UserID     End  End return   
GO
GRANT EXECUTE ON  [dbo].[SVC_Create_Serial_MSTR] TO [DYNGRP]
GO
