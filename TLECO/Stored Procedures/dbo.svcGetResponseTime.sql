SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE Procedure [dbo].[svcGetResponseTime]  (@ContractNumber char(11),  @ContractLine numeric(19,5),  @InDate datetime,  @InTime datetime,  @TimeInMinute int,  @RespDate datetime OUTPUT,  @RespTime datetime OUTPUT) As declare @Day smallint, @Found tinyint, @ResponseTimeInMinute int,  @RemainingMinute int,  @Avail tinyint, @i smallint, @daysToLoop smallint,  @STARTTIME datetime, @ENDTIME datetime, @mindate datetime  exec smGetMinDate @mindate output select @RespDate = @InDate, @RespTime = @InTime,  @Found = 0, @daysToLoop = 0,   @ResponseTimeInMinute = @TimeInMinute, @RemainingMinute = @TimeInMinute  while @daysToLoop < 10 and @Found = 0 Begin  select @Day = DATEPART(dw,@RespDate) , @Avail = 0, @i = 1  while @Avail = 0 and @i < 8  begin  select @Avail = case @Day  WHEN 2 THEN USECVPD_1  WHEN 3 THEN USECVPD_2  WHEN 4 THEN USECVPD_3  WHEN 5 THEN USECVPD_4  WHEN 6 THEN USECVPD_5  WHEN 7 THEN USECVPD_6  WHEN 1 THEN USECVPD_7  END  from SVC00601 WHERE CONSTS = 2 and CONTNBR = @ContractNumber and LNSEQNBR = @ContractLine  if @Avail = 0   begin  select @RespDate = dateadd(dd, 1, @RespDate)  select @i = @i + 1, @Day = @Day + 1  if @Day = 8   select @Day = 1  end  end   if @Avail <> 0  BEGIN  select @STARTTIME = case @Day  WHEN 2 THEN CNTCOVPD_1  WHEN 3 THEN CNTCOVPD_2  WHEN 4 THEN CNTCOVPD_3  WHEN 5 THEN CNTCOVPD_4  WHEN 6 THEN CNTCOVPD_5  WHEN 7 THEN CNTCOVPD_6  WHEN 1 THEN CNTCOVPD_7  END,  @ENDTIME = case @Day  WHEN 2 THEN Contract_Coverage_Period_1  WHEN 3 THEN Contract_Coverage_Period_2  WHEN 4 THEN Contract_Coverage_Period_3  WHEN 5 THEN Contract_Coverage_Period_4  WHEN 6 THEN Contract_Coverage_Period_5  WHEN 7 THEN Contract_Coverage_Period_6  WHEN 1 THEN Contract_Coverage_Period_7  END  from SVC00601   WHERE CONSTS = 2 and CONTNBR = @ContractNumber and LNSEQNBR = @ContractLine END else  return(999)  if @RespTime < @ENDTIME  begin  if @RespTime < @STARTTIME  select @RespTime = @STARTTIME   if (select dateadd(mi, @ResponseTimeInMinute, @RespTime)) >= @ENDTIME  select @ResponseTimeInMinute = (@RemainingMinute - datediff(mi,@RespTime, @ENDTIME) ), @RespTime=@ENDTIME  else  select @RespTime = dateadd(mi, @ResponseTimeInMinute, @RespTime), @ResponseTimeInMinute = 0, @Found = 1  end  if @Found = 0 and exists(select * from SVC00683 WHERE CONSTS = 2 and CONTNBR = @ContractNumber and LNSEQNBR = @ContractLine)  begin  select @STARTTIME = case @Day  WHEN 2 THEN svcCoveragePeriodStart2_1  WHEN 3 THEN svcCoveragePeriodStart2_2  WHEN 4 THEN svcCoveragePeriodStart2_3  WHEN 5 THEN svcCoveragePeriodStart2_4  WHEN 6 THEN svcCoveragePeriodStart2_5  WHEN 7 THEN svcCoveragePeriodStart2_6  WHEN 1 THEN svcCoveragePeriodStart2_7  END,  @ENDTIME = case @Day  WHEN 2 THEN svcCoveragePeriodEnd2_1  WHEN 3 THEN svcCoveragePeriodEnd2_2  WHEN 4 THEN svcCoveragePeriodEnd2_3  WHEN 5 THEN svcCoveragePeriodEnd2_4  WHEN 6 THEN svcCoveragePeriodEnd2_5  WHEN 7 THEN svcCoveragePeriodEnd2_6  WHEN 1 THEN svcCoveragePeriodEnd2_7  END  from SVC00683 WHERE CONSTS = 2 and CONTNBR = @ContractNumber and LNSEQNBR = @ContractLine   if @RespTime < @ENDTIME  begin  if @RespTime < @STARTTIME  select @RespTime = @STARTTIME  select @RemainingMinute = @ResponseTimeInMinute  if (select dateadd(mi, @ResponseTimeInMinute, @RespTime)) >= @ENDTIME  select @ResponseTimeInMinute = (@RemainingMinute - datediff(mi,@RespTime, @ENDTIME) ), @RespTime=@ENDTIME  else  select @RespTime = dateadd(mi, @ResponseTimeInMinute, @RespTime), @ResponseTimeInMinute = 0, @Found = 1  end  end  if @Found = 0 and exists(select * from SVC00683 WHERE CONSTS = 2 and CONTNBR = @ContractNumber and LNSEQNBR = @ContractLine)  begin  select @STARTTIME = case @Day  WHEN 2 THEN svcCoveragePeriodStart3_1  WHEN 3 THEN svcCoveragePeriodStart3_2  WHEN 4 THEN svcCoveragePeriodStart3_3  WHEN 5 THEN svcCoveragePeriodStart3_4  WHEN 6 THEN svcCoveragePeriodStart3_5  WHEN 7 THEN svcCoveragePeriodStart3_6  WHEN 1 THEN svcCoveragePeriodStart3_7  END,  @ENDTIME = case @Day  WHEN 2 THEN svcCoveragePeriodEnd3_1  WHEN 3 THEN svcCoveragePeriodEnd3_2  WHEN 4 THEN svcCoveragePeriodEnd3_3  WHEN 5 THEN svcCoveragePeriodEnd3_4  WHEN 6 THEN svcCoveragePeriodEnd3_5  WHEN 7 THEN svcCoveragePeriodEnd3_6  WHEN 1 THEN svcCoveragePeriodEnd3_7  END  from SVC00683 WHERE CONSTS = 2 and CONTNBR = @ContractNumber and LNSEQNBR = @ContractLine   if @RespTime < @ENDTIME  begin  if @RespTime < @STARTTIME  select @RespTime = @STARTTIME  select @RemainingMinute = @ResponseTimeInMinute   if (select dateadd(mi, @ResponseTimeInMinute, @RespTime)) >= @ENDTIME  select @ResponseTimeInMinute = (@RemainingMinute - datediff(mi,@RespTime, @ENDTIME) ), @RespTime=@ENDTIME  else  select @RespTime = dateadd(mi, @ResponseTimeInMinute, @RespTime), @ResponseTimeInMinute = 0, @Found = 1  end   end  if @Found = 0 and exists(select * from SVC00683 WHERE CONSTS = 2 and CONTNBR = @ContractNumber and LNSEQNBR = @ContractLine)  begin  select @STARTTIME = case @Day  WHEN 2 THEN svcCoveragePeriodStart4_1  WHEN 3 THEN svcCoveragePeriodStart4_2  WHEN 4 THEN svcCoveragePeriodStart4_3  WHEN 5 THEN svcCoveragePeriodStart4_4  WHEN 6 THEN svcCoveragePeriodStart4_5  WHEN 7 THEN svcCoveragePeriodStart4_6  WHEN 1 THEN svcCoveragePeriodStart4_7  END,  @ENDTIME = case @Day  WHEN 2 THEN svcCoveragePeriodEnd4_1  WHEN 3 THEN svcCoveragePeriodEnd4_2  WHEN 4 THEN svcCoveragePeriodEnd4_3  WHEN 5 THEN svcCoveragePeriodEnd4_4  WHEN 6 THEN svcCoveragePeriodEnd4_5  WHEN 7 THEN svcCoveragePeriodEnd4_6  WHEN 1 THEN svcCoveragePeriodEnd4_7  END  from SVC00683 WHERE CONSTS = 2 and CONTNBR = @ContractNumber and LNSEQNBR = @ContractLine   if @RespTime < @ENDTIME  begin  if @RespTime < @STARTTIME  select @RespTime = @STARTTIME  select @RemainingMinute = @ResponseTimeInMinute   if (select dateadd(mi, @ResponseTimeInMinute, @RespTime)) > @ENDTIME  select @ResponseTimeInMinute = (@RemainingMinute - datediff(mi,@RespTime, @ENDTIME) ), @RespTime=@ENDTIME  else  select @RespTime = dateadd(mi, @ResponseTimeInMinute, @RespTime), @ResponseTimeInMinute = 0, @Found = 1  end   end  if @Found = 0  begin  select @daysToLoop = @daysToLoop + 1, @Day = @Day + 1, @RespDate = dateadd(dd, 1, @RespDate),  @RespTime = @mindate  if @Day = 8 select @Day = 1  end End  return (0)    
GO
GRANT EXECUTE ON  [dbo].[svcGetResponseTime] TO [DYNGRP]
GO
