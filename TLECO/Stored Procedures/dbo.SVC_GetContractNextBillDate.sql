SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE Procedure [dbo].[SVC_GetContractNextBillDate]   (  @CONSTS smallint,   @CONTNBR char(11),   @LNSEQNBR numeric(19,5),   @CHECKDATE datetime,   @BillDate datetime OUTPUT,   @svcReverseType integer ,   @IN_FilterReverseType bit  )  As  declare @MinDate datetime,@MaxDate datetime declare @NextBillDate datetime, @LineNextBillDate datetime, @HdrNextBillDate datetime declare @Total numeric(19,2) declare @BillingPeriods int, @BillOnDay smallint declare @ContLineBillStartDate datetime declare @ContLineBillEndDate datetime declare @Evergreen tinyint declare @AtEvery smallint, @FrequencyQty numeric(19,2), @BillType smallint declare @LineStatus char (1)  exec smGetMinDate @MinDate output   set @svcReverseType = isnull(@svcReverseType,0)  select @MaxDate = DATEADD(yy, 1000, @MinDate) select @Evergreen = SVC_Evergreen_Contract,  @BillType = BILCYC, @AtEvery = svcBillingFrequency, @FrequencyQty = svcFrequencyQty  from SVC00600 where CONSTS=@CONSTS and CONTNBR = @CONTNBR set nocount on  if @LNSEQNBR = 0   begin  if (@Evergreen = 1 and (select TOTAL from SVC00600 where CONSTS=@CONSTS and CONTNBR = @CONTNBR) > 0)  select @BillDate = @MaxDate  else  begin  select @LineNextBillDate = min(NXTBLDTE) from SVC00601 where CONSTS = @CONSTS and CONTNBR = @CONTNBR  select @BillDate = MIN(SVC00603.INVODATE)  from SVC00603 where  SVC00603.CONSTS = @CONSTS and  SVC00603.CONTNBR = @CONTNBR and  SVC00603.POSTED = 0 and   (@IN_FilterReverseType = 0 or SVC00603.svcReverseType = @svcReverseType)   if @BillDate is null or @BillDate > @LineNextBillDate   select @BillDate = @LineNextBillDate  end  end  else   begin  if (@Evergreen = 1 and (select TOTAL from SVC00601 where CONSTS=@CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR) > 0)  Begin   select @BillDate = @MaxDate   end   else   begin  if exists(select * from SVC00603 where SVC00603.CONSTS = @CONSTS and  SVC00603.CONTNBR = @CONTNBR and SVC00603.LNSEQNBR = @LNSEQNBR)  select @BillDate = MIN(SVC00603.INVODATE)  from SVC00603   where  SVC00603.CONSTS = @CONSTS and  SVC00603.CONTNBR = @CONTNBR and  SVC00603.LNSEQNBR = @LNSEQNBR and SVC00603.POSTED = 0 and   (@IN_FilterReverseType = 0 or SVC00603.svcReverseType = @svcReverseType)   else   begin   select @BillDate = @MinDate  select @NextBillDate = NXTBLDTE, @Total = TOTAL,@ContLineBillStartDate = BILSTRT,@BillOnDay = BILONDY,  @ContLineBillEndDate = BILEND, @LineStatus = Contract_Line_Status  from SVC00601 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR  select @HdrNextBillDate = MIN(SVC00603.INVODATE) from SVC00603  where SVC00603.CONSTS = @CONSTS and  SVC00603.CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR and SVC00603.POSTED = 0   and (@IN_FilterReverseType = 0 or SVC00603.svcReverseType = @svcReverseType)   if @Evergreen = 1   begin  select @NextBillDate = case @BillType  when 1 then dateadd(dd, @FrequencyQty, @NextBillDate)  when 2 then dateadd(ww, @FrequencyQty, @NextBillDate)  when 3 then dateadd(mm, @FrequencyQty, @NextBillDate)  when 4 then dateadd(yy, @FrequencyQty, @NextBillDate)  end  if @BillOnDay >= 30 and @BillType > 2  exec SVC_EOM @NextBillDate OUTPUT    if (@NextBillDate >= @ContLineBillEndDate) or (@LineStatus = 'P' and @NextBillDate < @ContLineBillEndDate)  begin  update SVC00601 with (RowLock) set Next_Liability_Date = @NextBillDate   where CONSTS=@CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR  select @NextBillDate = @MaxDate  end  select @BillDate = @NextBillDate  end  else  Begin  while @Total = 0 and @BillDate <= @CHECKDATE  begin   select @NextBillDate = case @BillType  when 1 then dateadd(dd, @FrequencyQty, @NextBillDate)  when 2 then dateadd(ww, @FrequencyQty, @NextBillDate)  when 3 then dateadd(mm, @FrequencyQty, @NextBillDate)  when 4 then dateadd(yy, @FrequencyQty, @NextBillDate)  end  if @NextBillDate > @ContLineBillEndDate select @NextBillDate = @MaxDate  if @NextBillDate < @HdrNextBillDate select @NextBillDate = @HdrNextBillDate  select @BillDate = @NextBillDate  end  End  end  end  end  select @BillDate = IsNull(@BillDate, @MaxDate)    
GO
GRANT EXECUTE ON  [dbo].[SVC_GetContractNextBillDate] TO [DYNGRP]
GO
