SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[taRMSchedPmnts] @I_vORIG_DOC_NUMBER  char (21),   @I_vORIG_DOC_TYPE  smallint,   @I_vREC_OFFSET_ACCT_IDX int = 0,   @I_vRecOffsetAccount  varchar(75) = '',  @I_vFIRST_INV_DOC_DATE  datetime = '',   @I_vFIRST_INV_DUE_DATE  datetime = '',   @I_vINT_INCOME_ACCT_IDX int = 0,   @I_vIntIncomeAccount  varchar(75) = '',  @I_vPAYMENT_AMOUNT  numeric (19,5) = 0,  @I_vNUM_PAYMENTS  smallint = 0,   @I_vSCHEDULE_NUMBER  char (21)= '',   @I_vPYMNT_FREQUENCY  smallint = 2,   @I_vREC_ACCT_IDX  int = 0,   @I_vRecAccount   varchar(75) = '',  @I_vSCH_DOC_DATE  datetime = '',   @I_vSCHEDULE_AMOUNT  numeric (19,5) = 0,  @I_vSCHEDULE_DESC  char (31) = '',   @I_vSCHEDULE_INT_RATE  numeric (19,5) = 0,  @I_vSCHEDULE_INT_TYPE1  smallint = 0,   @I_vRequesterTrx  smallint = 0,   @I_vUSRDEFND1   char(50) = '',   @I_vUSRDEFND2   char(50) = '',   @I_vUSRDEFND3   char(50) = '',   @I_vUSRDEFND4   char(8000) = '',  @I_vUSRDEFND5   char(8000) = '',  @O_iErrorState int output,   @oErrString varchar(255) output   with encryption as  set transaction isolation level read uncommitted set nocount on  declare  @ACCTTYPE tinyint,    @ACTIVE tinyint,    @AppendString char (5),    @AppendNumber int,    @BALNCTYP smallint,    @count int,     @CURNCYID char (15),    @DecPlaces smallint,    @CUSTNMBR char (15),    @DOCDATE datetime,    @DOCNUMBR char (22),    @DUEDATE datetime,    @FIRST_INV_DOC_DATE datetime,   @FIRST_INV_DUE_DATE datetime,   @FuncSchAmnt numeric (19,5),   @FUNLCURR char(15),      @INACTIVE int,     @INT_INCOME_ACCT_IDX int,   @IntDenominator smallint,   @INTEREST_AMOUNT numeric (19,5),  @InterestRate numeric (19,7),   @ISMCTRX int,       @NOTEINDX numeric (19,5),   @NUM_PAYMENTS smallint,    @ORIG_DOC_NUMBER char (21),   @ORIG_DOC_TYPE smallint,   @PAYMENT_AMOUNT numeric (19,5),   @PRINCIPAL_AMOUNT numeric (19,5),  @PRINCIPAL_BALANCE numeric (19,5),  @REC_ACCT_IDX int,    @REC_OFFSET_ACCT_IDX int,   @SCH_DOC_DATE datetime,    @SCHEDULE_AMOUNT numeric (19,5),  @SCHEDULE_DESC char (31),   @SCHEDULE_NUMBER char (21),   @iStatus int,     @iBlankCurrency int,   @iGetNextNoteIdxErrState int,   @sCompanyID smallint,    @iError int,      @DBName char(50),    @iCustomErrString varchar(255),   @O_iNumErrorState int,    @O_iInitErrorState int,    @oInitErrString varchar(255),   @O_oErrorState int,    @iCustomState int,  @I_tInc_Dec int  select  @ACCTTYPE = 0,     @ACTIVE = 0,     @AppendString = '',  @AppendNumber = 1001,    @BALNCTYP = 0,     @count = 1,  @CURNCYID = '',  @DecPlaces = 2,  @CUSTNMBR = '',  @DOCDATE = '',  @DOCNUMBR = '',  @DUEDATE = '',  @FIRST_INV_DOC_DATE = '',  @FIRST_INV_DUE_DATE = '',  @FuncSchAmnt = 0,  @FUNLCURR = '',     @INACTIVE = 0,     @INT_INCOME_ACCT_IDX = 0,  @IntDenominator = 1,  @INTEREST_AMOUNT = 0,  @InterestRate = 0,  @ISMCTRX =0,  @NOTEINDX = 0,  @NUM_PAYMENTS = 0,  @ORIG_DOC_NUMBER = '',  @ORIG_DOC_TYPE = 0,  @PAYMENT_AMOUNT = 0,  @PRINCIPAL_AMOUNT = 0,  @PRINCIPAL_BALANCE = 0,  @REC_ACCT_IDX = 0,  @REC_OFFSET_ACCT_IDX = 0,  @SCH_DOC_DATE = '',  @SCHEDULE_AMOUNT = 0,  @SCHEDULE_DESC = '',  @SCHEDULE_NUMBER = '',  @iStatus = 0,  @iGetNextNoteIdxErrState = 0,  @sCompanyID = 0,  @iError = 0,  @DBName = '',  @iBlankCurrency = 0,  @iCustomErrString = '',  @O_iNumErrorState = 0,  @O_iInitErrorState = 0,  @oInitErrString = '',  @O_oErrorState = 0,  @iCustomState = 0,  @I_tInc_Dec = 1,    @O_iErrorState = 0  if (@oErrString is NULL) begin  select @oErrString = '' end  select @DBName = DB_Name()  exec @iStatus = taRMSchedPmntsPre  @I_vORIG_DOC_NUMBER  output,  @I_vORIG_DOC_TYPE  output,  @I_vREC_OFFSET_ACCT_IDX output,  @I_vRecOffsetAccount  output,  @I_vFIRST_INV_DOC_DATE  output,  @I_vFIRST_INV_DUE_DATE  output,  @I_vINT_INCOME_ACCT_IDX output,  @I_vIntIncomeAccount  output,  @I_vPAYMENT_AMOUNT  output,  @I_vNUM_PAYMENTS  output,  @I_vSCHEDULE_NUMBER  output,  @I_vPYMNT_FREQUENCY  output,  @I_vREC_ACCT_IDX  output,  @I_vRecAccount   output,  @I_vSCH_DOC_DATE  output,  @I_vSCHEDULE_AMOUNT  output,  @I_vSCHEDULE_DESC  output,  @I_vSCHEDULE_INT_RATE  output,  @I_vSCHEDULE_INT_TYPE1  output,  @I_vRequesterTrx  output,  @I_vUSRDEFND1   output,  @I_vUSRDEFND2   output,  @I_vUSRDEFND3 output,  @I_vUSRDEFND4   output,  @I_vUSRDEFND5   output,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output  if (@iStatus <> 0) or (@iCustomState <> 0) or (@iError <> 0) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  select @O_iErrorState = 3006    exec @iStatus = taUpdateString  @O_iErrorState,   @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if ( @I_vSCHEDULE_NUMBER is NULL or  @I_vORIG_DOC_NUMBER is NULL or  @I_vORIG_DOC_TYPE  is NULL or  @I_vREC_OFFSET_ACCT_IDX is NULL or  @I_vRecOffsetAccount is NULL or  @I_vFIRST_INV_DOC_DATE is NULL or  @I_vFIRST_INV_DUE_DATE is NULL or  @I_vINT_INCOME_ACCT_IDX is NULL or  @I_vIntIncomeAccount is NULL or  @I_vPAYMENT_AMOUNT is NULL or  @I_vNUM_PAYMENTS is NULL or  @I_vPYMNT_FREQUENCY is NULL or  @I_vREC_ACCT_IDX is NULL or  @I_vRecAccount is NULL or  @I_vSCH_DOC_DATE is NULL or  @I_vSCHEDULE_AMOUNT is NULL or  @I_vSCHEDULE_DESC is NULL or  @I_vSCHEDULE_INT_RATE is NULL or  @I_vSCHEDULE_INT_TYPE1 is NULL) begin  select @O_iErrorState = 3007    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  select  @I_vSCHEDULE_NUMBER = UPPER(@I_vSCHEDULE_NUMBER),  @I_vORIG_DOC_NUMBER = UPPER(@I_vORIG_DOC_NUMBER)  select @sCompanyID = CMPANYID from DYNAMICS..SY01500 (nolock) where INTERID = db_name() exec @iStatus = DYNAMICS..tasmGetNextNoteIndex  @I_sCompanyID   = @sCompanyID,  @I_iSQLSessionID = 0,  @I_noteincrement  = 1,  @O_mNoteIndex   = @NOTEINDX output,  @O_iErrorState  = @iGetNextNoteIdxErrState output select @iError = @@error if ((@iStatus <> 0) or (@iGetNextNoteIdxErrState <> 0) or (@iError <> 0)) begin  select @oErrString = rtrim(@oErrString) + ' ' + @iGetNextNoteIdxErrState  select @O_iErrorState = 3008   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  select  @CUSTNMBR = CUSTNMBR,   @ORIG_DOC_NUMBER = DOCNUMBR,  @ORIG_DOC_TYPE = RMDTYPAL,  @SCH_DOC_DATE = DOCDATE,  @SCHEDULE_AMOUNT = CURTRXAM,  @CURNCYID = CURNCYID  from RM20101 (nolock)  where DOCNUMBR = @I_vORIG_DOC_NUMBER and RMDTYPAL = @I_vORIG_DOC_TYPE  select  @FuncSchAmnt = @SCHEDULE_AMOUNT,  @NUM_PAYMENTS = @I_vNUM_PAYMENTS,  @IntDenominator =  case @I_vPYMNT_FREQUENCY  when 1 then 24  when 2 then 12  when 3 then 4   when 4 then 2  when 5 then 1  else 1  end  if (@I_vFIRST_INV_DOC_DATE = '')  select @FIRST_INV_DOC_DATE = @SCH_DOC_DATE else  select @FIRST_INV_DOC_DATE = @I_vFIRST_INV_DOC_DATE  select @INACTIVE = INACTIVE, @BALNCTYP = BALNCTYP from RM00101 (nolock) where CUSTNMBR = @CUSTNMBR  select @FUNLCURR = FUNLCURR from MC40000 (nolock)  if (@CURNCYID = '') begin  select @CURNCYID = @FUNLCURR  select @iBlankCurrency = 1 end  if (@FUNLCURR <> '' and @CURNCYID <> @FUNLCURR) begin  select @SCHEDULE_AMOUNT = ORCTRXAM from MC020102 (nolock) where DOCNUMBR = @I_vORIG_DOC_NUMBER  and RMDTYPAL = @I_vORIG_DOC_TYPE  select @ISMCTRX = 1   end  select @DecPlaces = DECPLCUR - 1 from DYNAMICS..MC40200 (nolock) where CURNCYID = @CURNCYID  if (@INACTIVE = 1)  begin  select @O_iErrorState = 3009    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@BALNCTYP <> 0)  begin  select @O_iErrorState = 3010    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vSCHEDULE_INT_TYPE1 not in (0,1)) begin  select @O_iErrorState = 3011     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vSCHEDULE_INT_RATE < 0 or @I_vSCHEDULE_INT_RATE > 99.9999) begin  select @O_iErrorState = 3012     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (len(@I_vSCHEDULE_NUMBER) > 20)  begin  select @O_iErrorState = 3013     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vSCHEDULE_NUMBER = '')   begin  exec @iStatus = taGetNextRMSchNumber  @I_tInc_Dec = 1,   @O_vSCHEDULE_NUMBER = @I_vSCHEDULE_NUMBER output,  @O_iErrorState = @O_iNumErrorState output  select @iError = @@error  if ((@iStatus <> 0) or (@O_iNumErrorState <> 0) or (@iError <> 0))  begin  select @O_iErrorState = 3014   exec @iStatus = taUpdateString   @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end  if  (exists(select 1 from RM00401 (nolock) where DOCNUMBR = @I_vSCHEDULE_NUMBER)) or  (exists(select 1 from RM10101 (nolock) where DOCNUMBR = @I_vSCHEDULE_NUMBER)) or  (exists(select 1 from RM20101 (nolock) where DOCNUMBR = @I_vSCHEDULE_NUMBER)) or  (exists(select 1 from RM20400 (nolock) where SCHEDULE_NUMBER = @I_vSCHEDULE_NUMBER)) or  (exists(select 1 from RM20401 (nolock) where SCHEDULE_NUMBER = @I_vSCHEDULE_NUMBER)) or  (exists(select 1 from RM30101 (nolock) where DOCNUMBR = @I_vSCHEDULE_NUMBER)) begin  select @O_iErrorState = 3015    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vORIG_DOC_NUMBER = '') begin  select @O_iErrorState = 3016    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@ORIG_DOC_NUMBER = '')  begin  select @O_iErrorState = 3017    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@SCHEDULE_AMOUNT = 0)   begin  select @O_iErrorState = 3018    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@ORIG_DOC_TYPE not in (1,3,5))  begin  select @O_iErrorState = 3019    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vRecOffsetAccount <> '') begin  select @REC_OFFSET_ACCT_IDX = ACTINDX from GL00105 (nolock) where ACTNUMST = @I_vRecOffsetAccount  if (@REC_OFFSET_ACCT_IDX = 0)  begin  select @O_iErrorState = 3020     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end else if (@I_vREC_OFFSET_ACCT_IDX <> 0) begin  select @REC_OFFSET_ACCT_IDX = ACTINDX from GL00105 (nolock) where ACTINDX = @I_vREC_OFFSET_ACCT_IDX  if (@REC_OFFSET_ACCT_IDX = 0)  begin  select @O_iErrorState = 3021     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vRecOffsetAccount = '' and @I_vREC_OFFSET_ACCT_IDX = 0) begin  select @O_iErrorState = 3022     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@REC_OFFSET_ACCT_IDX > 0 and @ISMCTRX = 1)  begin  if (not exists(select 1 from MC00200 (nolock) where ACTINDX = @REC_OFFSET_ACCT_IDX  and CURNCYID = @CURNCYID))  begin  select @O_iErrorState = 3023     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@REC_OFFSET_ACCT_IDX > 0)  begin  select @ACTIVE = ACTIVE, @ACCTTYPE = ACCTTYPE from GL00100 (nolock) where ACTINDX = @REC_OFFSET_ACCT_IDX  if (@ACTIVE = 0)   begin  select @O_iErrorState = 3024     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  select @ACTIVE = 0    if (@ACCTTYPE not in (1,3))  begin  select @O_iErrorState = 3025     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  select @ACCTTYPE = 0  end  if (@I_vIntIncomeAccount <> '' and @I_vSCHEDULE_INT_RATE <> 0)  begin  select @INT_INCOME_ACCT_IDX = ACTINDX from GL00105 (nolock) where ACTNUMST = @I_vIntIncomeAccount  if (@INT_INCOME_ACCT_IDX = 0)  begin  select @O_iErrorState = 3026     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end else if (@I_vINT_INCOME_ACCT_IDX <> 0 and @I_vSCHEDULE_INT_RATE <> 0)  begin  select @INT_INCOME_ACCT_IDX = ACTINDX from GL00105 (nolock) where ACTINDX = @I_vINT_INCOME_ACCT_IDX  if (@INT_INCOME_ACCT_IDX = 0)  begin  select @O_iErrorState = 3027     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vIntIncomeAccount = '' and @I_vINT_INCOME_ACCT_IDX = 0 and @I_vSCHEDULE_INT_RATE <> 0) begin  select @O_iErrorState = 3028     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@INT_INCOME_ACCT_IDX > 0 and @ISMCTRX = 1)  begin  if (not exists(select 1 from MC00200 (nolock) where ACTINDX = @INT_INCOME_ACCT_IDX  and CURNCYID = @CURNCYID))  begin  select @O_iErrorState = 3029     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@INT_INCOME_ACCT_IDX > 0)  begin  select @ACTIVE = ACTIVE, @ACCTTYPE = ACCTTYPE from GL00100 (nolock) where ACTINDX = @INT_INCOME_ACCT_IDX  if (@ACTIVE = 0)   begin  select @O_iErrorState = 3030     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  select @ACTIVE = 0   if (@ACCTTYPE not in (1,3))   begin  select @O_iErrorState = 3031     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  select @ACCTTYPE = 0  end  if (@I_vPYMNT_FREQUENCY not in (1,2,3,4,5))  begin  select @O_iErrorState = 3032     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vFIRST_INV_DOC_DATE = '' and @I_vPYMNT_FREQUENCY = 1) begin  select @O_iErrorState = 3033     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end else if (@I_vFIRST_INV_DOC_DATE = '' and @I_vPYMNT_FREQUENCY <> 1) begin   if (@FIRST_INV_DOC_DATE = '')  begin  select @O_iErrorState = 3034     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vFIRST_INV_DOC_DATE <> '' and @I_vFIRST_INV_DOC_DATE < @SCH_DOC_DATE) begin  select @O_iErrorState = 3035     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vFIRST_INV_DOC_DATE <> '' and @I_vPYMNT_FREQUENCY = 1) begin    if (datepart(day, @I_vFIRST_INV_DOC_DATE) not in (1,15))  begin  select @O_iErrorState = 3036     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vFIRST_INV_DUE_DATE = '' and @I_vPYMNT_FREQUENCY <> 1) begin  select @FIRST_INV_DUE_DATE =  case @I_vPYMNT_FREQUENCY    when 2 then DATEADD(month, 1, @FIRST_INV_DOC_DATE)  when 3 then DATEADD(quarter, 1, @FIRST_INV_DOC_DATE)  when 4 then DATEADD(quarter, 2, @FIRST_INV_DOC_DATE)  when 5 then DATEADD(year, 1, @FIRST_INV_DOC_DATE)  else @FIRST_INV_DUE_DATE  end end else begin  select @FIRST_INV_DUE_DATE = @I_vFIRST_INV_DUE_DATE end  if (@I_vFIRST_INV_DUE_DATE <> '' and @I_vFIRST_INV_DUE_DATE < @FIRST_INV_DOC_DATE) begin  select @FIRST_INV_DUE_DATE = @I_vFIRST_INV_DUE_DATE  select @O_iErrorState = 3037     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vFIRST_INV_DUE_DATE <> '' and @I_vPYMNT_FREQUENCY = 1) begin    if (datepart(day, @I_vFIRST_INV_DUE_DATE) not in (1,15))  begin  select @O_iErrorState = 3038     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vNUM_PAYMENTS not between 0 and 999) begin  select @O_iErrorState = 3039     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vNUM_PAYMENTS = 0  and @I_vPAYMENT_AMOUNT = 0) begin  select @O_iErrorState = 3040     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vPAYMENT_AMOUNT < 0) begin  select @O_iErrorState = 3041     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vPAYMENT_AMOUNT > @SCHEDULE_AMOUNT) begin  select @O_iErrorState = 3405     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vSCH_DOC_DATE = '') begin   if (@SCH_DOC_DATE = '')  begin  select @O_iErrorState = 3042     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vSCHEDULE_AMOUNT = 0) begin   if (@SCHEDULE_AMOUNT = 0)  begin  select @O_iErrorState = 3043     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end else if (@I_vSCHEDULE_AMOUNT > @SCHEDULE_AMOUNT) begin  select @O_iErrorState = 3044     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vRecAccount <> '') begin  select @REC_ACCT_IDX = ACTINDX from GL00105 (nolock) where ACTNUMST = @I_vRecAccount  if (@REC_ACCT_IDX = 0)  begin  select @O_iErrorState = 3045     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end else if (@I_vREC_ACCT_IDX <> 0) begin  select @REC_ACCT_IDX = ACTINDX from GL00105 (nolock) where ACTINDX = @I_vREC_ACCT_IDX  if (@REC_ACCT_IDX = 0)  begin  select @O_iErrorState = 3046     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  end  if ((@I_vRecAccount <> '') or (@I_vREC_ACCT_IDX <> 0)) and (@REC_ACCT_IDX > 0 and @ISMCTRX = 1) begin   if (not exists(select 1 from MC00200 (nolock) where ACTINDX = @REC_ACCT_IDX  and CURNCYID = @CURNCYID))  begin  select @O_iErrorState = 3047     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if ((@I_vRecAccount <> '') or (@I_vREC_ACCT_IDX <> 0)) and (@REC_ACCT_IDX > 0) begin  select @ACTIVE = ACTIVE, @ACCTTYPE = ACCTTYPE from GL00100 (nolock) where ACTINDX = @REC_ACCT_IDX  if (@ACTIVE = 0)   begin  select @O_iErrorState = 3048     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  select @ACTIVE = 0    if (@ACCTTYPE not in (1,3))  begin  select @O_iErrorState = 3049     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  select @ACCTTYPE = 0  end  if (@I_vRecAccount = '' and @I_vREC_ACCT_IDX = 0) begin  select @REC_ACCT_IDX = DSTINDX from RM10101 (nolock)   where DOCNUMBR = @I_vORIG_DOC_NUMBER and RMDTYPAL=@I_vORIG_DOC_TYPE and DISTTYPE=3  if (@REC_ACCT_IDX = 0)  begin  select @O_iErrorState = 3050     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@O_iErrorState <> 0)  return (@O_iErrorState)  if @I_vSCHEDULE_AMOUNT <> 0   begin  select  @PRINCIPAL_BALANCE = @I_vSCHEDULE_AMOUNT,  @DOCDATE = @FIRST_INV_DOC_DATE,  @DUEDATE = @FIRST_INV_DUE_DATE  end else if @I_vSCHEDULE_AMOUNT = 0   begin  select  @PRINCIPAL_BALANCE = @SCHEDULE_AMOUNT,  @DOCDATE = @FIRST_INV_DOC_DATE,  @DUEDATE = @FIRST_INV_DUE_DATE  end  if @I_vSCHEDULE_INT_RATE <> 0  select @InterestRate = @I_vSCHEDULE_INT_RATE / 100.0 else  select @InterestRate=0  if (@I_vSCHEDULE_INT_TYPE1 = 0)  begin   if (@I_vPAYMENT_AMOUNT > 0)  begin   select  @PAYMENT_AMOUNT = @I_vPAYMENT_AMOUNT  if (@I_vSCHEDULE_INT_RATE <> 0)   begin  select @NUM_PAYMENTS = round((-1 * log(1 - (((@InterestRate / @IntDenominator) * @PRINCIPAL_BALANCE) / @PAYMENT_AMOUNT))) / log(1 + (@InterestRate / @IntDenominator)) + .5,0)    end  else  if (@I_vSCHEDULE_INT_RATE = 0)   begin  select @NUM_PAYMENTS = round((@SCHEDULE_AMOUNT / @PAYMENT_AMOUNT) + .5,0)   end  end  else  begin   if (@I_vSCHEDULE_INT_RATE <> 0 and @NUM_PAYMENTS > 0)   begin  select @PAYMENT_AMOUNT = round((@PRINCIPAL_BALANCE * (@InterestRate / @IntDenominator))/(1 - (power((1 + (@InterestRate / @IntDenominator)),(-1 * @NUM_PAYMENTS)))),@DecPlaces)   end  else  if (@I_vSCHEDULE_INT_RATE = 0 and @NUM_PAYMENTS > 0)   begin  select @PAYMENT_AMOUNT = round((@PRINCIPAL_BALANCE / @NUM_PAYMENTS),@DecPlaces)   end  end end else  if (@I_vSCHEDULE_INT_TYPE1 = 1) begin   if (@InterestRate <> 0)  select @INTEREST_AMOUNT = round(@InterestRate * @PRINCIPAL_BALANCE * @NUM_PAYMENTS / @IntDenominator / @NUM_PAYMENTS,@DecPlaces)  else select @INTEREST_AMOUNT = 0   if (@I_vPAYMENT_AMOUNT > 0)  begin  select  @PAYMENT_AMOUNT = @I_vPAYMENT_AMOUNT  if (@InterestRate <> 0)   begin  select @NUM_PAYMENTS = round(1 /((@PAYMENT_AMOUNT / @PRINCIPAL_BALANCE) - (@InterestRate / @IntDenominator)) + .5, 0)  end  else  if (@InterestRate = 0)   begin  select @NUM_PAYMENTS = round((@PRINCIPAL_BALANCE / @PAYMENT_AMOUNT)+.5,0)     end  end  else   begin   if (@InterestRate <> 0 and @NUM_PAYMENTS > 0)   begin  select @PAYMENT_AMOUNT = round(((@PRINCIPAL_BALANCE * @InterestRate * @NUM_PAYMENTS / @IntDenominator) + @PRINCIPAL_BALANCE) / @NUM_PAYMENTS,@DecPlaces)  end  else  if (@InterestRate = 0 and @NUM_PAYMENTS > 0)   begin  select @PAYMENT_AMOUNT = round((@PRINCIPAL_BALANCE / @NUM_PAYMENTS),@DecPlaces)   end  end end  insert RM00401   (  DOCNUMBR,  RMDTYPAL,  DCSTATUS,  BCHSOURC,  TRXSORCE,  CUSTNMBR,  CHEKNMBR,  DOCDATE,  NEGQTYSOPINV  ) select  @I_vSCHEDULE_NUMBER,  2,  0,  '',    '',    '',    '',    '',    0    if (@@error <> 0) begin  select @O_iErrorState = 3051      exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  insert RM20400  (  SCHEDULE_NUMBER,  SCHEDULE_DESC,  ORIG_DOC_NUMBER,  ORIG_DOC_TYPE,  CUSTNMBR,  SCH_DOC_DATE,  SCHEDULE_AMOUNT,  FuncSchAmnt,  CURNCYID,  SCHEDULE_INT_TYPE1,  SCHEDULE_INT_RATE,  NUM_PAYMENTS,  PYMNT_FREQUENCY,  PAYMENT_AMOUNT,  FIRST_INV_DOC_DATE,  FIRST_INV_DUE_DATE,  REC_ACCT_IDX,  REC_OFFSET_ACCT_IDX,  INT_INCOME_ACCT_IDX,  CREDIT_MEMO_DOC_NUM,  NOTEINDX,  Status  ) select  @I_vSCHEDULE_NUMBER,    @I_vSCHEDULE_DESC,    @ORIG_DOC_NUMBER,    @ORIG_DOC_TYPE,     @CUSTNMBR,     @SCH_DOC_DATE,     case  when @I_vSCHEDULE_AMOUNT <> 0 then @I_vSCHEDULE_AMOUNT  else @SCHEDULE_AMOUNT  end,    @FuncSchAmnt,      case                              when @ISMCTRX = 1 then @CURNCYID   when @iBlankCurrency = 1 then ''  when @CURNCYID = @FUNLCURR then @FUNLCURR  else ''  End,   @I_vSCHEDULE_INT_TYPE1,    @I_vSCHEDULE_INT_RATE * 10000,   @NUM_PAYMENTS,     @I_vPYMNT_FREQUENCY,    @PAYMENT_AMOUNT,    @FIRST_INV_DOC_DATE,    @FIRST_INV_DUE_DATE,    @REC_ACCT_IDX,     @REC_OFFSET_ACCT_IDX,    @INT_INCOME_ACCT_IDX,    '',      @NOTEINDX,     3     if (@@error <> 0) begin  select @O_iErrorState = 3052      exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  while (@count <= @NUM_PAYMENTS) begin  select  @AppendString = CAST(@AppendNumber AS char(4)),  @DOCNUMBR = rtrim(@I_vSCHEDULE_NUMBER) + substring(@AppendString, 2, 3)   if (@I_vSCHEDULE_INT_TYPE1 = 0 and @InterestRate <> 0)  begin  select @INTEREST_AMOUNT = round(@InterestRate / @IntDenominator * @PRINCIPAL_BALANCE, @DecPlaces)  end  else  if (@I_vSCHEDULE_INT_TYPE1 = 0 and @InterestRate = 0)  select @INTEREST_AMOUNT = 0   if (@count = @NUM_PAYMENTS)   select  @PRINCIPAL_AMOUNT = @PRINCIPAL_BALANCE,  @PAYMENT_AMOUNT = @INTEREST_AMOUNT + @PRINCIPAL_AMOUNT,  @PRINCIPAL_BALANCE = @PRINCIPAL_BALANCE - @PAYMENT_AMOUNT + @INTEREST_AMOUNT  else  select  @PRINCIPAL_AMOUNT = @PAYMENT_AMOUNT - @INTEREST_AMOUNT,  @PRINCIPAL_BALANCE = @PRINCIPAL_BALANCE - @PAYMENT_AMOUNT + @INTEREST_AMOUNT   insert RM20401  (  SCHEDULE_NUMBER,  DOCNUMBR,  Schedule_Payment_Number,  CUSTNMBR,  PAYMENT_AMOUNT,  INTEREST_AMOUNT,  PRINCIPAL_AMOUNT,  PRINCIPAL_BALANCE,  DUEDATE,  DOCDATE,  Status,  MARKED,  MKDBYUSR  )  select   @I_vSCHEDULE_NUMBER,  @DOCNUMBR,  @count,  @CUSTNMBR,  @PAYMENT_AMOUNT,  @INTEREST_AMOUNT,  @PRINCIPAL_AMOUNT,  @PRINCIPAL_BALANCE,  @DUEDATE,  @DOCDATE,  3,  0,  ''  if (@@error <> 0)  begin  select @O_iErrorState = 3053      exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end   select  @DOCDATE =  case @I_vPYMNT_FREQUENCY  when 2 then dateadd(month, 1 * @count, @FIRST_INV_DOC_DATE)  when 3 then dateadd(quarter, 1 * @count, @FIRST_INV_DOC_DATE)  when 4 then dateadd(quarter, 2 * @count, @FIRST_INV_DOC_DATE)  when 5 then dateadd(year, 1 * @count, @FIRST_INV_DOC_DATE)  else @DOCDATE  end   if @I_vPYMNT_FREQUENCY = 1 and (datepart(day, @DOCDATE) = 1)  select @DOCDATE = dateadd(day, 14, @DOCDATE)  else   if @I_vPYMNT_FREQUENCY = 1 and (datepart(day, @DOCDATE) = 15)  select @DOCDATE = dateadd(month, 1, @DOCDATE) - 14   select @DUEDATE =  case @I_vPYMNT_FREQUENCY  when 2 then dateadd(month, 1 * @count, @FIRST_INV_DUE_DATE)  when 3 then dateadd(quarter, 1 * @count, @FIRST_INV_DUE_DATE)  when 4 then dateadd(quarter, 2 * @count, @FIRST_INV_DUE_DATE)  when 5 then dateadd(year, 1 * @count, @FIRST_INV_DUE_DATE)  else @DUEDATE  end   if @I_vPYMNT_FREQUENCY = 1 and (datepart(day, @DUEDATE) = 1)  select @DUEDATE = dateadd(day, 14, @DUEDATE)  else   if @I_vPYMNT_FREQUENCY = 1 and (datepart(day, @DUEDATE) = 15)  select @DUEDATE = dateadd(month, 1, @DUEDATE) - 14   select @AppendNumber = @AppendNumber + 1, @count = @count + 1 end  exec @iStatus = taRMSchedPmntsPost  @I_vORIG_DOC_NUMBER,  @I_vORIG_DOC_TYPE,  @I_vREC_OFFSET_ACCT_IDX,  @I_vRecOffsetAccount,  @I_vFIRST_INV_DOC_DATE,  @I_vFIRST_INV_DUE_DATE,  @I_vINT_INCOME_ACCT_IDX,  @I_vIntIncomeAccount,  @I_vPAYMENT_AMOUNT,  @I_vNUM_PAYMENTS,  @I_vSCHEDULE_NUMBER,  @I_vPYMNT_FREQUENCY,  @I_vREC_ACCT_IDX,  @I_vRecAccount,  @I_vSCH_DOC_DATE,  @I_vSCHEDULE_AMOUNT,  @I_vSCHEDULE_DESC,  @I_vSCHEDULE_INT_RATE,  @I_vSCHEDULE_INT_TYPE1,  @I_vRequesterTrx,  @I_vUSRDEFND1,  @I_vUSRDEFND2,  @I_vUSRDEFND3,  @I_vUSRDEFND4,  @I_vUSRDEFND5,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if (@iStatus <> 0) or (@iCustomState <> 0) or (@iError <> 0) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  select @O_iErrorState = 3055     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  return (@O_iErrorState)   
GO
GRANT EXECUTE ON  [dbo].[taRMSchedPmnts] TO [DYNGRP]
GO
