SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
 create procedure [dbo].[dtaRemoveOccasionalAnalysis]  @I_cReferenceNumber char(25) = NULL,  @I_sSeries smallint        = NULL,  @I_iAccountIndex        int             = NULL,  @I_iSequenceNumber int  = NULL,  @O_iErrorState int  = NULL  output as  declare  @tTransaction tinyint,  @tLoop tinyint,  @iStatus int,  @iError int  select @O_iErrorState = 0  select @iStatus = 0  if @@trancount = 0 begin  select @tTransaction = 1  begin transaction end   while (@tLoop is NULL) begin  select @tLoop = 1   if @I_cReferenceNumber is NULL or  @I_sSeries is NULL or  @I_iAccountIndex is NULL or  @I_iSequenceNumber is NULL  begin  select @O_iErrorState = 20898  break   end    delete  DTA10200  from   DTA10100  where  DTA10100.DTAREF    = @I_cReferenceNumber  and DTA10100.DTASERIES = @I_sSeries  and DTA10100.ACTINDX   = @I_iAccountIndex  and DTA10100.SEQNUMBR  = @I_iSequenceNumber  and DTA10200.CODEAMT   = 0.00  and DTA10200.DTASERIES = DTA10100.DTASERIES  and DTA10200.DTAREF = DTA10100.DTAREF  and DTA10200.ACTINDX = DTA10100.ACTINDX  and DTA10200.SEQNUMBR = DTA10100.SEQNUMBR  and DTA10200.GROUPID = DTA10100.GROUPID   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if @iStatus <> 0  break   delete  DTA10100  where  DTA10100.DTAREF    = @I_cReferenceNumber  and DTA10100.DTASERIES = @I_sSeries  and DTA10100.ACTINDX   = @I_iAccountIndex  and DTA10100.SEQNUMBR  = @I_iSequenceNumber  and  NOT EXISTS(  select  1  from  DTA10200  where  DTA10200.DTASERIES = DTA10100.DTASERIES  and DTA10200.DTAREF = DTA10100.DTAREF  and DTA10200.ACTINDX = DTA10100.ACTINDX  and DTA10200.SEQNUMBR = DTA10100.SEQNUMBR  and DTA10200.GROUPID = DTA10100.GROUPID)   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if @iStatus <> 0  break  end   if @O_iErrorState <> 0 begin  if @tTransaction = 1  rollback transaction end else if @tTransaction = 1  commit transaction  return (@iStatus)   
GO
GRANT EXECUTE ON  [dbo].[dtaRemoveOccasionalAnalysis] TO [DYNGRP]
GO
