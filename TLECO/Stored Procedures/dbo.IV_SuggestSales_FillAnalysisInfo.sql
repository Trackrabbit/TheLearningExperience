SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[IV_SuggestSales_FillAnalysisInfo] @I_sTableSugAnalyse NVARCHAR(30) = NULL, @I_sTableSugItem NVARCHAR(30) = NULL, @I_sItemID CHAR(31) = NULL, @I_sFromDate VARCHAR(200) = NULL, @I_sToDate VARCHAR(200) = NULL, @I_sBeginDocType VARCHAR(1) = NULL, @I_sEndDocType VARCHAR(1) = NULL, @I_fFullfillment TINYINT = NULL  AS  BEGIN  DECLARE @DATE VARCHAR(1000)=''  DECLARE @DOCDATE VARCHAR(1000)=''  DECLARE @DOCUMENTTYP VARCHAR(1000)=''  DECLARE @HISTDOCUMENTTYP VARCHAR(1000)=''   IF @I_sFromDate <> ''   BEGIN  SET @DATE = ' AND DOCDATE BETWEEN ''' + @I_sFromDate + ''' AND ''' + @I_sToDate + '''' ;   END  IF @I_sBeginDocType <> 0   BEGIN  IF @I_fFullfillment = 1   BEGIN  SET @DOCUMENTTYP = ' AND ((SOPTYPE >= '+ @I_sBeginDocType + ' AND SOPTYPE <= ' + @I_sEndDocType + ') OR SOPTYPE = 6 )';  SET @HISTDOCUMENTTYP = ' AND ORIGTYPE < '+ @I_sEndDocType + ' OR SOPTYPE = 6 ';  END  ELSE  BEGIN  SET @DOCUMENTTYP = ' AND (SOPTYPE >= '+ @I_sBeginDocType + ' AND  SOPTYPE <= ' + @I_sEndDocType + ') ';  SET @HISTDOCUMENTTYP = ' AND ORIGTYPE < '+ @I_sEndDocType ;  END  END    EXEC('DELETE FROM '+ @I_sTableSugAnalyse + ';   WITH SOPDOCITEMS   AS(  SELECT SOPNUMBE,ITEMNMBR,QUANTITY FROM  (SELECT DISTINCT SOPTYPE, SOPNUMBE,ITEMNMBR,SUM(QUANTITY) QUANTITY FROM  SOP30300 WHERE CMPNTSEQ = 0 GROUP BY SOPTYPE,SOPNUMBE,ITEMNMBR HAVING SUM(QUANTITY) >0  UNION   SELECT DISTINCT SOPTYPE, SOPNUMBE,ITEMNMBR,SUM(QUANTITY) QUANTITY FROM  SOP10200 WHERE CMPNTSEQ = 0 GROUP BY SOPTYPE,SOPNUMBE,ITEMNMBR HAVING SUM(QUANTITY) >0) AS S  WHERE S.SOPNUMBE NOT IN   (  SELECT SOPNUMBE FROM SOP30200  WHERE VOIDSTTS = 1   UNION  SELECT SOPNUMBE FROM SOP10100  WHERE VOIDSTTS = 1   )  AND SOPTYPE not in (4,5)   ' + @DOCUMENTTYP + '   AND SOPNUMBE NOT IN   (  SELECT ORIGNUMB FROM SOP30200 WHERE VOIDSTTS = 0 ' + @HISTDOCUMENTTYP +  @DATE + '  UNION  SELECT ORIGNUMB FROM SOP10100 WHERE VOIDSTTS = 0 ' + @HISTDOCUMENTTYP +  @DATE + '  )  ),  SUGITEM   AS(   SELECT SDI.SOPNUMBE, SDI.ITEMNMBR , SDI.QUANTITY,   ROW_NUMBER() OVER (PARTITION BY SDI.ITEMNMBR ORDER BY SDI.ITEMNMBR, (SDI.QUANTITY * SD.QUANTITY)) ITEMQTY,  COUNT(*) OVER (PARTITION BY SDI.ITEMNMBR) +1 ITEMCOUNT  FROM SOPDOCITEMS SDI INNER JOIN SOPDOCITEMS SD ON SD.SOPNUMBE = SDI.SOPNUMBE AND SD.ITEMNMBR = '''+ @I_sItemID + '''  WHERE SDI.ITEMNMBR <> '''+ @I_sItemID + ''' AND SDI.SOPNUMBE IN   (  SELECT SOPDOCS.SOPNUMBE FROM SOPDOCITEMS INNER JOIN   (  SELECT SOPTYPE,SOPNUMBE, DOCDATE FROM SOP10100   UNION   SELECT SOPTYPE,SOPNUMBE, DOCDATE FROM SOP30200  ) SOPDOCS ON SOPDOCITEMS.SOPNUMBE = SOPDOCS.SOPNUMBE   AND ITEMNMBR = '''+ @I_sItemID + '''' + @DATE + '   )   )   INSERT INTO '+ @I_sTableSugAnalyse + '( SUGITEMNMBR, SUGITEMDEC, SUGQUANTITY, MATCHPER, SUGITEMORD, SALESSCRIPT,DecimalPlacesQTYSSugItem, ITEMTYPE,INACTIVE)  SELECT TOP 25 SUGITEM.ITEMNMBR, ITEMDESC, SUGITEM.QUANTITY,ROUND(((ITEMCOUNT-1)*100)/Cast((SELECT COUNT(DISTINCT SOPNUMBE) FROM SUGITEM) as float),2) MATCHPERCENT,1, '''', DECPLQTY, ITEMTYPE,INACTIVE  FROM SUGITEM INNER JOIN IV00101 ON SUGITEM.ITEMNMBR = IV00101.ITEMNMBR   WHERE SUGITEM.ITEMQTY in ((ITEMCOUNT/2))  GROUP BY SOPNUMBE,SUGITEM.ITEMNMBR,QUANTITY,SUGITEM.ITEMQTY,ITEMCOUNT,IV00101.ITEMDESC, DECPLQTY, ITEMTYPE,INACTIVE  order by MATCHPERCENT desc,SUGITEM.ITEMNMBR')   Exec('UPDATE '+ @I_sTableSugAnalyse + ' SET '+ @I_sTableSugAnalyse + '.SALESSCRIPT = SUGITEMMAIN.SALESSCRIPT,'+ @I_sTableSugAnalyse + '.SUGITEMORD = ORDNUM +1 FROM '+ @I_sTableSugAnalyse + ',   (select SUGITEMNMBR,ROW_NUMBER() OVER(PARTITION BY ITEMNMBR ORDER BY SEQNUMBR) ORDNUM,SALESSCRIPT from '+ @I_sTableSugItem+ ') SUGITEMMAIN  WHERE '+ @I_sTableSugAnalyse + '.SUGITEMNMBR = SUGITEMMAIN.SUGITEMNMBR')  END   
GO
GRANT EXECUTE ON  [dbo].[IV_SuggestSales_FillAnalysisInfo] TO [DYNGRP]
GO
