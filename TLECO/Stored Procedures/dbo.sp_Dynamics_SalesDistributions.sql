SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[sp_Dynamics_SalesDistributions] @iLanguageID int  as  set nocount on   declare @sqldropstring varchar(400),  @sqldefaultstring varchar(8000),  @sqlstring1 varchar(8000),  @sqlstring2 varchar(8000),  @sqlstring3 varchar(8000),  @sqlstring4 varchar(8000),  @sqlstring5 varchar(8000),  @sqlstring6 varchar(8000),  @sqlstring7 varchar(8000),  @sqlstring8 varchar(8000),  @sqlstring9 varchar(8000),  @sqlstring10 varchar(8000),  @sqlstring11 varchar(8000),  @sqlstring12 varchar(8000),  @sqlstring13 varchar(8000),  @sqlstring14 varchar(8000),  @sqlstring15 varchar(8000),  @sqlstring16 varchar(8000),  @sqlstring17 varchar(8000),  @sqlstring18 varchar(8000),  @sqlstring19 varchar(8000),  @sqlstring20 varchar(8000),  @sqlstring21 varchar(8000),  @sqlstring22 varchar(8000),  @sqljoinstring varchar(8000),  @sqlaccessstring varchar(2000),  @tNumberSegments int,  @tSegment int,  @I_iDictID int,  @I_iLangID int,  @I_iMessageNumber int,  @I_iAliasMessageNumber int,  @I_iIntegerValue int,  @SOP_Type varchar(255), @SOP_Number varchar(255), @Sequence_Number varchar(255), @Credit_Amount varchar(255), @Debit_Amount varchar(255), @Distribution_Type varchar(255), @TRX_Source varchar(255), @Account_Number varchar(255), @Account_Description varchar(255), @Posted_Date varchar(255), @Customer_Name varchar(255), @Customer_Number varchar(255), @Document_ID varchar(255), @DrillBack_Base_Url varchar(255), @Customer_Number_For_DrillBack varchar(255), @Account_Number_For_DrillBack varchar(255), @SOP_Number_For_DrillBack varchar(255)  select @DrillBack_Base_Url = DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)  select @I_iDictID = 1493 select @I_iMessageNumber = 22605 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgString  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Document_ID output   select @I_iDictID = 1493 select @I_iMessageNumber = 22600 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgString  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @SOP_Type output   select @I_iDictID = 1493 select @I_iMessageNumber = 22601 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgString  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @SOP_Number output   select @I_iDictID = 1493 select @I_iMessageNumber = 24603 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgString  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Sequence_Number output   select @I_iDictID = 1493 select @I_iMessageNumber = 24512 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgString  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Credit_Amount output   select @I_iDictID = 1493 select @I_iMessageNumber = 24513 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgString  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Debit_Amount output   select @I_iDictID = 0 select @I_iMessageNumber = 22010 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgString  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Distribution_Type output   select @I_iDictID = 1493 select @I_iMessageNumber = 22699 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgString  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @TRX_Source output   select @I_iDictID = 1493 select @I_iMessageNumber = 22501 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgString  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Account_Number output   select @I_iDictID = 1493 select @I_iMessageNumber = 22505 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgString  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Account_Description output   select @I_iDictID = 1493 select @I_iMessageNumber = 22706 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgString  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Posted_Date output   select @I_iDictID = 1493 select @I_iMessageNumber = 22638 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgString  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Customer_Name output   select @I_iDictID = 1493 select @I_iMessageNumber = 24700 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgString  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Customer_Number output   select @I_iDictID = 1493 select @I_iMessageNumber = 24700 select @I_iAliasMessageNumber = 22214 exec DYNAMICS..smGetBIMsgString  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Customer_Number_For_DrillBack output   select @I_iDictID = 1493 select @I_iMessageNumber = 22501 select @I_iAliasMessageNumber = 22214 exec DYNAMICS..smGetBIMsgString  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Account_Number_For_DrillBack output   select @I_iDictID = 1493 select @I_iMessageNumber = 22601 select @I_iAliasMessageNumber = 22214 exec DYNAMICS..smGetBIMsgString  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @SOP_Number_For_DrillBack output   select @sqldropstring =   'if exists (select * from dbo.sysobjects where id = object_id(N''[dbo].[SalesDistributions]'') and OBJECTPROPERTY(id, N''IsView'') = 1) ' +  'drop view [dbo].[SalesDistributions] '  select @sqldefaultstring =   'CREATE VIEW SalesDistributions AS ' +   'select ' +   '''' + @SOP_Type + ''' = dbo.DYN_FUNC_SOP_Type([''Sales Distribution Work and History''].[SOPTYPE]), ' + 'rtrim([''Sales Distribution Work and History''].[SOPNUMBE]) as ''' + @SOP_Number + ''', ' +  '[''Sales Distribution Work and History''].[SEQNUMBR] as ''' + @Sequence_Number + ''', ' +  '[''Sales Distribution Work and History''].[CRDTAMNT] as ''' + @Credit_Amount + ''', ' +  '[''Sales Distribution Work and History''].[DEBITAMT] as ''' + @Debit_Amount + ''', ' +  'rtrim([''Sales Distribution Work and History''].[TRXSORCE]) as ''' + @TRX_Source + ''', ' +  '''' + @Distribution_Type + ''' = dbo.DYN_FUNC_SOP_Distribution_Type([''Sales Distribution Work and History''].[DISTTYPE]), ' + '(select rtrim([ACTNUMST]) from [GL00105] as [''Account Index Master''] where [''Account Index Master''].[ACTINDX] = [''Sales Distribution Work and History''].[ACTINDX]) as ''' + @Account_Number + ''', ' + 'rtrim([''Account Master''].[ACTDESCR]) as ''' + @Account_Description + ''', ' + '[''Sales Transaction History''].[GLPOSTDT] as ''' + @Posted_Date + ''', ' +  'case ISNULL([''Sales Transaction Work''].[CUSTNAME],''empty'') WHEN ''empty'' ' +  ' THEN rtrim([''Sales Transaction History''].[CUSTNAME]) ' + ' ELSE rtrim([''Sales Transaction Work''].[CUSTNAME]) ' + 'END as ''' + @Customer_Name + ''', ' +  'case ISNULL([''Sales Transaction Work''].[CUSTNMBR],''empty'') WHEN ''empty'' ' +  ' THEN rtrim([''Sales Transaction History''].[CUSTNMBR]) ' + ' ELSE rtrim([''Sales Transaction Work''].[CUSTNMBR]) ' + 'END as ''' + @Customer_Number + ''', ' +  'case ISNULL([''Sales Transaction Work''].[CUSTNMBR],''empty'') WHEN ''empty'' ' +  ' THEN rtrim([''Sales Transaction History''].[DOCID]) ' + ' ELSE rtrim([''Sales Transaction Work''].[DOCID]) ' + 'END as ''' + @Document_ID + ''', '  select @sqlstring1 =  '''' + @Account_Number_For_DrillBack + ''' = ''' + @DrillBack_Base_Url + ''' +dbo.dgppAccountIndex(1,[''Sales Distribution Work and History''].[ACTINDX] ), '+  'case ISNULL([''Sales Transaction Work''].[CUSTNMBR],''empty'') WHEN ''empty'' ' +  ' THEN '''+ @DrillBack_Base_Url + ''' +dbo.dgppCustomerID(1,[''Sales Transaction History''].[CUSTNMBR] ) ' + ' ELSE '''+ @DrillBack_Base_Url + ''' +dbo.dgppCustomerID(1,[''Sales Transaction Work''].[CUSTNMBR] ) ' + 'END as ''' + @Customer_Number_For_DrillBack + ''', '+  'case ISNULL( [''Sales Distribution Work and History''].[TRXSORCE],'''') WHEN '''' ' +  ' THEN '''+ @DrillBack_Base_Url + ''' +dbo.dgppSalesOrder(1,1,11,'''',0,0,[''Sales Transaction Work''].[CUSTNMBR],'''',0,'''',[''Sales Transaction Work''].[SOPTYPE],[''Sales Transaction Work''].[SOPNUMBE] ) ' + ' ELSE '''+ @DrillBack_Base_Url + ''' +dbo.dgppSalesOrder(1,3,11,'''',0,0,[''Sales Transaction History''].[CUSTNMBR],'''',0,'''',[''Sales Transaction History''].[SOPTYPE],[''Sales Transaction History''].[SOPNUMBE] ) ' + 'END as ''' + @SOP_Number_For_DrillBack + ''' '  select @sqlstring2 =   'from [SOP10102] as [''Sales Distribution Work and History''] with (NOLOCK) '   + 'left outer join [GL00100] as [''Account Master''] with (NOLOCK) on '   + '[''Sales Distribution Work and History''].[ACTINDX] = [''Account Master''].[ACTINDX] '   + 'left outer join [SOP30200] as [''Sales Transaction History''] with (NOLOCK) on '   + '[''Sales Distribution Work and History''].[SOPTYPE] = [''Sales Transaction History''].[SOPTYPE] '   + ' and [''Sales Distribution Work and History''].[SOPNUMBE] = [''Sales Transaction History''].[SOPNUMBE] '   + 'left outer join [SOP10100] as [''Sales Transaction Work''] with (NOLOCK) on '   + '[''Sales Distribution Work and History''].[SOPNUMBE] = [''Sales Transaction Work''].[SOPNUMBE] '   + ' and [''Sales Distribution Work and History''].[SOPTYPE] = [''Sales Transaction Work''].[SOPTYPE] '   select @sqlaccessstring =   'GRANT SELECT ON [dbo].[SalesDistributions] TO [rpt_order processor]' + 'GRANT SELECT ON [dbo].[SalesDistributions] TO [rpt_accounting manager]' + 'GRANT SELECT ON [dbo].[SalesDistributions] TO [rpt_bookkeeper]' + 'GRANT SELECT ON [dbo].[SalesDistributions] TO [rpt_executive]' + 'GRANT SELECT ON [dbo].[SalesDistributions] TO [rpt_certified accountant]'   exec (@sqldropstring)  exec (@sqldefaultstring+' '+@sqlstring1+' '+@sqlstring2+' '+@sqlstring3+' '+@sqlstring4+' '+@sqlstring5+' '+@sqlstring6+' '+@sqlstring7+' '+@sqlstring8+' '+@sqlstring9+' '+@sqlstring10+' '+@sqlstring11+' '+@sqlstring12+' '+@sqlstring13+' '+@sqlstring14+' '+@sqlstring15+' '+@sqlstring16+' '+@sqlstring17+' '+@sqlstring18+' '+@sqlstring19+' '+@sqlstring20+' '+@sqljoinstring)  exec (@sqlaccessstring)   set nocount off    
GO
GRANT EXECUTE ON  [dbo].[sp_Dynamics_SalesDistributions] TO [DYNGRP]
GO
