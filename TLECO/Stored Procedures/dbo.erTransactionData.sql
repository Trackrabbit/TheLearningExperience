SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
 create procedure [dbo].[erTransactionData]  @start_date datetime=NULL,  @end_date datetime=NULL,  @include_unposted smallint=NULL,  @include_intercompany bit=NULL,  @list_of_segments varchar(255)=NULL as  declare   @vFinalSelectAcct varchar(255),  @vFinalSelectAcct1 varchar(255),  @vFinalSelectAcct2 varchar(255),  @vSelectAcct varchar(255),  @vCreateColList varchar(255),  @cColSize char(3),  @vGroupByClause varchar(255),  @vAcctSegName varchar(20),  @vAcctColName varchar(20),  @tNumberSegments tinyint,  @tLoopControl tinyint,  @cIndex char(2),  @vInternalSegList varchar(255),  @vSortOrder varchar(255),  @bFirstSelectTerm bit,  @cSummaryTypePosted char(3),  @cSummaryTypeUnposted char(3),  @cStartDate char(14),  @cEndDate char(14),  @cBudgetIDTemp char(17),  @cPeriodIDTemp char(5),  @cIncludeUnposted char(1),  @iRetval integer,  @bPeriodSpansBeginning tinyint,  @iHistoryYear integer,  @dFirstDay datetime,  @cFiscalYear char(4),  @cFirstDayMinusOne char(14)  set nocount on set dateformat ymd if @start_date is null or  @end_date is null or  @include_unposted is null or  @include_intercompany is null begin  return -4 end  if @include_unposted < 0 or @include_unposted > 2 begin  return -3 end  select @tLoopControl    = 1 select @bFirstSelectTerm  = 1 select @bPeriodSpansBeginning = 0 select @vSortOrder    = '' select @vFinalSelectAcct  = '' select @vFinalSelectAcct1  = '' select @vFinalSelectAcct2  = '' select @vSelectAcct    = '' select @vCreateColList   = '' select @cColSize    = '' select @vGroupByClause   = '' select @vSortOrder    = ''  exec @iRetval = erInternalParseSegmentList   @list_of_segments,   @vInternalSegList out,   @vSortOrder out,  @tNumberSegments out if @iRetval <> 0 begin  return @iRetval end  select @bPeriodSpansBeginning = count(HISTORYR) from SY40101   where FSTFSCDY >= @start_date and FSTFSCDY <= @end_date  while @tLoopControl <= @tNumberSegments begin  select @cIndex = ltrim(str(@tLoopControl))  if substring(@vInternalSegList,@tLoopControl,1) = '1'  begin   select @vAcctSegName = 'account_number_' + @cIndex  select @vAcctColName = 'ACTNUMBR_' + @cIndex   select @cColSize  = convert(char(3),LOFSGMNT) from SY00300   where SGMTNUMB = convert(tinyint,@cIndex)   select @vCreateColList = @vCreateColList +   'ACTNUMBR_' + @cIndex +   ' char(' + rtrim(@cColSize) + '),'   if @bFirstSelectTerm = 1  begin  select @vFinalSelectAcct  = @vAcctSegName + ' = ' + @vAcctColName  select @vSelectAcct = @vAcctColName  select @vGroupByClause = @vAcctColName  select @bFirstSelectTerm = 0  end  else  begin  select @vFinalSelectAcct  = @vFinalSelectAcct + ',' +  @vAcctSegName + ' = ' +   @vAcctColName  select @vSelectAcct = @vSelectAcct + ',' + @vAcctColName  select @vGroupByClause = @vGroupByClause + ',' + @vAcctColName  end    end  if @tLoopControl = 5  begin  select @vFinalSelectAcct1 = @vFinalSelectAcct  select @vFinalSelectAcct = ''  end  if @tLoopControl = 10  begin  select @vFinalSelectAcct2 = @vFinalSelectAcct  select @vFinalSelectAcct = ''  end   select @tLoopControl = @tLoopControl + 1 end  if @include_unposted = 2 begin  select @cSummaryTypePosted = '''C'''  select @cSummaryTypeUnposted = '''C''' end else begin  select @cSummaryTypePosted = '''P'''  select @cSummaryTypeUnposted = '''U''' end select @cStartDate = ''''+convert(char(12),@start_date,102)+'''' select @cEndDate = ''''+convert(char(12),@end_date,102)+'''' select @cIncludeUnposted = convert(char(1),@include_unposted)  exec (  'create table ##TEMPACC (' +  @vCreateColList +  'corresponding_unit char(5), ' +  'summary_type char(1), ' +  'amount numeric(19,5) )'   )  exec (   'insert into ##TEMPACC select ' + @vSelectAcct +  ',CorrespondingUnit, ' + @cSummaryTypePosted +  ',sum(DEBITAMT)-sum(CRDTAMNT) ' +  ' from GL00105 a join GL20000 b WITH(INDEX(AK3GL20000)) on a.ACTINDX = b.ACTINDX ' +  '  join SY40101 c on c.YEAR1 = b.OPENYEAR ' +  ' where TRXDATE >= FSTFSCDY and TRXDATE >= ' + @cStartDate  +  ' and TRXDATE <= ' + @cEndDate +  ' group by ' + @vGroupByClause +  ', CorrespondingUnit'  )  exec (   'insert into ##TEMPACC select '+ @vSelectAcct +  ',CorrespondingUnit, ' + @cSummaryTypeUnposted +  ', sum(DEBITAMT)-sum(CRDTAMNT) ' +  ' from GL00105 a join GL10001 b WITH(INDEX(PKGL10001)) on a.ACTINDX = b.ACTINDX ' +  ' join GL10000 c WITH(INDEX(AK2GL10000)) on b.JRNENTRY = c.JRNENTRY ' +  ' where TRXDATE >= ' + @cStartDate +  ' and TRXDATE <= ' + @cEndDate +  ' and ' + @cIncludeUnposted + '> 0' +  ' group by ' + @vGroupByClause +  ', CorrespondingUnit'  )  exec (  'insert into ##TEMPACC select '+ @vSelectAcct +  ',CorrespondingUnit, ' + @cSummaryTypePosted +  ', sum(DEBITAMT)-sum(CRDTAMNT) ' +  ' from GL00105 a join GL30000 b WITH(INDEX(AK2GL30000)) on a.ACTINDX = b.ACTINDX ' +  '  join SY40101 c on c.YEAR1 = b.HSTYEAR ' +  ' where TRXDATE >= FSTFSCDY and TRXDATE >= ' + @cStartDate  +  ' and TRXDATE <= ' + @cEndDate +  ' group by ' + @vGroupByClause +  ', CorrespondingUnit'  )  if @bPeriodSpansBeginning <> 0 begin  select @iHistoryYear = HISTORYR,   @dFirstDay  = FSTFSCDY,  @cFiscalYear = convert(char(4),YEAR1)  from SY40101 where FSTFSCDY >= @start_date and FSTFSCDY <= @end_date   select @cFirstDayMinusOne = ''''+convert(char(12),dateadd(day,-1,@start_date),102)+''''   if @iHistoryYear = 0  begin  exec (  'insert into ##TEMPACC select ' + @vSelectAcct +  ',CorrespondingUnit, ''B'' '  +  ', sum(DEBITAMT)-sum(CRDTAMNT) ' +  ' from GL00105 a join GL20000 b WITH(INDEX(AK3GL20000)) on a.ACTINDX = b.ACTINDX ' +  ' where TRXDATE = ' + @cFirstDayMinusOne +  ' and OPENYEAR = ' + @cFiscalYear +  ' group by ' + @vGroupByClause +  ', CorrespondingUnit'  )  end  else  begin  exec (  'insert into ##TEMPACC select '+ @vSelectAcct +  ',CorrespondingUnit, ''B'' ' +  ', sum(DEBITAMT)-sum(CRDTAMNT) ' +  ' from GL00105 a join GL30000 b WITH(INDEX(AK2GL30000)) on a.ACTINDX = b.ACTINDX ' +  ' where TRXDATE = ' + @cFirstDayMinusOne +  ' and HSTYEAR = ' + @cFiscalYear +  ' group by ' + @vGroupByClause +  ', CorrespondingUnit'  )  end end  exec (  'select ' +  @vFinalSelectAcct1 + @vFinalSelectAcct2 + @vFinalSelectAcct +  ',corresponding_unit ,summary_type, amount=sum(amount) ' +  ' from ##TEMPACC ' +  ' group by ' + @vGroupByClause + ' , corresponding_unit, summary_type ' +  ' ' +  ' drop table ##TEMPACC ' )  return 0    
GO
GRANT EXECUTE ON  [dbo].[erTransactionData] TO [DYNGRP]
GO
