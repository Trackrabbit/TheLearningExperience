SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[glpVerifyTransaction]  @I_sTransactionType smallint = NULL,  @I_tPosting tinyint  = NULL,  @I_iJournalEntry int   = NULL,  @I_cBatchNumber char(15) = NULL,  @I_sBatchFrequency smallint = NULL,  @I_bBatchValid binary(4) = NULL,  @I_sCompanyID smallint = NULL,  @I_cFuncCurrencyID char(15) = NULL,  @I_sFuncCurrencyIndex smallint = NULL,  @I_sFuncDecimalPlaces smallint = NULL,  @I_tMCRegistered tinyint  = NULL,  @I_cUserID     char(15)  = NULL,  @I_tUseTaxPeriods       tinyint     = NULL,  @I_AllowReportingLedgers tinyint = NULL,  @IO_tPrintDistributions tinyint  = NULL output,  @O_sMCTransaction smallint = NULL  output,  @O_sDecimalPlaces smallint = NULL  output,  @O_bHeaderMessages binary(4) = NULL output,  @O_bHeaderMessages2 binary(4) = NULL output,  @O_iErrorState int   = NULL output as  declare  @TRUE tinyint,  @FALSE tinyint,  @POSTED smallint,  @UNPOSTED smallint,  @RECURRING_POSTED smallint,  @POSTED_WITH_ERROR smallint,  @NORMAL_TRX smallint,  @CLEARING_TRX smallint,  @BUDGET_TRX smallint,   @BUSINESS_FORM smallint,  @DEFAULT_DATE datetime,  @FINANCIAL smallint,  @RECURRING_TRX smallint,  @NEW smallint,  @SINGLE_USE smallint,  @REVERSING smallint,  @GL_TRANSACTION smallint,  @MC_TRANSACTION smallint,  @MS_ITEM_1 int,  @MS_ITEM_2 int,  @MS_ITEM_3 int,  @MS_ITEM_4 int,  @MS_ITEM_5    int,  @MS_ITEM_7 int,  @MS_ITEM_11 int,  @MS_ITEM_15 int,  @MS_ITEM_17 int,  @MS_ITEM_20 int,  @tRecurring tinyint,  @sJournalStatus smallint,  @iError int,  @iStatus int,  @iTransactionError int,  @tEditList tinyint,  @tTransaction tinyint,  @tLoop tinyint,  @sPostingStatus smallint,  @tUnknownError tinyint,  @bHeaderMessages binary(4),  @bLineMessages binary(4),  @sHdrTransactionType smallint,  @cHdrSourceDocument char(10),  @nHdrRecurringTRXSequence numeric(19,5),  @dHdrTaxDate datetime,  @dHdrTransactionDate datetime,  @sHdrTransactionPeriodID smallint,  @sHdrTransactionYear smallint,  @sHdrTransactionClosingYear smallint,  @tHdrTransactionHistory tinyint,  @dHdrReversingDate datetime,  @sHdrReversingPeriodID smallint,  @sHdrReversingYear smallint,  @sHdrReversingClosingYear smallint,  @tHdrReversingHistory tinyint,  @cHdrOrigCurrencyID char(15),  @sHdrOrigCurrencyIndex smallint,  @cHdrRateTypeID char(15),  @cHdrExchangeTableID char(15),  @mHdrExchangeRate numeric(15,7),  @dHdrExchangeDate datetime,  @dHdrExchangeTime datetime,  @sHdrBalanceForCalculation smallint,  @iHdrOffsetAccountIndex int,  @sHdrOffsetAccountType smallint,  @sHdrOffsetFixedOrVariable smallint,  @sHdrOffsetPostingType smallint,  @bHdrHeaderValid binary(4),  @tUpdateHeaderInfo tinyint,  @sMCTrxState smallint,  @dMinDate datetime,  @LedgerName char(15),  @LedgerID int  select  @O_sMCTransaction = 0,  @O_sDecimalPlaces = 0,  @O_bHeaderMessages = 0x00000000,  @O_bHeaderMessages2 = 0x00000000,  @O_iErrorState  = 0,  @iStatus  = 0  exec @iStatus = smGetMinDate @dMinDate output  if @@trancount = 0 begin  select @tTransaction = 1  begin transaction end   while (@tLoop is NULL) begin  select @tLoop = 1   if @I_sTransactionType is NULL or  @I_tPosting is NULL or  @I_iJournalEntry is NULL or  @I_cBatchNumber is NULL or  @I_sBatchFrequency is NULL or  @I_bBatchValid is NULL or  @I_sCompanyID is NULL or  @I_cFuncCurrencyID is NULL or  @I_sFuncCurrencyIndex is NULL or  @I_sFuncDecimalPlaces is NULL or  @I_tMCRegistered is NULL or  @IO_tPrintDistributions is NULL or  @O_bHeaderMessages is NULL or  @I_AllowReportingLedgers is NULL  begin  select @O_iErrorState = 20895  break  end    select  @TRUE   = 1,  @FALSE   = 0,  @POSTED   = 2,  @UNPOSTED  = 1,  @RECURRING_POSTED = 4,  @POSTED_WITH_ERROR = 3,  @NORMAL_TRX   = 1,  @CLEARING_TRX  = 2,  @BUDGET_TRX   = 4,    @BUSINESS_FORM  = 5,  @DEFAULT_DATE  = @dMinDate,  @FINANCIAL   = 2,  @RECURRING_TRX  = 3,  @NEW    = 0,  @SINGLE_USE   = 1,  @REVERSING   = 1,  @GL_TRANSACTION  = 0,  @MC_TRANSACTION  = 1,  @MS_ITEM_1  = power(2,24),  @MS_ITEM_2  = power(2,25),  @MS_ITEM_3  = power(2,26),  @MS_ITEM_4  = power(2,27),  @MS_ITEM_5   = power(2,28),  @MS_ITEM_7  = power(2,30),  @MS_ITEM_11  = power(2,18),  @MS_ITEM_15  = power(2,22),  @MS_ITEM_17  = power(2,8),  @MS_ITEM_20  = power(2,11)   select @tUpdateHeaderInfo = @FALSE   select   @cHdrSourceDocument   = SourceDocument,  @dHdrTransactionDate  = TransactionDate,  @sHdrTransactionPeriodID = TransactionPeriodID,  @sHdrTransactionYear  = TransactionYear,  @sHdrTransactionClosingYear = TransactionClosingYear,  @tHdrTransactionHistory  = TransactionHistory,  @dHdrTaxDate    = TaxDate,  @dHdrReversingDate   = ReversingDate,  @sHdrReversingPeriodID  = ReversingPeriodID,  @sHdrReversingYear   = ReversingYear,  @sHdrReversingClosingYear = ReversingClosingYear,  @tHdrReversingHistory  = ReversingHistory,  @sHdrTransactionType  = TransactionType,  @nHdrRecurringTRXSequence = RecurringTRXSequence,  @cHdrOrigCurrencyID   = CurrencyID,  @mHdrExchangeRate    = ExchangeRate,  @cHdrExchangeTableID   = ExchangeTableID,  @cHdrRateTypeID    = RateTypeID,  @dHdrExchangeDate    = ExchangeDate,  @dHdrExchangeTime    = ExchangeTime,  @bHdrHeaderValid   = HeaderValid,  @iHdrOffsetAccountIndex  = OffsetAccountIndex,  @sHdrOffsetAccountType  = OffsetAccountType,  @sHdrOffsetFixedOrVariable = OffsetFixedOrVariable,  @sHdrOffsetPostingType  = OffsetPostingType,  @sHdrBalanceForCalculation  = BalanceForCalculation,  @O_bHeaderMessages   = HeaderMessages,  @sMCTrxState    = MCTrxState,  @LedgerID     = Ledger_ID  from  #TRXHeader  where  JournalEntry = @I_iJournalEntry   if @@rowcount <> 1  begin  select @O_iErrorState = 20896  break  end   exec @iStatus = glpVerifySourceDocument  @cHdrSourceDocument,   @I_tPosting,  @O_bHeaderMessages output,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break   if @I_tMCRegistered = @TRUE and   (@I_cFuncCurrencyID <> @cHdrOrigCurrencyID)  begin  select @O_sMCTransaction = @MC_TRANSACTION   if @I_sTransactionType = @NORMAL_TRX  begin  exec @iStatus = glpmcVerifyCurrency  @I_sCompanyID,  @cHdrOrigCurrencyID,  @dHdrExchangeDate,  @mHdrExchangeRate,  @cHdrExchangeTableID,  @dHdrExchangeTime,   @FALSE,     @FALSE,      @I_tPosting,   @FALSE,     @cHdrRateTypeID,  @dHdrTransactionDate,  @sMCTrxState,  @O_bHeaderMessages2 output,  @sHdrOrigCurrencyIndex output,  @O_sDecimalPlaces output,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break  end   end   else  select  @O_sMCTransaction  = @GL_TRANSACTION,  @cHdrOrigCurrencyID  = @I_cFuncCurrencyID,  @sHdrOrigCurrencyIndex = @I_sFuncCurrencyIndex,  @O_sDecimalPlaces  = @I_sFuncDecimalPlaces + 1   if Exists (select * from sysobjects where id = object_id('dbo.IF000001') and xtype = 'U')  begin  if Exists (select IF_Activated from IF000001 where IF_Activated = 1)  begin  if (select count(*) from IF000005 where BACHNUMB= @I_cBatchNumber and JRNENTRY=@I_iJournalEntry and USERID= @I_cUserID ) > 0   begin      select @O_bHeaderMessages2 = (@O_bHeaderMessages2 | @MS_ITEM_5)   if @I_tPosting = @TRUE   begin  select @O_iErrorState = 20777   break   end  end   end  end   if (@bHdrHeaderValid & @MS_ITEM_3) <> @MS_ITEM_3 or    (@sHdrTransactionType = @REVERSING and   (@bHdrHeaderValid & @MS_ITEM_4) <> @MS_ITEM_4) or   (@I_bBatchValid & @MS_ITEM_1) = @MS_ITEM_1 or   (@I_bBatchValid & @MS_ITEM_2) = @MS_ITEM_2 or   @I_sBatchFrequency > @SINGLE_USE  begin  exec @iStatus = glpVerifyPostingDate  @I_sTransactionType,  @sHdrTransactionType,  @dHdrTransactionDate,  @dHdrReversingDate,  @I_sBatchFrequency,  @I_tPosting,  @O_bHeaderMessages output,  @sHdrTransactionPeriodID output,  @sHdrTransactionYear output,  @sHdrTransactionClosingYear output,  @tHdrTransactionHistory output,  @sHdrReversingPeriodID output,  @sHdrReversingYear output,  @sHdrReversingClosingYear output,  @tHdrReversingHistory output,  @O_iErrorState output,  @I_iJournalEntry output     select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break   select @tUpdateHeaderInfo = @TRUE   end     if @I_sTransactionType = @CLEARING_TRX  and  @tHdrTransactionHistory = @TRUE  begin   select @O_bHeaderMessages = (@O_bHeaderMessages | @MS_ITEM_15)   if @I_tPosting = @TRUE  begin  select @O_iErrorState = 20137   break  end  end  if @I_sTransactionType = @BUDGET_TRX and @tHdrTransactionHistory = @TRUE  begin   select @O_bHeaderMessages = (@O_bHeaderMessages | @MS_ITEM_20)   if @I_tPosting = @TRUE  begin  select @O_iErrorState = 21122   break  end   end   if (@bHdrHeaderValid & @MS_ITEM_2) <> @MS_ITEM_2 or   (@I_bBatchValid & @MS_ITEM_1) = @MS_ITEM_1 or    @tHdrTransactionHistory = @TRUE or  @tHdrReversingHistory = @TRUE  begin  if @I_sTransactionType = @BUDGET_TRX   select @sJournalStatus = @NEW  else  if @tHdrTransactionHistory = @TRUE or  @tHdrReversingHistory = @TRUE     exec @iStatus = glVerifyHistoryJournalEntry  @I_iJournalEntry,  @I_sBatchFrequency,  @sHdrTransactionYear,  @sJournalStatus output,  @O_iErrorState output  else   exec @iStatus = glVerifyJournalEntry  @I_iJournalEntry,  @I_sBatchFrequency,  @sJournalStatus output,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break   end    else  begin  if @I_sBatchFrequency = @SINGLE_USE  select @sJournalStatus = @NEW  else  select @sJournalStatus = @RECURRING_TRX   end    if @sJournalStatus = @NEW  select @nHdrRecurringTRXSequence = 0.0,  @tUpdateHeaderInfo = @TRUE   else if @sJournalStatus = @RECURRING_TRX  begin  select @nHdrRecurringTRXSequence = @nHdrRecurringTRXSequence + 1.0,  @tUpdateHeaderInfo = @TRUE   if @O_sMCTransaction = @MC_TRANSACTION and  @I_sTransactionType <> @CLEARING_TRX  begin  select @O_bHeaderMessages2 = (@O_bHeaderMessages2 | @MS_ITEM_11)   if @I_tPosting = @TRUE  begin  select @O_iErrorState = 20788  break  end  end  end  else  begin  select @O_bHeaderMessages = (@O_bHeaderMessages | @MS_ITEM_7)   if @I_tPosting = @TRUE  begin  select @O_iErrorState = 20005  break  end  end     if @I_sTransactionType = @BUSINESS_FORM  begin  if @sHdrTransactionType <> 0  begin  select @O_iErrorState = 20729  break  end   if @I_sBatchFrequency <> @SINGLE_USE  begin  select @O_iErrorState = 20730  break  end   exec @iStatus = glpVerifyQuickTransaction   @I_iJournalEntry,  @I_cBatchNumber,  @iHdrOffsetAccountIndex,  @I_tPosting,  @tHdrTransactionHistory,  @bHdrHeaderValid,  @I_bBatchValid,  @I_sCompanyID,  @sHdrOffsetAccountType output,  @sHdrOffsetFixedOrVariable output,  @sHdrBalanceForCalculation output,  @sHdrOffsetPostingType output,  @O_bHeaderMessages output,  @IO_tPrintDistributions output,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break   select @tUpdateHeaderInfo = @TRUE   end    if @I_sTransactionType = @BUDGET_TRX  begin  if @I_sBatchFrequency <> @SINGLE_USE  begin  select @O_iErrorState = 20730  break  end   end    if @I_sTransactionType = @NORMAL_TRX  begin   exec @iStatus = glVerifyTaxDate  @I_tPosting,  @I_tUseTaxPeriods,  @dHdrTaxDate,  0,  @O_bHeaderMessages2 output,  @O_iErrorState output    select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break  if @sHdrTransactionType = @REVERSING  begin  exec @iStatus = glVerifyTaxDate  @I_tPosting,  @I_tUseTaxPeriods,  @dHdrReversingDate,  @sHdrTransactionType,  @O_bHeaderMessages2 output,  @O_iErrorState output    select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break  end  if @I_AllowReportingLedgers = @TRUE  begin  select @LedgerName = (select Ledger_Name  from GL40001 where Ledger_ID = @LedgerID)  if (@LedgerName) IS NULL  begin  select @O_bHeaderMessages2 = (@O_bHeaderMessages2 | @MS_ITEM_17)  if @I_tPosting = @TRUE  begin  select @O_iErrorState = 21116   break  end  end  end    end   if @tUpdateHeaderInfo = @TRUE  begin  update  #TRXHeader  set  RecurringTRXSequence = @nHdrRecurringTRXSequence,  TransactionPeriodID  = @sHdrTransactionPeriodID,  TransactionYear   = @sHdrTransactionYear,  TransactionClosingYear = @sHdrTransactionClosingYear,  TransactionHistory  = @tHdrTransactionHistory,  ReversingPeriodID  = @sHdrReversingPeriodID,  ReversingYear   = @sHdrReversingYear,  ReversingClosingYear = @sHdrReversingClosingYear,  ReversingHistory  = @tHdrReversingHistory,  OffsetAccountType   = @sHdrOffsetAccountType,  OffsetFixedOrVariable = @sHdrOffsetFixedOrVariable,  BalanceForCalculation = @sHdrBalanceForCalculation,  OffsetPostingType  = @sHdrOffsetPostingType  where  JournalEntry = @I_iJournalEntry   if @@rowcount <> 1  begin  select @O_iErrorState = 20897  break  end   end   end   if @iStatus <> 0 or @O_iErrorState <> 0 begin  if @tTransaction = 1  rollback transaction  end else if @tTransaction = 1  commit transaction  return (@iStatus)   
GO
GRANT EXECUTE ON  [dbo].[glpVerifyTransaction] TO [DYNGRP]
GO
