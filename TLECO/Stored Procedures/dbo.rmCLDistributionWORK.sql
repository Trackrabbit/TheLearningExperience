SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[rmCLDistributionWORK]   @I_cUserID char(15) = NULL,  @I_cFileName1 varchar(40) = NULL,  @I_cSearchString1 char(2)  = NULL,  @O_iErrorState int  = NULL output as  declare  @iError int,   @iStatus int,   @tLoop tinyint,  @TRUE tinyint,  @RMDOCCASH int  select  @O_iErrorState = 0,  @iStatus  = 0,  @TRUE  = 1  while (@tLoop is NULL) begin  select @tLoop = 1   if @I_cUserID is NULL  or @I_cFileName1 is NULL  or    @I_cSearchString1 is NULL  begin  select @O_iErrorState = 20846  break  end   exec @iStatus = DYNAMICS.dbo.smGetConstantInt  'RM_DOC_CASH',   @RMDOCCASH output,   @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   insert into  #CNTRLNUMTEMP(  CNTRLNUM,  DOCTYPE,  VENDORID )  select  DISTINCT DOCNUMBR,  RMDTYPAL,  CUSTNMBR  from  RM10101  where RM10101.POSTED = @TRUE  and NOT EXISTS  (select 1  from RM20101  where  RM10101.DOCNUMBR = RM20101.DOCNUMBR  and RM10101.RMDTYPAL = RM20101.RMDTYPAL )   if @@rowcount <> 0  begin  delete  RM10101  from  RM10101  where RM10101.POSTED = @TRUE  and NOT EXISTS  (select 1  from RM20101  where  RM10101.DOCNUMBR = RM20101.DOCNUMBR  and RM10101.RMDTYPAL = RM20101.RMDTYPAL )   exec @iStatus = smCreateErrorLogRecord  @I_cUserID,  @I_cFileName1,  NULL,  10325,  @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break   end    insert into  #CNTRLNUMTEMP(  CNTRLNUM,  DOCTYPE,  VENDORID )  select  DISTINCT DOCNUMBR,  RMDTYPAL,  CUSTNMBR  from  RM10101  where RM10101.POSTED <> @TRUE  and  RM10101.RMDTYPAL >= @RMDOCCASH  and NOT EXISTS  (select 1  from RM10201  where substring(RM10101.DOCNUMBR,1,len(RM10201.DOCNUMBR)) = (RM10201.DOCNUMBR)  and RM10101.RMDTYPAL = RM10201.RMDTYPAL )   if @@rowcount <> 0  begin  delete  RM10101  from  RM10101  where RM10101.POSTED <> @TRUE  and  RM10101.RMDTYPAL >= @RMDOCCASH  and NOT EXISTS  (select 1  from RM10201  where substring(RM10101.DOCNUMBR,1,len(RM10201.DOCNUMBR)) = (RM10201.DOCNUMBR)  and RM10101.RMDTYPAL = RM10201.RMDTYPAL )   exec @iStatus = smCreateErrorLogRecord  @I_cUserID,  @I_cFileName1,  NULL,  10325,  @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break   end    insert into  #CNTRLNUMTEMP(  CNTRLNUM,  DOCTYPE,  VENDORID )  select  DISTINCT DOCNUMBR,  RMDTYPAL,  CUSTNMBR  from  RM10101  where RM10101.POSTED <> @TRUE  and  RM10101.RMDTYPAL < @RMDOCCASH  and NOT EXISTS  (select 1  from RM10301  where RM10101.DOCNUMBR = RM10301.RMDNUMWK  and RM10101.RMDTYPAL = RM10301.RMDTYPAL )   if @@rowcount <> 0  begin  delete  RM10101  from  RM10101  where RM10101.POSTED <> @TRUE  and  RM10101.RMDTYPAL < @RMDOCCASH  and NOT EXISTS  (select 1  from RM10301  where RM10101.DOCNUMBR = RM10301.RMDNUMWK  and RM10101.RMDTYPAL = RM10301.RMDTYPAL )   exec @iStatus = smCreateErrorLogRecord  @I_cUserID,  @I_cFileName1,  NULL,  10325,  @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break   end   end   return(@iStatus)    
GO
GRANT EXECUTE ON  [dbo].[rmCLDistributionWORK] TO [DYNGRP]
GO
