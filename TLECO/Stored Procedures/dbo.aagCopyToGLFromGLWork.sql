SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create             procedure [dbo].[aagCopyToGLFromGLWork] @I_nGLWorkHdrID int, @HdrID int output, @I_nYear int, @I_cTrxSource char(13), @I_caaTrxSource char(13), @O_fSuccess tinyint = 1 output, @CompayID smallint, @I_dtglPostDate datetime as begin   set nocount on  declare @RCTRXSEQ int,  @ORMSTRID  char(31),  @cnt    int,  @i    int,  @nIsOpenYear tinyint   select  @RCTRXSEQ = 0   if exists(Select YEAR1 from SY40101 where YEAR1 = @I_nYear and HISTORYR = 0)   begin   Select top 1 @RCTRXSEQ = RCTRXSEQ ,@ORMSTRID =  ORMSTRID from GL20000  where JRNENTRY in (Select JRNENTRY from AAG10000 where aaGLWorkHdrID = @I_nGLWorkHdrID) and  TRXSORCE = @I_cTrxSource   select @nIsOpenYear = 1  end  else  begin  Select top 1 @RCTRXSEQ = RCTRXSEQ , @ORMSTRID =  ORMSTRID from GL30000  where JRNENTRY in (Select JRNENTRY from AAG10000 where aaGLWorkHdrID = @I_nGLWorkHdrID) and  TRXSORCE = @I_cTrxSource  select @nIsOpenYear = 0  end   exec DYNAMICS.dbo.aagGetNextID 30000, @CompayID, @HdrID output    INSERT INTO [AAG30000] ([aaGLHdrID], [JRNENTRY], [RCTRXSEQ], [YEAR1],  [aaGLTRXSource], [aaTRXSource],[aaTRXType], [GLPOSTDT], [Ledger_ID])  SELECT  @HdrID, [JRNENTRY], [RCTRXSEQ], @I_nYear,  @I_cTrxSource,@I_caaTrxSource, [aaTRXType], @I_dtglPostDate, [Ledger_ID]   FROM [AAG10000]  where aaGLWorkHdrID = @I_nGLWorkHdrID   INSERT INTO [AAG30001] ([aaGLHdrID], [aaGLDistID],[INTERID], [aaBrowseType], [CorrespondingUnit], [ACTINDX], [ACCTTYPE],  [DECPLACS], [DEBITAMT], [CRDTAMNT], [ORDBTAMT], [ORCRDAMT], [CURNCYID],  [CURRNIDX], [RATETPID], [EXGTBLID], [XCHGRATE], [EXCHDATE], [TIME1],  [RTCLCMTD], [DENXRATE], [MCTRXSTT], [SEQNUMBR], [aaCustID], [aaVendID],  [aaSiteID], [aaItemID], [EMPLOYID], [aaCopyStatus])  SELECT    @HdrID, [aaGLWorkDistID],[INTERID],[aaBrowseType], [CorrespondingUnit], [ACTINDX], [ACCTTYPE],  [DECPLACS], [DEBITAMT], [CRDTAMNT], [ORDBTAMT], [ORCRDAMT], [CURNCYID],  [CURRNIDX], [RATETPID], [EXGTBLID], [XCHGRATE], [EXCHDATE], [TIME1],  [RTCLCMTD], [DENXRATE], [MCTRXSTT], [SQNCLINE], [aaCustID], [aaVendID],  [aaSiteID], [aaItemID], [EMPLOYID], [aaCopyStatus]  FROM [AAG10001]  where aaGLWorkHdrID = @I_nGLWorkHdrID   if @nIsOpenYear = 1  BEGIN  if (select min(SEQNUMBR) from AAG30001 where aaGLHdrID = @HdrID) <> (select  min(SEQNUMBR) from GL20000 where JRNENTRY = (select JRNENTRY from AAG30000 where aaGLHdrID = @HdrID) and TRXSORCE = @I_cTrxSource )  Begin  select  @cnt=count(JRNENTRY) from GL20000 where JRNENTRY = (select JRNENTRY from AAG30000 where aaGLHdrID = @HdrID) and TRXSORCE = @I_cTrxSource   set @i=1   while @i<=@cnt  Begin  if exists(select SEQNUMBR from GL20000 where JRNENTRY = (select JRNENTRY from AAG30000   where aaGLHdrID = @HdrID) and TRXSORCE = @I_cTrxSource and   OrigSeqNum = (select SEQNUMBR from AAG30001 where aaGLHdrID = @HdrID and aaGLDistID = @i))  Update AAG30001 set SEQNUMBR= (select SEQNUMBR from GL20000 where JRNENTRY = (select JRNENTRY from AAG30000 where aaGLHdrID = @HdrID) and TRXSORCE = @I_cTrxSource and   OrigSeqNum = (select SEQNUMBR from AAG30001 where aaGLHdrID = @HdrID and aaGLDistID = @i)) where aaGLHdrID = @HdrID and aaGLDistID = @i  set @i=@i+1  END  END  END  ELSE  BEGIN  if (select min(SEQNUMBR) from AAG30001 where aaGLHdrID = @HdrID) <> (select  min(SEQNUMBR) from GL30000 where JRNENTRY = (select JRNENTRY from AAG30000 where aaGLHdrID = @HdrID) and TRXSORCE = @I_cTrxSource )  Begin  select  @cnt=count(JRNENTRY) from GL30000 where JRNENTRY = (select JRNENTRY from AAG30000 where aaGLHdrID = @HdrID) and TRXSORCE = @I_cTrxSource   set @i=1   while @i<=@cnt  Begin  if exists(select SEQNUMBR from GL30000 where JRNENTRY = (select JRNENTRY from AAG30000 where aaGLHdrID = @HdrID) and TRXSORCE = @I_cTrxSource and   OrigSeqNum = (select SEQNUMBR from AAG30001 where aaGLHdrID = @HdrID and aaGLDistID = @i))  Update AAG30001 set SEQNUMBR= (select SEQNUMBR from GL30000 where JRNENTRY = (select JRNENTRY from AAG30000 where aaGLHdrID = @HdrID) and TRXSORCE = @I_cTrxSource and   OrigSeqNum = (select SEQNUMBR from AAG30001 where aaGLHdrID = @HdrID and aaGLDistID = @i)) where aaGLHdrID = @HdrID and aaGLDistID = @i   set @i=@i+1  END  END  END   INSERT INTO [AAG30002] ([aaGLHdrID], [aaGLDistID], [aaGLAssignID], [DEBITAMT], [CRDTAMNT],  [ORDBTAMT], [ORCRDAMT],[aaAssignedPercent], [DistRef], [NOTEINDX], [aaAliasID])  SELECT    @HdrID, [aaGLWorkDistID], [aaGLWorkAssignID], [DEBITAMT], [CRDTAMNT],  [ORDBTAMT], [ORCRDAMT],[aaAssignedPercent], [DistRef], [NOTEINDX], [aaAliasID]  FROM [AAG10002]  where aaGLWorkHdrID = @I_nGLWorkHdrID   INSERT INTO [AAG30003] ([aaGLHdrID], [aaGLDistID], [aaGLAssignID], [aaTrxDimID], [aaTrxCodeID])  SELECT    @HdrID, [aaGLWorkDistID], [aaGLWorkAssignID], [aaTrxDimID], [aaTrxCodeID]  FROM [AAG10003]  where aaGLWorkHdrID = @I_nGLWorkHdrID and aaTrxCodeID <> 0   set nocount off end    
GO
GRANT EXECUTE ON  [dbo].[aagCopyToGLFromGLWork] TO [DYNGRP]
GO
