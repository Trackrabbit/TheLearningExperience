SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[pmHistoricalAgedTrialBalance]  @I_cVendorTemp char(40)        = NULL,  @I_cDocumentTemp char(40)        = NULL,  @I_cApplyTemp char(40)        = NULL,  @I_cVendorListTemp char(40) = NULL,  @I_dAgingDate datetime = NULL,  @I_cStartVendorID               char(15)        = NULL,  @I_cEndVendorID          char(15)        = NULL,  @I_cStartVendorName             char(65)        = NULL,  @I_cEndVendorName               char(65)        = NULL,  @I_cStartClassID                char(15)        = NULL,  @I_cEndClassID                  char(15)        = NULL,  @I_cStartUserDefined     char(15)        = NULL,  @I_cEndUserDefined              char(15)        = NULL,  @I_cStartPaymentPriority        char(3)  = NULL,  @I_cEndPaymentPriority   char(3)  = NULL,  @I_cStartDocumentNumber char(21) = NULL,  @I_cEndDocumentNumber char(21) = NULL,  @I_tUsingDocumentDate tinyint  = NULL,  @I_dStartDate datetime = NULL,  @I_dEndDate datetime = NULL,  @I_tExcludeNoActivity tinyint  = NULL,  @I_tExcludeMultiCurrency tinyint  = NULL,  @I_tExcludeZeroBalanceVendors tinyint  = NULL,  @I_tExcludeFullyPaidTrxs tinyint  = NULL,  @I_tExcludeCreditBalance tinyint  = NULL,  @I_tExcludeUnpostedAppldCrDocs  tinyint  = NULL,  @I_cFunctionalCurrency char(15) = NULL,  @I_tMCRegistered tinyint  = NULL,  @I_sPrintCurrencyIn smallint = NULL,  @I_nReportingExchangeRate numeric(15,7) = NULL,  @I_sReportingRateCalcMethod smallint = NULL,  @I_sReportingDecimalPlaces smallint = NULL,  @I_tEuroEnabled tinyint  = NULL,  @O_iErrorState                  int             = NULL output as  declare  @TRUE smallint,  @FALSE smallint,  @cUsingDocumentDate char(1),  @cStartDate char(12),  @cEndDate char(12),  @cExcludeUnpostedFlag char(1),  @vExcludeUnpostedAppldCrDocs varchar(255),  @vExcludeApplyDateRange1 varchar(255),  @vExcludeApplyDateRange2 varchar(255),  @tLoopControl            tinyint,  @iStatus                 int,  @iError                  int  select  @iStatus = 0,  @O_iErrorState = 0  select  @TRUE  = 1,  @FALSE = 0  create table #DocumentTEMP(  VendorID                char(15) not null,  VoucherNumber char(21) not null,  DocumentType smallint not null,  CurrentTrxAmount numeric(19,5) not null,  DocumentAmount numeric(19,5) not null,  DiscountTakenAmount numeric(19,5) not null,  DiscountAmountAvail numeric(19,5) not null,  WriteoffAmount numeric(19,5) not null,  TotalPaymentsAmount numeric(19,5) not null,  RevalDocAmountAdj numeric(19,5) not null,  RevalDiscAmountAvailAdj numeric(19,5) not null,  RevalCurrentTrxAmountAdj numeric(19,5) not null,  SettledGainOrLoss numeric(19,5) not null,  SettledDiscAvail numeric(19,5) not null,  DocumentDate datetime not null,  DueDate datetime not null,  DiscountDate datetime not null,  GLPostingDate datetime not null,  DocumentNumber char(21) not null,  TrxSource char(13) not null,  CurrencyID char(15) not null,  CurrencyIndex smallint not null,  ExchangeRate numeric(15,7) not null,  DenominationExchangeRate numeric(15,7) not null,  MCTransactionState smallint not null,  OrigDocumentAmount numeric(19,5) not null,  OrigDiscTakenAmount numeric(19,5) not null,  OrigCurrentTrxAmount numeric(19,5) not null,  OrigDiscAmountAvail numeric(19,5) not null,  OrigWriteoffAmount numeric(19,5) not null,  OrigTotalPaymentsAmount numeric(19,5) not null,  OpenRecord tinyint not null,  AgingPeriod smallint not null )  create table #ApplyTEMP(  ApplyToVoucherNumber char(21) not null,  ApplyToDocumentType smallint not null,  VoucherNumber char(21) not null,  DocumentType smallint not null,  AppliedAmount numeric(19,5) not null,  RealizedGainLossAmount numeric(19,5) not null,  OrigAppliedAmount numeric(19,5) not null,  OrigDiscTakenAmount numeric(19,5) not null,  OrigWriteoffAmount numeric(19,5) not null,  CurrencyID char(15) not null,  CurrencyIndex smallint not null,  ExchangeRate numeric(15,7) not null,  DenominationExchangeRate numeric(15,7) not null,  MCTransactionState smallint not null,  DiscountTakenAmount numeric(19,5) not null,  GSTDiscountAmount numeric(19,5) not null,  WriteoffAmount numeric(19,5) not null,  PPSAmount numeric(19,5) not null,  AgingPeriod smallint not null,  Posted tinyint not null)  CREATE nonclustered index AK1ApplyTEMP on #ApplyTEMP(ApplyToVoucherNumber, ApplyToDocumentType)  while @tLoopControl is NULL begin  select @tLoopControl = 1   if @I_cVendorTemp is NULL or  @I_cDocumentTemp is NULL or  @I_cApplyTemp is NULL or  @I_cVendorListTemp is NULL or  @I_dAgingDate is NULL or  @I_cStartVendorID               is NULL or  @I_cEndVendorID          is NULL or  @I_cStartVendorName             is NULL or  @I_cEndVendorName               is NULL or  @I_cStartClassID                is NULL or  @I_cEndClassID                  is NULL or  @I_cStartUserDefined     is NULL or  @I_cEndUserDefined              is NULL or  @I_cStartPaymentPriority        is NULL or  @I_cEndPaymentPriority   is NULL or  @I_cStartDocumentNumber is NULL or  @I_cEndDocumentNumber is NULL or  @I_tUsingDocumentDate is NULL or  @I_dStartDate is NULL or  @I_dEndDate is NULL or  @I_tExcludeNoActivity is NULL or  @I_tExcludeMultiCurrency is NULL or  @I_tExcludeZeroBalanceVendors is NULL or  @I_tExcludeFullyPaidTrxs is NULL or  @I_tExcludeCreditBalance is NULL or  @I_tExcludeUnpostedAppldCrDocs is NULL or  @I_cFunctionalCurrency is NULL or  @I_tMCRegistered is NULL or  @I_sPrintCurrencyIn is NULL or  @I_nReportingExchangeRate is NULL or  @I_sReportingRateCalcMethod is NULL or  @I_sReportingDecimalPlaces is NULL or  @I_tEuroEnabled is NULL  begin  select @O_iErrorState = 20958  break  end    Exec @iStatus = pmPrintHATBGetDocuments  @I_dAgingDate,  @I_cStartVendorID,  @I_cEndVendorID,  @I_cStartVendorName,  @I_cEndVendorName,  @I_cStartClassID,  @I_cEndClassID,  @I_cStartUserDefined,  @I_cEndUserDefined,  @I_cStartPaymentPriority,  @I_cEndPaymentPriority,  @I_cStartDocumentNumber,  @I_cEndDocumentNumber,  @I_tUsingDocumentDate,  @I_dStartDate,  @I_dEndDate,  @I_tExcludeMultiCurrency,  @I_cFunctionalCurrency,  @I_tMCRegistered,  @I_sPrintCurrencyIn,  @I_nReportingExchangeRate,  @I_sReportingRateCalcMethod,  @I_sReportingDecimalPlaces,  @I_cVendorListTemp,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   Exec @iStatus = pmPrintHATBGetApplyWorkOpen  @I_tUsingDocumentDate,  @I_dStartDate,  @I_dEndDate,  @I_cStartDocumentNumber,  @I_cEndDocumentNumber,  @I_tExcludeMultiCurrency,  @I_tExcludeUnpostedAppldCrDocs,  @I_cFunctionalCurrency,  @I_tMCRegistered,  @I_sPrintCurrencyIn,  @I_nReportingExchangeRate,  @I_sReportingRateCalcMethod,  @I_sReportingDecimalPlaces,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   Exec @iStatus = pmPrintHATBGetApplyHistory  @I_tUsingDocumentDate,  @I_dStartDate,  @I_dEndDate,  @I_cStartDocumentNumber,  @I_cEndDocumentNumber,  @I_tExcludeMultiCurrency,  @I_cFunctionalCurrency,  @I_tMCRegistered,  @I_sPrintCurrencyIn,  @I_nReportingExchangeRate,  @I_sReportingRateCalcMethod,  @I_sReportingDecimalPlaces,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   Exec @iStatus = pmHATBCalculateTotals  @I_tUsingDocumentDate,  @I_dStartDate,  @I_dEndDate,  @I_dAgingDate,  @I_tExcludeUnpostedAppldCrDocs,  @I_cFunctionalCurrency,  @I_tMCRegistered,  @I_sPrintCurrencyIn,  @I_nReportingExchangeRate,  @I_sReportingRateCalcMethod,  @I_sReportingDecimalPlaces,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   Exec @iStatus = pmHATBLoadDexTempTables  @I_cVendorTemp,  @I_cDocumentTemp,  @I_cApplyTemp,  @I_cVendorListTemp,  @I_cStartVendorID,  @I_cEndVendorID,  @I_cStartVendorName,  @I_cEndVendorName,  @I_cStartClassID,  @I_cEndClassID,  @I_cStartUserDefined,  @I_cEndUserDefined,  @I_cStartPaymentPriority,  @I_cEndPaymentPriority,  @I_tExcludeNoActivity,  @I_tExcludeZeroBalanceVendors,  @I_tExcludeFullyPaidTrxs,  @I_tExcludeCreditBalance,  @I_tExcludeMultiCurrency,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break  end   drop table #DocumentTEMP drop table #ApplyTEMP  return(@iStatus)   
GO
GRANT EXECUTE ON  [dbo].[pmHistoricalAgedTrialBalance] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[pmHistoricalAgedTrialBalance] TO [rpt_accounting manager]
GO
GRANT EXECUTE ON  [dbo].[pmHistoricalAgedTrialBalance] TO [rpt_accounts payable coordinator]
GO
GRANT EXECUTE ON  [dbo].[pmHistoricalAgedTrialBalance] TO [rpt_bookkeeper]
GO
GRANT EXECUTE ON  [dbo].[pmHistoricalAgedTrialBalance] TO [rpt_power user]
GO
