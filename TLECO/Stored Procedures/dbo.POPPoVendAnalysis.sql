SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[POPPoVendAnalysis]  @I_VENDORID VARCHAR(100), @I_Orderby int, @IN_TypeID smallint, @IN_DocumentNo varchar(60), @IN_PurchaseOrdTbl varchar(10)   as BEGIN  declare @SqlStr1 varchar(8000)  declare @SqlStr2 varchar(8000)  declare @OrderbyStr varchar(7)  declare @QueryStr1 varchar(8000)  DECLARE @DocFilterStr VARCHAR(1000), @CompDBName VARCHAR(10)   SELECT @QueryStr1 = '', @CompDBName = DB_NAME()  exec POPVendAnalysisBuildQuery 4,1,@QueryStr1 out  if @I_Orderby = 0   SET @OrderbyStr = ' DESC '  else   SET @OrderbyStr = ' ASC '   IF @IN_TypeID = 2  and @IN_DocumentNo <> ''  SELECT @DocFilterStr = 'AND A.PONUMBER IN (SELECT PONUMBER FROM POP10310 WHERE POPRCTNM = '+ @IN_DocumentNo +' UNION SELECT PONUMBER FROM POP30310 WHERE POPRCTNM = '+ @IN_DocumentNo +') '  ELSE IF @IN_TypeID = 3  and @IN_DocumentNo <> ''   SELECT @DocFilterStr = ' AND A.PONUMBER IN (SELECT PORDNMBR FROM PM10000 WHERE VCHRNMBR = '+ @IN_DocumentNo +' UNION SELECT PORDNMBR FROM PM20000 WHERE VCHRNMBR = '+ @IN_DocumentNo +' UNION SELECT PORDNMBR FROM PM30200 WHERE VCHRNMBR = '+ @IN_DocumentNo +' UNION SELECT PONUMBER FROM POP10500 WHERE POPRCTNM = '+ @IN_DocumentNo +' OR POPRCTNM IN (SELECT POPRCTNM FROM POP30300 WHERE VCHRNMBR = '+ @IN_DocumentNo +')) '   ELSE IF @IN_TypeID = 4  and @IN_DocumentNo <> ''   BEGIN  SELECT @DocFilterStr = ' AND A.PONUMBER IN ((SELECT PORDNMBR FROM PM20000 WHERE VCHRNMBR IN (SELECT APTVCHNM FROM PM20100 WHERE APFRDCNM = '+ @IN_DocumentNo +') UNION SELECT PORDNMBR FROM PM10000 WHERE VCHRNMBR IN (SELECT APTVCHNM FROM PM30300 WHERE VCHRNMBR = '+ @IN_DocumentNo +' ) UNION SELECT PORDNMBR FROM PM20000 WHERE VCHRNMBR IN (SELECT APTVCHNM FROM PM30300 WHERE VCHRNMBR = '+ @IN_DocumentNo +' ) UNION SELECT PORDNMBR FROM PM30200 WHERE VCHRNMBR IN (SELECT APTVCHNM FROM PM30300 WHERE VCHRNMBR = '+ @IN_DocumentNo +' ) UNION SELECT PONUMBER FROM POP10500 WHERE POPRCTNM IN (SELECT POPRCTNM FROM POP30300 WHERE VCHRNMBR IN (SELECT APTVCHNM FROM PM30300 WHERE VCHRNMBR = '+ @IN_DocumentNo +')))) '  END  ELSE IF @IN_TypeID = 5  and @IN_DocumentNo <> ''   BEGIN  SELECT @DocFilterStr = 'AND A.PONUMBER IN (SELECT PONUMBER FROM POP10310 WHERE POPRCTNM = '+ @IN_DocumentNo +' UNION SELECT PONUMBER FROM POP30310 WHERE POPRCTNM = '+ @IN_DocumentNo +') '  END  ELSE IF @IN_TypeID = 6  and @IN_DocumentNo <> ''   BEGIN  SELECT @DocFilterStr = 'AND A.PONUMBER IN (SELECT PONUMBER FROM POP10310 WHERE POPRCTNM = '+ @IN_DocumentNo +' UNION SELECT PONUMBER FROM POP30310 WHERE POPRCTNM = '+ @IN_DocumentNo +' UNION SELECT PORDNMBR FROM PM10000 WHERE VCHRNMBR = '+ @IN_DocumentNo +' UNION SELECT PORDNMBR FROM PM20000 WHERE VCHRNMBR = '+ @IN_DocumentNo +' UNION SELECT PORDNMBR FROM PM30200 WHERE VCHRNMBR = '+ @IN_DocumentNo +') '  END   EXEC ('DELETE FROM '+ @IN_PurchaseOrdTbl)  set @SqlStr1 = ' INSERT INTO ['+@IN_PurchaseOrdTbl+']  SELECT TOP 100 ROW_NUMBER() OVER (ORDER BY A.DOCDATE '+@OrderbyStr+') AS [INDXLONG],VENDORID,PONUMBER,DOCDATE,  POSTATUS,POP_Origin,Workflow_Status,REQDATE,SHIPMTHD,CUSTNMBR,SOPNUMBE,SOPTYPE,SUBTOTAL,  PrepaymentAmount,ADDRESS1,ADDRESS2,ADDRES1,ADDRES2,POPRequisitionNumber,POPRCTNM  FROM (SELECT POP10100.VENDORID, POP10100.PONUMBER, POP10100.DOCDATE, [POSTATUS], POTYPE, 3 POP_Origin,[Workflow_Status], [REQDATE],   POP10100.[SHIPMTHD], [CUSTNMBR], case SOPTYPE when 9 then '''' else isnull([SOPNUMBE],'''') end SOPNUMBE, ISNULL(SOPTYPE,0) SOPTYPE, POP10100.[SUBTOTAL], POP10100.[PrepaymentAmount],  CITY ADDRESS1,RTRIM(STATE) + '' '' + ZIPCODE ADDRESS2, ADDRESS1 ADDRES1, ADDRESS2 ADDRES2,  case SOPTYPE when 9 then isnull([SOPNUMBE],'''') else '''' end POPRequisitionNumber,  SYSTEM_USER USERID, HOLD, CASE  WHEN POPTYPE IN (4, 5) THEN isnull(POP10310.[POPRCTNM],'''')  ELSE '''' END POPRCTNM  FROM POP10100 LEFT OUTER JOIN SOP60100 on SOP60100.PONUMBER = POP10100.PONUMBER   LEFT OUTER JOIN POP10310 on POP10100.PONUMBER = POP10310.PONUMBER  LEFT JOIN POP10300 on POP10310.POPRCTNM = POP10300.POPRCTNM AND POP10100.VENDORID = POP10300.VENDORID '  set @SqlStr2 = ' UNION   SELECT POP30100.VENDORID, POP30100.PONUMBER, POP30100.DOCDATE, [POSTATUS], POTYPE, 4 POP_Origin, [Workflow_Status], [REQDATE],   POP30100.[SHIPMTHD], [CUSTNMBR], case SOPTYPE when 9 then '''' else isnull([SOPNUMBE],'''') end SOPNUMBE, ISNULL(SOPTYPE,0) SOPTYPE, POP30100.[SUBTOTAL], POP30100.[PrepaymentAmount],  CITY ADDRESS1, RTRIM(STATE) + '' '' + ZIPCODE ADDRESS2, ADDRESS1 ADDRES1, ADDRESS2 ADDRES2,  case SOPTYPE when 9 then isnull([SOPNUMBE],'''') else '''' end POPRequisitionNumber,  SYSTEM_USER USERID, 0 HOLD, CASE  WHEN POPTYPE IN (4, 5) THEN isnull(POP30310.[POPRCTNM],'''')  ELSE '''' END POPRCTNM  FROM POP30100 LEFT OUTER JOIN SOP60100 on SOP60100.PONUMBER = POP30100.PONUMBER   LEFT OUTER JOIN POP30310 on POP30100.PONUMBER = POP30310.PONUMBER  LEFT JOIN POP30300 on POP30310.POPRCTNM = POP30300.POPRCTNM AND POP30100.VENDORID = POP30300.VENDORID) A WHERE A.VENDORID = '+ rtrim(@I_VENDORID) +' '  EXEC (@SqlStr1 + @SqlStr2 + @QueryStr1 + @DocFilterStr) END    
GO
GRANT EXECUTE ON  [dbo].[POPPoVendAnalysis] TO [DYNGRP]
GO
