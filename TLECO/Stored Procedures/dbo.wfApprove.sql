SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[wfApprove]  @ChangedDocument tinyint,  @WorkflowStepInstanceID char(37),  @Workflow_User char(85),  @Workflow_Task_Complete tinyint,   @Workflow_Comments char(2000),  @TempFilePath nvarchar(300) = '',  @Workflow_Error int OUTPUT AS  BEGIN   declare @WorkflowInstanceID char(37), @Workflow_Step_Assign_To char(37)  declare @Workflow_Managers char(37), @WF_Alt_FinalApprover char(37)  declare @Workflow_Step_Name char(51), @Workflow_Name char(51), @Workflow_Type_Name char(51)  declare @Workflow_Version int  declare @WF_Step_Completion_Polic smallint  declare @DueDate datetime, @DueTime datetime,  @Workflow_Completion_Date datetime, @Workflow_Completion_Time datetime  declare @met_completion_policy tinyint, @tasks_created tinyint,   @bypass_conditions tinyint, @workflow_action tinyint,  @escalation tinyint, @Workflow_Require_One_App tinyint,   @calculate_due_date tinyint, @assignment_status tinyint,  @approval_tasks_created tinyint, @escalate tinyint,   @WF_Use_Alt_Final_Approv tinyint, @alt_final_approver_step tinyint  declare @CMPANYID varchar(5), @server_name nvarchar(128), @SystemDB nvarchar(11)  declare @number_of_assignees numeric(19,5), @number_of_approvers numeric(19,5)  declare @WF_Action int, @Workflow_History_User char(85), @write_history_record tinyint  declare @WFIncludeDocumentAttach tinyint  declare @Workflow_Step_Name_old char(51), @WorkflowStepInstanceID_old char(37)  declare @WfBusObjKey varchar(201)  select @Workflow_Step_Name_old='', @WorkflowStepInstanceID_old=''    select @WorkflowStepInstanceID=UPPER(@WorkflowStepInstanceID)  select @Workflow_User=UPPER(@Workflow_User)   select @SystemDB = (select top 1 DBNAME from SY00100)  select @server_name=@@SERVERNAME   select @CMPANYID=DB_NAME()  select TOP 1 @WorkflowInstanceID=WorkflowInstanceID, @Workflow_Step_Name=Workflow_Step_Name,  @Workflow_Name=Workflow_Name,@Workflow_Version=Workflow_Version,  @DueDate=Workflow_Due_Date, @DueTime=Workflow_Due_Time,  @WF_Step_Completion_Polic=WF_Step_Completion_Polic   from WFI10004 with (nolock, index=AK2WFI10004)   where WorkflowStepInstanceID=@WorkflowStepInstanceID    select @met_completion_policy=0, @alt_final_approver_step=0, @write_history_record=0   update WFI10004 set Workflow_Action_Date=cast(SYSDATETIME() as date),  Workflow_Action_Time=cast(SYSDATETIME() as time)  where WorkflowInstanceID=@WorkflowInstanceID and WorkflowStepInstanceID=@WorkflowStepInstanceID  and UPPER(WorkflowTaskAssignedTo)=@Workflow_User   select top 1 @WF_Action=Workflow_Action,   @Workflow_History_User=Workflow_History_User from WF30100 where WorkflowStepInstanceID=@WorkflowStepInstanceID  order by Workflow_Completion_Date desc, Workflow_Completion_Time desc, Milliseconds desc   select @WF_Action=isnull(@WF_Action,0), @Workflow_History_User=isnull(@Workflow_History_User,'')   select top 1 @Workflow_Managers=UPPER(Workflow_Managers),  @Workflow_Type_Name=Workflow_Type_Name from WF100001 where Workflow_Type_Name in  (select Workflow_Type_Name from WF100002 where Workflow_Name in  (select Workflow_Name from WFI10003 where WorkflowStepInstanceID=@WorkflowStepInstanceID))   delete from WFI10005 where Workflow_User=@Workflow_User  exec DYNAMICS.dbo.GetAssignedUsers  @Workflow_User,   @Workflow_Managers,  @Workflow_Type_Name,  @Workflow_Name,  @Workflow_Version,  @WorkflowInstanceID,  @Workflow_Step_Name,  @WorkflowStepInstanceID,  @server_name,  @CMPANYID,  @SystemDB  delete from WFI10005 where UPPER(Workflow_User)=@Workflow_User   and UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID and UsersListGuid=''   if (select COUNT(UsersListGuid) from WFI10005   where Workflow_User=@Workflow_User and WorkflowStepInstanceID=@WorkflowStepInstanceID and UsersListGuid=@Workflow_Managers and UPPER(WorkflowTaskAssignedTo)=@Workflow_User)>0  begin  select @met_completion_policy=1  end  delete from WFI10005 where Workflow_User=@Workflow_User   if @met_completion_policy=0    begin  if @WF_Step_Completion_Polic=0   begin  select @met_completion_policy=1  end   if @WF_Step_Completion_Polic=1   begin  select @number_of_assignees=COUNT(*) from WFI10004   where WorkflowInstanceID=@WorkflowInstanceID and WorkflowStepInstanceID=@WorkflowStepInstanceID  select @number_of_approvers=COUNT(*) from WFI10004  where WorkflowInstanceID=@WorkflowInstanceID and WorkflowStepInstanceID=@WorkflowStepInstanceID   and Workflow_Action_Date<>''  if ((@number_of_approvers)/@number_of_assignees) > 0.50  begin  select @met_completion_policy=1  end   end  if @WF_Step_Completion_Polic=2   begin  select @number_of_assignees=COUNT(*) from WFI10004   where WorkflowInstanceID=@WorkflowInstanceID and WorkflowStepInstanceID=@WorkflowStepInstanceID  select @number_of_approvers=COUNT(*) from WFI10004  where WorkflowInstanceID=@WorkflowInstanceID and WorkflowStepInstanceID=@WorkflowStepInstanceID   and Workflow_Action_Date<>''  if ((@number_of_approvers)/@number_of_assignees) = 1.00  begin  select @met_completion_policy=1  end   end  end   if @met_completion_policy=1   begin    update WFI10003 set Workflow_Step_Status=4  where WorkflowStepInstanceID=@WorkflowStepInstanceID  if @Workflow_Step_Name='Alternate Final Approval'  begin  select @alt_final_approver_step=1  end   delete from WFI10004 where WorkflowStepInstanceID=@WorkflowStepInstanceID and Workflow_Action_Date=''   select @tasks_created=0  if (select COUNT(*) from WF100003 where Workflow_Name=@Workflow_Name   and Workflow_Version=@Workflow_Version and WF_Step_Predecessor=@Workflow_Step_Name)>0  begin   select @bypass_conditions=0 , @escalation=0   exec wfProcessChildrenOfStep @Workflow_User, @WorkflowStepInstanceID, @bypass_conditions, @escalation,@TempFilePath,@tasks_created OUTPUT, @approval_tasks_created OUTPUT   end    if @tasks_created=0   begin  if (select COUNT(*) from WFI10003 where WorkflowInstanceID=@WorkflowInstanceID   and Workflow_Step_Status=2)=0  begin   select @Workflow_Require_One_App=Workflow_Require_One_App,  @WF_Use_Alt_Final_Approv=WF_Use_Alt_Final_Approv,  @WF_Alt_FinalApprover=WF_Alt_FinalApprover from WFI10002   where WorkflowInstanceID=@WorkflowInstanceID   if @WF_Action=9 and upper(rtrim(@Workflow_History_User))=upper(rtrim(@Workflow_User))  begin  select @ChangedDocument=1  end   if @Workflow_Require_One_App>0 and @ChangedDocument>0 and @alt_final_approver_step=0  begin   select @Workflow_Step_Name_old=@Workflow_Step_Name, @WorkflowStepInstanceID_old=@WorkflowStepInstanceID  select @Workflow_Step_Name='Alternate Final Approval'   select @WorkflowStepInstanceID=convert(char(37),newid())  insert into WFI10003  select @WorkflowStepInstanceID,@Workflow_Step_Name,@WorkflowInstanceID,Workflow_Name,Workflow_Version,  @Workflow_Step_Name,2,0,1,0,  0,'','',  @WF_Alt_FinalApprover,'',0,8,  1,0,1,  0,SYSDATETIME() from WF100002   where Workflow_Name=@Workflow_Name and Workflow_Version=@Workflow_Version   select @calculate_due_date=0,@escalate=0  select @WFIncludeDocumentAttach = WFIncludeDocumentAttach from WF100003  where Workflow_Name = @Workflow_Name and Workflow_Step_Name = @Workflow_Step_Name  if @WFIncludeDocumentAttach = 1   begin  select @WfBusObjKey = WF2.WfBusObjKey from WFI10002 WF2 inner join WFI10003 WFI3   on WF2.WorkflowInstanceID = WFI3.WorkflowInstanceID   where WFI3.WorkflowStepInstanceID = @WorkflowStepInstanceID  exec wfDocAttach @Workflow_Type_Name, @WfBusObjKey, @WorkflowStepInstanceID  end    if @WF_Alt_FinalApprover=''   begin  select @assignment_status=1  end  else  begin  exec wfAssignTasks @WorkflowStepInstanceID, @WF_Alt_FinalApprover, @Workflow_User, @calculate_due_date, @escalate, @TempFilePath,  @assignment_status OUTPUT, @approval_tasks_created OUTPUT  if @assignment_status=0  begin   if @WFIncludeDocumentAttach=1  begin  insert into CO00104 select BusObjKey,Attachment_ID,'Workflow Message',CONVERT (date, SYSDATETIME()),  CONVERT (time, SYSDATETIME()),CRUSRID from CO00102 where WorkflowStepInstanceID = @WorkflowStepInstanceID  end   end   end   if @assignment_status>0   begin   update WFI10003 set Workflow_Step_Assign_To=@Workflow_Managers   where WorkflowStepInstanceID=@WorkflowStepInstanceID  exec wfAssignTasks @WorkflowStepInstanceID, @Workflow_Managers, @Workflow_User, @calculate_due_date, @escalate, @TempFilePath,  @assignment_status OUTPUT, @approval_tasks_created OUTPUT   if @assignment_status=0  begin   if @WFIncludeDocumentAttach=1  begin  insert into CO00104 select BusObjKey,Attachment_ID,'Workflow Message',CONVERT (date, SYSDATETIME()),  CONVERT (time, SYSDATETIME()),CRUSRID from CO00102 where WorkflowStepInstanceID = @WorkflowStepInstanceID  end   end   if @assignment_status>0  begin   if @Workflow_Step_Name='Alternate Final Approval'  begin  select @workflow_action=10  end  else  begin  if @Workflow_Task_Complete>0   select @workflow_action=4  else  select @workflow_action=3  end   select @Workflow_Completion_Date=cast(SYSDATETIME() as date),@Workflow_Completion_Time=cast(SYSDATETIME() as time)  select @Workflow_Step_Assign_To = Workflow_Step_Assign_To from WFI10003 where WorkflowStepInstanceID=@WorkflowStepInstanceID  exec wfCreateHistoryRecord @WorkflowInstanceID,  @WorkflowStepInstanceID,  @Workflow_User,  @Workflow_Name,  @Workflow_Step_Name,  @Workflow_Step_Assign_To,  @workflow_action,  @DueDate,  @DueTime,  @Workflow_Completion_Date,  @Workflow_Completion_Time,  @Workflow_Comments,  @Workflow_Error OUTPUT   select @Workflow_User='System'  select @Workflow_Comments='The task assignment was automatically rejected by the system.'  exec wfReject @WorkflowStepInstanceID,@Workflow_User,1,@Workflow_Comments,@Workflow_Error OUTPUT  end  end   if @assignment_status=0   begin  select @write_history_record=1  update WFI10002 set Workflow_Status=4  where WorkflowInstanceID=@WorkflowInstanceID  exec wfUpdateDocument @WorkflowInstanceID,1,4 ,'','',@Workflow_Error OUTPUT  select @tasks_created=1  end  end  else   begin  select @workflow_action=10   select @Workflow_Completion_Date=cast(SYSDATETIME() as date),@Workflow_Completion_Time=cast(SYSDATETIME() as time)   select @Workflow_Step_Assign_To = Workflow_Step_Assign_To from WFI10003 where WorkflowStepInstanceID=@WorkflowStepInstanceID  exec wfCreateHistoryRecord @WorkflowInstanceID,  @WorkflowStepInstanceID,  @Workflow_User,  @Workflow_Name,  @Workflow_Step_Name,  @Workflow_Step_Assign_To,  @workflow_action,  @DueDate,  @DueTime,  @Workflow_Completion_Date,  @Workflow_Completion_Time,  @Workflow_Comments,  @Workflow_Error OUTPUT   update WFI10002 set Workflow_Status=6 where WorkflowInstanceID=@WorkflowInstanceID  exec wfUpdateDocument @WorkflowInstanceID,1,6,'','',@Workflow_Error OUTPUT  end  end  else  begin  select @write_history_record=1  end  end   else  begin  select @write_history_record=1  end  end  else   begin  select @write_history_record=1  end   if @write_history_record=1  begin  if @Workflow_Step_Name_old<>''  begin   if @Workflow_Step_Name_old='Alternate Final Approval'  begin  select @workflow_action=10  end  else  begin  if @Workflow_Task_Complete>0   select @workflow_action=4  else  select @workflow_action=3  end  end  else  begin  if @Workflow_Step_Name='Alternate Final Approval'  begin  select @workflow_action=10  end  else  begin  if @Workflow_Task_Complete>0   select @workflow_action=4  else  select @workflow_action=3  end  end   select @Workflow_Completion_Date=cast(SYSDATETIME() as date),@Workflow_Completion_Time=cast(SYSDATETIME() as time)  select @Workflow_Step_Assign_To = Workflow_Step_Assign_To from WFI10003 where WorkflowStepInstanceID=@WorkflowStepInstanceID   if @Workflow_Step_Name_old<>''  exec wfCreateHistoryRecord @WorkflowInstanceID,  @WorkflowStepInstanceID_old,  @Workflow_User,  @Workflow_Name,  @Workflow_Step_Name_old,  @Workflow_Step_Assign_To,  @workflow_action,  @DueDate,  @DueTime,  @Workflow_Completion_Date,  @Workflow_Completion_Time,  @Workflow_Comments,  @Workflow_Error OUTPUT  else  exec wfCreateHistoryRecord @WorkflowInstanceID,  @WorkflowStepInstanceID,  @Workflow_User,  @Workflow_Name,  @Workflow_Step_Name,  @Workflow_Step_Assign_To,  @workflow_action,  @DueDate,  @DueTime,  @Workflow_Completion_Date,  @Workflow_Completion_Time,  @Workflow_Comments,  @Workflow_Error OUTPUT  end END   
GO
GRANT EXECUTE ON  [dbo].[wfApprove] TO [DYNGRP]
GO
