SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[glpmcVerifyCurrency]  @I_sCompanyID           smallint        = NULL,  @I_cCurrencyID          char(15)        = NULL,  @I_dExchangeDate        datetime        = NULL,  @I_mExchangeRate        numeric(15,7)   = NULL,  @I_cExchangeTableID     char(15)        = NULL,  @I_dExchangeTime        datetime        = NULL,  @I_tBatchPosting tinyint  = NULL,  @I_tFunctional          tinyint  = NULL,  @I_tPosting             tinyint  = NULL,  @I_tClearingTransaction tinyint  = NULL,  @I_cRateTypeID          char(15)        = NULL,  @I_dTransactionDate     datetime        = NULL,  @I_sMCTrxState smallint = NULL,  @IO_bMessages2     binary(4)       = NULL  output,  @O_sCurrencyIndex       smallint        = NULL  output,  @O_sDecimalPlaces       smallint        = NULL  output,  @O_iErrorState          int             = NULL  output as  declare  @TRUE tinyint,  @FALSE tinyint,  @DEFAULT_DATE datetime,  @MS_ITEM_1 int,  @MS_ITEM_2 int,  @MS_ITEM_3 int,  @MS_ITEM_4 int,  @MS_ITEM_5 int,  @MS_ITEM_6 int,  @MS_ITEM_7 int,  @MS_ITEM_8 int,  @MS_ITEM_9 int,  @MS_ITEM_10 int,  @MS_ITEM_12 int,  @MS_ITEM_13 int,  @MS_ITEM_14 int,  @MS_ITEM_15 int,  @dExpirationDate datetime,  @tInactive tinyint,  @tTransaction tinyint,  @tLoop tinyint,  @mExchangeRate         numeric(15,7),  @sMC_NONDENOM_TO_DENOM smallint,   @sMC_DENOM_TO_NONDENOM smallint,   @sMC_DENOM_TO_DENOM smallint,  @sMC_DENOM_TO_EURO smallint,  @sMC_EURO_TO_DENOM smallint,  @tEuroEnabled tinyint,  @cCurrencyID char(15),  @cEuroCurrencyID char(15),  @dMinDate datetime,  @iStatus int  select   @O_sCurrencyIndex = 0,  @O_sDecimalPlaces = 0,  @O_iErrorState = 0  exec @iStatus = smGetMinDate @dMinDate output  if @@trancount = 0 begin  select @tTransaction = 1  begin transaction end   while (@tLoop is NULL) begin  select @tLoop = 1   if   @I_sCompanyID           is NULL or  @I_cCurrencyID          is NULL or  @I_dExchangeDate        is NULL or  @I_mExchangeRate        is NULL or  @I_cExchangeTableID     is NULL or  @I_dExchangeTime        is NULL or  @I_tBatchPosting is NULL or  @I_tFunctional          is NULL or  @I_tPosting             is NULL or  @I_tClearingTransaction is NULL or  @I_cRateTypeID          is NULL or  @I_dTransactionDate     is NULL or  @I_sMCTrxState is NULL or  @IO_bMessages2     is NULL  begin  select @O_iErrorState = 20772  break  end    select  @TRUE           = 1,  @FALSE          = 0,  @DEFAULT_DATE = @dMinDate,  @MS_ITEM_1      = power(2,24),  @MS_ITEM_2      = power(2,25),  @MS_ITEM_3      = power(2,26),  @MS_ITEM_4      = power(2,27),  @MS_ITEM_5      = power(2,28),  @MS_ITEM_6      = power(2,29),  @MS_ITEM_7      = power(2,30),  @MS_ITEM_8      = convert(int, 0x80000000),  @MS_ITEM_9      = power(2,16),  @MS_ITEM_10     = power(2,17),  @MS_ITEM_12 = power(2,19),  @MS_ITEM_13  = power(2,20),  @MS_ITEM_14 = power(2,21),  @MS_ITEM_15 = power(2,22),  @sMC_NONDENOM_TO_DENOM = 3,  @sMC_DENOM_TO_NONDENOM = 4,  @sMC_DENOM_TO_DENOM = 5,  @sMC_DENOM_TO_EURO = 6,  @sMC_EURO_TO_DENOM = 7   if exists(select 1 from MC60400 where ENABLED = @TRUE)  select @tEuroEnabled = @TRUE  else  select @tEuroEnabled = @FALSE   select @cEuroCurrencyID =   isnull(Euro_Currency_ID,'') from DYNAMICS..MC40400   if @I_tBatchPosting = @TRUE  begin  if not exists(  select   1  from  MC40000 )  begin   select @IO_bMessages2 = (@IO_bMessages2 | @MS_ITEM_12)  if @I_tPosting = @TRUE  begin   select @O_iErrorState = 20822  break  end   end  end    select  @O_sCurrencyIndex = CURRNIDX,  @O_sDecimalPlaces = DECPLCUR  from  DYNAMICS..MC40200  where  CURNCYID = @I_cCurrencyID   if @@rowcount <> 1  begin  if @I_tBatchPosting = @TRUE  select @IO_bMessages2 = (@IO_bMessages2 | @MS_ITEM_13)  else if @I_tClearingTransaction = @TRUE  select @IO_bMessages2 = (@IO_bMessages2 | @MS_ITEM_6)  else  select @IO_bMessages2 = (@IO_bMessages2 | @MS_ITEM_1)   if @I_tPosting = @TRUE  begin  select @O_iErrorState = 20773  break  end  end   else  begin  select   @tInactive = INACTIVE  from  DYNAMICS..MC60100  where  CURNCYID = @I_cCurrencyID  and     CMPANYID = @I_sCompanyID   if @@rowcount <> 1  begin  if @I_tBatchPosting = @TRUE  select @IO_bMessages2 = (@IO_bMessages2 | @MS_ITEM_14)  else if @I_tClearingTransaction = @TRUE  select @IO_bMessages2 = (@IO_bMessages2 | @MS_ITEM_7)  else  select @IO_bMessages2 = (@IO_bMessages2 | @MS_ITEM_2)   if @I_tPosting = @TRUE  begin  select @O_iErrorState = 20774  break  end  end    else  begin  if (@I_sMCTrxState = @sMC_NONDENOM_TO_DENOM)   or (@I_sMCTrxState = @sMC_DENOM_TO_NONDENOM)   or (@I_sMCTrxState = @sMC_DENOM_TO_DENOM)   begin   if @tEuroEnabled = @TRUE  begin  if exists(select 1 from DYNAMICS.dbo.MC60100   where CMPANYID =  @I_sCompanyID  and INACTIVE = @TRUE  and  CURNCYID = @cEuroCurrencyID)  begin  select @IO_bMessages2 = (@IO_bMessages2 | @MS_ITEM_12)   if @I_tPosting = @TRUE  begin  select @O_iErrorState = 21049  break  end  end   end    end    end     if @tInactive = @TRUE and @I_tClearingTransaction = @FALSE  begin  if @I_tBatchPosting = @TRUE  select @IO_bMessages2 = (@IO_bMessages2 | @MS_ITEM_15)  else  select @IO_bMessages2 = (@IO_bMessages2 | @MS_ITEM_3)   if @I_tPosting = @TRUE  begin  select @O_iErrorState = 20775  break  end  end   end    if @I_tFunctional = @TRUE or @I_tClearingTransaction = @TRUE  break   if (@I_sMCTrxState = @sMC_DENOM_TO_DENOM)   or (@I_sMCTrxState = @sMC_DENOM_TO_EURO)   or (@I_sMCTrxState = @sMC_EURO_TO_DENOM)   break  else  begin  if @I_sMCTrxState = @sMC_DENOM_TO_NONDENOM   select @cCurrencyID = @cEuroCurrencyID   else  select @cCurrencyID = @I_cCurrencyID  end   if not exists (select  1  from  MC40100  where  RATETPID = @I_cRateTypeID)  begin  select @IO_bMessages2 = (@IO_bMessages2 | @MS_ITEM_4)   if @I_tPosting = @TRUE  begin  select @O_iErrorState = 20776  break  end  end   else  begin  if not exists (select  1  from  MC40301  where  CURNCYID = @cCurrencyID  and     RATETPID = @I_cRateTypeID)  begin  select @IO_bMessages2 = (@IO_bMessages2 | @MS_ITEM_5)   if @I_tPosting = @TRUE  begin  select @O_iErrorState = 20777  break  end  end   end    if not exists (select   1  from  DYNAMICS..MC40300  where  EXGTBLID = @I_cExchangeTableID)  begin  select @IO_bMessages2 = (@IO_bMessages2 | @MS_ITEM_6)   if @I_tPosting = @TRUE  begin  select @O_iErrorState = 20778  break  end  end   else  begin  select   @tInactive = INACTIVE  from  DYNAMICS..MC60200  where  EXGTBLID = @I_cExchangeTableID  and     CMPANYID = @I_sCompanyID   if @@rowcount <> 1  begin  select @IO_bMessages2 = (@IO_bMessages2 | @MS_ITEM_7)   if @I_tPosting = @TRUE  begin  select @O_iErrorState = 20779  break  end  end    else if @tInactive = @TRUE  begin  select @IO_bMessages2 = (@IO_bMessages2 | @MS_ITEM_8)   if @I_tPosting = @TRUE  begin  select @O_iErrorState = 20780  break  end  end   end   end   if @O_iErrorState <> 0 begin  if @tTransaction = 1  rollback transaction end else if @tTransaction = 1  commit transaction   return    
GO
GRANT EXECUTE ON  [dbo].[glpmcVerifyCurrency] TO [DYNGRP]
GO
