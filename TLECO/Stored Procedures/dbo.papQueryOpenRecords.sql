SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[papQueryOpenRecords]   @I_sUserID varchar(15),  @I_sCustomer varchar(15),  @I_sCorpCustomer varchar(15),  @I_sVendor varchar(15),  @I_dtDate datetime = NULL,   @O_iError integer output as  declare   @siBALNCTYP smallint,  @cyDebitTotal numeric(19,5),  @cyCreditTotal numeric(19,5),  @cyCurrentAmt numeric(19,5)  begin  delete PA50105 where USERID = @I_sUserID   select @siBALNCTYP = (select BALNCTYP from RM00101 where CUSTNMBR=@I_sCustomer)   if @I_sCorpCustomer <> @I_sCustomer   begin  if @siBALNCTYP = 0   insert into PA50105 select  @I_sUserID, rm.RMDTYPAL, rm.DOCNUMBR, '', 2, rm.DOCDATE, rm.DUEDATE, rm.CUSTNMBR, rm.CURTRXAM, isnull(mc.ORCTRXAM,0), rm.CURNCYID, rm.VOIDSTTS, 0.00000, 0.00000, 0.00000, 0.00000, 0.00000, 0.00000, '', 0.00000, 0.00000   from  RM20101 rm left outer join MC020102 mc on rm.DOCNUMBR = mc.DOCNUMBR and rm.RMDTYPAL = mc.RMDTYPAL  where rm.CUSTNMBR = @I_sCustomer and   CURTRXAM <> 0.00000  else  begin   select  @cyDebitTotal = isnull(sum(CURTRXAM),0.0)  from  RM20101 with (NOLOCK)   where  CUSTNMBR = @I_sCustomer   and  VOIDSTTS = 0   and  RMDTYPAL <=5    select  @cyCreditTotal = isnull(sum(CURTRXAM),0.0)   from  RM20101 with (NOLOCK)   where  CUSTNMBR  = @I_sCustomer   and  VOIDSTTS = 0   and  RMDTYPAL  >=7    select @cyCurrentAmt = isnull(@cyDebitTotal - @cyCreditTotal,0.0)    if @cyCurrentAmt > 0.00000  insert into PA50105 select  @I_sUserID, 1, 'BALFORWARD', '', 2, @I_dtDate, @I_dtDate, @I_sCustomer, @cyCurrentAmt, 0.00000, '', 0, 0.00000, 0.00000, 0.00000, 0.00000, 0.00000, 0.00000, '', 0.00000, 0.00000   else if @cyCurrentAmt < 0.00000  insert into PA50105 select  @I_sUserID, 7, 'BALFORWARD', '', 2, @I_dtDate, @I_dtDate, @I_sCustomer, (@cyCurrentAmt * -1), 0.00000, '', 0, 0.00000, 0.00000, 0.00000, 0.00000, 0.00000, 0.00000, '', 0.00000, 0.00000    end  end  else   insert into PA50105 select  @I_sUserID, rm.RMDTYPAL, rm.DOCNUMBR, '', 2,rm.DOCDATE, rm.DUEDATE, rm.CUSTNMBR, rm.CURTRXAM, isnull(mc.ORCTRXAM,0), rm.CURNCYID, rm.VOIDSTTS, 0.00000, 0.00000, 0.00000, 0.00000, 0.00000, 0.00000, '', 0.00000, 0.00000   from  RM20101 rm left outer join MC020102 mc on rm.DOCNUMBR = mc.DOCNUMBR and rm.RMDTYPAL = mc.RMDTYPAL  where rm.CPRCSTNM = @I_sCorpCustomer and  CURTRXAM <> 0.00000   insert into PA50105 select   @I_sUserID, pm.DOCTYPE, pm.DOCNUMBR, pm.VCHRNMBR, 1, pm.DOCDATE, pm.DUEDATE, pm.VENDORID, pm.CURTRXAM, isnull(mc.ORCTRXAM,0), pm.CURNCYID, 0, 0.00000, 0.00000, 0.00000, 0.00000, 0.00000, 0.00000, '', 0.00000, 0.00000   from PM20000 pm left outer join MC020103 mc on pm.DOCTYPE = mc.DOCTYPE and pm.VCHRNMBR = mc.VCHRNMBR  where pm.VENDORID = @I_sVendor and  CURTRXAM <> 0.00000   delete PA50105 where DOCTYPE=9 and MODULEID=2 and CURTRXAM<0  end   
GO
GRANT EXECUTE ON  [dbo].[papQueryOpenRecords] TO [DYNGRP]
GO
