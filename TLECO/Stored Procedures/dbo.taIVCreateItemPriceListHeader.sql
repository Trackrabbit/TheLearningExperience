SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[taIVCreateItemPriceListHeader] @I_vITEMNMBR char(30),     @I_vPRICMTHD smallint = null,    @I_vPriceGroup char(10) = null,   @I_vUOFM char(8) = null,   @I_vPRCLEVEL char(10) = null,   @I_vCURNCYID char(15) = '',   @I_vUpdateIfExists smallint = 1,   @I_vRequesterTrx smallint = 0,   @I_vUSRDEFND1 char(50) = '',       @I_vUSRDEFND2 char(50) = '',       @I_vUSRDEFND3 char(50) = '',       @I_vUSRDEFND4 varchar(8000) = '',  @I_vUSRDEFND5 varchar(8000) = '',  @O_iErrorState int output, @oErrString varchar(255) output  with encryption as  set transaction isolation level read uncommitted set nocount on  declare  @UOMSCHDL char(10),    @BASEUOFM char(8),    @QTYBSUOM numeric(19,5),   @FUNLCURR char(15),    @DECPLQTY smallint,    @iStatus int,  @iCustomState int,  @iCustomErrString varchar(255),  @O_oErrorState int,  @iError int,     @PRICMTHD smallint  select  @UOMSCHDL = '',     @BASEUOFM = '',     @QTYBSUOM = 1,     @FUNLCURR = '',     @DECPLQTY = 0 ,     @iStatus = 0,  @iCustomState = 0,  @iCustomErrString = '',  @O_oErrorState = 0,  @O_iErrorState = 0,    @PRICMTHD = 0  if (@oErrString is NULL) begin  select @oErrString = '' end  exec @iStatus = taIVCreateItemPriceListHeaderPre  @I_vITEMNMBR output,  @I_vPRICMTHD output,  @I_vPriceGroup output,  @I_vUOFM output,  @I_vPRCLEVEL output,  @I_vCURNCYID output,  @I_vUpdateIfExists output,  @I_vRequesterTrx output,  @I_vUSRDEFND1 output,  @I_vUSRDEFND2 output,  @I_vUSRDEFND3 output,  @I_vUSRDEFND4 output,  @I_vUSRDEFND5 output,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if ((@iStatus <> 0) or (@iCustomState <> 0) or (@iError <> 0)) begin  select @oErrString = rtrim(@oErrString) + ' ' + @iCustomErrString  select @O_iErrorState = 7085    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if (  @I_vITEMNMBR is NULL or  @I_vUpdateIfExists is NULL or  @I_vRequesterTrx is NULL or  @I_vUSRDEFND1 is NULL or  @I_vUSRDEFND2 is NULL or  @I_vUSRDEFND3 is NULL or  @I_vUSRDEFND4 is NULL or  @I_vUSRDEFND5 is NULL) begin  select @O_iErrorState = 7086    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  select  @I_vITEMNMBR = UPPER(@I_vITEMNMBR),  @I_vPriceGroup = UPPER(@I_vPriceGroup),  @I_vPRCLEVEL = UPPER(@I_vPRCLEVEL),  @I_vCURNCYID = UPPER(@I_vCURNCYID)  if exists(select 1 from IV00105 (nolock) where CURNCYID <> '') begin  select @FUNLCURR = FUNLCURR from MC40000 (nolock)   if (@I_vCURNCYID = '')  begin  select @O_iErrorState = 7096     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end else begin  select @I_vCURNCYID = '' end  select  @UOMSCHDL = UOMSCHDL,  @DECPLQTY = DECPLQTY,  @PRICMTHD = PRICMTHD  from IV00101 (nolock) where ITEMNMBR = @I_vITEMNMBR  select @BASEUOFM = BASEUOFM from IV40201 (nolock) where UOMSCHDL = @UOMSCHDL  if (@I_vPRICMTHD is null) begin  select @I_vPRICMTHD = @PRICMTHD   if (@I_vPRICMTHD is null)  begin  select @I_vPRICMTHD = 1  end end  if ((@PRICMTHD <> @I_vPRICMTHD) and (@PRICMTHD <> 0)) begin  select @O_iErrorState = 8078     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vITEMNMBR = '') begin  select @O_iErrorState = 7087     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vITEMNMBR <> '') begin  if not exists(select 1 from IV00101 (nolock) where ITEMNMBR = @I_vITEMNMBR)  begin  select @O_iErrorState = 7088     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vPRICMTHD < 1 or @I_vPRICMTHD > 6) begin  select @O_iErrorState = 7089     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vPRICMTHD = 1) begin  if (exists(select top 1 ITEMNMBR from IV00107 (nolock) where ITEMNMBR = @I_vITEMNMBR and RNDGAMNT > 0))  begin  select @O_iErrorState = 7115     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end   if (exists(select top 1 ITEMNMBR from IV00107 (nolock) where ITEMNMBR = @I_vITEMNMBR and ROUNDTO <> 1))  begin  select @O_iErrorState = 7116     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vPRICMTHD = 2) begin  if (exists(select top 1 ITEMNMBR from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and UOMPRICE < 0))  begin   select @O_iErrorState = 7066     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end   if (exists(select top 1 ITEMNMBR from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and UOMPRICE > 999.99))  begin   select @O_iErrorState = 7108     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vPRICMTHD = 3) begin  if (exists(select top 1 ITEMNMBR from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and UOMPRICE < 0))  begin   select @O_iErrorState = 7067     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end   if (exists(select top 1 ITEMNMBR from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and UOMPRICE > 999.99))  begin   select @O_iErrorState = 7109     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vPRICMTHD = 4) begin  if (exists(select top 1 ITEMNMBR from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and UOMPRICE < 0))  begin   select @O_iErrorState = 7068     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end   if (exists(select top 1 ITEMNMBR from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and UOMPRICE > 999.99))  begin   select @O_iErrorState = 7110     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vPRICMTHD = 5) begin  if (exists(select top 1 ITEMNMBR from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and UOMPRICE < 0))  begin   select @O_iErrorState = 7069     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end   if (exists(select top 1 ITEMNMBR from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and UOMPRICE >= 100))  begin   select @O_iErrorState = 7071     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vPRICMTHD = 5) begin  if (exists(select top 1 ITEMNMBR from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and UOMPRICE < 0))  begin   select @O_iErrorState = 7070     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end   if (exists(select top 1 ITEMNMBR from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and UOMPRICE >= 100))  begin   select @O_iErrorState = 7072     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vPRICMTHD > 2 and @I_vPRICMTHD < 7) and (@FUNLCURR <> @I_vCURNCYID)  begin  select @O_iErrorState = 7090      exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vPriceGroup is null)  begin   select @I_vPriceGroup = PriceGroup from IV00101 (nolock) where ITEMNMBR = @I_vITEMNMBR end  if (@I_vPriceGroup <> '')  begin   if not exists(select 1 from IV40900 (nolock) where PriceGroup = @I_vPriceGroup)  begin  select @O_iErrorState = 7091     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vUOFM is null)  begin   select @I_vUOFM = SELNGUOM from IV00101 (nolock) where ITEMNMBR = @I_vITEMNMBR end  if (@I_vUOFM <> '') begin   if not exists(select 1 from IV40202 (nolock) where UOFM = @I_vUOFM and UOMSCHDL = @UOMSCHDL)  begin  select @O_iErrorState = 7093    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vPRCLEVEL is null)  begin   select @I_vPRCLEVEL = PRCLEVEL from IV00101 (nolock) where ITEMNMBR = @I_vITEMNMBR end  if (@I_vPRCLEVEL <> '')  begin   if not exists(select 1 from IV40800 (nolock) where PRCLEVEL = @I_vPRCLEVEL)  begin  select @O_iErrorState = 7095     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vPRCLEVEL <> '') begin  if (not exists (select 1 from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and CURNCYID = @I_vCURNCYID and PRCLEVEL = @I_vPRCLEVEL))  begin  select @O_iErrorState = 7097     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vUOFM <> '') begin  if (not exists (select 1 from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and CURNCYID = @I_vCURNCYID and UOFM = @I_vUOFM))  begin  select @O_iErrorState = 8076     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@DECPLQTY = 1) begin  if (not exists (select 1 from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and TOQTY = 999999999999.00000 group by ITEMNMBR, CURNCYID, PRCLEVEL, UOFM))  begin  select @O_iErrorState = 7098     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  end  if (@DECPLQTY = 2) begin  if (not exists (select 1 from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and TOQTY = 999999999999.90000 group by ITEMNMBR, CURNCYID, PRCLEVEL, UOFM))  begin  select @O_iErrorState = 7102     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  end   if (@DECPLQTY = 3) begin  if (not exists (select 1 from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and TOQTY = 999999999999.99000 group by ITEMNMBR, CURNCYID, PRCLEVEL, UOFM))  begin  select @O_iErrorState = 7103     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  end  if (@DECPLQTY = 4) begin  if (not exists (select 1 from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and TOQTY = 999999999999.99900 group by ITEMNMBR, CURNCYID, PRCLEVEL, UOFM))  begin  select @O_iErrorState = 7104     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  end  if (@DECPLQTY = 5) begin  if (not exists (select 1 from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and TOQTY = 999999999999.99990 group by ITEMNMBR, CURNCYID, PRCLEVEL, UOFM))  begin  select @O_iErrorState = 7105     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  end  if (@DECPLQTY = 6) begin  if (not exists (select 1 from IV00108 (nolock) where ITEMNMBR = @I_vITEMNMBR and TOQTY = 999999999999.99999 group by ITEMNMBR, CURNCYID, PRCLEVEL, UOFM))  begin  select @O_iErrorState = 7106     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  end  select @QTYBSUOM = QTYBSUOM from IV40202 (nolock) where UOMSCHDL = @UOMSCHDL and UOFM = @I_vUOFM and EQUIVUOM = @BASEUOFM  if (@I_vUpdateIfExists < 0 or @I_vUpdateIfExists > 1) begin  select @O_iErrorState = 5531     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vRequesterTrx < 0 or @I_vRequesterTrx > 1) begin  select @O_iErrorState = 7099     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  update IV00101 set  PRICMTHD = @I_vPRICMTHD,  PRCLEVEL = @I_vPRCLEVEL,  PriceGroup = @I_vPriceGroup,  SELNGUOM = @I_vUOFM  where ITEMNMBR = @I_vITEMNMBR if @@error <> 0 begin  select @O_iErrorState = 7120    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if (@O_iErrorState <> 0) begin  return (@O_iErrorState) end  exec @iStatus = taIVCreateItemPriceListHeaderPost  @I_vITEMNMBR,  @I_vPRICMTHD,  @I_vPriceGroup,  @I_vUOFM,  @I_vPRCLEVEL,  @I_vCURNCYID,  @I_vUpdateIfExists,  @I_vRequesterTrx,  @I_vUSRDEFND1,  @I_vUSRDEFND2,  @I_vUSRDEFND3,  @I_vUSRDEFND4,  @I_vUSRDEFND5,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if ((@iStatus <> 0) or (@iCustomState <> 0) or (@iError <> 0)) begin  select @oErrString = rtrim(@oErrString) + ' ' + @iCustomErrString  select @O_iErrorState = 6644    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  return (@O_iErrorState)   
GO
GRANT EXECUTE ON  [dbo].[taIVCreateItemPriceListHeader] TO [DYNGRP]
GO
