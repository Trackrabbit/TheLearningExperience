SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE                                 procedure [dbo].[aagUpdateGLBusinessEntryOpt]  @aaGLWorkHdrID  int,  @JRNENTRY int,  @aaGLWorkDistID int output,  @CURNCYID char(15),   @CURRNIDX smallint,  @RATETPID char(15),  @EXGTBLID char(15),  @XCHGRATE numeric(19,7),  @EXCHDATE datetime,  @TIME1 datetime ,   @RTCLCMTD smallint,  @DENXRATE numeric(19,7),  @MCTRXSTT smallint,  @DECPLACS   smallint,   @CompanyID int,  @SqlSessionID int,  @BalAmt numeric(19,5),  @INTERID char(5),  @Post int,  @OFFINDX int  as begin   declare @SQNCLINE numeric(19,5),   @ACTINDX int,  @ACCTTYPE smallint,  @FXDORVAR smallint,   @CRDTAMNT numeric(19,5),   @DEBITAMT numeric(19,5),   @ORCRDAMT numeric(19,5),  @ORDBTAMT numeric(19,5),   @CorrespondingUnit char(5),   @aaBrowseType smallint,  @ClassID int,  @aaGLWorkAssignID int,  @Cnt int,  @TRXAMNT numeric(19,5),   @Flag smallint   Select  @SQNCLINE  = 0,  @ACTINDX  = 0,  @ACCTTYPE  = 0,  @FXDORVAR  = 0,   @CRDTAMNT  =0,   @DEBITAMT  =0,   @ORCRDAMT  =0,  @ORDBTAMT  =0,  @aaBrowseType =0,  @ClassID  =0,  @aaGLWorkAssignID  =0,  @Cnt     =0,  @TRXAMNT  =0,  @Flag   =0   declare CAADIST  cursor fast_forward  for  Select SQNCLINE, aaGLWorkDistID, ACTINDX ,DEBITAMT, CRDTAMNT   from AAG10001   where aaGLWorkHdrID = @aaGLWorkHdrID  and  aaGLWorkDistID > 0 and aaOFFSETAcct = 0  order by SQNCLINE, aaGLWorkDistID  open CAADIST  fetch next from CAADIST  into @SQNCLINE, @aaGLWorkDistID,@ACTINDX, @DEBITAMT, @CRDTAMNT  while @@fetch_status = 0  begin   if @DEBITAMT <> 0   Select @Cnt = count(*)  from GL10101 where   JRNENTRY = @JRNENTRY and SQNCLINE = @SQNCLINE and ACTINDX = @ACTINDX and TRXAMNT = @DEBITAMT   else if @CRDTAMNT <> 0   Select @Cnt = count(*)  from GL10101 where   JRNENTRY = @JRNENTRY and SQNCLINE = @SQNCLINE and ACTINDX = @ACTINDX and TRXAMNT = (@CRDTAMNT  *- 1)   if @Cnt = 0   begin  exec aagGLWorkDistDelete @aaGLWorkHdrID, @aaGLWorkDistID, 0   end   fetch next from CAADIST  into @SQNCLINE, @aaGLWorkDistID,@ACTINDX, @DEBITAMT, @CRDTAMNT   end   close CAADIST  deallocate CAADIST   select @Cnt = 0  declare CGLWORK cursor fast_forward for  Select SQNCLINE, ACTINDX,  ACCTTYPE, FXDORVAR,TRXAMNT  from GL10101  Where JRNENTRY = @JRNENTRY and SQNCLINE > 0  order by JRNENTRY, SQNCLINE  open CGLWORK   fetch next from CGLWORK into @SQNCLINE, @ACTINDX,  @ACCTTYPE, @FXDORVAR, @TRXAMNT  while @@fetch_status = 0   begin  if @TRXAMNT > 0   begin  select    @DEBITAMT = abs(@TRXAMNT),  @CRDTAMNT = 0,  @ORDBTAMT = abs(@TRXAMNT) ,  @ORCRDAMT =0  end  if @TRXAMNT < 0  begin  select    @DEBITAMT = 0,  @CRDTAMNT = abs(@TRXAMNT),  @ORDBTAMT = 0,  @ORCRDAMT =abs(@TRXAMNT)  end   Select @Cnt = 0  Select @Cnt = count(*)  from AAG10001   where aaGLWorkHdrID = @aaGLWorkHdrID and   aaGLWorkDistID > 0 and SQNCLINE = @SQNCLINE and   ACTINDX = @ACTINDX and   DEBITAMT = @DEBITAMT and CRDTAMNT = @CRDTAMNT and  ORDBTAMT = @ORDBTAMT and ORCRDAMT = @ORCRDAMT and   aaOFFSETAcct = 0   if @Cnt = 0  and @TRXAMNT <> 0  begin  Select @aaGLWorkDistID = isnull(max(aaGLWorkDistID),0)+1   from AAG10001 where aaGLWorkHdrID = @aaGLWorkHdrID and  aaGLWorkDistID > 0  exec aagGetClassIDBrowseType @ACTINDX, @ClassID output, @aaBrowseType output   if @ACCTTYPE = 2   begin   set @CURRNIDX  =  3  end   insert into AAG10001   (aaGLWorkHdrID,  aaGLWorkDistID,  INTERID ,  ACTINDX, ACCTTYPE ,  aaBrowseType, DECPLACS, FXDORVAR, DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT,  CURNCYID,CURRNIDX, SQNCLINE, aaCustID, aaVendID, aaSiteID,   aaItemID, aaCopyStatus, aaWinWasOpen, aaOFFSETAcct, aaDistErrors,aaChangeDate, aaChangeTime )  values (@aaGLWorkHdrID, @aaGLWorkDistID ,@INTERID, @ACTINDX, @ACCTTYPE,  @aaBrowseType,@DECPLACS, @FXDORVAR , @DEBITAMT, @CRDTAMNT, @ORDBTAMT, @ORCRDAMT,  @CURNCYID,@CURRNIDX, @SQNCLINE,  '', '', '', '', 8, 0, 0, 0,convert(char(12), getdate(), 102), convert(char(12), getdate(), 108))  exec aagGLAssignUpdate @aaGLWorkHdrID, @aaGLWorkDistID,@aaGLWorkAssignID, @CompanyID, @ClassID, @SqlSessionID,@Flag  end   fetch next from CGLWORK into @SQNCLINE, @ACTINDX,  @ACCTTYPE, @FXDORVAR, @TRXAMNT   end   close CGLWORK  deallocate CGLWORK  Select @aaGLWorkDistID = isnull(max(aaGLWorkDistID),0)+1   from AAG10001 where aaGLWorkHdrID = @aaGLWorkHdrID and  aaGLWorkDistID > 0   exec aagUpdateoffSetAcctOpt @aaGLWorkHdrID, @JRNENTRY, @aaGLWorkDistID Output,  @CURNCYID,@CURRNIDX,@EXGTBLID, @RATETPID,  @XCHGRATE, @EXCHDATE,  @TIME1 , @RTCLCMTD, @DENXRATE, @MCTRXSTT,  @DECPLACS, @CompanyID, @SqlSessionID,@BalAmt,@INTERID,@Post,@OFFINDX end     
GO
GRANT EXECUTE ON  [dbo].[aagUpdateGLBusinessEntryOpt] TO [DYNGRP]
GO
