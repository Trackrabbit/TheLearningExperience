SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create proc [dbo].[ivCreateItemSummaryHistory]   (@cItemNumber char(31)=NULL, @cLocation char(11)=NULL,   @bKeepCalendarHist smallint=NULL, @bKeepPeriodHist smallint=NULL,@bIncrease smallint=NULL,  @tCalendarYear smallint=NULL, @tCalendarPeriod smallint=NULL, @tFiscalYear smallint=NULL, @tFiscalPeriod smallint=NULL,  @nCost numeric(19,5)=NULL, @nSales numeric(19,5)=NULL, @nQty numeric(19,5)=NULL,  @iErrorState int=NULL output)  AS  declare @tTransaction tinyint begin  select @iErrorState = 0 if @cItemNumber=NULL or @cLocation=NULL or @bKeepCalendarHist=NULL or @bKeepPeriodHist=NULL or @bIncrease=NULL or  @tCalendarYear=NULL or @tCalendarPeriod=NULL or @tFiscalYear=NULL or @tFiscalPeriod=NULL or  @nCost=NULL or @nSales=NULL or @nQty=NULL begin  select @iErrorState = 21036  return end  if @bKeepCalendarHist = 0 AND @bKeepPeriodHist = 0  begin  return end  set nocount on if @@trancount = 0 begin   select @tTransaction = 1   begin transaction  end   if exists (SELECT * FROM IV30101 WHERE ITEMNMBR = @cItemNumber) begin  if @bIncrease > 0   UPDATE IV30101 SET SUMCSYTD = SUMCSYTD - @nCost,  SQTYSYTD = SQTYSYTD - @nQty,  SMSLSYTD = SMSLSYTD - @nSales  WHERE ITEMNMBR = @cItemNumber  else  UPDATE IV30101 SET  SUMCSYTD = SUMCSYTD + @nCost,  SQTYSYTD = SQTYSYTD + @nQty,  SMSLSYTD = SMSLSYTD + @nSales  WHERE ITEMNMBR = @cItemNumber end else begin  if @bIncrease > 0  INSERT INTO IV30101 (ITEMNMBR,SUMCSYTD,SQTYSYTD,SMSLSYTD)   VALUES (@cItemNumber, -@nCost, -@nQty, -@nSales)  else  INSERT INTO IV30101 (ITEMNMBR,SUMCSYTD,SQTYSYTD,SMSLSYTD)   VALUES (@cItemNumber, @nCost, @nQty, @nSales) end  if @bKeepCalendarHist > 0 begin  if exists (SELECT * FROM IV30102 WHERE ITEMNMBR = @cItemNumber AND LOCNCODE = '' AND SMRYTYPE = 1 AND YEAR1 = @tCalendarYear AND SMRYPMTH = @tCalendarPeriod)  begin  if @bIncrease > 0  UPDATE IV30102 SET  SMRYQTYS = SMRYQTYS - @nQty,  SMRYCOST = SMRYCOST - @nCost,  SMRYSALS = SMRYSALS - @nSales  WHERE ITEMNMBR = @cItemNumber AND LOCNCODE = '' AND SMRYTYPE = 1 AND YEAR1 = @tCalendarYear AND SMRYPMTH = @tCalendarPeriod   else  UPDATE IV30102 SET  SMRYQTYS = SMRYQTYS + @nQty,  SMRYCOST = SMRYCOST + @nCost,  SMRYSALS = SMRYSALS + @nSales  WHERE ITEMNMBR = @cItemNumber AND LOCNCODE = '' AND SMRYTYPE = 1 AND YEAR1 = @tCalendarYear AND SMRYPMTH = @tCalendarPeriod  end  else  begin  if @bIncrease > 0  INSERT IV30102 (ITEMNMBR, LOCNCODE, SMRYTYPE, SMRYPMTH, YEAR1, SMRYQTYS, SMRYCOST, SMRYSALS)  VALUES (@cItemNumber, '', 1, @tCalendarPeriod, @tCalendarYear, -@nQty,-@nCost, -@nSales)  else  INSERT IV30102 (ITEMNMBR, LOCNCODE, SMRYTYPE, SMRYPMTH, YEAR1, SMRYQTYS, SMRYCOST, SMRYSALS)  VALUES (@cItemNumber, '', 1, @tCalendarPeriod, @tCalendarYear, @nQty, @nCost, @nSales)  end   if exists (SELECT * FROM IV30102 WHERE ITEMNMBR = @cItemNumber AND LOCNCODE = @cLocation AND SMRYTYPE = 1 AND YEAR1 = @tCalendarYear AND SMRYPMTH = @tCalendarPeriod)  begin  if @bIncrease > 0  UPDATE IV30102 SET  SMRYQTYS = SMRYQTYS - @nQty,  SMRYCOST = SMRYCOST - @nCost,  SMRYSALS = SMRYSALS - @nSales  WHERE ITEMNMBR = @cItemNumber AND LOCNCODE = @cLocation AND SMRYTYPE = 1 AND YEAR1 = @tCalendarYear AND SMRYPMTH = @tCalendarPeriod   else  UPDATE IV30102 SET  SMRYQTYS = SMRYQTYS + @nQty,  SMRYCOST = SMRYCOST + @nCost,  SMRYSALS = SMRYSALS + @nSales  WHERE ITEMNMBR = @cItemNumber AND LOCNCODE = @cLocation AND SMRYTYPE = 1 AND YEAR1 = @tCalendarYear AND SMRYPMTH = @tCalendarPeriod  end  else  begin  if @bIncrease > 0  INSERT IV30102 (ITEMNMBR, LOCNCODE, SMRYTYPE, SMRYPMTH, YEAR1, SMRYQTYS, SMRYCOST, SMRYSALS)  VALUES (@cItemNumber, @cLocation, 1, @tCalendarPeriod, @tCalendarYear, -@nQty,-@nCost, -@nSales)  else  INSERT IV30102 (ITEMNMBR, LOCNCODE, SMRYTYPE, SMRYPMTH, YEAR1, SMRYQTYS, SMRYCOST, SMRYSALS)  VALUES (@cItemNumber, @cLocation, 1, @tCalendarPeriod, @tCalendarYear, @nQty, @nCost, @nSales)  end end   if @bKeepPeriodHist > 0 begin  if exists (SELECT * FROM IV30102 WHERE ITEMNMBR = @cItemNumber AND LOCNCODE = '' AND SMRYTYPE = 2 AND YEAR1 = @tFiscalYear AND SMRYPMTH = @tFiscalPeriod)  begin  if @bIncrease > 0  UPDATE IV30102 SET  SMRYQTYS = SMRYQTYS - @nQty,  SMRYCOST = SMRYCOST - @nCost,  SMRYSALS = SMRYSALS - @nSales  WHERE ITEMNMBR = @cItemNumber AND LOCNCODE = '' AND SMRYTYPE = 2 AND YEAR1 = @tFiscalYear AND SMRYPMTH = @tFiscalPeriod  else  UPDATE IV30102 SET  SMRYQTYS = SMRYQTYS + @nQty,  SMRYCOST = SMRYCOST + @nCost,  SMRYSALS = SMRYSALS + @nSales  WHERE ITEMNMBR = @cItemNumber AND LOCNCODE = '' AND SMRYTYPE = 2 AND YEAR1 = @tFiscalYear AND SMRYPMTH = @tFiscalPeriod  end  else  begin  if @bIncrease > 0  INSERT IV30102 (ITEMNMBR, LOCNCODE, SMRYTYPE, SMRYPMTH, YEAR1, SMRYQTYS, SMRYCOST, SMRYSALS)  VALUES (@cItemNumber, '', 2, @tFiscalPeriod, @tFiscalYear, -@nQty,-@nCost, -@nSales)  else  INSERT IV30102 (ITEMNMBR, LOCNCODE, SMRYTYPE, SMRYPMTH, YEAR1, SMRYQTYS, SMRYCOST, SMRYSALS)  VALUES (@cItemNumber, '', 2, @tFiscalPeriod, @tFiscalYear, @nQty, @nCost, @nSales)  end   if exists (SELECT * FROM IV30102 WHERE ITEMNMBR = @cItemNumber AND LOCNCODE = @cLocation AND SMRYTYPE = 2 AND YEAR1 = @tFiscalYear AND SMRYPMTH = @tFiscalPeriod)  begin  if @bIncrease > 0  UPDATE IV30102 SET  SMRYQTYS = SMRYQTYS - @nQty,  SMRYCOST = SMRYCOST - @nCost,  SMRYSALS = SMRYSALS - @nSales  WHERE ITEMNMBR = @cItemNumber AND LOCNCODE = @cLocation AND SMRYTYPE = 2 AND YEAR1 = @tFiscalYear AND SMRYPMTH = @tFiscalPeriod  else  UPDATE IV30102 SET  SMRYQTYS = SMRYQTYS + @nQty,  SMRYCOST = SMRYCOST + @nCost,  SMRYSALS = SMRYSALS + @nSales  WHERE ITEMNMBR = @cItemNumber AND LOCNCODE = @cLocation AND SMRYTYPE = 2 AND YEAR1 = @tFiscalYear AND SMRYPMTH = @tFiscalPeriod  end  else  begin  if @bIncrease > 0  INSERT IV30102 (ITEMNMBR, LOCNCODE, SMRYTYPE, SMRYPMTH, YEAR1, SMRYQTYS, SMRYCOST, SMRYSALS)  VALUES (@cItemNumber, @cLocation, 2, @tFiscalPeriod, @tFiscalYear, -@nQty,-@nCost, -@nSales)  else  INSERT IV30102 (ITEMNMBR, LOCNCODE, SMRYTYPE, SMRYPMTH, YEAR1, SMRYQTYS, SMRYCOST, SMRYSALS)  VALUES (@cItemNumber, @cLocation, 2, @tFiscalPeriod, @tFiscalYear, @nQty, @nCost, @nSales)  end end   if @tTransaction = 1  begin  commit transaction  end  set nocount off return  end   
GO
GRANT EXECUTE ON  [dbo].[ivCreateItemSummaryHistory] TO [DYNGRP]
GO
