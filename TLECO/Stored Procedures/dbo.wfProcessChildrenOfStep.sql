SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[wfProcessChildrenOfStep]  @Workflow_User char(85),  @WorkflowStepInstanceID char(37),  @bypass_conditions tinyint,  @escalation tinyint,  @TempFilePath nvarchar(300) = '',  @tasks_created tinyint OUTPUT,  @approval_tasks_created tinyint OUTPUT   AS  BEGIN set NOCOUNT ON   declare @Workflow_Type_Name char(51)  declare @user_assignment_table TABLE (workflow_assigned_to char(128))  declare @valid_step tinyint, @assignment_status tinyint  declare @Workflow_Step_Condition smallint, @Workflow_Step_Type smallint  declare @Workflow_Step_Conditions char(37)  declare @FieldsListGuid char(37)  declare @Workflow_Step_Assign_To char(37)  declare @WorkflowInstanceID char(37)  declare @Workflow_Name char(51)  declare @Workflow_Version int  declare @Workflow_Step_Name char(51)  declare @calculate_due_date tinyint, @escalate tinyint, @workflow_action tinyint  declare @Workflow_Business_Object_Key char(201)  declare @Workflow_Error int  declare @Workflow_Completion_Date datetime, @Workflow_Completion_Time datetime  declare @Comments_for_History char(2000)  declare @task_step_count int  declare @WFIncludeDocumentAttach tinyint  declare @WfBusObjKey varchar(201)  select @WorkflowStepInstanceID=UPPER(@WorkflowStepInstanceID)  select @Workflow_Name=Workflow_Name, @Workflow_Version=Workflow_Version,   @Workflow_Step_Name=Workflow_Step_Name, @WorkflowInstanceID=WorkflowInstanceID  from WFI10003 where WorkflowStepInstanceID=@WorkflowStepInstanceID  select @tasks_created=0, @task_step_count=0   select @Workflow_Type_Name=Workflow_Type_Name from WF100002   where Workflow_Name=@Workflow_Name and Workflow_Version=@Workflow_Version  select @FieldsListGuid=FieldsListGuid   from WF100001 where Workflow_Type_Name=@Workflow_Type_Name  select @Workflow_Business_Object_Key=WfBusObjKey from WFI10002 where WorkflowInstanceID=@WorkflowInstanceID   if @escalation=0  begin  declare Workflow_Steps cursor local fast_forward for  select Workflow_Step_Name,Workflow_Step_Condition,Workflow_Step_Conditions,Workflow_Step_Assign_To  from WF100003 where Workflow_Name=@Workflow_Name and Workflow_Version=@Workflow_Version  and WF_Step_Predecessor=@Workflow_Step_Name  end  else  begin   select @task_step_count = isnull((select count(Workflow_Step_Name) from WF100003 where Workflow_Name=@Workflow_Name and Workflow_Version=@Workflow_Version  and WF_Step_Predecessor=@Workflow_Step_Name and Workflow_Step_Type=2),0)  declare Workflow_Steps cursor local fast_forward for  select Workflow_Step_Name,Workflow_Step_Condition,Workflow_Step_Conditions,Workflow_Step_Assign_To  from WF100003 where Workflow_Name=@Workflow_Name and Workflow_Version=@Workflow_Version  and WF_Step_Predecessor=@Workflow_Step_Name and Workflow_Step_Type=1  end  open Workflow_Steps  fetch next from Workflow_Steps into @Workflow_Step_Name,@Workflow_Step_Condition,  @Workflow_Step_Conditions,@Workflow_Step_Assign_To  if @@FETCH_STATUS = 0 and @task_step_count=0  begin  while @@FETCH_STATUS = 0   begin  delete from @user_assignment_table   select @WorkflowStepInstanceID=convert(char(37),newid())  insert into WFI10003  select @WorkflowStepInstanceID,Workflow_Step_Name,@WorkflowInstanceID,Workflow_Name,Workflow_Version,  WF_Step_Description,2,Workflow_Step_Sequence,Workflow_Step_Type,Workflow_Step_Order,  Workflow_Step_Condition,Workflow_Step_Conditions,WF_Step_Predecessor,  Workflow_Step_Assign_To,EmailMessageID,Workflow_Step_Send_Email,Workflow_Step_Time_Limit,  WF_Step_Time_Limit_UofM,WF_Step_Completion_Polic,WF_Apply_WF_Calendar,  NOTEINDX,SYSDATETIME() from WF100003   where Workflow_Step_Name=@Workflow_Step_Name and Workflow_Name=@Workflow_Name and Workflow_Version=@Workflow_Version   select @valid_step=0, @assignment_status=0  if @Workflow_Step_Condition=1 and @bypass_conditions=0   exec wfEvaluateStep @WorkflowInstanceID,@FieldsListGuid,@Workflow_Step_Conditions,  @valid_step OUTPUT  else  select @valid_step=1   if @valid_step>0   begin  select @WFIncludeDocumentAttach = WFIncludeDocumentAttach from WF100003  where Workflow_Name = @Workflow_Name and Workflow_Step_Name = @Workflow_Step_Name  if @WFIncludeDocumentAttach = 1   begin  select @WfBusObjKey = WF2.WfBusObjKey from WFI10002 WF2   inner join WFI10003 WFI3 on WF2.WorkflowInstanceID = WFI3.WorkflowInstanceID   where WFI3.WorkflowStepInstanceID = @WorkflowStepInstanceID  exec wfDocAttach @Workflow_Type_Name, @WfBusObjKey, @WorkflowStepInstanceID  end   select @calculate_due_date=1,   @escalate=0   exec wfAssignTasks @WorkflowStepInstanceID,@Workflow_Step_Assign_To,@Workflow_User,@calculate_due_date,@escalate,@TempFilePath,  @assignment_status OUTPUT, @approval_tasks_created OUTPUT  if @assignment_status=0   begin  select @tasks_created=1  update WFI10002 set Workflow_Status=4  where WorkflowInstanceID=@WorkflowInstanceID  exec wfUpdateDocument @WorkflowInstanceID,1,4,'','',@Workflow_Error OUTPUT   if @WFIncludeDocumentAttach = 1  insert into CO00104 select BusObjKey,Attachment_ID,'Workflow Message',CONVERT (date, SYSDATETIME()),  CONVERT (time, SYSDATETIME()),CRUSRID from CO00102 where WorkflowStepInstanceID = @WorkflowStepInstanceID  end  end  else   begin  update WFI10003 set Workflow_Step_Status=1   where WorkflowStepInstanceID=@WorkflowStepInstanceID   select @Workflow_Completion_Date=cast(SYSDATETIME() as date),@Workflow_Completion_Time=cast(SYSDATETIME() as time)  select @Workflow_Step_Assign_To = Workflow_Step_Assign_To,  @Workflow_Step_Type=Workflow_Step_Type from WFI10003 where WorkflowStepInstanceID=@WorkflowStepInstanceID   if @Workflow_Step_Type>1   begin  select @workflow_action=4  select @Comments_for_History= 'No action is required for this step.'  end  else  begin  select @workflow_action=3  select @Comments_for_History='No approval is required for this step.'  end  exec wfCreateHistoryRecord @WorkflowInstanceID,  @WorkflowStepInstanceID,  '',  @Workflow_Name,  @Workflow_Step_Name,  '',  @workflow_action,  '',  '',  @Workflow_Completion_Date,  @Workflow_Completion_Time,  @Comments_for_History,  @Workflow_Error OUTPUT  end   fetch next from Workflow_Steps into @Workflow_Step_Name,@Workflow_Step_Condition,  @Workflow_Step_Conditions,@Workflow_Step_Assign_To  end   end  close Workflow_Steps  deallocate Workflow_Steps  END   
GO
GRANT EXECUTE ON  [dbo].[wfProcessChildrenOfStep] TO [DYNGRP]
GO
