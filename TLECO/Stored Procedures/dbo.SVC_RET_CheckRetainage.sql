SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 Create Procedure [dbo].[SVC_RET_CheckRetainage]  (  @CONSTS smallint,  @CONTNBR char(11),  @LNSEQNBR numeric(19,5),  @CUSTNMBR char(15),  @Show tinyint OUTPUT  ) As set nocount on  declare @l_wip_retainage numeric(19,5),  @l_remaining_retainage  numeric(19,5),  @RetainageType smallint,  @l_remaining_time numeric(19,5),  @l_remaining_call numeric(19,5),  @l_retainer_percentage integer,  @check_value numeric(19,5),  @PRETAXTOT numeric(19,5),  @TOTAL numeric(19,5),  @BLKTIM numeric(19,5),  @RETNAGAM numeric(19,5),  @NBRCAL integer select @Show = 0 if exists(select * from sysobjects where name = 'SVC00600') BEGIN  if exists(select * from SVC00601 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and  LNSEQNBR = @LNSEQNBR and BILCYC <> 1 and SVC_Liability_Type <> 1)  BEGIN  select @RetainageType = SVC_Liability_Type,  @BLKTIM = BLKTIM,  @RETNAGAM = RETNAGAM,  @NBRCAL = NBRCAL,  @l_remaining_time = BLKTIM - VALTIM,  @l_remaining_retainage = RETNAGAM - RTNBILLD,  @l_remaining_call = NBRCAL - ACTCAL,  @check_value = CASE   when SVC_Liability_Type = 2 and BLKTIM <> 0 THEN ((BLKTIM - VALTIM) * 100) / BLKTIM  when SVC_Liability_Type = 3 and RETNAGAM <> 0 THEN ((RETNAGAM - RTNBILLD) * 100) / RETNAGAM  when SVC_Liability_Type = 4 and NBRCAL <> 0 THEN ((NBRCAL - ACTCAL) * 100) / NBRCAL  else 100  END   from SVC00601 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and  LNSEQNBR = @LNSEQNBR  select @l_retainer_percentage = Retainage_Percent   from SVC00998  if @check_value <= @l_retainer_percentage  select @Show = 1  else  BEGIN  select @PRETAXTOT = IsNull(PRETAXTOT,0)  from SVC00200 where SRVRECTYPE = 2 and   CUSTNMBR = @CUSTNMBR and   CONSTS = @CONSTS and   CONTNBR = @CONTNBR  select @PRETAXTOT = IsNull(@PRETAXTOT,0)   if @RetainageType = 3   begin  select @l_remaining_retainage = @l_remaining_retainage - @PRETAXTOT  if @RETNAGAM <> 0   if (@l_remaining_retainage * 100  / @RETNAGAM) <= @l_retainer_percentage   select @Show = 1  end else if @RetainageType = 4   begin  select @l_remaining_call = @l_remaining_call - 1.  if @NBRCAL <> 0   if (@l_remaining_call * 100  / @NBRCAL) <= @l_retainer_percentage   select @Show = 1  end else if @RetainageType = 2   begin  select @TOTAL = SUM(IsNull(QTYSOLD,0))  from SVC00200 INNER JOIN SVC00203 on (SVC00200.SRVRECTYPE = SVC00203.SRVRECTYPE and SVC00200.CALLNBR = SVC00203.CALLNBR)  where SVC00200.SRVRECTYPE = 2 and   SVC00200.CUSTNMBR = @CUSTNMBR and   SVC00200.CONSTS = @CONSTS and   SVC00200.CONTNBR = @CONTNBR and  SVC00203.LINITMTYP = 'L'  select @TOTAL = IsNull(@TOTAL,0)  select @l_remaining_time = @l_remaining_time - @TOTAL  if @BLKTIM  <> 0   if (@l_remaining_time * 100 / @BLKTIM ) <= @l_retainer_percentage   select @Show = 1   END   END   END  END  return     
GO
GRANT EXECUTE ON  [dbo].[SVC_RET_CheckRetainage] TO [DYNGRP]
GO
