SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 Create Proc [dbo].[UPR_SetReportsToStructureForList]  (@I_sReportsToTableName char(30) = NULL, @I_nModule smallint = NULL, @EmployeeID VARCHAR(15), @CalledBy int = NULL, @O_SQL_Error_State int= NULL output) AS DECLARE @SQLString nvarchar(4000),@SQLString1 nvarchar(4000), @iStatus int,  @iError int , @ViewMultipleDirects smallint, @Stmt1  nvarchar(4000), @Stmt2  nvarchar(4000), @Stmt3  nvarchar(4000), @Stmt4  nvarchar(4000)  select  @O_SQL_Error_State = 0,  @iStatus = 0,   @iError = 0  if (  @I_sReportsToTableName is NULL or  @I_nModule is NULL or  @EmployeeID is NULL or  @EmployeeID is NULL )  begin  select @O_SQL_Error_State = 26000  return end  if @I_nModule = 35  or @I_nModule = 0 BEGIN  SET @ViewMultipleDirects = (SELECT VIEWMULTDIR FROM UPR40200 WHERE SETUPKEY = 1)  set @EmployeeID = REPLACE(@EmployeeID, '''','''''')  IF (@ViewMultipleDirects = 1)  BEGIN  IF @CalledBy = 2  BEGIN  SET @Stmt1 = 'SUP11.EMPLOYID AS S11,   SUP12.EMPLOYID AS S12,   SUP13.EMPLOYID AS S13,   SUP14.EMPLOYID AS S14,   SUP15.EMPLOYID AS S15,'  SET @Stmt2 = 'WHEN (SUP11.EMPLOYID = ''' + @EmployeeID + ''') THEN 11   WHEN (SUP12.EMPLOYID = ''' + @EmployeeID + ''') THEN 12   WHEN (SUP13.EMPLOYID = ''' + @EmployeeID + ''') THEN 13   WHEN (SUP14.EMPLOYID = ''' + @EmployeeID + ''') THEN 14   WHEN (SUP15.EMPLOYID = ''' + @EmployeeID + ''') THEN 15'   SET @Stmt3 = 'LEFT OUTER JOIN UPR00100 AS E11 ON SUP10.EMPLOYID = E11.EMPLOYID  LEFT OUTER JOIN UPR41700 AS SUP11 ON E11.SUPERVISORCODE_I = SUP11.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 AS E12 ON SUP11.EMPLOYID = E12.EMPLOYID  LEFT OUTER JOIN UPR41700 AS SUP12 ON E12.SUPERVISORCODE_I = SUP12.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 AS E13 ON SUP12.EMPLOYID = E13.EMPLOYID  LEFT OUTER JOIN UPR41700 AS SUP13 ON E13.SUPERVISORCODE_I = SUP13.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 AS E14 ON SUP13.EMPLOYID = E14.EMPLOYID  LEFT OUTER JOIN UPR41700 AS SUP14 ON E14.SUPERVISORCODE_I = SUP14.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 AS E15 ON SUP14.EMPLOYID = E15.EMPLOYID  LEFT OUTER JOIN UPR41700 AS SUP15 ON E15.SUPERVISORCODE_I = SUP15.SUPERVISORCODE_I'   SET @Stmt4 = 'OR SUP11.EMPLOYID = ''' + @EmployeeID + '''  OR SUP12.EMPLOYID = ''' + @EmployeeID + '''  OR SUP13.EMPLOYID = ''' + @EmployeeID + '''  OR SUP14.EMPLOYID = ''' + @EmployeeID + '''  OR SUP15.EMPLOYID = ''' + @EmployeeID + ''''  END  SET @SQLString = '  INSERT INTO ' + @I_sReportsToTableName + ' (EMPLOYID, Supervisor_Employee_ID, LVLLABEL, Group_ID, LASTNAME, FRSTNAME, MIDLNAME, EMPLSUFF, USERID, SUPERVISORCODE_I, SUPERVISOR, PHONE1, PHONE2,   Supervisor_Last_Name, Supervisor_First_Name, Supervisor_Middle_Name)   SELECT EMPLOYID, ISNULL(S1,''''), EELEVEL, GROUPBY, LASTNAME, FRSTNAME, MIDLNAME, EMPLSUFF, USERID, ISNULL(SUPERVISORCODE_I,''''), ISNULL(SUPERVISOR,''''), ISNULL(PHONE1,''00000000000000''), ISNULL(PHONE2, ''00000000000000''),  ISNULL(SUPLASTNAME,''''), ISNULL(SUPFRSTNAME,''''), ISNULL(SUPMIDLNAME,'''') FROM   (  SELECT E1.EMPLOYID AS EMPLOYID,   SUP1.EMPLOYID AS S1,   SUP2.EMPLOYID AS S2,   SUP3.EMPLOYID AS S3,   SUP4.EMPLOYID AS S4,   SUP5.EMPLOYID AS S5,   SUP6.EMPLOYID AS S6,   SUP7.EMPLOYID AS S7,   SUP8.EMPLOYID AS S8,   SUP9.EMPLOYID AS S9,   SUP10.EMPLOYID AS S10,' + @Stmt1 + '  CASE   WHEN (E1.EMPLOYID = ''' + @EmployeeID + ''') THEN 0  WHEN (SUP1.EMPLOYID = ''' + @EmployeeID + ''') THEN 1   WHEN (SUP2.EMPLOYID = ''' + @EmployeeID + ''') THEN 2   WHEN (SUP3.EMPLOYID = ''' + @EmployeeID + ''') THEN 3   WHEN (SUP4.EMPLOYID = ''' + @EmployeeID + ''') THEN 4   WHEN (SUP5.EMPLOYID = ''' + @EmployeeID + ''') THEN 5   WHEN (SUP6.EMPLOYID = ''' + @EmployeeID + ''') THEN 6   WHEN (SUP7.EMPLOYID = ''' + @EmployeeID + ''') THEN 7   WHEN (SUP8.EMPLOYID = ''' + @EmployeeID + ''') THEN 8   WHEN (SUP9.EMPLOYID = ''' + @EmployeeID + ''') THEN 9   WHEN (SUP10.EMPLOYID = ''' + @EmployeeID + ''') THEN 10   ' + @Stmt2 + '   END AS EELEVEL,  CASE   WHEN (E1.EMPLOYID = ''' + @EmployeeID + ''') THEN 0  WHEN (SUP1.EMPLOYID = ''' + @EmployeeID + ''') THEN 999   ELSE -1  END AS GROUPBY,  E1.LASTNAME,  E1.FRSTNAME,  E1.MIDLNAME,  E1.EMPLSUFF,  E1.USERID,  SUP1.SUPERVISORCODE_I,  SUP1.SUPERVISOR,  ADD1.PHONE1,  ADD2.PHONE1 AS PHONE2,  E2.LASTNAME AS SUPLASTNAME,  E2.FRSTNAME AS SUPFRSTNAME,  E2.MIDLNAME AS SUPMIDLNAME  FROM UPR00100 AS E1  LEFT OUTER JOIN UPR00102 AS ADD1 ON E1.EMPLOYID = ADD1.EMPLOYID AND E1.ADRSCODE = ADD1.ADRSCODE  LEFT OUTER JOIN UPR41700 AS SUP1 ON E1.SUPERVISORCODE_I = SUP1.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 AS E2 ON SUP1.EMPLOYID = E2.EMPLOYID  LEFT OUTER JOIN UPR00102 AS ADD2 ON E2.EMPLOYID = ADD2.EMPLOYID AND E2.ADRSCODE = ADD2.ADRSCODE  LEFT OUTER JOIN UPR41700 AS SUP2 ON E2.SUPERVISORCODE_I = SUP2.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 AS E3 ON SUP2.EMPLOYID = E3.EMPLOYID  LEFT OUTER JOIN UPR41700 AS SUP3 ON E3.SUPERVISORCODE_I = SUP3.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 AS E4 ON SUP3.EMPLOYID = E4.EMPLOYID  LEFT OUTER JOIN UPR41700 AS SUP4 ON E4.SUPERVISORCODE_I = SUP4.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 AS E5 ON SUP4.EMPLOYID = E5.EMPLOYID  LEFT OUTER JOIN UPR41700 AS SUP5 ON E5.SUPERVISORCODE_I = SUP5.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 AS E6 ON SUP5.EMPLOYID = E6.EMPLOYID  LEFT OUTER JOIN UPR41700 AS SUP6 ON E6.SUPERVISORCODE_I = SUP6.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 AS E7 ON SUP6.EMPLOYID = E7.EMPLOYID  LEFT OUTER JOIN UPR41700 AS SUP7 ON E7.SUPERVISORCODE_I = SUP7.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 AS E8 ON SUP7.EMPLOYID = E8.EMPLOYID  LEFT OUTER JOIN UPR41700 AS SUP8 ON E8.SUPERVISORCODE_I = SUP8.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 AS E9 ON SUP8.EMPLOYID = E9.EMPLOYID  LEFT OUTER JOIN UPR41700 AS SUP9 ON E9.SUPERVISORCODE_I = SUP9.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 AS E10 ON SUP9.EMPLOYID = E10.EMPLOYID  LEFT OUTER JOIN UPR41700 AS SUP10 ON E10.SUPERVISORCODE_I = SUP10.SUPERVISORCODE_I  '   SET @SQLString1 =  @Stmt3 + '   WHERE E1.EMPLOYID = ''' + @EmployeeID + '''  OR SUP1.EMPLOYID = ''' + @EmployeeID + '''  OR SUP2.EMPLOYID = ''' + @EmployeeID + '''  OR SUP3.EMPLOYID = ''' + @EmployeeID + '''  OR SUP4.EMPLOYID = ''' + @EmployeeID + '''  OR SUP5.EMPLOYID = ''' + @EmployeeID + '''  OR SUP6.EMPLOYID = ''' + @EmployeeID + '''  OR SUP7.EMPLOYID = ''' + @EmployeeID + '''  OR SUP8.EMPLOYID = ''' + @EmployeeID + '''  OR SUP9.EMPLOYID = ''' + @EmployeeID + '''  OR SUP10.EMPLOYID = ''' + @EmployeeID + '''  ' + @Stmt4 + '  ) AS A4  ' END ELSE BEGIN  SET @SQLString = '  INSERT INTO ' + @I_sReportsToTableName + ' (EMPLOYID, Supervisor_Employee_ID, LVLLABEL, Group_ID, LASTNAME, FRSTNAME, MIDLNAME, EMPLSUFF, USERID, SUPERVISORCODE_I, SUPERVISOR, PHONE1, PHONE2,   Supervisor_Last_Name, Supervisor_First_Name, Supervisor_Middle_Name)   SELECT EMPLOYID, ISNULL(S1,''''), EELEVEL, GROUPBY, LASTNAME, FRSTNAME, MIDLNAME, EMPLSUFF, USERID, ISNULL(SUPERVISORCODE_I,''''), ISNULL(SUPERVISOR,''''), ISNULL(PHONE1, ''00000000000000''), ISNULL(PHONE2, ''00000000000000''),  ISNULL(SUPLASTNAME,''''), ISNULL(SUPFRSTNAME,''''), ISNULL(SUPMIDLNAME,'''') FROM   (  SELECT E1.EMPLOYID AS EMPLOYID,   SUP1.EMPLOYID AS S1,   CASE   WHEN (E1.EMPLOYID = ''' + @EmployeeID + ''') THEN 0  WHEN (SUP1.EMPLOYID = ''' + @EmployeeID + ''') THEN 1   END AS EELEVEL,  CASE   WHEN (E1.EMPLOYID = ''' + @EmployeeID + ''') THEN 0  WHEN (SUP1.EMPLOYID = ''' + @EmployeeID + ''') THEN 999   ELSE -1  END AS GROUPBY,  E1.LASTNAME,  E1.FRSTNAME,  E1.MIDLNAME,  E1.EMPLSUFF,  E1.USERID,  SUP1.SUPERVISORCODE_I,  SUP1.SUPERVISOR,  ADD1.PHONE1,  ADD2.PHONE1 AS PHONE2,  E2.LASTNAME AS SUPLASTNAME,  E2.FRSTNAME AS SUPFRSTNAME,  E2.MIDLNAME AS SUPMIDLNAME  FROM UPR00100 AS E1  LEFT OUTER JOIN UPR00102 AS ADD1 ON E1.EMPLOYID = ADD1.EMPLOYID AND E1.ADRSCODE = ADD1.ADRSCODE  LEFT OUTER JOIN UPR41700 AS SUP1 ON E1.SUPERVISORCODE_I = SUP1.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 AS E2 ON SUP1.EMPLOYID = E2.EMPLOYID  LEFT OUTER JOIN UPR00102 AS ADD2 ON E2.EMPLOYID = ADD2.EMPLOYID AND E2.ADRSCODE = ADD2.ADRSCODE  WHERE E1.EMPLOYID = ''' + @EmployeeID + '''  OR SUP1.EMPLOYID = ''' + @EmployeeID + '''  ) AS A4  ' END exec(@SQLString + @SQLString1)  SET @SQLString = ' DECLARE @GroupBy AS INT, @Loops AS INT, @TempEEID AS VARCHAR(15)  SET @GroupBy = 0 SET @Loops = (SELECT COUNT(*) FROM ' + @I_sReportsToTableName + ' WHERE Group_ID = 999)  WHILE @Loops >= @GroupBy BEGIN  SET @GroupBy = @GroupBy + 1  SET @TempEEID = (SELECT TOP 1 C.EMPLOYID FROM ' + @I_sReportsToTableName + ' C  INNER JOIN ' + @I_sReportsToTableName + ' D  ON C.Supervisor_Employee_ID = D.EMPLOYID  WHERE C.Group_ID = 999  AND D.Group_ID > -1  ORDER BY C.EMPLOYID)   UPDATE A2  SET A2.Group_ID = @GroupBy  FROM ' + @I_sReportsToTableName + ' A2  JOIN ' + @I_sReportsToTableName + ' B2   ON A2.Supervisor_Employee_ID = B2.EMPLOYID  WHERE A2.Group_ID = 999  AND B2.Group_ID > -1  AND A2.Supervisor_Employee_ID = ''' + @EmployeeID + '''  AND A2.EMPLOYID = @TempEEID END  WHILE (SELECT COUNT(*) FROM ' + @I_sReportsToTableName + ' WHERE Group_ID = -1) > 0 BEGIN  UPDATE A3  SET A3.Group_ID = B3.Group_ID  FROM ' + @I_sReportsToTableName + ' A3  LEFT JOIN ' + @I_sReportsToTableName + ' B3  ON A3.Supervisor_Employee_ID = B3.EMPLOYID  WHERE B3.Group_ID > -1  AND A3.Group_ID = -1 END  ' exec(@SQLString) END   
GO
GRANT EXECUTE ON  [dbo].[UPR_SetReportsToStructureForList] TO [DYNGRP]
GO
