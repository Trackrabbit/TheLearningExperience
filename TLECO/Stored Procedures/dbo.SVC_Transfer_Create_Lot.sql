SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 Create Procedure [dbo].[SVC_Transfer_Create_Lot] ( @DocNumber char(15),  @Line int, @lot_number char(20),  @item_number char(30),  @location_code char(11),  @item_cost numeric(19,5), @rcv_date datetime, @date_seq numeric(19,5), @lot_qty numeric (19,5), @FromBin char(15), @ToBin char(15), @ExpDate datetime, @MfgDate datetime )  as declare @LotSequence int declare @InTransit char(11) declare @TransferStatus smallint declare @MinDate datetime  exec smGetMinDate @MinDate output   if (select ENABLEMULTIBIN from IV40100) = 1  begin  if @FromBin = ''   exec SVC_Bin_GetDefault @item_number, @location_code, 'I', @FromBin output  if @ToBin = ''  select @ToBin = @FromBin   end  begin transaction  if not exists(select * from SVC00702 where ORDDOCID = @DocNumber and TRANSLINESEQ = @Line   and SERLTNUM = @lot_number and ITEMNMBR = @item_number and DATERECD = @rcv_date and DTSEQNUM = @date_seq and STATUS < 2)  begin   select @LotSequence = isnull(Max(SLTSQNUM),0) + 1 from SVC00702  where ORDDOCID = @DocNumber and TRANSLINESEQ = @Line    insert SVC00702 select  @DocNumber, @Line, 0, '', 0, '',0, 1, @lot_number, @lot_qty, @LotSequence, isnull(@rcv_date,CONVERT(char(10),GETDATE(),102) + ' 00:00:00') ,  isnull(@date_seq,1),  @item_cost, @item_number, 'Transfer line' , 0, 0, 1, isnull(@FromBin,''), isnull(@ToBin,''), @MfgDate, @ExpDate  if @@error <> 0 goto badentry  select @InTransit = ITLOCN, @TransferStatus = STATUS from SVC00701 where ORDDOCID = @DocNumber and LNITMSEQ = @Line  if (@TransferStatus = 3 or @TransferStatus = 4) and @InTransit = @location_code  update SVC00702 with (rowlock) set STATUS = 4, OVRSERLT = 1   where ORDDOCID = @DocNumber and TRANSLINESEQ = @Line and SLTSQNUM = @LotSequence  end else  begin  update SVC00702 set SERLTQTY = SERLTQTY + @lot_qty   where ORDDOCID = @DocNumber and TRANSLINESEQ = @Line and SERLTNUM = @lot_number and ITEMNMBR = @item_number and DATERECD = @rcv_date and DTSEQNUM = @date_seq  end  commit transaction  return badentry:  rollback transaction  return     
GO
GRANT EXECUTE ON  [dbo].[SVC_Transfer_Create_Lot] TO [DYNGRP]
GO
