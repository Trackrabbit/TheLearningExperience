SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[glpVerifyClearingAccounts]  @I_iClearingAccountIndex                int             = NULL,  @I_iOffsetAccountIndex                  int             = NULL,  @I_bBatchValid                          binary(4)       = NULL,  @I_bLineValid                           binary(4)       = NULL,  @I_cIntercompanyID char(5)  = NULL,  @IO_sClearingAccountType                smallint        = NULL  output,  @IO_sClearingFixedOrVariable            smallint        = NULL  output,  @IO_sClearingBalForCal                  smallint        = NULL  output,  @IO_sClearingPostingType                smallint        = NULL  output,  @IO_sClearingDecimalPlaces              smallint        = NULL  output,  @IO_sOffsetAccountType                  smallint        = NULL  output,  @IO_sOffsetFixedOrVariable              smallint        = NULL  output,  @IO_sOffsetBalForCal                    smallint        = NULL  output,  @IO_sOffsetPostingType                  smallint        = NULL  output,  @IO_sOffsetDecimalPlaces                smallint        = NULL  output,  @IO_bLineMessages                       binary(4)       = NULL  output,  @IO_bOffsetMessages                     binary(4)       = NULL  output,  @O_iErrorState                          int             = NULL  output as  declare  @TRUE                   tinyint,  @FALSE tinyint,  @POST_ACCT              smallint,  @UNIT_ACCT              smallint,  @POST_ALLOC_ACCT        smallint,  @UNIT_ALLOC_ACCT        smallint,  @BAL_SHEET              smallint,  @PROFIT_AND_LOSS        smallint,  @FIXED                  smallint,  @VARIABLE               smallint,  @MS_ITEM_1              int,  @MS_ITEM_2              int,  @MS_ITEM_3              int,  @MS_ITEM_18             int,   @MS_ITEM_19             int,  @MS_ITEM_20             int,  @tValidAccountNumber    tinyint,  @tActive                tinyint,  @tTransaction           tinyint,  @tLoop                  tinyint,  @iError                 int,  @iStatus                int,  @iRelationID int,  @sUserLevel smallint,  @iAccessAllAccounts int,  @tALSRegistered tinyint,  @sAccountCategory smallint,  @cCompanyID char(5)  select  @O_iErrorState  = 0,   @iStatus        = 0  if @@trancount = 0 begin  select @tTransaction = 1  begin transaction end   while (@tLoop is NULL) begin  select @tLoop = 1   if      @I_iClearingAccountIndex                is NULL or  @I_iOffsetAccountIndex                  is NULL or  @I_bBatchValid                          is NULL or  @I_bLineValid                           is NULL or  @I_cIntercompanyID is NULL or  @IO_sClearingAccountType                is NULL or  @IO_sClearingFixedOrVariable            is NULL or  @IO_sClearingBalForCal                  is NULL or  @IO_sClearingPostingType                is NULL or  @IO_sClearingDecimalPlaces              is NULL or  @IO_sOffsetAccountType                  is NULL or  @IO_sOffsetFixedOrVariable              is NULL or  @IO_sOffsetBalForCal                    is NULL or  @IO_sOffsetPostingType                  is NULL or  @IO_bLineMessages                       is NULL or  @IO_bOffsetMessages                     is NULL  begin  select @O_iErrorState = 20134  break  end     select  @TRUE                   = 1,  @FALSE   = 0,  @POST_ACCT              = 1,  @UNIT_ACCT              = 2,  @POST_ALLOC_ACCT        = 3,  @UNIT_ALLOC_ACCT        = 4,  @BAL_SHEET              = 0,  @PROFIT_AND_LOSS        = 1,  @FIXED                  = 1,  @VARIABLE                       = 2,  @MS_ITEM_1              = power (2,24),  @MS_ITEM_2              = power (2,25),  @MS_ITEM_3              = power (2,26),  @MS_ITEM_18             = power (2,9),  @MS_ITEM_19             = power (2,10),  @MS_ITEM_20             = power (2,11),  @iRelationID  = 0,  @sUserLevel  = 0,  @iAccessAllAccounts = 0,  @tALSRegistered  = 0   select @cCompanyID = db_name()   exec @iStatus = DYNAMICS..smGetAccountLevelSecurityInfo  @cCompanyID,  @iRelationID output,  @sUserLevel  output,  @iAccessAllAccounts output,  @tALSRegistered output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if @iStatus <> 0 or @O_iErrorState <> 0  break   if (@I_bLineValid & @MS_ITEM_1) <> @MS_ITEM_1   or        (@I_bBatchValid & @MS_ITEM_1) = @MS_ITEM_1   or        (@I_bBatchValid & @MS_ITEM_3) = @MS_ITEM_3   or        @iAccessAllAccounts = @FALSE      begin  exec @iStatus = glpGetAccountNumber  @I_iClearingAccountIndex,  @iRelationID,  @sUserLevel,  @iAccessAllAccounts,  @tValidAccountNumber                    output,  @tActive                                output,  @IO_sClearingAccountType                output,  @sAccountCategory               output,  @IO_sClearingFixedOrVariable            output,  @IO_sClearingBalForCal                  output,  @IO_sClearingPostingType                output,   @IO_sClearingDecimalPlaces              output,   @O_iErrorState                          output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if @iStatus <> 0 or @O_iErrorState <> 0  break  end  else  begin  select   @tValidAccountNumber    = @TRUE,  @tActive                        = @TRUE  end    if @tValidAccountNumber <> @TRUE  begin  select @IO_bLineMessages = (@IO_bLineMessages | @MS_ITEM_1)  end  else   begin  if @tActive <> @TRUE  select @IO_bLineMessages = (@IO_bLineMessages | @MS_ITEM_2)  else   begin  if @IO_sClearingAccountType = @POST_ALLOC_ACCT or  @IO_sClearingAccountType = @UNIT_ALLOC_ACCT  select @IO_bLineMessages = (@IO_bLineMessages | @MS_ITEM_3)  end     if @IO_sClearingAccountType <>  @POST_ACCT              and  @IO_sClearingAccountType <>  @UNIT_ACCT                      and  @IO_sClearingAccountType <>  @POST_ALLOC_ACCT        and   @IO_sClearingAccountType <>  @UNIT_ALLOC_ACCT   begin  select @IO_bLineMessages = (@IO_bLineMessages | @MS_ITEM_1)  end    if @IO_sClearingAccountType = @POST_ACCT and   (@IO_sClearingPostingType <> @BAL_SHEET and  @IO_sClearingPostingType <> @PROFIT_AND_LOSS)  begin  select @IO_bLineMessages = (@IO_bLineMessages | @MS_ITEM_1)  end   end    if (@I_bLineValid        & @MS_ITEM_2) <> @MS_ITEM_2    or        (@I_bBatchValid & @MS_ITEM_1) = @MS_ITEM_1   or        (@I_bBatchValid & @MS_ITEM_3) = @MS_ITEM_3   or        @iAccessAllAccounts = @FALSE         begin  exec @iStatus = glpGetAccountNumber  @I_iClearingAccountIndex,  @iRelationID,  @sUserLevel,  @iAccessAllAccounts,  @tValidAccountNumber                    output,  @tActive                                output,  @IO_sClearingAccountType                output,  @sAccountCategory             output,  @IO_sClearingFixedOrVariable            output,  @IO_sClearingBalForCal                  output,  @IO_sClearingPostingType                output,   @IO_sClearingDecimalPlaces              output,   @O_iErrorState                          output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if @iStatus <> 0 or @O_iErrorState <> 0  break  end  else  begin  select   @tValidAccountNumber    = @TRUE,  @tActive                        = @TRUE  end    if @tValidAccountNumber <> @TRUE  begin  select @IO_bOffsetMessages = (@IO_bOffsetMessages | @MS_ITEM_18)  end  else  begin  if @tActive <> @TRUE  select @IO_bOffsetMessages = (@IO_bOffsetMessages | @MS_ITEM_19)  else   begin  if @IO_sOffsetAccountType = @POST_ACCT  or  @IO_sOffsetAccountType = @POST_ALLOC_ACCT  begin   if @IO_sClearingAccountType <> @POST_ACCT  select @IO_bOffsetMessages = (@IO_bOffsetMessages | @MS_ITEM_20)  end  else   begin  if @IO_sClearingAccountType <> @UNIT_ACCT  select @IO_bOffsetMessages = (@IO_bOffsetMessages | @MS_ITEM_20)  end  end     if @IO_sOffsetAccountType <>  @POST_ACCT                and  @IO_sOffsetAccountType <>  @UNIT_ACCT                        and  @IO_sOffsetAccountType <>  @POST_ALLOC_ACCT  and   @IO_sOffsetAccountType <>  @UNIT_ALLOC_ACCT   begin  select @IO_bOffsetMessages = (@IO_bOffsetMessages | @MS_ITEM_18)  end    if @IO_sOffsetAccountType = @POST_ALLOC_ACCT    or  @IO_sOffsetAccountType = @UNIT_ALLOC_ACCT   begin  if @IO_sOffsetFixedOrVariable <> @FIXED and  @IO_sOffsetFixedOrVariable   <> @VARIABLE  begin  select @IO_bOffsetMessages = (@IO_bOffsetMessages | @MS_ITEM_18)  end   end    if @IO_sOffsetAccountType = @POST_ACCT and   (@IO_sOffsetPostingType <> @BAL_SHEET and  @IO_sOffsetPostingType <> @PROFIT_AND_LOSS)  begin  select @IO_bOffsetMessages = (@IO_bOffsetMessages | @MS_ITEM_18)  end    end   end   if @IO_bOffsetMessages & @MS_ITEM_1 = @MS_ITEM_1  select @IO_sClearingAccountType = @POST_ACCT  if @IO_bOffsetMessages & @MS_ITEM_18 = @MS_ITEM_18  select @IO_sOffsetAccountType = @POST_ACCT  if @iStatus <> 0 or @O_iErrorState <> 0 begin  if @tTransaction = 1  rollback transaction  end else if @tTransaction = 1  commit transaction  return (@iStatus)    
GO
GRANT EXECUTE ON  [dbo].[glpVerifyClearingAccounts] TO [DYNGRP]
GO
