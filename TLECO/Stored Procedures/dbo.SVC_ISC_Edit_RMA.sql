SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE Procedure [dbo].[SVC_ISC_Edit_RMA]  (   @RETDOCID char(15) = NULL,  @custnmbr varchar(15) = NULL,   @LNSEQNBR numeric(19,5) = 0,  @adrscode char(15),  @address1 varchar(31) = NULL,  @address2 varchar(31) = NULL,  @city varchar(31) = NULL,  @state varchar(30) = NULL,  @zipcode varchar(11) = NULL,  @contact varchar(31) = NULL,  @equipid integer ,  @serial varchar(31) ,  @item varchar(31) = NULL,  @QTY numeric(19,5),  @NTEPRICE numeric(19,5) = 0,  @txtfield text = '',  @RETTYPE char(11) = NULL ,  @Reason char(3) = NULL,  @ReasonDesc char(31) = NULL,  @Origin smallint ,  @OriginID  char (31) = NULL,  @POAUTH char(31)= NULL,  @address3 varchar(31) = NULL  ) As declare @noteindx numeric(19,5) declare @country varchar(21) declare @UserID varchar(20) declare @RMA_Status int declare @description varchar(100) declare @rqstdte datetime declare @rqsttme datetime declare @UofM char(10)   declare @adrscodeACV char(15),  @address1ACV varchar(31),  @address2ACV varchar(31),  @cityACV varchar(31),  @stateACV varchar(30),  @zipcodeACV varchar(11),  @contactACV varchar(31),  @equipidACV integer,  @serialACV varchar(31),  @itemACV varchar(31),  @QTYACV numeric(19,5),  @NTEPRICEACV numeric(19,5),  @RETTYPEACV char(11),  @ReasonACV char(3),  @ReasonDescACV char(31),  @OriginACV smallint ,  @OriginIDACV  char (31),  @POAUTHACV char(31),  @address3ACV varchar(31)  select @UserID = INET5 from SY01200 where ((Master_Type = 'CUS') and(RTRIM(Master_ID) = @custnmbr) and (RTRIM(ADRSCODE) = @adrscode)) if (@UserID is NULL) or (@UserID = '')or (@UserID = ' ')  select @UserID ='DSC' select @RMA_Status = RMA_Status from SVC05200 where RETDOCID = @RETDOCID and  LNSEQNBR = @LNSEQNBR  select  @address1ACV=ADDRESS1,@address2ACV=ADDRESS2,@address3ACV=ADDRESS3,@cityACV=CITY,  @stateACV=STATE,@zipcodeACV=ZIPCODE,@contactACV=CONTACT,  @itemACV=ITEMNMBR,@QTYACV=QUANTITY,  @NTEPRICEACV=NTE_Price,@OriginIDACV=RETREF,@RETTYPEACV=RETTYPE,@OriginACV=RETORIG,  @adrscodeACV=ADRSCODE,@POAUTHACV=CSTPONBR,@ReasonACV=SVC_RMA_Reason_Code,  @ReasonDescACV=SVC_RMA_Reason_Code_Desc   from SVC05200 where RETDOCID = @RETDOCID and LNSEQNBR = @LNSEQNBR  if @address1ACV <> @address1  begin  select @description = 'Changed RMA from eReturns: Address1 from ' + rtrim(@address1ACV) + ' to ' + rtrim(@address1)  exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end if @address2ACV <> @address2  begin  select @description = 'Changed RMA from eReturns: Address2 from ' + rtrim(@address2ACV) + ' to ' + rtrim(@address2)  exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end if @address3ACV <> @address3  begin  select @description = 'Changed RMA from eReturns: Address3 from ' + rtrim(@address3ACV) + ' to ' + rtrim(@address3)  exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end if @cityACV <> @city  begin  select @description = 'Changed RMA from eReturns: City from ' + rtrim(@cityACV) + ' to ' + rtrim(@city)   exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end if @stateACV <> @state  begin  select @description = 'Changed RMA from eReturns: State from ' + rtrim(@stateACV) + ' to ' + rtrim(@state)  exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end if @zipcodeACV <> @zipcode  begin  select @description = 'Changed RMA from eReturns: Zip Code from ' + rtrim(@zipcodeACV) + ' to ' + rtrim(@zipcode)  exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID   end if @contactACV <> @contact  begin  select @description = 'Changed RMA from eReturns: Contact from ' + rtrim(@contactACV) + ' to ' + rtrim(@contact)  exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end if @equipidACV <> @equipid  begin  select @description = 'Changed RMA from eReturns: Equipment ID from ' + rtrim(@equipidACV) + ' to ' + rtrim(@equipid)   exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end if @itemACV <> @item  begin  select @description = 'Changed RMA from eReturns: Item from ' + rtrim(@itemACV) + ' to ' + rtrim(@item)  exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end if @serialACV <> @serial  begin  select @description = 'Changed RMA from eReturns: Serial from ' + rtrim(@serialACV) + ' to ' + rtrim(@serial)  exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end if @QTYACV <> @QTY  begin  select @description = 'Changed RMA from eReturns: Quantity from ' + rtrim(cast(@QTYACV as char(5))) + ' to ' + rtrim(cast(@QTY as char(5)))  exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end if @NTEPRICEACV <> @NTEPRICE  begin  select @description = 'Changed RMA from eReturns: NTE Price from ' + rtrim(cast(@NTEPRICEACV as char(8))) + ' to ' + rtrim(cast(@NTEPRICE as char(8)))  exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end if @OriginIDACV <> @OriginID  begin  select @description = 'Changed RMA from eReturns: Origin ID from ' + rtrim(@OriginIDACV) + ' to ' + rtrim(@OriginID)  exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end if @RETTYPEACV <> @RETTYPE  begin  select @description = 'Changed RMA from eReturns: Return Type from ' + rtrim(@RETTYPEACV) + ' to ' + rtrim(@RETTYPE)  exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end  if @OriginACV <> @Origin  begin  select @description = 'Changed RMA from eReturns: Origin from ' + rtrim(cast(@OriginACV as char(2))) + ' to ' + rtrim(cast(@Origin as char(2)))  exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end if @adrscodeACV <> @adrscode  begin  select @description = 'Changed RMA from eReturns: Address Code from ' + rtrim(@adrscodeACV) + ' to ' + rtrim(@adrscode)  exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end if @POAUTHACV <> @POAUTH  begin  select @description = 'Changed RMA from eReturns: PO Authorization from ' + rtrim(@POAUTHACV) + ' to ' + rtrim(@POAUTH)  exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end  if @ReasonACV <> @Reason  begin  select @description = 'Changed RMA from eReturns: Reason Code from ' + rtrim(@ReasonACV) + ' to ' + rtrim(@Reason)  exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end if @ReasonDescACV <> @ReasonDesc  begin   select @description = 'Changed RMA from eReturns: Reason Code Description from ' + rtrim(@ReasonDescACV) + ' to ' + rtrim(@ReasonDesc)  exec SVC_Create_RMA_Audit  @RETDOCID,@LNSEQNBR,'',@RMA_Status, @description,@UserID  end  set nocount on begin transaction select  @noteindx = NOTEINDX from SVC05200 where  SVC05200.RETDOCID = @RETDOCID and  SVC05200.LNSEQNBR = @LNSEQNBR exec SVC_UpdateTextObject @noteindx OUTPUT, NULL,NULL, @txtfield  SELECT @UofM = IV40201.UOMSCHDL from IV40201 left join IV00101 on IV40201.UOMSCHDL = IV00101.UOMSCHDL  where IV00101.ITEMNMBR = @item  update SVC05000   set  SVC05000.RETORIG = isnull(@Origin ,''),  SVC05000.RETREF = isnull(@OriginID,'')  where  SVC05000.RETDOCID = @RETDOCID   update SVC05200   set  SVC05200.ADRSCODE = IsNull(@adrscode,''),  SVC05200.ADDRESS1 = IsNull(@address1,''),  SVC05200.ADDRESS2 = IsNull(@address2,''),  SVC05200.ADDRESS3 = IsNull(@address3,''),  SVC05200.CITY = IsNull(@city,''),  SVC05200.STATE = IsNull(@state,''),  SVC05200.ZIPCODE = IsNull(@zipcode,''),  SVC05200.CONTACT = IsNull(@contact,''),  SVC05200.ITEMNMBR = @item,  SVC05200.QUANTITY = @QTY,  SVC05200.NTE_Price =@NTEPRICE,  SVC05200.Originating_NTE_Price = @NTEPRICE,   SVC05200.NOTEINDX = @noteindx,  SVC05200.RETTYPE =  isnull(@RETTYPE,''),  SVC05200.SVC_RMA_Reason_Code = isnull(@Reason,''),  SVC05200.SVC_RMA_Reason_Code_Desc =  isnull(@ReasonDesc,''),  SVC05200.RETORIG = isnull(@Origin ,''),  SVC05200.RETREF = isnull(@OriginID,''),  SVC05200.CSTPONBR =isnull( @POAUTH,'')  where  SVC05200.RETDOCID = @RETDOCID and  SVC05200.LNSEQNBR = @LNSEQNBR  update SVC05255 set SVC05255.Return_Serial_Number = @serial, SVC05255.Return_Equipment_ID = @equipid where  SVC05255.RETDOCID = @RETDOCID and  SVC05255.LNSEQNBR = @LNSEQNBR  commit transaction return   
GO
GRANT EXECUTE ON  [dbo].[SVC_ISC_Edit_RMA] TO [DYNGRP]
GO
