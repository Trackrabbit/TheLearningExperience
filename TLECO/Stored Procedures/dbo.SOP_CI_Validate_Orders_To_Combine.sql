SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create  PROCEDURE [dbo].[SOP_CI_Validate_Orders_To_Combine]   @TableName VARCHAR (50) ,  @MaxIndexNumber integer output  AS   declare  @ExecString nvarchar (4000),  @MaxCountParam nvarchar(500),  @Maxindex INTEGER  select @ExecString = 'UPDATE ['+ @TableName +']   SET ['+ @TableName +'].INDEX1= E.RANK1   FROM   (select D.CUSTNMBR,  C.PRBTADCD,   C.CURNCYID,   C.PYMTRMID,   C.EXGTBLID,   C.XCHGRATE,   C.RATETPID,   C.COMAPPTO,  C.SOPTYPE,  RANK() OVER (PARTITION BY A.RANK1   ORDER BY C.CUSTNMBR,  C.PRBTADCD,   C.CURNCYID,   C.PYMTRMID,   C.EXGTBLID,   C.XCHGRATE,   C.RATETPID,   C.COMAPPTO,  C.SOPTYPE  ) AS RANK1  FROM   (SELECT B.SOPTYPE, ['+ @TableName +'].CUSTNMBR,  B.PRBTADCD,   B.CURNCYID,   B.PYMTRMID,   B.EXGTBLID,   B.XCHGRATE,   B.RATETPID,   B.COMAPPTO,  1 RANK1  FROM ['+ @TableName +']   INNER JOIN SOP10100 B ON   ['+ @TableName +'].SOPNUMBE = B.SOPNUMBE   AND ['+ @TableName +'].SOPTYPE = B.SOPTYPE   WHERE ['+ @TableName +'].MKTOPROC = 1   GROUP BY   ['+ @TableName +'].CUSTNMBR,   B.PRBTADCD,   B.CURNCYID,   B.PYMTRMID,   B.EXGTBLID,   B.XCHGRATE,   B.RATETPID,   B.COMAPPTO,  B.SOPTYPE) A   INNER JOIN SOP10100 C ON   A.SOPTYPE = C.SOPTYPE   INNER JOIN ['+ @TableName +'] D ON   C.SOPNUMBE = D.SOPNUMBE   AND C.SOPTYPE = D.SOPTYPE   AND D.MKTOPROC = 1   WHERE C.CUSTNMBR= A.CUSTNMBR  AND C.PRBTADCD = A.PRBTADCD   AND C.CURNCYID=A.CURNCYID   AND C.PYMTRMID=A.PYMTRMID   AND C.EXGTBLID=A.EXGTBLID   AND C.XCHGRATE=A.XCHGRATE   AND C.RATETPID=A.RATETPID   AND C.COMAPPTO=A.COMAPPTO) E  INNER JOIN SOP10100 H ON   E.SOPTYPE = H.SOPTYPE   INNER JOIN ['+ @TableName +'] F ON   H.SOPNUMBE = F.SOPNUMBE and H.SOPTYPE = F.SOPTYPE AND F.MKTOPROC = 1   WHERE   H.CUSTNMBR= E.CUSTNMBR  AND H.PRBTADCD = E.PRBTADCD   AND H.CURNCYID=E.CURNCYID   AND H.PYMTRMID=E.PYMTRMID   AND H.EXGTBLID=E.EXGTBLID   AND H.XCHGRATE=E.XCHGRATE   AND H.RATETPID=E.RATETPID   AND H.COMAPPTO=E.COMAPPTO' EXEC ( @ExecString ) select @ExecString =  'SELECT *,0 as FLAG   INTO [#TEMP]   FROM ['+ @TableName +']   order by DEX_ROW_ID  DECLARE  @INDEX1 INT,   @Count INT ,   @a1 varchar(30)  SET @Count = 0  DECLARE Cur_Group cursor FAST_FORWARD FOR   select DISTINCT INDEX1,   (SELECT TOP 1 SOPNUMBE   FROM [#TEMP]   WHERE [#TEMP].INDEX1=A.INDEX1   ORDER BY [#TEMP].SOPNUMBE) Numbe   from [#TEMP] A   ORDER BY  Numbe   OPEN Cur_Group   FETCH NEXT FROM Cur_Group INTO @INDEX1 ,@a1  WHILE @@FETCH_STATUS = 0   BEGIN   SET @Count=@Count+1  BEGIN TRY   Update [#TEMP]   set INDEX1=@Count,  FLAG=1   where INDEX1=@INDEX1 and FLAG=0   END TRY   BEGIN CATCH   SELECT ERROR_MESSAGE() AS ErrorMessage   END CATCH   FETCH NEXT FROM Cur_Group INTO @INDEX1 ,@a1  END   DEALLOCATE Cur_Group   UPDATE ['+ @TableName +']   SET ['+ @TableName +'].INDEX1 = [#TEMP].INDEX1   FROM [#TEMP]   INNER JOIN ['+ @TableName +']   ON   ['+ @TableName +'].SOPNUMBE = [#TEMP].SOPNUMBE  DROP TABLE [#TEMP]'  EXEC ( @ExecString )  SELECT @ExecString = ' SELECT @MaxCount = Max(INDEX1)  FROM [' + @TableName + ']' set @MaxCountParam = N'@MaxCount int output'  EXEC sp_executesql  @ExecString,   @MaxCountParam,   @MaxCount= @Maxindex output set @MaxIndexNumber=@Maxindex    
GO
GRANT EXECUTE ON  [dbo].[SOP_CI_Validate_Orders_To_Combine] TO [DYNGRP]
GO
