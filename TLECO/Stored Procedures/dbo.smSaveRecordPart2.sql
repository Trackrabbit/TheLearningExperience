SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[smSaveRecordPart2] @I_cSourceCompanyName char(64) = NULL, @I_sCompanyID smallint = NULL, @I_tControlUser tinyint = NULL, @O_iErrorState int = NULL output  as  declare @tTransaction tinyint,  @sSourceCompanyID smallint,  @iCount int,  @iError int,  @iStatus int,  @cUserID char(15),  @cMasterOwner char(30),  @cDynamicsOwner char(30),  @TRUE tinyint,  @cNewUser varchar(15)  if  (@I_cSourceCompanyName is NULL or  @I_sCompanyID is NULL or  @I_tControlUser is NULL) begin  select @O_iErrorState = 20098  return end else begin  select @O_iErrorState = 0 end  create table #USERID (  USERID char(15) not null )  exec @iStatus = DYNAMICS.dbo.smGetConstantInt  'TRUE',  @TRUE output,  @O_iErrorState output  select @iError = @@error if @iStatus = 0 and @iError <> 0 begin  select @iStatus = @iError end  if (@iStatus <> 0 or @O_iErrorState <> 0) begin  return @iStatus end  select   @cMasterOwner = master.dbo.syslogins.name  from   master.dbo.syslogins,master.dbo.sysdatabases  where   master.dbo.sysdatabases.sid = master.dbo.syslogins.sid  and  master.dbo.sysdatabases.name = 'master'  select   @cDynamicsOwner = master.dbo.syslogins.name  from   master.dbo.syslogins,master.dbo.sysdatabases  where   master.dbo.sysdatabases.sid = master.dbo.syslogins.sid  and  master.dbo.sysdatabases.name = (select DBNAME from SY00100)  select  @sSourceCompanyID = CMPANYID from  DYNAMICS.dbo.SY01500 where  CMPNYNAM = @I_cSourceCompanyName  if (@@rowcount <> 1) begin  select @O_iErrorState = 20251  return end  select @iCount = (select  count(CMPANYID)  from  DYNAMICS.dbo.SY60100 left outer join DYNAMICS.dbo.SY01400 on (SY60100.USERID = SY01400.USERID)  where  CMPANYID = @sSourceCompanyID and  SY60100.USERID <> @cMasterOwner and  SY60100.USERID <> @cDynamicsOwner and  (UserStatus = 1 or UserStatus = 2) )  insert into  DYNAMICS.dbo.SY60100  (TRKUSER,  USERID,  CMPANYID,  SRBCHSEC_1,  SRBCHSEC_2,  SRBCHSEC_3,  SRBCHSEC_4,  SRBCHSEC_5,  SRBCHSEC_6,  SRBCHSEC_7,  SRSFNSEC_1,  SRSFNSEC_2,  SRSFNSEC_3,  SRSFNSEC_4,  SRSFNSEC_5,  SRSFNSEC_6,  SRSFNSEC_7,  MSCPRMIS) select  TRKUSER,  SY60100.USERID,  @I_sCompanyID,  SRBCHSEC_1,  SRBCHSEC_2,   SRBCHSEC_3,   SRBCHSEC_4,   SRBCHSEC_5,   SRBCHSEC_6,   SRBCHSEC_7,   SRSFNSEC_1,   SRSFNSEC_2,   SRSFNSEC_3,   SRSFNSEC_4,   SRSFNSEC_5,   SRSFNSEC_6,   SRSFNSEC_7,   MSCPRMIS from  DYNAMICS.dbo.SY60100 left outer join DYNAMICS.dbo.SY01400 on (SY60100.USERID = SY01400.USERID) where  CMPANYID = @sSourceCompanyID and  SY60100.USERID <> @cMasterOwner and  SY60100.USERID <> @cDynamicsOwner and  (UserStatus = 1 or UserStatus = 2)  if (@@rowcount <> @iCount) begin   select @O_iErrorState = 20252  return end  set rowcount 0  select   @iCount = count(CMPANYID) from  DYNAMICS.dbo.SY10500 left outer join DYNAMICS.dbo.SY01400 on (SY10500.USERID = SY01400.USERID) where  CMPANYID = @sSourceCompanyID and  SY10500.USERID <> @cMasterOwner and  SY10500.USERID <> @cDynamicsOwner and  (UserStatus = 1 or UserStatus = 2)   insert into  DYNAMICS.dbo.SY10500 select  SY10500.USERID,  @I_sCompanyID,  SECURITYROLEID from  DYNAMICS.dbo.SY10500 left outer join DYNAMICS.dbo.SY01400 on (SY10500.USERID = SY01400.USERID) where  CMPANYID = @sSourceCompanyID and  SY10500.USERID <> @cMasterOwner and  SY10500.USERID <> @cDynamicsOwner and  (UserStatus = 1 or UserStatus = 2)   if (@@rowcount <> @iCount) begin   select @O_iErrorState = 21100  return end  select   @iCount = count(CMPANYID) from  DYNAMICS.dbo.SY10550 left outer join DYNAMICS.dbo.SY01400 on (SY10550.USERID = SY01400.USERID) where  CMPANYID = @sSourceCompanyID and  SY10550.USERID <> @cMasterOwner and  SY10550.USERID <> @cDynamicsOwner and  (UserStatus = 1 or UserStatus = 2)   insert into  DYNAMICS.dbo.SY10550 select  SY10550.USERID,  @I_sCompanyID,  SECMODALTID from  DYNAMICS.dbo.SY10550 left outer join DYNAMICS.dbo.SY01400 on (SY10550.USERID = SY01400.USERID) where  CMPANYID = @sSourceCompanyID and  SY10550.USERID <> @cMasterOwner and  SY10550.USERID <> @cDynamicsOwner and  (UserStatus = 1 or UserStatus = 2)   if (@@rowcount <> @iCount) begin   select @O_iErrorState = 21101  return end  select   @iCount = count(CMPANYID) from  DYNAMICS.dbo.SY01900 left outer join DYNAMICS.dbo.SY01400 on (SY01900.USERID = SY01400.USERID) where  CMPANYID = @sSourceCompanyID and  (UserStatus = 1 or UserStatus = 2)   insert into  DYNAMICS.dbo.SY01900 select  @I_sCompanyID,  SY01900.USERID,  REPORTID from  DYNAMICS.dbo.SY01900 left outer join DYNAMICS.dbo.SY01400 on (SY01900.USERID = SY01400.USERID) where  CMPANYID = @sSourceCompanyID and  (UserStatus = 1 or UserStatus = 2)   if (@@rowcount <> @iCount) begin   select @O_iErrorState = 20254  return end  return    
GO
GRANT EXECUTE ON  [dbo].[smSaveRecordPart2] TO [DYNGRP]
GO
