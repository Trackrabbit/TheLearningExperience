SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[wfValidate]  @Action smallint,   @WorkflowStepInstanceID char(37),   @Workflow_User char(85),   @Delegate_User_GUID char(37),   @Workflow_Error int OUTPUT,  @Workflow_Name char(51) OUTPUT,  @Workflow_Step_Name char(51) OUTPUT,  @Workflow_Document char(85) OUTPUT,  @Workflow_Step_Status smallint OUTPUT AS  BEGIN  declare @WorkflowInstanceID char(37), @Workflow_Managers char(37) declare @Workflow_Originator char(238) declare @WF_AllowOrigApprover tinyint declare @Workflow_Step_Type smallint, @location smallint declare @WfBusObjKey char(201) declare @character_location integer declare @Delegate_Users char(85) declare @Workflow_Type_Name char(51) declare @Workflow_Version int declare @CMPANYID nvarchar(6) declare @server_name nvarchar(128)  declare @SystemDB nvarchar(11) declare @UserIsManager tinyint  declare @Workflow_Action_1 tinyint,  @Workflow_Action_2 tinyint,  @Workflow_Action_3 tinyint,  @Workflow_Action_4 tinyint,  @Workflow_Action_5 tinyint,  @Workflow_Action_6 tinyint,  @Workflow_Action_7 tinyint,  @Workflow_Action_8 tinyint,  @Workflow_Action_9 tinyint,  @Workflow_Action_10 tinyint,  @Single_Action_Available tinyint  select @WorkflowStepInstanceID=UPPER(@WorkflowStepInstanceID) select @Delegate_User_GUID=UPPER(@Delegate_User_GUID) select @Workflow_User=UPPER(@Workflow_User)  select @SystemDB = (select top 1 DBNAME from SY00100) select @server_name=@@SERVERNAME  select @CMPANYID=DB_NAME()  select @Workflow_Error=0, @UserIsManager=0  select @Workflow_Step_Status=Workflow_Step_Status, @Workflow_Step_Type=Workflow_Step_Type,  @Workflow_Name=Workflow_Name, @Workflow_Version=Workflow_Version,  @Workflow_Step_Name=Workflow_Step_Name, @WorkflowInstanceID=WorkflowInstanceID  from WFI10003 where WorkflowStepInstanceID=@WorkflowStepInstanceID select @WorkflowInstanceID=ISNULL(@WorkflowInstanceID,'') select @Workflow_Type_Name=Workflow_Type_Name,@WfBusObjKey=WfBusObjKey from WFI10002 where WorkflowInstanceID=@WorkflowInstanceID select @Workflow_Type_Name=ISNULL(@Workflow_Type_Name,'') select @WfBusObjKey=ISNULL(@WfBusObjKey,'')  if @WorkflowStepInstanceID<>'' begin  exec wfAllowableActions @Workflow_Type_Name, @WfBusObjKey, @WorkflowInstanceID,   @WorkflowStepInstanceID, @Workflow_User, 0,  0,   @Workflow_Action_1 OUTPUT, @Workflow_Action_2 OUTPUT, @Workflow_Action_3 OUTPUT,   @Workflow_Action_4 OUTPUT, @Workflow_Action_5 OUTPUT, @Workflow_Action_6 OUTPUT,   @Workflow_Action_7 OUTPUT, @Workflow_Action_8 OUTPUT, @Workflow_Action_9 OUTPUT,   @Workflow_Action_10 OUTPUT, @Single_Action_Available OUTPUT, @Workflow_Error OUTPUT   if (@Action=1 and @Workflow_Action_1=0) or  (@Action=2 and @Workflow_Action_2=0) or  (@Action=3 and @Workflow_Action_3=0) or  (@Action=4 and @Workflow_Action_4=0) or  (@Action=5 and @Workflow_Action_5=0) or  (@Action=6 and @Workflow_Action_6=0) or  (@Action=7 and @Workflow_Action_7=0) or  (@Action=8 and @Workflow_Action_8=0)  begin  select @Workflow_Error=104  RETURN  end end  select @character_location= charindex('~',@WfBusObjKey)  if @character_location=0  begin   select @Workflow_Document = rtrim(@WfBusObjKey)  end else  begin   select @Workflow_Document = SUBSTRING(@WfBusObjKey,1,(@character_location-1))  end  if @Workflow_Step_Status<>2  begin  select @Workflow_Error=100  RETURN   end  if (@WorkflowInstanceID<>'' and (select COUNT(WorkflowInstanceID) from WFI10002 where WorkflowInstanceID=@WorkflowInstanceID)=0) or  (@WorkflowStepInstanceID<>'' and (select COUNT(WorkflowStepInstanceID) from WFI10003 where WorkflowStepInstanceID=@WorkflowStepInstanceID)=0)  begin  select @Workflow_Error=101  RETURN  end  if @Action=6   begin  select @Workflow_Originator=Workflow_Originator, @WF_AllowOrigApprover=WF_AllowOrigApprover  from WFI10002 where WorkflowInstanceID=@WorkflowInstanceID  if @WF_AllowOrigApprover=0  begin  delete from WFI10005 where Workflow_User=@Workflow_User  exec DYNAMICS.dbo.GetAssignedUsers   @Workflow_User,  @Delegate_User_GUID,  @Workflow_Type_Name,  @Workflow_Name,  @Workflow_Version,  @WorkflowInstanceID,  @Workflow_Step_Name,  @WorkflowStepInstanceID,  @server_name,  @CMPANYID,  @SystemDB  delete from WFI10005 where UPPER(Workflow_User)=@Workflow_User   and UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID and UsersListGuid=''   if (select COUNT(*) from WFI10005   where Workflow_User=@Workflow_User  and UsersListGuid=@Delegate_User_GUID   and WorkflowStepInstanceID=@WorkflowStepInstanceID  and RTRIM(@Delegate_Users)=RTRIM(@Workflow_Originator))>0  begin  delete from WFI10005 where Workflow_User=@Workflow_User  select @Workflow_Error=102  RETURN  end   delete from WFI10005 where Workflow_User=@Workflow_User   end  end  if @WorkflowStepInstanceID<>'' and  (select COUNT(WorkflowStepInstanceID) from WFI10004 where WorkflowStepInstanceID=@WorkflowStepInstanceID  and UPPER(rtrim(WorkflowTaskAssignedTo))=RTRIM(@Workflow_User))=0  begin  if @Action<>7   begin  select @Workflow_Managers=UPPER(Workflow_Managers) from WF100001 where Workflow_Type_Name = @Workflow_Type_Name   if @Workflow_Managers<>''   begin  if @Workflow_Name<>'' and @Workflow_Step_Name<>''  begin  delete from WFI10005 where Workflow_User=@Workflow_User  exec DYNAMICS.dbo.GetAssignedUsers  @Workflow_User,  @Workflow_Managers,  @Workflow_Type_Name,  @Workflow_Name,  @Workflow_Version,  @WorkflowInstanceID,  @Workflow_Step_Name,  @WorkflowStepInstanceID,  @server_name,  @CMPANYID,  @SystemDB   delete from WFI10005 where UPPER(Workflow_User)=@Workflow_User   and UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID and UsersListGuid=''   if (select COUNT(UsersListGuid) from WFI10005   where UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID and UPPER(UsersListGuid)=@Workflow_Managers   and upper(WorkflowTaskAssignedTo)=@Workflow_User and Workflow_User=@Workflow_User)>0  begin  select @UserIsManager=1  end  delete from WFI10005 where Workflow_User=@Workflow_User  end  end   if @UserIsManager=0  begin  select @Workflow_Error=103  end  RETURN  end   end  if @Action=3  and @Workflow_Step_Type=2   begin  select @Workflow_Error=104  RETURN  end  if @Action=4  and @Workflow_Step_Type=1   begin  select @Workflow_Error=104  RETURN  end  if @Action=1   begin  if (select count(WorkflowInstanceID) from WFI10002 where Workflow_Type_Name=@Workflow_Type_Name  and WfBusObjKey=@WfBusObjKey)>0  begin  select @Workflow_Error=105  RETURN  end  end  END   
GO
GRANT EXECUTE ON  [dbo].[wfValidate] TO [DYNGRP]
GO
