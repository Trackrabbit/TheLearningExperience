SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 Create Procedure [dbo].[svcRMASetKitItemLineStatus] (@RMANumber char(15),  @RMALine numeric(19,5)) as declare @EntryStatus char(3),  @ReceivedStatus char(3),  @DiscpStatus char(3),  @PartialReceivedStatus char(3),  @ReadyToCloseStatus char(3),  @ClosedStatus char(3),  @HeaderStatus char(3),  @RMAStatus int,  @ClosedDate datetime,  @ClosedTime datetime,  @ClosedDateTime datetime,  @ReturnDateTime datetime,  @ReturnDate datetime,  @ReturnTime datetime,  @Received tinyint,  @RecType smallint,  @MinDate datetime declare @CMPNTSEQ int   if not exists(select * from SVC05200 where RETDOCID = @RMANumber and LNSEQNBR = @RMALine and svcRMAComponentSeq > 0 ) return exec smGetMinDate @MinDate output  select @EntryStatus = SVC05501.RETSTAT, @ReceivedStatus = SVC05501.Received_Status,   @PartialReceivedStatus = SVC05501.SVC_Partial_Received_Sta,  @DiscpStatus = SVC_Discrepancy_Status, @ClosedStatus = Close_Status,  @ReadyToCloseStatus = SVC05501.SVC_Ready_To_Close_Statu  from SVC05501 left join SVC05200 on  SVC05200.RETTYPE = SVC05501.RETTYPE where SVC05200.RETDOCID = @RMANumber and LNSEQNBR = @RMALine  if not exists(select * from SVC05200 where RETDOCID = @RMANumber and LNSEQNBR = @RMALine and svcRMAComponentSeq > 0 and Received = 0)  begin   select @RMAStatus = max(RMA_Status), @RecType = min(Return_Record_Type), @RMAStatus = min(RMA_Status), @RecType = min(Return_Record_Type),   @ClosedDateTime = max(dateadd(Minute,datepart(Minute,COMPTME),dateadd(Hour,datepart(Hour,COMPTME),COMPDTE))),   @ReturnDateTime = max(dateadd(Minute,datepart(Minute,Return_Time),dateadd(Hour,datepart(Hour,Return_Time),RETUDATE)))  from SVC05200 where RETDOCID = @RMANumber and LNSEQNBR = @RMALine and svcRMAComponentSeq <> 0  exec SVC_util_split_datetime @ReturnDateTime, @ReturnDate output, @ReturnTime output  exec SVC_util_split_datetime @ClosedDateTime, @ClosedDate output, @ClosedTime output   update SVC05200 with (rowlock) set Received = 1, RETSTAT = @ReceivedStatus, RMA_Status = @RMAStatus,  RETUDATE = isnull(@ReturnDate, @MinDate), Return_Time = isnull(@ReturnTime, @MinDate)  where RETDOCID = @RMANumber and LNSEQNBR = @RMALine and svcRMAComponentSeq = 0  end  return    
GO
GRANT EXECUTE ON  [dbo].[svcRMASetKitItemLineStatus] TO [DYNGRP]
GO
