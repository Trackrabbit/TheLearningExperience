SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE Procedure [dbo].[SVC_Labor_Minimum_Rounded]  (@CallNumber char(11),  @UseType char(2),@Item char(31),@ServiceType char(10),  @STARTDATE datetime, @STARTTIME datetime, @ENDDATE datetime, @ENDTIME datetime, @billable_time numeric(10,2) output) As declare @StartDateTime datetime declare @EndDateTime datetime declare @LaborItem char(31) declare @MinimumTime char(5) declare @RoundedTime char(5) declare @timediff integer declare @minimum_billable_time numeric(10,2)  declare @rounded_billable_time numeric(10,2)  set nocount on  exec SVC_util_combine_date_time @STARTDATE, @STARTTIME, @StartDateTime OUTPUT exec SVC_util_combine_date_time @ENDDATE, @ENDTIME, @EndDateTime OUTPUT select @timediff = DATEDIFF(n,@StartDateTime,@EndDateTime) select @LaborItem =   case   when @UseType =  'L' then LABITMST  when @UseType =  'T' then Travel_Labor_Item  when @UseType = 'H' then Hotline_Labor_Item  end,  @MinimumTime =   case   when @UseType =  'L' then SVC_Minimum_Labor  when @UseType =  'T' then SVC_Minimum_Travel  when @UseType = 'H' then SVC_Minimum_Hotline  end,  @RoundedTime =   case  when @UseType =  'L' then SVC_Rounded_Labor  when @UseType =  'T' then SVC_Rounded_Travel  when @UseType = 'H' then SVC_Rounded_Hotline  end  from SVC00920 where SRVTYPE = @ServiceType select @minimum_billable_time = 60*(@MinimumTime/100) + substring(@MinimumTime,4,2) select @rounded_billable_time = 60*(@RoundedTime/100) + substring(@RoundedTime,4,2) if @minimum_billable_time = 0 and @rounded_billable_time = 0  BEGIN  select @billable_time = @timediff  return (0)  END  if exists(select * FROM SVC00203  WHERE  SRVRECTYPE = 2 and  CALLNBR = @CallNumber  and LINITMTYP='L' and ITEMUSETYPE=@UseType and ITEMNMBR = @Item) BEGIN  if @rounded_billable_time = 0  select @billable_time = @timediff  else  select @billable_time = CEILING(@timediff/@rounded_billable_time) * @rounded_billable_time END  else  BEGIN  if @minimum_billable_time = 0 or  @Item <> @LaborItem  BEGIN  if @rounded_billable_time = 0  select @billable_time = @timediff  else  select @billable_time = CEILING(@timediff/@rounded_billable_time) * @rounded_billable_time  return (0)  END  if @timediff < @minimum_billable_time  select @billable_time = @minimum_billable_time  else  BEGIN  select @billable_time = @timediff  if @rounded_billable_time > 0  select @billable_time = CEILING(@billable_time/@rounded_billable_time) * @rounded_billable_time  END END select @EndDateTime = DATEADD(n,@billable_time,@StartDateTime )  return (0)    
GO
GRANT EXECUTE ON  [dbo].[SVC_Labor_Minimum_Rounded] TO [DYNGRP]
GO
