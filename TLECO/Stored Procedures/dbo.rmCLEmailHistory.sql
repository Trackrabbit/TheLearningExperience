SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[rmCLEmailHistory]  @I_cUserID char(15) = NULL,  @I_cFileName1 varchar(40) = NULL,  @I_cSearchString1 char(2)  = NULL,  @O_iErrorState int  = NULL output as  declare  @iError int,   @iStatus int,   @tLoop tinyint,  @RM_MODULE tinyint,  @DYNPROD_ID tinyint  select  @O_iErrorState = 0,  @iStatus  = 0  while (@tLoop is NULL) begin  select @tLoop = 1   if  @I_cUserID is NULL  or @I_cFileName1 is NULL  or @I_cSearchString1 is NULL  begin  select @O_iErrorState = 20846  break  end   exec @iStatus = DYNAMICS.dbo.smGetConstantInt  'RM',  @RM_MODULE output,  @O_iErrorState output   exec @iStatus = DYNAMICS.dbo.smGetConstantInt  'PRODID_DYNAMICS',  @DYNPROD_ID output,  @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   insert into  #CNTRLNUMTEMP(  CNTRLNUM,  DOCTYPE,  VENDORID )  select distinct  DOCNUMBR,  DOCTYPE,  Master_ID from  SY04915 where  DICTRYID = @DYNPROD_ID AND  MODULE1 = @RM_MODULE AND  NOT EXISTS  (select  1  from  RM20101  where  RM20101.DOCNUMBR = SY04915.DOCNUMBR AND  RM20101.RMDTYPAL = SY04915.DOCTYPE)   AND NOT EXISTS  (select  1  from  RM30101  where  RM30101.DOCNUMBR = SY04915.DOCNUMBR AND  RM30101.RMDTYPAL = SY04915.DOCTYPE)   AND NOT EXISTS  (select  1  from  RM10301  where  RM10301.DOCNUMBR = SY04915.DOCNUMBR AND  RM10301.RMDTYPAL = SY04915.DOCTYPE)   if @@rowcount <> 0  begin  delete  SY04915  from  SY04915  where  DICTRYID = @DYNPROD_ID AND  MODULE1 = @RM_MODULE AND  NOT EXISTS  (select  1  from  RM20101  where  RM20101.DOCNUMBR = SY04915.DOCNUMBR AND  RM20101.RMDTYPAL = SY04915.DOCTYPE)  AND NOT EXISTS  (select  1  from  RM30101  where  RM30101.DOCNUMBR = SY04915.DOCNUMBR AND  RM30101.RMDTYPAL = SY04915.DOCTYPE)  AND NOT EXISTS  (select  1  from  RM10301  where  RM10301.DOCNUMBR = SY04915.DOCNUMBR AND  RM10301.RMDTYPAL = SY04915.DOCTYPE)   exec @iStatus = smCreateErrorLogRecord  @I_cUserID,  @I_cFileName1,  @I_cSearchString1,  9755,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  begin  select @iStatus = @iError  end   if @iStatus <> 0 or @O_iErrorState <> 0  begin  return @iStatus  end  end end  return(@iStatus)    
GO
GRANT EXECUTE ON  [dbo].[rmCLEmailHistory] TO [DYNGRP]
GO
