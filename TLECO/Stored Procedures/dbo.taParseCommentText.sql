SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[taParseCommentText]   @I_vCMMTTEXT varchar(500),   @O_COMMENT_1 varchar(250) = '' output,  @O_COMMENT_2 varchar(250) = '' output,  @O_COMMENT_3 varchar(250) = '' output,  @O_COMMENT_4 varchar(250) = '' output   with encryption as  set transaction isolation level read uncommitted set nocount on  declare @LPOS int,  @LPOS1 int,  @LPOS2 int,  @LPOS3 int,  @LPOS4 int,  @CHARINDEX1 int,  @CHARINDEX2 int,  @CHARINDEX3 int,  @CHARINDEX4 int,  @NEWTEXT varchar(200),  @COUNTER int,  @CHAR varchar(1),  @NEWCHAR varchar(1),  @LEN int,  @SpacePos int  select @LPOS = 1,  @CHARINDEX1 = 0,  @NEWTEXT = '',  @COUNTER = 0,  @CHAR = '',  @LEN = 0,  @SpacePos = 0  select @CHARINDEX1 = CHARINDEX(char(13), @I_vCMMTTEXT)  if (@CHARINDEX1 = 0) begin  select @O_COMMENT_1 = (substring(@I_vCMMTTEXT, 1, 60)) end  if ((@CHARINDEX1 > 0) and (@CHARINDEX1 <= 50)) begin  select @O_COMMENT_1 = (substring(@I_vCMMTTEXT, 1, @CHARINDEX1)) end  if (@CHARINDEX1 > 50) begin  select @O_COMMENT_1 = (substring(@I_vCMMTTEXT, 1, @CHARINDEX1)) end  select @LEN = len(@O_COMMENT_1)  if (@LEN > 50) begin  while @COUNTER <= 50  begin  select @CHAR = substring(@I_vCMMTTEXT, @LPOS + @COUNTER, 1)  select @NEWTEXT = @NEWTEXT + @CHAR  select @COUNTER = @COUNTER + 1  end  select @O_COMMENT_1 = @NEWTEXT end  if ((@COUNTER = 51) and ((@CHAR <> ' ') and (@CHAR <> char(13)) and (@CHAR <> char(10)))) begin  select @SpacePos = (CHARINDEX(' ',reverse(@NEWTEXT)))   if (@SpacePos > 0)  begin  select @O_COMMENT_1 = (substring(@NEWTEXT, 1, 51 - @SpacePos))  end end  select @O_COMMENT_1 = replace(@O_COMMENT_1,char(13),'') select @O_COMMENT_1 = replace(@O_COMMENT_1,char(10),'')  if (@CHARINDEX1 = 0) begin  select @LPOS1 = @LPOS + 51 - @SpacePos  select @CHARINDEX2 = CHARINDEX(char(13), substring(@I_vCMMTTEXT, @LPOS1 + 1, 250)) end else if ((@CHARINDEX1 > 0) and (@CHARINDEX1 <= 50)) begin  select @LPOS1 = @CHARINDEX1 + 1 - @SpacePos  select @CHARINDEX2 = CHARINDEX(char(13), substring(@I_vCMMTTEXT, @CHARINDEX1 + 1, 250)) end else begin  select @LPOS1 = @LPOS + 51 - @SpacePos  select @CHARINDEX2 = @CHARINDEX1 - @LPOS1  if (@CHARINDEX2 < 0)  begin  select @CHARINDEX2 = 0  end end  select @COUNTER = 0,  @NEWTEXT = '',  @SpacePos = 0,  @NEWCHAR = substring (@I_vCMMTTEXT, @LPOS1, 1)  if ((@NEWCHAR = ' ') or (@NEWCHAR = char(13)) or (@NEWCHAR = char(10))) begin  select @LPOS1 = @LPOS1 + 1  select @NEWCHAR = substring (@I_vCMMTTEXT, @LPOS1, 1)  if ((@NEWCHAR = char(13)) or (@NEWCHAR = char(10)))  begin  select @LPOS1 = @LPOS1 + 1  end end  if ((@CHARINDEX1 > 0) or (@LEN > 50)) begin  if (@CHARINDEX2 = 0)  begin  select @O_COMMENT_2 = (substring(@I_vCMMTTEXT, @LPOS1, 60))  end   if ((@CHARINDEX2 > 0) and (@CHARINDEX2 <= 50))  begin  select @O_COMMENT_2 = (substring(@I_vCMMTTEXT, @LPOS1, @CHARINDEX2))  end   if (@CHARINDEX2 > 50)  begin  select @O_COMMENT_2 = (substring(@I_vCMMTTEXT, @LPOS1, @CHARINDEX2))  end   select @LEN = len(@O_COMMENT_2)   if (@LEN > 50)  begin  while @COUNTER <= 50  begin  select @CHAR = substring(@I_vCMMTTEXT, @LPOS1 + @COUNTER, 1)  select @NEWTEXT = @NEWTEXT + @CHAR  select @COUNTER = @COUNTER + 1  end  select @O_COMMENT_2 = @NEWTEXT  end   select @O_COMMENT_2 = replace(@O_COMMENT_2,char(13),'')  select @O_COMMENT_2 = replace(@O_COMMENT_2,char(10),'')   if ((@COUNTER = 51) and ((@CHAR <> ' ') and (@CHAR <> char(13)) and (@CHAR <> char(10))))  begin  select @SpacePos = (CHARINDEX(' ',reverse(@NEWTEXT)))   if (@SpacePos > 0)  begin  select @O_COMMENT_2 = (substring(@NEWTEXT, 1, 51 - @SpacePos))  end  end   if (@CHARINDEX2 = 0)  begin  select @LPOS2 = @LPOS1 + 51 - @SpacePos  select @CHARINDEX3 = CHARINDEX(char(13), substring(@I_vCMMTTEXT, @LPOS2 + 1, 250))  end  else  if ((@CHARINDEX2 > 0) and (@CHARINDEX2 <= 50))  begin  select @LPOS2 = @LPOS1 + @CHARINDEX2 - @SpacePos  select @CHARINDEX3 = CHARINDEX(char(13), substring(@I_vCMMTTEXT, @LPOS2 + 1, 250))  end  else  begin  select @LPOS2 = @LPOS1 + 51 - @SpacePos  select @CHARINDEX3 = @CHARINDEX2 - 50 + @SpacePos - 1  end   select @COUNTER = 0,  @NEWTEXT = '',  @SpacePos = 0,  @NEWCHAR = substring (@I_vCMMTTEXT, @LPOS2, 1)   if ((@NEWCHAR = ' ') or (@NEWCHAR = char(13)) or (@NEWCHAR = char(10)))  begin  select @LPOS2 = @LPOS2 + 1  select @NEWCHAR = substring (@I_vCMMTTEXT, @LPOS2, 1)  if ((@NEWCHAR = char(13)) or (@NEWCHAR = char(10)))  begin  select @LPOS2 = @LPOS2 + 1  end  end end  if ((@CHARINDEX2 > 0) or (@LEN > 50)) begin  if (@CHARINDEX3 = 0)  begin  select @O_COMMENT_3 = (substring(@I_vCMMTTEXT, @LPOS2, 60))  end   if ((@CHARINDEX3 > 0) and (@CHARINDEX3 <= 50))  begin  select @O_COMMENT_3 = (substring(@I_vCMMTTEXT, @LPOS2, @CHARINDEX3))  end   if (@CHARINDEX3 > 50)  begin  select @O_COMMENT_3 = (substring(@I_vCMMTTEXT, @LPOS2, @CHARINDEX3))  end   select @LEN = len(@O_COMMENT_3)   if (@LEN > 50)  begin  while @COUNTER <= 50  begin  select @CHAR = substring(@I_vCMMTTEXT, @LPOS2 + @COUNTER, 1)  select @NEWTEXT = @NEWTEXT + @CHAR  select @COUNTER = @COUNTER + 1  end  select @O_COMMENT_3 = @NEWTEXT  end   select @O_COMMENT_3 = replace(@O_COMMENT_3,char(13),'')  select @O_COMMENT_3 = replace(@O_COMMENT_3,char(10),'')   if ((@COUNTER = 51) and ((@CHAR <> ' ') and (@CHAR <> char(13)) and (@CHAR <> char(10))))  begin  select @SpacePos = (CHARINDEX(' ',reverse(@NEWTEXT)))   if (@SpacePos > 0)  begin  select @O_COMMENT_3 = (substring(@NEWTEXT, 1, 51 - @SpacePos))  end  end   if (@CHARINDEX3 = 0)  begin  select @LPOS3 = @LPOS2 + 51 - @SpacePos  select @CHARINDEX4 = CHARINDEX(char(13), substring(@I_vCMMTTEXT, @LPOS3 + 1, 250))  end  else  if ((@CHARINDEX3 > 0) and (@CHARINDEX3 <= 50))  begin  select @LPOS3 = @LPOS2 + @CHARINDEX3 - @SpacePos  select @CHARINDEX4 = CHARINDEX(char(13), substring(@I_vCMMTTEXT, @LPOS3 + 1, 250))  end  else  begin  select @LPOS3 = @LPOS2 + 51 - @SpacePos  select @CHARINDEX4 = @CHARINDEX3 - 50 + @SpacePos - 1  end   select @COUNTER = 0,  @NEWTEXT = '',  @SpacePos = 0,  @NEWCHAR = substring (@I_vCMMTTEXT, @LPOS3, 1)   if ((@NEWCHAR = ' ') or (@NEWCHAR = char(13)) or (@NEWCHAR = char(10)))  begin  select @LPOS3 = @LPOS3 + 1  select @NEWCHAR = substring (@I_vCMMTTEXT, @LPOS3, 1)  if ((@NEWCHAR = char(13)) or (@NEWCHAR = char(10)))  begin  select @LPOS3 = @LPOS3 + 1  end  end end  if ((@CHARINDEX3 > 0) or (@LEN > 50)) begin  if (@CHARINDEX4 = 0)  begin  select @O_COMMENT_4 = (substring(@I_vCMMTTEXT, @LPOS3, 60))  end   if ((@CHARINDEX4 > 0) and (@CHARINDEX4 <= 50))  begin  select @O_COMMENT_4 = (substring(@I_vCMMTTEXT, @LPOS3, @CHARINDEX4))  end   if (@CHARINDEX4 > 50)  begin  select @O_COMMENT_4 = (substring(@I_vCMMTTEXT, @LPOS3, 60))  end   select @LEN = len(@O_COMMENT_4)   if (@LEN > 50)  begin  while @COUNTER <= 50  begin  select @CHAR = substring(@I_vCMMTTEXT, @LPOS3 + @COUNTER, 1)  select @NEWTEXT = @NEWTEXT + @CHAR  select @COUNTER = @COUNTER + 1  end  select @O_COMMENT_4 = @NEWTEXT  end   select @O_COMMENT_4 = replace(@O_COMMENT_4,char(13),'')  select @O_COMMENT_4 = replace(@O_COMMENT_4,char(10),'')   if ((@COUNTER = 51) and ((@CHAR <> ' ') and (@CHAR <> char(13)) and (@CHAR <> char(10))))  begin  select @SpacePos = (CHARINDEX(' ',reverse(@NEWTEXT)))   if (@SpacePos > 0)  begin  select @O_COMMENT_4 = (substring(@NEWTEXT, 1, 51 - @SpacePos))  end  end end   
GO
GRANT EXECUTE ON  [dbo].[taParseCommentText] TO [DYNGRP]
GO
