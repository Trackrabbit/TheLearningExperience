SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[LoadSalesTrxListData]  @I_sTableName char(10) = NULL,  @I_nModule smallint = NULL,  @I_nCurrencyIndex   smallint = NULL,  @I_dtStart datetime = NULL,  @I_dtEnd datetime = NULL,  @I_fIncludeHistory tinyint  = NULL,  @I_nLanguageID smallint = 0,  @I_sRestriction char(255) = NULL,  @O_SQL_Error_State int   = NULL   output  as  declare @StartDate nvarchar(30), @EndDate nvarchar(30), @iStatus int, @iError int  select  @O_SQL_Error_State = 0,  @iStatus = 0,  @iError = 0  if (  @I_sTableName is NULL or  @I_dtStart is NULL or  @I_dtEnd is NULL or  @I_nModule is NULL or  @I_nCurrencyIndex is NULL or  @I_fIncludeHistory is NULL )  begin  select @O_SQL_Error_State = 26000  return end  select @StartDate = convert(nvarchar(30), @I_dtStart, 110) select @EndDate = convert(nvarchar(30), @I_dtEnd, 110)  if @I_nModule = 11  or @I_nModule = 0   begin exec ('insert into ' + @I_sTableName + ' (' +  'DOCDATE, SOURCE, DOCTYPE, DOCTYNAM, DOCNUMBR, ' +  'CUSTNMBR, CUSTNAME, PROSPECT, DCSTATUS, STSDESCR, DOCAMNT, CURNCYID, CURRNIDX, CSTPONBR, ' +  'PRSTADCD, SLPRSNID, SOPNUMBE, SOPSTATUS, SOPSTSDESCR, INVCNMBR, VOIDED, PRCHLDID, ' +  'QUOEXPDA, ReqShipDate, ALLOCABY, DOCID, Password_Valid, Workflow_Name, ' +  'Workflow_Approval_Status, Workflow_Due_Date, Workflow_Priority, Workflow_Originator, ' +  'Workflow_Approver, MKTOPROC, InfoValue, QTYTOPURCH, SHIPCOMPLETE, WF_Step_Type) ' +  'select ' +   'DOCDATE, SOURCE, DOCTYPE, DOCTYNAM, DOCNUMBR, ' +  'CUSTNMBR, CUSTNAME, PROSPECT, DCSTATUS, ' +  '(select STSDESCR = (rtrim((select SQL_MSG from DYNAMICS.dbo.MESSAGES where Language_ID = ' + @I_nLanguageID + ' and MSGNUM = 18682)) + (select ISNULL((select ''*'' where VOIDED = 1), '''')))), ' +  'DOCAMNT, CURNCYID, ' + @I_nCurrencyIndex + ', CSTPONBR, ' +  'PRSTADCD, SLPRSNID, SOPNUMBE, SOPSTATUS, SOPSTSDESCR, INVCNMBR, VOIDED, ' +   '(select PRCHLDID = ISNULL(dbo.sopGetHoldProcessID( [sopWorkTransactions].[DOCNUMBR], ' +  '[sopWorkTransactions].[DOCTYPE], ' +   @I_nLanguageID + '), '''')), ' +   'QUOEXPDA, ReqShipDate, ALLOCABY, DOCID, Password_Valid, ' +  '(select Workflow_Name = ' +  'case DOCTYPE ' +  'when 1 then (select SQL_MSG from DYNAMICS.dbo.MESSAGES where Language_ID = ' + @I_nLanguageID + ' and MSGNUM = 11396) '+  'when 2 then (select SQL_MSG from DYNAMICS.dbo.MESSAGES where Language_ID = ' + @I_nLanguageID + ' and MSGNUM = 11397) '+  'when 3 then (select SQL_MSG from DYNAMICS.dbo.MESSAGES where Language_ID = ' + @I_nLanguageID + ' and MSGNUM = 11397) '+  'when 6 then (select SQL_MSG from DYNAMICS.dbo.MESSAGES where Language_ID = ' + @I_nLanguageID + ' and MSGNUM = 11397) '+  'else ' + '''' + ' ' + '''' +  'end), '+  'Workflow_Approval_Status, Workflow_Due_Date, Workflow_Priority, Workflow_Originator, ' +  'Workflow_Approver, MKTOPROC, ' +  'InfoValue = (select dbo.syGetListInfoValue(0, 0, (select 1 where (select PRCHLDID = ISNULL(dbo.sopGetHoldProcessID([sopWorkTransactions].[DOCNUMBR],[sopWorkTransactions].[DOCTYPE],' + @I_nLanguageID + '), '''')) <> ''''), 0, '+  '(select 1 where VOIDED = 1), Emailed,0, 0, 0, 0, 0, 0)), ' +  '(select 1.0 * dbo.sopDocumentLinesExistToPurchase(DOCNUMBR, DOCTYPE)), ' +  'SHIPCOMPLETE, WF_Step_Type ' +  'from [dbo].[sopWorkTransactions] ' +  'where DOCDATE between ' + '''' + @StartDate + ''' and ''' + @EndDate + '''' +  ' and ' + @I_sRestriction)   if @I_fIncludeHistory > 0  begin  exec ('insert into ' + @I_sTableName + ' (' +  'DOCDATE, SOURCE, DOCTYPE, DOCTYNAM, DOCNUMBR, ' +  'CUSTNMBR, CUSTNAME, PROSPECT, DCSTATUS, STSDESCR, DOCAMNT, CURNCYID, CURRNIDX, CSTPONBR, ' +  'PRSTADCD, SLPRSNID, SOPNUMBE, SOPSTATUS, SOPSTSDESCR, INVCNMBR, VOIDED, PRCHLDID, ' +  'QUOEXPDA, ReqShipDate, ALLOCABY, DOCID, Password_Valid, Workflow_Name, ' +  'Workflow_Approval_Status, Workflow_Due_Date, Workflow_Priority, Workflow_Originator, ' +  'Workflow_Approver, MKTOPROC, InfoValue, QTYTOPURCH, SHIPCOMPLETE, WF_Step_Type) ' +  'select ' +   'DOCDATE, SOURCE, DOCTYPE, DOCTYNAM, DOCNUMBR, ' +  'CUSTNMBR, CUSTNAME, PROSPECT, DCSTATUS, ' +  '(select STSDESCR = (rtrim((select SQL_MSG from DYNAMICS.dbo.MESSAGES where Language_ID = ' + @I_nLanguageID + ' and MSGNUM = 12085)) + (select ISNULL((select ''*'' where VOIDED = 1), '''')))), ' +  'DOCAMNT, CURNCYID, ' + @I_nCurrencyIndex + ', CSTPONBR, ' +  'PRSTADCD, SLPRSNID, SOPNUMBE, SOPSTATUS, SOPSTSDESCR, INVCNMBR, VOIDED, ' +   '(select PRCHLDID = ISNULL(dbo.sopGetHoldProcessID( [sopHistoryTransactions].[DOCNUMBR], ' +  '[sopHistoryTransactions].[DOCTYPE], ' +   @I_nLanguageID + '), '''')), ' +   'QUOEXPDA, ReqShipDate, ALLOCABY, DOCID, Password_Valid, ' +  '(select Workflow_Name = ' +  'case DOCTYPE ' +  'when 1 then (select SQL_MSG from DYNAMICS.dbo.MESSAGES where Language_ID = ' + @I_nLanguageID + ' and MSGNUM = 11396) '+  'when 2 then (select SQL_MSG from DYNAMICS.dbo.MESSAGES where Language_ID = ' + @I_nLanguageID + ' and MSGNUM = 11397) '+  'when 3 then (select SQL_MSG from DYNAMICS.dbo.MESSAGES where Language_ID = ' + @I_nLanguageID + ' and MSGNUM = 11397) '+  'when 6 then (select SQL_MSG from DYNAMICS.dbo.MESSAGES where Language_ID = ' + @I_nLanguageID + ' and MSGNUM = 11397) '+  'else ' + '''' + ' ' + '''' +  'end), '+  'Workflow_Approval_Status, Workflow_Due_Date, Workflow_Priority, Workflow_Originator, ' +  'Workflow_Approver, MKTOPROC, ' +   '(select dbo.syGetListInfoValue(0, 0, (select 1 where (select PRCHLDID = ISNULL(dbo.sopGetHoldProcessID( [sopHistoryTransactions].[DOCNUMBR],[sopHistoryTransactions].[DOCTYPE],' + @I_nLanguageID + '), '''')) <> ''''), 0, '+  '(select 1 where VOIDED = 1), Emailed, 0, 0, 0, 0, 0, 0)), ' +  'QTYTOPURCH, SHIPCOMPLETE, WF_Step_Type ' +  'from [dbo].[sopHistoryTransactions] ' +  'where DOCDATE between ' + '''' + @StartDate + ''' and ''' + @EndDate + ''''  +  ' and ' + @I_sRestriction +  ' and ( ('+ @I_nModule + ' = 11) or ' +   '('+ @I_nModule + ' = 0 and (VOIDED = 1 or DOCTYPE = 1 or DOCTYPE = 2 or DOCTYPE = 5 or DOCTYPE = 6))' +  ')')  end end  if @I_nModule = 9  or @I_nModule = 0   begin exec ('insert into ' + @I_sTableName + ' (' +  'DOCDATE, SOURCE, DOCTYPE, DOCTYNAM, DOCNUMBR, ' +  'CUSTNMBR, CUSTNAME, PROSPECT, DCSTATUS, STSDESCR, DOCAMNT, CURNCYID, CURRNIDX, CSTPONBR, ' +  'PRSTADCD, SLPRSNID, SOPNUMBE, SOPSTATUS, SOPSTSDESCR, INVCNMBR, VOIDED, PRCHLDID, ' +  'QUOEXPDA, ReqShipDate, ALLOCABY, DOCID, Password_Valid, Workflow_Name, ' +  'Workflow_Approval_Status, Workflow_Due_Date, Workflow_Priority, Workflow_Originator, ' +  'Workflow_Approver, MKTOPROC, InfoValue, QTYTOPURCH, SHIPCOMPLETE, WF_Step_Type) ' +  'select ' +   'DOCDATE, SOURCE, DOCTYPE, DOCTYNAM, DOCNUMBR, ' +  'CUSTNMBR, CUSTNAME, PROSPECT, DCSTATUS, ' +  '(select STSDESCR = ' +  'case ' +  'when DCSTATUS = 1 then (rtrim((select SQL_MSG from DYNAMICS.dbo.MESSAGES where Language_ID = ' + @I_nLanguageID + ' and MSGNUM = 18682)) + (select ISNULL((select ''*'' where VOIDED = 1), ''''))) ' +  'when DCSTATUS = 2 then (rtrim((select SQL_MSG from DYNAMICS.dbo.MESSAGES where Language_ID = ' + @I_nLanguageID + ' and MSGNUM = 17213)) + (select ISNULL((select ''*'' where VOIDED = 1), ''''))) ' +  'when DCSTATUS = 3 then (rtrim((select SQL_MSG from DYNAMICS.dbo.MESSAGES where Language_ID = ' + @I_nLanguageID + ' and MSGNUM = 12085)) + (select ISNULL((select ''*'' where VOIDED = 1), ''''))) ' +  'end), '+  'DOCAMNT, CURNCYID, ' + @I_nCurrencyIndex + ', CSTPONBR, ' +  'PRSTADCD, SLPRSNID, ' +  '(select SOPNUMBE = dbo.rmGetSOPNumberFromTrxDescription(TRXSORCE, TRXDSCRN, DOCNUMBR, ' + @I_nLanguageID + ')), ' +  'SOPSTATUS, SOPSTSDESCR, ' +      '(select INVCNMBR = dbo.rmGetInvoiceNumberFromTrxDescription(TRXSORCE, TRXDSCRN, DOCNUMBR, ' + @I_nLanguageID + ')), ' +  'VOIDED, PRCHLDID, ' +  'QUOEXPDA, ReqShipDate, ALLOCABY, DOCID, Password_Valid, Workflow_Name, ' +  'Workflow_Approval_Status, Workflow_Due_Date, Workflow_Priority, Workflow_Originator, ' +  'Workflow_Approver, MKTOPROC, ' +   '(select dbo.syGetListInfoValue(0, 0, 0, 0, ' +  '(select 1 where VOIDED = 1), Emailed, 0, 0, 0, 0, 0, 0)), ' +  'QTYTOPURCH, SHIPCOMPLETE, WF_Step_Type ' +  'from [dbo].[rmWorkTransactions] ' +  'where DOCDATE between ' + '''' + @StartDate + ''' and ''' + @EndDate + ''''  +  ' and ' + @I_sRestriction)   if @I_fIncludeHistory > 0  begin  exec ('insert into ' + @I_sTableName + ' (' +  'DOCDATE, SOURCE, DOCTYPE, DOCTYNAM, DOCNUMBR, ' +  'CUSTNMBR, CUSTNAME, PROSPECT, DCSTATUS, STSDESCR, DOCAMNT, CURNCYID, CURRNIDX, CSTPONBR, ' +  'PRSTADCD, SLPRSNID, SOPNUMBE, SOPSTATUS, SOPSTSDESCR, INVCNMBR, VOIDED, PRCHLDID, ' +  'QUOEXPDA, ReqShipDate, ALLOCABY, DOCID, Password_Valid, Workflow_Name, ' +  'Workflow_Approval_Status, Workflow_Due_Date, Workflow_Priority, Workflow_Originator, ' +  'Workflow_Approver, MKTOPROC, InfoValue, QTYTOPURCH, SHIPCOMPLETE, WF_Step_Type) ' +  'select ' +   'DOCDATE, SOURCE, DOCTYPE, DOCTYNAM, DOCNUMBR, ' +  'CUSTNMBR, CUSTNAME, PROSPECT, DCSTATUS, ' +  '(select STSDESCR = (rtrim((select SQL_MSG from DYNAMICS.dbo.MESSAGES where Language_ID = ' + @I_nLanguageID + ' and MSGNUM = 12085)) + (select ISNULL((select ''*'' where VOIDED = 1), '''')))), ' +  'DOCAMNT, CURNCYID, ' + @I_nCurrencyIndex + ', CSTPONBR, ' +  'PRSTADCD, SLPRSNID, ' +  '(select SOPNUMBE = dbo.rmGetSOPNumberFromTrxDescription(TRXSORCE, TRXDSCRN, DOCNUMBR, ' + @I_nLanguageID + ')), ' +  'SOPSTATUS, SOPSTSDESCR, ' +     '(select INVCNMBR = dbo.rmGetInvoiceNumberFromTrxDescription(TRXSORCE, TRXDSCRN, DOCNUMBR, ' + @I_nLanguageID + ')), ' +  'VOIDED, PRCHLDID, ' +  'QUOEXPDA, ReqShipDate, ALLOCABY, DOCID, Password_Valid, Workflow_Name, ' +  'Workflow_Approval_Status, Workflow_Due_Date, Workflow_Priority, Workflow_Originator, ' +  'Workflow_Approver, MKTOPROC, ' +   '(select dbo.syGetListInfoValue(0, 0, 0, 0, ' +  '(select 1 where VOIDED = 1), Emailed, 0, 0, 0, 0, 0, 0)), ' +  'QTYTOPURCH, SHIPCOMPLETE, WF_Step_Type ' +  'from [dbo].[rmHistoryTransactions] ' +  'where DOCDATE between ' + '''' + @StartDate + ''' and ''' + @EndDate + ''''  +  ' and ' + @I_sRestriction)  end end  if @I_nModule = 10  or @I_nModule = 0   begin exec ('insert into ' + @I_sTableName + ' (' +  'DOCDATE, SOURCE, DOCTYPE, DOCTYNAM, DOCNUMBR, ' +  'CUSTNMBR, CUSTNAME, PROSPECT, DCSTATUS, STSDESCR, DOCAMNT, CURNCYID, CURRNIDX, CSTPONBR, ' +  'PRSTADCD, SLPRSNID, SOPNUMBE, SOPSTATUS, SOPSTSDESCR, INVCNMBR, VOIDED, PRCHLDID, ' +  'QUOEXPDA, ReqShipDate, ALLOCABY, DOCID, Password_Valid, Workflow_Name, ' +  'Workflow_Approval_Status, Workflow_Due_Date, Workflow_Priority, Workflow_Originator, ' +  'Workflow_Approver, MKTOPROC, InfoValue, QTYTOPURCH, SHIPCOMPLETE, WF_Step_Type) ' +  'select ' +   'DOCDATE, SOURCE, DOCTYPE, DOCTYNAM, DOCNUMBR, ' +  'CUSTNMBR, CUSTNAME, PROSPECT, DCSTATUS, ' +  '(select STSDESCR = (rtrim((select SQL_MSG from DYNAMICS.dbo.MESSAGES where Language_ID = ' + @I_nLanguageID + ' and MSGNUM = 18682)) + (select ISNULL((select ''*'' where VOIDED = 1), '''')))), ' +  'DOCAMNT, CURNCYID, ' + @I_nCurrencyIndex + ', CSTPONBR, ' +  'PRSTADCD, SLPRSNID, SOPNUMBE, SOPSTATUS, SOPSTSDESCR, INVCNMBR, VOIDED, PRCHLDID, ' +  'QUOEXPDA, ReqShipDate, ALLOCABY, DOCID, Password_Valid, Workflow_Name, ' +  'Workflow_Approval_Status, Workflow_Due_Date, Workflow_Priority, Workflow_Originator, ' +  'Workflow_Approver, MKTOPROC, ' +   '(select dbo.syGetListInfoValue(0, 0, (select 1 where HOLDNT = 1), 0, ' +  '(select 1 where VOIDED = 1), 0, 0, 0, 0, 0, 0, 0)), ' +  'QTYTOPURCH, SHIPCOMPLETE, WF_Step_Type ' +  'from [dbo].[ivcWorkTransactions] ' +  'where DOCDATE between ' + '''' + @StartDate + ''' and ''' + @EndDate + '''' +  ' and ' + @I_sRestriction)   if @I_fIncludeHistory > 0  begin  exec ('insert into ' + @I_sTableName + ' (' +  'DOCDATE, SOURCE, DOCTYPE, DOCTYNAM, DOCNUMBR, ' +  'CUSTNMBR, CUSTNAME, PROSPECT, DCSTATUS, STSDESCR, DOCAMNT, CURNCYID, CURRNIDX, CSTPONBR, ' +  'PRSTADCD, SLPRSNID, SOPNUMBE, SOPSTATUS, SOPSTSDESCR, INVCNMBR, VOIDED, PRCHLDID, ' +  'QUOEXPDA, ReqShipDate, ALLOCABY, DOCID, Password_Valid, Workflow_Name, ' +  'Workflow_Approval_Status, Workflow_Due_Date, Workflow_Priority, Workflow_Originator, ' +  'Workflow_Approver, MKTOPROC, InfoValue, QTYTOPURCH, SHIPCOMPLETE, WF_Step_Type) ' +  'select ' +   'DOCDATE, SOURCE, DOCTYPE, DOCTYNAM, DOCNUMBR, ' +  'CUSTNMBR, CUSTNAME, PROSPECT, DCSTATUS, ' +  '(select STSDESCR = (rtrim((select SQL_MSG from DYNAMICS.dbo.MESSAGES where Language_ID = ' + @I_nLanguageID + ' and MSGNUM = 12085)) + (select ISNULL((select ''*'' where VOIDED = 1), '''')))), ' +  'DOCAMNT, CURNCYID, ' + @I_nCurrencyIndex + ', CSTPONBR, ' +  'PRSTADCD, SLPRSNID, SOPNUMBE, SOPSTATUS, SOPSTSDESCR, INVCNMBR, VOIDED, PRCHLDID, ' +  'QUOEXPDA, ReqShipDate, ALLOCABY, DOCID, Password_Valid, Workflow_Name, ' +  'Workflow_Approval_Status, Workflow_Due_Date, Workflow_Priority, Workflow_Originator, ' +  'Workflow_Approver, MKTOPROC, ' +   '(select dbo.syGetListInfoValue(0, 0, (select 1 where HOLDNT = 1), 0, '+  '(select 1 where VOIDED = 1), 0, 0, 0, 0, 0, 0, 0)), ' +  'QTYTOPURCH, SHIPCOMPLETE, WF_Step_Type ' +  'from [dbo].[ivcHistoryTransactions] ' +  'where DOCDATE between ' + '''' + @StartDate + ''' and ''' + @EndDate + ''''  +  ' and ' + @I_sRestriction +  ' and ( ('+ @I_nModule + ' = 10) or ' +   '('+ @I_nModule + ' = 0 and VOIDED = 1)' +  ')')  end end  select @iError = @@error  if @iStatus = 0 and @iError <> 0  Begin  select @iStatus = @iError  End  if ( (@iStatus <> 0) or (@O_SQL_Error_State <> 0) )  return (@iStatus)  return(@iStatus)    
GO
GRANT EXECUTE ON  [dbo].[LoadSalesTrxListData] TO [DYNGRP]
GO
