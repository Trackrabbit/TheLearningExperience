SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create PROCEDURE [dbo].[SVC_RET_GetExpiredRevenues] (@Year integer,  @Period integer,  @User char(15),   @CHECKDATE datetime)  AS  declare @ContractNumber char(11) declare @Line numeric(19,5) declare @Customer char(15) declare @Amount numeric(19,5), @OrigAmount numeric(19,5) declare @Total numeric(19,5), @OrigTotal numeric(19,5) declare @SRVRECTYPE smallint, @Call char(11)  delete from SVC00625 with (rowlock)where USERID = @User and CNTTYPE = 'Expired' update SVC00625 with (rowlock) set MKDTOPST = 0 where USERID = @User if @Year = 0 and @Period = 0 return declare contract_revenue CURSOR for select CONTNBR, LNSEQNBR, CUSTNMBR from SVC00601  WHERE SVC00601.CONSTS = 2 and SVC00601.BILSTAT > 0 and SVC00601.SVC_Liability_Type> 1  and SVC00601.ENDDATE <= @CHECKDATE and Contract_Line_Status <> 'C' OPEN contract_revenue fetch next from contract_revenue into @ContractNumber, @Line, @Customer while @@FETCH_STATUS = 0  BEGIN  select @Amount = sum(SVC00604.Net_Transaction_Amount),  @OrigAmount = sum(SVC00604.OrigNetTransactionAmount)  FROM SVC00604 where CONSTS = 2 and CONTNBR = @ContractNumber and LNSEQNBR = @Line  select @Total = SUM(IsNull(DOCAMNT,0) - IsNull(SVC_Invoice_Credit_Amoun,0))- SUM(isnull(DSCDLRAM,0)),  @OrigTotal = SUM(IsNull(ORDOCAMT,0) - IsNull(OrigInvCreditAmt,0)) - SUM(isnull(ORDDLRAT,0))  from SVC00603 where CONSTS = 2 and CONTNBR = @ContractNumber and LNSEQNBR = @Line  select @Amount = @Total - isnull(@Amount,0), @OrigAmount = @OrigTotal - isnull(@OrigAmount,0)  if @Amount > 0   Begin  exec SVC_Check_Contract_OnCalls 2, @ContractNumber, @Line, @SRVRECTYPE output, @Call output  if not(@Call > '' and @SRVRECTYPE = 2)  begin  if not exists(select * from SVC00625 where USERID = @User and CONSTS = 2 and  CONTNBR = @ContractNumber and YEAR1 =@Year and PERIODID = @Period)   insert into SVC00625 with (rowlock)  SELECT @User, 2, @ContractNumber, 'Expired',@Customer, @Year,   @Period,0,0, isnull(@Amount,0), isnull(@OrigAmount,0) , '','',''  else  update SVC00625 with (rowlock)  set Transaction_Amount = Transaction_Amount + isnull(@Amount,0),  OrigTransactionAmount = OrigTransactionAmount + isnull(@OrigAmount,0)  where USERID = @User and CONSTS = 2 and CONTNBR = @ContractNumber  and CNTTYPE = 'Expired' and YEAR1 =@Year and PERIODID = @Period  end  select @Call = '', @SRVRECTYPE = 0  End  fetch next from contract_revenue into @ContractNumber, @Line, @Customer  END DEALLOCATE contract_revenue  return   
GO
GRANT EXECUTE ON  [dbo].[SVC_RET_GetExpiredRevenues] TO [DYNGRP]
GO
