SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE Procedure [dbo].[SVC_RTV_Convert] as declare @RTVNumber char(15),  @Line numeric(19,5),  @ReadyToShip tinyint,  @Shipped tinyint,  @Received tinyint,  @Closed tinyint,  @RTVType char(10),  @ReturnStatus char(3),  @RTV_Status smallint,  @UserID char(21),  @LNSEQNBR numeric(19,5) declare @MinDate datetime  if not exists(select * from sysobjects where name = 'SVC05601')   return if (select count(*) from SVC05601) > 1   return  exec smGetMinDate @MinDate output   select @UserID = SYSTEM_USER select @LNSEQNBR =max(IsNull(LNSEQNBR,0)) + 1   from SVC05620  insert into SVC05600 with (rowlock) select RTV_Number, RTV_Type, RTV_Return_Status, case when CB_Parts_Available =1 and Shipped = 1 and Received = 1 and CB_Closed = 1 then 6 when CB_Parts_Available =1 and Shipped = 1 and Received = 1 and CB_Closed = 0 then 5 when CB_Parts_Available =1 and Shipped = 1 and Received = 0 and CB_Closed = 0 then 3 when CB_Parts_Available =1 and Shipped = 0 and Received = 0 and CB_Closed = 0 then 2 else 1 End, VRMA_Document_ID, RETDOCID, LNSEQNBR, DSCRIPTN, SVC05600HOLD.VENDORID, isnull(VENDNAME,''), ADRSCODE, Ship_Address_Name, Ship_Address_1, Ship_Address_2, Ship_Address_3, Ship_City, Ship_State, SVC05600HOLD.ZIPCODE, Ship_Country, ENTDTE, ENTTME, PRMDATE, Promised_Time, Shipped_Date, Shipped_Time, receiptdate, Receipt_Time, COMPDTE, COMPTME, LOCCODEB, LOCNCODE, Part_Price, Part_Cost, Labor_Price, Labor_Cost, Expense_Price, Expense_Cost, Travel_Price, Travel_Cost, Bill_of_Lading_Out, Shipping_Method_Out, Bill_of_Lading, SVC05600HOLD.SHIPMTHD, OFFID, SVC05600HOLD.NOTEINDX, VCHNUMWK, Voucher_Number_Invoice, Voucher_Number_Reimburse, CUSTOWN, SVC05600HOLD.USERID, SVC05600HOLD.USERDEF1, SVC05600HOLD.USERDEF2, USRDEF03, USRDEF04, USRDEF05, SVC05600HOLD.CURNCYID, CURRNIDX, SVC05600HOLD.RATETPID, EXGTBLID, XCHGRATE, EXCHDATE, DECPLACS, TIME1, RATECALC, VIEWMODE, ISMCTRX, EXPNDATE, DENXRATE, MCTRXSTT, Originating_Part_Price, Originating_Part_Cost, Originating_Labor_Price, Originating_Labor_Cost, Originating_ExpensePrice, Originating_Expense_Cost, Originating_Travel_Price, Originating_Travel_Cost, 0, @MinDate from SVC05600HOLD  left join PM00200 on SVC05600HOLD.VENDORID = PM00200.VENDORID where CB_Closed = 0  insert into SVC05601 with (rowlock) select  RTV_Number, 100, RTV_Type, case when CB_Parts_Available =1 and Shipped = 1 and Received = 1 and CB_Closed = 1 then 6 when CB_Parts_Available =1 and Shipped = 1 and Received = 1 and CB_Closed = 0 then 5 when CB_Parts_Available =1 and Shipped = 1 and Received = 0 and CB_Closed = 0 then 3 when CB_Parts_Available =1 and Shipped = 0 and Received = 0 and CB_Closed = 0 then 2 else 1 End, RTV_Return_Status, VRMA_Document_ID, RETDOCID, LNSEQNBR, SVC_Process_SEQ_Number, DSCRIPTN, REFRENCE, Reference2, isnull(IV00101.ITEMNMBR,''), isnull(IV00101.ITEMDESC,''), isnull(ITMTRKOP,1), isnull(IV00101.DECPLQTY,0), QUANTITY, case when SVC05600HOLD.Shipped = 1 then QUANTITY else 0 end, case when SVC05600HOLD.Received = 1 then 0 else QUANTITY end, case when SVC05600HOLD.Received = 1 then QUANTITY else 0 end, 0, UOFM, VENDORID, VNDITNUM, Return_Item_Number, OFFID, LOCCODEB, SVC05600HOLD.LOCNCODE, ADRSCODE, Ship_Address_Name, Ship_Address_1, Ship_Address_2, Ship_Address_3, Ship_City, Ship_State, ZIPCODE, Ship_Country, ENTDTE, ENTTME, PRMDATE, Promised_Time, Shipped_Date, Shipped_Time, receiptdate, Receipt_Time, COMPDTE, COMPTME, PONMBRSTR, POLNSEQ, '', 0, Transfer_Reference, TRANSLINESEQ, CALLNBR, EQPLINE, LINITMTYP, LNITMSEQ, Bill_of_Lading_Out, Shipping_Method_Out, Bill_of_Lading, SHIPMTHD, Tracking_Number, SVC05600HOLD.NOTEINDX, VCHNUMWK, Voucher_Number_Invoice, Voucher_Number_Reimburse, CUSTOWN, USERDEF1, USERDEF2, USRDEF03, USRDEF04, USRDEF05, Part_Price, Part_Cost, Labor_Price, Labor_Cost, Expense_Price, Expense_Cost, Travel_Price, Travel_Cost, Originating_Part_Price, Originating_Part_Cost, Originating_Labor_Price, Originating_Labor_Cost, Originating_ExpensePrice, Originating_Expense_Cost, Originating_Travel_Price, Originating_Travel_Cost from SVC05600HOLD left join IV00101 on IV00101.ITEMNMBR = SVC05600HOLD.ITEMNMBR where CB_Closed = 0  insert into SVC05602 with (rowlock) select  RTV_Number, 100, 1, 1, 1, ITEMNMBR, SERLNMBR, SVC_Serial_ID, EQUIPID, Return_Item_Number, Return_Serial_Number, SVC_Return_Serial_ID, Return_Equipment_ID, BIN, TOBIN, 0, 1, receiptdate, 1, 'RTV', Shipped, Shipped, Received from SVC05600HOLD where CB_Closed = 0 and EQUIPID > 0  insert into SVC05620 with (rowlock) select  RTV_Number, 0, @LNSEQNBR, RTV_Return_Status, RTV_Return_Status, 'upgrade to 9.0', @UserID, convert(char(10), GETDATE(),101),  convert(char(10), GETDATE(),108) from SVC05600HOLD  where CB_Closed = 0  insert into SVC35600 with (rowlock) select RTV_Number, RTV_Type, RTV_Return_Status, case when CB_Parts_Available =1 and Shipped = 1 and Received = 1 and CB_Closed = 1 then 6 when CB_Parts_Available =1 and Shipped = 1 and Received = 1 and CB_Closed = 0 then 5 when CB_Parts_Available =1 and Shipped = 1 and Received = 0 and CB_Closed = 0 then 3 when CB_Parts_Available =1 and Shipped = 0 and Received = 0 and CB_Closed = 0 then 2 else 1 End, VRMA_Document_ID, RETDOCID, LNSEQNBR, DSCRIPTN, SVC05600HOLD.VENDORID, isnull(VENDNAME,''), ADRSCODE, Ship_Address_Name, Ship_Address_1, Ship_Address_2, Ship_Address_3, Ship_City, Ship_State, SVC05600HOLD.ZIPCODE, Ship_Country, ENTDTE, ENTTME, PRMDATE, Promised_Time, Shipped_Date, Shipped_Time, receiptdate, Receipt_Time, COMPDTE, COMPTME, LOCCODEB, LOCNCODE, Part_Price, Part_Cost, Labor_Price, Labor_Cost, Expense_Price, Expense_Cost, Travel_Price, Travel_Cost, Bill_of_Lading_Out, Shipping_Method_Out, Bill_of_Lading, SVC05600HOLD.SHIPMTHD, OFFID, SVC05600HOLD.NOTEINDX, VCHNUMWK, Voucher_Number_Invoice, Voucher_Number_Reimburse, CUSTOWN, SVC05600HOLD.USERID, SVC05600HOLD.USERDEF1, SVC05600HOLD.USERDEF2, USRDEF03, USRDEF04, USRDEF05, SVC05600HOLD.CURNCYID, CURRNIDX, SVC05600HOLD.RATETPID, EXGTBLID, XCHGRATE, EXCHDATE, DECPLACS, TIME1, RATECALC, VIEWMODE, ISMCTRX, EXPNDATE, DENXRATE, MCTRXSTT, Originating_Part_Price, Originating_Part_Cost, Originating_Labor_Price, Originating_Labor_Cost, Originating_ExpensePrice, Originating_Expense_Cost, Originating_Travel_Price, Originating_Travel_Cost, 0, @MinDate from SVC05600HOLD  left join PM00200 on SVC05600HOLD.VENDORID = PM00200.VENDORID where CB_Closed = 1  insert into SVC35601 with (rowlock) select  RTV_Number, 100, RTV_Type, case when CB_Parts_Available =1 and Shipped = 1 and Received = 1 and CB_Closed = 1 then 6 when CB_Parts_Available =1 and Shipped = 1 and Received = 1 and CB_Closed = 0 then 5 when CB_Parts_Available =1 and Shipped = 1 and Received = 0 and CB_Closed = 0 then 3 when CB_Parts_Available =1 and Shipped = 0 and Received = 0 and CB_Closed = 0 then 2 else 1 End, RTV_Return_Status, VRMA_Document_ID, RETDOCID, LNSEQNBR, SVC_Process_SEQ_Number, DSCRIPTN, REFRENCE, Reference2, isnull(IV00101.ITEMNMBR,''), isnull(IV00101.ITEMDESC,''), isnull(ITMTRKOP,1), isnull(IV00101.DECPLQTY,0), QUANTITY, case when SVC05600HOLD.Shipped = 1 then QUANTITY else 0 end, case when SVC05600HOLD.Received = 1 then 0 else QUANTITY end, case when SVC05600HOLD.Received = 1 then QUANTITY else 0 end, 0, UOFM, VENDORID, VNDITNUM, Return_Item_Number, OFFID, LOCCODEB, SVC05600HOLD.LOCNCODE, ADRSCODE, Ship_Address_Name, Ship_Address_1, Ship_Address_2, Ship_Address_3, Ship_City, Ship_State, ZIPCODE, Ship_Country, ENTDTE, ENTTME, PRMDATE, Promised_Time, Shipped_Date, Shipped_Time, receiptdate, Receipt_Time, COMPDTE, COMPTME, PONMBRSTR, POLNSEQ, '', 0, Transfer_Reference, TRANSLINESEQ, CALLNBR, EQPLINE, LINITMTYP, LNITMSEQ, Bill_of_Lading_Out, Shipping_Method_Out, Bill_of_Lading, SHIPMTHD, Tracking_Number, SVC05600HOLD.NOTEINDX, VCHNUMWK, Voucher_Number_Invoice, Voucher_Number_Reimburse, CUSTOWN, USERDEF1, USERDEF2, USRDEF03, USRDEF04, USRDEF05, Part_Price, Part_Cost, Labor_Price, Labor_Cost, Expense_Price, Expense_Cost, Travel_Price, Travel_Cost, Originating_Part_Price, Originating_Part_Cost, Originating_Labor_Price, Originating_Labor_Cost, Originating_ExpensePrice, Originating_Expense_Cost, Originating_Travel_Price, Originating_Travel_Cost from SVC05600HOLD left join IV00101 on IV00101.ITEMNMBR = SVC05600HOLD.ITEMNMBR where CB_Closed = 1  insert into SVC35602 with (rowlock) select  RTV_Number, 100, 1, 1, 1, ITEMNMBR, SERLNMBR, SVC_Serial_ID, EQUIPID, Return_Item_Number, Return_Serial_Number, SVC_Return_Serial_ID, Return_Equipment_ID, BIN, TOBIN, 0, 1, receiptdate, 1, 'RTV', Shipped, Shipped, Received from SVC05600HOLD where CB_Closed = 1 and EQUIPID > 0  insert into SVC05620 with (rowlock) select  RTV_Number, 0, @LNSEQNBR, RTV_Return_Status, RTV_Return_Status, 'upgrade to 9.0', @UserID, convert(char(10), GETDATE(),101),  convert(char(10), GETDATE(),108) from SVC05600HOLD  where CB_Closed = 1  insert into SVC35630 with (rowlock) select  SVC05630.RTV_Number, SVC05630.RTV_Line, SVC05630.LINITMTYP, SVC05630.SEQNUMBR, SVC_Distribution_Type, DistRef, ACTINDX, DEBITAMT, ORDBTAMT, CRDTAMNT, ORCRDAMT, SVC05630.CURRNIDX, SVC05630.TRXSORCE, SVC05630.POSTED, SVC05630.POSTEDDT from SVC05630 left join SVC05600HOLD on SVC05630.RTV_Number = SVC05600HOLD.RTV_Number where CB_Closed = 1 delete from SVC05630 where SVC05630.RTV_Number in (select RTV_Number from SVC35630)  insert into SVC35620 with (rowlock) select  SVC05620.RTV_Number, SVC05620.RTV_Line, SVC05620.LNSEQNBR, SVCFRMSTAT, SVCTOSTAT, DSCRPTION, SVC05620.USERID, CREATDDT, CREATETIME  from SVC05620 left join SVC05600HOLD on SVC05620.RTV_Number = SVC05600HOLD.RTV_Number where CB_Closed = 1 delete from SVC05620 where SVC05620.RTV_Number in (select RTV_Number from SVC35620)  return    
GO
GRANT EXECUTE ON  [dbo].[SVC_RTV_Convert] TO [DYNGRP]
GO
