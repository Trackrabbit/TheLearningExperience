SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[aagMLStep4]  @iStoredProcIdx smallint = 0,   @iDebug tinyint = 0,  @iBBFFromTable varchar(64) = '',  @oStatus  smallint = 0 out as  set nocount on set dateformat ymd  if @iDebug = 1  begin  print ''  print '************************'  print '** aagMLStep4 started **'  print '************************'  print '' end  declare @retCode int,  @execCmd nvarchar(4000),  @execCmd1  varchar(8000),  @iCol   int,   @sCols   char(100),   @sYear   char(20),  @sPer   char(20),  @iYear   int,  @iPerFrom  int,  @iPerTo  int,  @iTrxDimID  int,  @execNewCmd varchar(8000) ,  @totlenInsert int,  @totlenSelect int,  @totlenFrom1 int,  @totlenFrom2 int,  @totlenWhere int,  @totlenGroupBy int,  @totlenCmd int,  @aaSQLFrom1 varchar(8000),  @aaSQLFrom2 varchar(8000) select  @retCode   = 0,  @oStatus   = 0,  @execCmd   = N'',  @iCol   = 0,   @sCols    = N'',  @sYear    = N'',  @sPer    = N'',  @iYear  = 0,  @iPerFrom = 0,  @iPerTo  = 0,  @iTrxDimID = 0,  @totlenInsert = 0,  @totlenSelect = 0,  @totlenFrom1 = 0,  @totlenFrom2 = 0,  @totlenWhere = 0,  @totlenGroupBy = 0,  @totlenCmd = 0,  @execNewCmd = '',  @aaSQLFrom1 = '',  @aaSQLFrom2 = ''  if (@iStoredProcIdx = 4) goto DONE  if not exists(select name from tempdb..sysobjects where name = '##RowImport' and  type = 'U' ) begin  if exists(select name from tempdb..sysobjects where name = '##PreCalc'   and type = 'U') drop table ##PreCalc  if dbo.aagMLCancelled() = 1 goto DONE   select @execCmd1 =   rtrim(convert(varchar(8000), aaSQLCreate))   from ##Options  if LEN(@execCmd1) = 8000   begin   select @oStatus = -30   return @oStatus   end   if dbo.aagMLCancelled() = 1 goto DONE   if @iDebug = 1 print @execCmd1  exec ( @execCmd1 )   select @execCmd = N'ALTER table ##PreCalc add aaBudgetID tinyint NULL'   if @iDebug = 1 print @execCmd  exec @retCode = sp_executesql @execCmd   if (@retCode <> 0) return @retCode   select @execCmd = 'CREATE INDEX  PreCalc_ind'  select @execCmd =  @execCmd + ' ON ##PreCalc(year1,period,aaBudgetID)'   if @iDebug = 1 print @execCmd  exec @retCode = sp_executesql @execCmd   if (@retCode <> 0) return @retCode  if exists(select name from tempdb..sysobjects where name = '##OptionsFrom'   and type = 'U') drop table ##OptionsFrom  exec ('select * into ##OptionsFrom from ' + @iBBFFromTable + '')   select @totlenInsert = DATALENGTH(aaSQLInsert) from ##Options  select @totlenSelect = DATALENGTH(aaSQLSelect) from ##Options  select @totlenFrom1 = DATALENGTH(aaSQLFrom1) from ##OptionsFrom  select @totlenFrom2 = DATALENGTH(aaSQLFrom2) from ##OptionsFrom  select @totlenWhere = DATALENGTH(aaSQLWhere) from ##Options  select @totlenGroupBy = DATALENGTH(aaSQLGroupBy) from ##Options   select @aaSQLFrom1 = aaSQLFrom1 from ##OptionsFrom  select @aaSQLFrom2 = aaSQLFrom2 from ##OptionsFrom   if len(@aaSQLFrom1) = 7999  begin  set @aaSQLFrom1 = rtrim(@aaSQLFrom1) + '' + space(1)  end   if (@totlenInsert+@totlenSelect+@totlenFrom1) >= 8000-1  begin  set @totlenCmd = 8000-1-(@totlenInsert+@totlenSelect)   select @execCmd1 =  rtrim(convert(varchar(8000), aaSQLInsert)) + SPACE(1) +  rtrim(convert(varchar(8000), aaSQLSelect)) + SPACE(1) +  substring(rtrim(convert(varchar(8000), @aaSQLFrom1)),1,@totlenCmd-1-1)  from ##Options  select @execNewCmd =  substring(convert(varchar(8000), @aaSQLFrom1),@totlenCmd-1 ,@totlenFrom1)   +   rtrim(convert(varchar(8000), @aaSQLFrom2)) + SPACE(1) +  rtrim(convert(varchar(8000), aaSQLWhere))  + SPACE(1) +  rtrim(convert(varchar(8000), aaSQLGroupBy))  from ##Options  end  else if (@totlenInsert+@totlenSelect+@totlenFrom1+@totlenFrom2) >= 8000-1  begin  set @totlenCmd = 8000-1-(@totlenInsert+@totlenSelect+@totlenFrom1)   select @execCmd1 =  rtrim(convert(varchar(8000), aaSQLInsert)) + SPACE(1) +  rtrim(convert(varchar(8000), aaSQLSelect)) + SPACE(1) +  rtrim(convert(varchar(8000), @aaSQLFrom1)) +  substring(rtrim(convert(varchar(8000), @aaSQLFrom2)),1,@totlenCmd-1)  from ##Options  select @execNewCmd = substring(convert(varchar(8000), @aaSQLFrom2),@totlenCmd -1,@totlenFrom2)  + SPACE(1) +  rtrim(convert(varchar(8000), aaSQLWhere))  + space(1) +  rtrim(convert(varchar(8000), aaSQLGroupBy))   from ##Options   end  else if (@totlenInsert+@totlenSelect+@totlenFrom1+@totlenFrom2+@totlenWhere) >= 8000-1  begin  set @totlenCmd = 8000-1-(@totlenInsert+@totlenSelect+@totlenFrom1+@totlenFrom2)   select @execCmd1 =  rtrim(convert(varchar(8000), aaSQLInsert)) + SPACE(1) +  rtrim(convert(varchar(8000), aaSQLSelect)) + SPACE(1) +  rtrim(convert(varchar(8000), @aaSQLFrom1)) +  rtrim(convert(varchar(8000), @aaSQLFrom2)) + SPACE(1) +  substring(rtrim(convert(varchar(8000), aaSQLWhere)),1,@totlenCmd-1)  from ##Options  select @execNewCmd = substring(convert(varchar(8000), aaSQLWhere),@totlenCmd -1,@totlenWhere)  + SPACE(1) +  rtrim(convert(varchar(8000), aaSQLGroupBy))  from ##Options   end  else if (@totlenInsert+@totlenSelect+@totlenFrom1+@totlenFrom2+@totlenWhere+@totlenGroupBy) >= 8000-1  begin  set @totlenCmd = 8000-1-(@totlenInsert+@totlenSelect+@totlenFrom1+@totlenFrom2+@totlenWhere)   select @execCmd1 =  rtrim(convert(varchar(8000), aaSQLInsert)) + SPACE(1) +  rtrim(convert(varchar(8000), aaSQLSelect)) + SPACE(1) +  rtrim(convert(varchar(8000), @aaSQLFrom1)) +  rtrim(convert(varchar(8000), @aaSQLFrom2)) + SPACE(1) +  rtrim(convert(varchar(8000), aaSQLWhere))+ SPACE(1) +  substring(rtrim(convert(varchar(8000), aaSQLGroupBy)),1,@totlenCmd)  from ##Options  select @execNewCmd = substring(convert(varchar(8000), aaSQLGroupBy),@totlenCmd -1,@totlenGroupBy)  from ##Options   end  else  begin  select @execCmd1 =  rtrim(convert(varchar(8000), aaSQLInsert)) + space(1) +  rtrim(convert(varchar(8000), aaSQLSelect)) + space(1) +  rtrim(convert(varchar(8000), aaSQLFrom))   + space(1) +  rtrim(convert(varchar(8000), aaSQLWhere))  + space(1) +  rtrim(convert(varchar(8000), aaSQLGroupBy))  from ##Options   end    set @oStatus = 0   if LEN(@execCmd1) = 8000   begin   select @oStatus = -30   return @oStatus   end   if dbo.aagMLCancelled() = 1 goto DONE   if @iDebug = 1   begin  print @execCmd1  print @execNewCmd  end  exec ( @execCmd1 + '' + @execNewCmd)   Delete ##PreCalc where debit=0 and credit=0 and balance=0  select @execCmd = N'update ##PreCalc set aaBudgetID = 0'  if @iDebug = 1 print @execCmd  exec @retCode = sp_executesql @execCmd   if (@retCode <> 0) return @retCode   Select Top 1 @iCol = aaColumn from  ##ExpCols order by aaColumn desc   if dbo.aagMLCancelled() = 1 goto DONE   if @iCol >80   begin  EXEC @retCode= aagMLCalcBudgetValues  @iDebug  if (@retCode <> 0)   begin   select @oStatus = @retCode   return @oStatus  end  end  end  DONE:  if @iDebug = 1   begin  print ''  print '*************************'  print '** aagMLStep4 finished **'  print '*************************'  print ''  end   set nocount off  return 0    
GO
GRANT EXECUTE ON  [dbo].[aagMLStep4] TO [DYNGRP]
GO
