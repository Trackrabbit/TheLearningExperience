SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[svcCreateRemainingRevenue] (  @CONSTS                 smallint,  @CONTNBR                char(11) )  AS declare @ORIGLIABILITYAMOUNT    numeric(19,2),  @LIABILITYAMOUNT numeric(19,2),  @LNSEQNBR               numeric(19,5),  @RevenueLine int,  @UserID                 char(30),   @MinDate datetime declare @StartDate  datetime,  @EndDate    datetime, @LineEndDate datetime,  @OrigTotalInvoiced      numeric(19,2),   @TotalInvoiced          numeric(19,2),   @YEAR1      smallint,  @PERIODID   smallint  exec smGetMinDate @MinDate output  select @UserID = SUSER_SNAME()  declare createRevenue_601 cursor for select LNSEQNBR, ENDDATE from SVC00601 where CONSTS = @CONSTS and CONTNBR = @CONTNBR open createRevenue_601  FETCH NEXT FROM createRevenue_601 INTO @LNSEQNBR, @LineEndDate  while @@FETCH_STATUS = 0  BEGIN   select @LIABILITYAMOUNT = isnull(sum(Transaction_Amount),0), @ORIGLIABILITYAMOUNT = isnull(sum(OrigTransactionAmount),0),  @RevenueLine = max(LNITMSEQ) + 1  from SVC00604 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR  select @TotalInvoiced = SUM(IsNull(DOCAMNT,0) - IsNull(SVC_Invoice_Credit_Amoun,0))- SUM(isnull(DSCDLRAM,0)),  @OrigTotalInvoiced = SUM(IsNull(ORDOCAMT,0) - IsNull(OrigInvCreditAmt,0)) - SUM(isnull(ORDDLRAT,0))  from SVC00603 where CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR  exec SVC_GetFiscalPeriodDates @UserID, @LineEndDate,@StartDate OUTPUT,  @EndDate OUTPUT, @YEAR1 OUTPUT, @PERIODID OUTPUT  if @LIABILITYAMOUNT <> @TotalInvoiced  insert into SVC00604 select  2, @CONTNBR, @LNSEQNBR, @YEAR1, @PERIODID, isnull(@RevenueLine,1), 0, @MinDate,  @LineEndDate, @UserID, 0, 0, 'CAL',  CONVERT(varchar(1),2) + '-' + RTRIM(CONVERT(varchar(20),@CONTNBR)) + '-' + CONVERT(varchar(20),@LNSEQNBR),  @TotalInvoiced - @LIABILITYAMOUNT, @OrigTotalInvoiced - @ORIGLIABILITYAMOUNT,  @StartDate, @EndDate, 0, 0, 0, 0,  @TotalInvoiced - @LIABILITYAMOUNT, @OrigTotalInvoiced - @ORIGLIABILITYAMOUNT   FETCH NEXT FROM createRevenue_601 INTO @LNSEQNBR, @LineEndDate  END deallocate createRevenue_601  return    
GO
GRANT EXECUTE ON  [dbo].[svcCreateRemainingRevenue] TO [DYNGRP]
GO
