SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
 CREATE PROCEDURE [dbo].[SOP_BackOrderAllocate]   @OSName varchar(31), @FromSOPType as smallint, @ToSOPType as smallint, @From_Batch char(15), @To_Batch char(15), @From_Customer char(15), @To_Customer char(15), @From_DocID char(15), @To_DocID char(15), @From_SopNumber char(21), @ToSopNumber char(21), @From_DocDate char(15), @To_DocDate char(15), @From_UserDefined char(21), @To_UserDefined char(21), @From_SiteID char(11), @To_SiteID char(11), @From_ShipDate char(15), @To_ShipDate char(15), @From_ShipMethod char(16), @To_ShipMethod char(16), @From_Territory char(16), @To_Territory char(16), @From_Class char(15), @To_Class char(15), @From_Priority smallint, @To_Priority smallint, @UserDefinedFilled as smallint, @O_iErrorState int = NULL output AS  declare @sql_statement as varchar(8000),  @StartDocDate as varchar(10),  @EndDocDate as varchar(10),  @StartReqShipDate as varchar(10),  @EndReqShipDate as varchar(10)  set @StartDocDate = ltrim(str(datepart(month,@From_DocDate))) + '/'  + ltrim(str(datepart(day,@From_DocDate))) + '/'   + ltrim(str(datepart(year,@From_DocDate)))  set @EndDocDate = ltrim(str(datepart(month,@To_DocDate))) + '/'   + ltrim(str(datepart(day,@To_DocDate))) + '/'   + ltrim(str(datepart(year,@To_DocDate)))  set @StartReqShipDate = ltrim(str(datepart(month,@From_ShipDate))) + '/'  + ltrim(str(datepart(day,@From_ShipDate))) + '/'   + ltrim(str(datepart(year,@From_ShipDate)))  set @EndReqShipDate = ltrim(str(datepart(month,@To_ShipDate))) + '/'   + ltrim(str(datepart(day,@To_ShipDate))) + '/'   + ltrim(str(datepart(year,@To_ShipDate)))  if @ToSOPType = 0 begin  select @ToSOPType=@FromSOPType end   select @sql_statement = '' select @sql_statement = 'delete from ' + @OSName exec (@sql_statement)  CREATE TABLE [dbo].[#Working] (  [MKTOPROC] [tinyint] NOT NULL ,  [CUSTNMBR] [char] (15) NOT NULL ,  [CUSTPRIORITY] [smallint] NOT NULL ,  [ReqShipDate] [datetime] NOT NULL ,  [DOCDATE] [datetime] NOT NULL ,  [QTYTBAOR] [numeric](19, 5) NOT NULL ,  [QTYTOALLOC] [numeric](19, 5) NOT NULL ,  [SOPNUMBE] [char] (21)  NOT NULL ,  [ITEMNMBR] [char] (31)  NOT NULL ,  [UOFM] [char] (9)  NOT NULL ,  [LOCNCODE] [char] (11)  NOT NULL ,  [QTYREMBO] [numeric](19, 5) NOT NULL ,  [SOPTYPE] [smallint] NOT NULL ,  [LNITMSEQ] [int] NOT NULL ,  [CMPNTSEQ] [int] NOT NULL ,  [DECPLQTY] [smallint] NOT NULL,  [SOPSTATUS][smallint] NOT NULL,  [QTYBSUOM] [numeric](19, 5) NOT NULL,  [QTYTORDR] [numeric](19, 5) NOT NULL,  [ITEMDESC] [char] (102) NOT NULL,  [CUSTNAME] [char] (66) NOT NULL,  [ATYALLOC] [numeric](19, 5) NOT NULL,  [DOCID]    [char] (16) NOT NULL,  [USRTAB01] [char] (22) NOT NULL,  [CUSTCLAS]  [char] (16) NOT NULL,  [SHIPMTHD] [char] (16) NOT NULL,  [SALSTERR] [char] (16) NOT NULL,  [QTYFULFI] [numeric](19, 5) NOT NULL,  [USPFULPR] [tinyint] NOT NULL,  [QTYTOINV] [numeric](19, 5) NOT NULL,  [ERMSGTXT] [char] (256) NOT NULL,  [ERMSGTX2] [char] (256) NOT NULL,  [SEQ] [int] IDENTITY (1, 1) NOT NULL  ) ON [PRIMARY]  if @FromSOPType = 2 begin  insert into #Working  SELECT 0,ORD.CUSTNMBR,CUST.CUSTPRIORITY,LINE.ReqShipDate,ORD.DOCDATE,LINE.QTYTBAOR,0,   ORD.SOPNUMBE,LINE.ITEMNMBR,LINE.UOFM,LINE.LOCNCODE,0,ORD.SOPTYPE,LINE.LNITMSEQ,LINE.CMPNTSEQ,LINE.DECPLQTY,ORD.SOPSTATUS,  LINE.QTYBSUOM,LINE.QTYTORDR,LINE.ITEMDESC,ORD.CUSTNAME,0,ORD.DOCID,ISNULL(USERDEFINED.USRTAB01,''),CUST.CUSTCLAS,LINE.SHIPMTHD,  LINE.SALSTERR,0,0,LINE.QTYTOINV,'',''  FROM SOP10100 as ORD   INNER JOIN SOP10200 AS LINE   ON ORD.SOPTYPE=LINE.SOPTYPE AND ORD.SOPNUMBE = LINE.SOPNUMBE  INNER JOIN RM00101 as CUST   ON ORD.CUSTNMBR = CUST.CUSTNMBR   INNER JOIN SY00500 as BATCH   ON ORD.BCHSOURC = BATCH.BCHSOURC and ORD.BACHNUMB = BATCH.BACHNUMB   INNER JOIN IV00101 AS ITEM  ON ITEM.ITEMNMBR = LINE.ITEMNMBR   INNER JOIN SOP40200 AS SETP  ON ORD.SOPTYPE = SETP.SOPTYPE AND ORD.DOCID = SETP.DOCID  LEFT OUTER JOIN SOP10106 AS USERDEFINED   ON USERDEFINED.SOPTYPE = ORD.SOPTYPE AND USERDEFINED.SOPNUMBE = ORD.SOPNUMBE   WHERE (ORD.SOPTYPE = 2 AND (SETP.ALLOCABY =1 OR (SETP.ALLOCABY = 2 AND ORD.ALLOCABY>0)))  AND (ORD.DOCID >=  @From_DocID  AND ORD.DOCID <= @To_DocID)  AND (ORD.SOPNUMBE >=  @From_SopNumber  AND ORD.SOPNUMBE <=  @ToSopNumber)  AND (ORD.DOCDATE >=  @From_DocDate  AND ORD.DOCDATE <= @To_DocDate)  AND (BATCH.BACHNUMB >=  @From_Batch  AND BATCH.BACHNUMB <=  @To_Batch)   AND (CUST.CUSTNMBR >=   @From_Customer AND CUST.CUSTNMBR <=  @To_Customer)  AND (CUST.CUSTCLAS >=  @From_Class AND CUST.CUSTCLAS <= @To_Class)  AND (CUST.CUSTPRIORITY >= @From_Priority  AND CUST.CUSTPRIORITY <= @To_Priority)  AND ((USERDEFINED.USRTAB01 > = @From_UserDefined AND USERDEFINED.USRTAB01 <= @To_UserDefined) OR (USERDEFINED.USRTAB01 IS NULL AND @UserDefinedFilled = 1))  AND (LINE.LOCNCODE >=  @From_SiteID AND LINE.LOCNCODE <=  @To_SiteID)  AND (LINE.ReqShipDate >= @StartReqShipDate AND LINE.ReqShipDate <= @EndReqShipDate)  AND ((LINE.SHIPMTHD >=  @From_ShipMethod  AND LINE.SHIPMTHD <= @To_ShipMethod) or (LINE.SHIPMTHD = '' and LINE.CMPNTSEQ <> 0))  AND ((LINE.SALSTERR >=  @From_Territory  AND LINE.SALSTERR <= @To_Territory) or (LINE.SALSTERR = '' and LINE.CMPNTSEQ <> 0))  AND LINE.QTYTBAOR > 0  AND (LINE.QTYONPO = 0 AND LINE.NONINVEN = 0 AND LINE.DROPSHIP = 0)  AND (ITEM.ITEMTYPE IN(1,2))  end   if @FromSOPType = 5 begin  insert into #Working  SELECT 0,ORD.CUSTNMBR,CUST.CUSTPRIORITY,LINE.ReqShipDate,ORD.DOCDATE,LINE.QTYTBAOR,0,   ORD.SOPNUMBE,LINE.ITEMNMBR,LINE.UOFM,LINE.LOCNCODE,0,ORD.SOPTYPE,LINE.LNITMSEQ,LINE.CMPNTSEQ,LINE.DECPLQTY,ORD.SOPSTATUS,  LINE.QTYBSUOM,LINE.QTYTORDR,LINE.ITEMDESC,ORD.CUSTNAME,0,ORD.DOCID,ISNULL(USERDEFINED.USRTAB01,''),CUST.CUSTCLAS,LINE.SHIPMTHD,  LINE.SALSTERR,0,0,LINE.QTYTOINV,'',''  FROM SOP10100 as ORD   INNER JOIN SOP10200 AS LINE   ON ORD.SOPTYPE=LINE.SOPTYPE AND ORD.SOPNUMBE = LINE.SOPNUMBE  INNER JOIN RM00101 as CUST   ON ORD.CUSTNMBR = CUST.CUSTNMBR   INNER JOIN SY00500 as BATCH   ON ORD.BCHSOURC = BATCH.BCHSOURC and ORD.BACHNUMB = BATCH.BACHNUMB   INNER JOIN IV00101 AS ITEM  ON ITEM.ITEMNMBR = LINE.ITEMNMBR   INNER JOIN SOP40200 AS SETP  ON ORD.SOPTYPE = SETP.SOPTYPE AND ORD.DOCID = SETP.DOCID  LEFT OUTER JOIN SOP10106 AS USERDEFINED   ON USERDEFINED.SOPTYPE = ORD.SOPTYPE AND USERDEFINED.SOPNUMBE = ORD.SOPNUMBE   WHERE (ORD.SOPTYPE = 5 )  AND (ORD.DOCID >=  @From_DocID  AND ORD.DOCID <= @To_DocID)  AND (ORD.SOPNUMBE >=  @From_SopNumber  AND ORD.SOPNUMBE <=  @ToSopNumber)  AND (ORD.DOCDATE >=  @From_DocDate  AND ORD.DOCDATE <= @To_DocDate)  AND (BATCH.BACHNUMB >=  @From_Batch  AND BATCH.BACHNUMB <=  @To_Batch)   AND (CUST.CUSTNMBR >=   @From_Customer AND CUST.CUSTNMBR <=  @To_Customer)  AND (CUST.CUSTCLAS >=  @From_Class AND CUST.CUSTCLAS <= @To_Class)  AND (CUST.CUSTPRIORITY >= @From_Priority  AND CUST.CUSTPRIORITY <= @To_Priority)  AND ((USERDEFINED.USRTAB01 > = @From_UserDefined AND USERDEFINED.USRTAB01 <= @To_UserDefined) OR (USERDEFINED.USRTAB01 IS NULL AND @UserDefinedFilled = 1))  AND (LINE.LOCNCODE >=  @From_SiteID AND LINE.LOCNCODE <=  @To_SiteID)  AND (LINE.ReqShipDate >= @StartReqShipDate AND LINE.ReqShipDate <= @EndReqShipDate)  AND ((LINE.SHIPMTHD >=  @From_ShipMethod  AND LINE.SHIPMTHD <= @To_ShipMethod) or (LINE.SHIPMTHD = ''  and LINE.CMPNTSEQ <> 0))  AND ((LINE.SALSTERR >=  @From_Territory  AND LINE.SALSTERR <= @To_Territory) or (LINE.SALSTERR = '' and LINE.CMPNTSEQ <> 0))  AND QUANTITY - QTYCANCE > 0  AND (LINE.QTYONPO = 0 AND LINE.NONINVEN = 0 AND LINE.DROPSHIP = 0)  AND (ITEM.ITEMTYPE IN(1,2)) end  if @FromSOPType = 6 or @ToSOPType = 6 begin   insert into #Working  SELECT 0,ORD.CUSTNMBR,CUST.CUSTPRIORITY,LINE.ReqShipDate,ORD.DOCDATE,LINE.QTYTBAOR,0,   ORD.SOPNUMBE,LINE.ITEMNMBR,LINE.UOFM,LINE.LOCNCODE,0,ORD.SOPTYPE,LINE.LNITMSEQ,LINE.CMPNTSEQ,LINE.DECPLQTY,ORD.SOPSTATUS,  LINE.QTYBSUOM,LINE.QTYTORDR,LINE.ITEMDESC,ORD.CUSTNAME,0,ORD.DOCID,ISNULL(USERDEFINED.USRTAB01,''),CUST.CUSTCLAS,LINE.SHIPMTHD,  LINE.SALSTERR,0,0,LINE.QTYTOINV,'',''  FROM SOP10100 as ORD   INNER JOIN SOP10200 AS LINE   ON ORD.SOPTYPE=LINE.SOPTYPE AND ORD.SOPNUMBE = LINE.SOPNUMBE  INNER JOIN RM00101 as CUST   ON ORD.CUSTNMBR = CUST.CUSTNMBR   INNER JOIN SY00500 as BATCH   ON ORD.BCHSOURC = BATCH.BCHSOURC and ORD.BACHNUMB = BATCH.BACHNUMB   INNER JOIN IV00101 AS ITEM  ON ITEM.ITEMNMBR = LINE.ITEMNMBR   INNER JOIN SOP40200 AS SETP  ON 3 = SETP.SOPTYPE AND ORD.DOCID = SETP.DOCID  LEFT OUTER JOIN SOP10106 AS USERDEFINED   ON USERDEFINED.SOPTYPE = ORD.SOPTYPE AND USERDEFINED.SOPNUMBE = ORD.SOPNUMBE   WHERE (ORD.SOPTYPE = 6 AND (SETP.ALLOCABY =1 OR (SETP.ALLOCABY = 2 AND ORD.ALLOCABY>0)))  AND (ORD.DOCID >=  @From_DocID  AND ORD.DOCID <= @To_DocID)  AND (ORD.SOPNUMBE >=  @From_SopNumber  AND ORD.SOPNUMBE <=  @ToSopNumber)  AND (ORD.DOCDATE >=  @From_DocDate  AND ORD.DOCDATE <= @To_DocDate)  AND (BATCH.BACHNUMB >=  @From_Batch  AND BATCH.BACHNUMB <=  @To_Batch)   AND (CUST.CUSTNMBR >=   @From_Customer AND CUST.CUSTNMBR <=  @To_Customer)  AND (CUST.CUSTCLAS >=  @From_Class AND CUST.CUSTCLAS <= @To_Class)  AND (CUST.CUSTPRIORITY >= @From_Priority  AND CUST.CUSTPRIORITY <= @To_Priority)  AND ((USERDEFINED.USRTAB01 > = @From_UserDefined AND USERDEFINED.USRTAB01 <= @To_UserDefined) OR (USERDEFINED.USRTAB01 IS NULL AND @UserDefinedFilled = 1))  AND (LINE.LOCNCODE >=  @From_SiteID AND LINE.LOCNCODE <=  @To_SiteID)  AND (LINE.ReqShipDate >= @StartReqShipDate AND LINE.ReqShipDate <= @EndReqShipDate)  AND ((LINE.SHIPMTHD >=  @From_ShipMethod  AND LINE.SHIPMTHD <= @To_ShipMethod) or (LINE.SHIPMTHD = ''  and LINE.CMPNTSEQ <> 0))  AND ((LINE.SALSTERR >=  @From_Territory  AND LINE.SALSTERR <= @To_Territory) or (LINE.SALSTERR = '' and LINE.CMPNTSEQ <> 0))  AND LINE.QTYTBAOR > 0  AND (LINE.QTYONPO = 0 AND LINE.NONINVEN = 0 AND LINE.DROPSHIP = 0)  AND (ITEM.ITEMTYPE IN(1,2))  end  delete  from #Working where SEQ not in (select SEQ from #Working   INNER JOIN IV00101 AS ITEM  ON ITEM.ITEMNMBR = #Working.ITEMNMBR   INNER JOIN SOP10200 AS LINE   ON  LINE.SOPTYPE=#Working.SOPTYPE   AND LINE.SOPNUMBE = #Working.SOPNUMBE   AND LINE.LNITMSEQ = #Working.LNITMSEQ  AND LINE.CMPNTSEQ = 0  WHERE  (#Working.CMPNTSEQ > 0   AND ITEM.ITEMTYPE IN(1,2)  AND (LINE.SHIPMTHD >= @From_ShipMethod AND LINE.SHIPMTHD <= @To_ShipMethod)  AND (LINE.SALSTERR >=  @From_Territory AND LINE.SALSTERR <= @To_Territory))  OR #Working.CMPNTSEQ = 0)  update #Working set CUSTPRIORITY = 101 where CUSTPRIORITY = 1  select @sql_statement = ''  select @sql_statement = 'insert into  ' + @OSName  select @sql_statement = @sql_statement + ' select MKTOPROC, CUSTNMBR, CUSTPRIORITY, ReqShipDate, DOCDATE, QTYTBAOR,' select @sql_statement = @sql_statement + ' QTYTOALLOC, SOPNUMBE, ITEMNMBR, UOFM, LOCNCODE, QTYREMBO, SOPTYPE,' select @sql_statement = @sql_statement + ' LNITMSEQ, CMPNTSEQ, DECPLQTY,SOPSTATUS,QTYBSUOM,QTYTORDR,'''',ITEMDESC,CUSTNAME,ATYALLOC,DOCID, ' select @sql_statement = @sql_statement + ' USRTAB01,CUSTCLAS,SHIPMTHD,SALSTERR,QTYFULFI,USPFULPR,QTYTOINV,'''',''''' select @sql_statement = @sql_statement + ' from #Working ' select @sql_statement = @sql_statement + ' where (SOPTYPE= 2) OR (SOPTYPE = 6 AND SOPSTATUS = 2) or (SOPTYPE=5)'  exec (@sql_statement)    
GO
GRANT EXECUTE ON  [dbo].[SOP_BackOrderAllocate] TO [DYNGRP]
GO
