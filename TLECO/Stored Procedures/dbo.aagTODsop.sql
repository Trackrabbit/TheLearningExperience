SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create       procedure [dbo].[aagTODsop]  @SqlSessionID int as  begin  set nocount on  declare @CMPANYID int,  @HdrID int,  @DOCTYPE int,  @DOCNUMBR char(21)    select @CMPANYID = CMPANYID from DYNAMICS.dbo.SY01500 where INTERID = DB_NAME()  select @HdrID = dbo.aagGetNextHdrID(20000) - 1   declare CSOP cursor fast_forward for  select SOPTYPE,SOPNUMBE   from SOP10100  union all  select SOPTYPE,SOPNUMBE  from SOP30200  open CSOP  fetch next from CSOP into @DOCTYPE,@DOCNUMBR  while @@fetch_status = 0  begin  insert into AAG20000  (aaSubLedgerHdrID,SERIES,DOCTYPE,DOCNUMBR,Master_ID,aaHdrErrors)  values(dbo.aagGetNextHdrID(20000),11,@DOCTYPE,@DOCNUMBR,' ',0)   fetch next from CSOP into @DOCTYPE,@DOCNUMBR  end  close CSOP  deallocate CSOP  update DYNAMICS..AAG00102 set aaRowID = dbo.aagGetNextHdrID(20000) - 1  where aaTableID = 20000 and CMPANYID = @CMPANYID   insert into AAG20001  (aaSubLedgerHdrID,   aaSubLedgerDistID,   INTERID, ACTINDX, DISTTYPE, aaBrowseType,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, CURNCYID, CURRNIDX, SEQNUMBR,  GLPOSTDT, aaCustID, POSTED ,RATETPID, EXGTBLID, XCHGRATE, EXCHDATE, TIME1,  RTCLCMTD, DENXRATE, MCTRXSTT,aaChangeDate,aaChangeTime,ACCTTYPE)   select dbo.aagGetHdrID(11,SOP10102.SOPTYPE,SOP10102.SOPNUMBE,' ',0,0, getdate(),0,' ',20000),  SOP10102.DEX_ROW_ID,   DB_NAME(), SOP10102.ACTINDX,SOP10102.DISTTYPE, 0,   SOP10102.DEBITAMT, SOP10102.CRDTAMNT, SOP10102.ORDBTAMT, SOP10102.ORCRDAMT, SOP10100.CURNCYID, SOP10100.CURRNIDX, SOP10102.SEQNUMBR,  SOP10100.DOCDATE, '', SOP10102.POSTED ,SOP10100.RATETPID, SOP10100.EXGTBLID, SOP10100.XCHGRATE, SOP10100.EXCHDATE, SOP10100.TIME1,  SOP10100.RTCLCMTD, SOP10100.DENXRATE, SOP10100.MCTRXSTT,convert(char(12), getdate(), 102),convert(char(12), getdate(), 108),  dbo.aagGetAccountType(SOP10102.ACTINDX)  from SOP10102, SOP10100  where SOP10102.SOPTYPE = SOP10100.SOPTYPE and  SOP10102.SOPNUMBE = SOP10100.SOPNUMBE  union all  select dbo.aagGetHdrID(11,SOP10102.SOPTYPE,SOP10102.SOPNUMBE,' ',0,0, getdate(),0,' ',20000),  SOP10102.DEX_ROW_ID,   DB_NAME(), SOP10102.ACTINDX,SOP10102.DISTTYPE, 0,   SOP10102.DEBITAMT, SOP10102.CRDTAMNT, SOP10102.ORDBTAMT, SOP10102.ORCRDAMT, SOP30200.CURNCYID, SOP30200.CURRNIDX, SOP10102.SEQNUMBR,  SOP30200.DOCDATE, '', SOP10102.POSTED ,SOP30200.RATETPID, SOP30200.EXGTBLID, SOP30200.XCHGRATE, SOP30200.EXCHDATE, SOP30200.TIME1,  SOP30200.RTCLCMTD, SOP30200.DENXRATE, SOP30200.MCTRXSTT,convert(char(12), getdate(), 102),convert(char(12), getdate(), 108),  dbo.aagGetAccountType(SOP10102.ACTINDX)  from SOP10102, SOP30200  where SOP10102.SOPTYPE = SOP30200.SOPTYPE and  SOP10102.SOPNUMBE = SOP30200.SOPNUMBE  Update AAG20001 SET aaSubLedgerDistID=0-aaSubLedgerDistID  where aaSubLedgerHdrID not in (select distinct aaSubLedgerHdrID from AAG20002)  UPDATE AAG20001   SET aaSubLedgerDistID = (SELECT COUNT(1) FROM AAG20001 AA WHERE AAG20001.DEX_ROW_ID >= AA.DEX_ROW_ID AND AA.aaSubLedgerHdrID = AAG20001.aaSubLedgerHdrID )  where AAG20001.aaSubLedgerHdrID not in (select distinct aaSubLedgerHdrID from AAG20002)   insert into AAG20002   (aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID,DEBITAMT,  CRDTAMNT,ORDBTAMT,ORCRDAMT,aaAssignedPercent,DistRef,NOTEINDX,aaAssignErrors)  select aaSubLedgerHdrID,aaSubLedgerDistID,1,DEBITAMT,  CRDTAMNT,ORDBTAMT,ORCRDAMT,10000,' ',0,0 from AAG20001 where aaSubLedgerHdrID in  (select aaSubLedgerHdrID from AAG20000 where SERIES = 11)  set nocount off end    
GO
GRANT EXECUTE ON  [dbo].[aagTODsop] TO [DYNGRP]
GO
