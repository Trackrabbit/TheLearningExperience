SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[glGetNextReconciliationNumber]  @I_iSQLSessionID                        int             = NULL,  @IO_iOUTReconciliationID int             = NULL  output,  @O_RecIDFound                           tinyint   = NULL  output,  @O_iErrorState                          int             = NULL  output as  declare         @iRecIDOK int,  @TRUE int,  @NEW int,   @tTransaction tinyint,  @iError int  if ((@IO_iOUTReconciliationID is NULL) or  (@I_iSQLSessionID is NULL) ) begin  select          @O_iErrorState = 20159,  @IO_iOUTReconciliationID = 0,  @O_RecIDFound = 0  return end  select  @O_RecIDFound               = 0,  @IO_iOUTReconciliationID = 0,  @O_iErrorState    = 0,  @iRecIDOK     = 1,     @TRUE      = 1,  @NEW       = 0  if @@trancount = 0 begin  select @tTransaction = 1  begin transaction end  while (@iRecIDOK <> @NEW) begin  update  GL40000  set @IO_iOUTReconciliationID = NextReconciliationNumber,  NextReconciliationNumber = NextReconciliationNumber + 1   if ( @@rowcount <> 1)  begin  select  @O_iErrorState  = 20075  break  end   if (@IO_iOUTReconciliationID = 99999999) or (@IO_iOUTReconciliationID = 0)  begin  select @IO_iOUTReconciliationID = 1   update  GL40000  set  NextReconciliationNumber = 2   if ( @@rowcount <> 1)  begin  select @O_iErrorState = 20075  break  end  end   if not exists (  select  1  from  GL40401 with (NOLOCK)  where  Reconciliation_Number = @IO_iOUTReconciliationID)  begin  select @iRecIDOK = @NEW     end  else   begin  select @iRecIDOK = 1  end   if ( @iRecIDOK = @NEW)   begin  if not exists (  select  1  from  GL40402 with (NOLOCK)  where  Reconciliation_Number = @IO_iOUTReconciliationID)  begin  select @iRecIDOK = 0     end  else   begin  select @iRecIDOK = 1  end  end  end   if @O_iErrorState <> 0 begin  select @IO_iOUTReconciliationID = 0  if @tTransaction = 1  rollback transaction end else begin  select  @O_RecIDFound = @TRUE  if @tTransaction = 1  commit transaction end  return   
GO
GRANT EXECUTE ON  [dbo].[glGetNextReconciliationNumber] TO [DYNGRP]
GO
