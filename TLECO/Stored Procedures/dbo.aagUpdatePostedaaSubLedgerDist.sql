SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 Create procedure [dbo].[aagUpdatePostedaaSubLedgerDist]  @iHdrID int,  @iHdrIDPrimary int = NULL,  @I_cSource char(30),  @I_nMCRegistered tinyint as begin  set nocount on  declare @Series tinyint,  @DocType smallint,  @DocNum varchar(20),  @PostedDate datetime,  @SeqNum int,  @nSeqNum int,  @nIVAcct int,  @nIVOffsetAcct int,  @nExtdCostAmt numeric(19,5),  @sFunCurr varchar(15),  @nFuncCurrIndex int,  @nCurrDecPlaces int,  @nDistID int,  @blankdate datetime,  @nQty numeric(19,5),  @LineSEQ int,  @Count int,  @DistsDeleted tinyint,  @TrxQty numeric(19,5)   set @blankdate = '01-01-1800'   set @PostedDate = @blankdate   if @iHdrIDPrimary is not NULL and @iHdrIDPrimary <> 0  begin  if exists(select top 1 aaSubLedgerHdrID from AAG20001 where aaSubLedgerHdrID = @iHdrIDPrimary and POSTED=1)  return   select @Series=SERIES, @DocType=DOCTYPE, @DocNum=DOCNUMBR from AAG20000 where aaSubLedgerHdrID = @iHdrIDPrimary  end  else  begin   select @Series=SERIES, @DocType=DOCTYPE, @DocNum=DOCNUMBR from AAG20000 where aaSubLedgerHdrID = @iHdrID  end   Exec aagUpdateSubLedCustVendItemSiteInfoALLDists @iHdrID, @iHdrIDPrimary, @I_cSource   if @Series = 3 and @I_cSource = ''   begin  if @DocType = 9  select @PostedDate = GLPOSTDT from RM10201 where DOCNUMBR = @DocNum  else  select @PostedDate = GLPOSTDT from RM10301 where DOCNUMBR = @DocNum   if @PostedDate <> @blankdate  update AAG20001 set GLPOSTDT = @PostedDate, POSTED = 1  where aaSubLedgerHdrID = @iHdrID and POSTED = 0  end   else if @Series = 3 and @I_cSource <> ''  begin  if @I_cSource = 'NSF'  select @PostedDate = POSTEDDT from RM10101 where DOCNUMBR = @DocNum  else  select @PostedDate = POSTEDDT from RM10101  where DOCNUMBR = @DocNum and SEQNUMBR =  (select max(SEQNUMBR) from RM10101 where DOCNUMBR = @DocNum)  if @PostedDate <> @blankdate  update AAG20001 set GLPOSTDT = @PostedDate, POSTED = 1  where aaSubLedgerHdrID = @iHdrID and POSTED = 0  end  else if @Series = 4 and @I_cSource = ''   begin  select @PostedDate = PSTGDATE from PM10100  where CNTRLTYP = @DocType and VCHRNMBR = @DocNum  update AAG20001 set GLPOSTDT = @PostedDate , POSTED = 1 where aaSubLedgerHdrID = @iHdrID  delete AAG20001  from AAG20000  join AAG20001  on AAG20000.aaSubLedgerHdrID = AAG20001.aaSubLedgerHdrID  where AAG20000.aaSubLedgerHdrID = @iHdrID and AAG20000.DOCNUMBR = @DocNum  and AAG20000.SERIES = 4 and AAG20000.DOCTYPE = @DocType   and (AAG20001.CRDTAMNT + AAG20001.DEBITAMT + AAG20001.ORDBTAMT + AAG20001.ORCRDAMT) = 0   DELETE AAG20002  WHERE aaSubLedgerHdrID = @iHdrID   AND NOT EXISTS  (SELECT 1 FROM AAG20001  WHERE aaSubLedgerHdrID = AAG20002.aaSubLedgerHdrID   AND aaSubLedgerDistID = AAG20002.aaSubLedgerDistID)   DELETE AAG20003  WHERE aaSubLedgerHdrID = @iHdrID   AND NOT EXISTS  (SELECT 1 FROM AAG20001  WHERE aaSubLedgerHdrID = AAG20003.aaSubLedgerHdrID   AND aaSubLedgerDistID = AAG20003.aaSubLedgerDistID)   IF (SELECT COUNT(*)  FROM AAG20001  WHERE aaSubLedgerHdrID = @iHdrID)   <> (SELECT MAX(aaSubLedgerDistID)  FROM AAG20001  WHERE aaSubLedgerHdrID = @iHdrID)  BEGIN   EXEC aagReNumberPMDistID @iHdrID  END  end  else if @Series = 4 and @I_cSource <> ''   begin  select @PostedDate = GLPOSTDT from PM20200  where DOCTYPE = 6 and VCHRNMBR = @DocNum  update AAG20001 set GLPOSTDT = @PostedDate , POSTED = 1 where aaSubLedgerHdrID = @iHdrID and POSTED = 0  end  else if @Series = 5   begin   set @PostedDate = @blankdate  select @PostedDate = GLPOSTDT  from IV30200   where IVDOCTYP = @DocType and DOCNUMBR = @DocNum   if @PostedDate = @blankdate  select @PostedDate = GLPOSTDT  from IV10000   where IVDOCTYP = @DocType and IVDOCNBR = @DocNum   if @PostedDate <> @blankdate  update AAG20001 set GLPOSTDT = @PostedDate , POSTED = 1  where aaSubLedgerHdrID = @iHdrID and POSTED = 0   IF @I_nMCRegistered = 0  SELECT @sFunCurr = '', @nFuncCurrIndex = 0, @nCurrDecPlaces = 0  else  BEGIN  SELECT @sFunCurr = FUNLCURR, @nFuncCurrIndex = FUNCRIDX from MC40000  select @nCurrDecPlaces = DECPLCUR - 1 from DYNAMICS.dbo.MC40200 where CURRNIDX = @nFuncCurrIndex  END   Delete from AAG20002 Where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID IN  (Select aaSubLedgerDistID from AAG20001 Where aaSubLedgerHdrID = @iHdrID and TRXQTY = 0)  Set @DistsDeleted = 0  Delete from AAG20001 Where aaSubLedgerHdrID = @iHdrID and TRXQTY = 0  If @@RowCount <> 0   Set @DistsDeleted = 1  declare curUpdateSLDist cursor fast_forward FOR  select LNSEQNBR, IVIVINDX, IVIVOFIX, TRXQTY, EXTDCOST  from IV30300 where DOCTYPE = @DocType and DOCNUMBR = @DocNum  order by LNSEQNBR   Open curUpdateSLDist  Fetch next from curUpdateSLDist into @nSeqNum, @nIVAcct, @nIVOffsetAcct, @TrxQty, @nExtdCostAmt  WHILE @@fetch_status = 0  begin  set @nDistID = Null    Select @nDistID = aaSubLedgerDistID from AAG20001  where aaSubLedgerHdrID = @iHdrID and SEQNUMBR = @nSeqNum and  ACTINDX = @nIVAcct and aaOffsetAcct = 0   If @DocType = 3 or @TrxQty < 0  Begin  update AAG20001  set DECPLACS = @nCurrDecPlaces,  CRDTAMNT = @nExtdCostAmt,  CURNCYID = @sFunCurr,  CURRNIDX = @nFuncCurrIndex  Where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID = @nDistID    update AAG20002 set CRDTAMNT = @nExtdCostAmt where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID = @nDistID   End  Else  Begin  update AAG20001  set DECPLACS = @nCurrDecPlaces,  DEBITAMT = @nExtdCostAmt,  CURNCYID = @sFunCurr,  CURRNIDX = @nFuncCurrIndex  Where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID = @nDistID   update AAG20002 set DEBITAMT = @nExtdCostAmt where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID = @nDistID   End   Select @nDistID = aaSubLedgerDistID from AAG20001  where aaSubLedgerHdrID = @iHdrID and SEQNUMBR = @nSeqNum and  ACTINDX = @nIVOffsetAcct and aaOffsetAcct = 1   If @DocType = 3 or @TrxQty < 0  Begin  update AAG20001  set DECPLACS = @nCurrDecPlaces,  DEBITAMT = @nExtdCostAmt,  CURNCYID = @sFunCurr,  CURRNIDX = @nFuncCurrIndex  Where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID = @nDistID   update AAG20002 set DEBITAMT = @nExtdCostAmt where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID = @nDistID   End  Else  Begin  update AAG20001  set DECPLACS = @nCurrDecPlaces,  CRDTAMNT = @nExtdCostAmt,  CURNCYID = @sFunCurr,  CURRNIDX = @nFuncCurrIndex  Where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID = @nDistID   update AAG20002 set CRDTAMNT = @nExtdCostAmt where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID = @nDistID   End   Fetch next from curUpdateSLDist into @nSeqNum, @nIVAcct, @nIVOffsetAcct, @TrxQty, @nExtdCostAmt  end   close curUpdateSLDist  deallocate curUpdateSLDist   If @DistsDeleted = 1  Begin   declare curUpdateSLDist cursor fast_forward FOR  select LNSEQNBR, IVIVINDX, IVIVOFIX, EXTDCOST  from IV30300 where DOCTYPE = @DocType and DOCNUMBR = @DocNum  order by LNSEQNBR   Declare curUpdate20001 cursor FOR  select aaSubLedgerDistID, SEQNUMBR, TRXQTY from AAG20001  where aaSubLedgerHdrID = @iHdrID  order by aaSubLedgerDistID  For UPDATE Of aaSubLedgerDistID, SEQNUMBR   open curUpdateSLDist  open curUpdate20001  Fetch next from curUpdate20001 into @nDistID, @LineSEQ, @nQty  Fetch next from curUpdateSLDist into @nSeqNum, @nIVAcct, @nIVOffsetAcct, @nExtdCostAmt   Set @Count = 1  While @@fetch_status = 0  Begin  If @Count <> @nDistID  Begin  Update AAG20003 Set aaSubLedgerDistID = @Count Where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID = @nDistID  Update AAG20002 Set aaSubLedgerDistID = @Count Where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID = @nDistID  Update AAG20001 Set aaSubLedgerDistID = @Count, SEQNUMBR = @nSeqNum Where Current Of curUpdate20001  End   Fetch next from curUpdate20001 into @nDistID, @LineSEQ, @nQty   If @Count % 2 = 0   Fetch next from curUpdateSLDist into @nSeqNum, @nIVAcct, @nIVOffsetAcct, @nExtdCostAmt   Set @Count = @Count + 1  End   close curUpdateSLDist  deallocate curUpdateSLDist  close curUpdate20001  deallocate curUpdate20001  End  End   else if @Series = 12   begin  select @PostedDate = GLPOSTDT from POP10300 where POPTYPE = @DocType and POPRCTNM = @DocNum update AAG20001 set GLPOSTDT = @PostedDate , POSTED = 1 where aaSubLedgerHdrID = @iHdrID   end   else if @Series = 11   begin   select @PostedDate = GLPOSTDT from SOP30200 where SOPTYPE = @DocType and SOPNUMBE = @DocNum update AAG20001 set GLPOSTDT = @PostedDate , POSTED = 1 where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID > 0   end  set nocount off end    
GO
GRANT EXECUTE ON  [dbo].[aagUpdatePostedaaSubLedgerDist] TO [DYNGRP]
GO
