SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[icpmValidateIC]  @I_cBatchNumber char(15)  = NULL,  @I_cBatchSource  char(15)  = NULL,  @I_cOrigICID    char(5)  = NULL,  @I_tICRegistered tinyint  = NULL,   @O_tICError tinyint = NULL output,  @O_iErrorState      int             = NULL  output as   declare  @TRUE                   tinyint,   @FALSE         tinyint,   @MS_ITEM_14 int,  @MS_ITEM_26 int,  @MS_ITEM_27 int,  @tLoop          tinyint,  @sPURCHASING smallint,  @BOGUS char(15)  select  @O_iErrorState  = 0  while (@tLoop is NULL) begin      select @tLoop = 1   if      @I_cBatchNumber is NULL or   @I_cBatchSource  is NULL or  @I_tICRegistered  is NULL or  @I_cOrigICID   is NULL  begin  select @O_iErrorState = 21005   break  end    select  @TRUE           = 1,   @FALSE          = 0,   @MS_ITEM_14 = power(2,21),  @MS_ITEM_26 = power(2,1),  @MS_ITEM_27 = power(2,2),  @sPURCHASING = 4    update   PM10000   set  PMWRKMSG = 0x00000000,  PMWRKMS2 = 0x00000000,  PMDSTMSG = 0x00000000,  PMICMSGS = 0x00000000   where  PM10000.BCHSOURC = @I_cBatchSource  and PM10000.BACHNUMB  = @I_cBatchNumber  and (PMWRKMSG <> 0x00000000   or PMWRKMS2 <> 0x00000000  or PMDSTMSG <> 0x00000000  or PMICMSGS <> 0x00000000)   update   PM10000   set  PM10000.PMWRKMSG = (PM10000.PMWRKMSG | @MS_ITEM_26)  from   PM10000   join PM10100   on (PM10000.VCHNUMWK   = PM10100.VCHRNMBR   and PM10000.CNTRLTYP   = PM10100.CNTRLTYP   and PM10100.INTERID  <> @I_cOrigICID)  where  PM10000.BCHSOURC = @I_cBatchSource  and PM10000.BACHNUMB  = @I_cBatchNumber   and     PM10000.ICTRX   = @FALSE   if @@rowcount <> 0   select  @O_tICError  = @TRUE   update   PM10000   set  ICDISTS = @TRUE   where  PM10000.BCHSOURC = @I_cBatchSource  and PM10000.BACHNUMB  = @I_cBatchNumber   and    PM10000.ICDISTS  = @FALSE   and exists (  select   1   from  PM10100   where   PM10100.VCHRNMBR  =  PM10000.VCHNUMWK   and PM10100.CNTRLTYP  =  PM10000.CNTRLTYP   and PM10100.INTERID   <> @I_cOrigICID)    update   PM10000   set  ICDISTS = @FALSE  where  PM10000.BCHSOURC = @I_cBatchSource  and PM10000.BACHNUMB  = @I_cBatchNumber   and     PM10000.ICDISTS  = @TRUE   and not exists(  select  1   from  PM10100   where  PM10100.VCHRNMBR  =  PM10000.VCHNUMWK   and PM10100.CNTRLTYP  =  PM10000.CNTRLTYP  and PM10100.INTERID   <> @I_cOrigICID)   if @I_tICRegistered = @FALSE   begin  update   PM10000   set  PMWRKMSG = (PMWRKMSG | @MS_ITEM_27)  where   BCHSOURC  = @I_cBatchSource   and BACHNUMB  = @I_cBatchNumber  and (ICDISTS   = @TRUE   or ICTRX  = @TRUE)    if @@rowcount <> 0   select  @O_tICError  = @TRUE  end     update   PM10000   set  PM10000.PMICMSGS = (PM10000.PMICMSGS | @MS_ITEM_14)  from  PM10000  join PM10100   on (PM10000.VCHNUMWK = PM10100.VCHRNMBR  and PM10000.CNTRLTYP = PM10100.CNTRLTYP  and PM10100.INTERID <> @I_cOrigICID)  join DTA10100 with (NOLOCK)  on (PM10100.DSTINDX  = DTA10100.ACTINDX  and PM10100.DSTSQNUM = DTA10100.SEQNUMBR  and (PM10100.VCHRNMBR = substring(DTA10100.DTAREF,1,20))  and  DTA10100.DTASERIES = @sPURCHASING)  where  PM10000.BCHSOURC = @I_cBatchSource   and PM10000.BACHNUMB = @I_cBatchNumber  and  PM10000.ICDISTS  = @TRUE  if @@rowcount <> 0   select  @O_tICError  = @TRUE  end   return     
GO
GRANT EXECUTE ON  [dbo].[icpmValidateIC] TO [DYNGRP]
GO
