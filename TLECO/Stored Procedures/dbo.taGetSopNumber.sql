SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[taGetSopNumber]  @I_tSOPTYPE tinyint = NULL, @I_cDOCID char (15) = NULL,  @I_tInc_Dec tinyint = NULL, @O_vSopNumber varchar(21) = NULL output, @O_iErrorState int = NULL output    with encryption as  set transaction isolation level read uncommitted set nocount on  declare   @iError int,  @iStatus int,  @vSopNumber varchar (21),  @NextSopSetupNum tinyint,  @DocExists tinyint,   @Loop int,  @tTransaction tinyint  select @O_vSopNumber = '',  @NextSopSetupNum = 0,  @O_iErrorState  = 0,  @Loop = 0,  @DocExists = 1,  @tTransaction = 0  if   @I_cDOCID is NULL or  @I_tSOPTYPE is NULL or  @I_tInc_Dec is NULL  begin  select @O_iErrorState = 3394    return end  if @@trancount = 0 begin  select @tTransaction = 1  begin transaction end  if (@I_tSOPTYPE = 6) begin  select @I_tSOPTYPE = 3 end  select @O_vSopNumber = SOPNUMBE from SOP40200 WITH (TABLOCKX HOLDLOCK)  where DOCID = @I_cDOCID and SOPTYPE = @I_tSOPTYPE  if (@O_vSopNumber = '') and ((select USNXTINV from SOP40200 (nolock) where DOCID = @I_cDOCID and SOPTYPE = @I_tSOPTYPE) = 1) begin  select @O_vSopNumber = SOPNUMBE from SOP40200 WITH (TABLOCKX HOLDLOCK)  where SOPTYPE = 3 and DOCID in (select USDOCID1 from SOP40200 (nolock) where DOCID = @I_cDOCID and SOPTYPE = @I_tSOPTYPE) end  if (@O_vSopNumber = '') begin  select 1 from SOP40200 (nolock)   select @O_vSopNumber = SOPNUMBE from SOP40300 WITH (TABLOCKX HOLDLOCK)  where SOPTYPE = @I_tSOPTYPE  select @NextSopSetupNum = 1 end  if (@O_vSopNumber = '') begin  select @O_iErrorState = 3388    end  if @O_iErrorState = 0 begin  select @vSopNumber = @O_vSopNumber    while (@Loop < 1000)  begin  select @Loop = @Loop + 1   exec @iStatus = ivNumber_Inc_Dec  @I_tInc_Dec,  @vSopNumber output,  @O_iErrorState output  select @iError = @@error  if (@iError <> 0 or @iStatus <> 0 or @O_iErrorState <> 0)  begin  select @O_iErrorState = 3411    select @DocExists = 0  break  end   if (exists (select 1 from SOP10100 (nolock) where SOPTYPE = @I_tSOPTYPE and SOPNUMBE = @vSopNumber  union select 1 from SOP30200 (nolock) where SOPTYPE = @I_tSOPTYPE and SOPNUMBE = @vSopNumber))  begin  select @DocExists = 1  end  else  begin  if (exists (select 1 from SOP10100 (nolock) where SOPTYPE = @I_tSOPTYPE and SOPNUMBE = @O_vSopNumber  union select 1 from SOP30200 (nolock) where SOPTYPE = @I_tSOPTYPE and SOPNUMBE = @O_vSopNumber))  begin  select @O_vSopNumber = @vSopNumber  end  else  begin  select @DocExists = 0  break  end  end  end   if (@DocExists = 1)  begin  select @O_iErrorState = 3419    end   if (@O_iErrorState = 0)  begin  if (@NextSopSetupNum = 0)  begin  update SOP40200 set SOPNUMBE = @vSopNumber  where DOCID = @I_cDOCID and SOPTYPE = @I_tSOPTYPE  end  else  update SOP40300 set SOPNUMBE = @vSopNumber  where SOPTYPE = @I_tSOPTYPE  if (@@error <> 0)  begin  select @O_iErrorState = 3412    end  end end  if (@O_iErrorState <> 0) begin  select @O_vSopNumber = ''   if @tTransaction = 1  begin  rollback transaction  end end else begin  if @tTransaction = 1  begin  commit transaction  end end  return (@O_iErrorState)   
GO
GRANT EXECUTE ON  [dbo].[taGetSopNumber] TO [DYNGRP]
GO
