SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE PROCEDURE [dbo].[aagInitFAAssetAcct] @aaAssetIndex INTEGER, @aaBookIndex INTEGER,  @I_nCompanyID SMALLINT, @aaFASetupID INTEGER OUTPUT AS BEGIN   DECLARE @ListID INTEGER,  @aaAcctType INTEGER,  @ACCOUNTINDX INTEGER,  @ClassID INTEGER,  @aaBrowseTypeNew SMALLINT,  @oRequiredFieldEmpty TINYINT,  @aaAliasID INTEGER,  @DistID INTEGER,  @OLDaaSubLedgerHdrID INTEGER,  @nStatus SMALLINT   SET @aaBookIndex = 0  DECLARE BKINDX CURSOR FAST_FORWARD FOR  SELECT 0 AS BOOKINDX UNION  SELECT BOOKINDX FROM FA00200 WHERE ASSETINDEX = @aaAssetIndex  OPEN BKINDX  FETCH NEXT FROM BKINDX INTO @aaBookIndex  WHILE @@FETCH_STATUS = 0  BEGIN  SET @aaFASetupID = 0  SELECT @aaFASetupID = ISNULL(aaFASetupID,0) FROM AAG04000 WHERE aaAssetIndex = @aaAssetIndex AND aaBookIndex = @aaBookIndex  IF @aaFASetupID = 0  EXEC DYNAMICS.dbo.aagGetNextID   20000,   @I_nCompanyID,   @aaFASetupID OUT,   @nStatus OUT    SELECT @ListID = 1  DECLARE ACTINDX CURSOR FAST_FORWARD FOR  SELECT ACT FROM (SELECT ASSETINDEX, DEPREXPACCTINDX, DEPRRESVACCTINDX, PRIORYRDEPRACCTINDX, ASSETCOSTACCTINDX, PROCEEDSACCTINDX,   RECGAINLOSSACCTINDX, NONRECGAINLOSSACCTINDX, CLEARINGACCTINDX FROM FA00400 WHERE ASSETINDEX = @aaAssetIndex) p  UNPIVOT (ACT FOR ASSETI in ( DEPREXPACCTINDX, DEPRRESVACCTINDX, PRIORYRDEPRACCTINDX, ASSETCOSTACCTINDX, PROCEEDSACCTINDX,   RECGAINLOSSACCTINDX, NONRECGAINLOSSACCTINDX, CLEARINGACCTINDX )) AS A WHERE ASSETINDEX = @aaAssetIndex  OPEN ACTINDX  FETCH NEXT FROM ACTINDX INTO @ACCOUNTINDX  WHILE @@FETCH_STATUS = 0  BEGIN  IF NOT EXISTS (SELECT TOP 1 1 FROM AAG04000 WHERE aaFASetupID=@aaFASetupID AND ListID=@ListID AND ACTINDX = @ACCOUNTINDX)  BEGIN   DELETE FROM AAG04000 WHERE aaFASetupID=@aaFASetupID AND ListID=@ListID  DELETE FROM AAG04001 WHERE aaFASetupID=@aaFASetupID AND ListID=@ListID   EXEC aagGetClassIDBrowseType   @ACCOUNTINDX,   @ClassID output,   @aaBrowseTypeNew output    SELECT TOP 1 @aaAliasID=ISNULL(aaAliasID,0) FROM FA00100 WHERE ASSETINDEX = @aaAssetIndex  SELECT @aaAcctType = ACCTTYPE FROM GL00100 WHERE ACTINDX = @ACCOUNTINDX  INSERT INTO AAG04000  (aaFASetupID,ListID,INTERID,USERID,SERIES,ACTINDX,ACCTTYPE,aaBrowseType,aaAssetIndex,aaBookIndex,aaAliasID)  VALUES(@aaFASetupID,@ListID,DB_NAME(),SYSTEM_USER,2,@ACCOUNTINDX,@aaAcctType,@aaBrowseTypeNew,@aaAssetIndex,@aaBookIndex,@aaAliasID)   IF @aaBrowseTypeNew <> 0   AND NOT EXISTS  (SELECT TOP 1 1 FROM AAG04001  WHERE aaFASetupID = @aaFASetupID AND ListID = @ListID)  BEGIN   EXEC aagFASetupCodeUpdate   @aaFASetupID,   @ListID,   @ClassID,   @oRequiredFieldEmpty output   UPDATE AAG04001 SET aaTrxDimCodeID = ISNULL((SELECT TOP 1 AAG00801.aaTrxDimCodeID FROM AAG00801 WHERE AAG00801.aaTrxDimID = AAG04001.aaTrxDimID AND AAG00801.aaAliasID = @aaAliasID),0)  FROM AAG04001 WHERE aaFASetupID = @aaFASetupID AND ListID = @ListID   SET @aaBrowseTypeNew = 0   END    END  SET @ListID = @ListID + 1   FETCH NEXT FROM ACTINDX INTO @ACCOUNTINDX  END   CLOSE ACTINDX  DEALLOCATE ACTINDX    DECLARE UPDATECODE CURSOR FAST_FORWARD FOR  SELECT DISTINCT ListID FROM AAG04001 WHERE aaFASetupID = @aaFASetupID GROUP BY ListID HAVING SUM(aaTrxDimCodeID)<1  OPEN UPDATECODE  FETCH NEXT FROM UPDATECODE INTO @DistID  WHILE @@FETCH_STATUS = 0  BEGIN  UPDATE AAG04000 SET aaAliasID = ISNULL((SELECT aaAliasID FROM FA00100 WHERE ASSETINDEX = @aaAssetIndex),0) FROM AAG04000   WHERE aaFASetupID = @aaFASetupID AND ListID = @DistID   UPDATE AAG04001 SET aaTrxDimCodeID = ISNULL((SELECT TOP 1 AAG00801.aaTrxDimCodeID FROM AAG00801 WHERE AAG00801.aaTrxDimID = AAG04001.aaTrxDimID AND   AAG00801.aaAliasID = ISNULL((SELECT TOP 1 aaAliasID FROM AAG04000 WHERE aaFASetupID = @aaFASetupID AND ListID = @DistID),0)),0)  FROM AAG04001 WHERE aaFASetupID = @aaFASetupID AND ListID = @DistID   FETCH NEXT FROM UPDATECODE INTO @DistID  END   CLOSE UPDATECODE  DEALLOCATE UPDATECODE    FETCH NEXT FROM BKINDX INTO @aaBookIndex  END   CLOSE BKINDX  DEALLOCATE BKINDX  SELECT @aaFASetupID = ISNULL(aaFASetupID,0) FROM AAG04000 WHERE aaAssetIndex = @aaAssetIndex AND aaBookIndex = 0 END    
GO
GRANT EXECUTE ON  [dbo].[aagInitFAAssetAcct] TO [DYNGRP]
GO
