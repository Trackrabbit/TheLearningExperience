SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
 CREATE PROCEDURE [dbo].[aaMisc_Void]  @Doc_numbr as char(20),  @cmpid as int,  @User as char(10), @Seq_number as int , @Seq_line as int, @Series as int, @Doc_Type as int  AS  DECLARE  @aagGetHdrID as int,  @aaSubLedgerHdrID as int,  @aaSubLedgerDistID as int,  @SEQNUMBR as int,  @MaxaaSubLedgerHdrID as int,  @aaMaxSubLedgerDistID as int,  @aaGLHdrID as int,  @aagNextGLID as int,  @Batch_numbr as nvarchar(20),  @Accindx as int,  @totaadim  as int,  @aaNextSubDistID as int,  @aaGLDistID2 as int,  @nCount as int,  @aaGLDistID3 as int,  @aaGLDistID as int,  @Accindx1 as int,  @DEX_ROW_ID1 as int, @aaNextWorkDistID as int, @aaNextSubDistID1 as int, @Sequence_line as int BEGIN   set @aaNextWorkDistID=0  set @aaNextSubDistID=0   select @MaxaaSubLedgerHdrID = aaSubLedgerHdrID  from AAG20000 where DOCNUMBR = @Doc_numbr   and SERIES = @Series and DOCTYPE = @Doc_Type   EXEC DYNAMICS..aagGetNextID 10000,@cmpid,@aaGLHdrID output,0    select @aagNextGLID = max(JRNENTRY) from GL10000 where DTAControlNum = @Doc_numbr  and  SERIES = @Series   Delete From AAG60000   INSERT INTO AAG10000   ([aaGLWorkHdrID],[JRNENTRY],[RCTRXSEQ],[GLPOSTDT],[aaTRXType],[aaHdrErrors], [Ledger_ID])   VALUES   (@aaGLHdrID,@aagNextGLID,0,'',0,0,1)     Insert into AAG60000 values (@User,'',@aaGLHdrID,@aagNextGLID,1,'')    select @SEQNUMBR=MAX(SEQNUMBR) from AAG20001 where aaSubLedgerHdrID = @MaxaaSubLedgerHdrID   select @aaNextSubDistID = MAX(aaSubLedgerDistID)   from AAG20001 where aaSubLedgerHdrID = @MaxaaSubLedgerHdrID  delete from AAG20002 where not exists (select 1 from AAG20001 where AAG20001.aaSubLedgerDistID = AAG20002.aaSubLedgerDistID and AAG20001.aaSubLedgerHdrID = AAG20002.aaSubLedgerHdrID)  and aaSubLedgerHdrID = @MaxaaSubLedgerHdrID    DECLARE TrxDim_Cursor CURSOR static FOR   select aaSubLedgerHdrID,aaSubLedgerDistID from AAG20001 where aaSubLedgerHdrID = @MaxaaSubLedgerHdrID  order by aaSubLedgerDistID  OPEN TrxDim_Cursor   Fetch next from TrxDim_Cursor INTO @aaSubLedgerHdrID,@aaSubLedgerDistID   WHILE @@fetch_status = 0   BEGIN   set @SEQNUMBR =isnull(@SEQNUMBR,0)+isnull(@Seq_number,0)  set @Sequence_line = isnull(@Sequence_line,0)+isnull(@Seq_line,0)   set @aaNextSubDistID=isnull(@aaNextSubDistID,0)+1  set @aaNextWorkDistID=isnull(@aaNextWorkDistID,0)+1   INSERT INTO AAG20001(aaSubLedgerHdrID,aaSubLedgerDistID   ,INTERID ,CorrespondingUnit,ACTINDX ,DISTTYPE,ACCTTYPE ,aaBrowseType   ,DECPLACS,DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,CURNCYID   ,CURRNIDX,RATETPID,EXGTBLID,XCHGRATE,EXCHDATE,TIME1   ,RTCLCMTD,DENXRATE,MCTRXSTT,SEQNUMBR,GLPOSTDT,aaCustID   ,aaVendID,aaSiteID,aaItemID,aaCopyStatus,aaWinWasOpen,POSTED   ,HISTORY,aaDistErrors,APTVCHNM,APTODCTY,aaFutureDist,aaOffsetAcct   ,ITEMNMBR,TRXLOCTN ,BINNMBR,TRNSTLOC,TRXQTY,aaChangeDate,aaChangeTime)    select aaSubLedgerHdrID,@aaNextSubDistID   ,INTERID ,CorrespondingUnit,ACTINDX ,DISTTYPE,ACCTTYPE ,aaBrowseType   ,DECPLACS,CRDTAMNT,DEBITAMT,ORCRDAMT,ORDBTAMT,CURNCYID   ,CURRNIDX,RATETPID,EXGTBLID,XCHGRATE,EXCHDATE,TIME1   ,RTCLCMTD,DENXRATE,MCTRXSTT,@SEQNUMBR,GLPOSTDT,aaCustID   ,aaVendID,aaSiteID,aaItemID,aaCopyStatus,aaWinWasOpen,POSTED   ,HISTORY,0,'',0,0,0   ,'','' ,'','',0,'',''  from AAG20001 where aaSubLedgerHdrID = @MaxaaSubLedgerHdrID and aaSubLedgerDistID = @aaSubLedgerDistID    INSERT INTO AAG10001   ([aaGLWorkHdrID],[aaGLWorkDistID],[INTERID],[CorrespondingUnit]   ,[ACTINDX],[ACCTTYPE],[aaBrowseType],[DECPLACS],[FXDORVAR]   ,[DEBITAMT],[CRDTAMNT],[ORDBTAMT],[ORCRDAMT],[CURNCYID]   ,[CURRNIDX],[RATETPID],[EXGTBLID],[XCHGRATE],[EXCHDATE]   ,[TIME1],[RTCLCMTD] ,[DENXRATE],[MCTRXSTT],[SQNCLINE]   ,[aaCustID],[aaVendID],[aaSiteID],[aaItemID],[aaCopyStatus]   ,[aaWinWasOpen],[aaOFFSETAcct],[aaDistErrors],[aaChangeDate]   ,[aaChangeTime])  select @aaGLHdrID,@aaNextWorkDistID, INTERID,CorrespondingUnit,ACTINDX,DISTTYPE,ACCTTYPE,  DECPLACS,0,CRDTAMNT,DEBITAMT,ORCRDAMT,ORDBTAMT,CURNCYID,CURRNIDX,   RATETPID,EXGTBLID,XCHGRATE,EXCHDATE,TIME1,RTCLCMTD,DENXRATE,MCTRXSTT,   @Sequence_line,aaCustID ,aaVendID ,aaSiteID,aaItemID,aaCopyStatus,0,0,0,  convert(char(12), getdate(), 102),convert(char(12), getdate(), 108)   from AAG20001 where aaSubLedgerHdrID = @MaxaaSubLedgerHdrID and aaSubLedgerDistID = @aaSubLedgerDistID    INSERT INTO dbo.AAG20002(aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID   ,DEBITAMT,CRDTAMNT,ORCRDAMT,ORDBTAMT  ,aaAssignedPercent,DistRef,NOTEINDX,aaAssignErrors)   select  aaSubLedgerHdrID,@aaNextSubDistID,aaSubLedgerAssignID   ,CRDTAMNT,DEBITAMT,ORDBTAMT,ORCRDAMT   ,aaAssignedPercent,'',0,0  from AAG20002 where aaSubLedgerHdrID=@MaxaaSubLedgerHdrID and aaSubLedgerDistID=@aaSubLedgerDistID   INSERT INTO AAG10002   ([aaGLWorkHdrID],[aaGLWorkDistID],[aaGLWorkAssignID]   ,[DEBITAMT],[CRDTAMNT],[ORDBTAMT],[ORCRDAMT]   ,[aaAssignedPercent],[DistRef],[NOTEINDX],[aaAssignErrors])   select @aaGLHdrID,@aaNextWorkDistID,aaSubLedgerAssignID   ,[CRDTAMNT],[DEBITAMT],[ORCRDAMT],[ORDBTAMT]   ,[aaAssignedPercent],'',0,0  from  AAG20002 where aaSubLedgerHdrID = @MaxaaSubLedgerHdrID and aaSubLedgerDistID = @aaSubLedgerDistID    INSERT INTO dbo.AAG20003(aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID   ,aaTrxDimID,aaTrxCodeID,aaCodeErrors)   select  aaSubLedgerHdrID,@aaNextSubDistID,aaSubLedgerAssignID   ,aaTrxDimID,aaTrxCodeID,aaCodeErrors  from AAG20003 where aaSubLedgerHdrID=@MaxaaSubLedgerHdrID and aaSubLedgerDistID=@aaSubLedgerDistID   INSERT INTO AAG10003   ([aaGLWorkHdrID],[aaGLWorkDistID],[aaGLWorkAssignID]   ,aaTrxDimID,aaTrxCodeID,aaCodeErrors)   select @aaGLHdrID,@aaNextWorkDistID,aaSubLedgerAssignID   ,aaTrxDimID,aaTrxCodeID,aaCodeErrors  from AAG20003 where aaSubLedgerHdrID=@MaxaaSubLedgerHdrID and aaSubLedgerDistID=@aaSubLedgerDistID   Fetch next from TrxDim_Cursor INTO @aaSubLedgerHdrID,@aaSubLedgerDistID   END   CLOSE TrxDim_Cursor   DEALLOCATE TrxDim_Cursor  End     
GO
GRANT EXECUTE ON  [dbo].[aaMisc_Void] TO [DYNGRP]
GO
