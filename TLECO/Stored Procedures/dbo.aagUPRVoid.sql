SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROC [dbo].[aagUPRVoid]   @iOldAuditCtrlCode VARCHAR(15),   @iNewAuditCtrlCode VARCHAR(15),   @iUserID VARCHAR(15),  @iEmployID VARCHAR(15) AS BEGIN  DECLARE @OriSubLedgerHdrID INT,   @VoidSubLedgerHdrID INT,   @Status SMALLINT,   @Series SMALLINT,   @DocType SMALLINT,   @PayRunType SMALLINT,  @POSTEDDT DATETIME,  @iCompanyID SMALLINT   DECLARE @l_cINTERID char(5)  DECLARE @l_nStatus int  DECLARE @l_nError int  DECLARE @l_nSQL_Error_State int  DECLARE @l_cComputerCheckPrefix varchar(255)  DECLARE @l_cManualCheckPrefix varchar(255)  SELECT @OriSubLedgerHdrID = 0, @POSTEDDT = ''  SELECT @POSTEDDT = POSTEDDT FROM UPR30401   WHERE LTRIM(RTRIM(AUCTRLCD)) = LTRIM(RTRIM(@iNewAuditCtrlCode))  GROUP BY AUCTRLCD, EMPLOYID, POSTEDDT   SELECT @l_cINTERID = db_name()  select  @iCompanyID = CMPANYID from DYNAMICS.dbo.SY01500 where INTERID = @l_cINTERID  exec    @l_nStatus = DYNAMICS.dbo.smGetMsgString 275, @l_cINTERID, @l_cComputerCheckPrefix output, @l_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@l_nSQL_Error_State <> 0) )  return (@l_nStatus)  select @l_cComputerCheckPrefix = ltrim(rtrim(@l_cComputerCheckPrefix))   exec    @l_nStatus = DYNAMICS.dbo.smGetMsgString 276, @l_cINTERID, @l_cManualCheckPrefix output, @l_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@l_nSQL_Error_State <> 0) )  return (@l_nStatus)  select @l_cManualCheckPrefix = ltrim(rtrim(@l_cManualCheckPrefix))   if substring(ltrim(rtrim(@iOldAuditCtrlCode)), 1, len(ltrim(rtrim(@l_cComputerCheckPrefix)))) = ltrim(rtrim(@l_cComputerCheckPrefix))   BEGIN  select @OriSubLedgerHdrID = isnull(aaSubLedgerHdrID,0) from AAG20000   where ltrim(rtrim(DOCNUMBR)) = ltrim(rtrim(@iOldAuditCtrlCode)) and   ltrim(rtrim(Master_ID)) = ltrim(rtrim(@iEmployID)) and   SERIES = 6 and   DOCTYPE = 3  END   ELSE  BEGIN  select @OriSubLedgerHdrID = isnull(aaSubLedgerHdrID,0) from AAG20000   where ltrim(rtrim(DOCNUMBR)) = ltrim(rtrim(@iOldAuditCtrlCode)) and   ltrim(rtrim(Master_ID)) = ltrim(rtrim(@iEmployID)) and   SERIES = 6 and   DOCTYPE = 5  END   if @OriSubLedgerHdrID > 0   BEGIN  EXEC DYNAMICS..aagGetNextID 20000, @iCompanyID, @VoidSubLedgerHdrID OUT, @Status OUT  INSERT INTO AAG20000(aaSubLedgerHdrID, SERIES, DOCTYPE, DOCNUMBR, Master_ID, PYRNTYPE)  select @VoidSubLedgerHdrID, SERIES, 6, LTRIM(RTRIM(@iNewAuditCtrlCode)), LTRIM(RTRIM(@iEmployID)), PYRNTYPE  from AAG20000 where aaSubLedgerHdrID = @OriSubLedgerHdrID    insert into AAG20001 ([aaSubLedgerHdrID], [aaSubLedgerDistID], [INTERID], [CorrespondingUnit], [ACTINDX], [DISTTYPE], [ACCTTYPE], [aaBrowseType],   [DECPLACS], [DEBITAMT], [CRDTAMNT], [ORDBTAMT], [ORCRDAMT], [CURNCYID], [CURRNIDX], [RATETPID], [EXGTBLID], [XCHGRATE], [EXCHDATE], [TIME1],   [RTCLCMTD], [DENXRATE], [MCTRXSTT], [SEQNUMBR], [GLPOSTDT], [aaCustID], [aaVendID], [aaSiteID], [aaItemID],  [EMPLOYID], [aaCopyStatus], [aaWinWasOpen],   [POSTED], [HISTORY], [aaDistErrors], [APTVCHNM], [APTODCTY], [aaFutureDist], [aaOffsetAcct], [ITEMNMBR], [TRXLOCTN], [TRNSTLOC], [BINNMBR], [TRXQTY],  [aaChangeDate],[aaChangeTime], PYRLRTYP, TRXNUMBER)  select @VoidSubLedgerHdrID, [aaSubLedgerDistID], [INTERID], [CorrespondingUnit], [ACTINDX], [DISTTYPE], [ACCTTYPE], [aaBrowseType], [DECPLACS],   [CRDTAMNT], [DEBITAMT], [ORCRDAMT], [ORDBTAMT], [CURNCYID], [CURRNIDX], [RATETPID], [EXGTBLID], [XCHGRATE], [EXCHDATE], [TIME1], [RTCLCMTD], [DENXRATE],   [MCTRXSTT], [SEQNUMBR], @POSTEDDT, [aaCustID], [aaVendID], [aaSiteID], [aaItemID], @iEmployID, [aaCopyStatus], [aaWinWasOpen], [POSTED], [HISTORY],   [aaDistErrors], [APTVCHNM], [APTODCTY], [aaFutureDist], [aaOffsetAcct], [ITEMNMBR], [TRXLOCTN], [TRNSTLOC], [BINNMBR], [TRXQTY],convert(char(12), getdate(), 102),  convert(char(12), getdate(), 108), PYRLRTYP, TRXNUMBER  from AAG20001  where aaSubLedgerHdrID = @OriSubLedgerHdrID   insert into AAG20002 ([aaSubLedgerHdrID], [aaSubLedgerDistID], [aaSubLedgerAssignID], [DEBITAMT], [CRDTAMNT], [ORDBTAMT], [ORCRDAMT], [aaAssignedPercent], [DistRef], [aaAssignErrors], [aaAliasID])  select @VoidSubLedgerHdrID, [aaSubLedgerDistID], [aaSubLedgerAssignID], [CRDTAMNT], [DEBITAMT], [ORCRDAMT], [ORDBTAMT], [aaAssignedPercent], [DistRef], [aaAssignErrors], [aaAliasID]  from AAG20002  where aaSubLedgerHdrID = @OriSubLedgerHdrID   insert into AAG20003 ([aaSubLedgerHdrID], [aaSubLedgerDistID], [aaSubLedgerAssignID], [aaTrxDimID], [aaTrxCodeID], [aaCodeErrors])  select @VoidSubLedgerHdrID, [aaSubLedgerDistID], [aaSubLedgerAssignID], [aaTrxDimID], [aaTrxCodeID], [aaCodeErrors]  from AAG20003  where aaSubLedgerHdrID = @OriSubLedgerHdrID   END END     
GO
GRANT EXECUTE ON  [dbo].[aagUPRVoid] TO [DYNGRP]
GO
