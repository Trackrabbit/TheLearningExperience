SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[pmCLTaxWORK]  @I_cUserID char(15) = NULL,  @I_cFileName1 varchar(40) = NULL,  @I_cSearchString1 char(2)  = NULL,  @O_iErrorState int  = NULL output as  declare  @iError int,    @iStatus int,    @tLoop tinyint  select  @O_iErrorState = 0,  @iStatus  = 0  while (@tLoop is NULL) begin  select @tLoop = 1   if @I_cUserID is NULL   or @I_cFileName1 is NULL  or @I_cSearchString1 is NULL  begin  select @O_iErrorState = 20845  break  end   update  PM10500  set  POSTED = 1  where  EXISTS  (select  1  from  PM20000  where  PM10500.VCHRNMBR = PM20000.VCHRNMBR  and PM10500.DOCTYPE = PM20000.DOCTYPE )  and  POSTED = 0   update  PM10500  set  PM10500.POSTED = 0  where  EXISTS  (select  1  from  PM10000  where  PM10500.VCHRNMBR = PM10000.VCHNUMWK  and PM10500.DOCTYPE = PM10000.DOCTYPE )  and  PM10500.POSTED = 1   insert into  #CNTRLNUMTEMP(  CNTRLNUM,  DOCTYPE,  VENDORID )  select distinct  VCHRNMBR,  0,  VENDORID  from  PM10500  where  POSTED = 0  and  NOT EXISTS(  select  1  from  PM10000  where  PM10500.VCHRNMBR = PM10000.VCHNUMWK)   if @@rowcount <> 0  begin  delete  PM10500  where  POSTED = 0  and  NOT EXISTS(  select  1  from  PM10000  where  PM10500.VCHRNMBR = PM10000.VCHNUMWK)   exec @iStatus = smCreateErrorLogRecord  @I_cUserID,  @I_cFileName1,  @I_cSearchString1,  10351,  @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break   end    insert into  #CNTRLNUMTEMP(  CNTRLNUM,  DOCTYPE,  VENDORID )  select distinct  VCHRNMBR,  0,  VENDORID  from  PM10500  where  POSTED = 1  and  NOT EXISTS  (select   1  from   PM20000  where  PM10500.VCHRNMBR = PM20000.VCHRNMBR  and PM10500.DOCTYPE = PM20000.DOCTYPE )   if @@rowcount <> 0  begin  delete  PM10500  where  POSTED = 1  and  NOT EXISTS  (select   1   from   PM20000  where  PM10500.VCHRNMBR = PM20000.VCHRNMBR  and PM10500.DOCTYPE = PM20000.DOCTYPE )   exec @iStatus = smCreateErrorLogRecord  @I_cUserID,  @I_cFileName1,  @I_cSearchString1,  10351,  @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break   end   end   return(@iStatus)   
GO
GRANT EXECUTE ON  [dbo].[pmCLTaxWORK] TO [DYNGRP]
GO
