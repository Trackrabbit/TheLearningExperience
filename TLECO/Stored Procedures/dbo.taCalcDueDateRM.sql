SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[taCalcDueDateRM]  @I_vCUSTNMBR char(15),   @I_vPYMTRMID char(20),   @I_vDOCDATE datetime,   @O_dDISCDATE datetime output,  @O_dDUEDATE datetime output,  @O_iErrorState int output,   @oErrString varchar(255) output   with encryption as  set transaction isolation level read uncommitted set nocount on  declare @iStatement int,    @iStatus int,    @iAddCodeErrState int,    @sBALNCTYP smallint,   @sDISCTYPE smallint,   @sDISCDTDS smallint,   @sDUETYPE smallint,   @sDUEDTDS smallint,   @dDocDateEOM datetime,   @dDiscDateEOM datetime,   @dDocDatePlus1MonthEOM datetime,   @dDiscDatePlus1MonthEOM datetime,   @dDocDatePlus1MonthFOM datetime,   @dDiscDatePlus1MonthFOM datetime,   @sDUEGRPER   smallint,   @sDISGRPER smallint,   @tUSEGRPER tinyint    select  @O_dDISCDATE = '',  @O_dDUEDATE = '',  @iStatement = 0,            @O_iErrorState = 0,            @oErrString = isnull(@oErrString,'')  while (@iStatement = 0) begin  if (  @I_vCUSTNMBR is NULL or  @I_vPYMTRMID is NULL or  @I_vDOCDATE  is NULL  )  begin  select @O_iErrorState = 222     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   select @I_vCUSTNMBR = UPPER(@I_vCUSTNMBR)   if (@I_vCUSTNMBR = '')  begin  select @O_iErrorState = 219     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if (not exists (select 1 from RM00101 (nolock) where CUSTNMBR = @I_vCUSTNMBR))  begin  select @O_iErrorState = 221     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if ((@I_vPYMTRMID <> '') and (not exists (select 1 from SY03300 (nolock) where PYMTRMID = @I_vPYMTRMID)))  begin  select @O_iErrorState = 223     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  end   if (@O_iErrorState <> 0)  begin  break  end   select @sBALNCTYP  = BALNCTYP,  @sDUEGRPER = DUEGRPER,  @sDISGRPER = DISGRPER  from RM00101 (nolock)  where CUSTNMBR = @I_vCUSTNMBR   if (@I_vPYMTRMID = '')  begin  select @O_dDISCDATE = ''  select @O_dDUEDATE  = ''   return (@O_iErrorState)  end   if (@sBALNCTYP = 0)  begin  select  @sDISCTYPE = DISCTYPE,  @sDISCDTDS = DISCDTDS,  @sDUETYPE  = DUETYPE,  @sDUEDTDS  = DUEDTDS,  @tUSEGRPER = USEGRPER  from SY03300 (nolock) where PYMTRMID = @I_vPYMTRMID   if (@tUSEGRPER = 0)  begin  select @sDUEGRPER = 0,  @sDISGRPER = 0  end   if (@I_vDOCDATE = '')  begin  select @O_dDISCDATE = ''  end  else  begin   select @dDocDateEOM = (dateadd(month,1,@I_vDOCDATE)) - datepart(day,(dateadd(month,1,@I_vDOCDATE)))   select @dDocDatePlus1MonthFOM = dateadd(day,1,@dDocDateEOM)   select @dDocDatePlus1MonthEOM = (dateadd(month,1,@dDocDatePlus1MonthFOM)) - datepart(day,(dateadd(month,1,@dDocDatePlus1MonthFOM)))   select @O_dDISCDATE =   case   when @sDISCTYPE = 1 and @sDISCDTDS > 0   then dateadd(day, @sDISCDTDS, @I_vDOCDATE)  when @sDISCTYPE = 1 and @sDISCDTDS = 0   then @I_vDOCDATE     when @sDISCTYPE = 2   then  case  when (@dDocDateEOM - datepart(day,@dDocDateEOM) + @sDISCDTDS > @dDocDateEOM)  then @dDocDateEOM  else @dDocDateEOM - datepart(day,@dDocDateEOM) + @sDISCDTDS  end  when @sDISCTYPE = 3   then @dDocDateEOM  when @sDISCTYPE = 4   then @I_vDOCDATE   else @I_vDOCDATE  end   if (@sDISCTYPE = 2)    begin  while (dateadd(day, @sDISGRPER, @I_vDOCDATE) >= @O_dDISCDATE)  begin  select @O_dDISCDATE = dateadd(month, 1, @O_dDISCDATE)  end  end   if (@sDISCTYPE = 3)    begin  while (dateadd(day, @sDISGRPER, @I_vDOCDATE) >= @O_dDISCDATE)  begin  select @O_dDISCDATE = dateadd(month, 1, @O_dDISCDATE)  select @O_dDISCDATE = (dateadd(month,1,@O_dDISCDATE)) - datepart(day,(dateadd(month,1,@O_dDISCDATE)))  end  end  end   if (@I_vDOCDATE = '')  begin  select @O_dDUEDATE = ''  end  else  begin   select @dDiscDateEOM = (dateadd(month,1,@O_dDISCDATE)) - datepart(day,(dateadd(month,1,@O_dDISCDATE)))   if (@sDUETYPE = 5 and @sDUEDTDS = 0)  begin  select @sDUEDTDS = datepart(day,(dateadd(month,1,@I_vDOCDATE)))  end   select @O_dDUEDATE =   case @sDUETYPE   when 1 then  case  when (@sDISCTYPE = 1) then  dateadd(day, @sDUEDTDS, @I_vDOCDATE)  else  dateadd(day, @sDUEDTDS, @O_dDISCDATE)  end  when 2 then  case  when (@dDiscDateEOM - datepart(day,@dDiscDateEOM) + @sDUEDTDS > @dDiscDateEOM) then  @dDiscDateEOM  else  @dDiscDateEOM - datepart(day,@dDiscDateEOM) + @sDUEDTDS  end  when 3 then  @dDiscDateEOM  when 4 then  @I_vDOCDATE  when 5 then  case  when (@dDocDatePlus1MonthEOM - datepart(day,@dDocDatePlus1MonthEOM) + @sDUEDTDS > @dDocDatePlus1MonthEOM) then  @dDocDatePlus1MonthEOM  else  @dDocDatePlus1MonthEOM - datepart(day,@dDocDatePlus1MonthEOM) + @sDUEDTDS  end  else  @I_vDOCDATE  end   if (@sDUETYPE = 2)    begin  while (dateadd(day, @sDUEGRPER, @O_dDISCDATE) >= @O_dDUEDATE)  begin  select @O_dDUEDATE = dateadd(month, 1, @O_dDUEDATE)  end  end   if (@sDUETYPE = 3)    begin  while (dateadd(day, @sDUEGRPER, @O_dDISCDATE) >= @O_dDUEDATE)  begin  select @O_dDUEDATE = dateadd(month, 1, @O_dDUEDATE)  select @O_dDUEDATE = (dateadd(month,1,@O_dDUEDATE)) - datepart(day,(dateadd(month,1,@O_dDUEDATE)))  end  end   if (@sDUETYPE = 5)    begin  if (@O_dDUEDATE <= @O_dDISCDATE)  begin  select @O_dDUEDATE = dateadd(month, 1, @O_dDUEDATE)  end  end  end  end  else  begin  select @O_dDISCDATE = ''    select @O_dDUEDATE  = @I_vDOCDATE  end   break  end   return (@O_iErrorState)   
GO
GRANT EXECUTE ON  [dbo].[taCalcDueDateRM] TO [DYNGRP]
GO
