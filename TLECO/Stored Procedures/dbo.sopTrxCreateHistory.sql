SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create proc [dbo].[sopTrxCreateHistory] (@SopType smallint=NULL, @SopNumber char(21)=NULL,@TrxSource char(13)=NULL,   @KeepHistory smallint=NULL, @KeepDistributionHistory smallint=NULL, @iErrorState int=NULL output)  AS  declare @tTransaction tinyint,@WorkingSopType smallint,@WorkingSopStatus smallint BEGIN  SET nocount on  SELECT @iErrorState = 0 IF @SopType=NULL or @SopNumber=NULL or @TrxSource=NULL BEGIN  SELECT @iErrorState = 21036  RETURN END  IF @SopType = 6 BEGIN  SELECT @WorkingSopType=3  END ELSE BEGIN  SELECT @WorkingSopType = @SopType END  IF @SopType = 2 BEGIN  SELECT @WorkingSopStatus=9   END ELSE BEGIN  SELECT @WorkingSopStatus=0  END  IF @@trancount = 0 BEGIN  select @tTransaction = 1   begin transaction  END  if @KeepHistory > 0 or @KeepDistributionHistory > 0 begin  INSERT INTO SOP30200  (SOPTYPE, SOPNUMBE, ORIGTYPE, ORIGNUMB, DOCID, DOCDATE, GLPOSTDT, QUOTEDAT, QUOEXPDA, ORDRDATE,   INVODATE, BACKDATE, RETUDATE, ReqShipDate, FUFILDAT, ACTLSHIP, DISCDATE, DUEDATE, REPTING, TRXFREQU,   TIMEREPD, TIMETREP, DYSTINCR, DTLSTREP, DSTBTCH1, DSTBTCH2, USDOCID1, USDOCID2, DISCFRGT, ORDAVFRT,   DISCMISC, ORDAVMSC, DISAVAMT, ORDAVAMT, DISCRTND, ORDISRTD, DISTKNAM, ORDISTKN, DSCPCTAM, DSCDLRAM,   ORDDLRAT, DISAVTKN, ORDATKN, PYMTRMID, PRCLEVEL, LOCNCODE, BCHSOURC, BACHNUMB, CUSTNMBR,   CUSTNAME, CSTPONBR, PROSPECT, MSTRNUMB, PCKSLPNO, PICTICNU, MRKDNAMT, ORMRKDAM, PRBTADCD,   PRSTADCD, CNTCPRSN, ShipToName, ADDRESS1, ADDRESS2, ADDRESS3, CITY, STATE, ZIPCODE, CCode, COUNTRY,   PHNUMBR1, PHNUMBR2, PHONE3, FAXNUMBR, COMAPPTO, COMMAMNT, OCOMMAMT, CMMSLAMT, ORCOSAMT,   NCOMAMNT, ORNCMAMT, SHIPMTHD, TRDISAMT, ORTDISAM, TRDISPCT, SUBTOTAL, ORSUBTOT, REMSUBTO, OREMSUBT,   EXTDCOST, OREXTCST, MISCAMNT, FRTAMNT, ORFRTAMT, ORMISCAMT, TXENGCLD, TAXEXMT2, TAXEXMT1,   TXRGNNUM, TAXSCHID, TXSCHSRC, BSIVCTTL, FRTSCHID, FRTTXAMT, ORFRTTAX, FRGTTXBL, MSCSCHID, MSCTXAMT,   ORMSCTAX, MISCTXBL, BKTFRTAM, ORBKTFRT, BKTMSCAM, ORBKTMSC, BCKTXAMT, OBTAXAMT, TXBTXAMT, OTAXTAMT,   TAXAMNT, ORTAXAMT, ECTRX, DOCAMNT, ORDOCAMT, PYMTRCVD, ORPMTRVD, DEPRECVD, ORDEPRVD, CODAMNT,   ORCODAMT, ACCTAMNT, ORACTAMT, SALSTERR, SLPRSNID, UPSZONE, TIMESPRT, PSTGSTUS, VOIDSTTS, ALLOCABY,   NOTEINDX, CURNCYID, CURRNIDX, RATETPID, EXGTBLID, XCHGRATE, DENXRATE, EXCHDATE, TIME1, RTCLCMTD,   MCTRXSTT, TRXSORCE, SOPHDRE1, SOPHDRE2, SOPLNERR, SOPHDRFL, COMMNTID, REFRENCE, POSTEDDT, PTDUSRID,   USER2ENT, CREATDDT, MODIFDT, Tax_Date, APLYWITH, WITHHAMT, SHPPGDOC, CORRCTN, SIMPLIFD,  DOCNCORR, SEQNCORR, SALEDATE, Flags, SOPSTATUS, SHIPCOMPLETE, WorkflowApprStatCreditLm, WorkflowPriorityCreditLm,  WorkflowApprStatusQuote, WorkflowPriorityQuote, ContractExchangeRateStat,Print_Phone_NumberGB)  SELECT   @WorkingSopType, SOPNUMBE, ORIGTYPE, ORIGNUMB, DOCID, DOCDATE, GLPOSTDT, QUOTEDAT, QUOEXPDA, ORDRDATE,   INVODATE, BACKDATE, RETUDATE, ReqShipDate, FUFILDAT, ACTLSHIP, DISCDATE, DUEDATE, REPTING, TRXFREQU,   TIMEREPD, TIMETREP, DYSTINCR, DTLSTREP, DSTBTCH1, DSTBTCH2, USDOCID1, USDOCID2, DISCFRGT, ORDAVFRT,   DISCMISC, ORDAVMSC, DISAVAMT, ORDAVAMT, DISCRTND, ORDISRTD, DISTKNAM, ORDISTKN, DSCPCTAM, DSCDLRAM,   ORDDLRAT, DISAVTKN, ORDATKN, PYMTRMID, PRCLEVEL, LOCNCODE, BCHSOURC, BACHNUMB, CUSTNMBR,   CUSTNAME, CSTPONBR, PROSPECT, MSTRNUMB, PCKSLPNO, PICTICNU, MRKDNAMT, ORMRKDAM, PRBTADCD,   PRSTADCD, CNTCPRSN, ShipToName, ADDRESS1, ADDRESS2, ADDRESS3, CITY, STATE, ZIPCODE, CCode, COUNTRY,   PHNUMBR1, PHNUMBR2, PHONE3, FAXNUMBR, COMAPPTO, COMMAMNT, OCOMMAMT, CMMSLAMT, ORCOSAMT,   NCOMAMNT, ORNCMAMT, SHIPMTHD, TRDISAMT, ORTDISAM, TRDISPCT, SUBTOTAL, ORSUBTOT, REMSUBTO, OREMSUBT,   EXTDCOST, OREXTCST, MISCAMNT, FRTAMNT, ORFRTAMT, ORMISCAMT, TXENGCLD, TAXEXMT2, TAXEXMT1,   TXRGNNUM, TAXSCHID, TXSCHSRC, BSIVCTTL, FRTSCHID, FRTTXAMT, ORFRTTAX, FRGTTXBL, MSCSCHID, MSCTXAMT,   ORMSCTAX, MISCTXBL, BKTFRTAM, ORBKTFRT, BKTMSCAM, ORBKTMSC, BCKTXAMT, OBTAXAMT, TXBTXAMT, OTAXTAMT,   TAXAMNT, ORTAXAMT, ECTRX, DOCAMNT, ORDOCAMT, PYMTRCVD, ORPMTRVD, DEPRECVD, ORDEPRVD, CODAMNT,   ORCODAMT, ACCTAMNT, ORACTAMT, SALSTERR, SLPRSNID, UPSZONE, TIMESPRT, PSTGSTUS, VOIDSTTS, ALLOCABY,   NOTEINDX, CURNCYID, CURRNIDX, RATETPID, EXGTBLID, XCHGRATE, DENXRATE, EXCHDATE, TIME1, RTCLCMTD,   MCTRXSTT, TRXSORCE=@TrxSource, SOPHDRE1, SOPHDRE2, SOPLNERR, SOPHDRFL, COMMNTID, REFRENCE, POSTEDDT, PTDUSRID,   USER2ENT, CREATDDT, MODIFDT, Tax_Date, APLYWITH, WITHHAMT, SHPPGDOC, CORRCTN, SIMPLIFD,  DOCNCORR, SEQNCORR, SALEDATE, Flags, SOPSTATUS, SHIPCOMPLETE, WorkflowApprStatCreditLm, WorkflowPriorityCreditLm,  WorkflowApprStatusQuote, WorkflowPriorityQuote, ContractExchangeRateStat,Print_Phone_NumberGB  FROM SOP10100   WHERE SOP10100.SOPTYPE = @SopType AND SOP10100.SOPNUMBE = @SopNumber   if @SopType = 2 or @SopType = 5   UPDATE  SOP30200  SET  ACCTAMNT = DOCAMNT, ORACTAMT = ORDOCAMT  WHERE  SOPTYPE = @SopType and SOPNUMBE = @SopNumber   if @SopType = 2   UPDATE  SOP30200  SET  SOPSTATUS = @WorkingSopStatus  WHERE  SOPTYPE = @SopType and SOPNUMBE = @SopNumber end  if @KeepDistributionHistory > 0  UPDATE  SOP10102   SET  TRXSORCE = @TrxSource, POSTED = 1,  SOPTYPE = @WorkingSopType  WHERE  SOP10102.SOPTYPE = @SopType AND SOP10102.SOPNUMBE = @SopNumber else  DELETE  SOP10102  WHERE  SOP10102.SOPTYPE = @SopType AND SOP10102.SOPNUMBE = @SopNumber  if @KeepHistory > 0 begin   UPDATE SOP10101 SET TRXSORCE = @TrxSource,SOPTYPE = @WorkingSopType  WHERE SOP10101.SOPTYPE = @SopType AND SOP10101.SOPNUMBE = @SopNumber   DELETE FROM SOP10103   WHERE SOP10103.SOPTYPE != 3 AND SOP10103.SOPTYPE != 4 AND SOP10103.SOPTYPE != 6 AND SOP10103.PYMTTYPE = 6 AND SOP10103.SOPTYPE = @SopType AND SOP10103.SOPNUMBE = @SopNumber And SOP10103.AMNTREMA = SOP10103.AMNTPAID  UPDATE SOP10103 SET TRXSORCE = @TrxSource, DEPSTATS = 2,SOPTYPE = @WorkingSopType , AMNTREMA = 0, OAMNTREM = 0   WHERE SOP10103.SOPTYPE = @SopType AND SOP10103.SOPNUMBE = @SopNumber   UPDATE SOP10104 SET TRXSORCE = @TrxSource,SOPTYPE = @WorkingSopType  WHERE SOP10104.SOPTYPE = @SopType AND SOP10104.SOPNUMBE = @SopNumber   UPDATE SOP10105 SET TRXSORCE = @TrxSource,SOPTYPE = @WorkingSopType  WHERE SOP10105.SOPTYPE = @SopType AND SOP10105.SOPNUMBE = @SopNumber   UPDATE SOP10106 SET SOPTYPE = @WorkingSopType  WHERE SOP10106.SOPTYPE = @SopType AND SOP10106.SOPNUMBE = @SopNumber  INSERT INTO SOP30300 (SOPTYPE, SOPNUMBE, LNITMSEQ, CMPNTSEQ,ITEMNMBR, ITEMDESC, NONINVEN, UNITPRCE, ORUNTCST,   UNITCOST, LOCNCODE, UOFM, DROPSHIP, ORUNTPRC, XTNDPRCE, OXTNDPRC, REMPRICE, OREPRICE, EXTDCOST,   OREXTCST, MRKDNAMT, ORMRKDAM, MRKDNPCT, MRKDNTYP, INVINDX, CSLSINDX, SLSINDX, MKDNINDX,   RTNSINDX, INUSINDX, INSRINDX, DMGDINDX, ITMTSHID, IVITMTXB, BKTSLSAM, ORBKTSLS, ORTAXAMT, TAXAMNT,   TXBTXAMT, OTAXTAMT, BSIVCTTL, TRDISAMT, ORTDISAM, DISCSALE, ORDAVSLS, QUANTITY, ATYALLOC, QTYINSVC,   QTYINUSE, QTYDMGED, QTYRTRND, QTYONHND, QTYCANCE, QTYCANOT, QTYORDER, QTYPRBAC, QTYPRBOO,   QTYPRINV, QTYPRORD, QTYREMAI, QTYREMBO, QTYTBAOR, QTYTOINV, QTYTORDR, QTYFULFI, QTYSLCTD, QTYBSUOM,   EXTQTYAL, EXTQTYSEL, ReqShipDate, FUFILDAT, ACTLSHIP, SHIPMTHD, SALSTERR, SLPRSNID, PRCLEVEL, COMMNTID,   BRKFLD1, BRKFLD2, BRKFLD3, CURRNIDX, TRXSORCE, SOPLNERR, PURCHSTAT, QTYRECVD, QTYPRVRECVD,  ORGSEQNM, ITEMCODE, DECPLQTY, DECPLCUR, ODECPLCU, EXCEPTIONALDEMAND, TAXSCHID, TXSCHSRC, PRSTADCD, ShipToName, CNTCPRSN  , ADDRESS1, ADDRESS2, ADDRESS3, CITY, STATE, ZIPCODE, CCode, COUNTRY, PHONE1, PHONE2, PHONE3, FAXNUMBR, Flags,ISLINEINTRA,  CONTNBR,CONTLNSEQNBR,CONTSTARTDTE,CONTENDDTE,CONTITEMNBR,CONTSERIALNBR,Print_Phone_NumberGB)  SELECT @WorkingSopType, SOPNUMBE, LNITMSEQ, CMPNTSEQ,ITEMNMBR, ITEMDESC, NONINVEN, UNITPRCE, ORUNTCST,   UNITCOST, LOCNCODE, UOFM, DROPSHIP, ORUNTPRC, XTNDPRCE, OXTNDPRC, REMPRICE, OREPRICE, EXTDCOST,   OREXTCST, MRKDNAMT, ORMRKDAM, MRKDNPCT, MRKDNTYP, INVINDX, CSLSINDX, SLSINDX, MKDNINDX,   RTNSINDX, INUSINDX, INSRINDX, DMGDINDX, ITMTSHID, IVITMTXB, BKTSLSAM, ORBKTSLS, ORTAXAMT, TAXAMNT,   TXBTXAMT, OTAXTAMT, BSIVCTTL, TRDISAMT, ORTDISAM, DISCSALE, ORDAVSLS, QUANTITY, ATYALLOC, QTYINSVC,   QTYINUSE, QTYDMGED, QTYRTRND, QTYONHND, QTYCANCE, QTYCANOT, QTYORDER, QTYPRBAC, QTYPRBOO,   QTYPRINV, QTYPRORD, QTYREMAI, QTYREMBO, QTYTBAOR, QTYTOINV, QTYTORDR, QTYFULFI, QTYSLCTD, QTYBSUOM,   EXTQTYAL, EXTQTYSEL, ReqShipDate, FUFILDAT, ACTLSHIP, SHIPMTHD, SALSTERR, SLPRSNID, PRCLEVEL, COMMNTID,   BRKFLD1, BRKFLD2, BRKFLD3, CURRNIDX, TRXSORCE=@TrxSource, SOPLNERR, PURCHSTAT, QTYRECVD, QTYPRVRECVD,  ORGSEQNM, ITEMCODE, DECPLQTY, DECPLCUR, ODECPLCU, EXCEPTIONALDEMAND, TAXSCHID, TXSCHSRC, PRSTADCD, ShipToName, CNTCPRSN,   ADDRESS1, ADDRESS2, ADDRESS3, CITY, STATE, ZIPCODE, CCode, COUNTRY, PHONE1, PHONE2, PHONE3, FAXNUMBR, Flags, ISLINEINTRA,  CONTNBR,CONTLNSEQNBR,CONTSTARTDTE,CONTENDDTE,CONTITEMNBR,CONTSERIALNBR,Print_Phone_NumberGB  FROM SOP10200  WHERE SOP10200.SOPTYPE = @SopType AND SOP10200.SOPNUMBE = @SopNumber   UPDATE SOP10201 SET TRXSORCE = @TrxSource, POSTED = 1,SOPTYPE = @WorkingSopType  WHERE SOP10201.SOPTYPE = @SopType AND SOP10201.SOPNUMBE = @SopNumber   UPDATE SOP10202 SET TRXSORCE = @TrxSource,SOPTYPE = @WorkingSopType  WHERE SOP10202.SOPTYPE = @SopType AND SOP10202.SOPNUMBE = @SopNumber  if @WorkingSopType <> @SopType  begin  UPDATE SOP10107 SET SOPTYPE = @WorkingSopType  WHERE SOP10107.SOPTYPE = @SopType AND SOP10107.SOPNUMBE = @SopNumber   UPDATE SOP10112 SET SOPTYPE = @WorkingSopType  WHERE SOP10112.SOPTYPE = @SopType AND SOP10112.SOPNUMBE = @SopNumber   end end  IF @tTransaction = 1  BEGIN  commit transaction  END  end   
GO
GRANT EXECUTE ON  [dbo].[sopTrxCreateHistory] TO [DYNGRP]
GO
