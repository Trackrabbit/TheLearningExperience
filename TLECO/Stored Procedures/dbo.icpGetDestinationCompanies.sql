SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[icpGetDestinationCompanies]  @I_cOrigIntercompanyID char(5)  = NULL,  @I_cOpenAuditTrailCode char(13) = NULL,  @I_cHistoryAuditTrailCode char(13) = NULL,  @I_sWindowType smallint = NULL,  @I_cUserID char(15) = NULL,  @O_iErrorState           int             = NULL  output as  declare  @cBatchNumber char(15),  @cIntercompanyID char(5),  @cCompanyName char(64),  @cProcName char(40),  @iStatus int,  @iCursorError int,  @iError int,  @tTransaction tinyint,  @tLoop tinyint,  @cDatabaseName char(10)   select   @O_iErrorState  = 0,  @iStatus = 0  if @@trancount = 0 begin  select @tTransaction = 1  begin transaction end   while (@tLoop is NULL) begin  select @tLoop = 1   if  @I_cOrigIntercompanyID is NULL or  @I_cOpenAuditTrailCode is NULL or  @I_cHistoryAuditTrailCode is NULL or  @I_sWindowType is NULL or  @I_cUserID is NULL  begin  select @O_iErrorState = 20875  break  end    declare  CompanyCursor INSENSITIVE  cursor for select  IntercompanyID,  CompanyName,  DatabaseName  from  #Company  where  IntercompanyID <> @I_cOrigIntercompanyID   open CompanyCursor   select @iCursorError = @@cursor_rows   if (@iCursorError = 0) or (@iCursorError = -1)  begin  deallocate CompanyCursor  break  end   fetch next from  CompanyCursor  into  @cIntercompanyID,  @cCompanyName,  @cDatabaseName    while (@@fetch_status <> -1)  begin  if (@@fetch_status = -2)  begin  select @O_iErrorState = 20925  break  end   select @cProcName = rtrim(@cDatabaseName) + '..icpGetBatch'  exec @iStatus = @cProcName  @I_cOrigIntercompanyID,  @I_cOpenAuditTrailCode,  @I_cHistoryAuditTrailCode,  @I_sWindowType,  @I_cUserID,  @cCompanyName,  @cBatchNumber output,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  begin  select @iStatus = @iError  break  end   if @iStatus <> 0 or @O_iErrorState <> 0  break    if @cBatchNumber <> ''  begin  update  #Company  set  BatchNumber = @cBatchNumber  where  IntercompanyID = @cIntercompanyID   if @@rowcount <> 1  begin  select @O_iErrorState = 20876  break  end   end    fetch next from  CompanyCursor  into  @cIntercompanyID,  @cCompanyName,  @cDatabaseName    end    deallocate CompanyCursor  end   if @O_iErrorState <> 0 or @iStatus <> 0 begin  if @tTransaction = 1  rollback transaction end else if @tTransaction = 1  commit transaction   return(@iStatus)    
GO
GRANT EXECUTE ON  [dbo].[icpGetDestinationCompanies] TO [DYNGRP]
GO
