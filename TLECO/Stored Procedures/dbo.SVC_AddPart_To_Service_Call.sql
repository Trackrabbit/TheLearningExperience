SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 Create Procedure [dbo].[SVC_AddPart_To_Service_Call]  (@SRVRECTYPE smallint,  @CALLNBR char(11),  @TECHID char(11),  @LINITMTYP char(3),  @ITEMNMBR char(31),  @QTY numeric(19,5) = 0,  @QTYSOLD numeric(19,5) = 0,  @STARTDATE datetime = '01/01/1900 00:00:00',  @STARTTIME datetime = '01/01/1900 00:00:00',  @ENDDATE datetime = '01/01/1900 00:00:00',  @ENDTIME datetime = '01/01/1900 00:00:00',  @Status int output) As declare @UOM char(9) declare @LStatus integer declare @EQPLINE int declare @LNITMSEQ int declare @SRVSTAT char(3) declare @ITEMUSETYPE char(3) declare @ITEMDESC char(51) declare @LOCNCODE char(11) declare @ATYALLOC numeric(19,5) declare @QTYBACKO numeric(19,5) declare @UNITCOST numeric(19,5) declare @UNITPRCE numeric(19,5) declare @EXTDCOST numeric(19,5) declare @XTNDPRCE numeric(19,5) declare @LABPCT numeric(19,5) declare @PARTPCT numeric(19,5) declare @MISCPCT numeric(19,5) declare @PRICELVL char(15) declare @DEX_ROW_ID int  declare @STATUSOPTION int declare @DECCURR integer declare @DECQTY integer declare @STANDARDCOST numeric(19,5) declare @CURRENTCOST numeric(19,5) declare @QTYINBASE numeric(19,5) declare @TRANSTIME char(7) declare @BILLTIME char(7) IF not exists (select * from IV00101 where IV00101.ITEMNMBR = @ITEMNMBR) BEGIN  select @Status = 9999  return (0) END IF not exists (select * from SVC00200 where SVC00200.SRVRECTYPE = @SRVRECTYPE and SVC00200.CALLNBR = @CALLNBR) BEGIN  select @Status = 9998  return (0) END exec SVC_IV_UMObj_GetBaseUofM @ITEMNMBR,@UOM OUTPUT, @LStatus OUTPUT IF @LStatus <> 0  BEGIN  select @Status = @LStatus  return(0) END  select @LNITMSEQ = MAX(IsNull(LNITMSEQ,0)) + 16384  from SVC00203  WHERE SVC00203.SRVRECTYPE = @SRVRECTYPE and  SVC00203.CALLNBR = @CALLNBR and  SVC00203.EQPLINE = 1 and  SVC00203.LINITMTYP = @LINITMTYP if @LNITMSEQ is null or @LNITMSEQ = 0  select @LNITMSEQ = 16384  select @ITEMDESC = ITEMDESC,  @CURRENTCOST = CURRCOST,  @STANDARDCOST = STNDCOST,  @DECCURR = DECPLCUR,  @DECQTY = DECPLQTY  from IV00101 where ITEMNMBR = @ITEMNMBR  select @LOCNCODE = LOCNCODE  from SVC00100 where TECHID = @TECHID IF @@error <> 0 OR @LOCNCODE IS NULL BEGIN  select @LOCNCODE = '' END exec SVC_Get_ItemPriceLevel   @SRVRECTYPE,  @CALLNBR,  @LINITMTYP,   @ITEMNMBR,   @PRICELVL OUTPUT IF @LINITMTYP = 'P' BEGIN  IF NOT exists (select * from SVC00951 where ITEMNMBR = @ITEMNMBR)  exec zDP_SVC00951SI '',@ITEMNMBR,0,0,'','',0,0,0,0,0,@DEX_ROW_ID  select @ITEMUSETYPE = case   when RTRNABLE = 1 THEN 'I'  else 'C'  end  from SVC00951  where ITEMNMBR = @ITEMNMBR  IF @@error <> 0 OR @ITEMUSETYPE IS NULL OR @ITEMUSETYPE = ''  BEGIN  select @ITEMUSETYPE = 'C'  END  exec SVC_Allocate_and_Backorder @ITEMNMBR,  @LOCNCODE,  @QTY,  @CALLNBR,  @SRVRECTYPE,  @LNITMSEQ,  @ITEMDESC,  @UOM,  '',  '',  @ATYALLOC output,  @QTYBACKO output  IF @QTYBACKO > 0  BEGIN  select @SRVSTAT = Backorder_Status   from SVC00998   IF (select SRVSTAT from SVC00200 where SRVRECTYPE = @SRVRECTYPE and CALLNBR = @CALLNBR) > @SRVSTAT  update SVC00200 set SRVSTAT = @SRVSTAT where SRVRECTYPE = @SRVRECTYPE and CALLNBR = @CALLNBR  END ELSE  BEGIN  select @SRVSTAT = SRVSTAT   from SVC00998  END   IF @QTYSOLD > 0   BEGIN  IF @QTYBACKO > 0   select @QTYSOLD = @QTYSOLD - @QTYBACKO  END  select @TRANSTIME = '',@BILLTIME = '' END ELSE IF @LINITMTYP = 'L'  BEGIN select @QTYSOLD = 0,@QTYBACKO = 0, @ATYALLOC = 0, @TRANSTIME = '',@BILLTIME = '' END ELSE IF @LINITMTYP = 'A'  BEGIN select @QTYSOLD = 0,@QTYBACKO = 0, @ATYALLOC = 0,@TRANSTIME = '',@BILLTIME = '' END   select @LABPCT = LABPCT,  @MISCPCT = MISCPCT,  @PARTPCT = PARTPCT from SVC00200  where SRVRECTYPE = @SRVRECTYPE and  CALLNBR = @CALLNBR  exec SVC_Obj_ItemCostPrice @ITEMNMBR,@PRICELVL, @QTYSOLD, @UOM output, @UNITPRCE output, @UNITCOST output   IF @UNITCOST is null   select @UNITCOST = 0 IF @UNITPRCE is null   select @UNITPRCE = 0 IF @EXTDCOST is null   select @EXTDCOST = 0 IF @XTNDPRCE is null   select @XTNDPRCE = 0  select @XTNDPRCE = (@UNITPRCE * @QTYSOLD) * (@PARTPCT / 100.0) select @EXTDCOST = (@UNITCOST * @QTYSOLD) exec zDP_SVC00203SI @SRVRECTYPE,              @CALLNBR,                 1,                        @LNITMSEQ,                @LINITMTYP,                                 @SRVSTAT,                 @TECHID,                  @ITEMNMBR,                @ITEMUSETYPE,             @ITEMDESC,                @LOCNCODE,                @UOM,                     @QTY,                     @ATYALLOC,                @QTYBACKO,                @QTYSOLD,                 @UNITCOST,                @UNITPRCE,                @EXTDCOST,                @XTNDPRCE,                0,                        @STARTDATE,               @STARTTIME,               @ENDDATE,                 @ENDTIME,                 @TRANSTIME,               @BILLTIME,                '',                       0,                        0,                         '',                       0,                        @LABPCT,    @PARTPCT,                 @MISCPCT,                 '01/01/1900 00:00:00',    '',                       0,                        0,                        '',                       '',                       0,                        0,                        0,                        @PRICELVL,                @DEX_ROW_ID OUT          exec SVC_Set_Service_Totals @SRVRECTYPE, @CALLNBR  return    
GO
GRANT EXECUTE ON  [dbo].[SVC_AddPart_To_Service_Call] TO [DYNGRP]
GO
