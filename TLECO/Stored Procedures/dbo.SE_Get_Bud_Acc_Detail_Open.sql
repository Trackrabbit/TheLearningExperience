SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
CREATE PROCEDURE [dbo].[SE_Get_Bud_Acc_Detail_Open] @Id char(15) =NULL, @CurIdx smallint =NULL, @IsBud smallint =NULL, @Yr smallint =NULL, @NoSegs smallint =NULL, @Noperiods smallint =NULL, @budname char(15) =NULL AS declare @accidx int declare @NetAmt numeric(19,5) declare @PeriodBal numeric(19,5) declare @ZBal smallint declare @ZPBal smallint declare @acc1 char(5) declare @acc2 char(5) declare @acc3 char(3) declare @acc4 char(3) declare @sesorno1 smallint declare @sesort char(11) declare @percount smallint declare @ACTNUMST varchar(255) declare mycurs cursor for  select a.ACTINDX,a.ACTNUMBR_1, a.ACTNUMBR_2, a.ACTNUMBR_3, a.ACTNUMBR_4, a.SESORNO1,a.SESORT1,b.ACTNUMST  from SE00400 a, GL00105 b  where USERID = @Id  and b.ACTINDX = a.ACTINDX  order by a.ACTINDX for read only open mycurs fetch next from mycurs into @accidx,@acc1, @acc2, @acc3, @acc4, @sesorno1,@sesort,@ACTNUMST while @@fetch_status = 0 begin  select @Noperiods = count(*) from SE000100  select @percount = 0  select @PeriodBal = 0  while @percount <= @Noperiods begin   select @NetAmt = 0   select @NetAmt = isnull(BUDGETAMT,0) from GL00201 where ACTINDX = @accidx and PERIODID = @percount    and BUDGETID = @budname   select @ZPBal=0   if @NetAmt = 0   begin    select @ZBal=1    if @PeriodBal = 0    begin     select @ZPBal=1    end   end   else   begin    select @ZBal=0    select @PeriodBal = @PeriodBal + @NetAmt   end    if (select count(isnull(USERID,'1')) from SE000401 where USERID = @Id and ACTNUMBR_1 = @acc1 and ACTNUMBR_2 = @acc2 and ACTNUMBR_3 = @acc3 and ACTNUMBR_4 = @acc4 and PERIODID = @percount and SESORT1 = @sesort and OPENYEAR = @Yr and CURRNIDX = @CurIdx and SEBUDDET = @IsBud and  ACTINDX = @accidx) = 0 BEGIN   insert SE000401(USERID,ACTNUMBR_1, ACTNUMBR_2, ACTNUMBR_3, ACTNUMBR_4, PERIODID,SESORNO1,SESORT1,SE_Zero_NM,SE_Zero_PB,NETAMNT,PERDBLNC,OPENYEAR,CURRNIDX,SEBUDDET,ACTINDX,ACTNUMST)    values (@Id,@acc1, @acc2, @acc3, @acc4,     @percount,@sesorno1,@sesort,     @ZBal,@ZPBal,@NetAmt,@PeriodBal,@Yr,@CurIdx,@IsBud,@accidx,@ACTNUMST) end   select @percount = @percount + 1  end   fetch next from mycurs into @accidx,@acc1, @acc2, @acc3, @acc4, @sesorno1,@sesort,@ACTNUMST end close mycurs deallocate mycurs
GO
GRANT EXECUTE ON  [dbo].[SE_Get_Bud_Acc_Detail_Open] TO [DYNGRP]
GO
