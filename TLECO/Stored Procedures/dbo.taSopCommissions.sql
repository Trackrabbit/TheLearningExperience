SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[taSopCommissions]  @I_vSOPTYPE smallint,    @I_vSOPNUMBE char(21),     @I_vLNITMSEQ int=0,    @I_vSLPRSNID char(15),    @I_vSALSTERR char(15) = '',   @I_vCOMPRCNT numeric(19,2) = 0,   @I_vCOMMAMNT numeric(19,5) = 0,   @I_vPRCTOSAL numeric(19,5) = 100.00,  @I_vCUSTNMBR char(15),     @I_vCURNCYID char(15) = '',   @I_vRequesterTrx smallint = 0,   @I_vUSRDEFND1 char(50) = '',   @I_vUSRDEFND2 char(50) = '',   @I_vUSRDEFND3 char(50) = '',   @I_vUSRDEFND4 varchar(8000) = '',  @I_vUSRDEFND5 varchar(8000) = '',  @O_iErrorState int output,   @oErrString varchar(255) output    with encryption as  set transaction isolation level read uncommitted set nocount on  declare  @COMAPPTO tinyint,  @LNITMSEQ int,  @CURRNIDX int,  @iStatus int,  @iError int,  @iCustomState int,  @iCustomErrString varchar(255),  @O_oErrorState int,  @ACTSLAMT numeric(19,5),  @CMMSLAMT numeric(19,5),  @NCOMAMNT numeric(19,5),  @DECPLCUR int,  @CMPANYID smallint  select  @iStatus = 0,  @iError = 0,  @O_iErrorState = 0,  @COMAPPTO = 0,  @ACTSLAMT = 0,  @CMMSLAMT = 0,  @NCOMAMNT = 0,  @CURRNIDX = 0,  @LNITMSEQ = 0,  @DECPLCUR = 0,  @CMPANYID = 0   if (@oErrString is NULL) begin  select @oErrString = '' end  exec @iStatus = taSopCommissionsPre  @I_vSOPTYPE output,  @I_vSOPNUMBE output,  @I_vLNITMSEQ output,  @I_vSLPRSNID output,  @I_vSALSTERR output,  @I_vCOMPRCNT output,  @I_vCOMMAMNT output,  @I_vPRCTOSAL output,  @I_vCUSTNMBR output,  @I_vCURNCYID output,   @I_vRequesterTrx output,  @I_vUSRDEFND1 output,  @I_vUSRDEFND2 output,  @I_vUSRDEFND3 output,  @I_vUSRDEFND4 output,  @I_vUSRDEFND5 output,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if @iStatus = 0 and @iError <> 0 begin  select @iStatus = @iError end if (@iStatus <> 0) or (@iCustomState <> 0) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  select @O_iErrorState = 556    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if ( @I_vSOPTYPE is null or  @I_vSOPNUMBE is null or  @I_vSLPRSNID is null or  @I_vCUSTNMBR is null or  @I_vCURNCYID is null or   @I_vRequesterTrx is null  ) begin  select @O_iErrorState = 424     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if ( @I_vSOPTYPE = 0 or   @I_vSOPNUMBE = '' or  @I_vSLPRSNID = '' or  @I_vCUSTNMBR = ''  ) begin  select @O_iErrorState = 425     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  select @I_vSOPNUMBE = UPPER(@I_vSOPNUMBE),  @I_vCUSTNMBR = UPPER(@I_vCUSTNMBR),  @I_vSALSTERR = UPPER(@I_vSALSTERR),  @I_vSLPRSNID = UPPER(@I_vSLPRSNID),  @I_vCURNCYID = UPPER(@I_vCURNCYID)  select @CMPANYID = CMPANYID from DYNAMICS..SY01500 (nolock) where INTERID = db_name()   if (@I_vCURNCYID <> '')  begin  select @CURRNIDX = isnull(CURRNIDX,0) from DYNAMICS..MC40200 (nolock) where CURNCYID = @I_vCURNCYID end  if (@I_vCURNCYID = '') begin  select @I_vCURNCYID = isnull(RM00101.CURNCYID, '') from RM00101 (nolock) where RM00101.CUSTNMBR = @I_vCUSTNMBR  if (@I_vCURNCYID <> '')  begin  select @CURRNIDX = isnull(CURRNIDX,0) from DYNAMICS..MC40200 (nolock) where CURNCYID = @I_vCURNCYID  end  else  begin  select @I_vCURNCYID = isnull(FUNLCURR, ''), @CURRNIDX = isnull(FUNCRIDX,0) from MC40000 (nolock)   end end  if (@I_vCURNCYID = '') or (@CURRNIDX = 0) begin  select @O_iErrorState = 9278    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vCURNCYID <> '') begin  if (not exists(select 1 from DYNAMICS..MC40200 (nolock) where CURNCYID = @I_vCURNCYID))  begin  select @O_iErrorState = 5612     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if ( @I_vCURNCYID <> '' ) begin  if (not exists (select 1 from DYNAMICS..MC60100 (nolock) where CURNCYID = @I_vCURNCYID and CMPANYID = @CMPANYID ))  begin  select @O_iErrorState = 5613     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@I_vCURNCYID <> '') begin   if exists(select 1 from DYNAMICS..MC60100 (nolock) where CMPANYID = @CMPANYID and CURNCYID = @I_vCURNCYID and INACTIVE = 1)  begin  select @O_iErrorState = 5614     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  select @DECPLCUR = DECPLCUR-1 from DYNAMICS..MC40200 (nolock) where CURNCYID = @I_vCURNCYID  if (@I_vSALSTERR = '') begin  select @I_vSALSTERR = SALSTERR from RM00101 (nolock) where CUSTNMBR = @I_vCUSTNMBR end  if (@I_vSLPRSNID <> '') begin  if (not exists (select 1 from RM00301 (nolock) where SLPRSNID = @I_vSLPRSNID))  begin  select @O_iErrorState = 427     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  if (exists (select 1 from RM00301 (nolock) where SLPRSNID = @I_vSLPRSNID and INACTIVE = 1))  begin  select @O_iErrorState = 9540     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  select  @COMAPPTO = isnull(COMAPPTO, 0),  @I_vCOMPRCNT =  case   when @I_vCOMPRCNT = 0   then COMPRCNT/100  else @I_vCOMPRCNT  end  from RM00301 (nolock) where SLPRSNID = @I_vSLPRSNID  if (@I_vLNITMSEQ = 99193) begin  select @I_vLNITMSEQ = 0   if (@COMAPPTO = 0)  begin  select @ACTSLAMT = isnull(sum(OXTNDPRC), 0) from SOP10200 (nolock)   where SOPTYPE = @I_vSOPTYPE and SOPNUMBE = @I_vSOPNUMBE and SALSTERR = @I_vSALSTERR and SLPRSNID = @I_vSLPRSNID  select @I_vCOMMAMNT = sum(round(((@I_vCOMPRCNT/100) * OXTNDPRC), @DECPLCUR))  from SOP10200 (nolock) where SOPTYPE = @I_vSOPTYPE and SOPNUMBE = @I_vSOPNUMBE and SALSTERR = @I_vSALSTERR and SLPRSNID = @I_vSLPRSNID  select @NCOMAMNT = 0  select @I_vPRCTOSAL = 100.00  select @CMMSLAMT = round((@ACTSLAMT * @I_vPRCTOSAL) / 100, @DECPLCUR)  end  else  begin  select @ACTSLAMT = @I_vPRCTOSAL  select @I_vPRCTOSAL = 100.00  select @NCOMAMNT = 0  select @CMMSLAMT = round((@ACTSLAMT * @I_vPRCTOSAL) / 100, @DECPLCUR)  select @I_vCOMMAMNT = round(((@I_vCOMPRCNT/100) * @ACTSLAMT), @DECPLCUR)  end end else begin  select @ACTSLAMT = isnull(sum(OXTNDPRC), 0) from SOP10200 (nolock)   where SOPTYPE = @I_vSOPTYPE and SOPNUMBE = @I_vSOPNUMBE and SALSTERR = @I_vSALSTERR and SLPRSNID = @I_vSLPRSNID  select @CMMSLAMT = round((@ACTSLAMT * @I_vPRCTOSAL)/100, @DECPLCUR)  select @NCOMAMNT = @ACTSLAMT - round((@ACTSLAMT * @I_vPRCTOSAL)/100, @DECPLCUR)   if (@I_vLNITMSEQ = 99195)  begin  select @I_vCOMMAMNT = sum(round(((@I_vCOMPRCNT/100) * OXTNDPRC), @DECPLCUR))  from SOP10200 (nolock) where SOPTYPE = @I_vSOPTYPE and SOPNUMBE = @I_vSOPNUMBE and SALSTERR = @I_vSALSTERR and SLPRSNID = @I_vSLPRSNID  select @I_vLNITMSEQ = 0  end end  if (@I_vSOPTYPE < 1 or @I_vSOPTYPE > 6)  begin   select @O_iErrorState = 697     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vCOMPRCNT < 0.00 or @I_vCOMPRCNT > 100.00) begin  select @O_iErrorState = 694     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vPRCTOSAL < 0.00 or @I_vPRCTOSAL > 100.00) begin  select @O_iErrorState = 778     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (not exists(select 1 from RM00101 (nolock) where CUSTNMBR = @I_vCUSTNMBR)) begin  select @O_iErrorState = 428     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vSALSTERR = '') begin  select @O_iErrorState = 429     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if not exists(select 1 from RM00303 (nolock) where SALSTERR = @I_vSALSTERR) begin  select @O_iErrorState = 430     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if exists(select 1 from SOP10101 (nolock) where SALSTERR = @I_vSALSTERR and SLPRSNID = @I_vSLPRSNID and SOPNUMBE = @I_vSOPNUMBE and SOPTYPE = @I_vSOPTYPE) begin  select @O_iErrorState = 431     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vCOMMAMNT < 0.00) and (@I_vSOPTYPE not in(3,6))  begin  select @O_iErrorState = 695     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@O_iErrorState <> '')  return (@O_iErrorState)  if (@I_vLNITMSEQ = 0) begin  select @LNITMSEQ = isnull(max(SEQNUMBR),0) + 16384 from SOP10101 (nolock) where SOPTYPE = @I_vSOPTYPE and SOPNUMBE = @I_vSOPNUMBE end else begin  select @LNITMSEQ = @I_vLNITMSEQ end  if exists (select 1 from SOP10101 (nolock) where SOPNUMBE = @I_vSOPNUMBE and SEQNUMBR = @LNITMSEQ and SOPTYPE = @I_vSOPTYPE) begin  select @O_iErrorState = 432     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  select @I_vPRCTOSAL = @I_vPRCTOSAL * 100 select @I_vCOMPRCNT = @I_vCOMPRCNT * 100  if (@I_vRequesterTrx=0) begin  exec @iStatus = eConnectOutVerify  @I_vDOCTYPE='Sales_Transaction',  @I_vINDEX1=@I_vSOPNUMBE,  @I_vINDEX2=@I_vSOPTYPE,  @I_vINDEX3='',  @I_vINDEX4='',  @I_vINDEX5='',  @I_vINDEX6='',  @I_vINDEX7='',  @I_vINDEX8='',  @I_vINDEX9='',  @I_vINDEX10='',  @I_vINDEX11='',  @I_vINDEX12='',  @I_vINDEX13='',  @I_vINDEX14='',  @I_vINDEX15='',  @I_vDelete = 0,  @O_iErrorState = @iCustomState output  select @iError = @@error  if ((@iStatus <> 0) or (@iCustomState <> 0) or (@iError <> 0))  begin  select @oErrString = rtrim(@oErrString) + ' ' + @iCustomState  select @O_iErrorState = 2780    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end  insert SOP10101  (  SOPTYPE,  SOPNUMBE,  SEQNUMBR,  SLPRSNID,  SALSTERR,  COMPRCNT,  COMMAMNT,  OCOMMAMT,  NCOMAMNT,  ORNCMAMT,  PRCTOSAL,  ACTSLAMT,  ORSLSAMT,  CMMSLAMT,  ORCOSAMT,  CURRNIDX,  TRXSORCE  )  select  @I_vSOPTYPE,    @I_vSOPNUMBE,    @LNITMSEQ,    @I_vSLPRSNID,    @I_vSALSTERR,    @I_vCOMPRCNT,    @I_vCOMMAMNT,    @I_vCOMMAMNT,    @NCOMAMNT,    @NCOMAMNT,    @I_vPRCTOSAL,    @ACTSLAMT,    @ACTSLAMT,    @CMMSLAMT,    @CMMSLAMT,    @CURRNIDX,    ''    if (@@error <> 0) begin  select @O_iErrorState = 433    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  exec @iStatus = taSopCommissionsPost  @I_vSOPTYPE,  @I_vSOPNUMBE,  @I_vLNITMSEQ,  @I_vSLPRSNID,  @I_vSALSTERR,  @I_vCOMPRCNT,  @I_vCOMMAMNT,  @I_vPRCTOSAL,  @I_vCUSTNMBR,  @I_vCURNCYID,   @I_vRequesterTrx,  @I_vUSRDEFND1,  @I_vUSRDEFND2,  @I_vUSRDEFND3,  @I_vUSRDEFND4,  @I_vUSRDEFND5,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if @iStatus = 0 and @iError <> 0 begin  select @iStatus = @iError end if (@iStatus <> 0) or (@iCustomState <> 0) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  select @O_iErrorState = 557    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if (@I_vRequesterTrx=0) begin  exec @iStatus = eConnectOutVerify  @I_vDOCTYPE='Sales_Transaction',  @I_vINDEX1=@I_vSOPNUMBE,  @I_vINDEX2=@I_vSOPTYPE,  @I_vINDEX3='',  @I_vINDEX4='',  @I_vINDEX5='',  @I_vINDEX6='',  @I_vINDEX7='',  @I_vINDEX8='',  @I_vINDEX9='',  @I_vINDEX10='',  @I_vINDEX11='',  @I_vINDEX12='',  @I_vINDEX13='',  @I_vINDEX14='',  @I_vINDEX15='',  @I_vDelete = 1,  @O_iErrorState = @iCustomState output  select @iError = @@error  if ((@iStatus <> 0) or (@iCustomState <> 0) or (@iError <> 0))  begin  select @oErrString = rtrim(@oErrString) + ' ' + @iCustomState  select @O_iErrorState = 2779    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end  return (@O_iErrorState)   
GO
GRANT EXECUTE ON  [dbo].[taSopCommissions] TO [DYNGRP]
GO
