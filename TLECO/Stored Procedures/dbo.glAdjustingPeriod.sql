SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[glAdjustingPeriod]  @I_dDate                datetime        = NULL,  @O_AdjustmentPeriod tinyint  = NULL output,  @O_iOUTErr              int             = NULL  output,  @O_iErrorState          int             = NULL  output  as  declare  @TRUE                   smallint,  @FALSE                  smallint,  @sYear smallint,  @iMaxPeriod smallint,  @iAdjustingPeriodCount smallint,  @iAdjustingPeriod1      smallint,  @iAdjustingPeriod2 smallint,  @iRegularPeriodClosed tinyint  select          @O_AdjustmentPeriod = 0,  @O_iOUTErr      = 0,  @O_iErrorState  = 0  if      (@I_dDate  is NULL) begin  select          @O_iErrorState = 21123,  @O_iOUTErr = 3  return end  select  @TRUE = 1,  @FALSE = 0  select @iAdjustingPeriod1 = 0 select @iAdjustingPeriod2 = 0  select   @sYear = YEAR1  from   SY40101  where   FSTFSCDY <= @I_dDate  and LSTFSCDY >= @I_dDate  if @@rowcount <> 1  begin  select @O_iOUTErr = 2  return end  select   @iMaxPeriod = max(PERIODID)   from   SY40100  where   YEAR1 = @sYear  and SERIES = 0   and FORIGIN = 1  and PERIODDT <= @I_dDate  and PERDENDT >= @I_dDate  select   @iAdjustingPeriodCount = COUNT(1)  from  SY40100  where  YEAR1 = @sYear  and SERIES = 0   and FORIGIN = 1  and PERIODDT = (select PERIODDT from SY40100 where PERIODID = @iMaxPeriod and YEAR1 = @sYear and SERIES = 0 and FORIGIN = 1)  and PERIODID < @iMaxPeriod  if @iAdjustingPeriodCount = 1 begin  select @iAdjustingPeriod1 = @iMaxPeriod  select @iMaxPeriod = @iMaxPeriod - 1 end else if @iAdjustingPeriodCount = 2 begin  select @iAdjustingPeriod2 = @iMaxPeriod  select @iAdjustingPeriod1 = @iMaxPeriod - 1  select @iMaxPeriod = @iMaxPeriod - 2 end  select @iRegularPeriodClosed = CLOSED from SY40100 where PERIODID = @iMaxPeriod and YEAR1 = @sYear and SERIES = 2  if @iRegularPeriodClosed = @TRUE begin  select @O_AdjustmentPeriod =   case @iAdjustingPeriod1  when 0 then  @FALSE  else  @TRUE  end end else begin  select @O_AdjustmentPeriod = 0 end  return    
GO
GRANT EXECUTE ON  [dbo].[glAdjustingPeriod] TO [DYNGRP]
GO
