SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[svcCLContractCards]   @I_cUserID char(15)    = NULL,  @I_cUserDate char(12)    = NULL,  @I_cFunctionalCurrency char(15)    = NULL,  @I_PriceBookGroup  varchar(40) = NULL,  @I_PriceBookLine varchar(40) = NULL,  @I_ContractType varchar(40) = NULL,  @O_iErrorState int  = NULL output as  declare  @iError int,   @iStatus int,   @cSearchString1 char(2),  @tLoop tinyint  select  @O_iErrorState = 0,  @iStatus  = 0,  @cSearchString1 = '%1'  while (@tLoop is NULL) begin  select @tLoop = 1   if   @I_cUserID is NULL  or @I_PriceBookGroup is NULL  or @I_PriceBookLine is NULL  begin  select @O_iErrorState = 20846  break  end   create table #CNTRLNUMTEMP(  CNTRLNUM varchar(31) not null,  DOCTYPE smallint not null,  VENDORID varchar(30) not null )   insert into  #CNTRLNUMTEMP(  CNTRLNUM,  DOCTYPE,  VENDORID )  select   CNTTYPE,  3,  'Contract Type: '  from   SVC00602  where CNTTYPDESC='' or SRVTYPE ='' or ITEMNMBR =''  or GL_Prepaid_Account=0 or GL_Service_Account =0  or SVC_Contract_Batch_ID = '' or SVC_Contract_Document_ID =''   or SVC_C_Credit_Batch_ID='' or SVC_C_Credit_Document_ID=''   if @@rowcount <> 0  begin  exec @iStatus = svcCreateErrorLogRecord  @I_cUserID,  @I_ContractType,  'Required Fields are missing.',  @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break  end    insert into  #CNTRLNUMTEMP(  CNTRLNUM,  DOCTYPE,  VENDORID )  select   'Act. Index - ' + cast(GL_Prepaid_Account AS varchar(6)),  1,  'Contract Type: ' + CNTTYPE  from   SVC00602   where GL_Prepaid_Account not in (select ACTINDX from GL00100)  and GL_Prepaid_Account > 0   if @@rowcount <> 0  begin  update SVC00602 with (rowlock)  set GL_Prepaid_Account = 0  where GL_Prepaid_Account not in (select ACTINDX from GL00100)  and GL_Prepaid_Account > 0  exec @iStatus = svcCreateErrorLogRecord  @I_cUserID,  @I_ContractType,  'Invalid Accrual/Liability Account Index field has been cleared from the record.',  @O_iErrorState output   select @iError = @@error  if @iStatus <> 0 or @O_iErrorState <> 0 or @iError <> 0  break  end   insert into  #CNTRLNUMTEMP(  CNTRLNUM,  DOCTYPE,  VENDORID )  select   'Act. Index - ' + cast(GL_Service_Account AS varchar(6)),  1,  'Contract Type: ' + CNTTYPE  from   SVC00602   where GL_Service_Account not in (select ACTINDX from GL00100)  and GL_Service_Account > 0   if @@rowcount <> 0  begin  update SVC00602 with (rowlock)  set GL_Service_Account = 0  where GL_Service_Account not in (select ACTINDX from GL00100)  and GL_Service_Account > 0  exec @iStatus = svcCreateErrorLogRecord  @I_cUserID,  @I_ContractType,  'Invalid Sales Account Index field has been cleared from the record.',  @O_iErrorState output   select @iError = @@error  if @iStatus <> 0 or @O_iErrorState <> 0 or @iError <> 0  break  end    insert into  #CNTRLNUMTEMP(  CNTRLNUM,  DOCTYPE,  VENDORID )  select   PRICSHED,  1,  'Price Group'  from   SVC00654   where not exists  (select   1  from   SVC00650  where   SVC00650.PRICSHED = SVC00654.PRICSHED) and PRICSHED > ''  group by PRICSHED   if @@rowcount <> 0  begin  delete  SVC00654   where not exists  (select   1  from   SVC00650  where   SVC00650.PRICSHED = SVC00654.PRICSHED)   exec @iStatus = smCreateErrorLogRecord  @I_cUserID,  @I_PriceBookGroup,  @cSearchString1,  11503,  @O_iErrorState output   select @iError = @@error  update SY03400 set ERMSGTX2 = 'No Corresponding record was found in the SVC_Contract_Price_Book Table' where  FILENAME = @I_PriceBookGroup and ERMSGTX2 = ''   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break  end    insert into  #CNTRLNUMTEMP(  CNTRLNUM,  DOCTYPE,  VENDORID )  select   PRICSHED,  2,  'PriceBook'  from   SVC00651   where not exists  (select   1  from   SVC00650  where   SVC00650.PRICSHED = SVC00651.PRICSHED)  group by PRICSHED   if @@rowcount <> 0  begin   delete  SVC00651   where not exists  (select   1  from   SVC00650  where   SVC00650.PRICSHED = SVC00651.PRICSHED)  exec @iStatus = smCreateErrorLogRecord  @I_cUserID,  @I_PriceBookLine,  @cSearchString1,  11503,  @O_iErrorState output   select @iError = @@error  update SY03400 set ERMSGTX2 = 'No Corresponding record was found in the SVC_Contract_Price_Book Table' where  FILENAME = @I_PriceBookLine and ERMSGTX2 = ''   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break  end   end   return(@iStatus)    
GO
GRANT EXECUTE ON  [dbo].[svcCLContractCards] TO [DYNGRP]
GO
