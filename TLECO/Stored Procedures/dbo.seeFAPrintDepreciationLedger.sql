SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[seeFAPrintDepreciationLedger]  @Asset_ID_From VARCHAR(15),  @Asset_ID_To VARCHAR(15),  @Suf varchar(3),  @Asset_Description varchar(41),  @Asset_Type varchar(100),  @Structure_ID varchar(31),  @Asset_Class_ID varchar(15),  @Location_ID varchar(15),  @Property_Type varchar(100),  @Place_In_Service_Date_From datetime,  @Place_In_Service_Date_To datetime,  @Acquisition_Date_From datetime,  @Acquisition_Date_To datetime,   @Fully_Depreciated_Date_From datetime,  @Fully_Depreciated_Date_To datetime,  @Switch_Date_From datetime,  @Switch_Date_To datetime,   @Depreciation_Method varchar(100),  @Averaging_Convention varchar(100),  @Original_Life_Years_From smallint,  @Original_Life_Years_To smallint,  @Original_Life_Days_From smallint,  @Original_Life_Days_To smallint,  @Remaining_Life_Years_From smallint,  @Remaining_Life_Years_To smallint,  @Remaining_Life_Days_From smallint,  @Remaining_Life_Days_To smallint,  @Cost_Basis_From numeric(19,5),  @Cost_Basis_To numeric(19,5),  @YTD_Depreciation_Amount_From numeric(19,5),  @YTD_Depreciation_Amount_To numeric(19,5),  @LTD_Depreciation_Amount_From numeric(19,5),  @LTD_Depreciation_Amount_To numeric(19,5),  @Net_Book_Value_From numeric(19,5),  @Net_Book_Value_To numeric(19,5),  @Asset_Status varchar(100),  @Book_ID varchar(15),  @Depreciation_as_of_Date datetime,  @Calculate_with_Original_Amounts tinyint  AS  select distinct [Asset ID], [Suf], [Asset Description],  [Location ID], [Asset Class ID],  [Depreciation Method],  [Averaging Convention],  [Cost Before Retire or Delete],[Cost Basis],isnull([LTD Depreciation Amount],0.0) as [LTD Depreciation Amount],  isnull([YTD Depreciation Amount],0.0) as [YTD Depreciation Amount],  isnull([Net Book Value],0.0) as [Net Book Value],[Place in Service Date],  [Original Life Years],[Original Life Days],  [Structure ID],  case when ([Depreciated to Date] > @Depreciation_as_of_Date) then [Remaining Life Years] else REMAININGLIFEYEARS end as [Remaining Life Years],  case when ([Depreciated to Date] > @Depreciation_as_of_Date) then [Remaining Life Days] else REMAININGLIFEDAYS end as [Remaining Life Days],  [Asset Type],  [Property Type],  [Acquisition Date],[Fully Depreciated Date],  [Switch From 1 Date],  [Asset Status],  isnull([Current Run Depreciation Amount],0.0) as [Current Run Depreciation Amount],  [Amortization Code],  [Amortization Amount],  case when (([Depreciated to Date] > @Depreciation_as_of_Date) and ([Place in Service Date] >= @Depreciation_as_of_Date))  then [Place in Service Date] else [Depreciated to Date] end as [Depreciated to Date],  RETIREMENTDATE,ASSETINDXAFTRET into #DepreciationLedger  from ( select a.ASSETID as [Asset ID], cast(a.ASSETIDSUF as varchar) as [Suf], a.ASSETDESC as [Asset Description],  a.LOCATNID as [Location ID], a.ASSETCLASSID as [Asset Class ID],  dbo.FA_FUNC_Depreciation_Method(b.DEPRECIATIONMETHOD) as [Depreciation Method],  dbo.FA_FUNC_Averaging_Convention(b.AVERAGINGCONV) as [Averaging Convention],  b.COSTBFRETORDEL as [Cost Before Retire or Delete],b.COSTBASIS as [Cost Basis],   dbo.FA_CalcLTDDepreciation(a.ASSETINDEX,d.BOOKINDX,@Depreciation_as_of_Date,@Calculate_with_Original_Amounts) as [LTD Depreciation Amount],  dbo.FA_CalcYTDDepreciation(a.ASSETINDEX,d.BOOKINDX,@Depreciation_as_of_Date,@Calculate_with_Original_Amounts) as [YTD Depreciation Amount],  dbo.FA_CalcNetBookValue(a.ASSETINDEX,d.BOOKINDX,@Depreciation_as_of_Date,@Calculate_with_Original_Amounts) as [Net Book Value],   b.PLINSERVDATE as [Place in Service Date],  b.ORIGINALLIFEYEARS as [Original Life Years],b.ORIGINALLIFEDAYS as [Original Life Days],  a.STRUCTUREID as [Structure ID],  dbo.FA_RWCalcRemainingLife(@Depreciation_as_of_Date,b.PLINSERVDATE,b.DEPRBEGDATE,b.ORIGINALLIFEYEARS,b.ORIGINALLIFEDAYS,0,b.AVERAGINGCONV) as [Remaining Life Years],  b.REMAININGLIFEYEARS,  dbo.FA_RWCalcRemainingLife(@Depreciation_as_of_Date,b.PLINSERVDATE,b.DEPRBEGDATE,b.ORIGINALLIFEYEARS,b.ORIGINALLIFEDAYS,1,b.AVERAGINGCONV) as [Remaining Life Days],  b.REMAININGLIFEDAYS,  dbo.FA_FUNC_Asset_Type(a.ASSETTYPE) as [Asset Type],  dbo.FA_FUNC_Property_Type(a.PROPTYPE) as [Property Type],  a.ACQDATE as [Acquisition Date],b.FULLYDEPRDATE as [Fully Depreciated Date],  b.SWITCHFM1DATE as [Switch From 1 Date],  dbo.FA_FUNC_Asset_Status(a.ASSETSTATUS) as [Asset Status],a.ASSETSTATUS,   dbo.FA_CalcCurrentDepreciation(a.ASSETINDEX,d.BOOKINDX,@Depreciation_as_of_Date,@Calculate_with_Original_Amounts) as [Current Run Depreciation Amount],  dbo.FA_FUNC_Amortization_Code(b.AMORTIZATIONCODE) as [Amortization Code],  b.AMORTIZATIONAMOUNT as [Amortization Amount], b.DEPRTODATE as [Depreciated to Date],  isnull(e.RETIREMENTDATE,'') as RETIREMENTDATE,isnull(e.ASSETINDXAFTRET,0) as ASSETINDXAFTRET  from [FA00902] as c left outer join [FA00100] as a on c.[ASSETINDEX] = a.[ASSETINDEX]   left outer join [FA00200] as b on c.[ASSETINDEX] = b.[ASSETINDEX] and c.[BOOKINDX] = b.[BOOKINDX]   left outer join [FA40200] as d on b.[BOOKINDX] = d.[BOOKINDX]   left outer join [FA00700] as e on a.[ASSETINDEX] = e.[ASSETINDXAFTRET]  where c.TRANSACCTTYPE=2  and (a.ASSETID>=@Asset_ID_From and a.ASSETID<=@Asset_ID_To)  and (@Suf='ALL' or (cast(a.ASSETIDSUF as varchar)=@Suf))  and (@Asset_Description='ALL' or (a.ASSETDESC=@Asset_Description))  and (@Structure_ID='ALL' or (a.STRUCTUREID=@Structure_ID))  and (@Asset_Class_ID='ALL' or (a.ASSETCLASSID=@Asset_Class_ID))  and (@Location_ID='ALL' or (a.LOCATNID=@Location_ID))  and b.PLINSERVDATE between @Place_In_Service_Date_From and @Place_In_Service_Date_To  and a.ACQDATE between @Acquisition_Date_From and @Acquisition_Date_To  and b.FULLYDEPRDATE between @Fully_Depreciated_Date_From and @Fully_Depreciated_Date_To  and b.SWITCHFM1DATE between @Switch_Date_From and @Switch_Date_To  and b.ORIGINALLIFEYEARS between @Original_Life_Years_From and @Original_Life_Years_To  and b.ORIGINALLIFEDAYS between @Original_Life_Days_From and @Original_Life_Days_To  and b.REMAININGLIFEYEARS between @Remaining_Life_Years_From and @Remaining_Life_Years_To  and b.REMAININGLIFEDAYS between @Remaining_Life_Days_From and @Remaining_Life_Days_To  and b.YTDDEPRAMT between @YTD_Depreciation_Amount_From and @YTD_Depreciation_Amount_To  and b.LTDDEPRAMT between @LTD_Depreciation_Amount_From and @LTD_Depreciation_Amount_To  and b.NETBOOKVALUE between @Net_Book_Value_From and @Net_Book_Value_To   and d.BOOKID=@Book_ID  ) LedgerDetail  where (@Asset_Type='ALL' or ([Asset Type]=rtrim(@Asset_Type)))  and (@Property_Type='ALL' or ([Property Type]=rtrim(@Property_Type)))  and (@Depreciation_Method='ALL' or ([Depreciation Method]=rtrim(@Depreciation_Method)))  and (@Averaging_Convention='ALL' or ([Averaging Convention]=rtrim(@Averaging_Convention)))  and (@Asset_Status='ALL'   or (@Asset_Status=dbo.FA_FUNC_Asset_Status(1) and   ((ASSETSTATUS=1) or (ASSETSTATUS=4 and RETIREMENTDATE>=@Depreciation_as_of_Date)))  or (@Asset_Status=dbo.FA_FUNC_Asset_Status(4) and (([Asset Status]=rtrim(@Asset_Status) and ASSETSTATUS=4)  and (ASSETSTATUS=4 and RETIREMENTDATE<@Depreciation_as_of_Date))) )  and ( (((ASSETSTATUS=1) or (ASSETSTATUS=4 and RETIREMENTDATE>=@Depreciation_as_of_Date))   and ([Cost Basis] between @Cost_Basis_From and @Cost_Basis_To))  or ( (ASSETSTATUS=4 and RETIREMENTDATE<@Depreciation_as_of_Date)  and ([Cost Before Retire or Delete] between @Cost_Basis_From and @Cost_Basis_To)))  update #DepreciationLedger set [Depreciated to Date]=@Depreciation_as_of_Date   where [Depreciated to Date]>@Depreciation_as_of_Date and [Place in Service Date]<=@Depreciation_as_of_Date update #DepreciationLedger set [Remaining Life Years]=[Original Life Years],[Remaining Life Days]=[Original Life Days]   where [Remaining Life Years]>=[Original Life Years] and [Remaining Life Days]>=[Original Life Days] select [Asset ID], [Suf], [Asset Description],  [Location ID], [Asset Class ID],  [Depreciation Method],  [Averaging Convention],  [Cost Before Retire or Delete],[Cost Basis],[LTD Depreciation Amount],  [YTD Depreciation Amount],  [Net Book Value],[Place in Service Date],  [Original Life Years],[Original Life Days],  [Structure ID],  [Remaining Life Years],  [Remaining Life Days],  [Asset Type],  [Property Type],  [Acquisition Date],[Fully Depreciated Date],  [Switch From 1 Date],  [Asset Status],  [Current Run Depreciation Amount],  [Amortization Code],  [Amortization Amount],  [Depreciated to Date],  RETIREMENTDATE,ASSETINDXAFTRET from #DepreciationLedger     
GO
GRANT EXECUTE ON  [dbo].[seeFAPrintDepreciationLedger] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[seeFAPrintDepreciationLedger] TO [rpt_materials manager]
GO
GRANT EXECUTE ON  [dbo].[seeFAPrintDepreciationLedger] TO [rpt_operations manager]
GO
GRANT EXECUTE ON  [dbo].[seeFAPrintDepreciationLedger] TO [rpt_power user]
GO
GRANT EXECUTE ON  [dbo].[seeFAPrintDepreciationLedger] TO [rpt_production manager]
GO
GRANT EXECUTE ON  [dbo].[seeFAPrintDepreciationLedger] TO [rpt_warehouse manager]
GO
