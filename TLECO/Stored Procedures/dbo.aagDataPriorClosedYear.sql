SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aagDataPriorClosedYear] @I_nYearClosed smallint, @I_nPERCENT_FACTOR int = 0, @I_nDECPLfunCUR int = 0, @I_nCMPID int, @I_caaAuditTrailPrefix char(5), @O_nRun_Reconcile_Flag tinyint  = NULL output, @O_nSQL_Error_State int   = NULL output, @O_nHdrID int output, @I_nForUtility tinyint = 0, @I_nMCRegistered tinyint, @I_caaGLHdrBBFTemp_Table char(25) = NULL, @I_caaGLDistBBFTemp_Table char(25) = NULL, @I_caaGLAssingBBFTemp_Table char(25) = NULL, @I_caaGLCodeBBFTemp_Table char(25) = NULL, @I_caaGLDistBBFDispTemp_Table char(25) = NULL, @I_nUtilityForBefore10SP2 int  AS  BEGIN  DECLARE  @JRNENTRY int,  @RCTRXSEQ numeric(19,5),  @TRXSORCE char(13),  @aaGLHdrID int,  @aaOpenPosted int,  @aaNextYearOpen int,  @aaNextYear int,  @nOpenYear int,  @l_cInsertIntoTable char(7),  @l_cmdExec varchar(8000),  @l_nCreateRecToOpen int,  @l_nHdrID int,  @l_cINTERID char(5),  @l_cBBF varchar(255),  @l_cPANDL varchar(255),  @l_cTrxSrc varchar(255),  @l_nStatus int,  @l_nError int  select @l_cINTERID = db_name()   exec    @l_nStatus = DYNAMICS.dbo.smGetMsgString 12030, @l_cINTERID, @l_cBBF output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)   exec    @l_nStatus = DYNAMICS.dbo.smGetMsgString 12125, @l_cINTERID, @l_cPANDL output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)   exec    @l_nStatus = DYNAMICS.dbo.smGetMsgString 183, @l_cINTERID, @l_cTrxSrc output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)   SELECT @l_cTrxSrc = LTRIM(RTRIM(@l_cTrxSrc)) + '%'   Select TOP 1 @aaNextYear=YEAR1 ,@aaNextYearOpen=HISTORYR from SY40101  WHERE YEAR1 > @I_nYearClosed ORDER BY YEAR1 ASC   if @I_nUtilityForBefore10SP2 = 2 and @aaNextYearOpen = 1  begin  select @l_cInsertIntoTable = 'AAG4000', @l_nCreateRecToOpen = 1  end  else  begin  select @l_cInsertIntoTable = 'AAG3000', @l_nCreateRecToOpen = 0  end  IF @aaNextYearOpen = 0  BEGIN  set @nOpenYear = 0  DECLARE aaDataPosted cursor fast_forward for  select NXTYEAR.JRNENTRY, NXTYEAR.RCTRXSEQ, NXTYEAR.TRXSORCE from   (Select * from GL20000 where OPENYEAR = @aaNextYear AND SOURCDOC IN(@l_cBBF, @l_cPANDL) AND SEQNUMBR <> 0 AND TRXSORCE LIKE LTRIM(RTRIM(@l_cTrxSrc))) NXTYEAR  INNER JOIN   (SELECT * FROM GL30000 WHERE  HSTYEAR = @I_nYearClosed AND TRXSORCE LIKE LTRIM(RTRIM(@l_cTrxSrc))) YEARCLOSED  ON NXTYEAR.JRNENTRY = YEARCLOSED.JRNENTRY AND   NXTYEAR.RCTRXSEQ = YEARCLOSED.RCTRXSEQ AND   NXTYEAR.TRXSORCE = YEARCLOSED.TRXSORCE  GROUP BY NXTYEAR.JRNENTRY, NXTYEAR.RCTRXSEQ, NXTYEAR.TRXSORCE  ORDER BY NXTYEAR.JRNENTRY, NXTYEAR.RCTRXSEQ, NXTYEAR.TRXSORCE   END   ELSE  BEGIN   set @nOpenYear = 0   DECLARE aaDataPosted cursor fast_forward for  select NXTYEAR.JRNENTRY, NXTYEAR.RCTRXSEQ, NXTYEAR.TRXSORCE from   (Select * from GL30000 where HSTYEAR = @aaNextYear AND SOURCDOC IN(@l_cBBF, @l_cPANDL) AND SEQNUMBR <> 0 AND TRXSORCE LIKE LTRIM(RTRIM(@l_cTrxSrc))) NXTYEAR  INNER JOIN   (SELECT * FROM GL30000 WHERE  HSTYEAR = @I_nYearClosed AND TRXSORCE LIKE LTRIM(RTRIM(@l_cTrxSrc))) YEARCLOSED  ON NXTYEAR.JRNENTRY = YEARCLOSED.JRNENTRY AND   NXTYEAR.RCTRXSEQ = YEARCLOSED.RCTRXSEQ AND   NXTYEAR.TRXSORCE = YEARCLOSED.TRXSORCE  GROUP BY NXTYEAR.JRNENTRY, NXTYEAR.RCTRXSEQ, NXTYEAR.TRXSORCE  ORDER BY NXTYEAR.JRNENTRY, NXTYEAR.RCTRXSEQ, NXTYEAR.TRXSORCE  END   OPEN aaDataPosted  FETCH NEXT FROM aaDataPosted INTO @JRNENTRY, @RCTRXSEQ, @TRXSORCE  WHILE @@FETCH_STATUS = 0  BEGIN  IF @I_nUtilityForBefore10SP2 = 2  BEGIN  IF @aaNextYearOpen = 0  BEGIN  select @l_nHdrID = 0  select @l_nHdrID = aaGLHdrID from AAG30000   where JRNENTRY = @JRNENTRY AND   YEAR1 = @aaNextYear AND  RCTRXSEQ = @RCTRXSEQ AND  aaGLTRXSource = @TRXSORCE  DELETE FROM AAG30000 WHERE aaGLHdrID = @l_nHdrID  DELETE FROM AAG30001 WHERE aaGLHdrID = @l_nHdrID  DELETE FROM AAG30002 WHERE aaGLHdrID = @l_nHdrID  DELETE FROM AAG30003 WHERE aaGLHdrID = @l_nHdrID  END  ELSE  BEGIN  select @l_nHdrID = 0  select @l_nHdrID = aaGLHdrID from AAG40000   where JRNENTRY = @JRNENTRY AND   YEAR1 = @aaNextYear AND  RCTRXSEQ = @RCTRXSEQ AND  aaGLTRXSource = @TRXSORCE  DELETE FROM AAG40000 WHERE aaGLHdrID = @l_nHdrID  DELETE FROM AAG40001 WHERE aaGLHdrID = @l_nHdrID  DELETE FROM AAG40002 WHERE aaGLHdrID = @l_nHdrID  DELETE FROM AAG40003 WHERE aaGLHdrID = @l_nHdrID  END  END   SELECT @aaGLHdrID = aaGLHdrID FROM AAG40000   WHERE JRNENTRY = @JRNENTRY AND   YEAR1 = @I_nYearClosed AND  RCTRXSEQ = @RCTRXSEQ AND  aaGLTRXSource = @TRXSORCE   EXEC aaClosedYearTransaction   @I_nYearClosed,  @aaNextYear,  @I_nPERCENT_FACTOR,  @I_nDECPLfunCUR,  @I_nCMPID,  @I_caaAuditTrailPrefix,  @O_nRun_Reconcile_Flag,  @O_nSQL_Error_State,  @O_nHdrID output,  @nOpenYear,  @I_nForUtility,  @nOpenYear,  1,  @I_nMCRegistered,  @aaGLHdrID,  @l_nCreateRecToOpen,  @JRNENTRY   select @l_cmdExec = ' INSERT INTO ' + ltrim(rtrim(@I_caaGLHdrBBFTemp_Table)) +   ' SELECT aaGLHdrID, JRNENTRY, RCTRXSEQ, YEAR1, aaTRXType, aaGLTRXSource, aaTRXSource, GLPOSTDT, Ledger_ID   FROM '+ @l_cInsertIntoTable + '0 where  aaGLHdrID = ' + ltrim(rtrim(@O_nHdrID))  exec (@l_cmdExec)   select @l_cmdExec = ' INSERT INTO ' + ltrim(rtrim(@I_caaGLDistBBFTemp_Table)) +   ' SELECT aaGLHdrID,aaGLDistID, INTERID, CorrespondingUnit, ACTINDX, ACCTTYPE, aaBrowseType, DECPLACS, DEBITAMT, CRDTAMNT,   ORDBTAMT,ORCRDAMT,CURNCYID,CURRNIDX, RATETPID,EXGTBLID,XCHGRATE,EXCHDATE,TIME1,RTCLCMTD, DENXRATE,MCTRXSTT, SEQNUMBR,  aaCustID,aaVendID,aaSiteID,aaItemID,aaCopyStatus, aaChangeDate,aaChangeTime, SOURCDOC   FROM '+ @l_cInsertIntoTable + '1 where  aaGLHdrID = ' + ltrim(rtrim(@O_nHdrID))  exec (@l_cmdExec)   select @l_cmdExec = ' INSERT INTO ' + ltrim(rtrim(@I_caaGLDistBBFDispTemp_Table)) +   ' SELECT aaGLHdrID,aaGLDistID, INTERID, CorrespondingUnit, ACTINDX, ACCTTYPE, aaBrowseType, DECPLACS, DEBITAMT, CRDTAMNT,   ORDBTAMT,ORCRDAMT,CURNCYID,CURRNIDX, RATETPID,EXGTBLID,XCHGRATE,EXCHDATE,TIME1,RTCLCMTD, DENXRATE,MCTRXSTT, SEQNUMBR,  aaCustID,aaVendID,aaSiteID,aaItemID,aaCopyStatus,SOURCDOC, aaGLDistID   FROM '+ @l_cInsertIntoTable + '1 where  aaGLHdrID = ' + ltrim(rtrim(@O_nHdrID))  exec (@l_cmdExec)   select @l_cmdExec = ' INSERT INTO ' + ltrim(rtrim(@I_caaGLAssingBBFTemp_Table)) +   ' SELECT aaGLHdrID, aaGLDistID,aaGLAssignID, DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,aaAssignedPercent, DistRef, NOTEINDX, 0  FROM '+ @l_cInsertIntoTable + '2 where  aaGLHdrID = ' + ltrim(rtrim(@O_nHdrID))  exec (@l_cmdExec)   select @l_cmdExec = ' INSERT INTO ' + ltrim(rtrim(@I_caaGLCodeBBFTemp_Table)) +   ' SELECT aaGLHdrID, aaGLDistID, aaGLAssignID, aaTrxDimID, aaTrxCodeID FROM '+ @l_cInsertIntoTable + '3 where  aaGLHdrID = ' + ltrim(rtrim(@O_nHdrID))  exec (@l_cmdExec)   FETCH NEXT FROM aaDataPosted INTO @JRNENTRY, @RCTRXSEQ, @TRXSORCE  END  CLOSE aaDataPosted  DEALLOCATE aaDataPosted  UPDATE AAG40001 SET aaCopyStatus = 8   WHERE aaGLHdrID IN (SELECT aaGLHdrID FROM AAG40000 WHERE YEAR1 = @I_nYearClosed) AND aaCopyStatus = 20  END    
GO
GRANT EXECUTE ON  [dbo].[aagDataPriorClosedYear] TO [DYNGRP]
GO
