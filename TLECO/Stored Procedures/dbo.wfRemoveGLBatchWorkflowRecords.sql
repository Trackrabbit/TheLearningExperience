SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[wfRemoveGLBatchWorkflowRecords]  @wfGLHistoryRemovalTEMP varchar(128) as  begin set NOCOUNT ON declare @SQL_Text varchar(8000)  select @SQL_Text='' select @SQL_Text = @SQL_Text + 'declare @TRXSORCE char(13) ' select @SQL_Text = @SQL_Text + 'declare @WfBusObjKey char(201) ' select @SQL_Text = @SQL_Text + 'declare @BCHSOURC_main char(15), @BCHSOURC char(15),@BACHNUMB char(15),@CREATDDT datetime,@TIME1 datetime ' select @SQL_Text = @SQL_Text + 'declare @WorkflowInstanceID char(37) '  select @SQL_Text = @SQL_Text + 'declare trx_records_removed cursor local fast_forward for ' select @SQL_Text = @SQL_Text + 'select distinct TRXSORCE, BCHSOURC from '+@wfGLHistoryRemovalTEMP+' where TRXSORCE<>'''' ' select @SQL_Text = @SQL_Text + 'open trx_records_removed ' select @SQL_Text = @SQL_Text + 'fetch next from trx_records_removed into @TRXSORCE, @BCHSOURC_main ' select @SQL_Text = @SQL_Text + 'while @@FETCH_STATUS=0  ' select @SQL_Text = @SQL_Text + 'begin ' select @SQL_Text = @SQL_Text + ' if (select count(*) from SY30500 where TRXSORCE=@TRXSORCE)>0 ' select @SQL_Text = @SQL_Text + '  begin ' select @SQL_Text = @SQL_Text + '   select @BCHSOURC=BCHSOURC,@BACHNUMB=BACHNUMB,@CREATDDT=CREATDDT,@TIME1=TIME1 from SY30500 where TRXSORCE=@TRXSORCE ' select @SQL_Text = @SQL_Text + '    '  select @SQL_Text = @SQL_Text + '   select @WfBusObjKey = rtrim(@BACHNUMB)+''~''+rtrim(@BCHSOURC)+''~'' ' select @SQL_Text = @SQL_Text + '    +ltrim(str(year(@CREATDDT)))+''/''+ltrim(str(month(@CREATDDT)))+''/''+ltrim(str(day(@CREATDDT)))+''~'' ' select @SQL_Text = @SQL_Text + '    +convert(char(8),cast(@TIME1 as datetime),108) ' select @SQL_Text = @SQL_Text + '   if @BCHSOURC_main = ''GL_Budget'' ' select @SQL_Text = @SQL_Text + '    delete from SY30500 where BCHSOURC in (''GL_Budget'') and TRXSORCE=@TRXSORCE ' select @SQL_Text = @SQL_Text + '     and not exists(select 1 from GL32000 where TRXSORCE=@TRXSORCE)  ' select @SQL_Text = @SQL_Text + '   else ' select @SQL_Text = @SQL_Text + '    delete from SY30500 where BCHSOURC in (''GL_Normal'',''GL_Clearing'') and TRXSORCE=@TRXSORCE ' select @SQL_Text = @SQL_Text + '     and not exists (select 1 from GL20000 where TRXSORCE=@TRXSORCE)  ' select @SQL_Text = @SQL_Text + '     and not exists (select 1 from GL30000 where TRXSORCE=@TRXSORCE)  '  select @SQL_Text = @SQL_Text + '   if @@ROWCOUNT>0  ' select @SQL_Text = @SQL_Text + '    begin  ' select @SQL_Text = @SQL_Text + '     select @WorkflowInstanceID= ' select @SQL_Text = @SQL_Text + '      (select WorkflowInstanceID from WFI10002 where Workflow_Type_Name=''General Ledger Batch Approval'' ' select @SQL_Text = @SQL_Text + '       and rtrim(WfBusObjKey)=rtrim(@WfBusObjKey)) ' select @SQL_Text = @SQL_Text + '     delete from WFI10002 where WorkflowInstanceID=@WorkflowInstanceID  ' select @SQL_Text = @SQL_Text + '     delete from WFI10003 where WorkflowInstanceID=@WorkflowInstanceID  ' select @SQL_Text = @SQL_Text + '     delete from WFI10004 where WorkflowInstanceID=@WorkflowInstanceID  ' select @SQL_Text = @SQL_Text + '     delete from WF30100 where WorkflowInstanceID=@WorkflowInstanceID ' select @SQL_Text = @SQL_Text + '    end ' select @SQL_Text = @SQL_Text + '  end ' select @SQL_Text = @SQL_Text + ' fetch next from trx_records_removed into @TRXSORCE, @BCHSOURC_main ' select @SQL_Text = @SQL_Text + 'end ' select @SQL_Text = @SQL_Text + 'close trx_records_removed ' select @SQL_Text = @SQL_Text + 'deallocate trx_records_removed '  exec(@SQL_Text)  END   
GO
GRANT EXECUTE ON  [dbo].[wfRemoveGLBatchWorkflowRecords] TO [DYNGRP]
GO
