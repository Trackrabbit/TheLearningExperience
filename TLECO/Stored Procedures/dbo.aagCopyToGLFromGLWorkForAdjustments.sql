SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE              procedure [dbo].[aagCopyToGLFromGLWorkForAdjustments] @I_nGLWorkHdrID int, @HdrID int output, @I_nYear int, @I_cTrxSource char(13), @I_caaTrxSource char(13), @O_fSuccess tinyint = 1 output, @CompayID smallint as begin tran  declare @RCTRXSEQ int,  @ORMSTRID  char(31)  select  @RCTRXSEQ = 0  if exists(Select YEAR1 from SY40101 where YEAR1 = @I_nYear and HISTORYR = 0)   begin   Select top 1 @RCTRXSEQ = RCTRXSEQ ,@ORMSTRID =  ORMSTRID from GL20000  where JRNENTRY in (Select JRNENTRY from AAG10000 where aaGLWorkHdrID = @I_nGLWorkHdrID) and  TRXSORCE = @I_cTrxSource   end  else  begin  Select top 1 @RCTRXSEQ = RCTRXSEQ , @ORMSTRID =  ORMSTRID from GL30000  where JRNENTRY in (Select JRNENTRY from AAG10000 where aaGLWorkHdrID = @I_nGLWorkHdrID) and  TRXSORCE = @I_cTrxSource  end  Update AAG10000 set RCTRXSEQ = @RCTRXSEQ where aaGLWorkHdrID = @I_nGLWorkHdrID   exec DYNAMICS.dbo.aagGetNextID 30000, @CompayID, @HdrID output   INSERT INTO [AAG30000] ([aaGLHdrID], [JRNENTRY], [RCTRXSEQ], [YEAR1],  [aaGLTRXSource], [aaTRXSource],[aaTRXType], [GLPOSTDT], [Ledger_ID])  SELECT  @HdrID, [JRNENTRY], [RCTRXSEQ], @I_nYear,  @I_cTrxSource,@I_caaTrxSource, [aaTRXType], [GLPOSTDT], [Ledger_ID]   FROM [AAG10000]  where aaGLWorkHdrID = @I_nGLWorkHdrID  INSERT INTO [AAG30001] ([aaGLHdrID], [aaGLDistID],[INTERID], [aaBrowseType], [CorrespondingUnit], [ACTINDX], [ACCTTYPE],  [DECPLACS], [DEBITAMT], [CRDTAMNT], [ORDBTAMT], [ORCRDAMT], [CURNCYID],  [CURRNIDX], [RATETPID], [EXGTBLID], [XCHGRATE], [EXCHDATE], [TIME1],  [RTCLCMTD], [DENXRATE], [MCTRXSTT], [SEQNUMBR], [aaCustID], [aaVendID],  [aaSiteID], [aaItemID], [EMPLOYID], [aaCopyStatus],[aaChangeDate],[aaChangeTime])  SELECT   @HdrID, AAG10001.[aaGLWorkDistID],AAG10001.[INTERID],AAG10001.[aaBrowseType], AAG10001.[CorrespondingUnit], AAG10001.[ACTINDX], AAG10001.[ACCTTYPE],   AAG10001.[DECPLACS], AAG10001.[DEBITAMT], AAG10001.[CRDTAMNT], AAG10001.[ORDBTAMT], AAG10001.[ORCRDAMT], AAG10001.[CURNCYID],   AAG10001.[CURRNIDX], AAG10001.[RATETPID], AAG10001.[EXGTBLID], AAG10001.[XCHGRATE], AAG10001.[EXCHDATE], AAG10001.[TIME1],   AAG10001.[RTCLCMTD], AAG10001.[DENXRATE], AAG10001.[MCTRXSTT], AAG10001.[SQNCLINE],   isnull(dbo.aagGetMstrIDGL(2,GL20000.ORMSTRID,0,AAG10001.ACTINDX),0),   isnull(dbo.aagGetMstrIDGL(6,GL20000.ORMSTRID,0,AAG10001.ACTINDX),0),   AAG10001.[aaSiteID], AAG10001.[aaItemID], isnull(dbo.aagGetMstrIDGL(3,GL20000.ORMSTRID,0,AAG10001.ACTINDX),0), AAG10001.[aaCopyStatus],   convert(char(12), getdate(), 102), convert(char(12), getdate(), 108)   FROM AAG10001 , GL20000 , AAG10000   where AAG10000.JRNENTRY = GL20000.JRNENTRY  and AAG10000.RCTRXSEQ = GL20000.RCTRXSEQ   and AAG10001.SQNCLINE = GL20000.SEQNUMBR   and AAG10001.aaGLWorkHdrID = AAG10000.aaGLWorkHdrID   and AAG10001.aaGLWorkHdrID = @I_nGLWorkHdrID  and AAG10001.ACTINDX = GL20000.ACTINDX  INSERT INTO [AAG30002] ([aaGLHdrID], [aaGLDistID], [aaGLAssignID], [DEBITAMT], [CRDTAMNT],  [ORDBTAMT], [ORCRDAMT],[aaAssignedPercent], [DistRef], [NOTEINDX], [aaAliasID])  SELECT    @HdrID, [aaGLWorkDistID], [aaGLWorkAssignID], [DEBITAMT], [CRDTAMNT],  [ORDBTAMT], [ORCRDAMT],[aaAssignedPercent], [DistRef], [NOTEINDX], [aaAliasID]  FROM [AAG10002]  where aaGLWorkHdrID = @I_nGLWorkHdrID   INSERT INTO [AAG30003] ([aaGLHdrID], [aaGLDistID], [aaGLAssignID], [aaTrxDimID], [aaTrxCodeID])  SELECT    @HdrID, [aaGLWorkDistID], [aaGLWorkAssignID], A.aaTrxDimID, [aaTrxCodeID]  FROM [AAG10003] A,AAG00400 B   where aaGLWorkHdrID = @I_nGLWorkHdrID and aaTrxCodeID <> 0 and A.aaTrxDimID=B.aaTrxDimID and B.INACTIVE=0  commit tran    
GO
GRANT EXECUTE ON  [dbo].[aagCopyToGLFromGLWorkForAdjustments] TO [DYNGRP]
GO
