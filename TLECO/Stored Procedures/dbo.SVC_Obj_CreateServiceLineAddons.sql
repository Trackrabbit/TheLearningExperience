SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE procedure [dbo].[SVC_Obj_CreateServiceLineAddons]( @CallNumber char(11) )  as declare @UpdatePrice tinyint,  @CBEXP tinyint,  @CBADDNL tinyint,  @DLRORPCT char(1),  @Price numeric(19,5),  @Item char(31),  @ServiceType char(11),  @ServiceRecType smallint,  @LineItemType char(3),  @LineItemSeq int,  @NextLineItemSeq int,  @SRVSTAT char(3),  @techid char(11),  @item_number char(31),  @item_description char(100),  @location_code char(11),  @QUANTITY numeric(19,5),  @uom char(11),  @baseUofM char(11),  @sellUofM char(11),  @miscpercent numeric(19,5),  @price_level char(15),  @COSTAMNT numeric(19,5),  @ext_cost numeric(19,5),  @ext_price numeric(19,5),  @OrigCost numeric(19,5),  @OrigPrice numeric(19,5),  @Origext_cost numeric(19,5),  @Origext_price numeric(19,5)  declare @I_sRateCalcMethod  smallint ,           @I_sViewMode   smallint,            @I_nExchangeRate  numeric(15,7),       @I_nDenomExchangeRate numeric(15,7),       @I_sMCTrxState   smallint,            @I_sDecimalPlaces  smallint,            @O_iErrorState          int declare @MinDate datetime  exec smGetMinDate @MinDate output  select @ServiceType = SRVTYPE ,@ServiceRecType = SRVRECTYPE, @SRVSTAT = SRVSTAT, @techid = TECHID ,@miscpercent = MISCPCT,@price_level = PRICELVL from SVC00200 where CALLNBR = @CallNumber declare LineCheck CURSOR for   select CBADDNL,CBEXP,DLRORPCT,LISTPRCE,ITEMNMBR,ITEMDESC,QUANTITY,COSTAMNT from SVC00921 where SRVTYPE = @ServiceType and DLRORPCT = 'A' and (CBADDNL = 1 or CBEXP = 1) order by LNITMSEQ open LineCheck fetch next from LineCheck into @CBADDNL,@CBEXP,@DLRORPCT,@Price,@item_number,@item_description,@QUANTITY,@COSTAMNT WHILE (@@FETCH_status <> -1) BEGIN if @QUANTITY <> 0  Begin if @CBADDNL = 1 select @LineItemType = 'A' else if @CBEXP = 1 select @LineItemType = 'E'  select @LineItemSeq = isnull(MAX(LNITMSEQ),0) from SVC00203 where CALLNBR = @CallNumber and LINITMTYP = @LineItemType if  @LineItemSeq = 0 begin select @NextLineItemSeq = 16384 end else begin select @NextLineItemSeq = @LineItemSeq + 16384 end  exec SVC_Obj_GetLineSite @CallNumber, @location_code output  select @uom = UOMSCHDL from IV00101 where ITEMNMBR = @item_number  SET @baseUofM = isnull((SELECT BASEUOFM FROM IV40201 WHERE UOMSCHDL = @uom), @uom) SET @sellUofM = isnull((SELECT SELNGUOM FROM IV00101 WHERE ITEMNMBR = @item_number AND UOMSCHDL = @uom), '')  if @sellUofM <> ''  SET @uom = @sellUofM else if @sellUofM = '' AND @baseUofM <> ''  SET @uom = @baseUofM  select @ext_cost = @COSTAMNT * @QUANTITY select @ext_cost = round(@ext_cost ,2)  select @ext_price = @Price *  (@miscpercent/100) select @ext_price = @ext_price * @QUANTITY; select @ext_price = round(@ext_price ,2)  select @I_sRateCalcMethod = RATECALC,   @I_sViewMode = 3,            @I_nExchangeRate = XCHGRATE,   @I_nDenomExchangeRate = DENXRATE,   @I_sDecimalPlaces = DECPLACS,   @I_sMCTrxState = MCTRXSTT   from SVC00200 where CALLNBR = @CallNumber   exec SVC_Convert_Amount @I_sRateCalcMethod, @I_sViewMode,@I_nExchangeRate,  @I_nDenomExchangeRate,@I_sMCTrxState,@I_sDecimalPlaces,  @COSTAMNT,@OrigCost OUTPUT, @O_iErrorState OUTPUT  exec SVC_Convert_Amount @I_sRateCalcMethod, @I_sViewMode,@I_nExchangeRate,  @I_nDenomExchangeRate,@I_sMCTrxState,@I_sDecimalPlaces,  @Price,@OrigPrice OUTPUT, @O_iErrorState OUTPUT  exec SVC_Convert_Amount @I_sRateCalcMethod, @I_sViewMode,@I_nExchangeRate,  @I_nDenomExchangeRate,@I_sMCTrxState,@I_sDecimalPlaces,  @ext_cost,@Origext_cost OUTPUT, @O_iErrorState OUTPUT  exec SVC_Convert_Amount @I_sRateCalcMethod, @I_sViewMode,@I_nExchangeRate,  @I_nDenomExchangeRate,@I_sMCTrxState,@I_sDecimalPlaces,  @ext_price,@Origext_price OUTPUT, @O_iErrorState OUTPUT  INSERT SVC00203 select @ServiceRecType, @CallNumber, 1, @NextLineItemSeq, @LineItemType, @SRVSTAT, isnull(@techid,''), isnull(@item_number,''), 'S', isnull(@item_description,''), isnull(@location_code,''), isnull(@uom,''), 0, 0, 0, isnull(@QUANTITY,1), isnull(@COSTAMNT,0), isnull(@Price,0), isnull(@ext_cost,0), isnull(@ext_price,0), 0, '', '', '', '', '', '', '', 0, 0, '', 0, 0, 0, isnull(@miscpercent,0), '', '', 0, 0, '', 0, 0, 0, 0, isnull(@price_level,''), 0, '', 0, '', isnull(@OrigCost,0), isnull(@OrigPrice,0), isnull(@Origext_cost,0), isnull(@Origext_price,0), 0,0,'', 0,'',0,0  End fetch next from LineCheck into @CBADDNL,@CBEXP,@DLRORPCT,@Price,@item_number,@item_description,@QUANTITY,@COSTAMNT END close LineCheck DEALLOCATE LineCheck   
GO
GRANT EXECUTE ON  [dbo].[SVC_Obj_CreateServiceLineAddons] TO [DYNGRP]
GO
