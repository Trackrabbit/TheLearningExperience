SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
 CREATE  PROCEDURE [dbo].[aagGenericGLOpen] @USERID CHAR(15), @TBName varchar(25), @Preview SMALLINT, @O_SQL_Error_State int = NULL  output AS  BEGIN  Declare @cDBName char(5),  @l_nStatus int,  @l_cPROFIT_AND_LOSS varchar(255),  @l_cBalSheet varchar(255),  @l_ctPROFIT_AND_LOSS varchar(255),  @l_ctBalSheet varchar(255),  @O_nSQL_Error_State int,  @l_nError int   set nocount on   select @cDBName = DB_NAME()  exec    @l_nStatus = DYNAMICS.dbo.smGetMsgString 12125, @cDBName, @l_cPROFIT_AND_LOSS output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)   exec    @l_nStatus = DYNAMICS.dbo.smGetMsgString 12030, @cDBName, @l_cBalSheet output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)   set @l_ctBalSheet = replace(@l_cBalSheet,'''','''''')  set @l_ctPROFIT_AND_LOSS = replace(@l_cPROFIT_AND_LOSS,'''','''''')   DECLARE @JRNENTRY bigint, @SEQNUMBR INT,  @OPENYEAR SMALLINT,   @RCTRXSEQ numeric(19,5),   @TRXSORCE char(13),   @CRDTAMNT numeric(19,5),   @DEBITAMT numeric(19,5),  @TRXDATE datetime,  @CURNCYID CHAR(16),  @CURRNIDX SMALLINT,   @Ledger_ID INT,   @ACTINDX INT,  @SEQ1 INT   DECLARE C1 CURSOR FAST_FORWARD FOR (SELECT JRNENTRY, SEQNUMBR , OPENYEAR, RCTRXSEQ, TRXSORCE, CRDTAMNT, DEBITAMT,  TRXDATE,CURNCYID,CURRNIDX, Ledger_ID, ACTINDX , RANK() OVER (PARTITION BY JRNENTRY,OPENYEAR,RCTRXSEQ,TRXSORCE ORDER BY SEQNUMBR ASC)FROM GL20000   WHERE SOURCDOC NOT IN (@l_ctBalSheet , @l_ctPROFIT_AND_LOSS))  OPEN C1  FETCH NEXT FROM C1 INTO @JRNENTRY, @SEQNUMBR,@OPENYEAR, @RCTRXSEQ, @TRXSORCE, @CRDTAMNT, @DEBITAMT,  @TRXDATE,@CURNCYID,@CURRNIDX, @Ledger_ID, @ACTINDX,@SEQ1  while @@fetch_status = 0  Begin  update AAG30001 set AA_CL_Status = 1   FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID = A.aaGLHdrID  WHERE A.JRNENTRY = @JRNENTRY AND A.RCTRXSEQ = @RCTRXSEQ   AND A.YEAR1 = @OPENYEAR AND A.aaGLTRXSource = @TRXSORCE AND   A1.ACTINDX = @ACTINDX AND A1.CRDTAMNT  = @CRDTAMNT AND A1.DEBITAMT = @DEBITAMT   AND A.GLPOSTDT = @TRXDATE AND A1.CURNCYID = @CURNCYID AND A1.CURRNIDX = @CURRNIDX AND A.Ledger_ID = @Ledger_ID  AND A1.SEQNUMBR=@SEQNUMBR AND A1.aaGLDistID = @SEQ1   FETCH NEXT FROM C1 INTO @JRNENTRY, @SEQNUMBR,@OPENYEAR, @RCTRXSEQ, @TRXSORCE, @CRDTAMNT, @DEBITAMT,  @TRXDATE,@CURNCYID,@CURRNIDX, @Ledger_ID, @ACTINDX,@SEQ1  END   close C1  deallocate C1  UPDATE AAG30001 SET AA_CL_Status = 1 WHERE SOURCDOC IN (@l_ctBalSheet , @l_ctPROFIT_AND_LOSS)   EXEC ('UPDATE '+@TBName+' SET JRNENTRY=-9999 WHERE JRNENTRY=0')  IF @Preview = 1   BEGIN  EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Distribution Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30001.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30001.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30001.aaGLHdrID)) ),-9999)  FROM AAG30001 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30000 WHERE AAG30000.aaGLHdrID=AAG30001.aaGLHdrID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30002.aaGLHdrID)) ),-9999)  FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30000 WHERE AAG30000.aaGLHdrID=AAG30002.aaGLHdrID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30000 WHERE AAG30000.aaGLHdrID=AAG30003.aaGLHdrID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30002.aaGLHdrID)) ),-9999)  FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30002.aaGLHdrID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30003.aaGLHdrID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30002 WHERE AAG30002.aaGLHdrID=AAG30003.aaGLHdrID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30002.aaGLHdrID)) ),-9999)  FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT AAG30000.aaGLHdrID FROM AAG30000 INNER JOIN AAG30001 ON AAG30000.aaGLHdrID=AAG30001.aaGLHdrID WHERE AAG30000.aaGLHdrID=AAG30002.aaGLHdrID AND AAG30001.aaGLDistID=AAG30002.aaGLDistID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30002.aaGLHdrID)) ),-9999)  FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30002.aaGLHdrID AND AAG30001.aaGLDistID=AAG30002.aaGLDistID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30003.aaGLHdrID AND AAG30001.aaGLDistID=AAG30003.aaGLDistID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30002 WHERE AAG30002.aaGLHdrID=AAG30003.aaGLHdrID AND AAG30002.aaGLDistID=AAG30003.aaGLDistID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30002 WHERE AAG30002.aaGLHdrID=AAG30003.aaGLHdrID AND AAG30002.aaGLDistID=AAG30003.aaGLDistID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Header Table'',''AA GL Open Header ID=''+LTRIM(STR(A.aaGLHdrID))+SPACE(3)+''Year=''+ LTRIM(STR(B.OPENYEAR)),12,1,LTRIM(STR(A.JRNENTRY))  FROM AAG30000 A INNER JOIN AAG30001 A1 ON A.aaGLHdrID=A1.aaGLHdrID INNER JOIN GL20000 B ON A.JRNENTRY = B.JRNENTRY AND A1.AA_CL_Status = 0 AND A.aaGLTRXSource = B.TRXSORCE  AND A.RCTRXSEQ=B.RCTRXSEQ AND A.YEAR1 <> B.OPENYEAR AND A1.CURNCYID = B.CURNCYID AND A1.CURRNIDX = B.CURRNIDX')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Header Table'',''AA GL Open Header ID=''+LTRIM(STR(A.aaGLHdrID))+SPACE(3)+''Posting Date=''+ CONVERT(CHAR(12),B.TRXDATE,102),17,1,LTRIM(STR(A.JRNENTRY))  FROM AAG30000 A INNER JOIN AAG30001 A1 ON A.aaGLHdrID=A1.aaGLHdrID INNER JOIN GL20000 B ON A.JRNENTRY = B.JRNENTRY AND A1.AA_CL_Status = 0 AND A.aaGLTRXSource = B.TRXSORCE  AND A.RCTRXSEQ=B.RCTRXSEQ AND A.YEAR1 = B.OPENYEAR AND A.GLPOSTDT <> B.TRXDATE AND A1.CURNCYID = B.CURNCYID AND A1.CURRNIDX = B.CURRNIDX')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Header Table'',''AA GL Open Header ID=''+LTRIM(STR(A.aaGLHdrID))+SPACE(3)+''Ledger ID=''+(SELECT Ledger_Name FROM GL40001 WHERE GL40001.Ledger_ID = B.Ledger_ID),11,1,LTRIM(STR(A.JRNENTRY))  FROM AAG30000 A INNER JOIN GL20000 B ON A.JRNENTRY=B.JRNENTRY AND A.RCTRXSEQ=B.RCTRXSEQ AND  A.aaGLTRXSource=B.TRXSORCE AND A.YEAR1=B.OPENYEAR AND A.Ledger_ID <> B.Ledger_ID INNER JOIN AAG30001 A1 ON A.aaGLHdrID=A1.aaGLHdrID AND A1.AA_CL_Status = 0 AND A.GLPOSTDT = B.TRXDATE AND A1.CURNCYID = B.CURNCYID AND A1.CURRNIDX = B.CURRNIDX')  EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Header Table'',''AA GL Open Header ID=''+LTRIM(STR(AA.aaGLHdrID))+SPACE(3)+''Transaction Source=''+GL.TRXSORCE,19,1,LTRIM(STR(AA.JRNENTRY))   FROM AAG30000 AA  JOIN (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR FROM GL20000 GROUP BY JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR) AS  GL   ON AA.JRNENTRY = GL.JRNENTRY AND AA.RCTRXSEQ =GL.RCTRXSEQ AND OPENYEAR = YEAR1 AND AA.aaGLTRXSource <> GL.TRXSORCE ')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Distribution Table'',''AA GL Open Header ID=''+LTRIM(STR(A.aaGLHdrID))+SPACE(1)+''Currency ID=''+ RTRIM(CONVERT(CHAR(12),B.CURNCYID))+ '' Currency Index='' + LTRIM(RTRIM(STR(B.CURRNIDX))),21,1,LTRIM(STR(A.JRNENTRY))   FROM AAG30000 A INNER JOIN GL20000 B ON A.JRNENTRY=B.JRNENTRY AND A.RCTRXSEQ=B.RCTRXSEQ AND A.aaGLTRXSource=B.TRXSORCE AND A.YEAR1=B.OPENYEAR  AND A.Ledger_ID = B.Ledger_ID   INNER JOIN AAG30001 A1 ON A.aaGLHdrID = A1.aaGLHdrID AND A1.AA_CL_Status = 0 AND A1.SEQNUMBR = B.SEQNUMBR AND A.GLPOSTDT = B.TRXDATE AND (A1.CURNCYID <> B.CURNCYID OR A1.CURRNIDX <> B.CURRNIDX)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Distribution Table'',''AA GL Open Header ID=''+LTRIM(STR(A.aaGLHdrID)),1,1,LTRIM(STR(A.JRNENTRY))  FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID = A.aaGLHdrID AND A1.AA_CL_Status = 0 and ltrim(rtrim(SOURCDOC)) = ''''  LEFT OUTER JOIN (SELECT DISTINCT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR, TRXDATE, CURNCYID, CURRNIDX FROM GL20000  where SOURCDOC <> '''+ @l_ctBalSheet +   ''' and SOURCDOC <> '''+ @l_ctPROFIT_AND_LOSS + ''' ) B ON A.JRNENTRY=B.JRNENTRY AND   A.RCTRXSEQ=B.RCTRXSEQ AND  A.aaGLTRXSource=B.TRXSORCE AND  A.GLPOSTDT = B.TRXDATE AND  A1.CURNCYID = B.CURNCYID AND  A1.CURRNIDX = B.CURRNIDX  WHERE B.JRNENTRY IS NULL')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID +  ''''+',''AA GL Open Header Table'',''AA GL Open Header ID=''+LTRIM(STR(A.aaGLHdrID)),1,1,LTRIM(STR(A.JRNENTRY))  FROM AAG30000 A LEFT OUTER JOIN GL20000 B ON A.JRNENTRY=B.JRNENTRY AND   A.RCTRXSEQ=B.RCTRXSEQ AND  A.aaGLTRXSource=B.TRXSORCE   LEFT OUTER JOIN AAG30001 A1 ON A.aaGLHdrID = A1.aaGLHdrID AND A1.AA_CL_Status = 0 AND  A.GLPOSTDT = B.TRXDATE AND  A1.CURNCYID = B.CURNCYID AND  A1.CURRNIDX = B.CURRNIDX  WHERE B.JRNENTRY IS NULL ')  EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Header Table'',''AA GL Open Header ID=''+LTRIM(STR(A.aaGLHdrID)),1,1,LTRIM(STR(A.JRNENTRY))  FROM AAG30000 A LEFT OUTER JOIN (SELECT DISTINCT JRNENTRY,OPENYEAR YEAR1,TRXSORCE,RCTRXSEQ FROM GL20000 UNION ALL SELECT JRNENTRY, HSTYEAR YEAR1, TRXSORCE, RCTRXSEQ FROM GL30000) B ON A.JRNENTRY=B.JRNENTRY AND A.YEAR1=B.YEAR1 AND A.aaGLTRXSource = B.TRXSORCE  AND A.RCTRXSEQ=B.RCTRXSEQ  LEFT OUTER JOIN AAG30001 A1 ON A.aaGLHdrID = A1.aaGLHdrID and A1.AA_CL_Status = 0 WHERE B.JRNENTRY IS NULL')   END  ELSE  BEGIN   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Distribution Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30001.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30001.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30001.aaGLHdrID)) ),-9999)  FROM AAG30001 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30000 WHERE AAG30000.aaGLHdrID=AAG30001.aaGLHdrID)')   DELETE AAG30001 FROM AAG30001 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30000 WHERE AAG30000.aaGLHdrID=AAG30001.aaGLHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30002.aaGLHdrID)) ),-9999)  FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30000 WHERE AAG30000.aaGLHdrID=AAG30002.aaGLHdrID)')   DELETE AAG30002 FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30000 WHERE AAG30000.aaGLHdrID=AAG30002.aaGLHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30000 WHERE AAG30000.aaGLHdrID=AAG30003.aaGLHdrID)')   DELETE AAG30003 FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30000 WHERE AAG30000.aaGLHdrID=AAG30003.aaGLHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30002.aaGLHdrID)) ),-9999)  FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30002.aaGLHdrID)')   DELETE AAG30002 FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30002.aaGLHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30003.aaGLHdrID)')   DELETE AAG30003 FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30003.aaGLHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30002 WHERE AAG30002.aaGLHdrID=AAG30003.aaGLHdrID)')   DELETE AAG30003 FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30002 WHERE AAG30002.aaGLHdrID=AAG30003.aaGLHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30002.aaGLHdrID)) ),-9999)  FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT AAG30000.aaGLHdrID FROM AAG30000 INNER JOIN AAG30001 ON AAG30000.aaGLHdrID=AAG30001.aaGLHdrID AND AAG30000.aaGLHdrID=AAG30002.aaGLHdrID AND AAG30001.aaGLDistID=AAG30002.aaGLDistID)')   DELETE AAG30002 FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT AAG30000.aaGLHdrID FROM AAG30000 INNER JOIN AAG30001 ON AAG30000.aaGLHdrID=AAG30001.aaGLHdrID AND AAG30000.aaGLHdrID=AAG30002.aaGLHdrID AND AAG30001.aaGLDistID=AAG30002.aaGLDistID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30002.aaGLHdrID)) ),-9999)  FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30002.aaGLHdrID AND AAG30001.aaGLDistID=AAG30002.aaGLDistID)')   DELETE AAG30002 FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30002.aaGLHdrID AND AAG30001.aaGLDistID=AAG30002.aaGLDistID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30003.aaGLHdrID AND AAG30001.aaGLDistID=AAG30003.aaGLDistID)')   DELETE AAG30003 FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30003.aaGLHdrID AND AAG30001.aaGLDistID=AAG30003.aaGLDistID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30002 WHERE AAG30002.aaGLHdrID=AAG30003.aaGLHdrID AND AAG30002.aaGLDistID=AAG30003.aaGLDistID)')   DELETE AAG30003 FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30002 WHERE AAG30002.aaGLHdrID=AAG30003.aaGLHdrID AND AAG30002.aaGLDistID=AAG30003.aaGLDistID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30002 WHERE AAG30002.aaGLHdrID=AAG30003.aaGLHdrID AND AAG30002.aaGLDistID=AAG30003.aaGLDistID)')   DELETE AAG30003 FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30002 WHERE AAG30002.aaGLHdrID=AAG30003.aaGLHdrID AND AAG30002.aaGLDistID=AAG30003.aaGLDistID AND AAG30002.aaGLAssignID=AAG30003.aaGLAssignID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Header Table'',''AA GL Open Header ID=''+LTRIM(STR(A.aaGLHdrID))+SPACE(3)+''Year=''+ LTRIM(STR(B.OPENYEAR)),13,1,LTRIM(STR(A.JRNENTRY))  FROM AAG30000 A INNER JOIN AAG30001 A1 ON A.aaGLHdrID=A1.aaGLHdrID INNER JOIN GL20000 B ON A.JRNENTRY = B.JRNENTRY AND A1.AA_CL_Status = 0 AND A.aaGLTRXSource = B.TRXSORCE  AND A.RCTRXSEQ=B.RCTRXSEQ AND A.YEAR1 <> B.OPENYEAR AND A1.CURNCYID = B.CURNCYID AND A1.CURRNIDX = B.CURRNIDX')   UPDATE AAG30000 SET AAG30000.YEAR1 = B.OPENYEAR FROM AAG30000 A INNER JOIN AAG30001 A1 ON A.aaGLHdrID=A1.aaGLHdrID INNER JOIN GL20000 B ON A.JRNENTRY = B.JRNENTRY AND A.aaGLTRXSource = B.TRXSORCE  AND A.RCTRXSEQ=B.RCTRXSEQ AND A.YEAR1 <> B.OPENYEAR AND A1.CURNCYID = B.CURNCYID AND A1.CURRNIDX = B.CURRNIDX   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Header Table'',''AA GL Open Header ID=''+LTRIM(STR(A.aaGLHdrID))+SPACE(3)+''Posting Date=''+ convert(char(12),B.TRXDATE,102),16,1,LTRIM(STR(A.JRNENTRY))  FROM AAG30000 A INNER JOIN AAG30001 A1 ON A.aaGLHdrID=A1.aaGLHdrID INNER JOIN GL20000 B ON A.JRNENTRY = B.JRNENTRY AND A1.AA_CL_Status = 0 AND A.aaGLTRXSource = B.TRXSORCE  AND A.RCTRXSEQ=B.RCTRXSEQ AND A.YEAR1 = B.OPENYEAR AND A.GLPOSTDT <> B.TRXDATE AND A1.CURNCYID = B.CURNCYID AND A1.CURRNIDX = B.CURRNIDX')   UPDATE AAG30000 SET AAG30000.GLPOSTDT = B.TRXDATE FROM AAG30000 A INNER JOIN AAG30001 A1 ON A.aaGLHdrID=A1.aaGLHdrID INNER JOIN GL20000 B ON A.JRNENTRY = B.JRNENTRY AND A.aaGLTRXSource = B.TRXSORCE  AND A.RCTRXSEQ=B.RCTRXSEQ AND A.YEAR1 = B.OPENYEAR AND A.GLPOSTDT <> B.TRXDATE AND A1.CURNCYID = B.CURNCYID AND A1.CURRNIDX = B.CURRNIDX   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Header Table'',''AA GL Open Header ID=''+LTRIM(STR(A.aaGLHdrID))+SPACE(3)+''Ledger ID=''+(SELECT Ledger_Name FROM GL40001 WHERE GL40001.Ledger_ID = B.Ledger_ID),8,1,LTRIM(STR(A.JRNENTRY))   FROM AAG30000 A INNER JOIN GL20000 B ON A.JRNENTRY=B.JRNENTRY AND A.RCTRXSEQ=B.RCTRXSEQ AND  A.aaGLTRXSource=B.TRXSORCE AND A.YEAR1=B.OPENYEAR AND A.Ledger_ID <> B.Ledger_ID INNER JOIN AAG30001 A1 ON A.aaGLHdrID=A1.aaGLHdrID AND A1.AA_CL_Status = 0 AND A.GLPOSTDT = B.TRXDATE AND A1.CURNCYID = B.CURNCYID AND A1.CURRNIDX = B.CURRNIDX')   UPDATE AAG30000 set AAG30000.Ledger_ID = B.Ledger_ID  FROM AAG30000 A INNER JOIN GL20000 B ON A.JRNENTRY=B.JRNENTRY AND A.RCTRXSEQ=B.RCTRXSEQ AND  A.aaGLTRXSource=B.TRXSORCE AND A.YEAR1=B.OPENYEAR  AND A.Ledger_ID<>B.Ledger_ID INNER JOIN AAG30001 A1 ON A.aaGLHdrID = A1.aaGLHdrID AND A1.AA_CL_Status = 0 AND A.GLPOSTDT = B.TRXDATE AND A1.CURNCYID = B.CURNCYID AND A1.CURRNIDX = B.CURRNIDX   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Header Table'',''AA GL Open Header ID=''+LTRIM(STR(AA.aaGLHdrID))+SPACE(3)+''Transaction Source=''+GL.TRXSORCE,18,1,LTRIM(STR(AA.JRNENTRY))   FROM AAG30000 AA  JOIN (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR FROM GL20000 GROUP BY JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR) AS  GL   ON AA.JRNENTRY = GL.JRNENTRY AND AA.RCTRXSEQ =GL.RCTRXSEQ AND OPENYEAR = YEAR1 AND AA.aaGLTRXSource <> GL.TRXSORCE ')  UPDATE AAG30000 SET aaGLTRXSource = GL.TRXSORCE   FROM AAG30000 AA  JOIN (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR FROM GL20000 GROUP BY JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR) AS  GL   ON AA.JRNENTRY = GL.JRNENTRY AND AA.RCTRXSEQ =GL.RCTRXSEQ AND OPENYEAR = YEAR1 AND AA.aaGLTRXSource <> GL.TRXSORCE    EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Distribution Table'',''AA GL Open Header ID=''+LTRIM(STR(A.aaGLHdrID))+SPACE(1)+''Currency ID=''+ RTRIM(CONVERT(CHAR(12),B.CURNCYID))+ '' Currency Index='' + LTRIM(RTRIM(STR(B.CURRNIDX))),20,1,LTRIM(STR(A.JRNENTRY))   FROM AAG30000 A INNER JOIN GL20000 B ON A.JRNENTRY=B.JRNENTRY AND A.RCTRXSEQ=B.RCTRXSEQ AND A.aaGLTRXSource=B.TRXSORCE AND A.YEAR1=B.OPENYEAR  AND A.Ledger_ID = B.Ledger_ID   INNER JOIN AAG30001 A1 ON A.aaGLHdrID = A1.aaGLHdrID AND A1.AA_CL_Status = 0 AND A1.SEQNUMBR = B.SEQNUMBR AND A.GLPOSTDT = B.TRXDATE AND (A1.CURNCYID <> B.CURNCYID OR A1.CURRNIDX <> B.CURRNIDX)')   UPDATE AAG30001 set AAG30001.CURNCYID = B.CURNCYID, AAG30001.CURRNIDX = B.CURRNIDX  FROM AAG30000 A INNER JOIN GL20000 B ON A.JRNENTRY=B.JRNENTRY AND A.RCTRXSEQ=B.RCTRXSEQ AND A.aaGLTRXSource=B.TRXSORCE AND A.YEAR1=B.OPENYEAR  AND A.Ledger_ID = B.Ledger_ID   INNER JOIN AAG30001 A1 ON A.aaGLHdrID = A1.aaGLHdrID AND A1.AA_CL_Status = 0 AND A1.SEQNUMBR = B.SEQNUMBR AND A.GLPOSTDT = B.TRXDATE AND (A1.CURNCYID <> B.CURNCYID OR A1.CURRNIDX <> B.CURRNIDX)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Distribution Table'',''AA GL Open Header ID=''+LTRIM(STR(A.aaGLHdrID)),1,1,LTRIM(STR(A.JRNENTRY))  FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID = A.aaGLHdrID AND A1.AA_CL_Status = 0 and ltrim(rtrim(SOURCDOC)) = ''''  LEFT OUTER JOIN (SELECT DISTINCT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX FROM GL20000  where SOURCDOC <> '''+ @l_ctBalSheet +   ''' and SOURCDOC <> '''+ @l_ctPROFIT_AND_LOSS + ''' UNION ALL SELECT DISTINCT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX FROM GL30000  where SOURCDOC <> '''+ @l_ctBalSheet +   ''' and SOURCDOC <> '''+ @l_ctPROFIT_AND_LOSS + ''') B ON A.JRNENTRY=B.JRNENTRY AND   A.RCTRXSEQ=B.RCTRXSEQ AND  A.aaGLTRXSource=B.TRXSORCE AND  A.YEAR1=B.YEAR1 AND  A.GLPOSTDT = B.TRXDATE AND  A1.CURNCYID = B.CURNCYID AND  A1.CURRNIDX = B.CURRNIDX  WHERE B.JRNENTRY IS NULL')   DELETE AAG30001 FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID = A.aaGLHdrID AND A1.AA_CL_Status = 0 and ltrim(rtrim(SOURCDOC)) = ''  LEFT OUTER JOIN (SELECT DISTINCT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX FROM GL20000  where SOURCDOC <> @l_cBalSheet   and SOURCDOC <> @l_cPROFIT_AND_LOSS UNION ALL SELECT DISTINCT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX FROM GL30000  where SOURCDOC <> @l_cBalSheet   and SOURCDOC <> @l_cPROFIT_AND_LOSS) B ON A.JRNENTRY=B.JRNENTRY AND   A.RCTRXSEQ=B.RCTRXSEQ AND  A.aaGLTRXSource=B.TRXSORCE AND  A.YEAR1=B.YEAR1 AND  A.GLPOSTDT = B.TRXDATE AND  A1.CURNCYID = B.CURNCYID AND  A1.CURRNIDX = B.CURRNIDX  WHERE B.JRNENTRY IS NULL  EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Header Table'',''AA GL Open Header ID=''+LTRIM(STR(A.aaGLHdrID)),1,1,LTRIM(STR(A.JRNENTRY))  FROM AAG30000 A LEFT OUTER JOIN (SELECT DISTINCT JRNENTRY,OPENYEAR YEAR1,TRXSORCE,RCTRXSEQ FROM GL20000 UNION ALL SELECT JRNENTRY, HSTYEAR YEAR1, TRXSORCE, RCTRXSEQ FROM GL30000) B ON A.JRNENTRY=B.JRNENTRY AND A.YEAR1=B.YEAR1 AND A.aaGLTRXSource = B.TRXSORCE  AND A.RCTRXSEQ=B.RCTRXSEQ  LEFT OUTER JOIN AAG30001 A1 ON A.aaGLHdrID = A1.aaGLHdrID and A1.AA_CL_Status = 0 WHERE B.JRNENTRY IS NULL')   DELETE AAG30000 FROM AAG30000 A LEFT OUTER JOIN (SELECT DISTINCT JRNENTRY,OPENYEAR YEAR1,TRXSORCE,RCTRXSEQ FROM GL20000 UNION ALL SELECT JRNENTRY, HSTYEAR YEAR1, TRXSORCE, RCTRXSEQ FROM GL30000) B ON A.JRNENTRY=B.JRNENTRY AND A.YEAR1=B.YEAR1 AND A.aaGLTRXSource = B.TRXSORCE  AND A.RCTRXSEQ=B.RCTRXSEQ  LEFT OUTER JOIN AAG30001 A1 ON A.aaGLHdrID = A1.aaGLHdrID and A1.AA_CL_Status = 0 WHERE B.JRNENTRY IS NULL   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID +  ''''+',''AA GL Open Header Table'',''AA GL Open Header ID=''+LTRIM(STR(A.aaGLHdrID)),1,1,LTRIM(STR(A.JRNENTRY))  FROM AAG30000 A LEFT OUTER JOIN (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX  FROM GL20000 UNION ALL SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX  FROM GL30000) B ON A.JRNENTRY=B.JRNENTRY AND   A.RCTRXSEQ=B.RCTRXSEQ AND  A.aaGLTRXSource=B.TRXSORCE AND  A.YEAR1=B.YEAR1   LEFT OUTER JOIN AAG30001 A1 ON A.aaGLHdrID = A1.aaGLHdrID AND A1.AA_CL_Status = 0 AND  A.GLPOSTDT = B.TRXDATE AND  A1.CURNCYID = B.CURNCYID AND  A1.CURRNIDX = B.CURRNIDX  WHERE B.JRNENTRY IS NULL')   DELETE AAG30000 FROM AAG30000 A LEFT OUTER JOIN (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX  FROM GL20000 UNION ALL SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX  FROM GL30000)   B ON A.JRNENTRY=B.JRNENTRY AND   A.RCTRXSEQ=B.RCTRXSEQ AND  A.aaGLTRXSource=B.TRXSORCE AND  A.YEAR1=B.YEAR1   LEFT OUTER JOIN AAG30001 A1 ON A.aaGLHdrID = A1.aaGLHdrID AND A1.AA_CL_Status = 0 AND  A.GLPOSTDT = B.TRXDATE AND  A1.CURNCYID = B.CURNCYID AND  A1.CURRNIDX = B.CURRNIDX  WHERE B.JRNENTRY IS NULL  END  SET NOCOUNT OFF END   
GO
GRANT EXECUTE ON  [dbo].[aagGenericGLOpen] TO [DYNGRP]
GO
