SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[smCreateOriginRecords]  @I_cOrigin char(50) = NULL,  @I_sSeries smallint = NULL,  @I_iSQLSessionID int = NULL,  @O_iErrorState int = NULL output as  declare  @sTempYear smallint,   @iNumberOfPeriods int,   @tTransaction tinyint,   @iCount int,   @TRUE int,    @FALSE int,   @iError int,    @iRowCount int,  @iStatus int    if @I_cOrigin is NULL or  @I_sSeries is NULL or  @I_iSQLSessionID is NULL begin  select @O_iErrorState = 20442  return end  if @I_sSeries < 2 or @I_sSeries > 7   begin  select @O_iErrorState = 20553  return end  select   @O_iErrorState = 0,  @iCount = 1,  @TRUE = 1,  @FALSE = 0  if @@trancount = 0 begin  select @tTransaction = 1  begin transaction end  select  @sTempYear = min(YEAR1) from  SY40101  while @sTempYear is not NULL begin   select  @iNumberOfPeriods = NUMOFPER  from  SY40101  where  YEAR1 = @sTempYear   while @iCount  <= @iNumberOfPeriods  begin  if not exists(select  1  from  SY40100  where  FORIGIN = @FALSE  and YEAR1 = @sTempYear  and PERIODID = @iCount  and SERIES = @I_sSeries  and ODESCTN = @I_cOrigin)  begin  insert into   SY40100(  FORIGIN,  YEAR1,  PERIODID,  SERIES,  ODESCTN,  CLOSED,  PERIODDT,  PERNAME,   PSERIES_1,    PSERIES_2,  PSERIES_3,  PSERIES_4,  PSERIES_5,  PSERIES_6,  PERDENDT)  select  @FALSE,  @sTempYear,  @iCount,  @I_sSeries,  @I_cOrigin,  CASE  WHEN @I_sSeries = 2 then PSERIES_1  WHEN @I_sSeries = 3 then PSERIES_2  WHEN @I_sSeries = 4 then PSERIES_3  WHEN @I_sSeries = 5 then PSERIES_4  WHEN @I_sSeries = 6 then PSERIES_5  WHEN @I_sSeries = 7 then PSERIES_6   END,  PERIODDT,  PERNAME,  PSERIES_1,  PSERIES_2,  PSERIES_3,  PSERIES_4,  PSERIES_5,  PSERIES_6,  PERDENDT  from  SY40100  where  FORIGIN = @TRUE  and YEAR1 = @sTempYear  and PERIODID = @iCount  and SERIES = 0   select @iRowCount = @@rowcount  if @iRowCount > 1   begin  if @tTransaction = 1  rollback transaction  select @O_iErrorState = 20443  return  end  if @iRowCount = 0  begin   insert into SY40100(  FORIGIN,  YEAR1,  PERIODID,  SERIES,  ODESCTN,  CLOSED)  values (  @FALSE,  @sTempYear,  @iCount,  @I_sSeries,  @I_cOrigin,  0)  END  end   select @iCount = @iCount + 1   end    select @iCount = 1  select  @sTempYear = min(YEAR1)  from  SY40101  where  YEAR1 > @sTempYear  end  if @tTransaction = 1  commit transaction  return    
GO
GRANT EXECUTE ON  [dbo].[smCreateOriginRecords] TO [DYNGRP]
GO
