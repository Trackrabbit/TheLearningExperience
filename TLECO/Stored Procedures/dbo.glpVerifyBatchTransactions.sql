SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[glpVerifyBatchTransactions]  @I_cBatchSource char(15) = NULL,  @I_cBatchNumber char(15) = NULL,  @I_sTransactionType smallint = NULL,  @IO_bBatchMessages1 binary(4) = NULL output,  @O_iErrorState int   = NULL  output as  declare   @TRUE            tinyint,  @FALSE           tinyint,  @POSTED smallint,  @POSTED_WITH_ERROR smallint,  @RECURRING_POSTED smallint,  @NORMAL_TRX smallint,  @CLEARING_TRX smallint,  @BUDGET_TRX smallint,  @BUSINESS_FORM smallint,  @MS_ITEM_8 int,  @tLoop tinyint,  @tTransaction tinyint,  @iTranCount int,  @iPostedCount int  select @O_iErrorState = 0  if @@trancount = 0 begin  select @tTransaction = 1  begin transaction end   while (@tLoop is NULL) begin  select @tLoop = 1   if  @I_cBatchSource  is NULL or  @I_cBatchNumber  is NULL or  @I_sTransactionType  is NULL or  @IO_bBatchMessages1 is NULL  begin  select @O_iErrorState = 20802  break  end   select  @TRUE            = 1,  @FALSE           = 0,  @POSTED    = 2,  @POSTED_WITH_ERROR = 3,  @RECURRING_POSTED = 4,  @NORMAL_TRX   = 1,  @CLEARING_TRX  = 2,  @BUDGET_TRX   = 4,    @BUSINESS_FORM  = 5,  @MS_ITEM_8  = convert(int, 0x80000000),   @iTranCount   = 0,  @iPostedCount   = 0   if @I_sTransactionType <> @NORMAL_TRX and   @I_sTransactionType <> @CLEARING_TRX and  @I_sTransactionType <> @BUDGET_TRX and  @I_sTransactionType <> @BUSINESS_FORM  begin  select @O_iErrorState = 20803  break  end    if @I_sTransactionType = @NORMAL_TRX or  @I_sTransactionType = @CLEARING_TRX  begin   select   @iTranCount = count(JRNENTRY)  from  GL10000 with (NOLOCK)  where  BCHSOURC = @I_cBatchSource   and     BACHNUMB = @I_cBatchNumber   if @iTranCount > 0  begin  select   @iPostedCount = count(PSTGSTUS)  from  GL10000 with (NOLOCK)  where  BCHSOURC = @I_cBatchSource   and     BACHNUMB = @I_cBatchNumber  and     (PSTGSTUS = @POSTED  or PSTGSTUS = @RECURRING_POSTED  or PSTGSTUS = @POSTED_WITH_ERROR)   if @iTranCount <> @iPostedCount  select   @O_iErrorState  = 20911,  @IO_bBatchMessages1 = @IO_bBatchMessages1 | @MS_ITEM_8  end  else  begin  select   @O_iErrorState  = -20504,  @IO_bBatchMessages1 = @IO_bBatchMessages1 | @MS_ITEM_8  end  end    else if @I_sTransactionType = @BUDGET_TRX  begin  select   @iTranCount = count(JRNENTRY)  from  GL12000 with (NOLOCK)  where  BACHNUMB  = @I_cBatchNumber   if @iTranCount > 0  begin  select   @iPostedCount = count(PSTGSTUS)  from  GL12000 with (NOLOCK)  where  BACHNUMB  = @I_cBatchNumber  and     (PSTGSTUS = @POSTED  or PSTGSTUS = @POSTED_WITH_ERROR)   if @iTranCount <> @iPostedCount  begin  select   @O_iErrorState  = 20911,  @IO_bBatchMessages1 = @IO_bBatchMessages1 | @MS_ITEM_8  end  end   end   else if @I_sTransactionType = @BUSINESS_FORM  begin  select   @iTranCount = count(JRNENTRY)  from  GL10100 with (NOLOCK)  where  BSNSFMID  = @I_cBatchNumber   if @iTranCount > 0  begin  select   @iPostedCount = count(PSTGSTUS)  from  GL10100 with (NOLOCK)  where  BSNSFMID  = @I_cBatchNumber  and     (PSTGSTUS = @POSTED  or PSTGSTUS = @POSTED_WITH_ERROR)   if @iTranCount <> @iPostedCount  begin  select   @O_iErrorState  = 20911,  @IO_bBatchMessages1 = @IO_bBatchMessages1 | @MS_ITEM_8  end  end  else  begin  select   @O_iErrorState  = -20504,  @IO_bBatchMessages1 = @IO_bBatchMessages1 | @MS_ITEM_8   end  end  end   if @O_iErrorState <> 0 begin  if @tTransaction = 1  rollback transaction  end else if @tTransaction = 1  commit transaction  return     
GO
GRANT EXECUTE ON  [dbo].[glpVerifyBatchTransactions] TO [DYNGRP]
GO
