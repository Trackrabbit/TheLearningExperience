SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[taPopRcptLotInsert]  @I_vPOPRCTNM  char(17),     @I_vITEMNMBR  char(30),    @I_vSERLTNUM  char(20),    @I_vSERLTQTY  numeric(19,5),   @I_vRCPTLNNM int,     @I_vBIN char(15) = '',    @I_vCREATEBIN tinyint = 0,   @I_vLOCNCODE char(10) = '',      @I_vEXPNDATE datetime = '',   @I_vMFGDATE datetime = '',    @I_vRequesterTrx smallint = 0,   @I_vUSRDEFND1  char(50) = '',   @I_vUSRDEFND2  char(50) = '',   @I_vUSRDEFND3  char(50) = '',   @I_vUSRDEFND4  varchar(8000) = '',  @I_vUSRDEFND5  varchar(8000) = '',  @O_iErrorState  int output, @oErrString  varchar(255) output  with encryption as  set transaction isolation level read uncommitted set nocount on  declare   @SLTSQNUM int,     @ITMTRKOP smallint,    @DTSEQNUM smallint,    @LOTTYPE char(10),    @ENABLEMULTIBIN tinyint,  @sCompanyID int,  @NOTEINDX numeric(19,5),  @iGetNextNoteIdxErrState int,  @iStatus int,  @iCustomState int,  @iCustomErrString varchar(255),  @O_oErrorState int,  @iError int     select  @SLTSQNUM = 0,  @ITMTRKOP = 0,  @DTSEQNUM = 0,  @LOTTYPE = 0,  @ENABLEMULTIBIN = 0,  @sCompanyID = 0,  @NOTEINDX = 0,  @iGetNextNoteIdxErrState = 0,  @iStatus = 0,  @O_iErrorState = 0    if (@oErrString is NULL) begin  select @oErrString = '' end  exec @iStatus = taPopRcptLotInsertPre  @I_vPOPRCTNM output,  @I_vITEMNMBR output,  @I_vSERLTNUM output,  @I_vSERLTQTY output,  @I_vRCPTLNNM output,  @I_vBIN output,  @I_vCREATEBIN output,  @I_vLOCNCODE output,  @I_vEXPNDATE output,  @I_vMFGDATE output,  @I_vRequesterTrx output,  @I_vUSRDEFND1 output,  @I_vUSRDEFND2 output,  @I_vUSRDEFND3 output,  @I_vUSRDEFND4 output,  @I_vUSRDEFND5 output,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if (@iStatus = 0 and @iError <> 0) begin  select @iStatus = @iError end if (@iStatus <> 0) or (@iCustomState <> 0) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  select @O_iErrorState = 1582    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if (  @I_vPOPRCTNM is NULL or  @I_vITEMNMBR is NULL or  @I_vSERLTNUM is NULL or  @I_vRCPTLNNM is NULL or  @I_vBIN is null or  @I_vCREATEBIN is null or  @I_vLOCNCODE is null or  @I_vUSRDEFND1 is NULL or  @I_vUSRDEFND2 is NULL or  @I_vUSRDEFND3 is NULL or  @I_vUSRDEFND4 is NULL or  @I_vUSRDEFND5 is NULL) begin  select @O_iErrorState = 1583    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if ( @I_vPOPRCTNM = '' or  @I_vITEMNMBR = '' or  @I_vSERLTNUM = '') begin  select @O_iErrorState = 1584    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  select @I_vITEMNMBR = UPPER(@I_vITEMNMBR),  @I_vSERLTNUM = UPPER(@I_vSERLTNUM),  @I_vBIN = upper(@I_vBIN),  @I_vLOCNCODE = upper(@I_vLOCNCODE)  select @ENABLEMULTIBIN = ENABLEMULTIBIN from IV40100 (nolock) where SETUPKEY = 1  if (@ENABLEMULTIBIN = 0) begin  if (@I_vCREATEBIN = 1)  begin  select @O_iErrorState = 9289     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end   if (@I_vBIN <> '')  begin  select @O_iErrorState = 9290     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end else begin   if (@I_vCREATEBIN not in (0,1))  begin  select @O_iErrorState = 9291     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end   if (@I_vLOCNCODE = '')  begin  select @O_iErrorState = 9292     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  else  begin  if not exists(select 1 from IV40700 (nolock) where LOCNCODE = @I_vLOCNCODE)  begin  select @O_iErrorState = 9293     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  end   if ((@I_vBIN = '') and (@I_vCREATEBIN = 1))  begin  select @O_iErrorState = 9294     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end   if ((@I_vBIN <> '') and not exists(select 1 from IV40701 (nolock) where LOCNCODE = @I_vLOCNCODE and BIN = @I_vBIN))  begin  if (@I_vCREATEBIN = 0)  begin  select @O_iErrorState = 9295     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  else   begin  select @sCompanyID = CMPANYID from DYNAMICS..SY01500 (nolock) where INTERID = db_name()   exec @iStatus = DYNAMICS..tasmGetNextNoteIndex  @I_sCompanyID   = @sCompanyID,  @I_iSQLSessionID = 0,  @I_noteincrement  = 1,  @O_mNoteIndex   = @NOTEINDX output,  @O_iErrorState  = @iGetNextNoteIdxErrState output  select @iError = @@error  if ((@iStatus <> 0) or (@iGetNextNoteIdxErrState <> 0) or (@iError <> 0))  begin  select @oErrString = rtrim(@oErrString) + ' ' + @iGetNextNoteIdxErrState  select @O_iErrorState = 9296    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end   insert IV40701 (LOCNCODE, BIN, NOTEINDX)  select @I_vLOCNCODE, @I_vBIN, @NOTEINDX  if (@@error <> 0)  begin  select @O_iErrorState = 9297    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  end  end   if (@I_vBIN = '')  begin  select @I_vBIN = PORECEIPTBIN from IV00102 (nolock) where ITEMNMBR = @I_vITEMNMBR and LOCNCODE = @I_vLOCNCODE  end   if (@I_vBIN = '')  begin  select @I_vBIN = PORECEIPTBIN from IV40700 (nolock) where LOCNCODE = @I_vLOCNCODE  end   if (@I_vBIN = '')  begin  select @O_iErrorState = 9298     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@O_iErrorState <> 0)  return (@O_iErrorState)  select @ITMTRKOP = ITMTRKOP,  @LOTTYPE = isnull(LOTTYPE,'')  from IV00101 (nolock) where ITEMNMBR = @I_vITEMNMBR  if (@ITMTRKOP <> 3) begin  select @O_iErrorState = 2092    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if (@I_vRequesterTrx=0) begin  exec @iStatus = eConnectOutVerify  @I_vDOCTYPE='PO_Receiving_Transaction',  @I_vINDEX1=@I_vPOPRCTNM,  @I_vINDEX2='',  @I_vINDEX3='',  @I_vINDEX4='',  @I_vINDEX5='',  @I_vINDEX6='',  @I_vINDEX7='',  @I_vINDEX8='',  @I_vINDEX9='',  @I_vINDEX10='',  @I_vINDEX11='',  @I_vINDEX12='',  @I_vINDEX13='',  @I_vINDEX14='',  @I_vINDEX15='',  @I_vDelete = 0,  @O_iErrorState = @iCustomState output  select @iError = @@error  if @iStatus = 0 and @iError <> 0  begin  select @iStatus = @iError  end  if (@iStatus <> 0) or (@iCustomState <> 0)  begin  select @O_iErrorState = 2773   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end  if (@LOTTYPE <> '') begin  if not exists(select 1 from IV00301 (nolock) where ITEMNMBR = @I_vITEMNMBR and LOTNUMBR = @I_vSERLTNUM)  begin  insert IV00301  (  ITEMNMBR,  LOTNUMBR,  LOTATRB1,  LOTATRB2,  LOTATRB3,  LOTATRB4,  LOTATRB5,  IUSCOUNT,  RCRDSTTS   )  select  @I_vITEMNMBR,   @I_vSERLTNUM,   '',      '',      '',      '',      '',      1,      0      if (@@error <> 0)  begin  select @O_iErrorState = 2627     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end  end  else  begin  update IV00301 set IUSCOUNT = IUSCOUNT + 1 where ITEMNMBR = @I_vITEMNMBR and LOTNUMBR = @I_vSERLTNUM  if (@@error <> 0)  begin  select @O_iErrorState = 9299     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end  end end  if (@ITMTRKOP = 3) begin  select @SLTSQNUM = isnull(max(SLTSQNUM),0) + 1 from POP10330 (nolock) where ITMTRKOP = 3 and POPRCTNM = @I_vPOPRCTNM and RCPTLNNM = @I_vRCPTLNNM and QTYTYPE = 1   if @I_vSERLTNUM = ''  begin  select @O_iErrorState = 829   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end   insert POP10330  (  ITMTRKOP,  POPRCTNM,  RCPTLNNM,  SLTSQNUM,  ITEMNMBR,  SERLTNUM,  SERLTQTY,  TRXSORCE,  DATERECD,  DTSEQNUM,  UNITCOST,  QTYTYPE,  BIN,  MFGDATE,  EXPNDATE  )  select  3,      @I_vPOPRCTNM,   @I_vRCPTLNNM,   @SLTSQNUM,    @I_vITEMNMBR,   @I_vSERLTNUM,   @I_vSERLTQTY,   '',      '',      0,      0,      1,      @I_vBIN,    @I_vMFGDATE,   @I_vEXPNDATE   if (@@error <> 0)  begin  select @O_iErrorState = 1003     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end  if (@O_iErrorState <> 0)  return (@O_iErrorState)  exec @iStatus = taPopRcptLotInsertPost  @I_vPOPRCTNM,  @I_vITEMNMBR,  @I_vSERLTNUM,  @I_vSERLTQTY,  @I_vRCPTLNNM,  @I_vBIN,  @I_vCREATEBIN,  @I_vLOCNCODE,  @I_vEXPNDATE,  @I_vMFGDATE,  @I_vRequesterTrx,  @I_vUSRDEFND1,  @I_vUSRDEFND2,  @I_vUSRDEFND3,  @I_vUSRDEFND4,  @I_vUSRDEFND5,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if @iStatus = 0 and @iError <> 0 begin  select @iStatus = @iError end if (@iStatus <> 0) or (@iCustomState <> 0) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  select @O_iErrorState = 1598    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if (@I_vRequesterTrx=0) begin  exec @iStatus = eConnectOutVerify  @I_vDOCTYPE='PO_Receiving_Transaction',  @I_vINDEX1=@I_vPOPRCTNM,  @I_vINDEX2='',  @I_vINDEX3='',  @I_vINDEX4='',  @I_vINDEX5='',  @I_vINDEX6='',  @I_vINDEX7='',  @I_vINDEX8='',  @I_vINDEX9='',  @I_vINDEX10='',  @I_vINDEX11='',  @I_vINDEX12='',  @I_vINDEX13='',  @I_vINDEX14='',  @I_vINDEX15='',  @I_vDelete = 1,  @O_iErrorState = @iCustomState output  select @iError = @@error  if @iStatus = 0 and @iError <> 0  begin  select @iStatus = @iError  end  if (@iStatus <> 0) or (@iCustomState <> 0)  begin  select @O_iErrorState = 2774   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end  return (@O_iErrorState)   
GO
GRANT EXECUTE ON  [dbo].[taPopRcptLotInsert] TO [DYNGRP]
GO
