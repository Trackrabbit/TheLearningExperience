SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[seePositionHistory_Create] @iLanguageID int   as   set nocount on   declare @sqldropstring varchar(400),   @sqlstring1 varchar(8000),   @sqlstring2 varchar(8000),   @sqlstring3 varchar(8000),   @sqlstring4 varchar(8000),   @sqlstring5 varchar(8000),   @sqlstring6 varchar(8000),   @sqlstring7 varchar(8000),   @sqlstring8 varchar(8000),   @sqlstring9 varchar(8000),   @sqlstring10 varchar(8000),   @sqljoinstring varchar(8000),   @sqlaccessstring varchar(2000),   @tNumberSegments int,   @tSegment int,   @I_iDictID int,   @I_iLangID int,   @I_iMessageNumber int,   @I_iAliasMessageNumber int,   @I_iIntegerValue int,   @Employee_ID varchar(255), @EmployeeID_For_DrillBack varchar(255) select @I_iDictID = 1493 select @I_iMessageNumber = 22400 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgStringForProcs  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Employee_ID output   select @I_iDictID = 1493 select @I_iMessageNumber = 22400 select @I_iAliasMessageNumber = 22214 exec DYNAMICS..smGetBIMsgStringForProcs  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @EmployeeID_For_DrillBack output   select @sqldropstring =   'IF EXISTS (SELECT * FROM   sys.objects WHERE  object_id = OBJECT_ID(N''[dbo].[seePositionHistory]'') AND type in ( N''P'', N''PC'' ))  ' +   '  DROP PROCEDURE [dbo].[seePositionHistory]  '   select @sqlstring1 =   'create procedure [dbo].[seePositionHistory] @I_dUserDate datetime = null,  '+   '                                            @Employee    varchar(max)  '+   'as  '+   '  declare @ValuesTable table (  '+   '    Value nvarchar(500))  '+   '  insert into @ValuesTable  '+   '  select *  '+   '  from   dbo.seeSplitString(@Employee, '','')  '+   '  if ( @I_dUserDate is not null )  '+   '    begin  '+   '        select @I_dUserDate = DATEADD(HOUR, -DATEPART(HOUR, @I_dUserDate),  '+   '                              @I_dUserDate)  '+   '        select @I_dUserDate = DATEADD(MINUTE, -DATEPART(MINUTE, @I_dUserDate),  '+   '                              @I_dUserDate)  '+   '        select @I_dUserDate = DATEADD(SECOND, -DATEPART(SECOND, @I_dUserDate),  '+   '                              @I_dUserDate)  '+   '        select @I_dUserDate = DATEADD(MILLISECOND, -DATEPART(MILLISECOND,  '+   '                                                    @I_dUserDate),  '+   '                                     @I_dUserDate)  '+   '    end  '+   '  if @Employee = ''''  '+   '    begin  '+   '        select a.EMPLOYID,  '+   '               a.FRSTNAME,  '+   '               a.LASTNAME,  '+   '               isnull(dbo.DYN_FUNC_HR_Status(a.HRSTATUS), '''') as HRSTATUS,  '+   '               isnull(b.POSITION_I, '''')                       as POSITION_I,  '+   '               isnull(b.DIVISION_I, '''')                       as DIVISION_I,  '+   '               isnull(b.DEPARTMENTNAME_I, '''')                 as  '+   '               DEPARTMENTNAME_I,  '+   '               isnull(b.Effective_Date, ''1/1/1900'')           as Effective_Date, '+   '               ['+@EmployeeID_For_DrillBack+']  '+   '        from   UPR00100 a inner join Employees '+   '    on a.EMPLOYID = Employees.['+@Employee_ID+']      '+   '               left outer join MPOSHIST b  '+   '                 on a.EMPLOYID = b.EMPID_I  '+   '        where  ( @I_dUserDate is null  '+   '                  or @I_dUserDate >= b.CHANGEDATE_I )  '+   '        order  by EMPLOYID,  '+   '                  isnull(b.Effective_Date, ''1/1/1900'') DESC  '+   '    end  '+   '  else  '+   '    begin  '+   '        select a.EMPLOYID,  '+   '               a.FRSTNAME,  '+   '               a.LASTNAME,  '+   '               isnull(dbo.DYN_FUNC_HR_Status(a.HRSTATUS), '''') as HRSTATUS,  '+   '               isnull(b.POSITION_I, '''')                       as POSITION_I,  '+   '               isnull(b.DIVISION_I, '''')                       as DIVISION_I,  '+   '               isnull(b.DEPARTMENTNAME_I, '''')                 as  '+   '               DEPARTMENTNAME_I,  '+   '               isnull(b.Effective_Date, ''1/1/1900'')           as Effective_Date, '+   '    ['+@EmployeeID_For_DrillBack+']  '+   '        from   UPR00100 a inner join Employees '+   '    on a.EMPLOYID = Employees.['+@Employee_ID+']  '+   '               inner join @ValuesTable EmployeeList  '+   '                 on a.EMPLOYID = EmployeeList.Value  '+   '               left outer join MPOSHIST b  '+   '                 on a.EMPLOYID = b.EMPID_I  '+   '        where  ( @I_dUserDate is null  '+   '                  or @I_dUserDate >= b.CHANGEDATE_I )  '+   '        order  by EMPLOYID,  '+   '                  isnull(b.Effective_Date, ''1/1/1900'') DESC  '+   '    end  '  select @sqlaccessstring =   'GRANT execute ON [dbo].[seePositionHistory] TO [rpt_executive], [rpt_human resource administrator] '   exec (@sqldropstring)   exec (@sqlstring1+' '+@sqlstring2+' '+@sqlstring3+' '+@sqlstring4+' '+@sqlstring5+' '+@sqlstring6+' '+@sqlstring7+' '+@sqlstring8+' '+@sqlstring9+' '+@sqlstring10)   exec (@sqlaccessstring)   set nocount off    
GO
GRANT EXECUTE ON  [dbo].[seePositionHistory_Create] TO [DYNGRP]
GO
