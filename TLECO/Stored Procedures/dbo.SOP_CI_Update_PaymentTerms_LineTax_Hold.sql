SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
 Create PROCEDURE [dbo].[SOP_CI_Update_PaymentTerms_LineTax_Hold]  @FulSOP_Number VARCHAR(25),  @NewINV_Number VARCHAR(25),  @Trxsrc varchar(15),   @FunDecPlace int  As  DECLARE @DISTTYPE SMALLINT,  @SEQNUMBR INT,  @SOPNUMBE varchar(25),  @SOPTYPE INT,  @SEQNUMBR1 INT,  @LNITMSEQ INT,  @LNITMSEQ_Ln INT,  @SEQNUMBR_Nxt INT,  @Old_SEQNUMBR INT,  @TAXDTLID varchar(20),  @STAXAMNT numeric(19,5),  @ORSLSTAX numeric(19,5),  @FRTTXAMT numeric(19,5),  @ORFRTTAX numeric(19,5),  @MSCTXAMT numeric(19,5),  @ORMSCTAX numeric(19,5),  @TAXDTSLS numeric(19,5),  @ORTOTSLS numeric(19,5),  @TDTTXSLS numeric(19,5),  @ORTXSLS numeric(19,5),  @TXDTOTTX numeric(19,5),  @OTTAXPON numeric(19,5),  @PRCHLDID varchar(15),  @HOLDDATE datetime ,  @TIME1 datetime ,  @TRXSORCE varchar(13),  @ExecString nvarchar (4000),  @Param nvarchar(500),  @XCHGRATE NUMERIC(19,7),  @RTCLCMTD BIT,   @I_sMCTrxState SMALLINT = NULL,  @I_nDenomExchangeRate NUMERIC(15,7) = NULL,  @I_sViewMode smallint = NULL  select @I_nDenomExchangeRate= DENXRATE,   @XCHGRATE=XCHGRATE,  @I_sMCTrxState=MCTRXSTT,  @RTCLCMTD=RTCLCMTD   from SOP30200   where SOPNUMBE=@FulSOP_Number  set  @I_sViewMode=4  SELECT * INTO [#TEMPPAYM]   FROM SOP10103   where  SOPNUMBE=@FulSOP_Number   and SOPTYPE=6   IF (select COUNT(*) from SOP10103 where SOPNUMBE=@NewINV_Number and SOPTYPE=3)=0  update SOP10103   set SOPNUMBE=@NewINV_Number ,   SOPTYPE=3   where   SOPNUMBE=@FulSOP_Number   and SOPTYPE=6  if (select COUNT(*) from SOP10103 where SOPNUMBE=@NewINV_Number and SOPTYPE=3)>0  BEGIN  DECLARE Cur_Payment cursor for   select SOPNUMBE,SOPTYPE,SEQNUMBR from SOP10103 where SOPNUMBE=@FulSOP_Number and SOPTYPE=6  OPEN Cur_Payment  FETCH NEXT FROM Cur_Payment INTO @SOPNUMBE,@SOPTYPE,@SEQNUMBR  while @@FETCH_STATUS = 0  BEGIN  select @SEQNUMBR1=max(SEQNUMBR)+16384   from SOP10103   where SOPNUMBE=@NewINV_Number   and SOPTYPE=3  update SOP10103   set SOPNUMBE=@NewINV_Number ,   SOPTYPE=3,  SEQNUMBR=@SEQNUMBR1   where SOPNUMBE=@SOPNUMBE   and SOPTYPE=@SOPTYPE   and SEQNUMBR=@SEQNUMBR  FETCH NEXT FROM Cur_Payment INTO @SOPNUMBE,@SOPTYPE,@SEQNUMBR  END   deallocate Cur_Payment   END  INSERT INTO SOP10103   SELECT SOPTYPE,  SOPNUMBE,  SEQNUMBR,  PYMTTYPE,  DOCNUMBR,  RMDTYPAL,  CHEKBKID,  CHEKNMBR,  CARDNAME,  RCTNCCRD,  AUTHCODE,  AMNTPAID,  OAMTPAID,  AMNTREMA,  OAMNTREM,  DOCDATE,  EXPNDATE,  CURNCYID,  CURRNIDX,  TRXSORCE,  DEPSTATS,  DELETE1,  GLPOSTDT,  CASHINDEX,  DEPINDEX,  EFTFLAG   FROM [#TEMPPAYM]  SELECT * INTO [#TEMP]   FROM SOP10105   where SOPNUMBE=@FulSOP_Number   and SOPTYPE=6  Delete SOP10105   where SOPNUMBE=@FulSOP_Number   and LNITMSEQ=0   BEGIN   DECLARE Cur_LineTax cursor for   select SOPNUMBE,  LNITMSEQ,  TAXDTLID   from SOP10105   where SOPNUMBE=@FulSOP_Number   and SOPTYPE=6   order by LNITMSEQ   OPEN Cur_LineTax   FETCH NEXT FROM Cur_LineTax INTO @SOPNUMBE,@LNITMSEQ_Ln,@TAXDTLID   while @@FETCH_STATUS = 0   BEGIN   if @LNITMSEQ_Ln % 16384=0   BEGIN   Select @LNITMSEQ=isnull(max(LNITMSEQ),0)+16384   from SOP10105   where SOPNUMBE=@NewINV_Number   and SOPTYPE=3   and LNITMSEQ%16384=0   if @Old_SEQNUMBR<>@LNITMSEQ_Ln   UPDATE SOP10105   set SOPNUMBE=@NewINV_Number ,   SOPTYPE=3,LNITMSEQ=@LNITMSEQ   where  SOPNUMBE=@FulSOP_Number   and SOPTYPE=6   and LNITMSEQ=@LNITMSEQ_Ln   set @Old_SEQNUMBR=@LNITMSEQ_Ln   END   FETCH NEXT FROM Cur_LineTax INTO @SOPNUMBE,@LNITMSEQ_Ln,@TAXDTLID   END   deallocate Cur_LineTax   END   DECLARE Cur_LineTax_FRMSC cursor for   select SOPNUMBE,  LNITMSEQ,  TAXDTLID   from SOP10105   where SOPNUMBE=@FulSOP_Number   and SOPTYPE=6   OPEN Cur_LineTax_FRMSC   FETCH NEXT FROM Cur_LineTax_FRMSC INTO @SOPNUMBE,@LNITMSEQ_Ln,@TAXDTLID   while @@FETCH_STATUS = 0   BEGIN   if @LNITMSEQ_Ln % 16384<>0   BEGIN   if (select count(*)   from SOP10105   where SOPNUMBE=@NewINV_Number   and SOPTYPE=3   and TAXDTLID=@TAXDTLID   and LNITMSEQ=@LNITMSEQ_Ln)=0   UPDATE SOP10105   set SOPNUMBE=@NewINV_Number ,   SOPTYPE=3   where SOPNUMBE=@FulSOP_Number   and SOPTYPE=6   and LNITMSEQ=@LNITMSEQ_Ln   ELSE   BEGIN TRY   select @STAXAMNT = dbo.mcFuncCalculateAmount(@RTCLCMTD,   @I_sViewMode,   @XCHGRATE,   @I_nDenomExchangeRate,   @I_sMCTrxState,  @FunDecPlace,  sum(ORSLSTAX)),  @ORSLSTAX=sum(ORSLSTAX),  @FRTTXAMT=dbo.mcFuncCalculateAmount(@RTCLCMTD,   @I_sViewMode,   @XCHGRATE,   @I_nDenomExchangeRate,   @I_sMCTrxState,  @FunDecPlace,  sum(ORFRTTAX)),   @ORFRTTAX=sum(ORFRTTAX),  @MSCTXAMT=dbo.mcFuncCalculateAmount(@RTCLCMTD,   @I_sViewMode,   @XCHGRATE,   @I_nDenomExchangeRate,   @I_sMCTrxState,  @FunDecPlace,  sum(ORMSCTAX)),  @ORMSCTAX=sum(ORMSCTAX),  @TAXDTSLS=dbo.mcFuncCalculateAmount(@RTCLCMTD,   @I_sViewMode,   @XCHGRATE,   @I_nDenomExchangeRate,   @I_sMCTrxState,  @FunDecPlace,  sum(ORTOTSLS)),  @ORTOTSLS=sum(ORTOTSLS),  @TDTTXSLS=dbo.mcFuncCalculateAmount(@RTCLCMTD,   @I_sViewMode,   @XCHGRATE,   @I_nDenomExchangeRate,   @I_sMCTrxState,  @FunDecPlace,   sum(ORTXSLS)),  @ORTXSLS=sum(ORTXSLS),  @TXDTOTTX=dbo.mcFuncCalculateAmount(@RTCLCMTD,   @I_sViewMode,   @XCHGRATE,   @I_nDenomExchangeRate,   @I_sMCTrxState,  @FunDecPlace,   sum(OTTAXPON)),  @OTTAXPON=sum(OTTAXPON)   from SOP10105   where SOPTYPE=6   and TAXDTLID=@TAXDTLID   and LNITMSEQ=@LNITMSEQ_Ln   and SOPNUMBE=@SOPNUMBE   UPDATE SOP10105   set STAXAMNT=STAXAMNT+@STAXAMNT,  ORSLSTAX=ORSLSTAX+@ORSLSTAX,  FRTTXAMT=FRTTXAMT+@FRTTXAMT,  ORFRTTAX=ORFRTTAX+@ORFRTTAX,  MSCTXAMT=MSCTXAMT+@MSCTXAMT,  ORMSCTAX=ORMSCTAX+@ORMSCTAX,  TAXDTSLS=TAXDTSLS+@TAXDTSLS,  ORTOTSLS=ORTOTSLS+@ORTOTSLS,  TDTTXSLS=TDTTXSLS+@TDTTXSLS,  ORTXSLS=ORTXSLS+@ORTXSLS,  TXDTOTTX=TXDTOTTX+@TXDTOTTX,  OTTAXPON=OTTAXPON+@OTTAXPON   where   SOPNUMBE=@NewINV_Number   and SOPTYPE=3   and TAXDTLID=@TAXDTLID   and LNITMSEQ=@LNITMSEQ_Ln   END TRY   BEGIN CATCH   END CATCH   Delete   from SOP10105   where SOPNUMBE=@SOPNUMBE   and LNITMSEQ=@LNITMSEQ_Ln   and TAXDTLID=@TAXDTLID   END   FETCH NEXT FROM Cur_LineTax_FRMSC INTO @SOPNUMBE,@LNITMSEQ_Ln,@TAXDTLID   END   DEALLOCATE Cur_LineTax_FRMSC   insert into SOP10105   select SOPTYPE,  SOPNUMBE,  LNITMSEQ,  TAXDTLID,  ACTINDX,  BKOUTTAX,  TXABLETX,  STAXAMNT,  ORSLSTAX,  FRTTXAMT,  ORFRTTAX,  MSCTXAMT,  ORMSCTAX,  TAXDTSLS,  ORTOTSLS,  TDTTXSLS,  ORTXSLS,  TXDTOTTX,  OTTAXPON,  DELETE1,  CURRNIDX,  TRXSORCE   from [#TEMP]   SELECT * INTO [#TEMPHLD]   FROM SOP10104   where   SOPNUMBE=@FulSOP_Number   and SOPTYPE=6  DECLARE Cur_hld cursor for   select SOPNUMBE,  PRCHLDID   from SOP10104   where SOPNUMBE=@FulSOP_Number   and SOPTYPE=6   OPEN Cur_hld   FETCH NEXT FROM Cur_hld INTO @SOPNUMBE,@PRCHLDID   while @@FETCH_STATUS = 0   BEGIN   BEGIN TRY  if (select count(*) from SOP10104 where SOPNUMBE=@NewINV_Number and SOPTYPE=3 and PRCHLDID=@PRCHLDID)=0   UPDATE SOP10104   set SOPNUMBE=@NewINV_Number ,  SOPTYPE=3   where   SOPNUMBE=@FulSOP_Number   and SOPTYPE=6   else   Delete from SOP10104   where   SOPNUMBE=@FulSOP_Number   and SOPTYPE=6   and PRCHLDID=@PRCHLDID   END TRY   BEGIN CATCH   END CATCH  FETCH NEXT FROM Cur_hld INTO @SOPNUMBE,@PRCHLDID   END   DEALLOCATE Cur_hld   insert into SOP10104   select SOPTYPE,  SOPNUMBE,  PRCHLDID,  DELETE1,  USERID,  HOLDDATE,  TIME1,  TRXSORCE   from [#TEMPHLD]   Update SOP10104 set TRXSORCE =@Trxsrc where SOPNUMBE=@FulSOP_Number and  SOPTYPE=6   Update SOP10101 set TRXSORCE =@Trxsrc where SOPNUMBE=@FulSOP_Number and  SOPTYPE=6   Update SOP10200 set TRXSORCE =@Trxsrc where SOPNUMBE=@FulSOP_Number and  SOPTYPE=6   Update SOP10103 set TRXSORCE =@Trxsrc,DEPSTATS=2 where  SOPNUMBE=@FulSOP_Number and SOPTYPE=6   Update SOP10105 set TRXSORCE =@Trxsrc where  SOPNUMBE=@FulSOP_Number and SOPTYPE=6   Update SOP10201 set TRXSORCE =@Trxsrc where  SOPNUMBE=@FulSOP_Number and SOPTYPE=6   Update SOP10202 set TRXSORCE =@Trxsrc where  SOPNUMBE=@FulSOP_Number and SOPTYPE=6  Delete from DTA10100 where  DOCNUMBR=@FulSOP_Number and RMDTYPAL=6   Delete from DTA10200 where  DOCNUMBR=@FulSOP_Number and RMDTYPAL=6    
GO
GRANT EXECUTE ON  [dbo].[SOP_CI_Update_PaymentTerms_LineTax_Hold] TO [DYNGRP]
GO
