SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SOP_CI_Update_Combine_Distribution]   @TBName VARCHAR(25),   @SOP_Number VARCHAR(25),  @FunDecPlace int  As  DECLARE @DISTTYPE SMALLINT,   @ACTINDEX INT,   @DEBITAMT NUMERIC(19,5),   @CREDITAMT NUMERIC(19,5),   @ORGCRDTAMT NUMERIC(19,5),   @ORGDBTAMT NUMERIC(19,5),   @SeqNumber INT,   @CURRNIDX SMALLINT,   @ExecString nvarchar (4000),  @Param nvarchar(500),  @XCHGRATE NUMERIC(19,7),  @RTCLCMTD BIT,   @I_sMCTrxState SMALLINT = NULL,  @I_nDenomExchangeRate NUMERIC(15,7) = NULL,  @I_sViewMode smallint = NULL   set @I_sViewMode=4  SELECT @ExecString = ' SELECT TOP 1 @RTCM = ISNULL(A.RTCLCMTD,0),  @XCHGRATE1 = ISNULL(A.XCHGRATE,0),  @I_sMCTrxState1=ISNULL(A.MCTRXSTT,0),  @I_nDenomExchangeRate1=ISNULL(A.DENXRATE,0)   FROM SOP30200 A   INNER JOIN ' +  @TBName + ' B   on  A.SOPNUMBE = B.SOPNUMBE   where B.MKTOPROC = 1'   set @Param = N'@RTCM BIT output,  @XCHGRATE1 NUMERIC(19,7) output,   @I_sMCTrxState1 smallint output,   @I_nDenomExchangeRate1 numeric(15,7) output'   EXEC sp_executesql   @ExecString,   @Param,   @RTCM= @RTCLCMTD output,  @XCHGRATE1 = @XCHGRATE output,  @I_sMCTrxState1=@I_sMCTrxState output ,   @I_nDenomExchangeRate1=@I_nDenomExchangeRate output   SELECT @SeqNumber = 16384   SET @ExecString =   'DECLARE Update_Dist CURSOR FAST_FORWARD FOR   SELECT DISTTYPE,  ACTINDX,  CURRNIDX,  dbo.mcFuncCalculateAmount('+ convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORDBTAMT)),  dbo.mcFuncCalculateAmount('+ convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORCRDAMT)),  sum(ORDBTAMT),sum(ORCRDAMT)   FROM SOP10102   WHERE SOPNUMBE IN( SELECT SOPNUMBE   FROM ' + @TBName + '   WHERE MKTOPROC=1)  Group by DISTTYPE,ACTINDX,CURRNIDX'  EXEC(@ExecString)   OPEN Update_Dist   FETCH NEXT FROM Update_Dist INTO @DISTTYPE,@ACTINDEX,@CURRNIDX,@DEBITAMT,@CREDITAMT,@ORGDBTAMT,@ORGCRDTAMT   WHILE @@FETCH_STATUS=0   BEGIN   if @DISTTYPE=2   if @DEBITAMT>@CREDITAMT  INSERT INTO SOP10102( SOPTYPE,  SOPNUMBE,  SEQNUMBR,  DISTTYPE,  ACTINDX,  DEBITAMT,  ORDBTAMT,  CRDTAMNT,  ORCRDAMT,  CURRNIDX)   VALUES( 3,  @SOP_Number,  @SeqNumber,  @DISTTYPE,  @ACTINDEX,  abs(@DEBITAMT-@CREDITAMT),  abs(@ORGDBTAMT-@ORGCRDTAMT),  0,  0,  @CURRNIDX)   else   INSERT INTO SOP10102( SOPTYPE,  SOPNUMBE,  SEQNUMBR,  DISTTYPE,  ACTINDX,  DEBITAMT,  ORDBTAMT,  CRDTAMNT,  ORCRDAMT,  CURRNIDX)   VALUES( 3,  @SOP_Number,  @SeqNumber,  @DISTTYPE,  @ACTINDEX,  0,  0,  abs(@DEBITAMT-@CREDITAMT),  abs(@ORGDBTAMT-@ORGCRDTAMT),  @CURRNIDX)   else  INSERT INTO SOP10102(SOPTYPE,  SOPNUMBE,  SEQNUMBR,  DISTTYPE,  ACTINDX,  DEBITAMT,  ORDBTAMT,  CRDTAMNT,  ORCRDAMT,  CURRNIDX)   VALUES( 3,  @SOP_Number,  @SeqNumber,  @DISTTYPE,  @ACTINDEX,  @DEBITAMT,  @ORGDBTAMT,  @CREDITAMT,  @ORGCRDTAMT,  @CURRNIDX)   FETCH NEXT FROM Update_Dist INTO @DISTTYPE,@ACTINDEX,@CURRNIDX,@DEBITAMT,@CREDITAMT,@ORGDBTAMT,@ORGCRDTAMT   SET @SeqNumber=@SeqNumber+16384;   END   CLOSE Update_Dist   DEALLOCATE Update_Dist     
GO
GRANT EXECUTE ON  [dbo].[SOP_CI_Update_Combine_Distribution] TO [DYNGRP]
GO
