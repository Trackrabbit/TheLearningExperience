SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE Procedure [dbo].[SVC_RMA_Delete] ( @RecType smallint,  @RMANumber char(15), @Line numeric(19,5) )  as declare @ProcessLine Numeric(19,5) declare @DocNumber char(31) declare @Bin char(21) declare @ProcessType smallint declare @ReturnItem char(31) declare @ReturnSerial char(21) declare @ReturnEquip int declare @LotSeq int declare @retstat int declare @WORecType smallint  if @Line = 0   Begin  if @RecType = 2   Begin  declare Delete_Process_Line cursor for select SVC_Process_SEQ_Number, SVC_Document_Number, SVC_Process_Type, SLTSQNUM   from SVC35210   where RETDOCID = @RMANumber and Return_Record_Type = @RecType and SVC_Process_Type > 0  open Delete_Process_Line   fetch next from Delete_Process_Line into @ProcessLine, @DocNumber, @ProcessType, @LotSeq  while @@FETCH_STATUS = 0  Begin  if @ProcessType = 2  exec SVC_Delete_RTV @DocNumber  else if @ProcessType > 3   begin  exec @retstat = SVC_Delete_WorkOrder 2, @DocNumber  if @retstat <> 0 begin deallocate Delete_Process_Line  return (1002) end  end  fetch next from Delete_Process_Line into @ProcessLine, @DocNumber, @ProcessType, @LotSeq  End  deallocate Delete_Process_Line   delete from SVC35001 where RETDOCID = @RMANumber and Return_Record_Type = @RecType  delete from SVC35030 where RETDOCID = @RMANumber and Return_Record_Type = @RecType  delete from SVC35255 where RETDOCID = @RMANumber and Return_Record_Type = @RecType  delete from SVC35256 where RETDOCID = @RMANumber and Return_Record_Type = @RecType  delete from SVC35210 where RETDOCID = @RMANumber and Return_Record_Type = @RecType  delete from SVC35200 where RETDOCID = @RMANumber and Return_Record_Type = @RecType  delete from SVC35000 where RETDOCID = @RMANumber and Return_Record_Type = @RecType  delete from SVC35020 where RETDOCID = @RMANumber  End  Else   Begin  if (select RMA_Status from SVC05000 where RETDOCID = @RMANumber and Return_Record_Type = @RecType) >= 0  and @RecType < 1   return (1001)  declare Delete_Process_Line cursor for select SVC_Process_SEQ_Number, SVC_Document_Number, SVC_Process_Type, SLTSQNUM   from SVC05210   where RETDOCID = @RMANumber and Return_Record_Type = @RecType and SVC_Process_Type > 0   open Delete_Process_Line   fetch next from Delete_Process_Line into @ProcessLine, @DocNumber, @ProcessType, @LotSeq  while @@FETCH_STATUS = 0  Begin  if @ProcessType = 2  exec SVC_Delete_RTV @DocNumber  else if @ProcessType > 3   begin  if @ProcessType = 4   begin set @WORecType = 1  end  else   begin set @WORecType = 2  end   exec @retstat = SVC_Delete_WorkOrder @WORecType, @DocNumber  if @retstat <> 0 begin deallocate Delete_Process_Line  return (1002) end  end  fetch next from Delete_Process_Line into @ProcessLine, @DocNumber, @ProcessType, @LotSeq  End  deallocate Delete_Process_Line   delete from SVC05001 where RETDOCID = @RMANumber and Return_Record_Type = @RecType  delete from SVC05210 where RETDOCID = @RMANumber and Return_Record_Type = @RecType  delete from SVC05030 where RETDOCID = @RMANumber and Return_Record_Type = @RecType  delete from SVC05255 where RETDOCID = @RMANumber and Return_Record_Type = @RecType  delete from SVC05256 where RETDOCID = @RMANumber and Return_Record_Type = @RecType  delete from SVC05212 where RETDOCID = @RMANumber and Return_Record_Type = @RecType  delete from SVC05200 where RETDOCID = @RMANumber and Return_Record_Type = @RecType  delete from SVC05000 where RETDOCID = @RMANumber and Return_Record_Type = @RecType  delete from SVC05020 where RETDOCID = @RMANumber  End  End else  Begin  if @RecType = 2   Begin  delete from SVC35001 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line  delete from SVC35210 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line  delete from SVC35030 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line  delete from SVC35200 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line  End  Else   Begin  if exists(select * from SVC05200 where RETDOCID = @RMANumber  and Return_Record_Type = @RecType and LNSEQNBR = @Line and RMA_Status > 0)   return (1001)  delete from SVC05001 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line  delete from SVC05210 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line  delete from SVC05212 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line  delete from SVC05030 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line  delete from SVC05200 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line  End  End return    
GO
GRANT EXECUTE ON  [dbo].[SVC_RMA_Delete] TO [DYNGRP]
GO
