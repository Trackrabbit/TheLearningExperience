SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[seePOPLateShipmentMetricDetails_Create] @iLanguageID int   as   set nocount on   declare @sqldropstring varchar(400),   @sqlstring1 varchar(8000),   @sqlstring2 varchar(8000),   @sqlstring3 varchar(8000),   @sqlstring4 varchar(8000),   @sqlstring5 varchar(8000),   @sqlstring6 varchar(8000),   @sqlstring7 varchar(8000),   @sqlstring8 varchar(8000),   @sqlstring9 varchar(8000),   @sqlstring10 varchar(8000),   @sqljoinstring varchar(8000),   @sqlaccessstring varchar(2000),   @tNumberSegments int,   @tSegment int,   @I_iDictID int,   @I_iLangID int,   @I_iMessageNumber int,   @I_iAliasMessageNumber int,   @I_iIntegerValue int,  @Last_Receipt_Date varchar(255), @Promised_Ship_Date varchar(255), @Vendor_ID varchar(255)  select @I_iDictID = 1493 select @I_iMessageNumber = 26374 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgStringForProcs  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Last_Receipt_Date output   select @I_iDictID = 1493 select @I_iMessageNumber = 26323 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgStringForProcs  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Promised_Ship_Date output   select @I_iDictID = 1493 select @I_iMessageNumber = 26307 select @I_iAliasMessageNumber = 0 exec DYNAMICS..smGetBIMsgStringForProcs  @I_iMessageNumber, @I_iAliasMessageNumber, @I_iDictID, @iLanguageID, @Vendor_ID output    select @sqldropstring =   'IF EXISTS (SELECT * FROM   sys.objects WHERE  object_id = OBJECT_ID(N''[dbo].[seePOPLateShipmentMetricDetails]'') AND type in ( N''P'', N''PC'' ))  ' +   '  DROP PROCEDURE [dbo].[seePOPLateShipmentMetricDetails]  '   select @sqlstring1 =   'create procedure dbo.seePOPLateShipmentMetricDetails '+   '  @I_dUserDate datetime = NULL, '+   '  @Periods int   = NULL, '+   '  @Vendor varchar(max) '+   'as '+    'DECLARE @StartDate datetime '+   'DECLARE @EndDate datetime '+   'declare @ValuesTable table (Value nvarchar(500)) '+   'insert into @ValuesTable select * from dbo.seeSplitString(@Vendor, '','') '+   ' '+   'select '+   ' @I_dUserDate = DATEADD(HOUR, -DATEPART(HOUR, @I_dUserDate), @I_dUserDate) '+   'select '+   ' @I_dUserDate = DATEADD(MINUTE, -DATEPART(MINUTE, @I_dUserDate), @I_dUserDate) '+   'select '+   ' @I_dUserDate = DATEADD(SECOND, -DATEPART(SECOND, @I_dUserDate), @I_dUserDate) '+   'select '+   ' @I_dUserDate = DATEADD(MILLISECOND, -DATEPART(MILLISECOND, @I_dUserDate), @I_dUserDate) '+   'select '+   ' @EndDate = DATEADD(day, -DAY(@I_dUserDate), @I_dUserDate) '+   'select '+   ' @StartDate = DATEADD(month, -@Periods, DATEADD(day, -DAY(@I_dUserDate)+1, @I_dUserDate)) '+   'if @StartDate is not null and @EndDate is not null '+   'begin '+   ' if (@Vendor = '''') '+   ' begin '+   '  select distinct '+   '   Lines.*, '+   '   DATEDIFF(day, Lines.['+@Promised_Ship_Date+'], Lines.['+@Last_Receipt_Date+']) as DaysLate '+   '  from PurchaseLineItems Lines '+   '  where '+   '    Lines.['+@Last_Receipt_Date+'] > Lines.['+@Promised_Ship_Date+'] and '+   '    Lines.['+@Promised_Ship_Date+'] between @StartDate and @EndDate '+   ' end '+   ' else '+   ' begin '+   '  select distinct '+   '   Lines.*, '+   '   DATEDIFF(day, Lines.['+@Promised_Ship_Date+'], Lines.['+@Last_Receipt_Date+']) as DaysLate '+   '  from PurchaseLineItems Lines inner join @ValuesTable VendorList  on Lines.['+@Vendor_ID+'] = VendorList.Value '+   '  where '+   '    Lines.['+@Last_Receipt_Date+'] > Lines.['+@Promised_Ship_Date+'] and '+   '    Lines.['+@Promised_Ship_Date+'] between @StartDate and @EndDate '+   ' end '+   'end '+   'else '+   'begin '+   ' if (@Vendor = '''') '+   ' begin '+   '  select distinct '+   '   Lines.*, '+   '   DATEDIFF(day, Lines.['+@Promised_Ship_Date+'], Lines.['+@Last_Receipt_Date+']) as DaysLate '+   '  from PurchaseLineItems Lines '+   '  where '+   '    Lines.['+@Last_Receipt_Date+'] > Lines.['+@Promised_Ship_Date+'] '+   ' end '+   ' else '+   ' begin '+   '  select distinct '+   '   Lines.*, '+   '   DATEDIFF(day, Lines.['+@Promised_Ship_Date+'], Lines.['+@Last_Receipt_Date+']) as DaysLate '+   '  from PurchaseLineItems Lines inner join @ValuesTable VendorList  on Lines.['+@Vendor_ID+'] = VendorList.Value '+   '  where '+   '    Lines.['+@Last_Receipt_Date+'] > Lines.['+@Promised_Ship_Date+'] '+   ' end '+   'end '  select @sqlaccessstring =   'GRANT execute ON [dbo].[seePOPLateShipmentMetricDetails] TO [rpt_accounting manager],[rpt_accounts payable coordinator],[rpt_power user],[rpt_executive] '   exec (@sqldropstring)   exec (@sqlstring1+' '+@sqlstring2+' '+@sqlstring3+' '+@sqlstring4+' '+@sqlstring5+' '+@sqlstring6+' '+@sqlstring7+' '+@sqlstring8+' '+@sqlstring9+' '+@sqlstring10)   exec (@sqlaccessstring)   set nocount off    
GO
GRANT EXECUTE ON  [dbo].[seePOPLateShipmentMetricDetails_Create] TO [DYNGRP]
GO
