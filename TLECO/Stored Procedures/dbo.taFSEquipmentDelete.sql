SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[taFSEquipmentDelete] @I_vSERLNMBR char(21),    @I_vITEMNMBR char(31),    @I_vCUSTNMBR char(15) = null,   @I_vADRSCODE char(15) = null,   @I_vRequesterTrx smallint = 0,   @I_vUSRDEFND1 char(50) = '',   @I_vUSRDEFND2 char(50) = '',     @I_vUSRDEFND3 char(50) = '',   @I_vUSRDEFND4 varchar(8000) = '',  @I_vUSRDEFND5 varchar(8000) = '',  @O_iErrorState int output,   @oErrString varchar(255) output    with encryption as  set transaction isolation level read uncommitted set nocount on  declare  @O_TODAY datetime,  @USERID char(15),  @Line_Seq_Exists smallint,  @iStatus int,  @iCustomState int,  @iCustomErrString varchar(255),  @iAddCodeErrState int,    @O_oErrorState int,  @iError int,  @AuditLNITMSEQ int,  @AuditDesc char(31),  @EQUIPID int,  @CUSTNMBR char(15),  @ADRSCODE char(15),  @iValueExists smallint,  @O_iItemMetered smallint,  @NOTEINDX numeric(19,5)  select   @O_TODAY = convert(varchar(10), getdate(), 101),  @USERID = 'eConnect',  @Line_Seq_Exists = 0,  @iStatus  = 0,  @iCustomState  = 0,  @iCustomErrString = '',  @iAddCodeErrState  = 0,  @O_oErrorState  = 0,  @iError  = 0,  @AuditLNITMSEQ = 0,  @AuditDesc = 'Record deleted via eConnect',  @EQUIPID = 0,  @CUSTNMBR = '',  @ADRSCODE = '',  @O_iErrorState = 0,  @oErrString = '',  @iValueExists = 0,  @O_iItemMetered = 0,  @NOTEINDX = 0  if (@oErrString is NULL) begin  select @oErrString = '' end  exec @iStatus = taFSEquipmentDeletePre  @I_vSERLNMBR output,  @I_vITEMNMBR output,  @I_vCUSTNMBR output,  @I_vADRSCODE output,  @I_vRequesterTrx output,  @I_vUSRDEFND1 output,  @I_vUSRDEFND2 output,  @I_vUSRDEFND3 output,  @I_vUSRDEFND4 output,  @I_vUSRDEFND5 output,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if @iStatus = 0 and @iError <> 0 begin  select @iStatus = @iError end if (@iStatus <> 0) or (@iCustomState <> 0) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  set @O_iErrorState = 8865    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if @I_vSERLNMBR is null or  @I_vITEMNMBR is null or   @I_vCUSTNMBR is null or   @I_vADRSCODE is null begin  set @O_iErrorState = 8866    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if @I_vSERLNMBR='' or  @I_vITEMNMBR='' or  @I_vCUSTNMBR='' OR  @I_vADRSCODE='' begin  set @O_iErrorState = 8867    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if (@I_vCUSTNMBR <> '') begin  if not exists(select 1 from RM00101 (nolock) where CUSTNMBR=@I_vCUSTNMBR)  begin  set @O_iErrorState = 8872     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end  if (@I_vCUSTNMBR <> '') and (@I_vADRSCODE <> '') begin  if not exists(select 1 from RM00102 (nolock) where CUSTNMBR=@I_vCUSTNMBR and ADRSCODE = @I_vADRSCODE)  begin  set @O_iErrorState = 8873     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end  if (@I_vITEMNMBR <> '') begin  if not exists(select 1 from IV00101 (nolock) where ITEMNMBR=@I_vITEMNMBR)  begin  set @O_iErrorState = 8874     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end  if (@I_vITEMNMBR <> '') begin  set @iValueExists = 0  select @iValueExists = 1, @O_iItemMetered = isnull(METERED, 0) from SVC00951 (nolock) where ITEMNMBR = @I_vITEMNMBR  if (@@ERROR <> 0)  begin  set @O_iErrorState = 8875   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end   select  @I_vITEMNMBR = UPPER(@I_vITEMNMBR),  @I_vSERLNMBR = UPPER(@I_vSERLNMBR),  @I_vCUSTNMBR = UPPER(@I_vCUSTNMBR),  @I_vADRSCODE = UPPER(@I_vADRSCODE)  set @Line_Seq_Exists = 0 select @Line_Seq_Exists = 1,   @EQUIPID = isnull(EQUIPID, 0),   @CUSTNMBR = isnull(CUSTNMBR, ''),  @ADRSCODE = isnull(ADRSCODE, ''),  @NOTEINDX = isnull(NOTEINDX, 0)  from SVC00300 (nolock) where SERLNMBR = @I_vSERLNMBR and ITEMNMBR = @I_vITEMNMBR  if (@Line_Seq_Exists=0) or (@EQUIPID = 0) begin  set @O_iErrorState = 8868    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return(@O_iErrorState) end  if (@Line_Seq_Exists = 1 and @CUSTNMBR <> '' and @CUSTNMBR <> @I_vCUSTNMBR) begin  set @O_iErrorState = 8869     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return(@O_iErrorState) end  if (@Line_Seq_Exists = 1 and @ADRSCODE <> '' and @ADRSCODE <> @I_vADRSCODE) begin  set @O_iErrorState = 8870     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return(@O_iErrorState) end  if (@CUSTNMBR <> '' and @CUSTNMBR <> @I_vCUSTNMBR) or (@ADRSCODE <> '' and @ADRSCODE <> @I_vADRSCODE) begin  if exists(select 1 from SVC00601 (nolock) where (CONSTS = 1 or CONSTS = 2) and (Contract_Line_Status = 'C' or Contract_Line_Status = 'E')  and EQUIPID = @EQUIPID and ENDDATE < @O_TODAY)  begin  set @O_iErrorState = 8876     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end   if exists(select 1 from SVC00202 (nolock) where SRVRECTYPE = 2 and EQUIPID = @EQUIPID)  begin  set @O_iErrorState = 8881     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end   if exists(select 1 from SVC06100 (nolock) where WORKORDNUM <> '' and WORECTYPE = 2 and IBEQUIPID = @EQUIPID)  begin  set @O_iErrorState = 8882     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end   set @iStatus = 0  exec @iStatus = SVC_Check_Equip_On_Config  '',   @EQUIPID   if (@iStatus > 0)  begin  set @O_iErrorState = 8877     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end  select @AuditLNITMSEQ = count(*) + 1 from SVC00310 (nolock) where EQUIPID = @EQUIPID  if (@O_iErrorState <> 0)  return (@O_iErrorState)  if (@Line_Seq_Exists=1) begin  if (@O_iItemMetered = 1)  begin  delete from SVC00301 where EQUIPID = @EQUIPID and @I_vITEMNMBR = ITEMNMBR and SERLNMBR = @I_vSERLNMBR  if @@error <> 0  begin  set @O_iErrorState = 8883    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end  end   delete from SVC00302 where EQUIPID = @EQUIPID and @I_vITEMNMBR = ITEMNMBR and SERLNMBR = @I_vSERLNMBR  if @@error <> 0  begin  set @O_iErrorState = 8884    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end   delete from SVC00306 where EQUIPID = @EQUIPID  if @@error <> 0  begin  set @O_iErrorState = 8885    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end   delete from SVC00315 where EQUIPID = @EQUIPID  if @@error <> 0  begin  set @O_iErrorState = 8886    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end   if (@NOTEINDX > 0)  begin  delete from SY03900 where NOTEINDX = @NOTEINDX  if (@@error <> 0)  begin  set @O_iErrorState = 8887    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState)  end  end   delete from SVC00300 where EQUIPID = @EQUIPID AND SERLNMBR = @I_vSERLNMBR and ITEMNMBR = @I_vITEMNMBR  if (@@error <> 0)  begin  set @O_iErrorState = 8878    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState)  end   insert into SVC00310  (EQUIPID,  LNITMSEQ,  DATE1,  TIME1,  USERID,  From_Customer_Number,  To_Customer_Number,  From_Config_Reference,  To_Config_Reference,  From_Confg_Level,  To_Config_Level,  From_Config_Sequence,  To_Config_Sequence,  From_Serial_Number,  To_Serial_Number,  From_Item_Number,  To_Item_Number,  DSCRIPTN)  select  @EQUIPID,  @AuditLNITMSEQ,  @O_TODAY,  convert(varchar(12),getdate(),108),  @USERID,  @I_vCUSTNMBR,  '',  '',  '',  0,  0,  0,  0,  @I_vSERLNMBR,  '',  @I_vITEMNMBR,  '',  @AuditDesc  if @@error <> 0  begin  set @O_iErrorState = 8879    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end  if (@O_iErrorState <> 0)  return (@O_iErrorState)  exec @iStatus = taFSEquipmentDeletePost  @I_vSERLNMBR,  @I_vITEMNMBR,  @I_vCUSTNMBR,  @I_vADRSCODE,  @I_vRequesterTrx,  @I_vUSRDEFND1,  @I_vUSRDEFND2,  @I_vUSRDEFND3,  @I_vUSRDEFND4,  @I_vUSRDEFND5,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if @iStatus = 0 and @iError <> 0 begin  select @iStatus = @iError end if (@iStatus <> 0) or (@iCustomState <> 0) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  set @O_iErrorState = 8880    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  return (@O_iErrorState)   
GO
GRANT EXECUTE ON  [dbo].[taFSEquipmentDelete] TO [DYNGRP]
GO
