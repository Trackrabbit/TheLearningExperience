SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
 CREATE  PROCEDURE [dbo].[aagGenericGLHistunmatched] @USERID CHAR(15), @TBName varchar(25), @Preview SMALLINT, @O_SQL_Error_State int = NULL  output AS  BEGIN   SET NOCOUNT ON  SET TRANSACTION ISOLATION LEVEL READ COMMITTED  BEGIN TRANSACTION  Declare @JRNENTRY bigint,  @aaGLHdrID bigint,  @cnt int,  @i int,  @GLTrxSource char(13)   Declare @cDBName char(5),  @l_nStatus int,  @O_nSQL_Error_State int,  @l_nError int,  @l_cBBF varchar(255),  @l_cPANDL varchar(255),  @l_RCTRXSEQ numeric(19,5),  @l_YEAR1 smallint  select @cDBName = DB_NAME()   exec    @l_nStatus = DYNAMICS.dbo.smGetMsgString 12030, @cDBName, @l_cBBF output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)   exec    @l_nStatus = DYNAMICS.dbo.smGetMsgString 12125, @cDBName, @l_cPANDL output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)  DECLARE @JRNENTRY1 bigint, @SEQNUMBR1 INT,  @HSTYEAR1 SMALLINT,   @RCTRXSEQ1 numeric(19,5),   @TRXSORCE1 char(13),   @CRDTAMNT1 numeric(19,5),   @DEBITAMT1 numeric(19,5),  @TRXDATE1 datetime,  @CURNCYID1 CHAR(16),  @CURRNIDX1 SMALLINT,   @Ledger_ID1 INT,   @ACTINDX1 INT,  @SEQ1 INT   DECLARE C1 CURSOR FAST_FORWARD FOR (SELECT JRNENTRY, SEQNUMBR , HSTYEAR, RCTRXSEQ, TRXSORCE, CRDTAMNT, DEBITAMT,  TRXDATE,CURNCYID,CURRNIDX, Ledger_ID, ACTINDX , RANK() OVER (PARTITION BY JRNENTRY,HSTYEAR,RCTRXSEQ,TRXSORCE ORDER BY SEQNUMBR ASC)FROM GL30000   WHERE SOURCDOC NOT IN (@l_cBBF, @l_cPANDL))  OPEN C1  FETCH NEXT FROM C1 INTO @JRNENTRY1, @SEQNUMBR1,@HSTYEAR1, @RCTRXSEQ1, @TRXSORCE1, @CRDTAMNT1, @DEBITAMT1,  @TRXDATE1,@CURNCYID1,@CURRNIDX1, @Ledger_ID1, @ACTINDX1,@SEQ1  while @@fetch_status = 0  Begin  UPDATE AAG40001 SET AA_CL_Status = 1   FROM AAG40001 A1 INNER JOIN AAG40000 A ON A1.aaGLHdrID = A.aaGLHdrID  WHERE A.JRNENTRY = @JRNENTRY1 AND A.RCTRXSEQ = @RCTRXSEQ1   AND A.YEAR1 = @HSTYEAR1 AND A.aaGLTRXSource = @TRXSORCE1 AND A1.ACTINDX = @ACTINDX1  AND A1.CRDTAMNT  = @CRDTAMNT1 AND A1.DEBITAMT = @DEBITAMT1 AND A.GLPOSTDT = @TRXDATE1   AND A1.CURNCYID = @CURNCYID1 AND A1.CURRNIDX = @CURRNIDX1 AND A.Ledger_ID = @Ledger_ID1  AND A1.SEQNUMBR=@SEQNUMBR1 AND A1.aaGLDistID = @SEQ1   FETCH NEXT FROM C1 INTO @JRNENTRY1, @SEQNUMBR1,@HSTYEAR1, @RCTRXSEQ1, @TRXSORCE1, @CRDTAMNT1, @DEBITAMT1,  @TRXDATE1,@CURNCYID1,@CURRNIDX1, @Ledger_ID1, @ACTINDX1,@SEQ1  END   close C1  deallocate C1   UPDATE AAG40001 SET AA_CL_Status = 1 WHERE SOURCDOC IN (@l_cBBF, @l_cPANDL)    IF @Preview = 1   BEGIN  EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID +  ''''+',''AA GL History Header Table'',''AA GL History Header ID=''+LTRIM(STR(A1.aaGLHdrID))+SPACE(3)+''Year=''+ LTRIM(STR(GL.HSTYEAR)),12,1,LTRIM(STR(GL.JRNENTRY))  FROM GL30000 GL INNER JOIN (SELECT A.aaGLHdrID,GL.HSTYEAR,A1.ACTINDX,A1.CRDTAMNT,A1.DEBITAMT,A1.SEQNUMBR,GL.TRXDATE,A1.CURNCYID,A1.CURRNIDX,A.GLPOSTDT FROM AAG40001 A1  INNER JOIN AAG40000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(A1.SOURCDOC)) = ''''  LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL30000   ) GL ON GL.JRNENTRY=A.JRNENTRY AND A.RCTRXSEQ = GL.RCTRXSEQ AND A.YEAR1 = GL.HSTYEAR  AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN('''+@l_cBBF+''', '''+@l_cPANDL+''') AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   AND GL.SEQNUMBR = A1.SEQNUMBR AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX  WHERE A1.aaGLDistID > 0 AND GL.JRNENTRY IS NULL AND A1.AA_CL_Status = 0) A1 ON A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   AND GL.SEQNUMBR = A1.SEQNUMBR  AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX')    EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID +  ''''+',''AA GL History Header Table'',''AA GL History Header ID=''+LTRIM(STR(A1.aaGLHdrID))+SPACE(3)+''Posting Date=''+ convert(char(12),GL.TRXDATE,102),17,1,LTRIM(STR(GL.JRNENTRY))  FROM AAG40000 A INNER JOIN AAG40001 A1 ON A.aaGLHdrID=A1.aaGLHdrID AND A1.AA_CL_Status = 0  INNER JOIN GL30000 GL ON A.JRNENTRY = GL.JRNENTRY  AND A.aaGLTRXSource = GL.TRXSORCE  AND A.RCTRXSEQ=GL.RCTRXSEQ AND A.YEAR1 = GL.HSTYEAR AND A.GLPOSTDT <> GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX')    EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Header Table'',''AA GL History Header ID=''+LTRIM(STR(A.aaGLHdrID))+SPACE(3)+''Ledger ID=''+(SELECT Ledger_Name FROM GL40001 WHERE GL40001.Ledger_ID = B.Ledger_ID),11,1,LTRIM(STR(B.JRNENTRY))  FROM AAG40000 A INNER JOIN GL30000 B ON A.JRNENTRY=B.JRNENTRY AND A.RCTRXSEQ=B.RCTRXSEQ AND   A.aaGLTRXSource=B.TRXSORCE AND A.YEAR1=B.HSTYEAR AND A.Ledger_ID <> B.Ledger_ID INNER JOIN AAG40001 A1 ON A.aaGLHdrID=A1.aaGLHdrID AND A1.AA_CL_Status = 0 AND A.GLPOSTDT = B.TRXDATE AND A1.CURNCYID = B.CURNCYID AND A1.CURRNIDX = B.CURRNIDX')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Header Table'',''AA GL History Header ID=''+LTRIM(STR(AA.aaGLHdrID))+SPACE(3)+''Transaction Source=''+GL.TRXSORCE,19,1,LTRIM(STR(AA.JRNENTRY))  FROM AAG40000 AA JOIN (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR FROM GL30000 GROUP BY JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR) AS  GL   ON AA.JRNENTRY = GL.JRNENTRY AND AA.RCTRXSEQ =GL.RCTRXSEQ AND AA.aaGLTRXSource <> GL.TRXSORCE AND HSTYEAR = YEAR1')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Distribution Table'',''AA GL History Header ID=''+LTRIM(STR(A.aaGLHdrID))+SPACE(1)+''Currency ID=''+ RTRIM(CONVERT(CHAR(12),B.CURNCYID))+ '' Currency Index='' + LTRIM(RTRIM(STR(B.CURRNIDX))),21,1,LTRIM(STR(A.JRNENTRY))   FROM AAG40000 A INNER JOIN GL30000 B ON A.JRNENTRY=B.JRNENTRY AND A.RCTRXSEQ=B.RCTRXSEQ AND A.aaGLTRXSource=B.TRXSORCE AND A.YEAR1=B.HSTYEAR  AND A.Ledger_ID = B.Ledger_ID   INNER JOIN AAG40001 A1 ON A.aaGLHdrID = A1.aaGLHdrID AND A1.AA_CL_Status = 0 AND A1.SEQNUMBR = B.SEQNUMBR AND A.GLPOSTDT = B.TRXDATE AND (A1.CURNCYID <> B.CURNCYID OR A1.CURRNIDX <> B.CURRNIDX)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Distribution Table'',''AA GL Open Header ID=''+LTRIM(STR(A1.aaGLHdrID )),15,1 ,LTRIM(STR(A.JRNENTRY))  FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID =A.aaGLHdrID INNER JOIN   (SELECT RANK() OVER (PARTITION BY GL.JRNENTRY,GL.OPENYEAR,GL.RCTRXSEQ,GL.TRXSORCE ORDER BY GL.SEQNUMBR ASC) ID,A1.SEQNUMBR AA_SEQNUMBR,GL.JRNENTRY,GL.TRXSORCE,GL.SOURCDOC,GL.ACTINDX,GL.CRDTAMNT,GL.DEBITAMT,GL.SEQNUMBR GL_SEQNUMBR, GL.RCTRXSEQ, GL.OPENYEAR,GL.TRXDATE,GL.CURNCYID,GL.CURRNIDX FROM AAG30001 A1   INNER JOIN AAG30000 A ON A1.aaGLHdrID =A.aaGLHdrID AND ltrim(rtrim(A1.SOURCDOC)) = ''''  AND A1.AA_CL_Status = 0  LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, OPENYEAR,TRXDATE,CURNCYID,CURRNIDX,RCTRXSEQ FROM GL20000) GL ON GL.JRNENTRY=A.JRNENTRY AND A.RCTRXSEQ = GL.RCTRXSEQ   AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''') AND A1.ACTINDX = GL.ACTINDX AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT AND A.YEAR1 = GL.OPENYEAR  ) GL on GL.JRNENTRY=A.JRNENTRY AND A1.ACTINDX = GL.ACTINDX AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT AND A.YEAR1 = GL.OPENYEAR   WHERE GL_SEQNUMBR <> AA_SEQNUMBR')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Distribution Table'',''AA GL History Header ID=''+LTRIM(STR(A1.aaGLHdrID )),15,1 ,LTRIM(STR(A.JRNENTRY))  FROM AAG40001 A1 INNER JOIN AAG40000 A ON A1.aaGLHdrID =A.aaGLHdrID INNER JOIN   (SELECT RANK() OVER (PARTITION BY GL.JRNENTRY,GL.HSTYEAR,GL.RCTRXSEQ,GL.TRXSORCE ORDER BY GL.SEQNUMBR ASC) ID,A1.SEQNUMBR AA_SEQNUMBR,GL.JRNENTRY,GL.TRXSORCE,GL.SOURCDOC,GL.ACTINDX,GL.CRDTAMNT,GL.DEBITAMT,GL.SEQNUMBR GL_SEQNUMBR, GL.RCTRXSEQ, GL.HSTYEAR,GL.TRXDATE,GL.CURNCYID,GL.CURRNIDX FROM AAG40001 A1   INNER JOIN AAG40000 A ON A1.aaGLHdrID =A.aaGLHdrID AND ltrim(rtrim(A1.SOURCDOC)) = ''''  AND A1.AA_CL_Status = 0  LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL30000) GL ON GL.JRNENTRY=A.JRNENTRY AND A.RCTRXSEQ = GL.RCTRXSEQ  AND A.YEAR1 = GL.HSTYEAR  AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''') AND A1.ACTINDX = GL.ACTINDX AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   ) GL on GL.JRNENTRY=A.JRNENTRY AND A1.ACTINDX = GL.ACTINDX AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT  AND A.YEAR1 = GL.HSTYEAR   WHERE GL_SEQNUMBR <> AA_SEQNUMBR')   IF NOT EXISTS (  SELECT TOP 1 1 FROM GL30000 GL INNER JOIN (SELECT GL.HSTYEAR,A1.ACTINDX,A1.CRDTAMNT,A1.DEBITAMT,A1.SEQNUMBR,GL.TRXDATE,A1.CURNCYID,A1.CURRNIDX,A.GLPOSTDT FROM AAG40001 A1  INNER JOIN AAG40000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(A1.SOURCDOC)) = ''  LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL30000   ) GL ON GL.JRNENTRY=A.JRNENTRY AND A.RCTRXSEQ = GL.RCTRXSEQ AND A.YEAR1 = GL.HSTYEAR  AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(@l_cBBF, @l_cPANDL) AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   AND GL.SEQNUMBR = A1.SEQNUMBR  AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX AND A.YEAR1 = GL.HSTYEAR  WHERE A1.aaGLDistID > 0 AND GL.JRNENTRY IS NULL AND A1.AA_CL_Status = 0) A1 ON A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   AND GL.SEQNUMBR = A1.SEQNUMBR  AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX  UNION  SELECT TOP 1 1 FROM AAG40001 A1 INNER JOIN AAG40000 A ON A1.aaGLHdrID =A.aaGLHdrID INNER JOIN   (SELECT RANK() OVER (PARTITION BY GL.JRNENTRY,GL.HSTYEAR,GL.RCTRXSEQ,GL.TRXSORCE ORDER BY GL.SEQNUMBR ASC) ID,A1.SEQNUMBR AA_SEQNUMBR,GL.JRNENTRY,GL.TRXSORCE,GL.SOURCDOC,GL.ACTINDX,GL.CRDTAMNT,GL.DEBITAMT,GL.SEQNUMBR GL_SEQNUMBR, GL.RCTRXSEQ, GL.HSTYEAR,GL.TRXDATE,GL.CURNCYID,GL.CURRNIDX FROM AAG40001 A1   INNER JOIN AAG40000 A ON A1.aaGLHdrID =A.aaGLHdrID AND ltrim(rtrim(A1.SOURCDOC)) = ''  AND A1.AA_CL_Status = 0  LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL30000) GL ON GL.JRNENTRY=A.JRNENTRY AND A.RCTRXSEQ = GL.RCTRXSEQ  AND A.YEAR1 = GL.HSTYEAR  AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(@l_cBBF, @l_cPANDL) AND A1.ACTINDX = GL.ACTINDX AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT  
 ) GL on GL.JRNENTRY=A.JRNENTRY AND A1.ACTINDX = GL.ACTINDX AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT  AND A.YEAR1 = GL.HSTYEAR AND A1.aaGLDistID = GL.ID  WHERE GL_SEQNUMBR <> AA_SEQNUMBR)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Distribution Table'',''AA GL History Header ID=''+LTRIM(STR(A1.aaGLHdrID ))+SPACE(3)+''AA GL History Distribution ID=''+LTRIM(STR(A1.aaGLDistID )),10,1,LTRIM(STR(A.JRNENTRY))   FROM AAG40001 A1 INNER JOIN AAG40000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(A1.SOURCDOC)) = '''' LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL30000   ) GL ON GL.JRNENTRY=A.JRNENTRY AND A.RCTRXSEQ = GL.RCTRXSEQ AND A.YEAR1 = GL.HSTYEAR  AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''') AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX   AND GL.SEQNUMBR = A1.SEQNUMBR   WHERE A1.aaGLDistID > 0 AND GL.JRNENTRY IS NULL AND A1.AA_CL_Status = 0')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40002.aaGLHdrID)) ),-9999)  FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40002.aaGLHdrID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40003.aaGLHdrID)) ),-9999)  FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40003.aaGLHdrID=AAG40003.aaGLHdrID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Distribution Table'',''AA GL History Header ID=''+LTRIM(STR(A1.aaGLHdrID ))+SPACE(3)+''AA GL History Distribution ID=''+LTRIM(STR(A1.aaGLDistID )),10,1 ,LTRIM(STR(A.JRNENTRY))  FROM AAG40001 A1 INNER JOIN AAG40000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(A1.SOURCDOC)) = '''' LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL30000   ) GL ON GL.JRNENTRY=A.JRNENTRY AND A1.SEQNUMBR=GL.SEQNUMBR AND A.RCTRXSEQ = GL.RCTRXSEQ  AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX  AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''') AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   WHERE A1.aaGLDistID >   (SELECT count(JRNENTRY) FROM   (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR, TRXDATE, CURNCYID, CURRNIDX FROM GL30000) C   WHERE C.JRNENTRY = A.JRNENTRY AND C.TRXSORCE =A.aaGLTRXSource AND A.RCTRXSEQ = C.RCTRXSEQ AND A.GLPOSTDT = C.TRXDATE AND A1.CURNCYID = C.CURNCYID AND A1.CURRNIDX = C.CURRNIDX  AND C.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''')) AND A1.AA_CL_Status = 0')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40002.aaGLHdrID)) ),-9999)  FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40002.aaGLHdrID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40003.aaGLHdrID)) ),-9999)  FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40003.aaGLHdrID=AAG40003.aaGLHdrID)')   IF NOT EXISTS (SELECT TOP 1 1 FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID =A.aaGLHdrID INNER JOIN   (SELECT RANK() OVER (PARTITION BY GL.JRNENTRY,GL.OPENYEAR,GL.RCTRXSEQ,GL.TRXSORCE ORDER BY GL.SEQNUMBR ASC) ID,A1.SEQNUMBR AA_SEQNUMBR,GL.JRNENTRY,GL.TRXSORCE,GL.SOURCDOC,GL.ACTINDX,GL.CRDTAMNT,GL.DEBITAMT,GL.SEQNUMBR GL_SEQNUMBR, GL.RCTRXSEQ, GL.OPENYEAR,GL.TRXDATE,GL.CURNCYID,GL.CURRNIDX FROM AAG30001 A1   INNER JOIN AAG30000 A ON A1.aaGLHdrID =A.aaGLHdrID AND ltrim(rtrim(A1.SOURCDOC)) = ''  AND A1.AA_CL_Status = 0  LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, OPENYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL20000) GL ON GL.JRNENTRY=A.JRNENTRY AND A.RCTRXSEQ = GL.RCTRXSEQ   AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(@l_cBBF, @l_cPANDL) AND A1.ACTINDX = GL.ACTINDX AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT AND A.YEAR1 = GL.OPENYEAR  ) GL on GL.JRNENTRY=A.JRNENTRY AND A1.ACTINDX = GL.ACTINDX AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT AND A.YEAR1 = GL.OPENYEAR  WHERE GL_SEQNUMBR <> AA_SEQNUMBR)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Distribution Table'',''AA GL Open Header ID=''+LTRIM(STR(A1.aaGLHdrID ))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(A1.aaGLDistID )),10,1 ,LTRIM(STR(A.JRNENTRY))  FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(A1.SOURCDOC)) = '''' LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, OPENYEAR YEAR1,TRXDATE,CURNCYID,CURRNIDX FROM GL20000 UNION ALL SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR YEAR1,TRXDATE,CURNCYID,CURRNIDX FROM GL30000   ) GL ON GL.JRNENTRY=A.JRNENTRY AND A.RCTRXSEQ = GL.RCTRXSEQ   AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''') AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   AND GL.SEQNUMBR = A1.SEQNUMBR AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX  WHERE A1.aaGLDistID > 0 AND GL.JRNENTRY IS NULL AND A1.AA_CL_Status = 0')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30002.aaGLHdrID)) ),-9999)  FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30002.aaGLHdrID AND AAG30001.aaGLDistID=AAG30002.aaGLDistID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30003.aaGLHdrID AND AAG30001.aaGLDistID=AAG30003.aaGLDistID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Distribution Table'',''AA GL Open Header ID=''+LTRIM(STR(A1.aaGLHdrID ))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(A1.aaGLDistID )),1,1,LTRIM(STR(A.JRNENTRY))   FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID =A.aaGLHdrID AND A1.AA_CL_Status = 0 and ltrim(rtrim(SOURCDOC)) = ''''   LEFT JOIN (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR  FROM GL20000 UNION ALL SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR  FROM GL30000) GL   ON GL.JRNENTRY=A.JRNENTRY   AND A1.SEQNUMBR=GL.SEQNUMBR  AND GL.TRXSORCE =A.aaGLTRXSource   AND A.RCTRXSEQ = GL.RCTRXSEQ  AND A.YEAR1 = GL.YEAR1  AND A.GLPOSTDT = GL.TRXDATE   AND A1.CURNCYID = GL.CURNCYID   AND A1.CURRNIDX = GL.CURRNIDX  AND GL.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''') AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   WHERE A1.aaGLDistID > ( SELECT count(JRNENTRY) FROM (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC  FROM GL20000 UNION ALL SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC  FROM GL30000) C   WHERE C.JRNENTRY = A.JRNENTRY   AND C.TRXSORCE =A.aaGLTRXSource   AND A.RCTRXSEQ = C.RCTRXSEQ  AND A.YEAR1 = C.YEAR1  AND A.GLPOSTDT = C.TRXDATE   AND A1.CURNCYID = C.CURNCYID   AND A1.CURRNIDX = C.CURRNIDX  AND C.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + '''))')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Distribution Table'',''AA GL Open Header ID=''+LTRIM(STR(A1.aaGLHdrID ))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(A1.aaGLDistID )),10,1,LTRIM(STR(A.JRNENTRY))  FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(A1.SOURCDOC)) = '''' LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, OPENYEAR YEAR1,TRXDATE,CURNCYID,CURRNIDX FROM GL20000 UNION ALL SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR YEAR1,TRXDATE,CURNCYID,CURRNIDX FROM GL30000   ) GL ON GL.JRNENTRY=A.JRNENTRY AND A1.SEQNUMBR=GL.SEQNUMBR AND A.RCTRXSEQ = GL.RCTRXSEQ AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX  AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''') AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   WHERE A1.aaGLDistID >   (SELECT count(JRNENTRY) FROM   (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, OPENYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX FROM GL20000 UNION ALL SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX FROM GL30000) C   WHERE C.JRNENTRY = A.JRNENTRY AND C.TRXSORCE =A.aaGLTRXSource AND A.RCTRXSEQ = C.RCTRXSEQ AND A.GLPOSTDT = C.TRXDATE AND A1.CURNCYID = C.CURNCYID AND A1.CURRNIDX = C.CURRNIDX  AND C.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''')) AND A1.AA_CL_Status = 0')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30002.aaGLHdrID)) ),-9999)  FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30002.aaGLHdrID AND AAG30001.aaGLDistID=AAG30002.aaGLDistID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30003.aaGLHdrID AND AAG30001.aaGLDistID=AAG30003.aaGLDistID)')   END  ELSE  BEGIN   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID +  ''''+',''AA GL History Header Table'',''AA GL History Header ID=''+LTRIM(STR(AAG41.aaGLHdrID))+SPACE(3)+''Year=''+ LTRIM(STR(GL.HSTYEAR)),13,1,LTRIM(STR(AAG4.JRNENTRY))  FROM AAG40000 AAG4 INNER JOIN AAG40001 AAG41 ON AAG4.aaGLHdrID = AAG41.aaGLHdrID  INNER JOIN (  SELECT A1.YEAR1 , GL.HSTYEAR,A1.aaGLHdrID,A1.ACTINDX,A1.CRDTAMNT,A1.DEBITAMT,A1.SEQNUMBR,A1.CURRNIDX,GL.CURNCYID FROM GL30000 GL INNER JOIN   (SELECT GL.HSTYEAR,A.YEAR1,A.aaGLHdrID,A1.ACTINDX,A1.CRDTAMNT,A1.DEBITAMT,A1.SEQNUMBR,GL.TRXDATE,A1.CURNCYID,A1.CURRNIDX,A.GLPOSTDT FROM AAG40001 A1  INNER JOIN AAG40000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(A1.SOURCDOC)) = ''''  LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL30000   ) GL ON GL.JRNENTRY=A.JRNENTRY AND A.RCTRXSEQ = GL.RCTRXSEQ AND A.YEAR1 = GL.HSTYEAR  AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN('''+@l_cBBF+''', '''+@l_cPANDL+''') AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   AND GL.SEQNUMBR = A1.SEQNUMBR  AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX  WHERE A1.aaGLDistID > 0 AND GL.JRNENTRY IS NULL AND A1.AA_CL_Status = 0) A1 ON A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   AND GL.SEQNUMBR = A1.SEQNUMBR  AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX AND GL.HSTYEAR <> A1.YEAR1) GL  ON AAG41.ACTINDX = GL.ACTINDX AND AAG41.CRDTAMNT  = GL.CRDTAMNT AND AAG41.DEBITAMT = GL.DEBITAMT AND GL.SEQNUMBR = AAG41.SEQNUMBR   AND AAG41.CURNCYID = GL.CURNCYID AND AAG41.CURRNIDX = GL.CURRNIDX AND  GL.HSTYEAR <> AAG4.YEAR1 AND GL.YEAR1= AAG4.YEAR1   AND AAG4.aaGLHdrID = GL.aaGLHdrID')   UPDATE AAG40000 SET AAG40000.YEAR1 = GL.HSTYEAR FROM AAG40000 AAG4   INNER JOIN AAG40001 AAG41 ON AAG4.aaGLHdrID = AAG41.aaGLHdrID  INNER JOIN (  SELECT A1.YEAR1 , GL.HSTYEAR,A1.aaGLHdrID,A1.ACTINDX,A1.CRDTAMNT,A1.DEBITAMT,A1.SEQNUMBR,A1.CURRNIDX,GL.CURNCYID FROM GL30000 GL INNER JOIN   (SELECT GL.HSTYEAR,A.YEAR1,A.aaGLHdrID,A1.ACTINDX,A1.CRDTAMNT,A1.DEBITAMT,A1.SEQNUMBR,GL.TRXDATE,A1.CURNCYID,A1.CURRNIDX,A.GLPOSTDT FROM AAG40001 A1  INNER JOIN AAG40000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(A1.SOURCDOC)) = ''  LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL30000   ) GL ON GL.JRNENTRY=A.JRNENTRY AND A.RCTRXSEQ = GL.RCTRXSEQ AND A.YEAR1 = GL.HSTYEAR  AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(@l_cBBF,@l_cPANDL) AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   AND GL.SEQNUMBR = A1.SEQNUMBR  AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX  WHERE A1.aaGLDistID > 0 AND GL.JRNENTRY IS NULL AND A1.AA_CL_Status = 0) A1 ON A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   AND GL.SEQNUMBR = A1.SEQNUMBR  AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX AND GL.HSTYEAR <> A1.YEAR1) GL  ON AAG41.ACTINDX = GL.ACTINDX AND AAG41.CRDTAMNT  = GL.CRDTAMNT AND AAG41.DEBITAMT = GL.DEBITAMT AND GL.SEQNUMBR = AAG41.SEQNUMBR   AND AAG41.CURNCYID = GL.CURNCYID AND AAG41.CURRNIDX = GL.CURRNIDX AND  GL.HSTYEAR <> AAG4.YEAR1 AND GL.YEAR1= AAG4.YEAR1   AND AAG4.aaGLHdrID = GL.aaGLHdrID   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID +  ''''+',''AA GL History Header Table'',''AA GL History Header ID=''+LTRIM(STR(A1.aaGLHdrID))+SPACE(3)+''Posting Date=''+ convert(char(12),GL.TRXDATE,102),16,1,LTRIM(STR(GL.JRNENTRY))  FROM AAG40000 A INNER JOIN AAG40001 A1 ON A.aaGLHdrID=A1.aaGLHdrID AND A1.AA_CL_Status = 0   INNER JOIN GL30000 GL ON A.JRNENTRY = GL.JRNENTRY AND A.aaGLTRXSource = GL.TRXSORCE AND A.RCTRXSEQ=GL.RCTRXSEQ   AND A.YEAR1 = GL.HSTYEAR AND A.GLPOSTDT <> GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX')    UPDATE AAG40000 SET AAG40000.GLPOSTDT = GL.TRXDATE FROM AAG40000 A INNER JOIN AAG40001 A1 ON A.aaGLHdrID=A1.aaGLHdrID AND A1.AA_CL_Status = 0  INNER JOIN GL30000 GL ON A.JRNENTRY = GL.JRNENTRY AND A.aaGLTRXSource = GL.TRXSORCE AND A.RCTRXSEQ=GL.RCTRXSEQ   AND A.YEAR1 = GL.HSTYEAR AND A.GLPOSTDT <> GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX  EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Header Table'',''AA GL History Header ID=''+LTRIM(STR(A.aaGLHdrID))+SPACE(3)+''Ledger ID=''+(SELECT Ledger_Name FROM GL40001 WHERE GL40001.Ledger_ID = B.Ledger_ID),8,1,LTRIM(STR(A.JRNENTRY))   FROM AAG40000 A INNER JOIN GL30000 B ON A.JRNENTRY=B.JRNENTRY AND A.RCTRXSEQ=B.RCTRXSEQ AND   A.aaGLTRXSource=B.TRXSORCE AND A.YEAR1=B.HSTYEAR AND A.Ledger_ID <> B.Ledger_ID INNER JOIN AAG40001 A1 ON A.aaGLHdrID=A1.aaGLHdrID AND A1.AA_CL_Status = 0 AND A.GLPOSTDT = B.TRXDATE AND A1.CURNCYID = B.CURNCYID AND A1.CURRNIDX = B.CURRNIDX')   UPDATE AAG40000 set AAG40000.Ledger_ID = B.Ledger_ID  FROM AAG40000 A INNER JOIN GL30000 B ON A.JRNENTRY=B.JRNENTRY AND A.RCTRXSEQ=B.RCTRXSEQ AND   A.aaGLTRXSource=B.TRXSORCE AND A.YEAR1=B.HSTYEAR AND A.Ledger_ID<>B.Ledger_ID INNER JOIN AAG40001 A1 ON A.aaGLHdrID=A1.aaGLHdrID AND A1.AA_CL_Status = 0 AND A.GLPOSTDT = B.TRXDATE AND A1.CURNCYID = B.CURNCYID AND A1.CURRNIDX = B.CURRNIDX  EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Header Table'',''AA GL History Header ID=''+LTRIM(STR(AA.aaGLHdrID))+SPACE(3)+''Transaction Source=''+GL.TRXSORCE,18,1,LTRIM(STR(AA.JRNENTRY))  FROM AAG40000 AA JOIN (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR FROM GL30000 GROUP BY JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR) AS  GL   ON AA.JRNENTRY = GL.JRNENTRY AND AA.RCTRXSEQ =GL.RCTRXSEQ AND AA.aaGLTRXSource <> GL.TRXSORCE AND HSTYEAR = YEAR1')  UPDATE AAG40000 SET aaGLTRXSource = GL.TRXSORCE   FROM AAG40000 AA JOIN (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR FROM GL30000 GROUP BY JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR) AS  GL   ON AA.JRNENTRY = GL.JRNENTRY AND AA.RCTRXSEQ =GL.RCTRXSEQ AND AA.aaGLTRXSource <> GL.TRXSORCE AND HSTYEAR = YEAR1   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Distribution Table'',''AA GL History Header ID=''+LTRIM(STR(A.aaGLHdrID))+SPACE(1)+''Currency ID=''+ RTRIM(CONVERT(CHAR(12),B.CURNCYID))+ '' Currency Index='' + LTRIM(RTRIM(STR(B.CURRNIDX))),20,1,LTRIM(STR(A.JRNENTRY))   FROM AAG40000 A INNER JOIN GL30000 B ON A.JRNENTRY=B.JRNENTRY AND A.RCTRXSEQ=B.RCTRXSEQ AND A.aaGLTRXSource=B.TRXSORCE AND A.YEAR1=B.HSTYEAR  AND A.Ledger_ID = B.Ledger_ID   INNER JOIN AAG40001 A1 ON A.aaGLHdrID = A1.aaGLHdrID AND A1.AA_CL_Status = 0 AND A1.SEQNUMBR = B.SEQNUMBR AND A.GLPOSTDT = B.TRXDATE AND (A1.CURNCYID <> B.CURNCYID OR A1.CURRNIDX <> B.CURRNIDX)')   UPDATE AAG40001 set AAG40001.CURNCYID = B.CURNCYID, AAG40001.CURRNIDX = B.CURRNIDX  FROM AAG40000 A INNER JOIN GL30000 B ON A.JRNENTRY=B.JRNENTRY AND A.RCTRXSEQ=B.RCTRXSEQ AND A.aaGLTRXSource=B.TRXSORCE AND A.YEAR1=B.HSTYEAR  AND A.Ledger_ID = B.Ledger_ID   INNER JOIN AAG40001 A1 ON A.aaGLHdrID = A1.aaGLHdrID AND A1.AA_CL_Status = 0 AND A1.SEQNUMBR = B.SEQNUMBR AND A.GLPOSTDT = B.TRXDATE AND (A1.CURNCYID <> B.CURNCYID OR A1.CURRNIDX <> B.CURRNIDX)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Distribution Table'',''AA GL Open Header ID=''+LTRIM(STR(A1.aaGLHdrID )),14,1 ,LTRIM(STR(A.JRNENTRY))  FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID =A.aaGLHdrID INNER JOIN   (SELECT RANK() OVER (PARTITION BY GL.JRNENTRY,GL.OPENYEAR,GL.RCTRXSEQ,GL.TRXSORCE ORDER BY GL.SEQNUMBR ASC) ID,A1.SEQNUMBR AA_SEQNUMBR,GL.JRNENTRY,GL.TRXSORCE,GL.SOURCDOC,GL.ACTINDX,GL.CRDTAMNT,GL.DEBITAMT,GL.SEQNUMBR GL_SEQNUMBR, GL.RCTRXSEQ, GL.OPENYEAR,GL.TRXDATE,GL.CURNCYID,GL.CURRNIDX FROM AAG30001 A1   INNER JOIN AAG30000 A ON A1.aaGLHdrID =A.aaGLHdrID AND ltrim(rtrim(A1.SOURCDOC)) = ''''  AND A1.AA_CL_Status = 0  LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, OPENYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL20000) GL ON GL.JRNENTRY=A.JRNENTRY AND A.RCTRXSEQ = GL.RCTRXSEQ   AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''') AND A1.ACTINDX = GL.ACTINDX AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT AND A.YEAR1 = GL.OPENYEAR  ) GL on GL.JRNENTRY=A.JRNENTRY AND A1.ACTINDX = GL.ACTINDX AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT AND A.YEAR1 = GL.OPENYEAR  WHERE GL_SEQNUMBR <> AA_SEQNUMBR')   UPDATE AAG30001 SET AAG30001.SEQNUMBR = GL.SEQNUMBR from (SELECT JRNENTRY,SEQNUMBR,OPENYEAR,RCTRXSEQ,TRXSORCE,CRDTAMNT,   DEBITAMT,TRXDATE,CURNCYID,CURRNIDX,Ledger_ID,ACTINDX,   RANK() OVER (PARTITION BY JRNENTRY, OPENYEAR, RCTRXSEQ, TRXSORCE,CRDTAMNT,DEBITAMT, TRXDATE, CURNCYID, CURRNIDX, ACTINDX, Ledger_ID   ORDER BY SEQNUMBR ASC) AS DistNum   FROM   GL20000) GL   INNER JOIN (SELECT AA0.aaGLHdrID,AA1.aaGLDistID,JRNENTRY,SEQNUMBR,YEAR1,RCTRXSEQ,   aaGLTRXSource,CRDTAMNT,DEBITAMT,GLPOSTDT,CURNCYID,CURRNIDX,  Ledger_ID,ACTINDX,  RANK() OVER (PARTITION BY JRNENTRY, YEAR1, RCTRXSEQ, aaGLTRXSource,CRDTAMNT,DEBITAMT, GLPOSTDT, CURRNIDX, ACTINDX, Ledger_ID   ORDER BY aaGLDistID ASC) AS DistNum   FROM   AAG30000 AA0   INNER JOIN AAG30001 AA1   ON AA0.aaGLHdrID = AA1.aaGLHdrID) AA   ON GL.JRNENTRY = AA.JRNENTRY   AND GL.OPENYEAR = AA.YEAR1   AND GL.TRXSORCE = AA.aaGLTRXSource   AND GL.RCTRXSEQ = AA.RCTRXSEQ   AND GL.TRXDATE = AA.GLPOSTDT   AND GL.ACTINDX = AA.ACTINDX   AND GL.DEBITAMT = AA.DEBITAMT   AND GL.CRDTAMNT = AA.CRDTAMNT   AND GL.CURNCYID = AA.CURNCYID   AND GL.Ledger_ID = AA.Ledger_ID   AND GL.DistNum = AA.DistNum   INNER JOIN AAG30001 AA31   ON AA.aaGLHdrID = AA31.aaGLHdrID   AND AA.aaGLDistID = AA31.aaGLDistID   where  GL.SEQNUMBR <> AA.SEQNUMBR and AA31.AA_CL_Status=0   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Distribution Table'',''AA GL History Header ID=''+LTRIM(STR(A1.aaGLHdrID )),14,1 ,LTRIM(STR(A.JRNENTRY))  FROM AAG40001 A1 INNER JOIN AAG40000 A ON A1.aaGLHdrID =A.aaGLHdrID INNER JOIN   (SELECT RANK() OVER (PARTITION BY GL.JRNENTRY,GL.HSTYEAR,GL.RCTRXSEQ,GL.TRXSORCE ORDER BY GL.SEQNUMBR ASC) ID,A1.SEQNUMBR AA_SEQNUMBR,GL.JRNENTRY,GL.TRXSORCE,GL.SOURCDOC,GL.ACTINDX,GL.CRDTAMNT,GL.DEBITAMT,GL.SEQNUMBR GL_SEQNUMBR, GL.RCTRXSEQ, GL.HSTYEAR,GL.TRXDATE,GL.CURNCYID,GL.CURRNIDX FROM AAG40001 A1   INNER JOIN AAG40000 A ON A1.aaGLHdrID =A.aaGLHdrID AND ltrim(rtrim(A1.SOURCDOC)) = ''''  AND A1.AA_CL_Status = 0  LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL30000) GL ON GL.JRNENTRY=A.JRNENTRY AND A.RCTRXSEQ = GL.RCTRXSEQ  AND A.YEAR1 = GL.HSTYEAR  AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''') AND A1.ACTINDX = GL.ACTINDX AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   ) GL on GL.JRNENTRY=A.JRNENTRY AND A1.ACTINDX = GL.ACTINDX AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT  AND A.YEAR1 = GL.HSTYEAR   WHERE GL_SEQNUMBR <> AA_SEQNUMBR')   UPDATE AAG40001 SET AAG40001.SEQNUMBR = GL.SEQNUMBR FROM (SELECT JRNENTRY,SEQNUMBR,HSTYEAR,RCTRXSEQ,TRXSORCE,CRDTAMNT,   DEBITAMT,TRXDATE,CURNCYID,CURRNIDX,Ledger_ID,ACTINDX,   RANK() OVER (PARTITION BY JRNENTRY, HSTYEAR, RCTRXSEQ, TRXSORCE,CRDTAMNT,DEBITAMT, TRXDATE, CURNCYID, CURRNIDX, ACTINDX, Ledger_ID   ORDER BY SEQNUMBR ASC) AS DistNum   FROM   GL30000) GL   INNER JOIN (SELECT AA0.aaGLHdrID,AA1.aaGLDistID,JRNENTRY,SEQNUMBR,YEAR1,RCTRXSEQ,   aaGLTRXSource,CRDTAMNT,DEBITAMT,GLPOSTDT,CURNCYID,CURRNIDX,  Ledger_ID,ACTINDX,  RANK() OVER (PARTITION BY JRNENTRY, YEAR1, RCTRXSEQ, aaGLTRXSource,CRDTAMNT,DEBITAMT, GLPOSTDT, CURRNIDX, ACTINDX, Ledger_ID   ORDER BY aaGLDistID ASC) AS DistNum   FROM   AAG40000 AA0   INNER JOIN AAG40001 AA1   ON AA0.aaGLHdrID = AA1.aaGLHdrID) AA   ON GL.JRNENTRY = AA.JRNENTRY   AND GL.HSTYEAR = AA.YEAR1   AND GL.TRXSORCE = AA.aaGLTRXSource   AND GL.RCTRXSEQ = AA.RCTRXSEQ   AND GL.TRXDATE = AA.GLPOSTDT   AND GL.ACTINDX = AA.ACTINDX   AND GL.DEBITAMT = AA.DEBITAMT   AND GL.CRDTAMNT = AA.CRDTAMNT   AND GL.CURNCYID = AA.CURNCYID   AND GL.Ledger_ID = AA.Ledger_ID   AND GL.DistNum = AA.DistNum   INNER JOIN AAG40001 AA41   ON AA.aaGLHdrID = AA41.aaGLHdrID   AND AA.aaGLDistID = AA41.aaGLDistID   WHERE  GL.SEQNUMBR <> AA.SEQNUMBR and AA41.AA_CL_Status=0   DECLARE CGLOpenBKout CURSOR FAST_FORWARD  FOR   (SELECT DISTINCT A.JRNENTRY,A.aaGLHdrID,A.aaGLTRXSource, A.RCTRXSEQ, A.YEAR1 FROM AAG40001 A1 INNER JOIN AAG40000 A ON A1.aaGLHdrID = A.aaGLHdrID  INNER JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR,Original_JE, RCTRXSEQ, HSTYEAR FROM GL30000   ) B on   A.aaGLTRXSource =B.TRXSORCE and B.SOURCDOC <> @l_cPANDL and B.SOURCDOC <> @l_cBBF and A.JRNENTRY = B.JRNENTRY AND  A.RCTRXSEQ=B.RCTRXSEQ AND  A.YEAR1=B.HSTYEAR  where B.Original_JE <>0)  for read only  open CGLOpenBKout  fetch next from CGLOpenBKout into @JRNENTRY,@aaGLHdrID,@GLTrxSource, @l_RCTRXSEQ, @l_YEAR1  while @@fetch_status = 0  Begin   if (select min(SEQNUMBR)from AAG40001 where aaGLHdrID = @aaGLHdrID) <>   (select  min(SEQNUMBR) from GL30000   where JRNENTRY =   (select JRNENTRY from AAG40000   where aaGLHdrID = @aaGLHdrID)   and TRXSORCE = @GLTrxSource AND RCTRXSEQ = @l_RCTRXSEQ AND HSTYEAR = @l_YEAR1)  Begin  select  @cnt=count(JRNENTRY) from GL30000   where JRNENTRY = (select JRNENTRY from AAG40000 where aaGLHdrID = @aaGLHdrID)   and TRXSORCE = @GLTrxSource AND RCTRXSEQ = @l_RCTRXSEQ AND HSTYEAR = @l_YEAR1   set @i=1  while @i<=@cnt  Begin  if exists(select SEQNUMBR from GL30000   where JRNENTRY = (select JRNENTRY from AAG40000 where aaGLHdrID = @aaGLHdrID)  and TRXSORCE = @GLTrxSource   AND RCTRXSEQ = @l_RCTRXSEQ   AND HSTYEAR = @l_YEAR1  and OrigSeqNum = (select SEQNUMBR from AAG40001 where aaGLHdrID = @aaGLHdrID and aaGLDistID = @i))  Update AAG40001 set SEQNUMBR=   (select SEQNUMBR from GL30000   where JRNENTRY = (select JRNENTRY from AAG40000   where aaGLHdrID = @aaGLHdrID)   and TRXSORCE = @GLTrxSource  and RCTRXSEQ = @l_RCTRXSEQ   AND HSTYEAR = @l_YEAR1   AND OrigSeqNum = (select SEQNUMBR from AAG40001   where aaGLHdrID = @aaGLHdrID and aaGLDistID = @i))   where aaGLHdrID = @aaGLHdrID and aaGLDistID = @i   set @i=@i+1  End  End  fetch next from CGLOpenBKout into  @JRNENTRY, @aaGLHdrID, @GLTrxSource, @l_RCTRXSEQ, @l_YEAR1  End   CLOSE CGLOpenBKout  DEALLOCATE CGLOpenBKout   Delete AAG40001  from AAG40001 A inner join   (select MIN(DEX_ROW_ID) as DEX_ROW_ID,count(1) as COUNT1, aaGLHdrID, SEQNUMBR from AAG40001 where ltrim(rtrim(SOURCDOC)) = ''   group by aaGLHdrID, SEQNUMBR having count(1) > 1) B on A.aaGLHdrID = B.aaGLHdrID   and A.SEQNUMBR = B.SEQNUMBR where A.DEX_ROW_ID <> B.DEX_ROW_ID and A.ACCTTYPE<>3 and A.aaGLHdrID  not in (   select distinct A0.aaGLHdrID from AAG40000 A0 inner join (SELECT JRNENTRY,TRXSORCE,SOURCDOC,SEQNUMBR,DEX_ROW_ID, RCTRXSEQ, HSTYEAR FROM GL30000   ) GL on A0.aaGLTRXSource =GL.TRXSORCE and GL.SOURCDOC not IN(@l_cBBF, @l_cPANDL)   and A0.JRNENTRY = GL.JRNENTRY AND  A0.RCTRXSEQ=GL.RCTRXSEQ AND  A0.YEAR1=GL.HSTYEAR inner join   (select MIN(B1.DEX_ROW_ID) as DEX_ROW_ID,count(1) as COUNT1,B1.TRXSORCE, B1.JRNENTRY, B1.SEQNUMBR, B1.RCTRXSEQ, B1.HSTYEAR from   (SELECT JRNENTRY,TRXSORCE,SEQNUMBR,DEX_ROW_ID, RCTRXSEQ, HSTYEAR FROM GL30000 ) B1   group by B1.JRNENTRY,B1.TRXSORCE, B1.SEQNUMBR, B1.RCTRXSEQ, B1.HSTYEAR having count(1) > 1) B2 on GL.JRNENTRY = B2.JRNENTRY   and GL.TRXSORCE = B2.TRXSORCE   and GL.RCTRXSEQ = B2.RCTRXSEQ   and GL.HSTYEAR = B2.HSTYEAR   and GL.SEQNUMBR = B2.SEQNUMBR  where GL.DEX_ROW_ID <> B2.DEX_ROW_ID )    EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40002.aaGLHdrID)) ),-9999)  FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40002.aaGLHdrID)')   DELETE AAG40002 FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40002.aaGLHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40003.aaGLHdrID)) ),-9999)  FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40003.aaGLHdrID=AAG40003.aaGLHdrID)')   DELETE AAG40003 FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40003.aaGLHdrID=AAG40003.aaGLHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Distribution Table'',''AA GL History Header ID=''+LTRIM(STR(A1.aaGLHdrID ))+SPACE(3)+''AA GL History Distribution ID=''+LTRIM(STR(A1.aaGLDistID )),4,1,LTRIM(STR(A.JRNENTRY))  FROM AAG40001 A1 INNER JOIN AAG40000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(A1.SOURCDOC)) = '''' LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL30000   ) GL ON GL.JRNENTRY=A.JRNENTRY AND A.RCTRXSEQ = GL.RCTRXSEQ AND A.YEAR1 = GL.HSTYEAR  AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''') AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   AND GL.SEQNUMBR = A1.SEQNUMBR  AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX  WHERE A1.aaGLDistID > 0 AND GL.JRNENTRY IS NULL AND A1.AA_CL_Status = 0')   DELETE AAG40001  FROM AAG40001 A1 INNER JOIN AAG40000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(A1.SOURCDOC)) = '' LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL30000   ) GL ON GL.JRNENTRY=A.JRNENTRY AND A.RCTRXSEQ = GL.RCTRXSEQ AND A.YEAR1 = GL.HSTYEAR  AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(@l_cBBF, @l_cPANDL)   AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   AND GL.SEQNUMBR = A1.SEQNUMBR  AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX  WHERE A1.aaGLDistID > 0 AND GL.JRNENTRY IS NULL AND A1.AA_CL_Status = 0   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40002.aaGLHdrID)) ),-9999)  FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40002.aaGLHdrID AND AAG40001.aaGLDistID=AAG40002.aaGLDistID)')   DELETE AAG40002 FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40002.aaGLHdrID AND AAG40001.aaGLDistID=AAG40002.aaGLDistID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40003.aaGLHdrID)) ),-9999)  FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40003.aaGLHdrID=AAG40001.aaGLHdrID AND AAG40001.aaGLDistID=AAG40003.aaGLDistID)')   DELETE AAG40003 FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40003.aaGLHdrID=AAG40001.aaGLHdrID AND AAG40001.aaGLDistID=AAG40003.aaGLDistID)   BEGIN  UPDATE AAG40001 SET aaGLDistID=0-ABS(aaGLDistID)   UPDATE AAG40002 SET aaGLDistID=0-ABS(aaGLDistID)   UPDATE AAG40003 SET aaGLDistID=0-ABS(aaGLDistID)   UPDATE AAG40003 SET aaGLDistID = a.ID FROM (  SELECT RANK() OVER (PARTITION BY AAG40001.aaGLHdrID ORDER BY SEQNUMBR,AAG40001.DEX_ROW_ID ASC) ID,AAG40001.aaGLHdrID,aaGLDistID from AAG40001 WHERE SOURCDOC = '' group by AAG40001.aaGLHdrID,SEQNUMBR,aaGLDistID,AAG40001.DEX_ROW_ID  ) a INNER JOIN AAG40001 A1 ON A1.aaGLHdrID = a.aaGLHdrID AND A1.aaGLDistID = a.aaGLDistID  INNER JOIN AAG40003 A3 ON A3.aaGLHdrID = A1.aaGLHdrID AND A3.aaGLDistID = A1.aaGLDistID AND A1.SOURCDOC = ''   UPDATE AAG40002 SET aaGLDistID = a.ID FROM (  SELECT RANK() OVER (PARTITION BY AAG40001.aaGLHdrID ORDER BY SEQNUMBR,AAG40001.DEX_ROW_ID ASC) ID,AAG40001.aaGLHdrID,aaGLDistID from AAG40001 WHERE SOURCDOC = '' group by AAG40001.aaGLHdrID,SEQNUMBR,aaGLDistID,AAG40001.DEX_ROW_ID  ) a INNER JOIN AAG40001 A1 ON A1.aaGLHdrID = a.aaGLHdrID AND A1.aaGLDistID = a.aaGLDistID  INNER JOIN AAG40002 A2 ON A2.aaGLHdrID = A1.aaGLHdrID AND A2.aaGLDistID = A1.aaGLDistID AND A1.SOURCDOC = ''   UPDATE AAG40001 SET aaGLDistID = a.ID FROM (  SELECT RANK() OVER (PARTITION BY AAG40001.aaGLHdrID ORDER BY SEQNUMBR,AAG40001.DEX_ROW_ID ASC) ID,AAG40001.aaGLHdrID,aaGLDistID from AAG40001 WHERE SOURCDOC = ''  group by AAG40001.aaGLHdrID,SEQNUMBR,aaGLDistID,AAG40001.DEX_ROW_ID  ) a INNER JOIN AAG40001 A1 ON A1.aaGLHdrID = a.aaGLHdrID AND A1.aaGLDistID = a.aaGLDistID AND A1.SOURCDOC = ''   UPDATE AAG40003 SET aaGLDistID = ABS(aaGLDistID)  UPDATE AAG40002 SET aaGLDistID = ABS(aaGLDistID)  UPDATE AAG40001 SET aaGLDistID = ABS(aaGLDistID)   END   BEGIN   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Distribution Table'',''AA GL Open Header ID=''+LTRIM(STR(A1.aaGLHdrID ))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(A1.aaGLDistID )),1,1,LTRIM(STR(A.JRNENTRY))   FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID =A.aaGLHdrID AND A1.AA_CL_Status = 0 and ltrim(rtrim(SOURCDOC)) = ''''   LEFT JOIN (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR  FROM GL20000 UNION ALL SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR  FROM GL30000) GL   ON GL.JRNENTRY=A.JRNENTRY AND A1.AA_CL_Status = 0   AND A1.SEQNUMBR = GL.SEQNUMBR  AND GL.TRXSORCE = A.aaGLTRXSource   AND A.RCTRXSEQ = GL.RCTRXSEQ  AND A.YEAR1 = GL.YEAR1  AND GL.SOURCDOC <> ''' + @l_cPANDL +'''   AND GL.SOURCDOC <>  ''' + @l_cBBF + '''   AND A1.ACTINDX = GL.ACTINDX   AND A1.CRDTAMNT = GL.CRDTAMNT   AND A1.DEBITAMT = GL.DEBITAMT   AND A.GLPOSTDT = GL.TRXDATE   AND A1.CURNCYID = GL.CURNCYID   AND A1.CURRNIDX = GL.CURRNIDX   WHERE A1.aaGLDistID > ( SELECT count(JRNENTRY) FROM (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC  FROM GL20000 UNION ALL SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC  FROM GL30000) C   WHERE C.JRNENTRY = A.JRNENTRY   AND C.TRXSORCE =A.aaGLTRXSource   AND A.RCTRXSEQ = C.RCTRXSEQ  AND A.YEAR1 = C.YEAR1  AND C.SOURCDOC <> ''' + @l_cPANDL +'''   AND C.SOURCDOC <>  ''' + @l_cBBF + '''   AND A.GLPOSTDT = C.TRXDATE   AND A1.CURNCYID = C.CURNCYID   AND A1.CURRNIDX = C.CURRNIDX)')   Delete AAG30001   FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(SOURCDOC)) = ''   LEFT JOIN (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR  FROM GL20000 UNION ALL SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR  FROM GL30000) GL   ON GL.JRNENTRY=A.JRNENTRY AND A1.AA_CL_Status = 0   AND A1.SEQNUMBR=GL.SEQNUMBR  AND GL.TRXSORCE =A.aaGLTRXSource   AND A.RCTRXSEQ = GL.RCTRXSEQ  AND A.YEAR1 = GL.YEAR1  AND GL.SOURCDOC <> @l_cPANDL   AND GL.SOURCDOC <>  @l_cBBF   AND A1.ACTINDX = GL.ACTINDX   AND A1.CRDTAMNT = GL.CRDTAMNT   AND A1.DEBITAMT = GL.DEBITAMT   AND A.GLPOSTDT = GL.TRXDATE   AND A1.CURNCYID = GL.CURNCYID   AND A1.CURRNIDX = GL.CURRNIDX  WHERE A1.aaGLDistID > ( SELECT count(JRNENTRY) FROM (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC  FROM GL20000 UNION ALL SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC  FROM GL30000) C   WHERE C.JRNENTRY = A.JRNENTRY   AND C.TRXSORCE =A.aaGLTRXSource   AND A.RCTRXSEQ = C.RCTRXSEQ  AND A.YEAR1 = C.YEAR1  AND C.SOURCDOC <> @l_cPANDL   AND C.SOURCDOC <>  @l_cBBF   AND A.GLPOSTDT = C.TRXDATE   AND A1.CURNCYID = C.CURNCYID   AND A1.CURRNIDX = C.CURRNIDX)  EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Distribution Table'',''AA GL History Header ID=''+LTRIM(STR(A1.aaGLHdrID ))+SPACE(3)+''AA GL History Distribution ID=''+LTRIM(STR(A1.aaGLDistID )),4,1,LTRIM(STR(A.JRNENTRY))  FROM AAG40001 A1 INNER JOIN AAG40000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(A1.SOURCDOC)) = '''' LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL30000   ) GL ON GL.JRNENTRY=A.JRNENTRY AND A1.SEQNUMBR=GL.SEQNUMBR AND A.RCTRXSEQ = GL.RCTRXSEQ AND A.YEAR1 = GL.HSTYEAR AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX  AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''') AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   WHERE A1.aaGLDistID >   (SELECT count(JRNENTRY) FROM   (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL30000) C   WHERE C.JRNENTRY = A.JRNENTRY   AND C.TRXSORCE =A.aaGLTRXSource   AND A.RCTRXSEQ = C.RCTRXSEQ   AND A.YEAR1 = C.HSTYEAR   AND A.GLPOSTDT = C.TRXDATE   AND A1.CURNCYID = C.CURNCYID   AND A1.CURRNIDX = C.CURRNIDX  AND C.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + '''))   AND A1.AA_CL_Status = 0')   Delete AAG40001   FROM AAG40001 A1 INNER JOIN AAG40000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(A1.SOURCDOC)) = '' LEFT JOIN (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL30000   ) GL ON GL.JRNENTRY=A.JRNENTRY AND A1.SEQNUMBR=GL.SEQNUMBR AND A.RCTRXSEQ = GL.RCTRXSEQ AND A.YEAR1 = GL.HSTYEAR AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX  AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(@l_cBBF, @l_cPANDL) AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   WHERE A1.aaGLDistID >   (SELECT count(JRNENTRY) FROM   (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL30000) C   WHERE C.JRNENTRY = A.JRNENTRY   AND C.TRXSORCE =A.aaGLTRXSource   AND A.RCTRXSEQ = C.RCTRXSEQ   AND A.YEAR1 = C.HSTYEAR   AND A.GLPOSTDT = C.TRXDATE   AND A1.CURNCYID = C.CURNCYID   AND A1.CURRNIDX = C.CURRNIDX  AND C.SOURCDOC not IN(@l_cBBF, @l_cPANDL))   AND A1.AA_CL_Status = 0   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40002.aaGLHdrID)) ),-9999)  FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40002.aaGLHdrID)')   DELETE AAG40002 FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40002.aaGLHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40003.aaGLHdrID)) ),-9999)  FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40003.aaGLHdrID=AAG40003.aaGLHdrID)')   DELETE AAG40003 FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40003.aaGLHdrID=AAG40003.aaGLHdrID)  End   declare CGLOpenBKout cursor fast_forward  for   (Select Distinct A.JRNENTRY,A.aaGLHdrID,A.aaGLTRXSource, A.RCTRXSEQ, A.YEAR1 from AAG30001 A1 inner join AAG30000 A on A1.aaGLHdrID = A.aaGLHdrID  inner join (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR,Original_JE, RCTRXSEQ, OPENYEAR FROM GL20000   ) B on   A.aaGLTRXSource =B.TRXSORCE and B.SOURCDOC not IN(@l_cBBF, @l_cPANDL) and A.JRNENTRY = B.JRNENTRY AND  A.RCTRXSEQ=B.RCTRXSEQ AND  A.YEAR1=B.OPENYEAR  where B.Original_JE <>0)  for read only  open CGLOpenBKout  fetch next from CGLOpenBKout into @JRNENTRY,@aaGLHdrID,@GLTrxSource, @l_RCTRXSEQ, @l_YEAR1  while @@fetch_status = 0  Begin   if (select min(SEQNUMBR)from AAG30001 where aaGLHdrID = @aaGLHdrID) <>   (select  min(SEQNUMBR) from GL20000   where JRNENTRY =   (select JRNENTRY from AAG30000   where aaGLHdrID = @aaGLHdrID)  and TRXSORCE = @GLTrxSource AND RCTRXSEQ = @l_RCTRXSEQ AND OPENYEAR = @l_YEAR1)  Begin  select  @cnt=count(JRNENTRY) from GL20000   where JRNENTRY = (select JRNENTRY from AAG30000 where aaGLHdrID = @aaGLHdrID)   and TRXSORCE = @GLTrxSource AND RCTRXSEQ = @l_RCTRXSEQ AND OPENYEAR = @l_YEAR1   set @i=1  while @i<=@cnt  Begin  if exists(select SEQNUMBR from GL20000   where JRNENTRY = (select JRNENTRY from AAG30000 where aaGLHdrID = @aaGLHdrID)  and TRXSORCE = @GLTrxSource   AND RCTRXSEQ = @l_RCTRXSEQ   AND OPENYEAR = @l_YEAR1  and OrigSeqNum = (select SEQNUMBR from AAG30001 where aaGLHdrID = @aaGLHdrID and aaGLDistID = @i))  Update AAG30001 set SEQNUMBR=   (select SEQNUMBR from GL20000   where JRNENTRY = (select JRNENTRY from AAG30000   where aaGLHdrID = @aaGLHdrID)   and TRXSORCE = @GLTrxSource   and RCTRXSEQ = @l_RCTRXSEQ   AND OPENYEAR = @l_YEAR1   and OrigSeqNum = (select SEQNUMBR from AAG30001   where aaGLHdrID = @aaGLHdrID and aaGLDistID = @i))   where aaGLHdrID = @aaGLHdrID and aaGLDistID = @i   set @i=@i+1  End  End  fetch next from CGLOpenBKout into  @JRNENTRY, @aaGLHdrID ,@GLTrxSource, @l_RCTRXSEQ, @l_YEAR1  End   CLOSE CGLOpenBKout  DEALLOCATE CGLOpenBKout   Delete AAG30001  from AAG30001 A inner join   (select MIN(DEX_ROW_ID) as DEX_ROW_ID,count(*) as COUNT1, aaGLHdrID, SEQNUMBR from AAG30001 where ltrim(rtrim(SOURCDOC)) = ''   group by aaGLHdrID, SEQNUMBR having count(*) > 1) B on A.aaGLHdrID = B.aaGLHdrID   and A.SEQNUMBR = B.SEQNUMBR where A.DEX_ROW_ID <> B.DEX_ROW_ID and A.ACCTTYPE<>3 and A.aaGLHdrID  not in (   select distinct A0.aaGLHdrID from AAG30000 A0 inner join (SELECT JRNENTRY,TRXSORCE,SOURCDOC,SEQNUMBR,DEX_ROW_ID, RCTRXSEQ, OPENYEAR YEAR1 FROM GL20000 UNION ALL SELECT JRNENTRY,TRXSORCE,SOURCDOC,SEQNUMBR,DEX_ROW_ID, RCTRXSEQ, HSTYEAR YEAR1 FROM GL30000  ) GL on A0.aaGLTRXSource =GL.TRXSORCE and GL.SOURCDOC not IN(@l_cBBF, @l_cPANDL)   and A0.JRNENTRY = GL.JRNENTRY AND  A0.RCTRXSEQ=GL.RCTRXSEQ AND  A0.YEAR1=GL.YEAR1 inner join   (select MIN(B1.DEX_ROW_ID) as DEX_ROW_ID,count(*) as COUNT1,B1.TRXSORCE, B1.JRNENTRY, B1.SEQNUMBR, B1.RCTRXSEQ, B1.YEAR1 from   (SELECT JRNENTRY,TRXSORCE,SEQNUMBR,DEX_ROW_ID, RCTRXSEQ, OPENYEAR YEAR1 FROM GL20000 UNION ALL SELECT JRNENTRY,TRXSORCE,SEQNUMBR,DEX_ROW_ID, RCTRXSEQ, HSTYEAR YEAR1 FROM GL30000) B1   group by B1.JRNENTRY,B1.TRXSORCE, B1.SEQNUMBR, B1.RCTRXSEQ, B1.YEAR1 having count(*) > 1) B2 on GL.JRNENTRY = B2.JRNENTRY   and GL.TRXSORCE = B2.TRXSORCE   and GL.RCTRXSEQ = B2.RCTRXSEQ   and GL.YEAR1 = B2.YEAR1   and GL.SEQNUMBR = B2.SEQNUMBR  where GL.DEX_ROW_ID <> B2.DEX_ROW_ID )    EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Distribution Table'',''AA GL Open Header ID=''+LTRIM(STR(A1.aaGLHdrID ))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(A1.aaGLDistID )),4,1 ,LTRIM(STR(A.JRNENTRY))  FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(A1.SOURCDOC)) = '''' LEFT JOIN (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR  FROM GL20000 UNION ALL SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR FROM GL30000  ) GL ON GL.JRNENTRY=A.JRNENTRY AND A.RCTRXSEQ = GL.RCTRXSEQ AND A.YEAR1 = GL.YEAR1  AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''') AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT  AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX  AND GL.SEQNUMBR = A1.SEQNUMBR   WHERE A1.aaGLDistID > 0 AND GL.JRNENTRY IS NULL AND A1.AA_CL_Status = 0')   DELETE AAG30001  FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(A1.SOURCDOC)) = '' LEFT JOIN (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR  FROM GL20000 UNION ALL SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR FROM GL30000  ) GL ON GL.JRNENTRY=A.JRNENTRY AND A.RCTRXSEQ = GL.RCTRXSEQ AND A.YEAR1 = GL.YEAR1   AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(@l_cBBF, @l_cPANDL) AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX  AND GL.SEQNUMBR = A1.SEQNUMBR   WHERE A1.aaGLDistID > 0 AND GL.JRNENTRY IS NULL AND A1.AA_CL_Status = 0    EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30002.aaGLHdrID)) ),-9999)  FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30002.aaGLHdrID AND AAG30001.aaGLDistID=AAG30002.aaGLDistID)')   DELETE AAG30002 FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30002.aaGLHdrID AND AAG30001.aaGLDistID=AAG30002.aaGLDistID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30003.aaGLHdrID AND AAG30001.aaGLDistID=AAG30003.aaGLDistID)')   DELETE AAG30003 FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30003.aaGLHdrID AND AAG30001.aaGLDistID=AAG30003.aaGLDistID)   Begin  Update AAG30001 SET aaGLDistID=0-ABS(aaGLDistID)  Update AAG30002 SET aaGLDistID=0-ABS(aaGLDistID)   Update AAG30003 SET aaGLDistID=0-ABS(aaGLDistID)    UPDATE AAG30003 SET aaGLDistID = a.ID FROM (  SELECT RANK() OVER (PARTITION BY aaGLHdrID ORDER BY SEQNUMBR,DEX_ROW_ID ASC) ID,aaGLHdrID,aaGLDistID from AAG30001 where SOURCDOC = '' group by aaGLHdrID,SEQNUMBR,aaGLDistID,DEX_ROW_ID  ) a INNER JOIN AAG30001 A1 ON A1.aaGLHdrID = a.aaGLHdrID AND A1.aaGLDistID = a.aaGLDistID  INNER JOIN AAG30003 A3 ON A3.aaGLHdrID = A1.aaGLHdrID AND A3.aaGLDistID = A1.aaGLDistID AND A1.SOURCDOC = ''   UPDATE AAG30002 SET aaGLDistID = a.ID FROM (  SELECT RANK() OVER (PARTITION BY aaGLHdrID ORDER BY SEQNUMBR,DEX_ROW_ID ASC) ID,aaGLHdrID,aaGLDistID from AAG30001 where SOURCDOC = '' group by aaGLHdrID,SEQNUMBR,aaGLDistID,DEX_ROW_ID  ) a INNER JOIN AAG30001 A1 ON A1.aaGLHdrID = a.aaGLHdrID AND A1.aaGLDistID = a.aaGLDistID  INNER JOIN AAG30002 A2 ON A2.aaGLHdrID = A1.aaGLHdrID AND A2.aaGLDistID = A1.aaGLDistID AND A1.SOURCDOC = ''   UPDATE AAG30001 SET aaGLDistID = a.ID FROM (  SELECT RANK() OVER (PARTITION BY aaGLHdrID ORDER BY SEQNUMBR,DEX_ROW_ID ASC) ID,aaGLHdrID,aaGLDistID from AAG30001 where SOURCDOC = '' group by aaGLHdrID,SEQNUMBR,aaGLDistID,DEX_ROW_ID  ) a INNER JOIN AAG30001 A1 ON A1.aaGLHdrID = a.aaGLHdrID AND A1.aaGLDistID = a.aaGLDistID AND A1.SOURCDOC = ''   UPDATE AAG30003 SET aaGLDistID = ABS(AAG30003.aaGLDistID) from AAG30001 A1 where AAG30003.aaGLHdrID=A1.aaGLHdrID and AAG30003.aaGLDistID=A1.aaGLDistID and A1.SOURCDOC <> ''  UPDATE AAG30002 SET aaGLDistID = ABS(AAG30002.aaGLDistID) from AAG30001 A1 where AAG30002.aaGLHdrID=A1.aaGLHdrID and AAG30002.aaGLDistID=A1.aaGLDistID and A1.SOURCDOC <> ''  UPDATE AAG30001 SET aaGLDistID = ABS(aaGLDistID) where SOURCDOC <> ''  End   Begin   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Distribution Table'',''AA GL Open Header ID=''+LTRIM(STR(A1.aaGLHdrID ))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(A1.aaGLDistID )),4,1 ,LTRIM(STR(A.JRNENTRY))  FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(A1.SOURCDOC)) = '''' LEFT JOIN (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR  FROM GL20000 UNION ALL SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR FROM GL30000  ) GL ON GL.JRNENTRY=A.JRNENTRY AND A1.SEQNUMBR=GL.SEQNUMBR AND A.RCTRXSEQ = GL.RCTRXSEQ AND A.YEAR1 = GL.YEAR1 AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX  AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + ''') AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   WHERE A1.aaGLDistID >   (SELECT count(JRNENTRY) FROM   (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR  FROM GL20000 UNION ALL SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR FROM GL30000) C   WHERE C.JRNENTRY = A.JRNENTRY   AND C.TRXSORCE =A.aaGLTRXSource   AND A.RCTRXSEQ = C.RCTRXSEQ   AND A.YEAR1 = C.YEAR1   AND A.GLPOSTDT = C.TRXDATE   AND A1.CURNCYID = C.CURNCYID   AND A1.CURRNIDX = C.CURRNIDX  AND C.SOURCDOC not IN(''' + @l_cBBF +''', ''' + @l_cPANDL + '''))   AND A1.AA_CL_Status = 0')   Delete AAG30001   FROM AAG30001 A1 INNER JOIN AAG30000 A ON A1.aaGLHdrID =A.aaGLHdrID and ltrim(rtrim(A1.SOURCDOC)) = '' LEFT JOIN (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR  FROM GL20000 UNION ALL SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR FROM GL30000  ) GL ON GL.JRNENTRY=A.JRNENTRY AND A1.SEQNUMBR=GL.SEQNUMBR AND A.RCTRXSEQ = GL.RCTRXSEQ AND A.YEAR1 = GL.YEAR1 AND A.GLPOSTDT = GL.TRXDATE AND A1.CURNCYID = GL.CURNCYID AND A1.CURRNIDX = GL.CURRNIDX  AND GL.TRXSORCE =A.aaGLTRXSource AND GL.SOURCDOC not IN(@l_cBBF, @l_cPANDL) AND A1.ACTINDX = GL.ACTINDX AND A1.CRDTAMNT  = GL.CRDTAMNT AND A1.DEBITAMT = GL.DEBITAMT   WHERE A1.aaGLDistID >   (SELECT count(JRNENTRY) FROM   (SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, OPENYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR  FROM GL20000 UNION ALL SELECT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR YEAR1, TRXDATE, CURNCYID, CURRNIDX, SOURCDOC, ACTINDX, CRDTAMNT, DEBITAMT, SEQNUMBR FROM GL30000) C   WHERE C.JRNENTRY = A.JRNENTRY   AND C.TRXSORCE =A.aaGLTRXSource   AND A.RCTRXSEQ = C.RCTRXSEQ   AND A.YEAR1 = C.YEAR1   AND A.GLPOSTDT = C.TRXDATE   AND A1.CURNCYID = C.CURNCYID   AND A1.CURRNIDX = C.CURRNIDX  AND C.SOURCDOC not IN(@l_cBBF, @l_cPANDL))   AND A1.AA_CL_Status = 0   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30002.aaGLHdrID)) ),-9999)  FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30002.aaGLHdrID AND AAG30001.aaGLDistID=AAG30002.aaGLDistID)')   DELETE AAG30002 FROM AAG30002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30002.aaGLHdrID AND AAG30001.aaGLDistID=AAG30002.aaGLDistID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL Open Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG30003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG30003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG30000 WHERE aaGLHdrID =LTRIM(STR(AAG30003.aaGLHdrID)) ),-9999)  FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30003.aaGLHdrID AND AAG30001.aaGLDistID=AAG30003.aaGLDistID)')   DELETE AAG30003 FROM AAG30003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG30001 WHERE AAG30001.aaGLHdrID=AAG30003.aaGLHdrID AND AAG30001.aaGLDistID=AAG30003.aaGLDistID)  End  END  IF @@ERROR <> 0  BEGIN  ROLLBACK TRANSACTION  END  ELSE  BEGIN  COMMIT TRANSACTION  END  SET NOCOUNT OFF  END   
GO
GRANT EXECUTE ON  [dbo].[aagGenericGLHistunmatched] TO [DYNGRP]
GO
