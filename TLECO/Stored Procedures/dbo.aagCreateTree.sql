SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[aagCreateTree]  @iTree      char(61) = NULL,  @iLinkType  smallint = NULL,  @iDimID     int = NULL,   @iTreeDescr char(50) = NULL,  @iTreeMain  tinyint = NULL,  @iTreeInclAllRec tinyint = NULL,   @oStatus smallint = NULL out as  declare @transaction tinyint,   @retCode int,  @dbName char(32),  @companyID smallint,  @companyStatus smallint,  @treeID int,  @noteIndex numeric(19,5)  if ((@iTree is NULL) or (@iLinkType is NULL) or (@iDimID is NULL) or (@iTreeDescr is NULL) or (@iTreeMain is NULL) or (@iTreeInclAllRec is NULL))   begin select @oStatus = 1 return end  select  @transaction = 0,  @retCode = 0,  @dbName = '',  @companyID = 0,  @companyStatus = 0,  @treeID = 0,  @noteIndex = 0.00,  @oStatus = 0  select @dbName = db_name() exec @retCode = DYNAMICS.dbo.aagGetCompanyStatus @dbName, @companyID out, @companyStatus out, @oStatus out if ((@retCode <> 0) or (@oStatus <> 0)) return @retCode  if (@@trancount = 0) begin select @transaction = 1 begin transaction end  exec @retCode = DYNAMICS.dbo.aagGetNextID 00600, @companyID, @treeID out, @oStatus out  if ((@retCode <> 0) or (@oStatus <> 0)) begin if (@transaction = 1) rollback transaction return @retCode end  exec @retCode = DYNAMICS.dbo.smGetNextNoteIndex @companyID, 1, @noteIndex out, @oStatus out  if ((@retCode <> 0) or (@oStatus <> 0)) begin if (@transaction = 1) rollback transaction return @retCode end  insert AAG00600 values(@treeID, @iTree, @iLinkType, @iDimID, @iTreeDescr, @iTreeMain,   @iTreeInclAllRec, @noteIndex) if (@@rowcount <> 1) begin if (@transaction = 1) rollback transaction select @oStatus = 1 return end   exec @retCode = DYNAMICS.dbo.smGetNextNoteIndex @companyID, 1, @noteIndex out, @oStatus out  if ((@retCode <> 0) or (@oStatus <> 0)) begin if (@transaction = 1) rollback transaction return @retCode end  insert AAG00601 values(@treeID, 1, @iTreeDescr, 0, 0, 1, @noteIndex) if (@@rowcount <> 1) begin if (@transaction = 1) rollback transaction select @oStatus = 1 return end   if (@iTreeMain = 1 or @iTreeInclAllRec = 1)  insert AAG00602(aaTreeID, aaNodeID, aaMstrID)  select @treeID, 1, aaMstrID from AAG00800V  where  aaLinkType = @iLinkType and aaDimID = @iDimID   if (@transaction = 1) commit transaction  return 0     
GO
GRANT EXECUTE ON  [dbo].[aagCreateTree] TO [DYNGRP]
GO
