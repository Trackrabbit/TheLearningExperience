SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_Create_Cont_Billing_WORK]  @USERID char(15),  @CHECKDATE datetime,  @IncludeMeter tinyint,   @Error integer OUTPUT AS  declare @MinDate datetime  exec smGetMinDate @MinDate output select @Error = 0  delete from SVC00615 where USERID = @USERID  if @IncludeMeter = 1 BEGIN  insert into SVC00615  select @USERID,2,  SVC0615V.CONTNBR, SVC00600.CNTTYPE, SVC00600.STRTDATE,SVC00600.ENDDATE,SVC00600.LSTBLDTE,  dbo.svcContractSiteNextBillDate(SVC0615V.CONTNBR, SVC0615V.Bill_To_Customer,SVC0615V.SVC_Bill_To_Address_Code),  dbo.svcContractSiteTotalBilled (SVC0615V.CONTNBR, SVC0615V.Bill_To_Customer,SVC0615V.SVC_Bill_To_Address_Code,@CHECKDATE, @IncludeMeter, 0),  dbo.svcContractSiteLastAmountBilled(SVC0615V.CONTNBR, SVC0615V.Bill_To_Customer,SVC0615V.SVC_Bill_To_Address_Code, 0),  dbo.svcContractSiteInvoiceAmount (SVC0615V.CONTNBR, SVC0615V.Bill_To_Customer,SVC0615V.SVC_Bill_To_Address_Code,@CHECKDATE, @IncludeMeter, 0),  SVC00600.CUSTNMBR, SVC00600.ADRSCODE,  0,0,0,0,  dbo.svcContractSiteInvoiceAmount (SVC0615V.CONTNBR, SVC0615V.Bill_To_Customer,SVC0615V.SVC_Bill_To_Address_Code,@CHECKDATE, @IncludeMeter, 1),  0,'','',  SVC0615V.Bill_To_Customer,SVC0615V.SVC_Bill_To_Address_Code,  isnull(dbo.svcContractConsolidateInvoice(SVC0615V.CONTNBR, SVC0615V.Bill_To_Customer,SVC00950.svcConsolidateContractIn),0)  from SVC0615V left join SVC00600 on SVC00600.CONTNBR = SVC0615V.CONTNBR  and SVC00600.CONSTS = SVC0615V.CONSTS  left join SVC00950 on SVC0615V.Bill_To_Customer = SVC00950.CUSTNMBR and SVC0615V.SVC_Bill_To_Address_Code = SVC00950.ADRSCODE  where (SVC0615V.CONTNBR in (select CONTNBR from SVC00601 where CONSTS = 2 and SVC00601.NXTBLDTE <= @CHECKDATE and SVC00601.NXTBLDTE > @MinDate and SVC00601.Credit_Hold = 0) or  SVC0615V.CONTNBR in (select CONTNBR from SVC00607 where CONSTS = 2 and Amount_To_Invoice > 0.0 and INVODATE <= @CHECKDATE and INVODATE > @MinDate))   update SVC00615 set NXTBLDTE = (select case   when SVC00615.NXTBLDTE > min(SVC00607.INVODATE)  then isnull(min(SVC00607.INVODATE), convert(char(10), @MinDate, 101))  else SVC00615.NXTBLDTE  end  from SVC00607  where SVC00607.CONSTS = 2 and SVC00607.CONTNBR = SVC00615.CONTNBR and SVC00607.Amount_To_Invoice > 0.0 and INVODATE <= @CHECKDATE and INVODATE > @MinDate)  END else  insert into SVC00615  select @USERID,2,  SVC0615V.CONTNBR, SVC00600.CNTTYPE, SVC00600.STRTDATE,SVC00600.ENDDATE,SVC00600.LSTBLDTE,  dbo.svcContractSiteNextBillDate(SVC0615V.CONTNBR, SVC0615V.Bill_To_Customer,SVC0615V.SVC_Bill_To_Address_Code),  dbo.svcContractSiteTotalBilled (SVC0615V.CONTNBR, SVC0615V.Bill_To_Customer,SVC0615V.SVC_Bill_To_Address_Code,@CHECKDATE, @IncludeMeter, 0),  dbo.svcContractSiteLastAmountBilled(SVC0615V.CONTNBR, SVC0615V.Bill_To_Customer,SVC0615V.SVC_Bill_To_Address_Code, 0),  dbo.svcContractSiteInvoiceAmount (SVC0615V.CONTNBR, SVC0615V.Bill_To_Customer,SVC0615V.SVC_Bill_To_Address_Code,@CHECKDATE, @IncludeMeter, 0),  SVC00600.CUSTNMBR, SVC00600.ADRSCODE,  0,0,0,0,  dbo.svcContractSiteInvoiceAmount (SVC0615V.CONTNBR, SVC0615V.Bill_To_Customer,SVC0615V.SVC_Bill_To_Address_Code,@CHECKDATE, @IncludeMeter, 1),  0,'','',  SVC0615V.Bill_To_Customer,SVC0615V.SVC_Bill_To_Address_Code,  isnull(dbo.svcContractConsolidateInvoice(SVC0615V.CONTNBR, SVC0615V.Bill_To_Customer,SVC00950.svcConsolidateContractIn),0)  from SVC0615V left join SVC00600 on SVC00600.CONTNBR = SVC0615V.CONTNBR  and SVC00600.CONSTS = SVC0615V.CONSTS  left join SVC00950 on SVC0615V.Bill_To_Customer = SVC00950.CUSTNMBR and SVC0615V.SVC_Bill_To_Address_Code = SVC00950.ADRSCODE  where (SVC0615V.CONTNBR in (select CONTNBR from SVC00601 where CONSTS = 2 and SVC00601.NXTBLDTE <= @CHECKDATE and SVC00601.NXTBLDTE >@MinDate and SVC00601.Credit_Hold = 0))  delete from SVC00615 where NXTBLDTE > @CHECKDATE and USERID = @USERID return    
GO
GRANT EXECUTE ON  [dbo].[SVC_Create_Cont_Billing_WORK] TO [DYNGRP]
GO
