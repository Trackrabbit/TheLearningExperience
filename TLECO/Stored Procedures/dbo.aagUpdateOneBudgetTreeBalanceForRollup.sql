SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aagUpdateOneBudgetTreeBalanceForRollup]  (  @aaBudgetID    INTEGER  ,  @aaCodeSequence   INTEGER  ,   @aaFiscalPeriod   INTEGER ,  @PeriodDate DATETIME,  @aaActualPriliminary  INTEGER  ,  @Balance     NUMERIC(19,5) ,  @aaAmountQty INTEGER ) AS DECLARE @aaCodeSequenceRollUP INTEGER, @aaBudgetTreeID INTEGER, @ExistingBalance FLOAT SET NOCOUNT ON  IF @aaAmountQty = 0 BEGIN  SELECT @ExistingBalance = Balance FROM AAG00904 WHERE aaBudgetID = @aaBudgetID AND aaCodeSequence = @aaCodeSequence AND  PERIODDT = @PeriodDate AND aaFiscalPeriod = @aaFiscalPeriod AND aaActualPriliminary = @aaActualPriliminary   UPDATE AAG00904   SET Balance = @Balance   WHERE aaBudgetID = @aaBudgetID AND   aaCodeSequence = @aaCodeSequence AND  PERIODDT = @PeriodDate AND   aaFiscalPeriod = @aaFiscalPeriod AND   aaActualPriliminary = @aaActualPriliminary END ELSE BEGIN  SELECT @ExistingBalance = QUANTITY FROM AAG00904 WHERE aaBudgetID = @aaBudgetID AND aaCodeSequence = @aaCodeSequence AND  PERIODDT = @PeriodDate AND aaFiscalPeriod = @aaFiscalPeriod AND aaActualPriliminary = @aaActualPriliminary   UPDATE AAG00904   SET QUANTITY = @Balance   WHERE aaBudgetID = @aaBudgetID AND   aaCodeSequence = @aaCodeSequence AND  PERIODDT = @PeriodDate AND  aaFiscalPeriod = @aaFiscalPeriod AND   aaActualPriliminary = @aaActualPriliminary END  DECLARE CURUPDATE CURSOR FAST_FORWARD FOR SELECT aaCodeSequence FROM dbo.aagGetParentNodes(@aaBudgetID,@aaCodeSequence) OPEN CURUPDATE FETCH NEXT FROM CURUPDATE INTO @aaCodeSequenceRollUP WHILE @@FETCH_STATUS = 0 BEGIN  IF @aaAmountQty = 0  BEGIN  UPDATE AAG00904   SET Balance = Balance + (@Balance - @ExistingBalance)  WHERE aaBudgetID = @aaBudgetID AND   aaCodeSequence = @aaCodeSequenceRollUP AND  PERIODDT = @PeriodDate AND   aaFiscalPeriod = @aaFiscalPeriod AND   aaActualPriliminary = @aaActualPriliminary  END  ELSE  BEGIN  UPDATE AAG00904   SET QUANTITY = QUANTITY - (@ExistingBalance - @Balance)   WHERE aaBudgetID = @aaBudgetID AND   aaCodeSequence = @aaCodeSequenceRollUP AND  PERIODDT = @PeriodDate AND   aaFiscalPeriod = @aaFiscalPeriod AND   aaActualPriliminary = @aaActualPriliminary  END  FETCH NEXT FROM CURUPDATE INTO @aaCodeSequenceRollUP END CLOSE CURUPDATE DEALLOCATE CURUPDATE  SET NOCOUNT OFF    
GO
GRANT EXECUTE ON  [dbo].[aagUpdateOneBudgetTreeBalanceForRollup] TO [DYNGRP]
GO
