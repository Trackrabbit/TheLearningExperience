SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_TA_RMA_Transfer]  ( @custnmbr char(15),  @adrscode varchar(15) = NULL,  @equipid integer = NULL,  @serial char(21) = NULL,  @item varchar(31) = NULL,  @locationcode char(11) = NULL,  @CallNumber char(11) = NULL,  @ServiceRecType smallint,   @EQPLINE int,   @LNITMSEQ int,  @QTY numeric(19,5),  @UOM char(10),  @serialized tinyint,  @USERID char(15))  AS declare @CUSTOWN smallint declare @NEWRELEASE varchar(5) declare @NEWRETDOCID char(16) declare @template char(4) declare @ReturnStatus char(3) declare @SerialNumber char(21) declare @serialseq integer declare @Received tinyint declare @TransferLine integer,  @RETDOCID char(15),  @RetType char(11),  @returnlocation char(11) declare @LineNumber numeric(19,5),  @AddressOption smallint,  @TransferNumber char(16),  @Description char(31),  @allocQTY numeric(19,5) declare  @NowDateTime datetime,   @NowDate datetime,  @NowTime datetime  begin tran exec SVC_Add_Item_To_Site @item,@locationcode select @NowDateTime = getdate()  exec SVC_util_split_datetime @NowDateTime,@NowDate output,@NowTime output select @RetType = RETTYPE, @AddressOption = SVC_Address_Option from SVC00998 select @returnlocation = LOCNCODE from SVC05501 where RETTYPE = @RetType select @Description = ITEMDESC from IV00101 where ITEMNMBR = @item select @template = '0000'  select @EQPLINE = 1 select @LineNumber = 100 select @allocQTY = 0.0 if @serialized = 1   BEGIN  declare rserial_cursor CURSOR for select SERLTNUM from SVC00250  where SRVRECTYPE=2 and CALLNBR=@CallNumber and EQPLINE =1 and LINITMTYP='P' and LNITMSEQ=@LNITMSEQ  open rserial_cursor  FETCH NEXT FROM rserial_cursor into @SerialNumber  while @@FETCH_STATUS = 0  BEGIN  select @QTY = 1  exec SVC_Create_RMA @RETDOCID OUTPUT,@LineNumber output,2,'',@CallNumber,@custnmbr,@adrscode,@equipid,@SerialNumber,@item,@locationcode,0,@CallNumber,2,1,@LNITMSEQ,@QTY,@UOM,'','',@USERID  exec SVC_Create_Transfer @locationcode,  @returnlocation,  @item,  @Description,  @UOM,  @QTY,  @CallNumber,  2,  @LNITMSEQ,  1,  'P',  @RETDOCID,  @LineNumber,  '',  0,  '',  @AddressOption,  @adrscode,  @custnmbr,  @NowDate,  1,  @TransferNumber output,  @TransferLine output  if @@error = 0   begin  update SVC00203 set RETDOCID = @RETDOCID, LNSEQNBR = @LineNumber,On_Return=1, ORDDOCID = @TransferNumber, TRANSLINESEQ = @TransferLine, TRNFLAG=1,TRNSFQTY=@QTY,TRNSFLOC=@locationcode where   SRVRECTYPE=2 and CALLNBR=@CallNumber and EQPLINE=1 and LNITMSEQ=@LNITMSEQ and LINITMTYP = 'P'  exec SVC_Create_Transfer_Serial @TransferNumber,@TransferLine,@locationcode,@SerialNumber   update SVC05200 set ORDDOCID = @TransferNumber, TRANSLINESEQ = @TransferLine, STATUS = 1 where RETDOCID = @RETDOCID and LNSEQNBR = @LineNumber  select @allocQTY = @allocQTY + @QTY  end  select @LineNumber = CONVERT(CHAR(5),CONVERT(integer,@LineNumber ) + 1 )  select @LineNumber =  stuff(@template,4 - LEN(rtrim(@LineNumber)) + 1,LEN(rtrim(@LineNumber)),@LineNumber)  FETCH NEXT FROM rserial_cursor into @SerialNumber  END  deallocate rserial_cursor  END else   BEGIN  exec SVC_Create_RMA @RETDOCID OUTPUT,@LineNumber output,2,'',@CallNumber,@custnmbr,@adrscode,@equipid,'',@item,@locationcode,0,@CallNumber,2,1,@LNITMSEQ,@QTY,@UOM,'','',@USERID  if @@error = 0   exec SVC_Create_Transfer @locationcode,  @returnlocation,  @item,  @Description,  @UOM,  @QTY,  @CallNumber,  2,  @LNITMSEQ,  1,  'P',  @RETDOCID,  @LineNumber,  '',  0,  '',  @AddressOption,  @adrscode,  @custnmbr,  @NowDate,  1,  @TransferNumber output,  @TransferLine output  if @@error = 0   begin  update SVC00203 set RETDOCID = @RETDOCID, LNSEQNBR = @LineNumber, ORDDOCID = @TransferNumber, TRANSLINESEQ = @TransferLine, TRNFLAG=1 where   SRVRECTYPE=2and CALLNBR=@CallNumber and EQPLINE=1 and LNITMSEQ=@LNITMSEQ and LINITMTYP = 'P'  update SVC05200 set ORDDOCID = @TransferNumber, TRANSLINESEQ = @TransferLine, STATUS = 1 where RETDOCID = @RETDOCID and LNSEQNBR = @LineNumber  update SVC00701 set STATUS = 1, QTYFULFI = @QTY where  ORDDOCID = @TransferNumber and LNITMSEQ = @TransferLine  update SVC00700 set STATUS = 1 where  ORDDOCID = @TransferNumber  select @allocQTY = @QTY  end  END update IV00102 set QTYONHND = QTYONHND+@allocQTY where ITEMNMBR = @item and LOCNCODE = @locationcode and RCRDTYPE = 2 update IV00102 set QTYONHND = QTYONHND+@allocQTY where ITEMNMBR = @item and RCRDTYPE = 1 commit tran  return    
GO
GRANT EXECUTE ON  [dbo].[SVC_TA_RMA_Transfer] TO [DYNGRP]
GO
