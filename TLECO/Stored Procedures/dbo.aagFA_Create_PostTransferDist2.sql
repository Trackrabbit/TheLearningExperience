SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE PROC [dbo].[aagFA_Create_PostTransferDist2]  @FALastFinancialIndex INT, @DocType SMALLINT, @COMPANYID SMALLINT, @InterID VARCHAR(20), @FALatestFinancialIndex INT OUTPUT, @PartialXfr BIT   AS BEGIN  DECLARE @FA_Doc_Nmbr VARCHAR(21),  @AssetIndex INT,  @BookIndex INT,  @AcctIndex INT,  @aaSubLedgerHdrID INT,  @HdrIDStatus SMALLINT,  @AcctClassID INT,  @AssetID VARCHAR(30),  @BookID VARCHAR(20),  @aaSubLedgerDistID INT,  @AssetSufIndex SMALLINT,  @AcctType SMALLINT,  @Amount NUMERIC(19,5),  @DEBITAMT NUMERIC(19,5),  @CRDTAMNT NUMERIC(19,5),  @SEQNMBR INT,  @aaBrowseType INT,  @aaAliasID INT,  @aaFASetupID INT,  @ListID SMALLINT,  @ORDEBITAMT NUMERIC(19,5),  @ORCRDTAMNT NUMERIC(19,5),  @FUNCRIDX SMALLINT,  @FUNLCURR CHAR(15)   SET @aaSubLedgerHdrID=0  SELECT @FUNCRIDX=FUNCRIDX,@FUNLCURR=FUNLCURR FROM MC40000   DECLARE FADOCNMBR CURSOR FAST_FORWARD FOR  SELECT DISTINCT FA_Doc_Number FROM FA00902 WHERE FINANCIALINDX>@FALastFinancialIndex AND (BOOKINDX IN (SELECT BOOKINDX FROM FA40200 WHERE PTGENLED =1) OR BOOKINDX = (SELECT CORPBOOKINDX  FROM FA49900))  OPEN FADOCNMBR  FETCH NEXT FROM FADOCNMBR INTO @FA_Doc_Nmbr   WHILE @@FETCH_STATUS = 0  BEGIN  EXEC DYNAMICS.dbo.aagGetNextID 20000,@COMPANYID,@aaSubLedgerHdrID OUT  INSERT INTO AAG20000(aaSubLedgerHdrID,SERIES,DOCTYPE,DOCNUMBR) VALUES(@aaSubLedgerHdrID,2,@DocType,@FA_Doc_Nmbr)  SET @aaSubLedgerDistID=1  SET @SEQNMBR=16384  SET @aaAliasID=0  DECLARE FADIST CURSOR FAST_FORWARD FOR  SELECT FINANCIALINDX,ASSETINDEX,BOOKINDX,GLINTACCTINDX,TRANSACCTTYPE,AMOUNT FROM FA00902 WHERE FA_Doc_Number=@FA_Doc_Nmbr AND (BOOKINDX IN (SELECT BOOKINDX FROM FA40200 WHERE PTGENLED =1) OR BOOKINDX = (SELECT CORPBOOKINDX  FROM FA49900))   OPEN FADIST  FETCH NEXT FROM FADIST INTO @FALatestFinancialIndex,@AssetIndex,@BookIndex,@AcctIndex,@AcctType,@Amount  WHILE @@FETCH_STATUS = 0  BEGIN  SELECT @BookID=BOOKID FROM FA40200 WHERE BOOKINDX=@BookIndex  SELECT @AssetID=ASSETID,@AssetSufIndex=ASSETIDSUF FROM FA00100 WHERE ASSETINDEX=@AssetIndex  SELECT @aaAliasID = 0  EXEC aagGetClassIDBrowseType @AcctIndex,@AcctClassID OUTPUT,@aaBrowseType OUTPUT  IF @Amount <= 0  BEGIN  SET @DEBITAMT=0  SET @CRDTAMNT=(-1)*@Amount  END  ELSE  BEGIN  SET @DEBITAMT=@Amount  SET @CRDTAMNT=0  END  SET @ORDEBITAMT=@DEBITAMT  SET @ORCRDTAMNT=@CRDTAMNT   INSERT INTO AAG20001  (aaSubLedgerHdrID,aaSubLedgerDistID,INTERID,ACTINDX,ACCTTYPE,aaBrowseType,DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,  SEQNUMBR,aaAssetID,aaBookID,TRXNUMBER,aaChangeDate,aaChangeTime,  CURRNIDX,CURNCYID)  VALUES(@aaSubLedgerHdrID,@aaSubLedgerDistID,@InterID,@AcctIndex,@AcctType,@aaBrowseType,@DEBITAMT,@CRDTAMNT,@ORDEBITAMT,@ORCRDTAMNT,  @SEQNMBR,rtrim(@AssetID)+'-'+convert(varchar(20),@AssetSufIndex),@BookID,@FALatestFinancialIndex,convert(char(12), getdate(), 102),convert(char(12), getdate(), 108),  @FUNCRIDX,@FUNLCURR)  IF @PartialXfr=0 AND (SELECT COUNT(*) FROM AAG04000 WHERE  aaAssetIndex=-@AssetIndex and aaBookIndex=0 and ACTINDX=@AcctIndex)>0  BEGIN   SELECT TOP 1 @aaFASetupID=aaFASetupID,@ListID=ListID,@aaAliasID=aaAliasID FROM AAG04000 WHERE  aaAssetIndex=-@AssetIndex and aaBookIndex=0 and ACTINDX=@AcctIndex   END   ELSE   BEGIN  IF (SELECT COUNT(*) FROM AAG04000 WHERE  aaAssetIndex=@AssetIndex and aaBookIndex=@BookIndex and ACTINDX=@AcctIndex)>0   SELECT TOP 1 @aaFASetupID=aaFASetupID,@ListID=ListID,@aaAliasID=aaAliasID FROM AAG04000 WHERE  aaAssetIndex=@AssetIndex and aaBookIndex=@BookIndex and ACTINDX=@AcctIndex   ELSE IF (SELECT COUNT(*) FROM AAG04000 WHERE  aaAssetIndex=@AssetIndex and aaBookIndex=0 and ACTINDX=@AcctIndex)>0  SELECT TOP 1 @aaFASetupID=aaFASetupID,@ListID=ListID,@aaAliasID=aaAliasID FROM AAG04000 WHERE  aaAssetIndex=@AssetIndex and aaBookIndex=0 and ACTINDX=@AcctIndex   END  INSERT INTO AAG20002  (aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID,DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,aaAssignedPercent,aaAliasID)  VALUES(@aaSubLedgerHdrID,@aaSubLedgerDistID,1,@DEBITAMT,@CRDTAMNT,@DEBITAMT,@CRDTAMNT,10000,@aaAliasID)  EXEC aagCreateSubLedgerCodesFA @aaSubLedgerHdrID,@aaSubLedgerDistID,1,@AcctClassID,@aaFASetupID,@ListID  SET @aaSubLedgerDistID=@aaSubLedgerDistID+1  SET @SEQNMBR=@SEQNMBR+16384  FETCH NEXT FROM FADIST INTO @FALatestFinancialIndex,@AssetIndex,@BookIndex,@AcctIndex,@AcctType,@Amount  END  CLOSE FADIST  DEALLOCATE FADIST  FETCH NEXT FROM FADOCNMBR INTO @FA_Doc_Nmbr  END  CLOSE FADOCNMBR  DEALLOCATE FADOCNMBR END   
GO
GRANT EXECUTE ON  [dbo].[aagFA_Create_PostTransferDist2] TO [DYNGRP]
GO
