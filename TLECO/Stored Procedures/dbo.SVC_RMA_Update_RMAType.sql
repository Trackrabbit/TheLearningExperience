SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_RMA_Update_RMAType] (  @RMANumber char(15),  @Line numeric(19,5),  @RMAType char(11) ) AS declare @old_RMAType char(11) declare @ReturnLocation char(10) declare @InvoiceItem char(30) declare @ReturnStatus char(3) declare @ReceivedStatus char(3) declare @ReadyToCloseStatus char(3) declare @DiscrepancyStatus char(3) declare @ReturnPath smallint  select @ReceivedStatus = Received_Status, @ReadyToCloseStatus = SVC_Ready_To_Close_Statu,  @DiscrepancyStatus = SVC_Discrepancy_Status, @ReturnStatus = RETSTAT,  @ReturnLocation = LOCNCODE, @InvoiceItem = ITEMNMBR, @ReturnPath = RETPATH  from SVC05501 where RETTYPE = @RMAType if @Line = 0 begin  declare RMAline cursor for select LNSEQNBR,RETTYPE from SVC05200  where Return_Record_Type = 1 and RETDOCID = @RMANumber and Received = 0   open RMAline  fetch next from RMAline into @Line , @old_RMAType  while @@FETCH_STATUS = 0  BEGIN  if @old_RMAType <> @RMAType  begin  update SVC05200 with (rowlock) set RETTYPE = @RMAType,  CUSTOWN = case when @ReturnPath = 1 then 1  else 0 END,  RETSTAT = case when SVC_Ready_To_Close = 1 then @ReadyToCloseStatus   when Received = 1 and ITEMNMBR <> Return_Item_Number then @DiscrepancyStatus   when Received = 1 and ITEMNMBR = Return_Item_Number then @ReceivedStatus   else @ReturnStatus END,  Return_Location_Code = case when ORDDOCID > '' then Return_Location_Code  else @ReturnLocation END,  Item_Number_Invoice = @InvoiceItem  where Return_Record_Type = 1 and RETDOCID = @RMANumber and LNSEQNBR = @Line  exec SVC_Set_RMA_Dist @RMANumber,1,@Line, 0,'',0,0,0,0,0,1,0  if @ReturnPath < 2   exec SVC_Set_RMA_Dist @RMANumber,1,@Line, 0,'R',1,0,0,0,0,1,0  end  fetch next from RMAline into @Line , @old_RMAType  END  deallocate RMAline end else begin  update SVC05200 with (rowlock) set RETTYPE = @RMAType,  CUSTOWN = case when @ReturnPath = 1 then 1  else 0 END,  RETSTAT = case when SVC_Ready_To_Close = 1 then @ReadyToCloseStatus   when Received = 1 and ITEMNMBR <> Return_Item_Number then @DiscrepancyStatus   when Received = 1 and ITEMNMBR = Return_Item_Number then @ReceivedStatus   else @ReturnStatus END,  Return_Location_Code = case when ORDDOCID > '' or Received = 1 then Return_Location_Code  else @ReturnLocation END,  Item_Number_Invoice = @InvoiceItem  where Return_Record_Type = 1 and RETDOCID = @RMANumber and LNSEQNBR = @Line  exec SVC_Set_RMA_Dist @RMANumber,1,@Line, 0,'',0,0,0,0,0,1,0  if @ReturnPath < 2   exec SVC_Set_RMA_Dist @RMANumber,1,@Line, 0,'R',1,0,0,0,0,1,0 end return    
GO
GRANT EXECUTE ON  [dbo].[SVC_RMA_Update_RMAType] TO [DYNGRP]
GO
