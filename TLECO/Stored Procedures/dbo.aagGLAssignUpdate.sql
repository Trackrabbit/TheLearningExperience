SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE procedure [dbo].[aagGLAssignUpdate] @aaGLWorkHdrID int, @aaGLWorkDistID int, @aaGLWorkAssignID int output, @CompanyID  int, @ClassID int,  @SqlSessionID int, @Flag smallint  as begin  declare @NOTEINDX numeric(19,5)   declare @RequiredFieldEmpty tinyint  declare @PaymentVoucherNo varchar(50)  declare @OrgTrxNumber varchar(50), @SQLStmt varchar(2000)  Select   @NOTEINDX = 0, @SQLStmt = '', @OrgTrxNumber = '', @PaymentVoucherNo = ''   Select @aaGLWorkAssignID = isnull(max(aaGLWorkDistID),0) + 1   from AAG10002 where aaGLWorkHdrID = @aaGLWorkHdrID and  aaGLWorkDistID = @aaGLWorkDistID and   @aaGLWorkAssignID > 0   exec DYNAMICS.dbo.smGetNextNoteIndex @CompanyID, @SqlSessionID, @NOTEINDX output   insert into AAG10002 ( aaGLWorkHdrID, aaGLWorkDistID, aaGLWorkAssignID,DEBITAMT,  CRDTAMNT, ORDBTAMT, ORCRDAMT, aaAssignedPercent ,DistRef, NOTEINDX, aaAssignErrors)  Select  aaGLWorkHdrID, aaGLWorkDistID, @aaGLWorkAssignID, DEBITAMT,   CRDTAMNT, ORDBTAMT, ORCRDAMT,10000, '  ', @NOTEINDX,0 from AAG10001 where  aaGLWorkHdrID = @aaGLWorkHdrID and aaGLWorkDistID = @aaGLWorkDistID  if @Flag  <> 1  exec aagGLWorkCodeUpdate @aaGLWorkHdrID, @aaGLWorkDistID, @aaGLWorkAssignID, @ClassID,@RequiredFieldEmpty output   select @PaymentVoucherNo=DTAControlNum from GL10000 where JRNENTRY=(select JRNENTRY from AAG10000 where aaGLWorkHdrID=@aaGLWorkHdrID)  select @OrgTrxNumber=CNTRLNUM from PM00400 where  TRXSORCE = (select TRXSORCE from PM30200 where VCHRNMBR=@PaymentVoucherNo and DOCTYPE=6) and DOCTYPE=1   SELECT @SQLStmt = ' select  X.aaGLWorkHdrID,X.aaGLWorkDistID,Y.aaSubLedgerHdrID,Y.aaSubLedgerDistID into [##TEMP'+RTRIM(@CompanyID)+convert(varchar(12),@SqlSessionID)+'] from AAG10001 X   left outer join AAG20001 Y  on X.ACTINDX=Y.ACTINDX  where X.aaGLWorkHdrID=' + convert(varchar(12),@aaGLWorkHdrID) + ' and   Y.aaSubLedgerHdrID = (select aaSubLedgerHdrID from AAG20000 where DOCNUMBR=''' + @OrgTrxNumber + ''' and DOCTYPE=0) and   ((Y.DISTTYPE=2 and Y.CRDTAMNT=0) or (Y.DISTTYPE=1 and Y.DEBITAMT=0) or (Y.DISTTYPE<>2 and Y.DISTTYPE<>1)) order by X.DEX_ROW_ID  if (select count(*) from [##TEMP'+RTRIM(@CompanyID)+convert(varchar(12),@SqlSessionID)+'])>0  begin  Update AAG10003 set aaTrxCodeID = AAG20003.aaTrxCodeID from [##TEMP'+RTRIM(@CompanyID)+convert(varchar(12),@SqlSessionID)+'] left outer join AAG20003   on AAG20003.aaSubLedgerHdrID=[##TEMP'+RTRIM(@CompanyID)+convert(varchar(12),@SqlSessionID)+'].aaSubLedgerHdrID and  AAG20003.aaSubLedgerDistID=[##TEMP'+RTRIM(@CompanyID)+convert(varchar(12),@SqlSessionID)+'].aaSubLedgerDistID   where AAG20003.aaTrxDimID=AAG10003.aaTrxDimID and [##TEMP'+RTRIM(@CompanyID)+convert(varchar(12),@SqlSessionID)+'].aaGLWorkDistID = AAG10003.aaGLWorkDistID   and  AAG10003.aaGLWorkHdrID='+ convert(varchar(12),@aaGLWorkHdrID) +'   end   drop table [##TEMP'+RTRIM(@CompanyID)+convert(varchar(12),@SqlSessionID)+']'   exec(@SQLStmt) end    
GO
GRANT EXECUTE ON  [dbo].[aagGLAssignUpdate] TO [DYNGRP]
GO
