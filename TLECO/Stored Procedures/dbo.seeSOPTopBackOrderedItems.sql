SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[seeSOPTopBackOrderedItems]   @UserDate datetime,  @MaxItems int,  @ItemNumber varchar(max),  @TimeUnit varchar(10) = 'Period' AS  DECLARE @ITEMS table (  ITEMNMBR varchar(31) )  declare @ItemsTemp table (ITEMNMBR nvarchar(500)) insert into @ItemsTemp select * from dbo.seeSplitString(@ItemNumber, ',')   DECLARE @NO_LIMIT int SET @NO_LIMIT = 2147483647  if(@ItemNumber = '') begin  INSERT INTO @ITEMS  SELECT TOP (SELECT CASE WHEN @MaxItems = 0 THEN @NO_LIMIT ELSE @MaxItems END)  ITEMNMBR  FROM   ((SELECT   ITEMNMBR, QUANTITY  FROM   SOP30200 as hdr JOIN SOP30300 as line ON hdr.SOPNUMBE = line.SOPNUMBE  WHERE   hdr.SOPTYPE = 5   AND BACKDATE BETWEEN dbo.GetBeginningDate(@UserDate, 'Fiscal', @TimeUnit, 1) AND @UserDate AND  rtrim(ITEMNMBR) LIKE   CASE WHEN rtrim(@ItemNumber) = '' THEN '%'  ELSE rtrim(@ItemNumber) END) UNION ALL  SELECT   ITEMNMBR, QUANTITY  FROM   SOP10100 as hdr JOIN SOP10200 as line ON hdr.SOPNUMBE = line.SOPNUMBE  WHERE   hdr.SOPTYPE = 5   AND BACKDATE BETWEEN dbo.GetBeginningDate(@UserDate, 'Fiscal', @TimeUnit, 1) AND @UserDate AND  rtrim(ITEMNMBR) LIKE   CASE WHEN rtrim(@ItemNumber) = '' THEN '%'  ELSE rtrim(@ItemNumber) END) sub  GROUP BY  ITEMNMBR  ORDER BY  sum(QUANTITY) DESC   SELECT  rtrim(SOPNUMBE) as [SOP Number],  rtrim(ITEMNMBR) as [Item Number],   rtrim(ITEMDESC) as [Item Description],  QUANTITY as [Total Quantity],  rtrim(sub.LOCNCODE) as [Location Code],  QTYONHND as [QTY On Hand],  QTYORDER as [QTY Ordered],  QTYREMAI as [QTY Remaining],  rtrim(SALSTERR) as [Sales Territory],  rtrim(SLPRSNID) as [Salesperson ID]  FROM   ((SELECT   hdr.SOPNUMBE, line.ITEMNMBR, ITEMDESC, QUANTITY, line.LOCNCODE, BACKDATE,   hdr.SOPTYPE, QTYONHND, QTYORDER, QTYREMAI, line.SALSTERR, line.SLPRSNID  FROM   SOP30200 as hdr JOIN SOP30300 as line ON hdr.SOPNUMBE = line.SOPNUMBE JOIN @ITEMS it on line.ITEMNMBR = it.ITEMNMBR) UNION  SELECT   hdr.SOPNUMBE, line.ITEMNMBR, ITEMDESC, QUANTITY, line.LOCNCODE, BACKDATE,   hdr.SOPTYPE, QTYONHND, QTYORDER, QTYREMAI, line.SALSTERR, line.SLPRSNID  FROM   SOP10100 as hdr JOIN SOP10200 as line ON hdr.SOPNUMBE = line.SOPNUMBE JOIN @ITEMS it on line.ITEMNMBR = it.ITEMNMBR) sub  WHERE   sub.BACKDATE BETWEEN dbo.GetBeginningDate(@UserDate, 'Fiscal', @TimeUnit, 1) AND @UserDate AND  sub.SOPTYPE = 5 AND   rtrim(ITEMNMBR) LIKE   CASE WHEN rtrim(@ItemNumber) = '' THEN '%'  ELSE rtrim(@ItemNumber) END  ORDER BY  QUANTITY DESC, ITEMNMBR ASC end  if (@ItemNumber <> '') begin  SELECT  rtrim(SOPNUMBE) as [SOP Number],  rtrim(ITEMNMBR) as [Item Number],   rtrim(ITEMDESC) as [Item Description],  QUANTITY as [Total Quantity],  rtrim(sub.LOCNCODE) as [Location Code],  QTYONHND as [QTY On Hand],  QTYORDER as [QTY Ordered],  QTYREMAI as [QTY Remaining],  rtrim(SALSTERR) as [Sales Territory],  rtrim(SLPRSNID) as [Salesperson ID]  FROM   ((SELECT   hdr.SOPNUMBE, line.ITEMNMBR, ITEMDESC, QUANTITY, line.LOCNCODE, BACKDATE,   hdr.SOPTYPE, QTYONHND, QTYORDER, QTYREMAI, line.SALSTERR, line.SLPRSNID  FROM   SOP30200 as hdr JOIN SOP30300 as line ON hdr.SOPNUMBE = line.SOPNUMBE) UNION   SELECT   hdr.SOPNUMBE, line.ITEMNMBR, ITEMDESC, QUANTITY, line.LOCNCODE, BACKDATE,   hdr.SOPTYPE, QTYONHND, QTYORDER, QTYREMAI, line.SALSTERR, line.SLPRSNID  FROM   SOP10100 as hdr JOIN SOP10200 as line ON hdr.SOPNUMBE = line.SOPNUMBE) sub  WHERE   sub.BACKDATE BETWEEN dbo.GetBeginningDate(@UserDate, 'Fiscal', @TimeUnit, 1) AND @UserDate AND  sub.SOPTYPE = 5 AND ITEMNMBR in (select ITEMNMBR from @ItemsTemp)  ORDER BY  QUANTITY DESC, ITEMNMBR ASC  end    
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopBackOrderedItems] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopBackOrderedItems] TO [rpt_executive]
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopBackOrderedItems] TO [rpt_materials manager]
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopBackOrderedItems] TO [rpt_operations manager]
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopBackOrderedItems] TO [rpt_order processor]
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopBackOrderedItems] TO [rpt_shipping and receiving]
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopBackOrderedItems] TO [rpt_warehouse manager]
GO
