SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE PROC [dbo].[aagUpdateOriginalRec] @I_aaBatchNumber CHAR(15) AS BEGIN  DECLARE @nSubLedgerHdrID INTEGER,  @FA_Doc_Number CHAR(21),  @nDistID INTEGER,  @TRXNUMBER INTEGER,  @OldaaSubLedgerHdrID INTEGER,  @OldaaSubLedgerDistID INTEGER,  @ACTINDX INTEGER   SELECT @nSubLedgerHdrID = aaSubLedgerHdrID FROM AAG20000 WHERE DOCNUMBR = @I_aaBatchNumber AND SERIES = 2 AND DOCTYPE = 0    DECLARE FASubLedgerLine CURSOR FAST_FORWARD FOR  SELECT FINANCIALINDX,FA_Doc_Number,GLINTACCTINDX FROM FA00902 WHERE GLINTBTCHNUM = @I_aaBatchNumber   ORDER BY FINANCIALINDX ASC  OPEN FASubLedgerLine  FETCH NEXT FROM FASubLedgerLine   INTO @TRXNUMBER,@FA_Doc_Number,@ACTINDX  WHILE @@FETCH_STATUS = 0  BEGIN  SELECT @OldaaSubLedgerHdrID = A0.aaSubLedgerHdrID , @OldaaSubLedgerDistID = A1.aaSubLedgerDistID FROM AAG20001 A1   INNER JOIN AAG20000 A0 ON A1.aaSubLedgerHdrID = A0.aaSubLedgerHdrID  WHERE A0.DOCNUMBR = @FA_Doc_Number AND A0.SERIES = 2 AND RTRIM(A1.TRXNUMBER) = RTRIM(@TRXNUMBER)   SELECT @nDistID = aaSubLedgerDistID FROM AAG20001 WHERE aaSubLedgerHdrID = @nSubLedgerHdrID AND RTRIM(TRXNUMBER) = RTRIM(@TRXNUMBER)   UPDATE AAG20001 SET aaChangeDate = CONVERT(CHAR(12), GETDATE(), 102), aaChangeTime = CONVERT(CHAR(12), GETDATE(), 108) FROM AAG20001 WHERE aaSubLedgerHdrID = @OldaaSubLedgerHdrID AND aaSubLedgerDistID = @OldaaSubLedgerDistID   DELETE FROM AAG20003 WHERE aaSubLedgerHdrID = @OldaaSubLedgerHdrID AND aaSubLedgerDistID = @OldaaSubLedgerDistID  DELETE FROM AAG20002 WHERE aaSubLedgerHdrID = @OldaaSubLedgerHdrID AND aaSubLedgerDistID = @OldaaSubLedgerDistID   INSERT INTO AAG20002 ([aaSubLedgerHdrID], [aaSubLedgerDistID], [aaSubLedgerAssignID], [DEBITAMT], [CRDTAMNT], [ORDBTAMT], [ORCRDAMT], [aaAssignedPercent], [DistRef], [NOTEINDX], [aaAssignErrors], [aaAliasID])  SELECT @OldaaSubLedgerHdrID, @OldaaSubLedgerDistID, [aaSubLedgerAssignID], [DEBITAMT], [CRDTAMNT], [ORDBTAMT], [ORCRDAMT], [aaAssignedPercent], [DistRef], [NOTEINDX], [aaAssignErrors], [aaAliasID]  FROM AAG20002  WHERE aaSubLedgerHdrID = @nSubLedgerHdrID AND aaSubLedgerDistID = @nDistID   INSERT INTO AAG20003 ([aaSubLedgerHdrID], [aaSubLedgerDistID], [aaSubLedgerAssignID], [aaTrxDimID], [aaTrxCodeID], [aaCodeErrors])  SELECT @OldaaSubLedgerHdrID, @OldaaSubLedgerDistID, [aaSubLedgerAssignID], [aaTrxDimID], [aaTrxCodeID], [aaCodeErrors]  FROM AAG20003  WHERE aaSubLedgerHdrID = @nSubLedgerHdrID AND aaSubLedgerDistID = @nDistID   FETCH NEXT FROM FASubLedgerLine   INTO @TRXNUMBER,@FA_Doc_Number,@ACTINDX  END  CLOSE FASubLedgerLine  DEALLOCATE FASubLedgerLine  END   
GO
GRANT EXECUTE ON  [dbo].[aagUpdateOriginalRec] TO [DYNGRP]
GO
