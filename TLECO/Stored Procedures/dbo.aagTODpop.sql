SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create     procedure [dbo].[aagTODpop]  @SqlSessionID int as begin  set nocount on  declare @CMPANYID int,  @HdrID int,  @DOCTYPE int,  @DOCNUMBR char(21)   select  @CMPANYID = CMPANYID from DYNAMICS.dbo.SY01500 where INTERID = DB_NAME()   declare CPOP cursor fast_forward for   select POPTYPE,POPRCTNM  from POP10300   union all   select POPTYPE,POPRCTNM   from POP30300  union all   select DISTINCT 21,POPRequisitionNumber   from POP10200  open CPOP  fetch next from CPOP into @DOCTYPE,@DOCNUMBR  while @@fetch_status = 0  begin  insert into AAG20000  (aaSubLedgerHdrID,SERIES,DOCTYPE,DOCNUMBR,Master_ID,aaHdrErrors)  values(dbo.aagGetNextHdrID(20000),12,@DOCTYPE,@DOCNUMBR,' ',0)  fetch next from CPOP into @DOCTYPE,@DOCNUMBR  end  close CPOP  deallocate CPOP   update DYNAMICS..AAG00102 set aaRowID = dbo.aagGetNextHdrID(20000) - 1  where aaTableID = 20000 and CMPANYID = @CMPANYID   insert into AAG20001   (aaSubLedgerHdrID, aaSubLedgerDistID, INTERID, ACTINDX, DISTTYPE, aaBrowseType,   DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, CURNCYID, CURRNIDX, SEQNUMBR,  GLPOSTDT, aaCustID, POSTED ,RATETPID, EXGTBLID, XCHGRATE, EXCHDATE, TIME1,  RTCLCMTD, DENXRATE, MCTRXSTT,aaChangeDate,aaChangeTime,ACCTTYPE,TRNSTLOC)  select dbo.aagGetHdrID(12,POP10300.POPTYPE,POP10300.POPRCTNM,' ',0,0, getdate(),0,' ',20000),  POP10390.DEX_ROW_ID,  DB_NAME(), POP10390.ACTINDX, POP10390.DISTTYPE, 0,   POP10390.DEBITAMT, POP10390.CRDTAMNT, POP10390.ORDBTAMT, POP10390.ORCRDAMT, isnull(POP10390.CURNCYID,' '), POP10390.CURRNIDX, POP10390.SEQNUMBR,  POP10300.GLPOSTDT, '', 1, isnull(POP10390.RATETPID,' '), isnull(POP10390.EXGTBLID,' '), POP10390.XCHGRATE, POP10390.EXCHDATE, POP10390.TIME1,   POP10390.RATECALC, POP10390.DENXRATE, POP10390.MCTRXSTT,convert(char(12), getdate(), 102),convert(char(12), getdate(), 108),  dbo.aagGetAccountType(POP10390.ACTINDX), ''  from POP10390, POP10300 where POP10390.POPRCTNM = POP10300.POPRCTNM  union all  select dbo.aagGetHdrID(12,POP30300.POPTYPE,POP30300.POPRCTNM,' ',0,0, getdate(),0,' ',20000),  POP30390.DEX_ROW_ID,  DB_NAME(), POP30390.ACTINDX, POP30390.DISTTYPE, 0,   POP30390.DEBITAMT, POP30390.CRDTAMNT, POP30390.ORDBTAMT, POP30390.ORCRDAMT, isnull(POP30390.CURNCYID,' '), POP30390.CURRNIDX, POP30390.SEQNUMBR,  POP30300.GLPOSTDT, '', 1, isnull(POP30390.RATETPID,' '), isnull(POP30390.EXGTBLID,' '), POP30390.XCHGRATE, POP30390.EXCHDATE, POP30390.TIME1,   POP30390.RATECALC, POP30390.DENXRATE, POP30390.MCTRXSTT,convert(char(12), getdate(), 102),convert(char(12), getdate(), 108),  dbo.aagGetAccountType(POP30390.ACTINDX), ''  from POP30390, POP30300 where POP30390.POPRCTNM = POP30300.POPRCTNM  union all  select dbo.aagGetHdrID(12,21,POP10200.POPRequisitionNumber,' ',0,0, getdate(),0,' ',20000),  POP10210.DEX_ROW_ID,  DB_NAME(), POP10210.INVINDX, 0, 0,   POP10210.EXTDCOST, 0, POP10210.OREXTCST, 0, isnull(POP10210.CURNCYID,' '), POP10210.CURRNIDX, POP10210.ORD,  POP10200.DOCDATE, '', 1, isnull(POP10210.RATETPID,' '), isnull(POP10210.EXGTBLID,' '), POP10210.XCHGRATE, POP10210.EXCHDATE, POP10210.TIME1,   POP10210.RATECALC, POP10210.DENXRATE, POP10210.MCTRXSTT,convert(char(12), getdate(), 102),convert(char(12), getdate(), 108),  dbo.aagGetAccountType(POP10210.INVINDX), LineNumber  from POP10210, POP10200 where POP10210.POPRequisitionNumber = POP10200.POPRequisitionNumber  Update AAG20001 SET aaSubLedgerDistID=0-aaSubLedgerDistID  where aaSubLedgerHdrID not in (select distinct aaSubLedgerHdrID from AAG20002)  UPDATE AAG20001   SET aaSubLedgerDistID = (SELECT COUNT(1) FROM AAG20001 AA WHERE AAG20001.DEX_ROW_ID >= AA.DEX_ROW_ID AND AA.aaSubLedgerHdrID = AAG20001.aaSubLedgerHdrID )  where AAG20001.aaSubLedgerHdrID not in (select distinct aaSubLedgerHdrID from AAG20002)   insert into AAG20002   (aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID,DEBITAMT,  CRDTAMNT,ORDBTAMT,ORCRDAMT,aaAssignedPercent,DistRef,NOTEINDX,aaAssignErrors)  select aaSubLedgerHdrID,aaSubLedgerDistID,1,DEBITAMT,  CRDTAMNT,ORDBTAMT,ORCRDAMT,10000,' ',0,0 from AAG20001 where aaSubLedgerHdrID in  (select aaSubLedgerHdrID from AAG20000 where SERIES = 12)   set nocount off end    
GO
GRANT EXECUTE ON  [dbo].[aagTODpop] TO [DYNGRP]
GO
