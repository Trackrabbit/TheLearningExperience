SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aagCreateRecordsforCompCheckPrePayment]  @BCHNMBR VARCHAR(100),  @BCHSORCE VARCHAR(100),  @CompanyID SMALLINT,  @SqlSessionID INT,  @l_ErrorCode SMALLINT = NULL OUTPUT AS  BEGIN   DECLARE   @PMNTNMBR VARCHAR(100),  @TRXSORCE VARCHAR(100),  @PONUMBER VARCHAR(100),  @VCHRNMBR VARCHAR(100),  @aaSubLedgerHdrID INT,  @aaSubLedgerDistID INT,  @DSTINDX INT,  @DISTTYPE INT,  @DEBITAMT NUMERIC(19,5),  @CRDTAMNT NUMERIC(19,5),  @ORCRDAMT NUMERIC(19,5),  @ORDBTAMT NUMERIC(19,5),  @NOTEINDX NUMERIC(19,5),  @aaBrowseType INT,  @RequiredFieldEmpty TINYINT,  @CURNCYID CHAR(15),  @CURRNIDX SMALLINT,  @RATETPID CHAR(15),  @EXGTBLID CHAR(15),  @XCHGRATE NUMERIC(19,5),  @EXCHDATE DATETIME,  @TIME1 DATETIME,  @RTCLCMTD SMALLINT,  @DENXRATE NUMERIC(19,5),  @MCTRXSTT INT,  @ACCTTYPE SMALLINT,  @PSTGDATE DATETIME,  @VENDORID CHAR(15),  @DSTSQNUM INT,  @ClassID INT,  @DECPLACS SMALLINT   SELECT @ClassID   = 0, @DECPLACS = 0   DECLARE Cursor1 CURSOR LOCAL FAST_FORWARD FOR   SELECT PONUMBER, PMNTNMBR, VCHRNMBR FROM PM10300 WHERE BACHNUMB = @BCHNMBR AND BCHSOURC = @BCHSORCE  OPEN Cursor1  FETCH NEXT FROM Cursor1 INTO @PONUMBER, @PMNTNMBR, @VCHRNMBR  WHILE @@FETCH_STATUS = 0  BEGIN   SELECT @aaSubLedgerHdrID = ISNULL(aaSubLedgerHdrID,0) FROM AAG20000 WHERE (DOCNUMBR = @PONUMBER OR DOCNUMBR = @PMNTNMBR) AND SERIES = 4 AND DOCTYPE = 1  IF @aaSubLedgerHdrID <> 0  UPDATE AAG20000 SET DOCNUMBR = @PMNTNMBR WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID  else  EXEC DYNAMICS.dbo.aagGetNextID 20000, @CompanyID, @aaSubLedgerHdrID out  SELECT @ACCTTYPE =0   DECLARE Cursor2 CURSOR LOCAL FAST_FORWARD FOR   SELECT DSTINDX, DEBITAMT, ORDBTAMT, CRDTAMNT, ORCRDAMT, DISTTYPE, CURNCYID, CURRNIDX, DSTSQNUM, DECPLACS,  PSTGDATE, VENDORID ,RATETPID, EXGTBLID, XCHGRATE, EXCHDATE, TIME1,  RTCLCMTD, DENXRATE, MCTRXSTT FROM PM10100 WHERE VCHRNMBR = @VCHRNMBR  OPEN Cursor2  FETCH NEXT FROM Cursor2 INTO @DSTINDX, @DEBITAMT, @ORDBTAMT, @CRDTAMNT, @ORCRDAMT, @DISTTYPE, @CURNCYID, @CURRNIDX, @DSTSQNUM, @DECPLACS,  @PSTGDATE, @VENDORID, @RATETPID, @EXGTBLID, @XCHGRATE, @EXCHDATE, @TIME1, @RTCLCMTD, @DENXRATE, @MCTRXSTT  WHILE @@FETCH_STATUS = 0  BEGIN    SELECT @aaSubLedgerDistID = aaSubLedgerDistID FROM AAG20001 where aaSubLedgerHdrID = @aaSubLedgerHdrID   AND ACTINDX = @DSTINDX AND DEBITAMT = @DEBITAMT AND ORDBTAMT = @ORDBTAMT AND CRDTAMNT = @CRDTAMNT AND ORCRDAMT = @ORCRDAMT   IF @aaSubLedgerDistID is NOT NULL  BEGIN  UPDATE AAG20001 SET DISTTYPE = @DISTTYPE, aaCopyStatus = 8, aaWinWasOpen = 1, POSTED = 0  where aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID  END  ELSE  BEGIN  SELECT @aaSubLedgerDistID = ISNULL(MAX(aaSubLedgerDistID),0)+1 FROM AAG20001 where aaSubLedgerHdrID = @aaSubLedgerHdrID  SELECT @ACCTTYPE = ACCTTYPE FROM GL00100 WHERE ACTINDX = @DSTINDX  exec aagGetClassIDBrowseType @DSTINDX, @ClassID output, @aaBrowseType output   INSERT INTO AAG20001   (aaSubLedgerHdrID, aaSubLedgerDistID, INTERID, ACTINDX, ACCTTYPE, DISTTYPE, aaBrowseType,   DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, CURNCYID, CURRNIDX, SEQNUMBR, DECPLACS,  GLPOSTDT, aaVendID, POSTED ,RATETPID, EXGTBLID, XCHGRATE, EXCHDATE, TIME1,  RTCLCMTD, DENXRATE, MCTRXSTT,aaChangeDate,aaChangeTime)   SELECT   @aaSubLedgerHdrID, @aaSubLedgerDistID, DB_NAME(), @DSTINDX, @ACCTTYPE, @DISTTYPE, @aaBrowseType,  @DEBITAMT, @CRDTAMNT, @ORDBTAMT, @ORCRDAMT, @CURNCYID, @CURRNIDX, @DSTSQNUM, @DECPLACS,  @PSTGDATE, @VENDORID, 0, @RATETPID, @EXGTBLID, @XCHGRATE, @EXCHDATE, @TIME1,  @RTCLCMTD, @DENXRATE, @MCTRXSTT,convert(char(12), getdate(), 102),CONVERT(CHAR(12), GETDATE(), 108)  FROM AAG20001  WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID   exec DYNAMICS.dbo.smGetNextNoteIndex @CompanyID, @SqlSessionID, @NOTEINDX output  INSERT INTO  AAG20002  (aaSubLedgerHdrID, aaSubLedgerDistID, aaSubLedgerAssignID, DEBITAMT, CRDTAMNT, ORDBTAMT,  ORCRDAMT, aaAssignedPercent, DistRef, NOTEINDX, aaAssignErrors)  VALUES (@aaSubLedgerHdrID, @aaSubLedgerDistID,1, @DEBITAMT, @CRDTAMNT, @ORDBTAMT,  @ORCRDAMT,10000, '', @NOTEINDX,0)  IF @aaBrowseType <> 0  BEGIN  EXEC aagSubLedgerCodeUpdate @aaSubLedgerHdrID, @aaSubLedgerDistID, 1, @ClassID, @RequiredFieldEmpty output  END  END   FETCH NEXT FROM Cursor2 INTO @DSTINDX, @DEBITAMT, @ORDBTAMT, @CRDTAMNT, @ORCRDAMT, @DISTTYPE, @CURNCYID, @CURRNIDX, @DSTSQNUM, @DECPLACS,  @PSTGDATE, @VENDORID, @RATETPID, @EXGTBLID, @XCHGRATE, @EXCHDATE, @TIME1, @RTCLCMTD, @DENXRATE, @MCTRXSTT  END  CLOSE Cursor2  DEALLOCATE Cursor2  SELECT @aaSubLedgerDistID = NULL   EXEC aagRenumberAADistsForRMApply @aaSubLedgerHdrID, 16384  UPDATE AAG20001 SET POSTED = 1  where aaSubLedgerHdrID = @aaSubLedgerHdrID   FETCH NEXT FROM Cursor1 INTO @PONUMBER, @PMNTNMBR, @VCHRNMBR  END  CLOSE Cursor1  DEALLOCATE Cursor1 END   
GO
GRANT EXECUTE ON  [dbo].[aagCreateRecordsforCompCheckPrePayment] TO [DYNGRP]
GO
