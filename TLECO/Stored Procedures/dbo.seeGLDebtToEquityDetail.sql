SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
create procedure [dbo].[seeGLDebtToEquityDetail]   @UserDate datetime = '',    @Label varchar(30) = '',     @CurrPrevType smallint,     @Date datetime = NULL as SET NOCOUNT ON IF (@Label IS NULL OR @Label = '') BEGIN  SET @Label = (SELECT rtrim(PERNAME) AS PERNAME        FROM (SELECT DISTINCT(PERNAME), PERIODID        FROM SY40100        WHERE PERNAME <> 'Beginning Balance'         and @Date between PERIODDT and PERDENDT) SY40100)  END IF (@UserDate IS NULL or @UserDate = '') BEGIN  SET @UserDate = ISNULL(@Date,GetDate()) END DECLARE @IsHist int   DECLARE @CurrentYear int DECLARE @DATEMAX datetime DECLARE @StartDate datetime DECLARE @EndDate datetime  DECLARE @PERIODOD smallint DECLARE @BeginingBalance numeric DECLARE @DetailDates TABLE (StartDate datetime,  EndDate datetime,  DateLabel varchar(30),  CurrPrevType int) INSERT INTO @DetailDates  SELECT   StartDate, EndDate, DateLabel, CurrPrevType  FROM   GetKPIDetailDates(@UserDate, 'Fiscal') SET @StartDate = (select StartDate from @DetailDates where DateLabel = @Label and CurrPrevType = @CurrPrevType) SET @EndDate = (select EndDate from @DetailDates where DateLabel = @Label and CurrPrevType = @CurrPrevType) SELECT @CurrentYear = YEAR1,   @IsHist = HISTORYR  FROM SY40101  WHERE @StartDate between FSTFSCDY and LSTFSCDY  SELECT @PERIODOD = PERIODID   FROM SY40100  WHERE @StartDate between PERIODDT and PERDENDT   AND PERIODID <> 0   AND  FORIGIN = 1   AND YEAR1 = @CurrentYear create table #Liabilities_Detail (ATYPE smallint,  ACTNUMST char (129),  ACTDESCR char (51),  JRNENTRY int,  TRXDATE datetime,  ACCATDSC char (51),  DEBITAMT numeric(19,5),  CRDTAMNT numeric(19,5),  [Journal Entry For Drillback] varchar(500),  [Account Index For Drillback] varchar(500)) create table #Equity_Detail (ATYPE smallint,  ACTNUMST char (129),  ACTDESCR char (51),  JRNENTRY int,  TRXDATE datetime,  ACCATDSC char (51),  DEBITAMT numeric(19,5),  CRDTAMNT numeric(19,5),  [Journal Entry For Drillback] varchar(500),  [Account Index For Drillback] varchar(500)) IF @IsHist = 1  BEGIN  INSERT INTO #Equity_Detail (ATYPE, ACTNUMST, ACTDESCR, JRNENTRY, TRXDATE, ACCATDSC, DEBITAMT, CRDTAMNT, [Journal Entry For Drillback], [Account Index For Drillback])    SELECT 0, ACTNUMST, GL00100.ACTDESCR, JRNENTRY, TRXDATE, GL00102.ACCATDSC, ISNULL(DEBITAMT,0.00) as DEBITAMT, ISNULL(CRDTAMNT,0.00) as CRDTAMNT, [Journal Entry For Drillback], [Account Index For Drillback]  FROM GL30000   join GL00100 on    GL30000.ACTINDX = GL00100.ACTINDX  join GL00105 on   GL30000.ACTINDX = GL00105.ACTINDX  join GL00102 on   GL00100.ACCATNUM = GL00102.ACCATNUM   join (SELECT DISTINCT [Journal Entry],  [Journal Entry For Drillback]    FROM [AccountTransactions]) AccountTransactions on   GL30000.JRNENTRY = AccountTransactions.[Journal Entry]  join (SELECT DISTINCT [Account Index], [Account Index For Drillback]    FROM [AccountTransactions]) AccountDrillback on   GL30000.ACTINDX = AccountDrillback.[Account Index]  WHERE   GL00100.ACCATNUM in (23, 24, 25, 26, 27, 28)   AND   TRXDATE >= @StartDate    AND   TRXDATE <= @EndDate  INSERT INTO #Liabilities_Detail (ATYPE, ACTNUMST, ACTDESCR, JRNENTRY, TRXDATE, ACCATDSC, DEBITAMT, CRDTAMNT, [Journal Entry For Drillback], [Account Index For Drillback])    SELECT 1, ACTNUMST, GL00100.ACTDESCR, JRNENTRY, TRXDATE, GL00102.ACCATDSC, ISNULL(DEBITAMT,0.00) as DEBITAMT, ISNULL(CRDTAMNT,0.00) as CRDTAMNT, [Journal Entry For Drillback], [Account Index For Drillback]  FROM GL30000   join GL00100 on    GL30000.ACTINDX = GL00100.ACTINDX  join GL00105 on   GL30000.ACTINDX = GL00105.ACTINDX  join GL00102 on   GL00100.ACCATNUM = GL00102.ACCATNUM   join (SELECT DISTINCT [Journal Entry],  [Journal Entry For Drillback]    FROM [AccountTransactions]) AccountTransactions on   GL30000.JRNENTRY = AccountTransactions.[Journal Entry]  join (SELECT DISTINCT [Account Index], [Account Index For Drillback]    FROM [AccountTransactions]) AccountDrillback on   GL30000.ACTINDX = AccountDrillback.[Account Index]  WHERE   GL00100.ACCATNUM in (13,14,15,16,17,18,19,20,21,22)   AND   TRXDATE >= @StartDate    AND   TRXDATE <= @EndDate END   ELSE  BEGIN     INSERT INTO #Equity_Detail (ATYPE, ACTNUMST, ACTDESCR, JRNENTRY, TRXDATE, ACCATDSC, DEBITAMT, CRDTAMNT, [Journal Entry For Drillback], [Account Index For Drillback])     SELECT 0, ACTNUMST, GL00100.ACTDESCR, JRNENTRY, TRXDATE, GL00102.ACCATDSC, ISNULL(DEBITAMT,0.00) as DEBITAMT, ISNULL(CRDTAMNT,0.00) as CRDTAMNT, [Journal Entry For Drillback], [Account Index For Drillback]  FROM GL20000   join GL00100 on    GL20000.ACTINDX = GL00100.ACTINDX   join GL00105 on   GL20000.ACTINDX = GL00105.ACTINDX  join GL00102 on   GL00100.ACCATNUM = GL00102.ACCATNUM  join (SELECT DISTINCT [Journal Entry],  [Journal Entry For Drillback]    FROM [AccountTransactions]) AccountTransactions on   GL20000.JRNENTRY = AccountTransactions.[Journal Entry]  join (SELECT DISTINCT [Account Index], [Account Index For Drillback]    FROM [AccountTransactions]) AccountDrillback on   GL20000.ACTINDX = AccountDrillback.[Account Index]    WHERE   GL00100.ACCATNUM  in (23, 24, 25, 26, 27, 28)   AND   TRXDATE >= @StartDate    AND   TRXDATE <= @EndDate  INSERT INTO #Liabilities_Detail (ATYPE, ACTNUMST, ACTDESCR, JRNENTRY, TRXDATE, ACCATDSC, DEBITAMT, CRDTAMNT, [Journal Entry For Drillback], [Account Index For Drillback])     SELECT 1, ACTNUMST, GL00100.ACTDESCR, JRNENTRY, TRXDATE, GL00102.ACCATDSC, ISNULL(DEBITAMT,0.00) as DEBITAMT, ISNULL(CRDTAMNT,0.00) as CRDTAMNT, [Journal Entry For Drillback], [Account Index For Drillback]  FROM GL20000   join GL00100 on    GL20000.ACTINDX = GL00100.ACTINDX   join GL00105 on   GL20000.ACTINDX = GL00105.ACTINDX  join GL00102 on   GL00100.ACCATNUM = GL00102.ACCATNUM  join (SELECT DISTINCT [Journal Entry],  [Journal Entry For Drillback]    FROM [AccountTransactions]) AccountTransactions on   GL20000.JRNENTRY = AccountTransactions.[Journal Entry]  join (SELECT DISTINCT [Account Index], [Account Index For Drillback]    FROM [AccountTransactions]) AccountDrillback on   GL20000.ACTINDX = AccountDrillback.[Account Index]    WHERE   GL00100.ACCATNUM  in (13,14,15,16,17,18,19,20,21,22)   AND   TRXDATE >= @StartDate    AND   TRXDATE <= @EndDate END SELECT ATYPE, ACTNUMST, ACTDESCR, JRNENTRY, TRXDATE, ACCATDSC, DEBITAMT, CRDTAMNT, [Journal Entry For Drillback], [Account Index For Drillback] from #Equity_Detail UNION ALL SELECT ATYPE, ACTNUMST, ACTDESCR, JRNENTRY, TRXDATE, ACCATDSC, DEBITAMT, CRDTAMNT, [Journal Entry For Drillback], [Account Index For Drillback] from #Liabilities_Detail ORDER BY ATYPE, ACTNUMST, TRXDATE           
GO
GRANT EXECUTE ON  [dbo].[seeGLDebtToEquityDetail] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[seeGLDebtToEquityDetail] TO [rpt_accounting manager]
GO
GRANT EXECUTE ON  [dbo].[seeGLDebtToEquityDetail] TO [rpt_bookkeeper]
GO
GRANT EXECUTE ON  [dbo].[seeGLDebtToEquityDetail] TO [rpt_certified accountant]
GO
GRANT EXECUTE ON  [dbo].[seeGLDebtToEquityDetail] TO [rpt_executive]
GO
