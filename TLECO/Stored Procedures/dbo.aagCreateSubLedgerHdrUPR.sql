SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROC [dbo].[aagCreateSubLedgerHdrUPR]   @AuditCtrlCode VARCHAR(15), @iCompanyID SMALLINT, @UserID VARCHAR(15) AS  DECLARE @SubLedgerHdrID INT, @Status SMALLINT, @Series SMALLINT, @DocType SMALLINT, @MasterID VARCHAR(15), @PayRunType SMALLINT,   @RecordExists SMALLINT  SET @RecordExists = 0   DECLARE CreateHdrRecords CURSOR FAST_FORWARD  FOR   SELECT 6 AS SERIES, 3 AS DOCTYPE, EMPLOYID AS Master_ID, 0 AS PYRNTYPE FROM UPR30401   WHERE LTRIM(RTRIM(AUCTRLCD)) = LTRIM(RTRIM(@AuditCtrlCode))  GROUP BY AUCTRLCD, EMPLOYID  OPEN CreateHdrRecords  FETCH NEXT FROM CreateHdrRecords INTO @Series, @DocType, @MasterID, @PayRunType  WHILE @@FETCH_STATUS = 0  BEGIN  SELECT @RecordExists = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG20000  WHERE SERIES = 6 AND DOCTYPE = 2 AND LTRIM(RTRIM(DOCNUMBR)) = LTRIM(RTRIM(@UserID)) AND   LTRIM(RTRIM(Master_ID)) = LTRIM(RTRIM(@MasterID)) AND PYRNTYPE = 0  IF @RecordExists = 1   BEGIN  SELECT @SubLedgerHdrID = aaSubLedgerHdrID FROM AAG20000  WHERE SERIES = 6 AND DOCTYPE = 2 AND LTRIM(RTRIM(DOCNUMBR)) = LTRIM(RTRIM(@UserID)) AND   LTRIM(RTRIM(Master_ID)) = LTRIM(RTRIM(@MasterID)) AND PYRNTYPE = 0  UPDATE AAG20000 SET DOCTYPE = 3, DOCNUMBR = LTRIM(RTRIM(@AuditCtrlCode))  WHERE SERIES = 6 AND DOCTYPE = 2 AND LTRIM(RTRIM(DOCNUMBR)) = LTRIM(RTRIM(@UserID)) AND  LTRIM(RTRIM(Master_ID)) = LTRIM(RTRIM(@MasterID)) AND PYRNTYPE = 0  END  ELSE   BEGIN  EXEC DYNAMICS..aagGetNextID 20000, @iCompanyID, @SubLedgerHdrID OUT, @Status OUT  INSERT INTO AAG20000(aaSubLedgerHdrID, SERIES, DOCTYPE, DOCNUMBR, Master_ID, PYRNTYPE)  VALUES(@SubLedgerHdrID, @Series, @DocType, LTRIM(RTRIM(@AuditCtrlCode)), LTRIM(RTRIM(@MasterID)), @PayRunType)   END  EXEC aagCreateSubLedgerDistUPR @SubLedgerHdrID, @AuditCtrlCode, @MasterID  FETCH NEXT FROM CreateHdrRecords INTO @Series, @DocType, @MasterID, @PayRunType  END  CLOSE CreateHdrRecords  DEALLOCATE CreateHdrRecords    
GO
GRANT EXECUTE ON  [dbo].[aagCreateSubLedgerHdrUPR] TO [DYNGRP]
GO
