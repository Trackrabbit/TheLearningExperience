SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE PROC [dbo].[aagFA_UpdateSetupForTransfer] @TransferIndex INT AS BEGIN  DECLARE @AcctIndx INT,  @TempAcctIndex INT,  @ListID SMALLINT,  @aaFASetupID INT,  @aaBrowseType SMALLINT,  @AcctClassID INT,  @AcctType SMALLINT,  @aaAliasID INT  SET @ListID=1  SET @aaAliasID=0   SELECT @aaAliasID = aaAliasID FROM  FA00100 WHERE ASSETINDEX = (SELECT ASSETINDEX FROM FA00801 WHERE TRANSFERINDX=@TransferIndex)  DECLARE CURSOR_SETP CURSOR FAST_FORWARD FOR  SELECT ACT FROM (SELECT TRANSFERINDX, TODEPREXPACCTINDX, TODEPRRESVACCTINDX, TOPRYRDEPRACCTINDX, TOASSETCOSTACCTINDX, TOPROCEEDSACCTINDX, TORECGAINLOSSACCTINDX,   TONONRECGAINLOSSACCTINDX, TOCLEARACCTINDX FROM FA00801 WHERE TRANSFERINDX = @TransferIndex) p  UNPIVOT (ACT FOR ASSETI in ( TODEPREXPACCTINDX, TODEPRRESVACCTINDX, TOPRYRDEPRACCTINDX, TOASSETCOSTACCTINDX, TOPROCEEDSACCTINDX, TORECGAINLOSSACCTINDX,   TONONRECGAINLOSSACCTINDX,TOCLEARACCTINDX )) as a WHERE TRANSFERINDX = @TransferIndex   OPEN CURSOR_SETP   FETCH NEXT FROM CURSOR_SETP INTO @AcctIndx  WHILE @@fetch_status = 0  BEGIN  SELECT @aaFASetupID=aaFASetupID,@TempAcctIndex=ACTINDX FROM AAG04000 WHERE aaAssetIndex>(SELECT INDXVALUE FROM FAINDEX WHERE INDXNAME=2) AND aaBookIndex=@TransferIndex AND ListID=@ListID  IF @TempAcctIndex!=@AcctIndx   BEGIN  UPDATE AAG04000 SET ACTINDX=@AcctIndx,aaAliasID=@aaAliasID WHERE aaFASetupID=@aaFASetupID AND ListID=@ListID  DELETE FROM  AAG04001 WHERE aaFASetupID=@aaFASetupID AND ListID=@ListID  SELECT @AcctType=ACCTTYPE FROM GL00100 WHERE ACTINDX=@AcctIndx  EXEC aagGetClassIDBrowseType @AcctIndx,@AcctClassID OUTPUT,@aaBrowseType OUTPUT   IF @aaAliasID=0   BEGIN  INSERT INTO AAG04001 (aaFASetupID, ListID,aaTrxDimID, aaTrxDimCodeID)   SELECT @aaFASetupID, @ListID,aaTrxDimID,aaTrxDimCodeIDDflt  FROM AAG00202 WHERE aaAcctClassID = @AcctClassID AND aaTrxDimID >=0   AND aaTrxDimID NOT IN (SELECT l.aaTrxDimID FROM AAG04001 l WHERE l.aaFASetupID = @aaFASetupID AND l.ListID = @ListID )  END  ELSE  BEGIN  INSERT INTO AAG04001 (aaFASetupID, ListID,aaTrxDimID, aaTrxDimCodeID)   SELECT @aaFASetupID, @ListID, aaTrxDimID,aaTrxDimCodeID  FROM AAG00801 WHERE aaAliasID=@aaAliasID and aaTrxDimID >=0   AND aaTrxDimID NOT IN (SELECT l.aaTrxDimID FROM AAG04001 l WHERE l.aaFASetupID = @aaFASetupID AND l.ListID = @ListID)  END  END  SET @ListID=@ListID+1  FETCH NEXT FROM CURSOR_SETP INTO @AcctIndx  END  CLOSE CURSOR_SETP  DEALLOCATE CURSOR_SETP END   
GO
GRANT EXECUTE ON  [dbo].[aagFA_UpdateSetupForTransfer] TO [DYNGRP]
GO
