SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[rmBalanceForwardConsolidation]  @I_vCustomerNumber varchar(21) = NULL,  @I_tTransactionCutoffDate datetime = NULL,  @I_dUserDate datetime = NULL,  @I_cFunctionalCurrency char(15) = NULL,  @O_cBalanceForwardNumber char(21) = NULL output,  @O_iErrorState                  int             = NULL output as  declare  @TRUE tinyint,  @FALSE tinyint,  @BFCDescription char(31),  @cDBName char(5),  @cDocumentNumber char(21),  @tLoopControl           tinyint,  @iStatus int,  @iError                 int  select  @TRUE  = 1,  @FALSE = 0  select  @O_iErrorState = 0,  @iStatus = 0,  @O_cBalanceForwardNumber = ''  while @tLoopControl is NULL begin  select @tLoopControl = 1   if @I_vCustomerNumber is NULL or  @I_tTransactionCutoffDate is NULL or  @I_dUserDate is NULL or  @I_cFunctionalCurrency is NULL   begin  select @O_iErrorState = 20854  break  end    select @cDBName = db_name()  exec @iStatus = DYNAMICS.dbo.smGetMsgString  10252,  @cDBName,  @BFCDescription output,   @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   if NOT EXISTS(select  1  from  RM20101  where  CUSTNMBR = @I_vCustomerNumber  and DOCNUMBR = @I_vCustomerNumber + '^' + replicate('0',(19 - len(@I_vCustomerNumber)))  and RMDTYPAL = 0 )  and  EXISTS(select 1 from #Documents)  begin  insert into  RM20101(  CUSTNMBR,  DOCNUMBR,  RMDTYPAL,  DUEDATE,  DOCDATE,  GLPOSTDT,  TRXDSCRN,  AGNGBUKT,  CURNCYID,  Tax_Date )  values(  @I_vCustomerNumber,  @I_vCustomerNumber + '^' + replicate('0',(19 - len(@I_vCustomerNumber))),  0,  @I_dUserDate,  @I_dUserDate,  @I_dUserDate,   @BFCDescription,  2,   @I_cFunctionalCurrency,  @I_dUserDate )  end   if NOT EXISTS(select  1  from  RM00401  where  DOCNUMBR = @I_vCustomerNumber + '^' + replicate('0',(19 - len(@I_vCustomerNumber)))  and RMDTYPAL = 0 )  and  EXISTS(select 1 from #Documents)  begin  Insert into  RM00401(  DOCNUMBR,  RMDTYPAL,  DCSTATUS,  CUSTNMBR,  DOCDATE )  values(  @I_vCustomerNumber + '^' + replicate('0',(19 - len(@I_vCustomerNumber))),  0,  2,   @I_vCustomerNumber,  @I_dUserDate )  end   if EXISTS(select  1  from  RM30101  where  RM30101.CUSTNMBR = @I_vCustomerNumber  and RM30101.RMDTYPAL = 0 )  begin  select  @cDocumentNumber =   stuff(max(RM30101.DOCNUMBR),17,4,rtrim(substring(convert(char(5),(convert(int,('1' +   substring(max(RM30101.DOCNUMBR),17,4))) + 1)),2,4)))  from  RM30101  where  RM30101.CUSTNMBR = @I_vCustomerNumber  and RM30101.RMDTYPAL = 0  end   else  begin  select  @cDocumentNumber = stuff(DOCNUMBR,20,1,'1')  from   RM20101  where  RM20101.CUSTNMBR = @I_vCustomerNumber  and RM20101.RMDTYPAL = 0  end   select @O_cBalanceForwardNumber = ISNULL(@cDocumentNumber,'')   insert into  RM30101(  CUSTNMBR,  RMDTYPAL,  DOCNUMBR,  DUEDATE,  DOCDATE,  GLPOSTDT,  TRXDSCRN,  CURNCYID,  ORTRXAMT,  CURTRXAM,  POSTDATE,  BALFWDNM,  Tax_Date )  select  RM20101.CUSTNMBR,  RM20101.RMDTYPAL,  @cDocumentNumber,  RM20101.DUEDATE,  RM20101.DOCDATE,  RM20101.GLPOSTDT,  RM20101.TRXDSCRN,  RM20101.CURNCYID,  RM20101.ORTRXAMT,  RM20101.CURTRXAM,  @I_dUserDate,  @cDocumentNumber,  RM20101.Tax_Date  from  RM20101  where  RM20101.CUSTNMBR = @I_vCustomerNumber  and RM20101.RMDTYPAL = 0   Insert into  RM00401(  DOCNUMBR,  RMDTYPAL,  DCSTATUS,  CUSTNMBR,  DOCDATE )  select  @cDocumentNumber,  0,  3,   CUSTNMBR,  DOCDATE  from  RM20101  where  RM20101.CUSTNMBR = @I_vCustomerNumber  and RM20101.RMDTYPAL = 0   update  RM20101  set  ORTRXAMT = ORTRXAMT + ISNULL((select sum(TRANSAMT) from #Documents),0.00),  CURTRXAM = CURTRXAM + ISNULL((select sum(TRANSAMT) from #Documents),0.00),  DUEDATE  = @I_dUserDate,  DOCDATE  = @I_dUserDate,  GLPOSTDT = @I_dUserDate,  CURNCYID = @I_cFunctionalCurrency,  Tax_Date = @I_dUserDate  where  RM20101.CUSTNMBR = @I_vCustomerNumber  and RM20101.RMDTYPAL = 0   delete  RM00401  where  DOCNUMBR = @I_vCustomerNumber + '^' + replicate('0',(19 - len(@I_vCustomerNumber)))  and DCSTATUS=2  and EXISTS (select   1   from  RM20101  where  DOCNUMBR = @I_vCustomerNumber + '^' + replicate('0',(19 - len(@I_vCustomerNumber)))  and CUSTNMBR = @I_vCustomerNumber  and RMDTYPAL = 0  and ORTRXAMT = 0 )  delete  RM20101  where  DOCNUMBR = @I_vCustomerNumber + '^' + replicate('0',(19 - len(@I_vCustomerNumber)))  and CUSTNMBR = @I_vCustomerNumber  and RMDTYPAL = 0  and ORTRXAMT = 0  end   return(@iStatus)   
GO
GRANT EXECUTE ON  [dbo].[rmBalanceForwardConsolidation] TO [DYNGRP]
GO
