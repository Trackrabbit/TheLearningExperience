SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 Create Proc [dbo].[UPR_PopulateTimecardHistoricalListTempForEmployee]  (@I_sListTempTableName char(30) = NULL, @I_sReportsToTableName char(30) = NULL, @I_nModule smallint = NULL, @EmployeeID varchar(15),  @O_SQL_Error_State int= NULL output) as  declare   @iStatus int,  @iError int  select  @O_SQL_Error_State = 0,  @iStatus = 0,   @iError = 0  if (  @I_sListTempTableName is NULL or  @I_nModule is NULL or @I_sReportsToTableName is NULL )  begin  select @O_SQL_Error_State = 26000  return end  if @I_nModule = 35  or @I_nModule = 0 BEGIN  DECLARE @SQLString varchar(6000), @IncludeInactive smallint, @IncludeInactiveString varchar(100)   SET @IncludeInactive = (SELECT INCINEMP FROM UPR40200 WHERE SETUPKEY = 1)  SET @IncludeInactiveString = ''  IF (@IncludeInactive = 0)  BEGIN  SET @IncludeInactiveString = ' AND E.INACTIVE = 0 '  END   SET @SQLString = '  WITH MyCTE AS  (  SELECT HH.EMPLOYID, HH.Pay_Schedule, HH.YEAR1, HH.PERIODID, HH.Workflow_Status,  SUM(HD.UNTSTOPY) AS UNTSTOPY,  H.Group_ID, H.LVLLABEL, H.LASTNAME, H.FRSTNAME, H.MIDLNAME, H.EMPLSUFF, H.Supervisor_Employee_ID, H.USERID,  H.SUPERVISORCODE_I, H.SUPERVISOR, H.PHONE1, H.PHONE2, LEFT(LTRIM(RTRIM(H.Supervisor_Last_Name)) + '', '' + LTRIM(RTRIM(H.Supervisor_First_Name)) + '' '' + LTRIM(RTRIM(H.Supervisor_Middle_Name)), 40) AS EMPLNAME,  SH.PAYPEROD,  S.PERNAME, S.STRTDATE, S.ENDDATE,  0 AS InfoValue, 0 AS MKTOPROC, '''' AS CMMTTEXT,   E.DEPRTMNT AS DEPRTMNT, E.JOBTITLE AS JOBTITLE, E.LOCATNID AS LOCATNID, E.DIVISIONCODE_I AS DIVISIONCODE_I  FROM UPR30500 HH  INNER JOIN UPR00100 E ON HH.EMPLOYID = E.EMPLOYID  LEFT OUTER JOIN UPR30501 HD ON HH.EMPLOYID = HD.EMPLOYID and HH.Pay_Schedule = HD.Pay_Schedule AND HH.YEAR1 = HD.YEAR1 AND HH.PERIODID = HD.PERIODID  LEFT OUTER JOIN UPR42100 AS SH ON HH.Pay_Schedule = SH.Pay_Schedule  LEFT OUTER JOIN UPR42101 S ON S.Pay_Schedule = HH.Pay_Schedule AND S.YEAR1 = HH.YEAR1 AND S.PERIODID = HH.PERIODID  LEFT OUTER JOIN ' + @I_sReportsToTableName + ' H ON HH.EMPLOYID = H.EMPLOYID  WHERE H.Group_ID IS NOT NULL  GROUP BY HH.EMPLOYID, HH.Pay_Schedule, HH.YEAR1, HH.PERIODID, HH.Workflow_Status,  H.Group_ID, H.LVLLABEL, H.LASTNAME, H.FRSTNAME, H.MIDLNAME, H.EMPLSUFF, H.Supervisor_Employee_ID, H.USERID,  H.SUPERVISORCODE_I, H.SUPERVISOR, H.PHONE1, H.PHONE2, H.Supervisor_Last_Name, H.Supervisor_First_Name, H.Supervisor_Middle_Name,  SH.PAYPEROD,  S.PERNAME, S.STRTDATE, S.ENDDATE,  E.DEPRTMNT, E.JOBTITLE, E.LOCATNID, E.DIVISIONCODE_I  )  INSERT INTO ' + @I_sListTempTableName + '   (EMPLOYID, Pay_Schedule, YEAR1, PERIODID, PERNAME, STRTDATE, ENDDATE, Group_ID, LVLLABEL, LASTNAME, FRSTNAME, MIDLNAME, EMPLSUFF, Supervisor_Employee_ID, USERID,   SUPERVISORCODE_I, SUPERVISOR, PHONE1, PHONE2, EMPLNAME,   UNTSTOPY, PAYPEROD, InfoValue, MKTOPROC, Workflow_Status, DEPRTMNT, JOBTITLE, LOCATNID, DIVISIONCODE_I, CMMTTEXT, Workflow_Due_Date, Workflow_Due_Time, Workflow_Name, Workflow_Approver, Workflow_Originator, Workflow_Type_Name, WorkflowInstanceID, WorkflowStepInstanceID, Workflow_Step_Type)  SELECT EMPLOYID, Pay_Schedule, YEAR1, PERIODID, PERNAME, STRTDATE, ENDDATE, Group_ID, LVLLABEL, LASTNAME, FRSTNAME, MIDLNAME, EMPLSUFF, Supervisor_Employee_ID, USERID,  SUPERVISORCODE_I, SUPERVISOR, PHONE1, PHONE2, EMPLNAME,   UNTSTOPY, PAYPEROD, InfoValue, MKTOPROC, Workflow_Status, DEPRTMNT, JOBTITLE, LOCATNID, DIVISIONCODE_I, CMMTTEXT, convert(char(10), getdate(), 111) , '''', REPLICATE(''X'', 51), REPLICATE(''X'', 238), REPLICATE(''X'', 238),'''','''','''',0  FROM MyCTE'  exec(@SQLString)   SET @SQLString = '  WITH MyCTE AS  (  SELECT HH.EMPLOYID, HH.Pay_Schedule, HH.YEAR1, HH.PERIODID, HH.Workflow_Status,  SUM(HD.UNTSTOPY) AS UNTSTOPY,  999 AS Group_ID, ''Delegate'' AS LVLLABEL, E.LASTNAME, E.FRSTNAME, E.MIDLNAME, E.EMPLSUFF, ISNULL(EESUP.EMPLOYID, '''') AS Supervisor_Employee_ID, E.USERID,  E.SUPERVISORCODE_I, ISNULL(SUP.SUPERVISOR, '''') AS SUPERVISOR, ISNULL(ADD1.PHONE1, ''00000000000000'') AS PHONE1, ISNULL(ADD2.PHONE1, ''00000000000000'') AS PHONE2,   LEFT(LTRIM(RTRIM(ISNULL(EESUP.LASTNAME, ''''))) + '', '' + LTRIM(RTRIM(ISNULL(EESUP.FRSTNAME, ''''))) + '' '' + LTRIM(RTRIM(ISNULL(EESUP.MIDLNAME, ''''))), 40) AS EMPLNAME,   SH.PAYPEROD,  S.PERNAME, S.STRTDATE, S.ENDDATE,  0 AS InfoValue, 0 AS MKTOPROC, '''' AS CMMTTEXT,   E.DEPRTMNT AS DEPRTMNT, E.JOBTITLE AS JOBTITLE, E.LOCATNID AS LOCATNID, E.DIVISIONCODE_I AS DIVISIONCODE_I  FROM UPR30500 HH  INNER JOIN UPR00100 E ON HH.EMPLOYID = E.EMPLOYID  LEFT OUTER JOIN UPR00102 AS ADD1 ON E.EMPLOYID = ADD1.EMPLOYID AND E.ADRSCODE = ADD1.ADRSCODE  LEFT OUTER JOIN UPR41700 SUP ON E.SUPERVISORCODE_I = SUP.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 EESUP ON SUP.EMPLOYID = EESUP.EMPLOYID  LEFT OUTER JOIN UPR00102 AS ADD2 ON EESUP.EMPLOYID = ADD2.EMPLOYID AND EESUP.ADRSCODE = ADD2.ADRSCODE  LEFT OUTER JOIN UPR30501 HD ON HH.EMPLOYID = HD.EMPLOYID and HH.Pay_Schedule = HD.Pay_Schedule AND HH.YEAR1 = HD.YEAR1 AND HH.PERIODID = HD.PERIODID  LEFT OUTER JOIN UPR42100 AS SH ON HH.Pay_Schedule = SH.Pay_Schedule  LEFT OUTER JOIN UPR42101 S ON S.Pay_Schedule = HH.Pay_Schedule AND S.YEAR1 = HH.YEAR1 AND S.PERIODID = HH.PERIODID  LEFT OUTER JOIN ' + @I_sReportsToTableName + ' H ON HH.EMPLOYID = H.EMPLOYID  WHERE H.Group_ID IS NULL  AND E.EMPLOYID IN (  SELECT E.EMPLOYID  FROM UPR00100 E  LEFT OUTER JOIN UPR00201 TOBDEPT ON TOBDEPT.DEPRTMNT = E.DEPRTMNT  LEFT OUTER JOIN UPR00202 TOBCLASS ON TOBCLASS.EMPLCLAS = E.EMPLCLAS  LEFT OUTER JOIN UPR00203 TOBEMP ON TOBEMP.Employee_ID_Assigned = E.EMPLOYID  LEFT OUTER JOIN UPR41700 SUP ON E.SUPERVISORCODE_I = SUP.SUPERVISORCODE_I  LEFT OUTER JOIN UPR00100 EESUP ON SUP.EMPLOYID = EESUP.EMPLOYID  LEFT OUTER JOIN UPR00200 TOBHDR ON TOBDEPT.Time_on_Behalf_Code = TOBHDR.Time_on_Behalf_Code OR TOBCLASS.Time_on_Behalf_Code = TOBHDR.Time_on_Behalf_Code   OR TOBEMP.Time_on_Behalf_Code = TOBEMP.Time_on_Behalf_Code OR TOBHDR.Admin_Code = 1  LEFT OUTER JOIN ' + @I_sReportsToTableName + ' LIST ON E.EMPLOYID = LIST.EMPLOYID  WHERE ((TOBDEPT.DEPRTMNT IS NOT NULL OR TOBCLASS.EMPLCLAS IS NOT NULL OR TOBEMP.EMPLOYID IS NOT NULL) OR TOBHDR.Admin_Code = 1) AND   (LIST.EMPLOYID IS NULL AND (TOBDEPT.EMPLOYID = ''' + @EmployeeID + ''' OR TOBCLASS.EMPLOYID = ''' + @EmployeeID + ''' OR TOBEMP.EMPLOYID = ''' + @EmployeeID + ''')))  GROUP BY HH.EMPLOYID, HH.Pay_Schedule, HH.YEAR1, HH.PERIODID, HH.Workflow_Status,  E.LASTNAME, E.FRSTNAME, E.MIDLNAME, E.EMPLSUFF, EESUP.EMPLOYID, E.USERID,  E.SUPERVISORCODE_I, SUP.SUPERVISOR, ADD1.PHONE1, ADD2.PHONE1, EESUP.LASTNAME, EESUP.FRSTNAME, EESUP.MIDLNAME,  SH.PAYPEROD,  S.PERNAME, S.STRTDATE, S.ENDDATE,  E.DEPRTMNT, E.JOBTITLE, E.LOCATNID, E.DIVISIONCODE_I  )  INSERT INTO ' + @I_sListTempTableName + '   (EMPLOYID, Pay_Schedule, YEAR1, PERIODID, PERNAME, STRTDATE, ENDDATE, Group_ID, LVLLABEL, LASTNAME, FRSTNAME, MIDLNAME, EMPLSUFF, Supervisor_Employee_ID, USERID,   SUPERVISORCODE_I, SUPERVISOR, PHONE1, PHONE2, EMPLNAME,   UNTSTOPY, PAYPEROD, InfoValue, MKTOPROC, Workflow_Status, DEPRTMNT, JOBTITLE, LOCATNID, DIVISIONCODE_I, CMMTTEXT, Workflow_Due_Date, Workflow_Due_Time, Workflow_Name, Workflow_Approver, Workflow_Originator, Workflow_Type_Name, WorkflowInstanceID, WorkflowStepInstanceID, Workflow_Step_Type)  SELECT EMPLOYID, Pay_Schedule, YEAR1, PERIODID, PERNAME, STRTDATE, ENDDATE, Group_ID, LVLLABEL, LASTNAME, FRSTNAME, MIDLNAME, EMPLSUFF, Supervisor_Employee_ID, USERID,  SUPERVISORCODE_I, SUPERVISOR, PHONE1, PHONE2, EMPLNAME,   UNTSTOPY, PAYPEROD, InfoValue, MKTOPROC, Workflow_Status, DEPRTMNT, JOBTITLE, LOCATNID, DIVISIONCODE_I, CMMTTEXT, convert(char(10), getdate(), 111) , '''', REPLICATE(''X'', 51), REPLICATE(''X'', 238), REPLICATE(''X'', 238),'''','''','''',0  FROM MyCTE'  exec(@SQLString) END   
GO
GRANT EXECUTE ON  [dbo].[UPR_PopulateTimecardHistoricalListTempForEmployee] TO [DYNGRP]
GO
