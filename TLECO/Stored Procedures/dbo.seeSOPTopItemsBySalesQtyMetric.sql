SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[seeSOPTopItemsBySalesQtyMetric]  @I_dUserDate datetime = NULL,  @I_iPeriodDays int   = NULL,  @I_iNumItems int   = NULL,  @CustomerNumber varchar(max),  @SalesPerson varchar(max),  @ItemNumber varchar(max)  as  declare @ValuesTable table (Value nvarchar(500))  if (@SalesPerson != '') begin  insert into @ValuesTable select * from dbo.seeSplitString(@SalesPerson, ',') end  if (@CustomerNumber != '') begin  insert into @ValuesTable select * from dbo.seeSplitString(@CustomerNumber, ',') end  if (@ItemNumber != '') begin  insert into @ValuesTable select * from dbo.seeSplitString(@ItemNumber, ',') end  select @I_dUserDate = dbo.GetDateStripTime(@I_dUserDate)  if @CustomerNumber = '' and @SalesPerson = '' and @ItemNumber = '' begin  select  TOP (select @I_iNumItems) sum(round((Line.QTYTOINV * Line.QTYBSUOM), Line.DECPLQTY - 1)) as QTYToInvInBase,  Line.ITEMNMBR as ItemNumber,  '' as Filter  from  dbo.SOP30200 as Header with (NOLOCK),  dbo.SOP30300 as Line with (NOLOCK)  where  (Header.DOCDATE >= @I_dUserDate - @I_iPeriodDays and Header.DOCDATE <= @I_dUserDate - 1) and  Header.SOPTYPE = 3 and Header.VOIDSTTS <> 1 and  (Header.SOPTYPE = Line.SOPTYPE and Header.SOPNUMBE = Line.SOPNUMBE) and   Line.QTYTOINV > 0   group by  ITEMNMBR  order by  QTYToInvInBase DESC,  ItemNumber end  if @CustomerNumber != ''  begin  select  sum(round((Line.QTYTOINV * Line.QTYBSUOM), Line.DECPLQTY - 1)) as QTYToInvInBase,  Line.ITEMNMBR as ItemNumber,  Header.CUSTNMBR as Filter  from  dbo.SOP30200 as Header with (NOLOCK) inner join dbo.SOP30300 as Line with (NOLOCK)  on (Header.DOCDATE >= @I_dUserDate - @I_iPeriodDays and Header.DOCDATE <= @I_dUserDate - 1) and  Header.SOPTYPE = 3 and Header.VOIDSTTS <> 1 and  (Header.SOPTYPE = Line.SOPTYPE and Header.SOPNUMBE = Line.SOPNUMBE)   inner join (select  TOP (select @I_iNumItems) sum(round((Line.QTYTOINV * Line.QTYBSUOM), Line.DECPLQTY - 1)) as QTYToInvInBaseTemp,  Line.ITEMNMBR as ItemNumberTemp  from  dbo.SOP30200 as Header with (NOLOCK) inner join dbo.SOP30300 as Line with (NOLOCK)  on (Header.DOCDATE >= @I_dUserDate - @I_iPeriodDays and Header.DOCDATE <= @I_dUserDate - 1) and  Header.SOPTYPE = 3 and Header.VOIDSTTS <> 1 and  (Header.SOPTYPE = Line.SOPTYPE and Header.SOPNUMBE = Line.SOPNUMBE)  group by  ITEMNMBR  order by  QTYToInvInBaseTemp DESC,  ItemNumberTemp) ItemsTemp on ItemsTemp.ItemNumberTemp = Line.ITEMNMBR  inner join @ValuesTable CustomerList  on CustomerList.Value = Header.CUSTNMBR  inner join RM00101 a  on a.CUSTNMBR = Header.CUSTNMBR  left outer join SY01200 b on  b.Master_ID = a.CUSTNMBR  and b.ADRSCODE = a.ADRSCODE  and b.Master_Type = 'CUS'  group by  ItemsTemp.QTYToInvInBaseTemp,  ITEMNMBR,  Header.CUSTNMBR  order by  ItemsTemp.QTYToInvInBaseTemp DESC,  ItemNumber,  Filter end  if @SalesPerson != '' begin   select  sum(round((Line.QTYTOINV * Line.QTYBSUOM), Line.DECPLQTY - 1)) as QTYToInvInBase,  Line.ITEMNMBR as ItemNumber,  Header.SLPRSNID as Filter  from  dbo.SOP30200 as Header with (NOLOCK) inner join dbo.SOP30300 as Line with (NOLOCK)  on (Header.DOCDATE >= @I_dUserDate - @I_iPeriodDays and Header.DOCDATE <= @I_dUserDate - 1) and  Header.SOPTYPE = 3 and Header.VOIDSTTS <> 1 and  (Header.SOPTYPE = Line.SOPTYPE and Header.SOPNUMBE = Line.SOPNUMBE) and   Line.QTYTOINV > 0   inner join (select  TOP (select @I_iNumItems) sum(round((Line.QTYTOINV * Line.QTYBSUOM), Line.DECPLQTY - 1)) as QTYToInvInBaseTemp,  Line.ITEMNMBR as ItemNumberTemp  from  dbo.SOP30200 as Header with (NOLOCK) inner join dbo.SOP30300 as Line with (NOLOCK)  on (Header.DOCDATE >= @I_dUserDate - @I_iPeriodDays and Header.DOCDATE <= @I_dUserDate - 1) and  Header.SOPTYPE = 3 and Header.VOIDSTTS <> 1 and  (Header.SOPTYPE = Line.SOPTYPE and Header.SOPNUMBE = Line.SOPNUMBE)  group by  ITEMNMBR  order by  QTYToInvInBaseTemp DESC,  ItemNumberTemp) ItemsTemp on ItemsTemp.ItemNumberTemp = Line.ITEMNMBR  inner join @ValuesTable SalesPersonList  on SalesPersonList.Value = Header.SLPRSNID  inner join RM00301 a  on a.SLPRSNID = Header.SLPRSNID   left outer join SY01200 b on  b.Master_ID = a.SLPRSNID  and b.Master_Type = 'SLP'  group by  ItemsTemp.QTYToInvInBaseTemp,  ITEMNMBR,  Header.SLPRSNID  order by  ItemsTemp.QTYToInvInBaseTemp DESC,  ItemNumber,  Filter end  if @ItemNumber != '' begin  select  TOP (select @I_iNumItems) sum(round((Line.QTYTOINV * Line.QTYBSUOM), Line.DECPLQTY - 1)) as QTYToInvInBase,  Line.ITEMNMBR as ItemNumber,  Line.ITEMNMBR as Filter  from  dbo.SOP30200 as Header with (NOLOCK),  dbo.SOP30300 as Line with (NOLOCK)  where  (Header.DOCDATE >= @I_dUserDate - @I_iPeriodDays and Header.DOCDATE <= @I_dUserDate - 1) and  Header.SOPTYPE = 3 and Header.VOIDSTTS <> 1 and  (Header.SOPTYPE = Line.SOPTYPE and Header.SOPNUMBE = Line.SOPNUMBE) and   Line.QTYTOINV > 0 and  Line.ITEMNMBR in (select * from @ValuesTable)  group by  ITEMNMBR  order by  QTYToInvInBase DESC,  ItemNumber end   
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopItemsBySalesQtyMetric] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopItemsBySalesQtyMetric] TO [rpt_executive]
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopItemsBySalesQtyMetric] TO [rpt_materials manager]
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopItemsBySalesQtyMetric] TO [rpt_operations manager]
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopItemsBySalesQtyMetric] TO [rpt_order processor]
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopItemsBySalesQtyMetric] TO [rpt_purchasing manager]
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopItemsBySalesQtyMetric] TO [rpt_shipping and receiving]
GO
GRANT EXECUTE ON  [dbo].[seeSOPTopItemsBySalesQtyMetric] TO [rpt_warehouse manager]
GO
