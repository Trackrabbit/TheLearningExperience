SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[SVC_CreateGLTransactions](  @BATCHNUM varchar(15)  = NULL,  @USRJRNL      integer         = 0,  @TRXDATE datetime = NULL,  @TRXAMT numeric(19, 5) = 0,  @TRXDESC      varchar(30),  @ACTINDEX     int             = 0,  @USERID       varchar(15) = NULL,  @COID  varchar(5) = NULL,  @JOURNAL integer output,  @STATUS integer output ) as  declare   @post_date datetime,  @batch_source varchar(15),  @today        datetime,  @next_journal integer,  @dta_index    numeric(19, 5),  @year         numeric(19, 5),  @curr_id      varchar(15),  @curr_index   integer,  @period       smallint,  @open_year    smallint,  @fy_first     datetime,  @fy_last      datetime,  @dex_row      integer,  @trx_seq      integer,  @act_type     smallint,  @fixvar       smallint,  @calc_bal     smallint,  @post_type    smallint,  @dec_places   smallint,  @cmdline      varchar(255)  select @post_date    = convert(varchar(12), @TRXDATE, 101) + ' 12:00AM',  @batch_source = 'GL_Normal',  @today        = convert(varchar(12), getdate(), 101) + ' 12:00AM',  @next_journal = @USRJRNL select @curr_id      = FUNLCURR,  @curr_index   = FUNCRIDX  from MC40000   if @BATCHNUM = NULL or   @TRXDATE  = NULL or  @TRXAMT   = 0    or  @ACTINDEX = 0    or  @USERID   = NULL or  @COID     = NULL BEGIN   select @STATUS = -1  return  END   if @COID <> DB_NAME() BEGIN   select @STATUS = -2  return  END  if not exists(select * from GL00100 where ACTINDX = @ACTINDEX) BEGIN   select @STATUS = -8  return  END if exists(select * from GL00100 where ACTINDX = @ACTINDEX and ACTIVE = 0) BEGIN   select @STATUS = -9  return  END select @act_type   = ACCTTYPE,   @fixvar     = FXDORVAR,  @calc_bal   = BALFRCLC,  @post_type  = PSTNGTYP,  @dec_places = DECPLACS  from GL00100 where ACTINDX = @ACTINDEX  if not exists(select * from SY40101 where FSTFSCDY <= @TRXDATE and LSTFSCDY >= @TRXDATE and HISTORYR = 0) BEGIN   select @STATUS = -5  return  END select @open_year = YEAR1 from SY40101 where FSTFSCDY <= @TRXDATE and LSTFSCDY >= @TRXDATE and HISTORYR = 0  select @period = PERIODID from SY40100 where SERIES = 2 and PERIODDT <= @TRXDATE and ODESCTN = 'General Entry' if @open_year = 0 or @open_year = NULL or @period = 0 or @period = NULL BEGIN   select @STATUS = -6  return  END  if @USRJRNL > 0   begin  if not exists(select * from GL10000 where BACHNUMB = @BATCHNUM and JRNENTRY = @USRJRNL)  BEGIN   select @STATUS = -11  return   END  end  if exists(select * from dbo.SY00500 where BACHNUMB = @BATCHNUM and SERIES = 2)  begin   if exists(select * from dbo.SY00500 where BACHNUMB = @BATCHNUM and SERIES = 2 and (MKDTOPST <> 0 or BCHSTTUS <> 0)) or   exists(select * from DYNAMICS.dbo.SY00800 where BACHNUMB = @BATCHNUM)  BEGIN   select @STATUS = -3  return   END  else  select @post_date = GLPOSTDT from dbo.SY00500 where BACHNUMB = @BATCHNUM and SERIES = 2  end else  begin   exec dbo.zDP_SY00500SI @TRXDATE,                     @batch_source,                    @BATCHNUM,                        2,                                0,                                0,                                0,                                0,                                0,                                1,                                '01/01/1900 12:00AM',             0,                               'RE/MAX Front End Interface' ,    0,                                0,                                0,                                @USERID,                          '',                               0.00,                             0,                                0,                                @today,                           '',                               '',                               0,                                @today,                           @today,                           0,                                '',                               0,                                0,                                0.00,                             0,                                0,                                '01/01/1900 00:00:00',            '',                               1,                                0,                                0,                                @dex_row output   if @dex_row <= 0   BEGIN   select @STATUS = -4  return   END  end  if @USRJRNL <= 0  begin  select @next_journal = NJRNLENT from GL40000 where UNIQKEY = '1'  update GL40000  set NJRNLENT = NJRNLENT + 1  where UNIQKEY = '1'  select @year = datepart(year, @TRXDATE)  if @year > 1999   select @year = (@year - 2000) / 100000  else  select @year = (@year - 1900) / 100000  select @dta_index = @next_journal * 100000 +  datepart(second, @TRXDATE) +  datepart(minute, @TRXDATE) * 60 +  datepart(hour, @TRXDATE) * 3600 +  ((datepart(day, @TRXDATE) + datepart(month, @TRXDATE) * 31) / 1000) +  @year   exec dbo.zDP_GL10000SI @BATCHNUM,                        'GL_Normal',                      @next_journal,                    0,                                'GJ',                             @TRXDESC,         @TRXDATE,                         '01/01/1900 12:00AM',              0,                                 0,                                1,                                @USERID,                          @today,                            '',                                0,                                0,                                 0,                                0,                                '',                               '',                               2,                                '01/01/1900 12:00AM',             '',                               0,                                '',                               0,                                @dta_index,                       @curr_id,                         @curr_index,                       '',                               '',                               0,                                '01/01/1900 12:00AM',             '01/01/1900 12:00AM',             0,                                0,                                0,                                 @period,                          @open_year,                       0,                                0,                                0,                                0,                                0,                                 0,                                 0,                                0,                                '',                             0,                                 0,                                 1,                                @dex_row output   if @dex_row <= 0  BEGIN   select @STATUS = -7  return  END end  select @trx_seq = 0 select @trx_seq = SQNCLINE from GL10001 where BACHNUMB = @BATCHNUM and JRNENTRY = @next_journal select @trx_seq = @trx_seq + 16384  exec dbo.zDP_GL10001SI @BATCHNUM,                       @next_journal,                    @trx_seq,                         @ACTINDEX,                        @TRXAMT,                          @TRXAMT,                           0,                                @TRXDESC,                         0,                                0,                                @curr_index,                      0,                                 @act_type,                        @fixvar,                           @calc_bal,                         @post_type,                       2,                                '',                               '',                               '',                               '',                               0,                                0,                                0,                                @COID,                             '',                               '',                               '01/01/1900 12:00AM',             '01/01/1900 12:00AM',             0,                                @dex_row output  if @dex_row <= 0  BEGIN   select @STATUS = -10  return  END  if @USRJRNL = 0  update SY00500  set NUMOFTRX = NUMOFTRX + 1  where BACHNUMB = @BATCHNUM and SERIES = 2 if @TRXAMT > 0   update SY00500  set BCHTOTAL = BCHTOTAL + @TRXAMT  where BACHNUMB = @BATCHNUM and SERIES = 2 else  update SY00500  set BCHTOTAL = BCHTOTAL + (@TRXAMT * -1)  where BACHNUMB = @BATCHNUM and SERIES = 2  select @JOURNAL = @next_journal select @cmdline = convert(varchar(8), @next_journal) print @cmdline select @STATUS = 0 return     
GO
GRANT EXECUTE ON  [dbo].[SVC_CreateGLTransactions] TO [DYNGRP]
GO
