SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[seePMPayablesAgingMetric]  @I_dAgingDate datetime = NULL,  @I_iPMDocSchedule int = NULL,  @I_iPMDocMiscChange int = NULL,  @VendorNumber varchar(max) as  declare   @numPeriods int,        @ageUnappliedCreditAmounts smallint    declare @Vendors table (VENDORID nvarchar(500)) insert into @Vendors select * from dbo.seeSplitString(@VendorNumber, ',')  select  @ageUnappliedCreditAmounts = AGEUNAPPLDCR from  dbo.PM40100 with (NOLOCK)  select  @numPeriods = INDEX1 from  dbo.PM40101 with (NOLOCK) where  ENDGPDYS = 999  create table #PayablesSummInquiryTemp (RCRDTYPE smallint NOT NULL,  DOCTYPE smallint NOT NULL,  CURTRXAM numeric(19,5) NOT NULL,  DOCAMNT numeric(19,5) NOT NULL,  RECCOUNT numeric(19,5) NOT NULL,  PERIODID smallint NOT NULL,  VENDORID char(15) NOT NULL,  DEX_ROW_ID int identity NOT NULL)  create table #PayablesAgingTemp (PeriodDescription char(31) not null,  AgingAmount numeric(19, 5) not null,  VENDORID char(15) not null) if (@VendorNumber = '') begin   exec dbo.seepmPayablesSummaryInquiryByVendorID '#PayablesSummInquiryTemp', @I_dAgingDate, ''   insert into #PayablesAgingTemp  (PeriodDescription,  AgingAmount,  VENDORID)  select  DSCRIPTN as PeriodDescription,  0 as AgingAmount,  '' as VENDORID  from  dbo.PM40101 with (NOLOCK)  where  INDEX1 <= @numPeriods  order by  INDEX1   if @ageUnappliedCreditAmounts = 0  begin  insert into #PayablesAgingTemp  (PeriodDescription,  AgingAmount,  VENDORID)  select  PM40101.DSCRIPTN as PeriodDescription,  -#PayablesSummInquiryTemp.CURTRXAM as AgingAmount,  '' as VENDORID  from  dbo.PM40101 with (NOLOCK),  #PayablesSummInquiryTemp with (NOLOCK)  where  PM40101.INDEX1 = 1 and  #PayablesSummInquiryTemp.RCRDTYPE = 2 and  #PayablesSummInquiryTemp.DOCTYPE < @I_iPMDocSchedule and  #PayablesSummInquiryTemp.DOCTYPE > @I_iPMDocMiscChange  order by  PM40101.INDEX1  end  else  begin  insert into #PayablesAgingTemp  (PeriodDescription,  AgingAmount,  VENDORID)  select  PM40101.DSCRIPTN as PeriodDescription,  -#PayablesSummInquiryTemp.CURTRXAM as AgingAmount,  '' as VENDORID  from  dbo.PM40101 with (NOLOCK),  #PayablesSummInquiryTemp with (NOLOCK)  where  PM40101.INDEX1 = #PayablesSummInquiryTemp.PERIODID and  #PayablesSummInquiryTemp.RCRDTYPE = 2 and  #PayablesSummInquiryTemp.DOCTYPE < @I_iPMDocSchedule and  #PayablesSummInquiryTemp.DOCTYPE > @I_iPMDocMiscChange  order by  PM40101.INDEX1  end   insert into #PayablesAgingTemp  (PeriodDescription,  AgingAmount,  VENDORID)  select  PM40101.DSCRIPTN as PeriodDescription,  #PayablesSummInquiryTemp.CURTRXAM as AgingAmount,  '' as VENDORID  from  dbo.PM40101 with (NOLOCK),  #PayablesSummInquiryTemp with (NOLOCK)  where  PM40101.INDEX1 = #PayablesSummInquiryTemp.PERIODID and  #PayablesSummInquiryTemp.RCRDTYPE = 2 and  #PayablesSummInquiryTemp.DOCTYPE < @I_iPMDocSchedule and  #PayablesSummInquiryTemp.DOCTYPE <= @I_iPMDocMiscChange  order by  PM40101.INDEX1  end else begin   exec dbo.seepmPayablesSummaryInquiryByVendorID '#PayablesSummInquiryTemp', @I_dAgingDate, @VendorNumber   insert into #PayablesAgingTemp  (PeriodDescription,  AgingAmount,  VENDORID)  select  DSCRIPTN as PeriodDescription,  0 as AgingAmount,  #PayablesSummInquiryTemp.VENDORID as VENDORID  from  dbo.PM40101 with (NOLOCK),  #PayablesSummInquiryTemp  where  INDEX1 <= @numPeriods  order by  INDEX1   if @ageUnappliedCreditAmounts = 0  begin  insert into #PayablesAgingTemp  (PeriodDescription,  AgingAmount,  VENDORID)  select  PM40101.DSCRIPTN as PeriodDescription,  -#PayablesSummInquiryTemp.CURTRXAM as AgingAmount,  #PayablesSummInquiryTemp.VENDORID as VENDORID  from  dbo.PM40101 with (NOLOCK),  #PayablesSummInquiryTemp with (NOLOCK)  where  PM40101.INDEX1 = 1 and  #PayablesSummInquiryTemp.RCRDTYPE = 2 and  #PayablesSummInquiryTemp.DOCTYPE < @I_iPMDocSchedule and  #PayablesSummInquiryTemp.DOCTYPE > @I_iPMDocMiscChange  order by  PM40101.INDEX1  end  else  begin  insert into #PayablesAgingTemp  (PeriodDescription,  AgingAmount,  VENDORID)  select  PM40101.DSCRIPTN as PeriodDescription,  -#PayablesSummInquiryTemp.CURTRXAM as AgingAmount,  #PayablesSummInquiryTemp.VENDORID as VENDORID  from  dbo.PM40101 with (NOLOCK),  #PayablesSummInquiryTemp with (NOLOCK)  where  PM40101.INDEX1 = #PayablesSummInquiryTemp.PERIODID and  #PayablesSummInquiryTemp.RCRDTYPE = 2 and  #PayablesSummInquiryTemp.DOCTYPE < @I_iPMDocSchedule and  #PayablesSummInquiryTemp.DOCTYPE > @I_iPMDocMiscChange  order by  PM40101.INDEX1  end   insert into #PayablesAgingTemp  (PeriodDescription,  AgingAmount,  VENDORID)  select  PM40101.DSCRIPTN as PeriodDescription,  #PayablesSummInquiryTemp.CURTRXAM as AgingAmount,  #PayablesSummInquiryTemp.VENDORID as VENDORID  from  dbo.PM40101 with (NOLOCK),  #PayablesSummInquiryTemp with (NOLOCK)  where  PM40101.INDEX1 = #PayablesSummInquiryTemp.PERIODID and  #PayablesSummInquiryTemp.RCRDTYPE = 2 and  #PayablesSummInquiryTemp.DOCTYPE < @I_iPMDocSchedule and  #PayablesSummInquiryTemp.DOCTYPE <= @I_iPMDocMiscChange  order by  PM40101.INDEX1  end  select * from #PayablesAgingTemp with (NOLOCK)  drop table #PayablesAgingTemp drop table #PayablesSummInquiryTemp    
GO
GRANT EXECUTE ON  [dbo].[seePMPayablesAgingMetric] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[seePMPayablesAgingMetric] TO [rpt_accounting manager]
GO
GRANT EXECUTE ON  [dbo].[seePMPayablesAgingMetric] TO [rpt_accounts payable coordinator]
GO
GRANT EXECUTE ON  [dbo].[seePMPayablesAgingMetric] TO [rpt_bookkeeper]
GO
GRANT EXECUTE ON  [dbo].[seePMPayablesAgingMetric] TO [rpt_certified accountant]
GO
GRANT EXECUTE ON  [dbo].[seePMPayablesAgingMetric] TO [rpt_executive]
GO
