SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE  procedure [dbo].[aagUpdateRepTableForEditList]  @BACHNUMB char(15),  @SERIES int,  @USERID char(15),  @Hdr nvarchar(30),  @Dist nvarchar(30),  @Assign nvarchar(30),  @isval tinyint output,  @I_UserID varchar(20),  @I_Right int  as begin  declare @DOCTYPE int,  @DOCNUMBR char(21),  @aaSubLedgerHdrID int,   @PSTDATE datetime,  @Cnt int   select  @DOCTYPE  = 0,  @aaSubLedgerHdrID = 0,  @isval   = 0,  @Cnt   = 0   if @SERIES = 11   begin  delete AAG2000E   from AAG2000E a   join AAG20000 b  on a.aaSubLedgerHdrID = b.aaSubLedgerHdrID  join SOP10100 c  on b.DOCNUMBR = c.SOPNUMBE  and b.DOCTYPE = c.SOPTYPE  where c.BACHNUMB = @BACHNUMB  and b.SERIES = 11  and b.Master_ID = ''   declare  CSOP cursor fast_forward for  Select SOPTYPE, SOPNUMBE, DOCDATE  from SOP10100  where BACHNUMB = @BACHNUMB AND SOPTYPE IN (3,4)   open CSOP  end  fetch next from CSOP into @DOCTYPE,@DOCNUMBR, @PSTDATE  while @@fetch_status = 0  begin    Select @aaSubLedgerHdrID = aaSubLedgerHdrID  from AAG20000  where SERIES = @SERIES and  DOCTYPE = @DOCTYPE and  DOCNUMBR = @DOCNUMBR   if @aaSubLedgerHdrID > 0  Insert into AAG50000  (USERID, TRXBTCHSRC, aaSubLedgerHdrID,  SERIES, DOCTYPE, DOCNUMBR,PSTGDATE,aaOrder)   values(@USERID,0,@aaSubLedgerHdrID,@SERIES,@DOCTYPE,@DOCNUMBR,@PSTDATE,0)  exec('insert into '+ @Hdr + '(USERID, TRXBTCHSRC, aaSubLedgerHdrID,  SERIES, DOCTYPE, DOCNUMBR,PSTGDATE,aaOrder)  select USERID, TRXBTCHSRC, aaSubLedgerHdrID,  SERIES, DOCTYPE, DOCNUMBR,PSTGDATE,0 from AAG50000')  delete AAG50000  exec aagInsertDistandAssignToReportTempTables  @aaSubLedgerHdrID,  @Dist,  @Assign,  0    exec aagValidateCodeSubLedHdr 'AAG20002', 'AAG20003',  'AAG2000E', @aaSubLedgerHdrID , @isval output,@I_UserID,@I_Right   fetch next from CSOP into @DOCTYPE,@DOCNUMBR, @PSTDATE   end  close CSOP  deallocate CSOP  Select @Cnt = count(*) from  AAG2000E    if @Cnt > 0  set @isval = 0  else  set @isval = 1 end    
GO
GRANT EXECUTE ON  [dbo].[aagUpdateRepTableForEditList] TO [DYNGRP]
GO
