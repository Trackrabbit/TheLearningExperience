SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[wfGetOutOfOfficeDelegate]  @assigned_task_user char(85),  @Workflow_User char(85),  @Workflow_Type_Name char(51),  @WF_AllowOrigApprover tinyint,  @Workflow_Manually_Delega tinyint,  @Workflow_Originator char(238),  @WorkflowStepInstanceID char(37),  @new_delegate char(85) OUTPUT,  @Workflow_Error int OUTPUT  AS  BEGIN set NOCOUNT ON   declare @UsersListGuid char(37)  declare @DomainUserName char(255), @DelegateTo char(255),  @WF_Auto_Delegate_Tasks tinyint, @Workflow_Select_Delegate smallint   declare @already_assigned tinyint   select @assigned_task_user=UPPER(@assigned_task_user)  select @Workflow_Error=1   select @already_assigned=0   if @Workflow_Manually_Delega=1   begin  select @DomainUserName=upper(DomainUserName), @WF_Auto_Delegate_Tasks=WF_Auto_Delegate_Tasks,   @Workflow_Select_Delegate=Workflow_Select_Delegate, @UsersListGuid=UPPER(UsersListGuid)  from WF40500 where rtrim(upper(DomainUserName))=rtrim(@assigned_task_user)  if @DomainUserName is not null   begin  if @WF_Auto_Delegate_Tasks=1   begin   if @Workflow_Select_Delegate=0    begin  select @DelegateTo=DomainUserName from WF40510   where UPPER(UsersListGuid)=@UsersListGuid and getdate() between STRTDATE and ENDDATE  end  else   begin  select top 1 @DelegateTo=DomainUserName from WF40510   where UPPER(UsersListGuid)=@UsersListGuid   and Workflow_Type_Name=@Workflow_Type_Name  and getdate() between STRTDATE and ENDDATE  end   select @DelegateTo=UPPER(ISNULL(@DelegateTo,''))  if @DelegateTo<>''  and (@WF_AllowOrigApprover=1 or (@WF_AllowOrigApprover=0 and @DelegateTo<>UPPER(@Workflow_Originator)))   begin  if (select COUNT(Workflow_User) from WFI10005 where Workflow_User=@Workflow_User   and UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID   and UPPER(WorkflowTaskAssignedTo)=UPPER(@DelegateTo))>0   begin  select @already_assigned=1  select @new_delegate=''  delete from WFI10005  where Workflow_User=@Workflow_User   and UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID   and UPPER(WorkflowTaskAssignedTo)=@assigned_task_user  end  else  begin   select @new_delegate=@DelegateTo  update WFI10005 set WorkflowTaskAssignedTo=RTRIM(@DelegateTo)   where Workflow_User=@Workflow_User   and UPPER(WorkflowStepInstanceID)=@WorkflowStepInstanceID   and UPPER(WorkflowTaskAssignedTo)=@assigned_task_user  end  end  else  begin  select @new_delegate=''  end  end  else  begin  select @new_delegate=''  end   end  else  begin  select @new_delegate=''  end  end  else  begin  select @new_delegate=''  end END   
GO
GRANT EXECUTE ON  [dbo].[wfGetOutOfOfficeDelegate] TO [DYNGRP]
GO
