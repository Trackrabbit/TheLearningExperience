SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[taGetTrxSourceNumber]  @I_vSeries tinyint, @I_vPrefix char(5), @I_vInc_Dec tinyint, @O_vTrxSourceNumber char(13) = NULL output, @O_iErrorState int = NULL output  with encryption as   set transaction isolation level read uncommitted set nocount on  declare   @TrxSourceNumber char(13),  @Loop int,  @DocExists tinyint,   @iStatus int,  @iError int  select @O_vTrxSourceNumber = '',  @TrxSourceNumber = '',  @O_iErrorState  = 0,  @Loop = 0,  @DocExists = 1,  @iStatus = 0,  @iError = 0  if (@I_vSeries is NULL or @I_vPrefix is NULL) begin  select @O_iErrorState = 46    return (@O_iErrorState) end  select @O_vTrxSourceNumber = rtrim(@I_vPrefix)+replicate('0',8-len(ltrim(str(NTRXSNUM))))+ltrim(str(NTRXSNUM)) from SY01000 WITH (TABLOCKX HOLDLOCK) where SERIES = @I_vSeries and TRXSRCPX = @I_vPrefix if (@@rowcount <> 1) begin  select @O_iErrorState = 47     return (@O_iErrorState) end  select @TrxSourceNumber = @O_vTrxSourceNumber  while (@Loop < 1000) begin  select @Loop = @Loop + 1  select @DocExists = 0   exec @iStatus = ivNumber_Inc_Dec  @I_vInc_Dec,  @TrxSourceNumber output,  @O_iErrorState output  select @iError = @@error  if (@iError <> 0 or @iStatus <> 0 or @O_iErrorState <> 0 or @TrxSourceNumber = '' or @TrxSourceNumber is null)  begin  select @O_iErrorState = 6540    select @DocExists = 0  break  end   if (exists (select 1 from SOP30100 (nolock) where TRXSORCE = @TrxSourceNumber))  begin  select @DocExists = 1  end  else  begin  if (exists (select 1 from SOP30100 (nolock) where TRXSORCE = @O_vTrxSourceNumber))  begin  select @O_vTrxSourceNumber = @TrxSourceNumber  end  else  begin  select @DocExists = 0  break  end  end end  if (@DocExists = 1) begin  select @O_iErrorState = 123   end  if (@O_iErrorState = 0) begin  update SY01000 set NTRXSNUM = convert(int, substring(@TrxSourceNumber,6,10))  where SERIES = @I_vSeries and TRXSRCPX = @I_vPrefix  if (@@error <> 0)  begin  select @O_iErrorState = 6539    end end else begin  select @O_vTrxSourceNumber = '' end  return (@O_iErrorState)   
GO
GRANT EXECUTE ON  [dbo].[taGetTrxSourceNumber] TO [DYNGRP]
GO
