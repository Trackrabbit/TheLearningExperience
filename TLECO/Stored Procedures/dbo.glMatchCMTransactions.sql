SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[glMatchCMTransactions] @iGLTempTable VARCHAR(50), @iCMTempTable VARCHAR(50), @iCMMatchTable VARCHAR(50), @iGLMatchTable VARCHAR(50), @iCMPMatchTable VARCHAR(50),  @iGLPMatchTable VARCHAR(50) AS BEGIN   DECLARE  @lSQLError int,@Statement VARCHAR(2000),@Statement1 VARCHAR(2000),@i int,@Statement2 VARCHAR(2000),@Statement3 VARCHAR(2000),@Statement4 VARCHAR(2000)   select @Statement = ''   EXEC(  'INSERT INTO ' +  @iCMMatchTable +  ' (POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,   TrxNumDrillBack)  SELECT DISTINCT POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, '''', VOIDED,   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppCMTransactionZoom(0,CMRECNUM)   FROM  ' +  @iCMTempTable + ' JOIN ' + @iGLTempTable + ' ON POSTEDDT = TRXDATE AND TRXSORCE = ORTRXSRC AND DOCNUMBR = ORCTRNUM AND  (DepAmt-PAYMENT_AMOUNT) = (DEBITAMT-CRDTAMNT) ')   EXEC(  'INSERT INTO ' +  @iGLMatchTable +  ' (TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT,  AccountNumberDrillback,   JournalEntryDrillback)  SELECT DISTINCT TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppAccountIndex(1,ACTINDX),   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppJournalInquiry(1,JRNENTRY,0.0,YEAR1,TRXDATE)   FROM  ' + @iGLTempTable + ' JOIN ' +  @iCMTempTable + '  ON POSTEDDT = TRXDATE  AND  TRXSORCE = ORTRXSRC  AND  ORCTRNUM = DOCNUMBR AND  (DepAmt-PAYMENT_AMOUNT) = (DEBITAMT-CRDTAMNT) ')    EXEC( 'DELETE ' +   @iCMTempTable +   ' FROM ' +   @iCMTempTable +   ' CMTemp INNER JOIN ' + @iCMMatchTable + ' CMMatch ON CMMatch.TRXSORCE = CMTemp.TRXSORCE AND CMMatch.POSTEDDT = CMTemp.POSTEDDT  AND CMMatch.CMTrxNum = CMTemp.CMTrxNum AND CMMatch.DOCNUMBR = CMTemp.DOCNUMBR AND (CMMatch.DepAmt-CMMatch.PAYMENT_AMOUNT) = (CMTemp.DepAmt-CMTemp.PAYMENT_AMOUNT)')    EXEC( 'DELETE ' + @iGLTempTable + ' FROM ' + @iGLTempTable + ' GLTemp INNER JOIN ' + @iGLMatchTable + ' GLMatch ON GLMatch.ORTRXSRC = GLTemp.ORTRXSRC AND GLMatch.TRXDATE = GLTemp.TRXDATE  AND GLMatch.ORCTRNUM = GLTemp.ORCTRNUM  AND (GLTemp.DEBITAMT-GLTemp.CRDTAMNT)=(GLMatch.DEBITAMT-GLMatch.CRDTAMNT)')    EXEC(  'SELECT DISTINCT POSTEDDT, CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, '''' as STRVAL, VOIDED,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)  + dbo.dgppCMTransactionZoom(0,CMRECNUM)  AS TrxNumDrillBack INTO  ##CMDetailTemp   FROM ' +  @iCMTempTable + ' JOIN ' + @iGLTempTable + '  ON  POSTEDDT = TRXDATE  AND  TRXSORCE = ORTRXSRC  AND  (ORCTRNUM = '''' OR DOCNUMBR = ''''  OR ORCTRNUM = DOCNUMBR)  GROUP BY  POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,CMRECNUM')    EXEC(  'SELECT DISTINCT TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT  INTO  ##GLDetailTemp  FROM ' +  @iGLTempTable + '   JOIN ' + @iCMTempTable + '  ON  TRXDATE = POSTEDDT  AND  ORTRXSRC = TRXSORCE   AND  (DOCNUMBR = '''' OR ORCTRNUM = ''''  OR ORCTRNUM = DOCNUMBR)   GROUP BY  TRXDATE, JRNENTRY, ORTRXSRC, ORCTRNUM, ACTINDX, DEBITAMT, CRDTAMNT ')    SELECT DISTINCT * INTO #Temp FROM ##CMDetailTemp  TRUNCATE TABLE ##CMDetailTemp  INSERT INTO ##CMDetailTemp SELECT * FROM #Temp   DROP TABLE #Temp   SELECT  POSTEDDT, TRXSORCE, (SUM(DepAmt) - SUM(PAYMENT_AMOUNT)) AS ACCTAMNT INTO  #CMSumTemp FROM  ##CMDetailTemp GROUP BY  POSTEDDT, TRXSORCE   SELECT  TRXDATE, ORTRXSRC, (SUM(DEBITAMT) - SUM(CRDTAMNT)) AS GLAMNT INTO  #GLSumTemp FROM  ##GLDetailTemp GROUP BY  TRXDATE, ORTRXSRC    SELECT  POSTEDDT, TRXSORCE INTO  #TRXRemoveTemp FROM  #CMSumTemp JOIN #GLSumTemp  ON  TRXDATE = POSTEDDT AND TRXSORCE = ORTRXSRC  AND  ACCTAMNT <> GLAMNT    DELETE  #CMSumTemp FROM  #CMSumTemp JOIN #GLSumTemp  ON  TRXDATE = POSTEDDT AND TRXSORCE = ORTRXSRC  AND  ACCTAMNT <> GLAMNT    DELETE  #GLSumTemp FROM  #GLSumTemp JOIN #TRXRemoveTemp  ON  TRXDATE = POSTEDDT AND ORTRXSRC = TRXSORCE   EXEC(  'INSERT INTO ' +  @iCMMatchTable +  ' (POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,   TrxNumDrillBack)  SELECT DISTINCT ##CMDetailTemp.POSTEDDT,  ##CMDetailTemp.CMTrxNum,  ##CMDetailTemp.TRXSORCE,  DOCNUMBR,  DOCTYPE, ##CMDetailTemp.PAYMENT_AMOUNT,   ##CMDetailTemp.DepAmt, '''' , VOIDED, ##CMDetailTemp.TrxNumDrillBack    FROM  ##CMDetailTemp JOIN #CMSumTemp   ON  ##CMDetailTemp.POSTEDDT = #CMSumTemp.POSTEDDT AND ##CMDetailTemp.TRXSORCE  = #CMSumTemp.TRXSORCE ')    EXEC(  'INSERT INTO ' +  @iGLMatchTable +  ' (TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT,  AccountNumberDrillback,   JournalEntryDrillback)  SELECT DISTINCT ##GLDetailTemp.TRXDATE,  ##GLDetailTemp.JRNENTRY,  ##GLDetailTemp.ORTRXSRC,  ##GLDetailTemp.ORCTRNUM,  ##GLDetailTemp.ACTINDX,  ##GLDetailTemp.DEBITAMT,  ##GLDetailTemp.CRDTAMNT,   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppAccountIndex(1,##GLDetailTemp.ACTINDX),   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppJournalInquiry(1,##GLDetailTemp.JRNENTRY,0.0,' + @iGLTempTable + '.YEAR1,##GLDetailTemp.TRXDATE)   FROM  ##GLDetailTemp JOIN #GLSumTemp  ON  ##GLDetailTemp.ORTRXSRC = #GLSumTemp.ORTRXSRC AND ##GLDetailTemp.TRXDATE = #GLSumTemp.TRXDATE   JOIN ' + @iGLTempTable + ' ON ##GLDetailTemp.ORTRXSRC = ' + @iGLTempTable + '.ORTRXSRC AND ##GLDetailTemp.JRNENTRY = ' + @iGLTempTable + '.JRNENTRY  AND ##GLDetailTemp.TRXDATE = ' + @iGLTempTable + '.TRXDATE')    EXEC( 'DELETE ' +   @iCMTempTable +   ' FROM ' +   @iCMTempTable +   ' CMTemp INNER JOIN ' + @iCMMatchTable + ' CMMatch ON CMMatch.TRXSORCE = CMTemp.TRXSORCE AND CMMatch.POSTEDDT = CMTemp.POSTEDDT  AND CMMatch.CMTrxNum = CMTemp.CMTrxNum AND CMMatch.DOCNUMBR = CMTemp.DOCNUMBR AND (CMMatch.DepAmt-CMMatch.PAYMENT_AMOUNT) = (CMTemp.DepAmt-CMTemp.PAYMENT_AMOUNT)')    EXEC( 'DELETE ' + @iGLTempTable + ' FROM ' + @iGLTempTable + ' GLTemp INNER JOIN ' + @iGLMatchTable + ' GLMatch ON GLMatch.ORTRXSRC = GLTemp.ORTRXSRC AND GLMatch.TRXDATE = GLTemp.TRXDATE  AND GLMatch.ORCTRNUM = GLTemp.ORCTRNUM  AND (GLTemp.DEBITAMT-GLTemp.CRDTAMNT)=(GLMatch.DEBITAMT-GLMatch.CRDTAMNT)')    SET @i = 1  WHILE @i <= 2  BEGIN  if @i = 1  BEGIN  SET @Statement = ' (  SELECT DISTINCT TOP 1 APTVCHNM FROM (SELECT DISTINCT APTVCHNM FROM PM10200 INNER JOIN PM00400 ON CNTRLNUM = APTVCHNM AND PM10200.VENDORID = PM00400.VENDORID AND DCSTATUS = 2 AND  PM10200.VCHRNMBR = ' +  @iCMTempTable + '.DOCNUMBR AND PM10200.DOCTYPE = 6  UNION  SELECT DISTINCT APTVCHNM FROM PM30300 INNER JOIN PM00400 ON CNTRLNUM = APTVCHNM AND PM30300.VENDORID = PM00400.VENDORID AND DCSTATUS = 3 AND  PM30300.VCHRNMBR = ' +  @iCMTempTable + '.DOCNUMBR AND PM30300.DOCTYPE = 6 ) A) '  SET @Statement1 = ' TRXSORCE LIKE ''PMTRX%'' '  SET @Statement2 = '(SELECT CASE COUNT(1) WHEN 1 THEN (SELECT TOP 1 VCHRNMBR FROM (  SELECT VCHRNMBR FROM PM10200 WHERE APTVCHNM = ' + @iGLTempTable + '.ORCTRNUM   UNION ALL   SELECT VCHRNMBR FROM PM30300 WHERE APTVCHNM = ' + @iGLTempTable + '.ORCTRNUM)   VCHRNMBR)   ELSE '''' END AS DOCNUMBR FROM   (SELECT APTVCHNM FROM PM10200 WHERE APTVCHNM = ' + @iGLTempTable + '.ORCTRNUM   UNION ALL  SELECT APTVCHNM FROM PM30300 WHERE APTVCHNM = ' + @iGLTempTable + '.ORCTRNUM) A   GROUP BY A.APTVCHNM)'  SET @Statement4 = '(SELECT TOP 1 VCHRNMBR FROM (  SELECT VCHRNMBR FROM PM10200 WHERE APTVCHNM = ' + @iGLTempTable + '.ORCTRNUM  AND APPLDAMT = CRDTAMNT  UNION ALL   SELECT VCHRNMBR FROM PM30300 WHERE APTVCHNM = ' + @iGLTempTable + '.ORCTRNUM  AND APPLDAMT = CRDTAMNT)   VCHRNMBR)'  SET @Statement3 = '(SELECT APTVCHNM FROM PM10200 WHERE APTVCHNM = GLTemp.ORCTRNUM UNION ALL   SELECT APTVCHNM FROM PM30300 WHERE APTVCHNM = GLTemp.ORCTRNUM)'  END  ELSE  BEGIN  SET @Statement = ' (SELECT DISTINCT TOP 1 APTODCNM FROM (  SELECT DISTINCT APTODCNM FROM RM20201 INNER JOIN RM00401 ON DOCNUMBR = APFRDCNM AND RM20201.CUSTNMBR = RM00401.CUSTNMBR AND   RM20201.APFRDCNM = ' +  @iCMTempTable + '.DOCNUMBR   UNION  SELECT DISTINCT APTODCNM FROM RM30201 INNER JOIN RM00401 ON DOCNUMBR = APFRDCNM AND RM30201.CUSTNMBR = RM00401.CUSTNMBR AND  RM30201.APFRDCNM = ' +  @iCMTempTable + '.DOCNUMBR  UNION  SELECT DISTINCT APTODCNM FROM RM30202 INNER JOIN RM00401 ON DOCNUMBR = APFRDCNM AND RM30202.CUSTNMBR = RM00401.CUSTNMBR AND  RM30202.APFRDCNM = ' +  @iCMTempTable + '.DOCNUMBR ) A)'  SET @Statement1 = ' TRXSORCE LIKE ''RMSLS%'' '  SET @Statement2 = '(SELECT CASE COUNT(1) WHEN 1 THEN (SELECT TOP 1 APFRDCNM FROM (  SELECT APFRDCNM FROM RM20201 WHERE APTODCNM = ' + @iGLTempTable + '.ORCTRNUM   UNION ALL   SELECT APFRDCNM FROM RM30201 WHERE APTODCNM = ' + @iGLTempTable + '.ORCTRNUM   UNION ALL   SELECT APFRDCNM FROM RM30202 WHERE APTODCNM = ' + @iGLTempTable + '.ORCTRNUM)   APFRDCNM)   ELSE '''' END AS DOCNUMBR FROM   (SELECT APTODCNM FROM RM20201 WHERE APTODCNM = ' + @iGLTempTable + '.ORCTRNUM   UNION ALL  SELECT APTODCNM FROM RM30201 WHERE APTODCNM = ' + @iGLTempTable + '.ORCTRNUM   UNION ALL  SELECT APTODCNM FROM RM30202 WHERE APTODCNM = ' + @iGLTempTable + '.ORCTRNUM) A   GROUP BY A.APTODCNM)'  SET @Statement4 = '(SELECT TOP 1 APFRDCNM FROM (  SELECT APFRDCNM FROM RM20201 WHERE APTODCNM = ' + @iGLTempTable + '.ORCTRNUM   UNION ALL   SELECT APFRDCNM FROM RM30201 WHERE APTODCNM = ' + @iGLTempTable + '.ORCTRNUM  UNION ALL   SELECT APFRDCNM FROM RM30202 WHERE APTODCNM = ' + @iGLTempTable + '.ORCTRNUM)   APFRDCNM) '  SET @Statement3 = '(SELECT APTODCNM FROM RM20201 WHERE APTODCNM = GLTemp.ORCTRNUM UNION ALL   SELECT APTODCNM FROM RM30201 WHERE APTODCNM = GLTemp.ORCTRNUM UNION ALL   SELECT APTODCNM FROM RM30202 WHERE APTODCNM = GLTemp.ORCTRNUM)'  END  EXEC(  'INSERT INTO ' +  @iCMMatchTable +  ' (POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,   TrxNumDrillBack)  SELECT  POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, '''', VOIDED,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppCMTransactionZoom(0,CMRECNUM)   AS TrxNumDrillBack   FROM  ' +  @iCMTempTable + ' JOIN ' + @iGLTempTable + ' ON POSTEDDT = TRXDATE AND TRXSORCE = ORTRXSRC AND '+@Statement1+' AND  (DepAmt-PAYMENT_AMOUNT) = (DEBITAMT-CRDTAMNT)  AND ORCTRNUM =' + @Statement)   EXEC(  'INSERT INTO ' +  @iGLMatchTable +  ' (TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT,  AccountNumberDrillback,   JournalEntryDrillback)  SELECT DISTINCT TRXDATE,  JRNENTRY,  ORTRXSRC,  '+@Statement4+',  ACTINDX,  DEBITAMT,  CRDTAMNT,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppAccountIndex(1,ACTINDX),   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppJournalInquiry(1,JRNENTRY,0.0,YEAR1,TRXDATE)   FROM  ' + @iGLTempTable + ' JOIN ' +  @iCMTempTable + '  ON POSTEDDT = TRXDATE  AND  TRXSORCE = ORTRXSRC AND '+@Statement1+' AND  (DepAmt-PAYMENT_AMOUNT) = (DEBITAMT-CRDTAMNT)  AND  ORCTRNUM = ' + @Statement)    EXEC( 'DELETE ' +   @iCMTempTable +   ' FROM ' +   @iCMTempTable +   ' CMTemp INNER JOIN ' + @iCMMatchTable + ' CMMatch ON CMMatch.TRXSORCE = CMTemp.TRXSORCE AND CMMatch.POSTEDDT = CMTemp.POSTEDDT  AND CMMatch.CMTrxNum = CMTemp.CMTrxNum AND CMMatch.DOCNUMBR = CMTemp.DOCNUMBR AND (CMMatch.DepAmt-CMMatch.PAYMENT_AMOUNT) = (CMTemp.DepAmt-CMTemp.PAYMENT_AMOUNT)')    EXEC( 'DELETE ' + @iGLTempTable + ' FROM ' + @iGLTempTable + ' GLTemp INNER JOIN ' + @iGLMatchTable + ' GLMatch ON GLMatch.ORTRXSRC = GLTemp.ORTRXSRC AND GLMatch.TRXDATE = GLTemp.TRXDATE  AND GLTemp.ORCTRNUM IN '+@Statement3+' AND (GLTemp.DEBITAMT-GLTemp.CRDTAMNT)=(GLMatch.DEBITAMT-GLMatch.CRDTAMNT)')    EXEC(  'SELECT  POSTEDDT, CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, '''' as STRVAL, VOIDED,   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppCMTransactionZoom(0,CMRECNUM)  AS TrxNumDrillBack,' + @Statement + ' AS APTVCHNUM  INTO  ##CMDetailTemp5   FROM ' +  @iCMTempTable + ' JOIN ' + @iGLTempTable + '  ON  POSTEDDT = TRXDATE  AND  TRXSORCE = ORTRXSRC AND '+@Statement1+' AND ORCTRNUM = ' + @Statement + '  GROUP BY  POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED, CMRECNUM')    EXEC(  'SELECT  TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT  INTO  ##GLDetailTemp5  FROM ' +  @iGLTempTable + '   JOIN ' + @iCMTempTable + '  ON  TRXDATE = POSTEDDT  AND  ORTRXSRC = TRXSORCE AND '+@Statement1+' AND ORCTRNUM = ' + @Statement + '   GROUP BY  TRXDATE, JRNENTRY, ORTRXSRC, ORCTRNUM, ACTINDX, DEBITAMT, CRDTAMNT ')    SELECT DISTINCT * INTO #Temp5 FROM ##CMDetailTemp5  TRUNCATE TABLE ##CMDetailTemp5  INSERT INTO ##CMDetailTemp5 SELECT * FROM #Temp5  DROP TABLE #Temp5   SELECT POSTEDDT, TRXSORCE, APTVCHNUM, (SUM(DepAmt) - SUM(PAYMENT_AMOUNT)) AS ACCTAMNT INTO  #CMSumTemp5 FROM  ##CMDetailTemp5 GROUP BY  POSTEDDT, TRXSORCE, APTVCHNUM  SELECT TRXDATE, ORTRXSRC, ORCTRNUM, (SUM(DEBITAMT) - SUM(CRDTAMNT)) AS GLAMNT INTO  #GLSumTemp5 FROM  ##GLDetailTemp5 GROUP BY  TRXDATE, ORTRXSRC, ORCTRNUM   SELECT POSTEDDT, TRXSORCE, APTVCHNUM INTO  #TRXRemoveTemp5 FROM  #CMSumTemp5 JOIN #GLSumTemp5  ON  TRXDATE = POSTEDDT AND TRXSORCE = ORTRXSRC AND ORCTRNUM =APTVCHNUM AND  ACCTAMNT <> GLAMNT    DELETE #CMSumTemp5 FROM  #CMSumTemp5 JOIN #GLSumTemp5  ON  TRXDATE = POSTEDDT AND TRXSORCE = ORTRXSRC AND ORCTRNUM =APTVCHNUM AND  ACCTAMNT <> GLAMNT    DELETE #GLSumTemp5 FROM  #GLSumTemp5 JOIN #TRXRemoveTemp5  ON  TRXDATE = POSTEDDT AND ORTRXSRC = TRXSORCE AND ORCTRNUM =APTVCHNUM  EXEC( 'INSERT INTO ' +  @iCMMatchTable +  ' (POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,   TrxNumDrillBack)  SELECT DISTINCT CM.POSTEDDT,  CM.CMTrxNum,  CM.TRXSORCE,  DOCNUMBR,  DOCTYPE, CM.PAYMENT_AMOUNT, CM.DepAmt, '''' ,   VOIDED, CM.TrxNumDrillBack FROM  ##CMDetailTemp5 CM JOIN #CMSumTemp5  ON  CM.POSTEDDT = #CMSumTemp5.POSTEDDT AND CM.TRXSORCE  = #CMSumTemp5.TRXSORCE AND CM.APTVCHNUM = #CMSumTemp5.APTVCHNUM')    EXEC( 'INSERT INTO ' +  @iGLMatchTable +  ' (TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT,  AccountNumberDrillback,   JournalEntryDrillback)  SELECT DISTINCT GL.TRXDATE,  GL.JRNENTRY,  GL.ORTRXSRC,  '+@Statement2+',  GL.ACTINDX,  GL.DEBITAMT,  GL.CRDTAMNT,   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0) + dbo.dgppAccountIndex(1,GL.ACTINDX),   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0) + dbo.dgppJournalInquiry(1,GL.JRNENTRY,0.0,' + @iGLTempTable + '.YEAR1,GL.TRXDATE)   FROM  ##GLDetailTemp5 GL JOIN #GLSumTemp5  ON  GL.ORTRXSRC = #GLSumTemp5.ORTRXSRC AND GL.TRXDATE = #GLSumTemp5.TRXDATE AND GL.ORCTRNUM = #GLSumTemp5.ORCTRNUM  JOIN ' + @iGLTempTable + ' ON GL.ORTRXSRC = ' + @iGLTempTable + '.ORTRXSRC AND GL.JRNENTRY = ' + @iGLTempTable + '.JRNENTRY  AND GL.TRXDATE = ' + @iGLTempTable + '.TRXDATE')    EXEC( 'DELETE ' +   @iCMTempTable +   ' FROM ' +   @iCMTempTable +   ' CMTemp INNER JOIN ' + @iCMMatchTable + ' CMMatch ON CMMatch.TRXSORCE = CMTemp.TRXSORCE AND CMMatch.POSTEDDT = CMTemp.POSTEDDT  AND CMMatch.CMTrxNum = CMTemp.CMTrxNum AND CMMatch.DOCNUMBR = CMTemp.DOCNUMBR AND (CMMatch.DepAmt-CMMatch.PAYMENT_AMOUNT) = (CMTemp.DepAmt-CMTemp.PAYMENT_AMOUNT)')    EXEC( 'DELETE ' + @iGLTempTable + ' FROM ' + @iGLTempTable + ' GLTemp INNER JOIN ' + @iGLMatchTable + ' GLMatch ON GLMatch.ORTRXSRC = GLTemp.ORTRXSRC AND GLMatch.TRXDATE = GLTemp.TRXDATE  AND GLTemp.ORCTRNUM IN '+@Statement3+' AND (GLTemp.DEBITAMT-GLTemp.CRDTAMNT)=(GLMatch.DEBITAMT-GLMatch.CRDTAMNT)')   SET @i = @i + 1  DROP TABLE #CMSumTemp5,#GLSumTemp5,#TRXRemoveTemp5  DROP TABLE ##CMDetailTemp5,  ##GLDetailTemp5  END   EXEC(  'SELECT  POSTEDDT, CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, '''' AS STRVAL, VOIDED,   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppCMTransactionZoom(0,CMRECNUM)   AS TrxNumDrillBack  INTO  ##CMDeposits   FROM ' +  @iCMTempTable + ' WHERE DOCTYPE IN (1) AND CMTrxNum IN (SELECT DISTINCT CMTrxNum FROM ' + @iCMMatchTable + ' WHERE DOCTYPE in (2,0))   GROUP BY  POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,CMRECNUM ')    EXEC(  'SELECT A.POSTEDDT, A.CMTrxNum, A.TRXSORCE, A.DOCNUMBR, A.DOCTYPE, A.PAYMENT_AMOUNT, A.DepAmt, '''' AS STRVAL, A.VOIDED,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppCMTransactionZoom(0,B.CMRECNUM)  AS TrxNumDrillBack   INTO  ##CMDetailTemp1   FROM ' +  @iCMMatchTable + ' A INNER JOIN ' + @iCMTempTable + ' B ON B.CMTrxNum = A.CMTrxNum  WHERE A.DOCTYPE IN (2,0) AND  B.DOCTYPE=1    ')    EXEC(  'SELECT  TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT, CRDTAMNT, CMTrxNum  INTO ##GLDetailTemp1 FROM ' + @iGLMatchTable + '   JOIN ' + @iCMMatchTable + ' CMMatch ON  TRXDATE = CMMatch.POSTEDDT  AND  ORTRXSRC = CMMatch.TRXSORCE AND CMMatch.DOCNUMBR IN (SELECT DISTINCT DOCNUMBR FROM ##CMDetailTemp1 CMDtl WHERE   CMDtl.POSTEDDT = CMMatch.POSTEDDT  AND  CMDtl.TRXSORCE = CMMatch.TRXSORCE AND CMDtl.DOCNUMBR = CMMatch.DOCNUMBR)  GROUP BY  TRXDATE, JRNENTRY, ORTRXSRC, ORCTRNUM, ACTINDX, DEBITAMT, CRDTAMNT, CMTrxNum  ')    SELECT   CMTrxNum, SUM(DepAmt) AS DEPAMNT INTO  #CMDep FROM  ##CMDeposits GROUP BY   CMTrxNum    SELECT   CMTrxNum, SUM(DepAmt) AS ACCTAMNT INTO  #CMSumTemp2 FROM  ##CMDetailTemp1 GROUP BY   CMTrxNum   SELECT  CMTrxNum, (SUM(DEBITAMT) - SUM(CRDTAMNT)) AS GLAMNT INTO  #GLSumTemp2 FROM  ##GLDetailTemp1 GROUP BY   CMTrxNum    SELECT   #CMSumTemp2.CMTrxNum INTO  #TRXRemoveTemp2 FROM  #CMSumTemp2 JOIN #CMDep ON   #CMSumTemp2.CMTrxNum = #CMDep.CMTrxNum AND #CMSumTemp2.ACCTAMNT <> #CMDep.DEPAMNT    SELECT  #CMSumTemp2.CMTrxNum, ACCTAMNT INTO #CMSumTemp3 FROM  #CMSumTemp2 JOIN #GLSumTemp2  ON   #CMSumTemp2.CMTrxNum = #GLSumTemp2.CMTrxNum    JOIN #CMDep ON #CMSumTemp2.CMTrxNum = #CMDep.CMTrxNum AND #CMSumTemp2.ACCTAMNT <> #CMDep.DEPAMNT    SELECT  #GLSumTemp2.CMTrxNum, GLAMNT INTO #GLSumTemp3 FROM  #GLSumTemp2 JOIN #TRXRemoveTemp2  ON   #GLSumTemp2.CMTrxNum = #TRXRemoveTemp2.CMTrxNum   EXEC(  'INSERT INTO ' +  @iCMPMatchTable +  ' (POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,   TrxNumDrillBack) SELECT  A.POSTEDDT, A.CMTrxNum,  A.TRXSORCE,  DOCNUMBR,  DOCTYPE, A.PAYMENT_AMOUNT,   A.DepAmt, '''' AS STRVAL, VOIDED, A.TrxNumDrillBack FROM  ##CMDetailTemp1 A JOIN #CMSumTemp3 ON A.CMTrxNum  = #CMSumTemp3.CMTrxNum ')    EXEC(  'INSERT INTO ' +  @iGLPMatchTable +  ' (TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT, ACCTAMNT,  AccountNumberDrillback,   JournalEntryDrillback) SELECT DISTINCT A.TRXDATE,  A.JRNENTRY,  A.ORTRXSRC,  A.ORCTRNUM,  A.ACTINDX,  A.DEBITAMT,  A.CRDTAMNT,   A.DEBITAMT- A.CRDTAMNT AS ACCTAMNT,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)  + dbo.dgppAccountIndex(1,A.ACTINDX) AS AccountNumberDrillback,   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0) + dbo.dgppJournalInquiry(1,A.JRNENTRY,0.0,(SELECT TOP 1 YEAR1 FROM SY40101 WHERE A.TRXDATE BETWEEN FSTFSCDY AND LSTFSCDY),A.TRXDATE)  AS JournalEntryDrillback  FROM  ##GLDetailTemp1 A JOIN #GLSumTemp3  ON A.CMTrxNum = #GLSumTemp3.CMTrxNum   ')    EXEC( 'DELETE ' +   @iCMMatchTable +   ' FROM ' +   @iCMMatchTable +   ' CMTemp INNER JOIN ' + @iCMPMatchTable + ' CMMatch ON CMMatch.TRXSORCE = CMTemp.TRXSORCE AND CMMatch.POSTEDDT = CMTemp.POSTEDDT  AND CMMatch.CMTrxNum = CMTemp.CMTrxNum AND CMMatch.DOCNUMBR = CMTemp.DOCNUMBR AND (CMMatch.DepAmt-CMMatch.PAYMENT_AMOUNT) = (CMTemp.DepAmt-CMTemp.PAYMENT_AMOUNT)')    EXEC( 'DELETE ' + @iGLMatchTable + ' FROM ' + @iGLMatchTable + ' GLTemp INNER JOIN ' + @iGLPMatchTable + ' GLMatch ON GLMatch.ORTRXSRC = GLTemp.ORTRXSRC AND GLMatch.TRXDATE = GLTemp.TRXDATE  AND GLMatch.ORCTRNUM = GLTemp.ORCTRNUM  AND (GLTemp.DEBITAMT-GLTemp.CRDTAMNT)=(GLMatch.DEBITAMT-GLMatch.CRDTAMNT)')    EXEC(  'INSERT INTO ' +  @iCMMatchTable +  ' (POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,   TrxNumDrillBack)   SELECT  A.POSTEDDT,  A.CMTrxNum, A.TRXSORCE, A.DOCNUMBR, A.DOCTYPE, A.PAYMENT_AMOUNT, A.DepAmt, '''', A.VOIDED,   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppCMTransactionZoom(0,A.CMRECNUM)   AS TrxNumDrillBack   FROM ' +  @iCMTempTable + ' AS A WHERE  A.DOCTYPE = 1 AND   A.CMTrxNum IN (SELECT DISTINCT CMTrxNum FROM ' +  @iCMMatchTable +  ' WHERE  ' +  @iCMMatchTable +  '.DOCTYPE IN (2,0))  GROUP BY  A.POSTEDDT,  A.CMTrxNum, A.TRXSORCE, A.DOCNUMBR, A.DOCTYPE, A.PAYMENT_AMOUNT, A.DepAmt, A.STRVAL, A.VOIDED,A.CMRECNUM ')    EXEC( 'DELETE ' +   @iCMTempTable +   ' FROM ' +   @iCMTempTable +   ' CMTemp INNER JOIN ' + @iCMMatchTable + ' CMMatch ON CMMatch.TRXSORCE = CMTemp.TRXSORCE AND CMMatch.POSTEDDT = CMTemp.POSTEDDT  AND CMMatch.CMTrxNum = CMTemp.CMTrxNum AND CMMatch.DOCNUMBR = CMTemp.DOCNUMBR AND (CMMatch.DepAmt-CMMatch.PAYMENT_AMOUNT) = (CMTemp.DepAmt-CMTemp.PAYMENT_AMOUNT)')    DROP TABLE  ##CMDetailTemp,  ##GLDetailTemp, ##CMDetailTemp1,  ##GLDetailTemp1, ##CMDeposits  RETURN (@lSQLError)   END    
GO
GRANT EXECUTE ON  [dbo].[glMatchCMTransactions] TO [DYNGRP]
GO
