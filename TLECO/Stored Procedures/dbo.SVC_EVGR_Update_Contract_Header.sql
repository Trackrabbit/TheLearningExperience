SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE procedure [dbo].[SVC_EVGR_Update_Contract_Header]  @CONSTS smallint,  @CONTNBR char(10) AS  declare @NewBillAmount numeric(19,5) declare @OrigNewBillAmount numeric(19,5) declare @TOTAL numeric(19,2), @TOTAL_Cost numeric(19,2) declare @ORIGTOTAL numeric(19,2), @ORIGTOTAL_Cost numeric(19,2) declare @DiscountDollar numeric(19,2) declare @OrigDiscountDollar numeric(19,2) declare @NEXTBILLDATE datetime declare @LastBillAmount numeric(19,5) declare @OrigLastBillAmount numeric(19,5) declare @TermDate datetime declare @BillingStatus smallint declare @EndDate datetime DECLARE @MinDate datetime, @MaxDate datetime  exec smGetMinDate @MinDate output  select @MaxDate = DATEADD(yy, 1000, @MinDate)  select @NEXTBILLDATE = min(INVODATE),   @NewBillAmount = SUM(IsNull(SVC00603.DOCAMNT,0) - IsNull(SVC00603.SVC_Invoice_Credit_Amoun,0) - isnull(DSCDLRAM,0)),  @OrigNewBillAmount = SUM(IsNull(SVC00603.ORDOCAMT,0) - IsNull(SVC00603.OrigInvCreditAmt,0) - isnull(ORDDLRAT,0))  from SVC00603 WITH (NOLOCK) where SVC00603.CONSTS = @CONSTS and  SVC00603.CONTNBR = @CONTNBR and SVC00603.POSTED = 0  select @TOTAL = SUM(IsNull(SVC00603.DOCAMNT,0) - IsNull(SVC00603.SVC_Invoice_Credit_Amoun,0)),  @ORIGTOTAL = SUM(IsNull(SVC00603.ORDOCAMT,0) - IsNull(SVC00603.OrigInvCreditAmt,0)),  @DiscountDollar = SUM(isnull(DSCDLRAM,0)) , @OrigDiscountDollar = SUM(isnull(ORDDLRAT,0))  from SVC00603 WITH (NOLOCK) where CONSTS = @CONSTS and CONTNBR = @CONTNBR  select @OrigLastBillAmount = SUM(IsNull(ORIGLASTAmountBilled,0)), @LastBillAmount = SUM(IsNull(Last_Amount_Billed,0)),  @TOTAL_Cost = sum(isnull(UNITCOST,0))  , @ORIGTOTAL_Cost = sum(isnull(ORUNTCST,0)),  @NEXTBILLDATE = min(NXTBLDTE), @BillingStatus = min(BILSTAT)  from SVC00601 WITH (NOLOCK) where CONSTS = @CONSTS and CONTNBR = @CONTNBR select @BillingStatus = isnull(@BillingStatus,0)  if @BillingStatus = 0 and exists(select * from SVC00601 WITH (NOLOCK) where CONSTS = @CONSTS and CONTNBR = @CONTNBR and BILSTAT > 0)   select @BillingStatus = 1 if @BillingStatus = 2 and exists(select * from SVC00601 WITH (NOLOCK) where CONSTS = @CONSTS and CONTNBR = @CONTNBR and Contract_Line_Status = 'P')   select @BillingStatus = 4 else if @BillingStatus = 2 and exists(select * from SVC00601 WITH (NOLOCK) where CONSTS = @CONSTS and CONTNBR = @CONTNBR and Contract_Line_Status = 'T')   select @BillingStatus = 5 else if @BillingStatus = 0 and exists(select * from SVC00603 WITH (NOLOCK) where CONSTS = @CONSTS and CONTNBR = @CONTNBR and POSTED = 1)   select @BillingStatus = 1    UPDATE SVC00600 with (ROWLOCK) set  SVC00600.NXTBLDTE = IsNull(@NEXTBILLDATE,@MaxDate),   SVC00600.Last_Amount_Billed = IsNull(@LastBillAmount,0),  SVC00600.ORIGLASTAmountBilled = IsNull(@OrigLastBillAmount,0),   SVC00600.Amount_To_Invoice = IsNull(@NewBillAmount,0),  SVC00600.Orig_Amount_To_Invoice =  IsNull(@OrigNewBillAmount,0),  TOTAL = IsNull(@TOTAL,0), ORIGTOTAL = IsNull(@ORIGTOTAL,0),  DSCDLRAM = isnull(@DiscountDollar,0), ORDDLRAT = isnull(@OrigDiscountDollar,0),  Originating_Total_Unit = isnull(@ORIGTOTAL_Cost,0), Total_Unit = isnull(@TOTAL_Cost,0),  BILSTAT = @BillingStatus  WHERE CONSTS = @CONSTS AND CONTNBR = @CONTNBR  if @BillingStatus = 2 or @BillingStatus = 4  Begin  select @EndDate = max(ENDDATE) from SVC00601 WITH (NOLOCK) where CONSTS = @CONSTS and CONTNBR = @CONTNBR  update SVC00600 with (ROWLOCK)  set ENDDATE = @EndDate  WHERE CONSTS = @CONSTS AND CONTNBR = @CONTNBR  End  return    
GO
GRANT EXECUTE ON  [dbo].[SVC_EVGR_Update_Contract_Header] TO [DYNGRP]
GO
