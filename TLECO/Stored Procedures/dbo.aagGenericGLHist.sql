SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
 CREATE  PROCEDURE [dbo].[aagGenericGLHist] @USERID CHAR(15), @TBName varchar(25), @Preview SMALLINT, @O_SQL_Error_State int = NULL  output AS  BEGIN  Declare @cDBName char(5),  @l_nStatus int,  @l_cPROFIT_AND_LOSS varchar(255),  @l_cBalSheet varchar(255),  @l_ctPROFIT_AND_LOSS varchar(255),  @l_ctBalSheet varchar(255),  @O_nSQL_Error_State int,  @l_nError int   set nocount on   select @cDBName = DB_NAME()  exec    @l_nStatus = DYNAMICS.dbo.smGetMsgString 12125, @cDBName, @l_cPROFIT_AND_LOSS output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)   exec    @l_nStatus = DYNAMICS.dbo.smGetMsgString 12030, @cDBName, @l_cBalSheet output, @O_nSQL_Error_State output  select @l_nError = @@error  if @l_nStatus = 0 and @l_nError <> 0  select @l_nStatus = @l_nError   if ( (@l_nStatus <> 0) or (@O_nSQL_Error_State <> 0) )  return (@l_nStatus)   set @l_ctBalSheet = replace(@l_cBalSheet,'''','''''')  set @l_ctPROFIT_AND_LOSS = replace(@l_cPROFIT_AND_LOSS,'''','''''')   IF @Preview = 1  BEGIN  EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Distribution Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40001.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40001.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40001.aaGLHdrID)) ),-9999)  FROM AAG40001 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40000 WHERE AAG40000.aaGLHdrID=AAG40001.aaGLHdrID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40002.aaGLHdrID)) ),-9999)  FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40000 WHERE AAG40000.aaGLHdrID=AAG40002.aaGLHdrID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40003.aaGLHdrID)) ),-9999)  FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40000 WHERE AAG40000.aaGLHdrID=AAG40003.aaGLHdrID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40002.aaGLHdrID)) ),-9999)  FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40002.aaGLHdrID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40003.aaGLHdrID)) ),-9999)  FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40003.aaGLHdrID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40003.aaGLHdrID)) ),-9999)  FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40002 WHERE AAG40002.aaGLHdrID=AAG40003.aaGLHdrID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40002.aaGLHdrID)) ),-9999)  FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT AAG40000.aaGLHdrID FROM AAG40000 INNER JOIN AAG40001 ON AAG40000.aaGLHdrID=AAG40001.aaGLHdrID WHERE AAG40000.aaGLHdrID=AAG40002.aaGLHdrID AND AAG40001.aaGLDistID=AAG40002.aaGLDistID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40002.aaGLHdrID)) ),-9999)  FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40002.aaGLHdrID AND AAG40001.aaGLDistID=AAG40002.aaGLDistID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40003.aaGLHdrID)) ),-9999)  FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40003.aaGLHdrID AND AAG40001.aaGLDistID=AAG40003.aaGLDistID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40003.aaGLHdrID)) ),-9999)  FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40002 WHERE AAG40002.aaGLHdrID=AAG40003.aaGLHdrID AND AAG40002.aaGLDistID=AAG40003.aaGLDistID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40003.aaGLHdrID)) ),-9999)  FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40002 WHERE AAG40002.aaGLHdrID=AAG40003.aaGLHdrID AND AAG40002.aaGLDistID=AAG40003.aaGLDistID)')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Distribution Table'',''AA GL History Header ID=''+LTRIM(STR(A.aaGLHdrID)),1,1,LTRIM(STR(A.JRNENTRY))  FROM AAG40001 A1 INNER JOIN AAG40000 A ON A1.aaGLHdrID = A.aaGLHdrID AND A1.AA_CL_Status = 0 and ltrim(rtrim(SOURCDOC)) = ''''   LEFT OUTER JOIN (SELECT DISTINCT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR, TRXDATE, CURNCYID, CURRNIDX FROM GL30000 where SOURCDOC <> '''+ @l_ctBalSheet +   ''' and SOURCDOC <> '''+ @l_ctPROFIT_AND_LOSS + ''' ) B ON   A.JRNENTRY=B.JRNENTRY AND   A.RCTRXSEQ=B.RCTRXSEQ AND  A.aaGLTRXSource=B.TRXSORCE AND  A.GLPOSTDT = B.TRXDATE AND  A1.CURNCYID = B.CURNCYID AND  A1.CURRNIDX = B.CURRNIDX  WHERE A1.aaGLDistID >   (SELECT count(JRNENTRY) FROM   (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL30000) C   WHERE C.JRNENTRY = A.JRNENTRY AND C.TRXSORCE =A.aaGLTRXSource AND A.RCTRXSEQ = C.RCTRXSEQ AND A.YEAR1 = C.HSTYEAR AND A.GLPOSTDT = C.TRXDATE AND A1.CURNCYID = C.CURNCYID AND A1.CURRNIDX = C.CURRNIDX  AND C.SOURCDOC not IN(''' + @l_ctBalSheet +''', ''' + @l_ctPROFIT_AND_LOSS + '''))')   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID +  ''''+',''AA GL History Header Table'',''AA GL History Header ID=''+LTRIM(STR(A.aaGLHdrID)),1,1,LTRIM(STR(A.JRNENTRY))  FROM AAG40000 A LEFT OUTER JOIN GL30000 B ON A.JRNENTRY=B.JRNENTRY AND   A.RCTRXSEQ=B.RCTRXSEQ AND  A.aaGLTRXSource=B.TRXSORCE AND  A.YEAR1=B.HSTYEAR   LEFT OUTER JOIN AAG40001 A1 ON A.aaGLHdrID = A1.aaGLHdrID   AND A1.AA_CL_Status = 0 AND  A.GLPOSTDT = B.TRXDATE AND  A1.CURNCYID = B.CURNCYID AND  A1.CURRNIDX = B.CURRNIDX  WHERE B.JRNENTRY IS NULL')    END  ELSE  BEGIN  EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Distribution Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40001.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40001.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40001.aaGLHdrID)) ),-9999)  FROM AAG40001 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40000 WHERE AAG40000.aaGLHdrID=AAG40001.aaGLHdrID)')   DELETE AAG40001 FROM AAG40001 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40000 WHERE AAG40000.aaGLHdrID=AAG40001.aaGLHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40002.aaGLHdrID)) ),-9999)  FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40000 WHERE AAG40000.aaGLHdrID=AAG40002.aaGLHdrID)')   DELETE AAG40002 FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40000 WHERE AAG40000.aaGLHdrID=AAG40002.aaGLHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40003.aaGLHdrID)) ),-9999)  FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40000 WHERE AAG40000.aaGLHdrID=AAG40003.aaGLHdrID)')   DELETE AAG40003 FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40000 WHERE AAG40000.aaGLHdrID=AAG40003.aaGLHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40002.aaGLHdrID)) ),-9999)  FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40002.aaGLHdrID)')   DELETE AAG40002 FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40002.aaGLHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40003.aaGLHdrID)) ),-9999)  FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40003.aaGLHdrID=AAG40003.aaGLHdrID)')   DELETE AAG40003 FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40003.aaGLHdrID=AAG40003.aaGLHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40003.aaGLHdrID)) ),-9999)  FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40002 WHERE AAG40002.aaGLHdrID=AAG40003.aaGLHdrID)')   DELETE AAG40003 FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40002 WHERE AAG40002.aaGLHdrID=AAG40003.aaGLHdrID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40002.aaGLHdrID)) ),-9999)  FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40002.aaGLHdrID AND AAG40001.aaGLDistID=AAG40002.aaGLDistID)')   DELETE AAG40002 FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40002.aaGLHdrID AND AAG40001.aaGLDistID=AAG40002.aaGLDistID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Assignment Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40002.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40002.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40002.aaGLHdrID)) ),-9999)  FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT AAG40000.aaGLHdrID FROM AAG40000 INNER JOIN AAG40001 ON AAG40000.aaGLHdrID=AAG40001.aaGLHdrID AND AAG40000.aaGLHdrID=AAG40002.aaGLHdrID AND AAG40001.aaGLDistID=AAG40002.aaGLDistID)')   DELETE AAG40002 FROM AAG40002 WHERE NOT EXISTS (SELECT DISTINCT AAG40000.aaGLHdrID FROM AAG40000 INNER JOIN AAG40001 ON AAG40000.aaGLHdrID=AAG40001.aaGLHdrID AND AAG40000.aaGLHdrID=AAG40002.aaGLHdrID AND AAG40001.aaGLDistID=AAG40002.aaGLDistID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40003.aaGLHdrID)) ),-9999)  FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40003.aaGLHdrID AND AAG40001.aaGLDistID=AAG40003.aaGLDistID)')   DELETE AAG40003 FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40001 WHERE AAG40001.aaGLHdrID=AAG40003.aaGLHdrID AND AAG40001.aaGLDistID=AAG40003.aaGLDistID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40003.aaGLHdrID)) ),-9999)  FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40002 WHERE AAG40002.aaGLHdrID=AAG40003.aaGLHdrID AND AAG40002.aaGLDistID=AAG40003.aaGLDistID)')   DELETE AAG40003 FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40002 WHERE AAG40002.aaGLHdrID=AAG40003.aaGLHdrID AND AAG40002.aaGLDistID=AAG40003.aaGLDistID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Code Table'',''AA GL Open Header ID=''+LTRIM(STR(AAG40003.aaGLHdrID))+SPACE(3)+''AA GL Open Distribution ID=''+LTRIM(STR(AAG40003.aaGLDistID)),1,1 ,ISNULL((SELECT TOP 1 JRNENTRY FROM AAG40000 WHERE aaGLHdrID =LTRIM(STR(AAG40003.aaGLHdrID)) ),-9999)  FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40002 WHERE AAG40002.aaGLHdrID=AAG40003.aaGLHdrID AND AAG40002.aaGLDistID=AAG40003.aaGLDistID)')   DELETE AAG40003 FROM AAG40003 WHERE NOT EXISTS (SELECT DISTINCT aaGLHdrID FROM AAG40002 WHERE AAG40002.aaGLHdrID=AAG40003.aaGLHdrID AND AAG40002.aaGLDistID=AAG40003.aaGLDistID AND AAG40002.aaGLAssignID=AAG40003.aaGLAssignID)   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID + ''''+',''AA GL History Distribution Table'',''AA GL History Header ID=''+LTRIM(STR(A.aaGLHdrID)),1,1,LTRIM(STR(A.JRNENTRY))  FROM AAG40001 A1 INNER JOIN AAG40000 A ON A1.aaGLHdrID = A.aaGLHdrID AND A1.AA_CL_Status = 0 and ltrim(rtrim(SOURCDOC)) = ''''   LEFT OUTER JOIN (SELECT DISTINCT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR, TRXDATE, CURNCYID, CURRNIDX FROM GL30000 where SOURCDOC <> '''+ @l_ctBalSheet +   ''' and SOURCDOC <> '''+ @l_ctPROFIT_AND_LOSS + ''' ) B ON   A.JRNENTRY=B.JRNENTRY AND   A.RCTRXSEQ=B.RCTRXSEQ AND  A.aaGLTRXSource=B.TRXSORCE AND  A.YEAR1=B.HSTYEAR AND  A.GLPOSTDT = B.TRXDATE AND  A1.CURNCYID = B.CURNCYID AND  A1.CURRNIDX = B.CURRNIDX  WHERE A1.aaGLDistID >   (SELECT count(JRNENTRY) FROM   (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR,TRXDATE,CURNCYID,CURRNIDX FROM GL30000) C   WHERE C.JRNENTRY = A.JRNENTRY AND C.TRXSORCE =A.aaGLTRXSource AND A.RCTRXSEQ = C.RCTRXSEQ AND A.YEAR1 = C.HSTYEAR AND A.GLPOSTDT = C.TRXDATE AND A1.CURNCYID = C.CURNCYID AND A1.CURRNIDX = C.CURRNIDX  AND C.SOURCDOC not IN(''' + @l_ctBalSheet +''', ''' + @l_ctPROFIT_AND_LOSS + '''))')   DELETE AAG40001 FROM AAG40001 A1 INNER JOIN AAG40000 A ON A1.aaGLHdrID = A.aaGLHdrID AND A1.AA_CL_Status = 0 and ltrim(rtrim(SOURCDOC)) = ''  LEFT OUTER JOIN (SELECT DISTINCT JRNENTRY, RCTRXSEQ, TRXSORCE, HSTYEAR, TRXDATE, CURNCYID, CURRNIDX FROM GL30000 where SOURCDOC <> @l_cBalSheet   and SOURCDOC <> @l_cPROFIT_AND_LOSS) B ON   A.JRNENTRY=B.JRNENTRY AND   A.RCTRXSEQ=B.RCTRXSEQ AND  A.aaGLTRXSource=B.TRXSORCE AND  A.YEAR1=B.HSTYEAR AND  A.GLPOSTDT = B.TRXDATE AND  A1.CURNCYID = B.CURNCYID AND  A1.CURRNIDX = B.CURRNIDX  WHERE A1.aaGLDistID >   (SELECT count(JRNENTRY) FROM   (SELECT JRNENTRY,TRXSORCE,SOURCDOC,ACTINDX,CRDTAMNT,DEBITAMT,SEQNUMBR, RCTRXSEQ, HSTYEAR, TRXDATE,CURNCYID,CURRNIDX FROM GL30000) C   WHERE C.JRNENTRY = A.JRNENTRY AND C.TRXSORCE =A.aaGLTRXSource AND A.RCTRXSEQ = C.RCTRXSEQ AND A.YEAR1 = C.HSTYEAR AND A.GLPOSTDT = C.TRXDATE AND A1.CURNCYID = C.CURNCYID AND A1.CURRNIDX = C.CURRNIDX  AND C.SOURCDOC not IN(@l_ctBalSheet ,@l_ctPROFIT_AND_LOSS ))   EXEC ('INSERT INTO '+@TBName +'(USERID,  AATBL , ERMSGTXT,AAERMSG,AAERTYP,JRNENTRY)   SELECT DISTINCT '+''''+@USERID +  ''''+',''AA GL History Header Table'',''AA GL History Header ID=''+LTRIM(STR(A.aaGLHdrID)),1,1,LTRIM(STR(A.JRNENTRY))  FROM AAG40000 A LEFT OUTER JOIN GL30000 B ON   A.JRNENTRY=B.JRNENTRY AND   A.RCTRXSEQ=B.RCTRXSEQ AND  A.aaGLTRXSource=B.TRXSORCE AND  A.YEAR1=B.HSTYEAR  LEFT OUTER JOIN AAG40001 A1 ON A.aaGLHdrID = A1.aaGLHdrID AND   A1.AA_CL_Status = 0 AND  A.GLPOSTDT = B.TRXDATE AND  A1.CURNCYID = B.CURNCYID AND  A1.CURRNIDX = B.CURRNIDX  WHERE B.JRNENTRY IS NULL')    DELETE AAG40000 FROM AAG40000 A LEFT OUTER JOIN GL30000   B ON A.JRNENTRY=B.JRNENTRY AND   A.RCTRXSEQ=B.RCTRXSEQ AND  A.aaGLTRXSource=B.TRXSORCE AND  A.YEAR1=B.HSTYEAR  LEFT OUTER JOIN AAG40001 A1 ON A.aaGLHdrID = A1.aaGLHdrID AND   A1.AA_CL_Status = 0 AND  A.GLPOSTDT = B.TRXDATE AND  A1.CURNCYID = B.CURNCYID AND  A1.CURRNIDX = B.CURRNIDX  WHERE B.JRNENTRY IS NULL   END  set nocount off  END   
GO
GRANT EXECUTE ON  [dbo].[aagGenericGLHist] TO [DYNGRP]
GO
