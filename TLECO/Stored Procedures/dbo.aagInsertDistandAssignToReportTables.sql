SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE procedure [dbo].[aagInsertDistandAssignToReportTables] @cUserID char(15), @cTrxBatchSrc char(51), @iSeries int, @iHdrID int, @iOnlyUnposted tinyint = 0, @iLastDistID bigint = 0 as SELECT @cTrxBatchSrc = replace(@cTrxBatchSrc,'''','''''')  exec('delete from AAG50001 where USERID = ''' + @cUserID + ''' and TRXBTCHSRC = ''' + @cTrxBatchSrc + ''' and SERIES = ''' +@iSeries + ''' and aaSubLedgerHdrID = ' + @iHdrID) exec('delete from AAG50002 where USERID = ''' + @cUserID + ''' and TRXBTCHSRC = ''' + @cTrxBatchSrc + ''' and aaSubLedgerHdrID = ' + @iHdrID)  begin if @iOnlyUnposted = 1  begin   if not exists(select ACTINDX from AAG50001 where aaSubLedgerHdrID=@iHdrID)  begin  insert into AAG50001(aaSubLedgerHdrID,aaSubLedgerDistID, ACTINDX,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, CURNCYID, CURRNIDX,POSTED)  select aaSubLedgerHdrID,aaSubLedgerDistID, ACTINDX,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, CURNCYID, CURRNIDX,POSTED  from AAG20001 where aaSubLedgerHdrID = @iHdrID and POSTED = 0 and INTERID = DB_NAME()  end  end  else  begin  if not exists(select ACTINDX from AAG50001 where aaSubLedgerHdrID=@iHdrID)  begin  insert into AAG50001(aaSubLedgerHdrID,aaSubLedgerDistID, ACTINDX,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, CURNCYID, CURRNIDX,POSTED)  select aaSubLedgerHdrID,aaSubLedgerDistID, ACTINDX,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, CURNCYID, CURRNIDX,POSTED  from AAG20001 where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID > @iLastDistID and INTERID = DB_NAME()  end  end end exec('update AAG50001 set USERID = ''' + @cUserID + ''', TRXBTCHSRC = ''' + @cTrxBatchSrc + ''', SERIES = ''' +@iSeries + ''' where aaSubLedgerHdrID = ' + @iHdrID)  begin if @iOnlyUnposted = 1  begin   if not exists(select ORDBTAMT from AAG50002 where aaSubLedgerHdrID=@iHdrID)  begin  insert into AAG50002(aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT,  DistRef)  select aaSubLedgerHdrID, aaSubLedgerDistID,  aaSubLedgerAssignID,DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT,CAST((aaSubLedgerDistID-(SELECT MIN(aaSubLedgerDistID) FROM AAG20002 WHERE aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID > @iLastDistID   and aaSubLedgerDistID in(select aaSubLedgerDistID from AAG20001   where aaSubLedgerHdrID = @iHdrID and INTERID = DB_NAME()))+1) AS VARCHAR(10))   from AAG20002 where aaSubLedgerHdrID = @iHdrID  and aaSubLedgerDistID in(select aaSubLedgerDistID from AAG20001  where aaSubLedgerHdrID = @iHdrID and POSTED = 0  and INTERID = DB_NAME())  end  end else  begin  if not exists(select ORDBTAMT from AAG50002 where aaSubLedgerHdrID=@iHdrID)  begin  insert into AAG50002(aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT,  DistRef)  select aaSubLedgerHdrID,aaSubLedgerDistID,  aaSubLedgerAssignID,DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT,  CAST((aaSubLedgerDistID-(SELECT MIN(aaSubLedgerDistID) FROM AAG20002 WHERE aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID > @iLastDistID   and aaSubLedgerDistID in(select aaSubLedgerDistID from AAG20001   where aaSubLedgerHdrID = @iHdrID and INTERID = DB_NAME()))+1) AS VARCHAR(10))   from AAG20002 where aaSubLedgerHdrID = @iHdrID and aaSubLedgerDistID > @iLastDistID  and aaSubLedgerDistID in(select aaSubLedgerDistID from AAG20001   where aaSubLedgerHdrID = @iHdrID and INTERID = DB_NAME())  end  end end exec('update AAG50002 set USERID = ''' + @cUserID + ''', TRXBTCHSRC = ''' + @cTrxBatchSrc + ''' where aaSubLedgerHdrID = ' + @iHdrID)    
GO
GRANT EXECUTE ON  [dbo].[aagInsertDistandAssignToReportTables] TO [DYNGRP]
GO
