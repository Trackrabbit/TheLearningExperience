SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aagCreateGLforPrePayment]  @PMNTNMBR VARCHAR(100),  @TRXSORCE VARCHAR(100),  @aaGLWorkHdrID INT,  @CompanyID SMALLINT,  @SqlSessionID INT,  @l_ErrorCode SMALLINT = NULL OUTPUT AS  BEGIN   DECLARE   @PONUMBER VARCHAR(100),  @JRNENTRY INT,  @InterID CHAR(5),  @Ledger_ID SMALLINT,  @GLPOSTDT DATETIME,  @USERID VARCHAR(100),  @O_nSQL_Error_State INT,  @l_nError INT,  @PaymentSrcDoc VARCHAR(100),  @aaSubLedgerHdrID INT   SELECT @InterID =DB_NAME(), @USERID = SYSTEM_USER   exec    @l_ErrorCode = DYNAMICS.dbo.smGetMsgString 11574, @InterID, @PaymentSrcDoc output, @O_nSQL_Error_State output   SELECT @l_nError = @@ERROR   IF @l_ErrorCode = 0 and @l_nError <> 0   SELECT @l_ErrorCode = @l_nError   IF ( (@l_ErrorCode <> 0) or (@O_nSQL_Error_State <> 0) )   return (@l_ErrorCode)   SELECT @PONUMBER = PONUMBER, @GLPOSTDT = GLPOSTDT FROM POP10170 WHERE PMNTNMBR = @PMNTNMBR    if (SELECT TOP 1 1 FROM AAG20000 WHERE DOCNUMBR = @PONUMBER AND SERIES = 4 AND DOCTYPE = 1) is null  set @PONUMBER = @PMNTNMBR   SELECT @aaSubLedgerHdrID = aaSubLedgerHdrID FROM AAG20000 WHERE DOCNUMBR = @PONUMBER AND SERIES = 4 AND DOCTYPE = 1  UPDATE AAG20000 SET DOCNUMBR = @PMNTNMBR WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID   UPDATE AAG20001 SET DISTTYPE = P.DISTTYPE FROM AAG20001 A inner join PM10100 P ON P.DSTINDX = ACTINDX  AND   A.CRDTAMNT = P.CRDTAMNT  AND A.DEBITAMT = P.DEBITAMT WHERE P.VCHRNMBR = @PMNTNMBR AND P.TRXSORCE = @TRXSORCE and   P.PSTGDATE= @GLPOSTDT AND A.aaSubLedgerHdrID = @aaSubLedgerHdrID   exec aagRenumberAADistsForRMApply @aaSubLedgerHdrID, 16384   SELECT @JRNENTRY = JRNENTRY FROM GL10000  WHERE ORTRXSRC = @TRXSORCE AND SOURCDOC = @PaymentSrcDoc AND DTAControlNum = @PMNTNMBR AND JRNENTRY >= 0 AND TRXDATE = @GLPOSTDT   exec aagCreateDefaultAAForGLWork  @JRNENTRY,  @InterID,  @SqlSessionID,  @USERID    SELECT @aaGLWorkHdrID = aaGLWorkHdrID FROM AAG10000 WHERE JRNENTRY = @JRNENTRY  DELETE FROM AAG10002 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID IN(1,2)   INSERT INTO AAG10002(aaGLWorkHdrID, aaGLWorkDistID, aaGLWorkAssignID, DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT,   aaAssignedPercent, DistRef, NOTEINDX, aaAssignErrors, aaAliasID)   SELECT @aaGLWorkHdrID, aaSubLedgerDistID, aaSubLedgerAssignID,   (SELECT DEBITAMT FROM AAG10001 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID = AAG20002.aaSubLedgerDistID) * aaAssignedPercent / 10000,   (SELECT CRDTAMNT FROM AAG10001 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID = AAG20002.aaSubLedgerDistID) * aaAssignedPercent / 10000,   (SELECT ORDBTAMT FROM AAG10001 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID = AAG20002.aaSubLedgerDistID) * aaAssignedPercent / 10000,   (SELECT ORCRDAMT FROM AAG10001 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID = AAG20002.aaSubLedgerDistID) * aaAssignedPercent / 10000,   aaAssignedPercent, DistRef, NOTEINDX, aaAssignErrors, aaAliasID   FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID IN(1,2)  DELETE FROM AAG10003 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID IN(1,2)   INSERT INTO AAG10003(aaGLWorkHdrID, aaGLWorkDistID, aaGLWorkAssignID, aaTrxDimID, aaTrxCodeID, aaCodeErrors)   SELECT @aaGLWorkHdrID, aaSubLedgerDistID, aaSubLedgerAssignID, aaTrxDimID, aaTrxCodeID, aaCodeErrors FROM AAG20003   WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID IN(1,2)  END   
GO
GRANT EXECUTE ON  [dbo].[aagCreateGLforPrePayment] TO [DYNGRP]
GO
