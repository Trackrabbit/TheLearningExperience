SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
 create proc [dbo].[sopTrxDeleteWork]   (@SopType smallint=NULL, @SopNumber char(21)=NULL, @MstrNumber int=NULL, @iErrorState int=NULL output)  AS  declare @tTransaction tinyint,  @bachnumb varchar(15) BEGIN  SET nocount on  SELECT @iErrorState = 0 IF @SopType=NULL or @SopNumber=NULL BEGIN  SELECT @iErrorState = 21036  RETURN END  SET nocount on IF @@trancount = 0 BEGIN  SELECT @tTransaction = 1   BEGIN TRANSACTION  END  DELETE FROM SOP10101  WHERE SOP10101.SOPTYPE = @SopType AND SOP10101.SOPNUMBE = @SopNumber AND SOP10101.TRXSORCE = ''  DELETE FROM SOP10102   WHERE SOP10102.SOPTYPE = @SopType AND SOP10102.SOPNUMBE = @SopNumber AND SOP10102.TRXSORCE = ''  IF NOT EXISTS (SELECT * FROM SOP30200 WHERE SOP30200.SOPTYPE = @SopType AND SOP30200.SOPNUMBE = @SopNumber)  BEGIN  DELETE FROM SOP10103  WHERE SOP10103.SOPTYPE = @SopType AND SOP10103.SOPNUMBE = @SopNumber END  DELETE FROM SOP10104  WHERE SOP10104.SOPTYPE = @SopType AND SOP10104.SOPNUMBE = @SopNumber AND SOP10104.TRXSORCE = ''  DELETE FROM SOP10105  WHERE SOP10105.SOPTYPE = @SopType AND SOP10105.SOPNUMBE = @SopNumber AND SOP10105.TRXSORCE = ''  if not exists (SELECT * FROM SOP30200 WHERE SOP30200.SOPTYPE = @SopType AND SOP30200.SOPNUMBE = @SopNumber)  begin  DELETE FROM SOP10106  WHERE SOP10106.SOPTYPE = @SopType AND SOP10106.SOPNUMBE = @SopNumber     DELETE FROM SOP10107  WHERE SOP10107.SOPTYPE = @SopType AND SOP10107.SOPNUMBE = @SopNumber     DELETE FROM SOP10112  WHERE SOP10112.SOPTYPE = @SopType AND SOP10112.SOPNUMBE = @SopNumber  end  DELETE FROM SOP10201  WHERE SOP10201.SOPTYPE = @SopType AND SOP10201.SOPNUMBE = @SopNumber AND SOP10201.TRXSORCE = ''   DELETE FROM SOP10202  WHERE SOP10202.SOPTYPE = @SopType AND SOP10202.SOPNUMBE = @SopNumber AND SOP10202.TRXSORCE = ''   DELETE FROM SOP10200  WHERE SOP10200.SOPTYPE = @SopType AND SOP10200.SOPNUMBE = @SopNumber   SELECT @bachnumb = BACHNUMB FROM   SOP10100 WHERE  SOPNUMBE = @SopNumber  AND SOPTYPE = @SopType  DELETE FROM SOP10100   WHERE SOP10100.SOPTYPE = @SopType AND SOP10100.SOPNUMBE = @SopNumber   DELETE FROM SOP10204   WHERE SOP10204.SOPTYPE = @SopType AND SOP10204.SOPNUMBE = @SopNumber   DELETE FROM SOP40500   WHERE MSTRNUMB = @MstrNumber AND  NOT EXISTS ( SELECT * FROM SOP10100 WHERE MSTRNUMB = @MstrNumber ) AND  NOT EXISTS ( SELECT * FROM SOP30200 WHERE MSTRNUMB = @MstrNumber )  DELETE FROM SOP10207  WHERE SOP10207.SOPTYPE = @SopType AND SOP10207.SOPNUMBE = @SopNumber  DELETE a FROM SOP10206 a WHERE a.BACHNUMB = @bachnumb  AND NOT EXISTS (SELECT DISTINCT * FROM SOP10207   where a.BACHNUMB = BACHNUMB  AND a.LOCNCODE = LOCNCODE  AND a.SEQNUMBR = SEQNUMBR)  DELETE FROM CO00102  WHERE BusObjKey like '%Sales\Sales Order Line\' + RTRIM(LTRIM(STR(@SopType))) + '~' + RTRIM(LTRIM(@SopNumber)) + '%' DELETE FROM CO00102  WHERE BusObjKey like '%Sales\Sales Order\' + RTRIM(LTRIM(STR(@SopType))) + '~' + RTRIM(LTRIM(@SopNumber)) + '%'  DELETE FROM CO00101  WHERE Attachment_ID NOT IN (SELECT DISTINCT Attachment_ID FROM CO00102)  DELETE FROM coAttachmentItems  WHERE Attachment_ID NOT IN (SELECT DISTINCT Attachment_ID CO00101 FROM CO00102)  IF @tTransaction = 1  BEGIN  commit transaction  END  END   
GO
GRANT EXECUTE ON  [dbo].[sopTrxDeleteWork] TO [DYNGRP]
GO
