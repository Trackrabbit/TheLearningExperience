SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_RMA_Void_Unposted]  @RecordType smallint,  @ReturnDocID char(15),  @OverwriteCheck smallint,  @USERID char(15)  AS DECLARE @Exists smallint DECLARE @ReceivedLines smallint DECLARE @RMAStatus integer DECLARE @lStatus integer DECLARE @LNSEQNBR numeric(19,5),  @SVC_Next_Line_SEQ_Number numeric (19,5),  @SVC_Prev_Line_SEQ_Number numeric(19,5),  @RETTYPE char(11), @RMA_Status smallint,  @RETSTAT char(3), @Received tinyint,  @Traveler_Printed tinyint, @SVC_Ready_To_Close tinyint,  @SVC_RMA_Reason_Code char(3), @SVC_RMA_Reason_Code_Desc char(31),  @NOTEINDX numeric(19,5), @RETORIG smallint,  @RETREF char(31), @SRVRECTYPE smallint,  @CALLNBR char(11), @EQPLINE int,  @LNITMSEQ int, @SVC_RMA_From_Service tinyint,  @SOPTYPE smallint, @SOPNUMBE char(21),  @CMPNTSEQ int, @SOP_Line_Item_Sequence int,  @ENTDTE datetime, @ENTTME datetime,  @ETADTE datetime, @ETATME datetime,  @Commit_Date datetime, @Commit_Time datetime,  @RETUDATE datetime, @Return_Time datetime,  @COMPDTE datetime, @COMPTME datetime,  @PRMDATE datetime, @REFRENCE char(31),  @OFFID char(11),  @LOCNCODE char(11), @RTRNNAME char(45),  @RETADDR1 char(61), @RETADDR2 char(61),  @RETADDR3 char(61), @RTRNCITY char(35),  @SVC_Return_State char(29), @RTRNZIP char(11), @Return_Country char(61),   @CUSTNMBR char(15), @CUSTNAME char(65),  @ADRSCODE char(15), @CONTACT char(61),  @ADDRESS1 char(61), @ADDRESS2 char(61),  @ADDRESS3 char(61), @CITY char(35),  @STATE char(29), @ZIPCODE char(11), @COUNTRY char(61),   @Bill_To_Customer char(15), @SVC_Bill_To_Address_Code char(15),  @CSTPONBR char(21), @QUANTITY numeric(19,5),  @DECPLQTY smallint, @UOFM char(9),  @ITEMNMBR char(31), @ITEMDESC char(101),  @UNITCOST numeric(19,5), @ORUNTCST numeric(19,5),  @EXTDCOST numeric(19,5), @OREXTCST numeric(19,5),  @UNITPRCE numeric(19,5), @ORUNTPRC numeric(19,5),  @XTNDPRCE numeric(19,5), @OXTNDPRC numeric(19,5),  @CUSTOWN tinyint, @FACTSEAL tinyint,  @ORDDOCID char(15), @TRANSLINESEQ int,  @STATUS smallint,   @Flat_Rate_Repair_Price numeric(19,5), @Orig_Flat_RepairPrice numeric(19,5),  @Repair_Price numeric(19,5), @Originating_Repair_Price numeric(19,5),  @NTE_Price numeric(19,5), @Originating_NTE_Price numeric(19,5),  @Repair_Cost numeric(19,5), @Originating_Repair_Cost numeric(19,5),  @Bill_of_Lading char(31), @SHIPMTHD char(15),  @Credit_SOP_Type smallint, @Credit_SOP_Number char(21),  @Credit_SOP_Line_Item_Seq int,   @Replace_SOP_Type smallint, @Replace_SOP_Number char(21),  @Replace_SOP_Line_Item_Se int, @Location_Code_Replacemen char(11),  @Replace_Item_Number char(31), @Replace_U_Of_M char(9),  @Replace_Price_Level char(11), @Replace_QTY numeric(19,5),  @Replace_Cost numeric(19,5), @Originating_Replace_Cost numeric(19,5),  @Replace_Price numeric(19,5), @Originating_Replace_Pric numeric(19,5),  @SOP_Number_Invoice char(21), @Item_Number_Invoice char(31),  @USERDEF1 char(21), @USERDEF2 char(21),   @USRDEF03 char(21), @USRDEF04 char(21),   @USRDEF05 char(21),  @CURRNIDX smallint, @DECPLCUR smallint,  @ODECPLCU smallint, @Return_Item_Number char(31),  @Return_Item_Description char(51), @Return_Location_Code char(11),  @Return_QTY numeric(19,5), @Return_U_Of_M char(9),   @RETCOST numeric(19,5), @Originating_Return_Cost numeric(19,5),  @SVC_Extended_Return_Cost numeric(19,5), @SVC_Orig_Ext_Return_Cost numeric(19,5),  @SVC_Return_Price_Level char(11), @SVC_Return_Price numeric(19,5),  @Originating_Return_Price numeric(19,5), @SVC_Extended_Return_Pric numeric(19,5),  @SVC_Orig_Ext_Return_Pric numeric(19,5), @SVC_FO_ID char(51),  @SVC_SCM_Complete smallint declare @AuditItemSeq numeric(19,5) declare @VoidStatus int, @CurrentStatus char(3) declare @VoidRetStatus char(3) declare @MinDate datetime, @MinDateD datetime, @MinDateT datetime  begin  SET @Exists = 0  SET @ReceivedLines = 1  SET @VoidStatus = 20  SET @VoidRetStatus = 'VOD'   EXEC smGetMinDate @MinDate output   EXEC SVC_util_split_datetime @MinDate, @MinDateD output, @MinDateT output   IF @ReturnDocID <> '' AND @RecordType = 1  IF EXISTS(SELECT * FROM SVC05000 WHERE RETDOCID = @ReturnDocID AND Return_Record_Type = @RecordType)  SET @Exists = 1  ELSE  SET @Exists = 0  IF @Exists = 0  return (1001)   IF @OverwriteCheck = 0   exec SVC_Check_RMA_Status @RecordType, @ReturnDocID, @RMAStatus OUTPUT  ELSE  SET @RMAStatus = 0  IF @RMAStatus <> 0  return (@RMAStatus)   SELECT @CurrentStatus = ISNULL(RETSTAT, '') FROM SVC05000 WHERE RETDOCID = @ReturnDocID AND Return_Record_Type = @RecordType  IF NOT EXISTS(SELECT * FROM SVC05200 WHERE RETDOCID = @ReturnDocID AND Return_Record_Type = @RecordType)  select @ReceivedLines = 0    else  Begin   IF NOT EXISTS(SELECT * FROM SVC05200 WHERE RETDOCID = @ReturnDocID AND Return_Record_Type = @RecordType   AND (((RMA_Status = 8 OR RMA_Status = 7) AND Received = 1)  OR (RMA_Status = 9 AND SVC_Ready_To_Close = 1)))  begin  begin tran moveRMALine  UPDATE SVC05200 SET RMA_Status = @VoidStatus WHERE RETDOCID = @ReturnDocID AND Return_Record_Type = @RecordType   exec SVC_RMA_Move_Lines_To_History @RecordType, @ReturnDocID, 0, @lStatus   IF @lStatus = 0  begin  rollback tran moveRMALine  return (1002)  end   commit tran moveRMALine  SET @ReceivedLines = 0   end   End   IF @ReceivedLines = 0  begin  UPDATE SVC05000 SET RMA_Status = @VoidStatus WHERE RETDOCID = @ReturnDocID AND Return_Record_Type = @RecordType   INSERT SVC35000 SELECT RETDOCID, 2 , RMA_Status, Received, RETORIG, RETREF, RETSTAT, RETTYPE,   ENTDTE, ENTTME, ETADTE, ETATME, RETUDATE, Return_Time, COMPDTE, COMPTME, USERID, OFFID,  RTRNNAME, RETADDR1, RETADDR2, RETADDR3, RTRNCITY, SVC_Return_State, RTRNZIP, Return_Country,  LOCNCODE, CUSTNMBR, ADRSCODE, CUSTNAME, CONTACT, ADDRESS1, ADDRESS2, ADDRESS3, CITY, STATE, ZIPCODE, COUNTRY,  NOTEINDX, CALLNBR, SRVRECTYPE, EQPLINE, LNITMSEQ, Bill_of_Lading, SHIPMTHD, SOPTYPE, SOPNUMBE, SOP_Line_Item_Sequence,  CMPNTSEQ, Bill_To_Customer, SVC_Bill_To_Address_Code, Commit_Date, Commit_Time,   USERDEF1, USERDEF2, USRDEF03, USRDEF04, USRDEF05,   CURNCYID, CURRNIDX, RATETPID, EXGTBLID, XCHGRATE, EXCHDATE, DECPLACS, TIME1, RATECALC, VIEWMODE, ISMCTRX,   EXPNDATE, DENXRATE, MCTRXSTT,  CSTPONBR, SVC_RMA_Reason_Code, SVC_RMA_Reason_Code_Desc, SVC_RMA_From_Service, SVC_FO_ID  FROM SVC05000 WHERE RETDOCID = @ReturnDocID AND Return_Record_Type = @RecordType   SET @AuditItemSeq = (SELECT ISNULL(MAX(LNITMSEQ),0) + 1 FROM SVC35020 WHERE RETDOCID = @ReturnDocID)  INSERT INTO SVC35020 (RETDOCID, LNSEQNBR, LNITMSEQ, SVCFRMSTAT, SVCTOSTAT,  DSCRPTION, USERID, CREATDDT, CREATETIME)  VALUES (@ReturnDocID, 0, @AuditItemSeq, @CurrentStatus, @VoidRetStatus,   'Move to History via RMA Void',   @USERID, CONVERT(varchar(10),GETDATE(),102) + ' 00:00:00', @MinDateD + CONVERT(varchar(10),GETDATE(),108))   DELETE FROM SVC05000 WHERE RETDOCID = @ReturnDocID AND Return_Record_Type = @RecordType   return (1009)   end end return   
GO
GRANT EXECUTE ON  [dbo].[SVC_RMA_Void_Unposted] TO [DYNGRP]
GO
