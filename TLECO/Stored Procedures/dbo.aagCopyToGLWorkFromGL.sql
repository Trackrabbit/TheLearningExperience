SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE              procedure [dbo].[aagCopyToGLWorkFromGL] @I_nGLHdrID int, @HdrID int output, @I_nYear int, @I_cTrxSource char(13), @O_fSuccess tinyint = 1 output, @CompanyID smallint as begin tran  declare @RCTRXSEQ int,  @ORMSTRID  char(31),  @aaGLWorkHdrID int,  @nIsYECJrnl tinyint   select  @RCTRXSEQ = 0, @nIsYECJrnl = 0   if exists(Select YEAR1 from SY40101 where YEAR1 = @I_nYear and HISTORYR = 0)   begin   Select top 1 @RCTRXSEQ = RCTRXSEQ ,@ORMSTRID =  ORMSTRID from GL20000  where JRNENTRY in (Select JRNENTRY from AAG30000 where aaGLHdrID = @I_nGLHdrID) and  TRXSORCE = @I_cTrxSource   end  else  begin  Select top 1 @RCTRXSEQ = RCTRXSEQ , @ORMSTRID =  ORMSTRID from GL30000  where JRNENTRY in (Select JRNENTRY from AAG30000 where aaGLHdrID = @I_nGLHdrID) and  TRXSORCE = @I_cTrxSource  end   if exists(Select 1 from AAG30001 where aaGLHdrID = @I_nGLHdrID and ltrim(rtrim(SOURCDOC)) <> '')  begin  select @nIsYECJrnl = 1  end   exec DYNAMICS.dbo.aagGetNextID 10000, @CompanyID, @HdrID output    if exists (SELECT 1 FROM AAG10000 WHERE exists(SELECT  1  FROM [AAG30000]   where  AAG30000.JRNENTRY = AAG10000.JRNENTRY and   AAG30000.RCTRXSEQ = AAG10000.RCTRXSEQ and   aaGLHdrID = @I_nGLHdrID))  begin  SELECT @aaGLWorkHdrID = aaGLWorkHdrID FROM AAG10000 WHERE exists(SELECT  1  FROM [AAG30000]   where  AAG30000.JRNENTRY = AAG10000.JRNENTRY and   AAG30000.RCTRXSEQ = AAG10000.RCTRXSEQ and   aaGLHdrID = @I_nGLHdrID)  DELETE AAG10000 WHERE aaGLWorkHdrID = @aaGLWorkHdrID  end    INSERT INTO [AAG10000] ([aaGLWorkHdrID], [JRNENTRY], [RCTRXSEQ],[aaTRXType], [GLPOSTDT], [Ledger_ID])  SELECT  @HdrID, [JRNENTRY], [RCTRXSEQ], 3, [GLPOSTDT],[Ledger_ID]   FROM [AAG30000]  where aaGLHdrID = @I_nGLHdrID   if @nIsYECJrnl = 0  begin  INSERT INTO [AAG10001] ([aaGLWorkHdrID], [aaGLWorkDistID],[INTERID], [aaBrowseType], [CorrespondingUnit], [ACTINDX], [ACCTTYPE],  [DECPLACS], [DEBITAMT], [CRDTAMNT], [ORDBTAMT], [ORCRDAMT], [CURNCYID],  [CURRNIDX], [RATETPID], [EXGTBLID], [XCHGRATE], [EXCHDATE], [TIME1],  [RTCLCMTD], [DENXRATE], [MCTRXSTT],[SQNCLINE], [aaCustID], [aaVendID],  [aaSiteID], [aaItemID], [EMPLOYID], [aaCopyStatus],[aaChangeDate],[aaChangeTime])  SELECT      @HdrID, [AAG30001].[aaGLDistID],[AAG30001].[INTERID],[AAG30001].[aaBrowseType], [AAG30001].[CorrespondingUnit], [AAG30001].[ACTINDX], [AAG30001].[ACCTTYPE],   [AAG30001].[DECPLACS], [AAG30001].[DEBITAMT], [AAG30001].[CRDTAMNT], [AAG30001].[ORDBTAMT], [AAG30001].[ORCRDAMT], [AAG30001].[CURNCYID],   [AAG30001].[CURRNIDX], [AAG30001].[RATETPID], [AAG30001].[EXGTBLID], [AAG30001].[XCHGRATE], [AAG30001].[EXCHDATE], [AAG30001].[TIME1],   [AAG30001].[RTCLCMTD], [AAG30001].[DENXRATE], [AAG30001].[MCTRXSTT], [AAG30001].[SEQNUMBR],   isnull(dbo.aagGetMstrIDGL(2,GL20000.ORMSTRID,0,[AAG30001].ACTINDX),0),   isnull(dbo.aagGetMstrIDGL(6,GL20000.ORMSTRID,0,[AAG30001].ACTINDX),0),   [AAG30001].[aaSiteID], [AAG30001].[aaItemID], isnull(dbo.aagGetMstrIDGL(3,GL20000.ORMSTRID,0,[AAG30001].ACTINDX),0), [AAG30001].[aaCopyStatus],convert(char(12), getdate(), 102), convert(char(12), getdate(), 108)   FROM [AAG30001] , GL20000 , AAG30000   where AAG30000.JRNENTRY = GL20000.JRNENTRY   and AAG30000.RCTRXSEQ = GL20000.RCTRXSEQ   and AAG30001.SEQNUMBR = GL20000.SEQNUMBR   and AAG30001.aaGLHdrID = AAG30000.aaGLHdrID   and [AAG30001].aaGLHdrID = @I_nGLHdrID   and GL20000.RCTRXSEQ = @RCTRXSEQ   and AAG30001.ACTINDX = GL20000.ACTINDX  end  else  begin  INSERT INTO [AAG10001] ([aaGLWorkHdrID], [aaGLWorkDistID],[INTERID], [aaBrowseType], [CorrespondingUnit], [ACTINDX], [ACCTTYPE],  [DECPLACS], [DEBITAMT], [CRDTAMNT], [ORDBTAMT], [ORCRDAMT], [CURNCYID],  [CURRNIDX], [RATETPID], [EXGTBLID], [XCHGRATE], [EXCHDATE], [TIME1],  [RTCLCMTD], [DENXRATE], [MCTRXSTT],[SQNCLINE], [aaCustID], [aaVendID],  [aaSiteID], [aaItemID], [EMPLOYID], [aaCopyStatus],[aaChangeDate],[aaChangeTime])  SELECT      @HdrID, [AAG30001].[aaGLDistID],[AAG30001].[INTERID],[AAG30001].[aaBrowseType], [AAG30001].[CorrespondingUnit], [AAG30001].[ACTINDX], [AAG30001].[ACCTTYPE],   [AAG30001].[DECPLACS], [AAG30001].[DEBITAMT], [AAG30001].[CRDTAMNT], [AAG30001].[ORDBTAMT], [AAG30001].[ORCRDAMT], [AAG30001].[CURNCYID],   [AAG30001].[CURRNIDX], [AAG30001].[RATETPID], [AAG30001].[EXGTBLID], [AAG30001].[XCHGRATE], [AAG30001].[EXCHDATE], [AAG30001].[TIME1],   [AAG30001].[RTCLCMTD], [AAG30001].[DENXRATE], [AAG30001].[MCTRXSTT], [AAG30001].[SEQNUMBR],   '', '',   [AAG30001].[aaSiteID], [AAG30001].[aaItemID], [AAG30001].[EMPLOYID], [AAG30001].[aaCopyStatus],convert(char(12), getdate(), 102), convert(char(12), getdate(), 108)   FROM [AAG30001]  where [AAG30001].aaGLHdrID = @I_nGLHdrID   end   INSERT INTO [AAG10002] ([aaGLWorkHdrID], [aaGLWorkDistID], [aaGLWorkAssignID], [DEBITAMT], [CRDTAMNT],  [ORDBTAMT], [ORCRDAMT],[aaAssignedPercent], [DistRef], [NOTEINDX], [aaAliasID])  SELECT    @HdrID, [aaGLDistID], [aaGLAssignID], [DEBITAMT], [CRDTAMNT],  [ORDBTAMT], [ORCRDAMT],[aaAssignedPercent], [DistRef], [NOTEINDX], [aaAliasID]  FROM [AAG30002]  where aaGLHdrID = @I_nGLHdrID   INSERT INTO [AAG10003] ([aaGLWorkHdrID], [aaGLWorkDistID], [aaGLWorkAssignID], [aaTrxDimID], [aaTrxCodeID])  SELECT    @HdrID, [aaGLDistID], [aaGLAssignID], [aaTrxDimID], [aaTrxCodeID]  FROM [AAG30003]  where aaGLHdrID = @I_nGLHdrID   commit tran    
GO
GRANT EXECUTE ON  [dbo].[aagCopyToGLWorkFromGL] TO [DYNGRP]
GO
