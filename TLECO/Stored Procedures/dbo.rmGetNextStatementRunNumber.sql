SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[rmGetNextStatementRunNumber]  @O_iRunNumber int  = NULL  output,  @O_iErrorState int  = NULL  output as   declare  @iRunNumberOK int,  @TRUE int,  @FALSE int,   @tTransaction tinyint,  @iError int,  @iRowcount int,  @iStatus int,  @MAXINT int  select  @O_iRunNumber  = 0,  @O_iErrorState  = 0,  @iStatus  = 0,  @iRunNumberOK  = 0,     @TRUE   = 1,  @FALSE   = 0,  @MAXINT   = 2147483647  if @@trancount = 0 begin  select @tTransaction = 1  begin transaction end  while (@iRunNumberOK <> @TRUE) begin  update  RM40102  set  @O_iRunNumber = NXTRNNMBR,  NXTRNNMBR = NXTRNNMBR + 1   select @iRowcount = @@rowcount  select @iError = @@error  if ( @iError = 0 ) and ( @iRowcount = 0 )  begin  select  @O_iRunNumber = (  select  max(RNNMBR)  from  RM30701 with (NOLOCK) ) + 1   if ( @O_iRunNumber is NULL )   select @O_iRunNumber = 1   insert  RM40102  (UNIQKEY, NXTRNNMBR)  values  ('1', @O_iRunNumber + 1)  end  else if ( @iRowcount < 0 or @iRowcount > 1)  begin  select  @O_iErrorState  = 21087  break  end  else if (@iError <> 0 )  begin  select @iStatus = @iError  end   if ( @O_iRunNumber >= @MAXINT ) or ( @O_iRunNumber = 0 ) or ( @O_iRunNumber is NULL )  begin  select  @O_iRunNumber = (  select  max(RNNMBR)  from  RM30701 with (NOLOCK) ) + 1  if ( @O_iRunNumber is NULL or @O_iRunNumber >= @MAXINT )   select @O_iRunNumber = 1   update  RM40102  set  NXTRNNMBR = @O_iRunNumber + 1   if ( @@rowcount <> 1)  begin  select @O_iErrorState = 21087  break  end  end  if not exists (  select  1  from  RM30701 with (NOLOCK)  where  RNNMBR = @O_iRunNumber )  begin  select @iRunNumberOK = @TRUE     end  else   begin  select @iRunNumberOK = @FALSE  end  end   if @O_iErrorState <> 0 begin  select @O_iRunNumber = 0  if @tTransaction = 1  rollback transaction end else begin  if @tTransaction = 1  commit transaction end  return (@iStatus)   
GO
GRANT EXECUTE ON  [dbo].[rmGetNextStatementRunNumber] TO [DYNGRP]
GO
