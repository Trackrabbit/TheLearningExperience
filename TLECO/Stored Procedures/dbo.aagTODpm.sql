SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create           procedure [dbo].[aagTODpm]  @SqlSessionID int as begin  set nocount on  declare @CMPANYID smallint,  @Hdr int,  @CNTRLTYP int,  @VCHRNMBR char(21)  select @Hdr  =0   select  @CMPANYID = CMPANYID from DYNAMICS.dbo.SY01500 where INTERID = DB_NAME()  declare CPM cursor fast_forward for  select CNTRLTYP,VCHRNMBR  from PM10100  group by CNTRLTYP,VCHRNMBR  union all  select CNTRLTYP,VCHRNMBR  from PM30600  group by CNTRLTYP,VCHRNMBR  open CPM  fetch next from CPM into @CNTRLTYP,@VCHRNMBR  while @@fetch_status = 0  begin  insert into AAG20000  (aaSubLedgerHdrID,SERIES,DOCTYPE,DOCNUMBR,Master_ID,aaHdrErrors)  values(dbo.aagGetNextHdrID(20000),4,@CNTRLTYP,@VCHRNMBR,' ',0)  fetch next from CPM into @CNTRLTYP,@VCHRNMBR  end  close CPM  deallocate CPM   update DYNAMICS..AAG00102 set aaRowID = dbo.aagGetNextHdrID(20000) - 1  where aaTableID = 20000 and CMPANYID = @CMPANYID   insert into AAG20001  (aaSubLedgerHdrID, aaSubLedgerDistID, INTERID, ACTINDX, DISTTYPE, aaBrowseType,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, CURNCYID, CURRNIDX, SEQNUMBR,  GLPOSTDT, aaCustID, POSTED ,RATETPID, EXGTBLID, XCHGRATE, EXCHDATE, TIME1,  RTCLCMTD, DENXRATE, MCTRXSTT,aaChangeDate,aaChangeTime,ACCTTYPE)   select dbo.aagGetHdrID(4,CNTRLTYP,VCHRNMBR,' ',0,0, getdate(),0,' ',20000),  DEX_ROW_ID,  DB_NAME(), DSTINDX, DISTTYPE, 0,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, isnull(CURNCYID,' '), isnull(CURRNIDX,0), DSTSQNUM,  PSTGDATE, '', 0, isnull(RATETPID,' '), isnull(EXGTBLID,' '), isnull(XCHGRATE,0), isnull(EXCHDATE,'1999-03-06 00:00:00.000'), isnull(TIME1,0),  isnull(RTCLCMTD,0), isnull(DENXRATE,0), isnull(MCTRXSTT,0),convert(char(12), getdate(), 102),convert(char(12), getdate(), 108),  dbo.aagGetAccountType(DSTINDX)  from PM10100   union all  select dbo.aagGetHdrID(4,PM30600.CNTRLTYP,PM30600.VCHRNMBR,' ',0,0, getdate(),0,' ',20000),  PM30600.DEX_ROW_ID,  DB_NAME(), PM30600.DSTINDX, PM30600.DISTTYPE, 0,  PM30600.DEBITAMT, PM30600.CRDTAMNT, PM30600.ORDBTAMT, PM30600.ORCRDAMT, isnull(MC020103.CURNCYID,' '), isnull(MC020103.CURRNIDX,0), PM30600.DSTSQNUM,  PM30600.PSTGDATE, 1, 0, isnull(MC020103.RATETPID,' '), isnull(MC020103.EXGTBLID,' '), isnull(MC020103.XCHGRATE,0), isnull(MC020103.EXCHDATE,'1999-03-06 00:00:00.000'), isnull(MC020103.TIME1,0),  isnull(MC020103.RTCLCMTD,0), isnull(MC020103.DENXRATE,0), isnull(MC020103.MCTRXSTT,0),convert(char(12), getdate(), 102),convert(char(12), getdate(), 108),  dbo.aagGetAccountType(PM30600.DSTINDX) from  PM30600 LEFT OUTER JOIN  MC020103 on PM30600.CNTRLTYP = MC020103.DOCTYPE and  PM30600.VCHRNMBR = MC020103.VCHRNMBR   Update AAG20001 SET aaSubLedgerDistID=0-aaSubLedgerDistID  where aaSubLedgerHdrID not in (select distinct aaSubLedgerHdrID from AAG20002)  UPDATE AAG20001   SET aaSubLedgerDistID = (SELECT COUNT(1) FROM AAG20001 AA WHERE AAG20001.DEX_ROW_ID >= AA.DEX_ROW_ID AND AA.aaSubLedgerHdrID = AAG20001.aaSubLedgerHdrID )  where AAG20001.aaSubLedgerHdrID not in (select distinct aaSubLedgerHdrID from AAG20002)   insert into AAG20002   (aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID,DEBITAMT,  CRDTAMNT,ORDBTAMT,ORCRDAMT,aaAssignedPercent,DistRef,NOTEINDX,aaAssignErrors)  select aaSubLedgerHdrID,aaSubLedgerDistID,1,DEBITAMT,  CRDTAMNT,ORDBTAMT,ORCRDAMT,10000,' ',0,0 from AAG20001 where aaSubLedgerHdrID in  (select aaSubLedgerHdrID from AAG20000 where SERIES = 4)  set nocount off end    
GO
GRANT EXECUTE ON  [dbo].[aagTODpm] TO [DYNGRP]
GO
