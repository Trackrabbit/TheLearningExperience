SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 Create procedure [dbo].[SVC_METER_Post_Batch](@BatchID char(15),  @Date datetime,  @UserID char(15)) as declare @Meter1 integer declare @Meter2 integer declare @Meter3 integer declare @Meter4 integer declare @Meter5 integer declare @EquipID integer declare @DexID integer declare @PrevMeter1 integer declare @PrevMeter2 integer declare @PrevMeter3 integer declare @PrevMeter4 integer declare @PrevMeter5 integer declare @problem integer,  @SourceModule char(2),  @SourceDocument varchar(255)  select @SourceModule = 'CLS',   @problem = 0 if not exists(select * from SVC10300 where BACHNUMB = @BatchID) return(-190001) if 1 in (select In_Use from SVC10300 where BACHNUMB = @BatchID) return(-190002) update SVC10300 set In_Use = 1 where BACHNUMB = @BatchID declare Meter_Cursor cursor for select EQUIPID, Meters_1, Meters_2, Meters_3, Meters_4, Meters_5, DEX_ROW_ID  from SVC10301   where BACHNUMB = @BatchID open Meter_Cursor fetch next from Meter_Cursor into @EquipID,@Meter1,@Meter2,@Meter3,@Meter4,@Meter5,@DexID while (@@fetch_status = 0)   begin  select @PrevMeter1 = Meters_1,  @PrevMeter2 = Meters_2,  @PrevMeter3 = Meters_3,  @PrevMeter4 = Meters_4,  @PrevMeter5 = Meters_5  from SVC00300  where EQUIPID = @EquipID    if (@Meter1 > @PrevMeter1 or @Meter1 = 0) and  (@Meter2 > @PrevMeter2 or @Meter2 = 0) and  (@Meter3 > @PrevMeter3 or @Meter3 = 0) and  (@Meter4 > @PrevMeter4 or @Meter4 = 0) and  (@Meter5 > @PrevMeter5 or @Meter5 = 0)  begin  select @SourceDocument = CONVERT(varchar(20),@EquipID)   exec SVC_METER_Post_Serial_Readings @EquipID,@Meter1,@Meter2,@Meter3,@Meter4,@Meter5,0,0,0,0,0,@Date,@UserID,'Batch Post',@SourceModule,@SourceDocument  delete SVC10301 where DEX_ROW_ID = @DexID  end  else  begin  select @problem = -190003  end  fetch next from Meter_Cursor into @EquipID,@Meter1,@Meter2,@Meter3,@Meter4,@Meter5,@DexID  end deallocate Meter_Cursor update SVC10300 set In_Use = 0 where BACHNUMB = @BatchID return @problem    
GO
GRANT EXECUTE ON  [dbo].[SVC_METER_Post_Batch] TO [DYNGRP]
GO
