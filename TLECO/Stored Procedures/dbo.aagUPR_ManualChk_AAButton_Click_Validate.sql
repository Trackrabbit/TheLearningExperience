SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROC [dbo].[aagUPR_ManualChk_AAButton_Click_Validate] @I_PYADNMBR INT, @I_MLCHKTYP SMALLINT, @O_MLTRXNBR INT OUTPUT, @O_SEQNUMBR INT OUTPUT, @O_ACTINDX INT OUTPUT, @O_DEPRTMNT CHAR(7) OUTPUT, @O_JOBTITLE CHAR(7) OUTPUT, @O_UPRTRXCD CHAR(7) OUTPUT, @O_UPRACTYP smallint OUTPUT, @O_ERRORVALID INT OUTPUT  AS BEGIN  DECLARE @STRFILTER VARCHAR(50)   SET @STRFILTER = ''  SET @O_ERRORVALID = 0   IF @O_ACTINDX <> 0 AND @O_SEQNUMBR <> 0  BEGIN  SET @STRFILTER = ' AND UPR.ACTINDX = ' + CONVERT(VARCHAR(21),@O_ACTINDX) + ' AND UPR.SEQNUMBR = ' + CONVERT(VARCHAR(21),@O_SEQNUMBR)   END  SET @O_ACTINDX = 0   IF NOT EXISTS(SELECT 1 FROM UPR10310 WHERE PYADNMBR = @I_PYADNMBR AND MLCHKTYP = @I_MLCHKTYP)  BEGIN  SET @O_ERRORVALID = 3  RETURN  END   IF EXISTS(SELECT 1 FROM UPR10310 UPR  INNER JOIN AAG00200 AA ON UPR.ACTINDX = AA.ACTINDX  AND aaAcctClassID <> 0   WHERE PYADNMBR = @I_PYADNMBR AND MLCHKTYP = @I_MLCHKTYP)  BEGIN  EXEC ('DECLARE CURAAMANUALCHKVALIDATE CURSOR FAST_FORWARD FOR  SELECT  TOP 1 MLTRXNBR, SEQNUMBR, UPR.ACTINDX, UPR.DEPRTMNT, UPR.JOBTITLE, UPR.UPRTRXCD, UPR.UPRACTYP  FROM UPR10310 UPR  INNER JOIN AAG00200 AA ON UPR.ACTINDX = AA.ACTINDX  AND aaAcctClassID <> 0   WHERE PYADNMBR = ' + @I_PYADNMBR + ' AND MLCHKTYP = ' + @I_MLCHKTYP + '' + @STRFILTER + '  ORDER BY UPR.SEQNUMBR')  OPEN CURAAMANUALCHKVALIDATE  FETCH NEXT FROM CURAAMANUALCHKVALIDATE INTO @O_MLTRXNBR, @O_SEQNUMBR, @O_ACTINDX, @O_DEPRTMNT, @O_JOBTITLE, @O_UPRTRXCD, @O_UPRACTYP  WHILE @@FETCH_STATUS = 0   BEGIN   IF @O_ACTINDX <> 0   BEGIN  FETCH NEXT FROM CURAAMANUALCHKVALIDATE INTO @O_MLTRXNBR, @O_SEQNUMBR, @O_ACTINDX, @O_DEPRTMNT, @O_JOBTITLE, @O_UPRTRXCD, @O_UPRACTYP   END  END  CLOSE CURAAMANUALCHKVALIDATE  DEALLOCATE CURAAMANUALCHKVALIDATE    IF @O_ACTINDX <> 0  BEGIN  SET @O_ERRORVALID = 0  END  ELSE  BEGIN  SET @O_ERRORVALID = 2   END  IF @O_ACTINDX = 0   BEGIN  EXEC ('DECLARE CURAAMANUALCHKVALIDATE_2 CURSOR FAST_FORWARD FOR  SELECT  TOP 1 MLTRXNBR, SEQNUMBR, UPR.ACTINDX, UPR.DEPRTMNT, UPR.JOBTITLE, UPR.UPRTRXCD, UPR.UPRACTYP  FROM UPR10310 UPR  INNER JOIN AAG00200 AA ON UPR.ACTINDX = AA.ACTINDX  AND aaAcctClassID <> 0   WHERE PYADNMBR = ' + @I_PYADNMBR + ' AND MLCHKTYP = ' + @I_MLCHKTYP + '  ORDER BY UPR.SEQNUMBR')  OPEN CURAAMANUALCHKVALIDATE_2  FETCH NEXT FROM CURAAMANUALCHKVALIDATE_2 INTO @O_MLTRXNBR, @O_SEQNUMBR, @O_ACTINDX, @O_DEPRTMNT, @O_JOBTITLE, @O_UPRTRXCD, @O_UPRACTYP  WHILE @@FETCH_STATUS = 0   BEGIN   SET @O_ERRORVALID = 2  IF @O_ACTINDX <> 0   BEGIN  FETCH NEXT FROM CURAAMANUALCHKVALIDATE_2 INTO @O_MLTRXNBR, @O_SEQNUMBR, @O_ACTINDX, @O_DEPRTMNT, @O_JOBTITLE, @O_UPRTRXCD, @O_UPRACTYP  END  END  CLOSE CURAAMANUALCHKVALIDATE_2  DEALLOCATE CURAAMANUALCHKVALIDATE_2   END   END  ELSE  BEGIN  SET @O_ERRORVALID = 1  END END    
GO
GRANT EXECUTE ON  [dbo].[aagUPR_ManualChk_AAButton_Click_Validate] TO [DYNGRP]
GO
