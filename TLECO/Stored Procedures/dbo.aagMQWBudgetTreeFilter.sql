SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[aagMQWBudgetTreeFilter] as begin  set nocount on  declare @aaMinOrder int,  @aaMaxOrder   int,  @aaColumnCmd nvarchar(2000),  @changeflag int,  @aaCmd nvarchar(2000),  @Param nvarchar(100),  @Cnt int,  @aaBudgetTreeID int,  @PageBreak int,  @MaxCodeSeq int   select  @aaMinOrder  = 0,  @aaMaxOrder  = 0,  @changeflag  = 0,  @aaBudgetTreeID  = 0,  @aaColumnCmd  = '',  @PageBreak  = 0  if not exists(select name from tempdb..sysobjects where name = '##BudgetTree'    and type = 'U') return  select top 1 @aaMinOrder = aaOrder from ##Lvl where aaColumn > 16000 order by aaOrder   select top 1 @aaMaxOrder = aaOrder from ##Lvl where aaColumn > 16000 order by aaOrder desc  select @aaBudgetTreeID = aaTreeID from ##Col where aaColumn = 118   set @Cnt  = @aaMinOrder  while @Cnt <>(@aaMaxOrder + 1)   begin  if @changeflag = 0  begin  set @aaColumnCmd = @aaColumnCmd + 'ltrim(str('+'##Rows.L'+ltrim(str(@Cnt))+'_codeID'+'))'  set @changeflag = 1  end  else  begin  set @aaColumnCmd = @aaColumnCmd + '+'+''','''+' +  isnull(ltrim(str('+'##Rows.L'+ltrim(str(@Cnt))+'_codeID'+')),space(1))'  end  set @Cnt = @Cnt + 1  end   if exists(select name from tempdb..sysobjects where name = '##RowFilter'    and type = 'U') drop table ##RowFilter  create table ##RowFilter(rowOrder int,aaLvlCodeString char(51),aaCodeSequence int, NewrowOrder int identity )  set @aaCmd = 'insert into  ##RowFilter(rowOrder,aaLvlCodeString,aaCodeSequence)  select ##Rows.rowOrder,dbo.aaMLGetCodeString(' +@aaColumnCmd+ '),AAG00902.aaCodeSequence  from ##Rows , AAG00902 where ##Rows.Lvl > ='+ str(@aaMinOrder) + ' and  AAG00902.aaBudgetTreeID = '+ str(@aaBudgetTreeID) + '   and dbo.aaMLGetCodeString(' +@aaColumnCmd+ ') = AAG00902.aaLvlCodeString  union all  select rowOrder,''0'',0 from ##Rows where lvl < '+ str(@aaMinOrder) + ' order by rowOrder '  exec (@aaCmd )  exec('delete from ##Rows where rowOrder not in(select rowOrder from ##RowFilter ) ')  exec('delete from ##RowImport where rowOrder not in(select rowOrder from ##RowFilter )')   exec('declare CPB cursor fast_forward for select aaPageBreak from ##Col where aaColumn = 118')  open CPB  fetch next from CPB into @PageBreak  close CPB  deallocate CPB  if @PageBreak = 1  begin  exec('declare CPB cursor fast_forward for select max(aaCodeSequence) from ##RowFilter')  open CPB  fetch next from CPB into @MaxCodeSeq  close CPB  deallocate CPB  exec('update ##RowImport set pageBreak = 1 where rowOrder in   (select rowOrder  from ##RowFilter where aaCodeSequence = ' +@MaxCodeSeq +')')  end  set nocount off end    
GO
GRANT EXECUTE ON  [dbo].[aagMQWBudgetTreeFilter] TO [DYNGRP]
GO
