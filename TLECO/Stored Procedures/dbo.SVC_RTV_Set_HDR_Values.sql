SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 Create Procedure [dbo].[SVC_RTV_Set_HDR_Values] (@RTV char(15)) as declare @EntryStatus char(3),  @ReadyToShipStatus char(3),  @ShippedStatus char(3),  @ReceivedStatus char(3),  @PartialReceivedStatus char(3),  @PartialShippedStatus char(3),  @ClosedStatus char(3),  @HeaderStatus char(3),  @RTVStatus int,  @RTVHeaderStatus int,  @EntryDate datetime,  @EntryTime datetime,  @PromisDate datetime,  @PromisTime datetime,  @ClosedDate datetime,  @ClosedTime datetime,  @ShippedDate datetime,  @ShippedTime datetime,  @ReturnDate datetime,  @ReturnTime datetime,  @Received tinyint,  @RecType smallint,  @PCost numeric (19,5),  @PPrice numeric (19,5),  @LCost numeric (19,5),  @LPrice numeric (19,5),  @TCost numeric (19,5),  @TPrice numeric (19,5),  @ECost numeric (19,5),  @EPrice numeric (19,5),  @OrigPCost numeric (19,5),  @OrigPPrice numeric (19,5),  @OrigLCost numeric (19,5),  @OrigLPrice numeric (19,5),  @OrigTCost numeric (19,5),  @OrigTPrice numeric (19,5),  @OrigECost numeric (19,5),  @OrigEPrice numeric (19,5),  @MinDate datetime  exec smGetMinDate @MinDate output  select @EntryStatus = SVC05003.RTV_Return_Status, @ReceivedStatus = SVC05003.RTV_Received_Status,   @ShippedStatus = RTV_Shipping_Status, @PartialShippedStatus = SVC_Partial_Shipped_Stat,  @PartialReceivedStatus = SVC05003.SVC_Partial_Received_Sta,  @ReadyToShipStatus = SVC_Ready_To_Ship_Status, @ClosedStatus = RTV_Closed_Status,  @HeaderStatus = SVC05600.RTV_Return_Status, @RTVHeaderStatus = RTV_Status  from SVC05003 left join SVC05600 on  SVC05600.RTV_Type = SVC05003.RTV_Type where SVC05600.RTV_Number = @RTV if @PartialReceivedStatus = '' or @PartialReceivedStatus is null  select @PartialReceivedStatus = @ReceivedStatus if @PartialShippedStatus = '' or @PartialShippedStatus is null  select @PartialShippedStatus = @ShippedStatus  if not exists(select * from SVC05601 where RTV_Number = @RTV)  begin  update SVC05600 with (rowlock)   set  RTV_Return_Status = @EntryStatus, RTV_Status = 1,   Originating_Travel_Price = 0,Originating_Travel_Cost = 0,  Originating_ExpensePrice = 0, Originating_Expense_Cost = 0,  Originating_Labor_Price = 0,Originating_Labor_Cost = 0,  Originating_Part_Price = 0, Originating_Part_Cost = 0,  Travel_Price = 0,Travel_Cost = 0,  Expense_Price = 0, Expense_Cost = 0,  Labor_Price = 0,Labor_Cost = 0,  Part_Price = 0, Part_Cost = 0  where RTV_Number = @RTV  return  end select @RTVStatus = min(RTV_Status) from SVC05601 where RTV_Number = @RTV if @RTVStatus = 6  select @HeaderStatus = @ClosedStatus, @RTVHeaderStatus = 6 else if @RTVStatus = 5  select @HeaderStatus = @ReceivedStatus, @RTVHeaderStatus = 5 else if @RTVStatus = 4  select @HeaderStatus = @PartialReceivedStatus, @RTVHeaderStatus = 4 else if @RTVStatus = 3   begin  if  @RTVHeaderStatus > 3  select @HeaderStatus = @PartialReceivedStatus, @RTVHeaderStatus = 4  else  select @HeaderStatus = @ShippedStatus, @RTVHeaderStatus = 3  if exists(select * from SVC05601 where RTV_Number = @RTV and RTV_Status > 3) and @RTVHeaderStatus = 3  select @HeaderStatus = @PartialReceivedStatus  end else if @RTVStatus = 2  begin  if  @RTVHeaderStatus > 3  select @HeaderStatus = @PartialReceivedStatus, @RTVHeaderStatus = 4  else if  @RTVHeaderStatus = 3  select @HeaderStatus = @PartialShippedStatus, @RTVHeaderStatus = 3  else  select @HeaderStatus = @ReadyToShipStatus, @RTVHeaderStatus = 2  if exists(select * from SVC05601 where RTV_Number = @RTV and RTV_Status > 3) and @RTVHeaderStatus < 4  select @HeaderStatus = @PartialReceivedStatus  else if exists(select * from SVC05601 where RTV_Number = @RTV and RTV_Status= 3) and @RTVHeaderStatus < 3  select @HeaderStatus = @PartialShippedStatus   end else if @RTVStatus = 1  begin  if  @RTVHeaderStatus > 3  select @HeaderStatus = @PartialReceivedStatus, @RTVHeaderStatus = 4  else if  @RTVHeaderStatus = 3  select @HeaderStatus = @PartialShippedStatus, @RTVHeaderStatus = 3  else if  @RTVHeaderStatus = 2  select @HeaderStatus = @ReadyToShipStatus, @RTVHeaderStatus = 2  else  select @HeaderStatus = @EntryStatus, @RTVHeaderStatus = 1  if exists(select * from SVC05601 where RTV_Number = @RTV and RTV_Status > 3) and @RTVHeaderStatus < 4  select @HeaderStatus = @PartialReceivedStatus  else if exists(select * from SVC05601 where RTV_Number = @RTV and RTV_Status= 3) and @RTVHeaderStatus < 3  select @HeaderStatus = @PartialShippedStatus  end  select @PromisDate = max(PRMDATE), @PromisTime = max(Promised_Time),   @ShippedDate= max(Shipped_Date), @ShippedTime = max(Shipped_Time),  @ReturnDate = max(receiptdate), @ReturnTime = max(Receipt_Time),  @ClosedDate = max(COMPDTE), @ClosedTime = max(COMPTME) ,  @PPrice = isnull(sum(Part_Price),0),  @PCost = isnull(sum(Part_Cost),0),  @LPrice = isnull(sum(Labor_Price),0),  @LCost = isnull(sum(Labor_Cost),0),  @EPrice = isnull(sum(Expense_Price),0),  @ECost = isnull(sum(Expense_Cost),0),  @TPrice = isnull(sum(Travel_Price),0),  @TCost = isnull(sum(Travel_Cost),0),  @OrigPPrice = isnull(sum(Originating_Part_Price),0),  @OrigPCost = isnull(sum(Originating_Part_Cost),0),  @OrigLPrice = isnull(sum(Originating_Labor_Price),0),  @OrigLCost = isnull(sum(Originating_Labor_Cost),0),  @OrigEPrice = isnull(sum(Originating_ExpensePrice),0),  @OrigECost = isnull(sum(Originating_Expense_Cost),0),  @OrigTPrice = isnull(sum(Originating_Travel_Price),0),  @OrigTCost = isnull(sum(Originating_Travel_Cost),0)  from SVC05601 where RTV_Number = @RTV update SVC05600 with (rowlock)   set  RTV_Return_Status = @HeaderStatus, RTV_Status = isnull(@RTVHeaderStatus,1),   PRMDATE = isnull(@PromisDate,@MinDate), Promised_Time = isnull(@PromisTime,@MinDate),  Shipped_Date = isnull(@ShippedDate,@MinDate), Shipped_Time = isnull(@ShippedTime,@MinDate),  receiptdate = isnull(@ReturnDate, @MinDate), Receipt_Time = isnull(@ReturnTime, @MinDate),  COMPDTE = isnull(@ClosedDate, @MinDate), COMPTME = isnull(@ClosedTime, @MinDate),  Originating_Travel_Price = @OrigTPrice,Originating_Travel_Cost = @OrigTCost,  Originating_ExpensePrice = @OrigEPrice, Originating_Expense_Cost = @OrigECost,  Originating_Labor_Price = @OrigLPrice,Originating_Labor_Cost = @OrigLCost,  Originating_Part_Price = @OrigPPrice, Originating_Part_Cost = @OrigPCost,  Travel_Price = @TPrice,Travel_Cost = @TCost,  Expense_Price = @EPrice, Expense_Cost = @ECost,  Labor_Price = @LPrice,Labor_Cost = @LCost,  Part_Price = @PPrice, Part_Cost = @PCost  where RTV_Number = @RTV return    
GO
GRANT EXECUTE ON  [dbo].[SVC_RTV_Set_HDR_Values] TO [DYNGRP]
GO
