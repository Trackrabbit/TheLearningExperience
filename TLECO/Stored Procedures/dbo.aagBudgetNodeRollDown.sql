SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aagBudgetNodeRollDown]  (  @Type INTEGER ,   @Parts FLOAT  )  AS BEGIN  DECLARE @aaCodeSequence INTEGER ,  @Percentage FLOAT ,  @nCount INTEGER ,   @Result INTEGER ,  @aaTempCode INTEGER ,   @USERID CHAR(15),  @WINTYPE INTEGER ,  @CMPANYID  INTEGER ,  @PercentTotal FLOAT ,  @aaActualPriliminary INTEGER ,  @aaAmtQty INTEGER ,  @aaBudgetID INTEGER  SELECT @USERID  = SYSTEM_USER  SELECT @WINTYPE = 1   SELECT @CMPANYID = dbo.aagGetCompanyID()  SET TRANSACTION ISOLATION LEVEL READ COMMITTED  BEGIN TRANSACTION   SELECT @PercentTotal = SUM(Percentage) FROM #temp_aaCodeSequence  IF @Type <> 1  SET @PercentTotal =100.00  SELECT @aaBudgetID = aaBudgetID, @aaTempCode = aaCodeSequence, @aaActualPriliminary = aaActualPriliminary, @aaAmtQty = aaAmtQty FROM AAG00906   WHERE USERID = @USERID AND   WINTYPE = @WINTYPE AND CMPANYID = @CMPANYID  if @aaAmtQty = 0   Update AAG00904 set Balance = 0 where aaBudgetID = @aaBudgetID and aaCodeSequence in (select aaCodeSequence from #temp_aaCodeSequence)  else  Update AAG00904 set QUANTITY = 0 where aaBudgetID = @aaBudgetID and aaCodeSequence in (select aaCodeSequence from #temp_aaCodeSequence)  WHILE ( 1 = 1 )  BEGIN  SELECT @nCount = COUNT (*) FROM #temp_aaCodeSequence  IF @nCount <= 0  BREAK  SELECT top 1 @aaCodeSequence = aaCodeSequence, @Percentage = Percentage from #temp_aaCodeSequence order by aaCodeSequence  UPDATE AAG00906 SET aaCodeSequence = @aaCodeSequence WHERE USERID = @USERID   AND WINTYPE = @WINTYPE AND CMPANYID = @CMPANYID  EXEC aagBudgetNodeRollDownOne @USERID, @WINTYPE, @CMPANYID, @aaCodeSequence,   @Percentage, @Type, @Parts, @PercentTotal, @Result OUTPUT  DELETE FROM #temp_aaCodeSequence WHERE aaCodeSequence = @aaCodeSequence   END   IF @Result < 0  BEGIN  ROLLBACK TRANSACTION   DROP TABLE #temp_aaCodeSequence  SELECT @Result  RETURN  END  UPDATE AAG00906 SET aaCodeSequence = @aaTempCode WHERE USERID = @USERID AND   WINTYPE = @WINTYPE  COMMIT TRANSACTION  DROP TABLE #temp_aaCodeSequence  SELECT @Result  RETURN  END    
GO
GRANT EXECUTE ON  [dbo].[aagBudgetNodeRollDown] TO [DYNGRP]
GO
