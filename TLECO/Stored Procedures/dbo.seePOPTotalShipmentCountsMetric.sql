SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[seePOPTotalShipmentCountsMetric]  @I_dUserDate datetime = NULL,  @I_iNumOfMonths int   = NULL,  @Vendor varchar(max) as  declare @dtStart datetime,   @dtEnd datetime,  @month int,  @iterator int declare @ValuesTable table (Value nvarchar(500))  insert into @ValuesTable select * from dbo.seeSplitString(@Vendor, ',')  select  @I_dUserDate = DATEADD(HOUR, -DATEPART(HOUR, @I_dUserDate), @I_dUserDate) select  @I_dUserDate = DATEADD(MINUTE, -DATEPART(MINUTE, @I_dUserDate), @I_dUserDate) select  @I_dUserDate = DATEADD(SECOND, -DATEPART(SECOND, @I_dUserDate), @I_dUserDate) select  @I_dUserDate = DATEADD(MILLISECOND, -DATEPART(MILLISECOND, @I_dUserDate), @I_dUserDate)  select  @dtEnd = DATEADD(day, -DAY(@I_dUserDate), @I_dUserDate) select  @dtStart = DATEADD(month, -@I_iNumOfMonths, DATEADD(day, -DAY(@I_dUserDate)+1, @I_dUserDate))  create table #TotalShipmentCounts (PromiseDateNumber int not null,   MonthDate       datetime not null,  Filter char(15)) if @Vendor = '' begin  select @iterator = @I_iNumOfMonths  while (@iterator >= 1)  begin  insert #TotalShipmentCounts values(  0,DATEADD(month, -@iterator, DATEADD(day, -day(@I_dUserDate)+1, @I_dUserDate)), '')  select @iterator = @iterator - 1  end    insert into #TotalShipmentCounts  (PromiseDateNumber,  MonthDate,  Filter )  select  count(PRMSHPDTE) AS PromiseDateNumber,  DATEADD(DAY, -DAY(PRMSHPDTE)+1, PRMSHPDTE) as MonthDate,  '' as Filter  from  dbo.POP10110 with (NOLOCK)  where  PRMSHPDTE < LSTRCPTDT and  (PRMSHPDTE between @dtStart and @dtEnd)  group by  PRMSHPDTE  union all   select  count(PRMSHPDTE) AS PromiseDateNumber,  DATEADD(DAY, -DAY(PRMSHPDTE)+1, PRMSHPDTE) as MonthDate,  '' as Filter  from  dbo.POP30110 with (NOLOCK)  where  PRMSHPDTE < LSTRCPTDT and  (PRMSHPDTE between @dtStart and @dtEnd)  group by  PRMSHPDTE end else begin  select @iterator = @I_iNumOfMonths  while (@iterator >= 1)  begin  insert #TotalShipmentCounts   select  0,DATEADD(month, -@iterator, DATEADD(day, -day(@I_dUserDate)+1, @I_dUserDate)), VendorList.Value  from  @ValuesTable VendorList  select @iterator = @iterator - 1  end    insert into #TotalShipmentCounts  (PromiseDateNumber,  MonthDate,  Filter)  select  count(PRMSHPDTE) AS PromiseDateNumber,  DATEADD(DAY, -DAY(PRMSHPDTE)+1, PRMSHPDTE) as MonthDate,  VENDORID as Filter  from  dbo.POP10110 with (NOLOCK),  @ValuesTable VendorList   where  VendorList.Value = POP10110.VENDORID and  PRMSHPDTE < LSTRCPTDT and  (PRMSHPDTE between @dtStart and @dtEnd)  group by  PRMSHPDTE,  VENDORID  union all   select  count(PRMSHPDTE) AS PromiseDateNumber,  DATEADD(DAY, -DAY(PRMSHPDTE)+1, PRMSHPDTE) as MonthDate,  VENDORID as Filter  from  dbo.POP30110 with (NOLOCK),  @ValuesTable VendorList   where  VendorList.Value = POP30110.VENDORID and  PRMSHPDTE < LSTRCPTDT and  (PRMSHPDTE between @dtStart and @dtEnd)  group by  PRMSHPDTE, VENDORID end  select SUM(PromiseDateNumber) as PromiseDateNumber, MonthDate, Filter  from #TotalShipmentCounts with (NOLOCK)  group by MonthDate, Filter order by MonthDate drop table #TotalShipmentCounts    
GO
GRANT EXECUTE ON  [dbo].[seePOPTotalShipmentCountsMetric] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[seePOPTotalShipmentCountsMetric] TO [rpt_accounting manager]
GO
GRANT EXECUTE ON  [dbo].[seePOPTotalShipmentCountsMetric] TO [rpt_accounts payable coordinator]
GO
GRANT EXECUTE ON  [dbo].[seePOPTotalShipmentCountsMetric] TO [rpt_executive]
GO
GRANT EXECUTE ON  [dbo].[seePOPTotalShipmentCountsMetric] TO [rpt_power user]
GO
