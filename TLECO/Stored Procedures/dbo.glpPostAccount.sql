SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[glpPostAccount]  @I_iSQLSessionID                int             = NULL,  @I_sTransactionType             smallint        = NULL,   @I_iJournalEntry                int             = NULL,  @I_cBatchSource                 char(15)        = NULL,   @I_cBatchNumber                 char(15)        = NULL,   @I_cUserID                      char(15)        = NULL,   @I_sSeries                      smallint        = NULL,   @I_iAccountIndex                int             = NULL,  @I_sAccountType                 smallint        = NULL,  @I_sFixedOrVariable             smallint        = NULL,  @I_mDebit                       numeric(19,5)   = NULL,  @I_mCredit                      numeric(19,5)   = NULL,  @I_cAuditTrailCode              char(13)        = NULL,  @I_mSequenceLine                numeric(19,5)   = NULL,  @I_dTransactionDate             datetime        = NULL,  @I_sTransactionPeriodID         smallint        = NULL,  @I_nLedgerID int  = NULL,  @I_sTransactionYear             smallint        = NULL,  @I_sTransactionClosingYear      smallint        = NULL,  @I_tTransactionHistory          tinyint         = NULL,  @I_cDescription                 char(30)        = NULL,  @I_tPrintDistributions          tinyint         = NULL,  @I_tReversing                   tinyint         = NULL,  @I_tPrinting                    tinyint         = NULL,  @I_tPosting                     tinyint         = NULL,   @I_tOffsetAccount               tinyint         = NULL,  @I_tRealTimeQuick               tinyint         = NULL,  @I_sQuickOffset                 smallint        = NULL,  @I_mRecurringTRXSequence        numeric(19,5)   = NULL,  @I_mExchangeRate                numeric(15,7)   = NULL,  @I_sBalanceForCalculation       smallint        = NULL,  @I_sPostingType                 smallint        = NULL,  @I_cFuncCurrencyID              char(15)        = NULL,   @I_sFuncCurrencyIndex           smallint        = NULL,  @I_sFuncDecimalPlaces           smallint        = NULL,  @I_tMCRegistered                tinyint         = NULL,  @I_tMCReport                    tinyint         = NULL,  @I_sMCTransaction               tinyint         = NULL,  @I_mOrigDebit                   numeric(19,5)   = NULL,  @I_mOrigCredit                  numeric(19,5)   = NULL,  @I_cOrigCurrencyID              char(15)        = NULL,  @I_sOrigCurrencyIndex           smallint        = NULL,  @I_sOrigDecimalPlaces           smallint        = NULL,  @I_cIntercompanyID char(5)  = NULL,  @I_tICTransaction tinyint  = NULL,  @I_cOriginatingDocNumber char(21) = NULL,  @I_cOriginatingControlNumber char(21) = NULL,  @I_cOriginatingMasterID char(31) = NULL,  @I_cOriginatingMasterName char(65) = NULL,  @I_sOriginatingTrxType smallint = NULL,  @I_cOriginatingTRXDesc char(30) = NULL,  @I_sOrigDTASeries smallint = NULL,  @I_iOrigSequenceNumber int  = NULL,  @I_sDTAGLStatus smallint = NULL,  @I_nDTAIndex numeric(19,5) = NULL,  @I_nDenomExchangeRate numeric(15,7) = NULL,  @I_sMCTrxState smallint = NULL,  @I_dDocumentDate datetime = NULL,  @I_iClearingAccountIndex        int             = NULL,  @I_iPostingNumber int  = NULL,  @I_iPeriodPostingNumber int  = NULL,  @I_iPostingNumberHist int  = NULL,  @I_iPeriodPostingNumberHist int  = NULL,  @I_cCorrespondingUnit char(5)  = NULL,  @IO_bLineMessages               binary(4)       = NULL  output,  @IO_bLineMessages2              binary(4)       = NULL  output,  @O_iErrorState                  int             = NULL  output as  declare  @TRUE                           tinyint,  @FALSE                          tinyint,  @POST_ACCT                      smallint,  @UNIT_ACCT                      smallint,  @POST_ALLOC_ACCT                smallint,  @UNIT_ALLOC_ACCT                smallint,  @FIXED                          smallint,  @VARIABLE smallint,  @CURRENT_YEAR                   smallint,  @ALLOCATION                     smallint,  @BUSINESS_FORM smallint,  @CLEARING_TRX smallint,  @tDistributionsExist tinyint,  @mExchangeRate                  numeric(15,7),  @cExchangeTableID               char(15),  @sRateCalculationMethod smallint,  @cRateTypeID                    char(15),  @tTransaction                   tinyint,   @iError                         int,  @iStatus                        int,  @tLoop                          tinyint,  @bRetainEarnMessages binary(4),  @bRetainEarnMessages2 binary(4)  select   @O_iErrorState = 0,  @iStatus       = 0  if @@trancount = 0 begin  select @tTransaction = 1  begin transaction end   while (@tLoop is NULL) begin  select @tLoop = 1   if      @I_iSQLSessionID                is NULL or  @I_sTransactionType             is NULL or   @I_iJournalEntry                is NULL or   @I_cBatchSource                 is NULL or   @I_cBatchNumber                 is NULL or  @I_cUserID                      is NULL or   @I_sSeries                      is NULL or   @I_iAccountIndex                is NULL or  @I_sAccountType                 is NULL or  @I_sFixedOrVariable             is NULL or  @I_mDebit                       is NULL or  @I_mCredit                      is NULL or  @I_cAuditTrailCode              is NULL or  @I_mSequenceLine                is NULL or  @I_dTransactionDate             is NULL or  @I_sTransactionPeriodID         is NULL or  @I_nLedgerID is NULL or  @I_sTransactionYear             is NULL or  @I_sTransactionClosingYear      is NULL or  @I_tTransactionHistory          is NULL or  @I_cDescription                 is NULL or  @I_tPrintDistributions          is NULL or  @I_tReversing                   is NULL or  @I_tPrinting                    is NULL or  @I_tPosting                     is NULL or  @I_tOffsetAccount               is NULL or  @I_tRealTimeQuick               is NULL or  @I_sQuickOffset                 is NULL or  @I_mRecurringTRXSequence        is NULL or  @I_mExchangeRate                is NULL or  @I_sBalanceForCalculation       is NULL or  @I_sPostingType                 is NULL or  @I_cFuncCurrencyID              is NULL or  @I_sFuncCurrencyIndex           is NULL or  @I_sFuncDecimalPlaces           is NULL or  @I_tMCRegistered                is NULL or  @I_tMCReport                    is NULL or  @I_sMCTransaction               is NULL or  @I_mOrigDebit                   is NULL or  @I_mOrigCredit                  is NULL or  @I_cOrigCurrencyID              is NULL or  @I_sOrigCurrencyIndex           is NULL or  @I_sOrigDecimalPlaces           is NULL or   @I_cIntercompanyID is NULL or  @I_tICTransaction is NULL or  @I_cOriginatingDocNumber is NULL or  @I_cOriginatingControlNumber is NULL or  @I_cOriginatingMasterID is NULL or  @I_cOriginatingMasterName is NULL or  @I_sOriginatingTrxType is NULL or  @I_cOriginatingTRXDesc is NULL or  @I_sOrigDTASeries is NULL or  @I_iOrigSequenceNumber is NULL or  @I_sDTAGLStatus is NULL or  @I_nDTAIndex is NULL or  @I_nDenomExchangeRate is NULL or  @I_sMCTrxState is NULL or  @I_dDocumentDate is NULL or  @I_iClearingAccountIndex        is NULL or   @I_iPostingNumber is NULL or  @I_iPeriodPostingNumber is NULL or  @I_iPostingNumberHist is NULL or  @I_iPeriodPostingNumberHist is NULL or  @IO_bLineMessages               is NULL or  @IO_bLineMessages2              is NULL or  @I_cCorrespondingUnit is NULL   begin  select @O_iErrorState = 20052  break  end    select  @TRUE                   = 1,  @FALSE                  = 0,  @POST_ACCT              = 1,  @UNIT_ACCT              = 2,  @POST_ALLOC_ACCT        = 3,  @UNIT_ALLOC_ACCT        = 4,  @FIXED                  = 1,  @VARIABLE  = 2,  @CURRENT_YEAR           = 1,  @ALLOCATION             = 1,  @BUSINESS_FORM  = 5,  @CLEARING_TRX  = 2   select  @cExchangeTableID = ' ',  @sRateCalculationMethod = 0,  @cRateTypeID  = ' ',  @mExchangeRate   = 0.0,  @bRetainEarnMessages = 0x00000000,  @bRetainEarnMessages2 = 0x00000000   if (@I_mOrigDebit = 0.0 and @I_mOrigCredit = 0.0 and  @I_mDebit = 0.0 and @I_mCredit = 0.0) or  @I_sTransactionType = @BUSINESS_FORM or  @I_cFuncCurrencyID = @I_cOrigCurrencyID  begin  select @mExchangeRate = 0.0   if @I_sTransactionType = @BUSINESS_FORM  select @I_sOrigCurrencyIndex = 0  end  else if @I_sTransactionType = @CLEARING_TRX  select @mExchangeRate = round ((@I_mDebit - @I_mCredit)/(@I_mOrigDebit - @I_mOrigCredit), 7)  else   select @mExchangeRate = @I_mExchangeRate   if  @I_sAccountType = @POST_ACCT or  @I_sAccountType = @UNIT_ACCT  begin  if @I_tTransactionHistory = @FALSE and  @I_tPosting = @TRUE  begin  exec @iStatus = glpPostToCurrentYear  @I_iSQLSessionID,  @I_sTransactionType,  @I_iJournalEntry,  @I_cUserID,  @I_iAccountIndex,  @I_sAccountType,  @I_mDebit,  @I_mCredit,  @I_tOffsetAccount,  @I_sQuickOffset,  @I_cAuditTrailCode,   @I_sTransactionYear,  @I_sTransactionPeriodID,  @I_nLedgerID,  @CURRENT_YEAR,  @I_dTransactionDate,      @I_cDescription,  @I_mRecurringTRXSequence,  @mExchangeRate,  @cExchangeTableID,  @I_cFuncCurrencyID,  @I_sFuncCurrencyIndex,  @I_tMCRegistered,  @I_sMCTransaction,  @I_mOrigDebit,  @I_mOrigCredit,  @I_cOrigCurrencyID,  @I_sOrigCurrencyIndex,  @sRateCalculationMethod,  @cRateTypeID,  @I_cOriginatingDocNumber,  @I_cOriginatingControlNumber,  @I_cOriginatingMasterID,  @I_cOriginatingMasterName,  @I_sOriginatingTrxType,  @I_cOriginatingTRXDesc,  @I_sOrigDTASeries,  @I_iOrigSequenceNumber,  @I_mSequenceLine,  @I_sDTAGLStatus,  @I_nDTAIndex,  @I_nDenomExchangeRate,  @I_sMCTrxState,   @I_dDocumentDate,  @I_iPostingNumber,  @I_iPeriodPostingNumber,  @I_cCorrespondingUnit,  @O_iErrorState output  select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   end     else if @I_tTransactionHistory = @TRUE  begin  exec @iStatus = glpPostToHistoryYear  @I_iSQLSessionID,  @I_sTransactionType,   @I_iJournalEntry,   @I_cBatchSource,   @I_cBatchNumber,                  @I_cUserID,   @I_sSeries,   @I_iAccountIndex,  @I_sAccountType,  @I_sPostingType,  @I_mDebit,  @I_mCredit,  @I_cAuditTrailCode,  @I_dTransactionDate,  @I_sTransactionYear,  @I_sTransactionClosingYear,  @I_sTransactionPeriodID,  @I_nLedgerID,  @I_cDescription,  @I_tPrintDistributions,  @I_tReversing,  @I_tPrinting,   @I_tPosting,  @I_tRealTimeQuick,   @I_sQuickOffset,  @I_tOffsetAccount,  @TRUE,                            @I_mSequenceLine,  @I_mRecurringTRXSequence,  @mExchangeRate,  @I_cFuncCurrencyID,  @I_sFuncCurrencyIndex,  @I_sFuncDecimalPlaces,  @I_tMCRegistered,   @I_sMCTransaction,  @I_mOrigDebit,  @I_mOrigCredit,  @I_cOrigCurrencyID,  @I_sOrigCurrencyIndex,  @I_sOrigDecimalPlaces,  @I_cIntercompanyID,  @I_tICTransaction,  @I_cOriginatingDocNumber,  @I_cOriginatingControlNumber,  @I_cOriginatingMasterID,  @I_cOriginatingMasterName,  @I_sOriginatingTrxType,  @I_cOriginatingTRXDesc,  @I_sOrigDTASeries,  @I_iOrigSequenceNumber,  @I_sDTAGLStatus,  @I_nDTAIndex,  @I_nDenomExchangeRate,  @I_sMCTrxState,  @I_dDocumentDate,  @I_iPostingNumber,  @I_iPeriodPostingNumber,  @I_iPostingNumberHist,  @I_iPeriodPostingNumberHist,  @I_cCorrespondingUnit,  @IO_bLineMessages       output,  @IO_bLineMessages2      output,  @bRetainEarnMessages output,  @bRetainEarnMessages2 output,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   end    end    else if  @I_sAccountType = @POST_ALLOC_ACCT or  @I_sAccountType = @UNIT_ALLOC_ACCT  begin   if @I_sFixedOrVariable = @FIXED  begin  exec @iStatus = glpPostFixedAllocations  @I_iSQLSessionID,  @I_sTransactionType,   @I_iJournalEntry,   @I_cBatchSource,   @I_cBatchNumber,                  @I_cUserID,   @I_sSeries,   @I_iAccountIndex,  @I_mDebit,  @I_mCredit,  @I_cAuditTrailCode,  @I_dTransactionDate,  @I_sTransactionYear,  @I_sTransactionClosingYear,  @I_sTransactionPeriodID,  @I_nLedgerID,  @I_cDescription,  @I_tPrintDistributions,  @I_tReversing,  @I_tPrinting,   @I_tPosting,   @I_tRealTimeQuick,   @I_sQuickOffset,  @ALLOCATION,  @I_tTransactionHistory,   @I_tOffsetAccount,   @I_mSequenceLine,  @I_mRecurringTRXSequence,  @mExchangeRate,  @cExchangeTableID,  @I_cFuncCurrencyID,  @I_sFuncCurrencyIndex,  @I_sFuncDecimalPlaces,  @I_tMCRegistered,  @I_sMCTransaction,  @I_mOrigDebit,  @I_mOrigCredit,  @I_cOrigCurrencyID,  @I_sOrigCurrencyIndex,  @I_sOrigDecimalPlaces,  @sRateCalculationMethod,  @cRateTypeID,  @I_cIntercompanyID,  @I_tICTransaction,  @I_cOriginatingDocNumber,  @I_cOriginatingControlNumber,  @I_cOriginatingMasterID,  @I_cOriginatingMasterName,  @I_sOriginatingTrxType,  @I_cOriginatingTRXDesc,  @I_sOrigDTASeries,  @I_iOrigSequenceNumber,  @I_sDTAGLStatus,  @I_nDTAIndex,  @I_nDenomExchangeRate,  @I_sMCTrxState,  @I_dDocumentDate,  @I_iPostingNumber,  @I_iPeriodPostingNumber,  @I_iPostingNumberHist,  @I_iPeriodPostingNumberHist,  @I_cCorrespondingUnit,  @IO_bLineMessages output,  @IO_bLineMessages2 output,  @bRetainEarnMessages output,  @bRetainEarnMessages2 output,  @tDistributionsExist    output,  @O_iErrorState          output  select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if @I_tPrinting = @TRUE and  @tDistributionsExist = @FALSE  select @I_tPrintDistributions = @FALSE   delete   #Distributions   where   SQLSessionID = @I_iSQLSessionID  and     AllocationIndex = @I_iAccountIndex  and AllocationType = @ALLOCATION   end   else if @I_sFixedOrVariable = @VARIABLE  begin  exec @iStatus = glpPostVariableAllocations  @I_iSQLSessionID,  @I_sTransactionType,   @I_iJournalEntry,   @I_cBatchSource,   @I_cBatchNumber,                  @I_cUserID,   @I_sSeries,   @I_iAccountIndex,  @I_mDebit,  @I_mCredit,  @I_cAuditTrailCode,  @I_dTransactionDate,  @I_sTransactionYear,  @I_sTransactionPeriodID,  @I_nLedgerID,  @I_cDescription,  @I_tPrintDistributions,  @I_tReversing,  @I_tPrinting,   @I_tPosting,   @I_tRealTimeQuick,   @I_sQuickOffset,  @I_tTransactionHistory,   @I_tOffsetAccount,   @I_mSequenceLine,  @I_mRecurringTRXSequence,  @I_sBalanceForCalculation,  @mExchangeRate,  @cExchangeTableID,  @I_cFuncCurrencyID,  @I_sFuncCurrencyIndex,  @I_sFuncDecimalPlaces,  @I_tMCRegistered,  @I_sMCTransaction,  @I_mOrigDebit,  @I_mOrigCredit,  @I_cOrigCurrencyID,  @I_sOrigCurrencyIndex,  @I_sOrigDecimalPlaces,  @sRateCalculationMethod,  @cRateTypeID,  @I_cIntercompanyID,  @I_tICTransaction,  @I_cOriginatingDocNumber,  @I_cOriginatingControlNumber,  @I_cOriginatingMasterID,  @I_cOriginatingMasterName,  @I_sOriginatingTrxType,  @I_cOriginatingTRXDesc,  @I_sOrigDTASeries,  @I_iOrigSequenceNumber,  @I_sDTAGLStatus,  @I_nDTAIndex,  @I_nDenomExchangeRate,  @I_sMCTrxState,  @I_dDocumentDate,  @I_iClearingAccountIndex,  @I_iPostingNumber,  @I_iPeriodPostingNumber,  @I_iPostingNumberHist,  @I_iPeriodPostingNumberHist,  @I_cCorrespondingUnit,  @IO_bLineMessages       output,  @IO_bLineMessages2      output,  @bRetainEarnMessages output,  @bRetainEarnMessages2 output,  @tDistributionsExist    output,  @O_iErrorState          output  select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if @I_tPrinting = @TRUE and  @tDistributionsExist = @FALSE  select @I_tPrintDistributions = @FALSE   delete   #Distributions   where   SQLSessionID = @I_iSQLSessionID  and     AllocationIndex = @I_iAccountIndex  and AllocationType = @ALLOCATION   delete   #Breakdowns   where   SQLSessionID = @I_iSQLSessionID  and     AllocationIndex = @I_iAccountIndex  and AllocationType = @ALLOCATION   end   else  begin  select @O_iErrorState = 20813  break  end  end  else  begin  select @O_iErrorState = 20483  break  end    if @iStatus <> 0 or @O_iErrorState <> 0   break   if @I_tPrinting = @TRUE and   (@I_sAccountType = @POST_ACCT or  @I_sAccountType = @UNIT_ACCT or   @I_tPrintDistributions = @FALSE)  begin  exec @iStatus = glpUpdateAllocationRegister  @I_sTransactionType,  @I_iJournalEntry,  @I_cBatchSource,  @I_cBatchNumber,  @I_cUserID,  @I_tRealTimeQuick,                @I_iAccountIndex,                 @I_sAccountType,  @I_mDebit,   @I_mCredit,   @I_dTransactionDate,  @I_mSequenceLine,                 @I_cDescription,                  @I_tOffsetAccount,                 @I_tTransactionHistory,    @I_tReversing,  @IO_bLineMessages,  @I_cFuncCurrencyID,  @I_sFuncCurrencyIndex,  @IO_bLineMessages2,  @I_mOrigDebit,  @I_mOrigCredit,  @I_cOrigCurrencyID,  @I_sOrigCurrencyIndex,  @I_cIntercompanyID,  @I_tICTransaction,  @I_cOriginatingDocNumber,  @I_cOriginatingControlNumber,  @I_cOriginatingMasterID,  @I_cOriginatingMasterName,  @I_sOriginatingTrxType,  @I_sMCTrxState,   @I_mExchangeRate,  @I_nDenomExchangeRate,   @O_iErrorState  output  select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   end   end   select  @IO_bLineMessages = @IO_bLineMessages | convert(int,@bRetainEarnMessages),   @IO_bLineMessages2 = @IO_bLineMessages2 | convert(int,@bRetainEarnMessages)  if @iStatus <> 0 or @O_iErrorState <> 0 begin  if @tTransaction = 1  rollback transaction end else if @tTransaction = 1  commit transaction  return (@iStatus)   
GO
GRANT EXECUTE ON  [dbo].[glpPostAccount] TO [DYNGRP]
GO
