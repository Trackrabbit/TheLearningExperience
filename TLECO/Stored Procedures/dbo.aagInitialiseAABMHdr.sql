SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[aagInitialiseAABMHdr]  @CB_Trans_Type char(1),  @ORDOCNUM char(21),  @CHEKBKID char(15),   @SERIES smallint,  @CMPANYID smallint,  @aaSubLedgerHdrID int output,  @create tinyint,  @AcctLinked integer output,  @WinOpen integer output,   @DistCnt integer output as begin  declare @DOCTYPE smallint,  @Cnt int,  @CHEKBKID1 char(15),  @CB_Type smallint   select  @DOCTYPE = 0,  @Cnt  = 0,  @CB_Type = 0   if isnumeric(@CB_Trans_Type)=1   begin   if @SERIES = 0  set @CB_Type = 1  else if @SERIES = 4  set @CB_Type = 2  else if @SERIES = 3  set @CB_Type = 3   select @CB_Trans_Type = dbo.aagBMDocTypeEBM(@ORDOCNUM, @CHEKBKID,@CB_Type)  end  select @DOCTYPE = dbo.aagBMDocType(@CB_Trans_Type,@SERIES)  select @CHEKBKID1 = @CHEKBKID  if @DOCTYPE <> 7   Select @aaSubLedgerHdrID = aaSubLedgerHdrID , @Cnt = count(*)  from AAG20000  where SERIES = 58  and   DOCTYPE = @DOCTYPE and  DOCNUMBR = @ORDOCNUM and  Master_ID = @CHEKBKID1  group by aaSubLedgerHdrID  else if @DOCTYPE = 7   begin  Select @aaSubLedgerHdrID = aaSubLedgerHdrID , @Cnt = count(*)  from AAG20000  where SERIES = 58  and   DOCTYPE = @DOCTYPE and  DOCNUMBR = @ORDOCNUM  group by aaSubLedgerHdrID  set @CHEKBKID1 = space(1)  end  if @Cnt <> 1 and @create = 1  begin  exec DYNAMICS.dbo.aagGetNextID 20000, @CMPANYID,@aaSubLedgerHdrID output    insert into AAG20000  (aaSubLedgerHdrID, SERIES, DOCTYPE, DOCNUMBR, Master_ID, aaHdrErrors)  values (@aaSubLedgerHdrID, 58, @DOCTYPE,@ORDOCNUM,@CHEKBKID1,0)  end   select @AcctLinked = count(*) from AAG20001  where aaSubLedgerHdrID = @aaSubLedgerHdrID and  aaSubLedgerDistID >0 and aaBrowseType in (1,2)   select @DistCnt = count(*) from AAG20001  where aaSubLedgerHdrID = @aaSubLedgerHdrID and  aaSubLedgerDistID >0 if @DOCTYPE <> 7 and @DOCTYPE <> 9  select top 1 @WinOpen = aaWinWasOpen from AAG20001  where aaSubLedgerHdrID = @aaSubLedgerHdrID and aaBrowseType IN (1,2)   order by DEX_ROW_ID desc else  select @WinOpen = count(*) from AAG20001  where aaSubLedgerHdrID = @aaSubLedgerHdrID and  aaSubLedgerDistID >0 and aaWinWasOpen = 1  end    
GO
GRANT EXECUTE ON  [dbo].[aagInitialiseAABMHdr] TO [DYNGRP]
GO
