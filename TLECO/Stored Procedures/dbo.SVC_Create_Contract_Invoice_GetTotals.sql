SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_Create_Contract_Invoice_GetTotals]  ( @CONSTS smallint, @CONTNBR char(11), @LNSEQNBR numeric(19,5), @CHECKDATE datetime, @InvoiceDate datetime, @Invoice_Amount  numeric(19,5) OUTPUT, @OrigInvoice_Amount  numeric(19,5) OUTPUT, @LINECREDIT  numeric(19,5) OUTPUT, @ORIGLINECREDIT  numeric(19,5) OUTPUT, @Invoice_DISCOUNTAMOUNT numeric(19,5) OUTPUT,  @Invoice_ORIGDISCOUNTAMOUNT numeric(19,5) OUTPUT,  @Return_DISCOUNTAMOUNT numeric(19,5) OUTPUT,  @Return_ORIGDISCOUNTAMOUNT numeric(19,5) OUTPUT ) AS  declare @BILLAMOUNT numeric(19,2) declare @DiscountPercent smallint declare @ORIGBILLAMOUNT numeric(19,2) declare @INVOICECOUNT integer declare @I_LineExchangeRate  numeric(15,7),@I_sRateCalcMethod  smallint ,@I_sDecimalPlaces  smallint declare @I_sViewMode   smallint,   @I_nExchangeRate  numeric(15,7),   @I_nDenomExchangeRate numeric(15,7),   @I_sMCTrxState   smallint,   @O_iErrorState  int declare @ORDOCAMT numeric(19,2),  @DOCAMNT numeric(19,2),  @PSTDAMNT numeric(19,2), @OrigPSTDAMNT numeric(19,2),  @SVC_Invoice_Credit_Amoun numeric(19,2),  @OrigInvCreditAmt numeric(19,2),  @ORDDLRAT numeric(19,2),  @DEX_ROW_ID int,  @SVC_Coverage_Start_Date datetime,  @SVC_Coverage_End_Date datetime declare @DSCDLRAM numeric(19,2) declare @603svcReverseType int declare @Return_Amount numeric(19,2), @OrigReturn_Amount numeric(19,2) declare @ExchangeDate datetime, @ExchangeTime datetime declare @LIABILITYTYPE smallint declare @DISCOUNTAMOUNT  numeric(19,5), @ORIGDISCOUNTAMOUNT numeric(19,5) declare @MinDate datetime  exec smGetMinDate @MinDate output   select @Invoice_Amount = 0, @OrigInvoice_Amount = 0, @LINECREDIT = 0, @ORIGLINECREDIT = 0, @DISCOUNTAMOUNT = 0, @ORIGDISCOUNTAMOUNT = 0 select @Invoice_DISCOUNTAMOUNT = 0 ,@Invoice_ORIGDISCOUNTAMOUNT = 0, @Return_DISCOUNTAMOUNT = 0, @Return_ORIGDISCOUNTAMOUNT  = 0  select @I_sViewMode = 4             select  @LIABILITYTYPE = SVC_Liability_Type,@I_nExchangeRate = XCHGRATE,  @ExchangeDate = EXCHDATE, @ExchangeTime = TIME1  from SVC00600 WITH (NOLOCK) where CONSTS = @CONSTS and CONTNBR = @CONTNBR    select   @DiscountPercent = DSCPCTAM,  @I_sRateCalcMethod = RATECALC,   @I_LineExchangeRate = XCHGRATE,  @I_sDecimalPlaces =  DECPLACS,   @I_nDenomExchangeRate = DENXRATE,   @I_sMCTrxState = MCTRXSTT  from SVC00601 WITH (NOLOCK) where  SVC00601.CONSTS = @CONSTS and  SVC00601.CONTNBR = @CONTNBR and  SVC00601.LNSEQNBR = @LNSEQNBR    declare UpdatePostedAmount CURSOR LOCAL FAST_FORWARD for  select DOCAMNT,PSTDAMNT,SVC_Invoice_Credit_Amoun,ORDOCAMT,DEX_ROW_ID,SVC_Coverage_Start_Date,  SVC_Coverage_End_Date,OrigInvCreditAmt,ORDDLRAT, DSCDLRAM, svcReverseType from SVC00603 WITH (NOLOCK) where  SVC00603.CONSTS = @CONSTS and  SVC00603.CONTNBR = @CONTNBR and  SVC00603.LNSEQNBR = @LNSEQNBR and  SVC00603.POSTED = 1   and SVC00603.svcReverseType between -100 and -90    select @BILLAMOUNT = 0, @ORIGBILLAMOUNT = 0, @ORIGDISCOUNTAMOUNT = 0,  @LINECREDIT = 0, @ORIGLINECREDIT = 0, @INVOICECOUNT = 0, @DISCOUNTAMOUNT = 0,  @Invoice_Amount = 0, @OrigInvoice_Amount = 0, @Return_Amount = 0, @OrigReturn_Amount = 0  ,@Invoice_ORIGDISCOUNTAMOUNT = 0, @Invoice_DISCOUNTAMOUNT = 0  ,@Return_ORIGDISCOUNTAMOUNT = 0, @Return_DISCOUNTAMOUNT = 0   open UpdatePostedAmount  fetch next from UpdatePostedAmount into @DOCAMNT,@PSTDAMNT,@SVC_Invoice_Credit_Amoun,@ORDOCAMT,@DEX_ROW_ID,  @SVC_Coverage_Start_Date,@SVC_Coverage_End_Date,@OrigInvCreditAmt,@ORDDLRAT, @DSCDLRAM, @603svcReverseType  WHILE (@@FETCH_status = 0)  BEGIN  select @OrigPSTDAMNT = @ORDOCAMT - @OrigInvCreditAmt - @ORDDLRAT,  @PSTDAMNT = @DOCAMNT -@SVC_Invoice_Credit_Amoun - @DSCDLRAM  if not exists(select * from SVC00604 where CONSTS = @CONSTS and CONTNBR = @CONTNBR)  and @I_LineExchangeRate <> @I_nExchangeRate  begin  exec SVC_Convert_Amount @I_sRateCalcMethod, @I_sViewMode,@I_nExchangeRate,  @I_nDenomExchangeRate,@I_sMCTrxState,@I_sDecimalPlaces,  @OrigPSTDAMNT,@PSTDAMNT OUTPUT, @O_iErrorState OUTPUT  exec SVC_Convert_Amount @I_sRateCalcMethod, @I_sViewMode,@I_nExchangeRate,  @I_nDenomExchangeRate,@I_sMCTrxState,@I_sDecimalPlaces,  @ORDOCAMT,@DOCAMNT OUTPUT, @O_iErrorState OUTPUT  exec SVC_Convert_Amount @I_sRateCalcMethod, @I_sViewMode,@I_nExchangeRate,  @I_nDenomExchangeRate,@I_sMCTrxState,@I_sDecimalPlaces,  @OrigInvCreditAmt,@SVC_Invoice_Credit_Amoun OUTPUT, @O_iErrorState OUTPUT  exec SVC_Convert_Amount @I_sRateCalcMethod, @I_sViewMode,@I_nExchangeRate,  @I_nDenomExchangeRate,@I_sMCTrxState,@I_sDecimalPlaces,  @ORDDLRAT,@DSCDLRAM OUTPUT, @O_iErrorState OUTPUT  end   select @Invoice_Amount = @Invoice_Amount + @DOCAMNT  select @OrigInvoice_Amount = @OrigInvoice_Amount + @ORDOCAMT  select @Return_Amount = @Return_Amount + (@SVC_Invoice_Credit_Amoun)  select @OrigReturn_Amount = @OrigReturn_Amount + (@OrigInvCreditAmt)  select @BILLAMOUNT = @BILLAMOUNT + IsNull(@PSTDAMNT,0)  select @ORIGBILLAMOUNT = @ORIGBILLAMOUNT + IsNull(@OrigPSTDAMNT,0)  select @ORIGDISCOUNTAMOUNT = @ORIGDISCOUNTAMOUNT + IsNull(@ORDDLRAT,0)  select @DISCOUNTAMOUNT = @DISCOUNTAMOUNT + isnull(@DSCDLRAM,0)  select @ORIGLINECREDIT = @ORIGLINECREDIT + IsNull(@OrigInvCreditAmt,0)  select @LINECREDIT = @LINECREDIT + isnull(@SVC_Invoice_Credit_Amoun,0)  select @INVOICECOUNT = @INVOICECOUNT + 1    fetch next from UpdatePostedAmount into @DOCAMNT,@PSTDAMNT,@SVC_Invoice_Credit_Amoun,@ORDOCAMT,@DEX_ROW_ID,  @SVC_Coverage_Start_Date,@SVC_Coverage_End_Date,@OrigInvCreditAmt,@ORDDLRAT, @DSCDLRAM, @603svcReverseType  END  close UpdatePostedAmount  DEALLOCATE UpdatePostedAmount   if not exists(select * from SVC00604 where CONSTS = @CONSTS and CONTNBR = @CONTNBR) and @ORIGDISCOUNTAMOUNT <> @DISCOUNTAMOUNT  exec SVC_Convert_Amount @I_sRateCalcMethod, @I_sViewMode,@I_nExchangeRate,  @I_nDenomExchangeRate,@I_sMCTrxState,@I_sDecimalPlaces,  @ORIGDISCOUNTAMOUNT,@DISCOUNTAMOUNT OUTPUT, @O_iErrorState OUTPUT   select @ORIGLINECREDIT = @OrigReturn_Amount  select @LINECREDIT = @Return_Amount   if @ORIGLINECREDIT <> 0   BEGIN   if not exists(select * from SVC00604 where CONSTS = @CONSTS and CONTNBR = @CONTNBR)  exec SVC_Convert_Amount @I_sRateCalcMethod, @I_sViewMode,@I_nExchangeRate,  @I_nDenomExchangeRate,@I_sMCTrxState,@I_sDecimalPlaces,  @ORIGLINECREDIT,@LINECREDIT OUTPUT, @O_iErrorState OUTPUT  select @DiscountPercent = isnull(@DiscountPercent,0)   select @Return_ORIGDISCOUNTAMOUNT = @ORIGDISCOUNTAMOUNT,  @Return_DISCOUNTAMOUNT = @DISCOUNTAMOUNT  END   if @Invoice_Amount <> 0   BEGIN  select @DiscountPercent = isnull(@DiscountPercent,0)  select @ORIGDISCOUNTAMOUNT = @OrigInvoice_Amount * @DiscountPercent / 10000.0  select @DISCOUNTAMOUNT = @Invoice_Amount * @DiscountPercent / 10000.0  select @Invoice_ORIGDISCOUNTAMOUNT = @ORIGDISCOUNTAMOUNT,  @Invoice_DISCOUNTAMOUNT = @DISCOUNTAMOUNT  END   set @Invoice_Amount  = isnull(@Invoice_Amount ,0)  set @OrigInvoice_Amount  = isnull( @OrigInvoice_Amount ,0)  set @LINECREDIT  = isnull( @LINECREDIT ,0)  set @ORIGLINECREDIT  = isnull( @ORIGLINECREDIT ,0)  set @DISCOUNTAMOUNT  = isnull( @DISCOUNTAMOUNT ,0)  set @ORIGDISCOUNTAMOUNT  = isnull( @ORIGDISCOUNTAMOUNT ,0)  if @InvoiceDate > @MinDate  Begin  select @LINECREDIT = sum(SVC_Invoice_Credit_Amoun), @ORIGLINECREDIT = sum(OrigInvCreditAmt),  @Return_DISCOUNTAMOUNT = sum(DSCDLRAM), @Return_ORIGDISCOUNTAMOUNT = sum(ORDDLRAT)  from SVC00603 where   CONSTS = @CONSTS and CONTNBR = @CONTNBR and LNSEQNBR = @LNSEQNBR and INVODATE = @InvoiceDate and svcReverseType = -91  End  set @LINECREDIT  = @LINECREDIT * -1 set @ORIGLINECREDIT  = @ORIGLINECREDIT * -1 return    
GO
GRANT EXECUTE ON  [dbo].[SVC_Create_Contract_Invoice_GetTotals] TO [DYNGRP]
GO
