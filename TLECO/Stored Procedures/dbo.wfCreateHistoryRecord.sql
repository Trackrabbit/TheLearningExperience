SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[wfCreateHistoryRecord]  @WorkflowInstanceID char(37),  @WorkflowStepInstanceID char(37),  @Workflow_History_User char(85),  @Workflow_Name char(51),  @Workflow_Step_Name char(51),  @Workflow_Step_Assign_To char(37),  @Workflow_Action smallint,  @Workflow_Due_Date datetime,  @Workflow_Due_Time datetime,  @Workflow_Completion_Date datetime,  @Workflow_Completion_Time datetime,  @Workflow_Comments char(2000),  @Workflow_Error int OUTPUT AS  BEGIN   declare @send_email tinyint  declare @WF_SendNotificatications tinyint  declare @EmailMessageID char(25)  declare @Workflow_Originator char(238)  declare @WF_Notification_Action smallint  declare @Workflow_Type_Name char(51)  declare @DocAttachBusObjKey char(200)  declare @Document_ID char(50)  declare @Workflow_Status smallint  declare @Workflow_Managers char(37)  declare @DocumentDrillDown varchar(255)  declare @CMPANYID nvarchar(6)  declare @server_name nvarchar(128)   declare @SystemDB nvarchar(11)  declare @Workflow_Version int  declare @Milliseconds smallint   select @WorkflowInstanceID=UPPER(@WorkflowInstanceID)  select @WorkflowStepInstanceID=UPPER(@WorkflowStepInstanceID)  select @Workflow_Step_Assign_To=UPPER(@Workflow_Step_Assign_To)  select @Workflow_Error=0, @Milliseconds=0   select @Workflow_Due_Time = DATEADD(ms, -DATEPART(ms, @Workflow_Due_Time), @Workflow_Due_Time)  select @Milliseconds=DATEPART(ms, @Workflow_Completion_Time)  select @Workflow_Completion_Time = DATEADD(ms, -DATEPART(ms, @Workflow_Completion_Time), @Workflow_Completion_Time)   select @SystemDB = (select top 1 DBNAME from SY00100)  select @server_name=@@SERVERNAME   select @CMPANYID=DB_NAME()   insert into WF30100  select  @WorkflowInstanceID,  @WorkflowStepInstanceID,  @Workflow_History_User,  @Workflow_Name,  @Workflow_Step_Name,  @Workflow_Step_Assign_To,  @Workflow_Action,  @Workflow_Due_Date,  @Workflow_Due_Time,  @Workflow_Completion_Date,  @Workflow_Completion_Time,  @Milliseconds,  @Workflow_Comments   select @Workflow_Type_Name=Workflow_Type_Name, @WF_SendNotificatications=WF_SendNotificatications,  @Workflow_Status=Workflow_Status, @Workflow_Originator=Workflow_Originator, @Workflow_Version = Workflow_Version  from WFI10002 where WorkflowInstanceID=@WorkflowInstanceID   select @EmailMessageID=EmailMessageID from WF40400 where Workflow_Type_Name=@Workflow_Type_Name   and Workflow_Name=@Workflow_Name and WF_Notification_Action=@Workflow_Action  and WF_Notification_Enabled=1  select @WF_Notification_Action=@Workflow_Action   select @Workflow_Managers=Workflow_Managers from WF100001 where Workflow_Type_Name=@Workflow_Type_Name   if (select top 1 isnull(Enable_Workflow_Email, 0) from WF00100) > 0  begin  if @WF_SendNotificatications>0 and   (@EmailMessageID<>'' and (select count(EmailMessageID)   from SY04901 where EmailMessageID=@EmailMessageID and Email_Message_Type=3)>0)  begin  exec wfGetCompletedEmailInformation   @WorkflowInstanceID,  @DocAttachBusObjKey OUTPUT,  @Document_ID OUTPUT,  @DocumentDrillDown OUTPUT,  @Workflow_Managers OUTPUT,  @Workflow_Originator OUTPUT,  @Workflow_Status OUTPUT,  @Workflow_Error OUTPUT   exec DYNAMICS.dbo.SendWorkflowCompletionEmail   @WorkflowInstanceID,  @WorkflowStepInstanceID,  @EmailMessageID,  @Workflow_Version,  @Workflow_Action,  @Workflow_History_User,   @Workflow_Comments,  @Workflow_Completion_Date,  @Workflow_Completion_Time,  @Workflow_Due_Date,  @Workflow_Due_Time,  @DocAttachBusObjKey,  @DocumentDrillDown,  @Document_ID,   @Workflow_Managers,  @Workflow_Name,  @Workflow_Type_Name,  @Workflow_Originator,  @Workflow_Status,  @Workflow_Step_Name,  @server_name,  @CMPANYID,  @SystemDB,  @Workflow_Error out  end  end END   
GO
GRANT EXECUTE ON  [dbo].[wfCreateHistoryRecord] TO [DYNGRP]
GO
