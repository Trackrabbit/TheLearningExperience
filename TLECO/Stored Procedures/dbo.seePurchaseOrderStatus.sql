SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[seePurchaseOrderStatus]  @SORTBY char(15),       @i_PONUMBER_RS char(17) = '',    @i_PONUMBER_RE char(17) = '',    @i_DOCDATE_RS datetime = '',    @i_DOCDATE_RE datetime = '',    @i_VENDORID_RS char(21) = '',    @i_VENDORID_RE char(21) = '',    @i_VENDNAME_RS char(65) = '',    @i_VENDNAME_RE char(65) = '',    @i_POSTATUS_RS tinyint = 0,     @i_POSTATUS_RE tinyint = 0,     @i_ORIGIN_RS tinyint = 0,     @i_ORIGIN_RE tinyint = 0,     @i_BUYER_RS char(21) = '',     @i_BUYER_RE char(21) = '',     @DETAIL tinyint = 0,      @NEW tinyint = 0,       @CHANGE tinyint = 0,      @RELEASED tinyint = 0,      @RECEIVED tinyint = 0,      @CLOSED tinyint = 0,      @CANCELLED tinyint = 0,      @RECEIPTS tinyint = 0       as  set nocount on  declare  @x int, @POPNUM char (17), @POPNUM_OLD char(17), @ORD int, @a numeric(19,5), @b numeric(19,5), @ex numeric(19,5)  If OBJECT_ID('tempdb..#POPSTATUS') is  NULL  Begin  create table #POPSTATUS (  PONUMBER char(17) not null default '',  POLINE int not null default 0,  POSTATUS tinyint not null default 0,  POTYPE tinyint not null default 0,  DOCDATE datetime not null default '01/01/1900',  VENDORID char(31) not null default 0,  VENDNAME char(65) not null default '',  BUYERID char(21) not null default '',  Workflow_Approval_Status char (25) not null default '',  ITEMNMBR char(31) not null default '',  ITEMDESC char(101) not null default '',  VNDITNUM char(31) not null default '',  LINEORIGIN char(31) not null default '',  ORD int not null default 0,  POLNESTA char(31) not null default '',  LOCNCODE char(11) not null default '',  UofM char(9) not null default '',  QTYORDER numeric(19,5) not null default 0.00,  QTYCANCE numeric(19,5) not null default 0.00,  QTYUNCMTBASE numeric(19,5) not null default 0.00,  QTYRMINV numeric(19,5) not null default 0.00,  UNITCOST numeric(19,5) not null default 0.00,  EXTDCOST numeric(19,5) not null default 0.00,  RMUNTCST numeric(19,5) not null default 0.00,  RPUNTCST numeric(19,5) not null default 0.00,  RPREMCST numeric(19,5) not null default 0.00,  POPRCTNM char(17) not null default '',  DATERECD datetime not null default '01/01/1900',  TRXLOCTN char(11) not null default '',  TRXUofM char(9) not null default '',  QTYSHPPD numeric(19,5) not null default 0.00,  QTYINVCD numeric(19,5) not null default 0.00,  QTYREJ numeric(19,5) not null default 0.00,  MY_DEX_ROW int Identity (1,1) )  End  If @RECEIPTS = 0  Begin  insert into #POPSTATUS (PONUMBER,POSTATUS,POTYPE,DOCDATE,VENDORID,VENDNAME,BUYERID,Workflow_Approval_Status,  ITEMNMBR,ITEMDESC,VNDITNUM,LINEORIGIN,ORD,POLNESTA,LOCNCODE,UofM,QTYORDER,QTYCANCE,QTYUNCMTBASE,QTYRMINV,UNITCOST,RMUNTCST)  select a.PONUMBER, a.POSTATUS, a.POTYPE, a.DOCDATE, a.VENDORID, a.VENDNAME, a.BUYERID,   case  when a.Workflow_Approval_Status = 1 then 'Not Submitted'  when a.Workflow_Approval_Status = 2 then 'Submitted'  when a.Workflow_Approval_Status = 3 then 'Not Needed'  when a.Workflow_Approval_Status = 4 then 'Pending Approval'  when a.Workflow_Approval_Status = 5 then 'Pending Changes'  when a.Workflow_Approval_Status = 6 then 'Approved'  when a.Workflow_Approval_Status = 7 then 'Rejected'  when a.Workflow_Approval_Status = 8 then 'Ended'  when a.Workflow_Approval_Status = 9 then 'Not Enabled'  when a.Workflow_Approval_Status = 10 then 'Disabled'  else '' end,  b.ITEMNMBR, b.ITEMDESC, b.VNDITNUM, b.LINEORIGIN, b.ORD, b.POLNESTA, b.LOCNCODE, b.UOFM, b.QTYORDER, b.QTYCANCE,b.QTYUNCMTBASE,b.QTYUNCMTBASE,b.UNITCOST, a.REMSUBTO  from POP10100 a, POP10110 b  where a.PONUMBER = b.PONUMBER and  b.PONUMBER between @i_PONUMBER_RS and @i_PONUMBER_RE and  a.DOCDATE between @i_DOCDATE_RS and @i_DOCDATE_RE and  a.VENDORID between @i_VENDORID_RS and @i_VENDORID_RE and  a.VENDNAME between @i_VENDNAME_RS and @i_VENDNAME_RE and  a.POSTATUS between @i_POSTATUS_RS and @i_POSTATUS_RE and  b.LINEORIGIN between @i_ORIGIN_RS and @i_ORIGIN_RE and  a.BUYERID between @i_BUYER_RS and @i_BUYER_RE and  b.POLNESTA in (@NEW,@RECEIVED,@RELEASED,@CLOSED,@CHANGE,@CANCELLED)  End Else  Begin   insert into #POPSTATUS (PONUMBER,POSTATUS,POTYPE,DOCDATE,VENDORID,VENDNAME,BUYERID,Workflow_Approval_Status,  ITEMNMBR,ITEMDESC,VNDITNUM,LINEORIGIN,ORD,POLNESTA,LOCNCODE,UofM,QTYORDER,QTYCANCE,QTYUNCMTBASE,QTYRMINV,UNITCOST,RMUNTCST,  POPRCTNM, DATERECD, TRXLOCTN, TRXUofM, QTYSHPPD,QTYINVCD, QTYREJ  )  select a.PONUMBER, a.POSTATUS, a.POTYPE, a.DOCDATE, a.VENDORID, a.VENDNAME, a.BUYERID,   case  when a.Workflow_Approval_Status = 1 then 'Not Submitted'  when a.Workflow_Approval_Status = 2 then 'Submitted'  when a.Workflow_Approval_Status = 3 then 'Not Needed'  when a.Workflow_Approval_Status = 4 then 'Pending Approval'  when a.Workflow_Approval_Status = 5 then 'Pending Changes'  when a.Workflow_Approval_Status = 6 then 'Approved'  when a.Workflow_Approval_Status = 7 then 'Rejected'  when a.Workflow_Approval_Status = 8 then 'Ended'  when a.Workflow_Approval_Status = 9 then 'Not Enabled'  when a.Workflow_Approval_Status = 10 then 'Disabled'  else '' end,  b.ITEMNMBR, b.ITEMDESC, b.VNDITNUM, b.LINEORIGIN, b.ORD,b.POLNESTA, b.LOCNCODE, b.UOFM, b.QTYORDER, b.QTYCANCE,b.QTYUNCMTBASE,b.QTYUNCMTBASE,b.UNITCOST, a.REMSUBTO,  isNULL(c.POPRCTNM,''), isNULL(c.DATERECD,'01/01/1900'), isNULL(c.TRXLOCTN,''), isNULL(c.UOFM,'') as RCPTUOFM, isNULL(c.QTYSHPPD,0), isNULL(c.QTYINVCD,0), isNULL(c.QTYREJ,0)  from POP10100 as a inner join POP10110 as b  on a.PONUMBER = b.PONUMBER left outer join POP10500 as c  on b.PONUMBER = c.PONUMBER and b.ORD = c.POLNENUM  where  b.PONUMBER between @i_PONUMBER_RS and @i_PONUMBER_RE and  a.DOCDATE between @i_DOCDATE_RS and @i_DOCDATE_RE and  a.VENDORID between @i_VENDORID_RS and @i_VENDORID_RE and  a.VENDNAME between @i_VENDNAME_RS and @i_VENDNAME_RE and  a.POSTATUS between @i_POSTATUS_RS and @i_POSTATUS_RE and  b.LINEORIGIN between @i_ORIGIN_RS and @i_ORIGIN_RE and  a.BUYERID between @i_BUYER_RS and @i_BUYER_RE and  b.POLNESTA in (@NEW,@RECEIVED,@RELEASED,@CLOSED,@CHANGE,@CANCELLED)  End   select @a = 0.00  select @POPNUM_OLD = ''   DECLARE mbssequencenumber CURSOR FOR  SELECT distinct PONUMBER, ORD FROM #POPSTATUS order by PONUMBER, ORD   OPEN mbssequencenumber   FETCH NEXT FROM mbssequencenumber  INTO  @POPNUM, @ORD  WHILE @@FETCH_STATUS = 0   Begin  If @POPNUM_OLD <> @POPNUM  Begin  set @x = 1   select @ex = isNULL(sum(EXTDCOST),0) from POP10110 where PONUMBER = @POPNUM and POLNESTA <> 6  update #POPSTATUS set EXTDCOST = @ex where PONUMBER = @POPNUM  End   update #POPSTATUS set POLINE = @x where ORD = @ORD   set @x = @x+1   set @POPNUM_OLD = @POPNUM   FETCH NEXT FROM mbssequencenumber INTO   @POPNUM, @ORD  end  CLOSE mbssequencenumber  DEALLOCATE mbssequencenumber  set nocount off   select PONUMBER, POLINE,  case when POSTATUS = 1 then 'New'  when POSTATUS = 2 then 'Released'  when POSTATUS = 3 then 'Change Order'  when POSTATUS = 4 then 'Received'  when POSTATUS = 5 then 'Closed'  when POSTATUS = 6 then 'Canceled'  else '' end as POSTATUS,  case when POTYPE = 1 then 'Standard'  when POTYPE = 2 then 'Drop Ship'  when POTYPE = 3 then 'Blanket'  when POTYPE = 4 then 'Drop Ship Blanket'  else '' end as POTYPE,  DOCDATE,VENDORID,VENDNAME,BUYERID,Workflow_Approval_Status,  ITEMNMBR,ITEMDESC,VNDITNUM,  case when LINEORIGIN = 1 then 'Manual'  when LINEORIGIN = 2 then 'eReq'  when LINEORIGIN = 3 then 'SOP'  when LINEORIGIN = 4 then 'MRP'  when LINEORIGIN = 5 then 'SMS-CL'  when LINEORIGIN = 6 then 'SMS-RT'  when LINEORIGIN = 7 then 'SMS-DP'  when LINEORIGIN = 8 then 'MOP'  when LINEORIGIN = 9 then 'PO Gen'  else '' end as LINEORIGIN,  ORD,  case when POLNESTA = 1 then 'New'  when POLNESTA = 2 then 'Released'  when POLNESTA = 3 then 'Change Order'  when POLNESTA = 4 then 'Received'  when POLNESTA = 5 then 'Closed'  when POLNESTA = 6 then 'Canceled'  else '' end as POLNESTA,  LOCNCODE,UofM,QTYORDER,QTYCANCE,QTYUNCMTBASE,QTYRMINV,UNITCOST,EXTDCOST,RMUNTCST,RPUNTCST,RPREMCST,  POPRCTNM,   case when DATERECD = '01/01/1900' then '' else convert(char(12), DATERECD, 101) end as DATERECD,   TRXLOCTN, TRXUofM, QTYSHPPD,QTYINVCD, QTYREJ   from #POPSTATUS order by POLINE   
GO
GRANT EXECUTE ON  [dbo].[seePurchaseOrderStatus] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[seePurchaseOrderStatus] TO [rpt_power user]
GO
GRANT EXECUTE ON  [dbo].[seePurchaseOrderStatus] TO [rpt_purchasing agent]
GO
GRANT EXECUTE ON  [dbo].[seePurchaseOrderStatus] TO [rpt_purchasing manager]
GO
