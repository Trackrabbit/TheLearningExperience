SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[sopExtPricingPriceBookSetup]   @piST_ItemNo  char(31),  @ST_PriceGroup char(15),  @iMCReg integer AS  DECLARE @loIN_DPCurr integer,  @loIN_BaseUofM  numeric(19,5),  @loST_UofM char(9),  @loDE_MinVal decimal(19,5),  @loDE_MaxVal decimal(19,5),  @loST_ITEMNMBR char(31),  @loIN_DECPLQTY integer,  @loST_UOMSCHDL char(11),  @loST_FUNLCURR char(16),  @loLO_SeqNo integer,  @UoMSalesOpt integer  DELETE IV00107   WHERE IV00107.ITEMNMBR = @piST_ItemNo AND  IV00107.PRCLEVEL = 'EXTPRCLVL'  DELETE IV00108   WHERE IV00108.ITEMNMBR = @piST_ItemNo AND  IV00108.PRCLEVEL = 'EXTPRCLVL'  IF @iMCReg = 1  EXECUTE ExtPricingGetFunctionalCurrency @loST_FUNLCURR OUTPUT ELSE  SET @loST_FUNLCURR = ''  DECLARE tcsSOPTR00006_IV00101_INS_CUR1 CURSOR FOR SELECT IV00101.ITEMNMBR, IV00101.DECPLQTY, IV00101.UOMSCHDL  FROM IV00101  WHERE IV00101.ITEMNMBR = @piST_ItemNo  OPEN tcsSOPTR00006_IV00101_INS_CUR1 FETCH tcsSOPTR00006_IV00101_INS_CUR1 INTO @loST_ITEMNMBR, @loIN_DECPLQTY, @loST_UOMSCHDL WHILE @@FETCH_STATUS = 0 BEGIN    SET @loIN_DPCurr = @loIN_DECPLQTY - 1   IF @loIN_DPCurr > 0   BEGIN  SET @loDE_MinVal = '0.' + SUBSTRING('0000', 1, @loIN_DPCurr - 1) + '1'  SET @loDE_MaxVal = 1000000000000 - @loDE_MinVal  SELECT @UoMSalesOpt = 3  END  ELSE  BEGIN  SET @loDE_MinVal  = 1  SET @loDE_MaxVal = 999999999999  SELECT @UoMSalesOpt = 2  END   DECLARE tcsSOPTR00006_IV00101_INS_CUR2 CURSOR FOR   SELECT  IV40202.UOFM,  IV40202.QTYBSUOM  FROM IV40202  INNER JOIN IV40201  ON IV40201.BASEUOFM = IV40202.EQUIVUOM  AND IV40201.UOMSCHDL = IV40202.UOMSCHDL  WHERE IV40201.UOMSCHDL = @loST_UOMSCHDL   OPEN tcsSOPTR00006_IV00101_INS_CUR2  FETCH tcsSOPTR00006_IV00101_INS_CUR2 INTO @loST_UofM, @loIN_BaseUofM  WHILE @@FETCH_STATUS = 0  BEGIN  INSERT INTO IV00107  (ITEMNMBR,  CURNCYID,  PRCLEVEL,  UOFM,  RNDGAMNT,  ROUNDHOW,  ROUNDTO,  UMSLSOPT,  QTYBSUOM)  VALUES (@loST_ITEMNMBR,  @loST_FUNLCURR,   'EXTPRCLVL',   @loST_UofM,   0,  0,  1,  @UoMSalesOpt,   @loIN_BaseUofM)    INSERT INTO IV00108  (ITEMNMBR,  CURNCYID,  PRCLEVEL,  UOFM,  TOQTY,  FROMQTY,   UOMPRICE,  QTYBSUOM)  VALUES (@loST_ITEMNMBR,   @loST_FUNLCURR,  'EXTPRCLVL',   @loST_UofM,   @loDE_MaxVal,  @loDE_MinVal,  0,  @loIN_BaseUofM)    FETCH tcsSOPTR00006_IV00101_INS_CUR2 INTO @loST_UofM, @loIN_BaseUofM  END  CLOSE tcsSOPTR00006_IV00101_INS_CUR2  DEALLOCATE tcsSOPTR00006_IV00101_INS_CUR2    FETCH tcsSOPTR00006_IV00101_INS_CUR1 INTO @loST_ITEMNMBR, @loIN_DECPLQTY, @loST_UOMSCHDL  END  CLOSE tcsSOPTR00006_IV00101_INS_CUR1 DEALLOCATE tcsSOPTR00006_IV00101_INS_CUR1  if @ST_PriceGroup <> '' BEGIN  IF (SELECT COUNT(*) from IV10400 WHERE ITEMNMBR = @piST_ItemNo) > 0  BEGIN  IF (SELECT PRCGRPID from IV10400 WHERE ITEMNMBR = @piST_ItemNo) <> @ST_PriceGroup  BEGIN  SELECT @loLO_SeqNo = ISNULL(MAX(SEQNUMBR),0) + 16384 FROM IV10400  WHERE PRCGRPID = @ST_PriceGroup   if @loLO_SeqNo IS NULL  BEGIN  select @loLO_SeqNo = 1  WHILE EXISTS(SELECT 1 FROM IV10400 WHERE PRCGRPID = @ST_PriceGroup and SEQNUMBR = @loLO_SeqNo)  select @loLO_SeqNo = @loLO_SeqNo + 1  END  if @loLO_SeqNo IS NOT NULL  BEGIN  UPDATE IV10400   SET  PRCGRPID = @ST_PriceGroup,  SEQNUMBR = @loLO_SeqNo    WHERE ITEMNMBR = @piST_ItemNo  END   END  END  ELSE  BEGIN  INSERT INTO IV10400  SELECT @ST_PriceGroup,  @piST_ItemNo,  (SELECT ISNULL(MAX(IV10400.SEQNUMBR),0) + 16384  FROM IV10400  WHERE PRCGRPID = @ST_PriceGroup) as SEQNUMBR  END  END    
GO
GRANT EXECUTE ON  [dbo].[sopExtPricingPriceBookSetup] TO [DYNGRP]
GO
