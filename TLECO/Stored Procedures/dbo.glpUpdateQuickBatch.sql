SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[glpUpdateQuickBatch]  @I_iSQLSessionID        int             = NULL,  @I_cBatchSource char(15)        = NULL,  @I_cBatchNumber char(15)        = NULL,  @O_iErrorState          int             = NULL output as  declare  @FALSE tinyint,   @UNPOSTED smallint,  @POSTED smallint,  @POSTED_WITH_ERROR              smallint,  @BATCH_POSTED_WITH_ERROR        smallint,  @tLoop tinyint,  @tTransaction tinyint,  @iUnpostedTransactions          int,  @iPostedWithError int  select   @O_iErrorState = 0  if @@trancount = 0 begin  select @tTransaction = 1  begin transaction end   while (@tLoop is NULL) begin  select @tLoop = 1   select  @FALSE    = 0,  @UNPOSTED   = 1,  @POSTED    = 2,  @POSTED_WITH_ERROR  = 3,  @BATCH_POSTED_WITH_ERROR = 11   select   @iUnpostedTransactions = 0,  @iPostedWithError = 0   if      @I_iSQLSessionID is NULL or  @I_cBatchSource is NULL or  @I_cBatchNumber is NULL  begin   select @O_iErrorState = 20501  break  end    delete   GL10100  where  BSNSFMID        = @I_cBatchNumber  and     PSTGSTUS        = @POSTED   select  @iUnpostedTransactions = count(JRNENTRY)  from  GL10100 with (NOLOCK)  where   BSNSFMID = @I_cBatchNumber  and     PSTGSTUS        <> @POSTED   and     PSTGSTUS  <> @POSTED_WITH_ERROR   update   GL10100  set  PSTGSTUS  = @UNPOSTED,  GLHDRMSG  = 0x00000000,  GLHDRMS2 = 0x00000000  where   BSNSFMID        = @I_cBatchNumber  and     PSTGSTUS        = @POSTED_WITH_ERROR   select @iPostedWithError = @@rowcount   select @iUnpostedTransactions = @iUnpostedTransactions + @iPostedWithError   if @iUnpostedTransactions = 0  begin   delete   SY00500  where  BACHNUMB        = @I_cBatchNumber  and     BCHSOURC        = @I_cBatchSource   if @@rowcount <> 1  begin  select @O_iErrorState = 20717  break  end    end   else   begin  update SY00500  set  MKDTOPST        = @FALSE,  NUMOFTRX        = @iUnpostedTransactions,  DELBACH  = @FALSE,  USERID  = ' ',  BCHSTTUS        = @BATCH_POSTED_WITH_ERROR  where  BCHSOURC        = @I_cBatchSource   and     BACHNUMB        = @I_cBatchNumber   if @@rowcount <> 1  begin  select @O_iErrorState = 20502  break  end   end   end   if @O_iErrorState <> 0 begin  if @tTransaction = 1  rollback transaction  end else if @tTransaction = 1  commit transaction  return    
GO
GRANT EXECUTE ON  [dbo].[glpUpdateQuickBatch] TO [DYNGRP]
GO
