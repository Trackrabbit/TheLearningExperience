SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE procedure [dbo].[SVC_Post_Service_Call] ( @srvrectype int = NULL, @callnbr varchar(10) = NULL) as  declare @compstatus varchar(3) declare @contnbr varchar(11) declare @compdate datetime declare @srvtype varchar(11) declare @pmflag int declare @labortime decimal(19,2) declare @lineprice decimal(19,2) declare @equipid int declare @nextline int declare @meter1 decimal declare @meter2 decimal declare @meter3 decimal declare @meter4 decimal declare @meter5 decimal,  @Rep1 tinyint,   @Rep2 tinyint,  @Rep3 tinyint,  @Rep4 tinyint,  @Rep5 tinyint declare @Internal1 integer declare @Internal2 integer declare @Internal3 integer declare @Internal4 integer declare @Internal5 integer declare @installdate datetime declare @itemnmbr varchar(30) declare @serialnmbr varchar(20) declare @dailyusage decimal declare @numdays integer declare @custnmbr varchar(15) declare @rtnstatus varchar(11) declare @msg varchar(60) declare @errornum int declare @timezone char(3) declare @ADRSCODE char(15) declare @ADDRESS1 char(31) declare @ADDRESS2 char (31) declare @CITY char (31) declare @STATE char (5) declare @ZIP char (11) declare @COUNTRY char (21) declare @CNTCPRSN char (31) declare @linenumber numeric(19,2) declare @LIABTYPE integer declare @BILLAMOUNT numeric(19,2) declare @TOTALREDUCED numeric(19,2) declare @LIABILITY integer declare @LIABDATE datetime declare @MAXCALLS numeric(19,2) declare @NUMBEROFCALLS numeric(19,2) declare @TOTAL numeric(19,2) declare @ErrorCode integer declare @TechID char(11),  @SourceModule char(3),  @SourceDocument varchar(255)  declare  @NEXTLIABDATE datetime ,  @LIABAMT numeric(19,2) ,  @LIABMONTHAMT numeric(19,2),  @TOTALBILLED numeric(19,2) ,  @DLIABAMT numeric(19,2),  @DLIABMONTHAMT numeric(19,2),  @DTOTALBILLED numeric(19,2) ,  @LIABMONTHS integer ,  @LASTDATE datetime  declare @DOCUMENTAMOUNT numeric(19,5),@CONSTS smallint,  @ORGDOCUMENTAMOUNT numeric(19,5),  @AutoMoveHist tinyint,  @USERID       char(15) declare @MinDate datetime  exec smGetMinDate @MinDate output  select @USERID = SYSTEM_USER  set nocount on   if @srvrectype is NULL or @callnbr is NULL begin return 500 end select @compstatus = Invoiced_Status,  @meter3 = 0,   @custnmbr = RETCSTNR,  @rtnstatus = RETSTATUS,  @AutoMoveHist = svcAutoMoveHistory  from SVC00998 if @@error <> 0   begin   return 100001   end  if @compstatus is null or not exists (select SRVSTAT from SVC00913 where SRVSTAT = @compstatus)   begin   return 100003   end  if @rtnstatus is null or not exists (select SRLSTAT from SVC00911 where SRLSTAT = @rtnstatus)   begin   return 100005   end select @contnbr = CONTNBR, @CONSTS = CONSTS,  @DOCUMENTAMOUNT = LABSTOTCST+PARSTOTCST + MISSTOTCST,  @ORGDOCUMENTAMOUNT = ORIGLABSUBTOTCOST+ ORIGPARSTOTCST + ORIGMISSTOTCST  from SVC00200 where SRVRECTYPE = @srvrectype and CALLNBR    = @callnbr  begin transaction  if @DOCUMENTAMOUNT > 0   update SVC00600 set SVC_Invoiced_Cost = SVC_Invoiced_Cost + @DOCUMENTAMOUNT,  Orig_SVC_Invoiced_Cost = Orig_SVC_Invoiced_Cost + @ORGDOCUMENTAMOUNT  where CONTNBR = @contnbr and CONSTS = @CONSTS  update SVC00200 set   SRVRECTYPE = 3,  @contnbr   = CONTNBR,  @linenumber = SVC_Contract_Line_SEQ,  @compdate  = ISNULL(NULLIF(COMPDTE,@MinDate),CONVERT(varchar(10),GETDATE(),102) + ' 00:00:00'),  @srvtype   = SRVTYPE,  @meter1 = Meters_1,  @meter2 = Meters_2,  @meter3 = Meters_3,  @meter4 = Meters_4,  @meter5 = Meters_5,  @Rep1 = Replaces_1,  @Rep2 = Replaces_2,  @Rep3 = Replaces_3,  @Rep4 = Replaces_4,  @Rep5 = Replaces_5,  @Internal1 = Meter_Internal_Uses_1,  @Internal2 = Meter_Internal_Uses_2,  @Internal3 = Meter_Internal_Uses_3,  @Internal4 = Meter_Internal_Uses_4,  @Internal5 = Meter_Internal_Uses_5,  @TechID = TECHID  where SRVRECTYPE = @srvrectype and CALLNBR    = @callnbr  if @@error <> 0 begin   select @ErrorCode = 100006  GOTO syserror   end  update SVC00300   set LSTSRVDTE = @compdate  from SVC00300 inner join SVC00202 on (SVC00300.EQUIPID = SVC00202.EQUIPID)   where SVC00202.SRVRECTYPE = @srvrectype and  SVC00202.CALLNBR = @callnbr  if @@error <> 0   begin   select @ErrorCode = 100010  GOTO syserror   end   update SVC00203 set  ATYALLOC = 0,  QTYBACKO = 0,  SRVRECTYPE = 3  where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  if @@error <> 0   begin   select @ErrorCode = 100012  GOTO syserror   end   update SVC00250 set  SRVRECTYPE = 3  where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  if @@error <> 0        begin   select @ErrorCode = 100013  GOTO syserror   end   insert into SVC00225   SELECT  SVC00201.ITEMNMBR, '', SVC00201.PROBCDE, SVC00201.RPRCODE,0  FROM SVC00201 LEFT JOIN SVC00225 ON   (SVC00201.ITEMNMBR = SVC00225.ITEMNMBR and  SVC00201.PROBCDE = SVC00225.PROBCDE and  SVC00201.RPRCODE = SVC00225.RPRCODE)  WHERE (SVC00225.RPRCODE Is Null) AND  (SVC00225.PROBCDE Is Null) AND  (SVC00225.ITEMNMBR Is Null) and   SVC00201.SRVRECTYPE = @srvrectype and  SVC00201.CALLNBR    =  @callnbr   if @@error <> 0   begin   select @ErrorCode = 100014  GOTO syserror   end  update SVC00225 set  NUMOFTRX = NUMOFTRX + 1  from SVC00225, SVC00201  where SVC00225.ITEMNMBR = SVC00201.ITEMNMBR and  SVC00225.PROBCDE   = SVC00201.PROBCDE and  SVC00225.RPRCODE   = SVC00201.RPRCODE and  SVC00201.SRVRECTYPE = @srvrectype and  SVC00201.CALLNBR    = @callnbr  if @@error <> 0   begin   select @ErrorCode = 100015  GOTO syserror   end  update SVC00201 set  SRVRECTYPE = 3  where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  if @@error <> 0   begin   select @ErrorCode = 100016  GOTO syserror   end   update SVC00210   set SRVRECTYPE = 3  where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  if @@error <> 0   begin   select @ErrorCode = 100017  GOTO syserror   end  update SVC00202   set SRVRECTYPE = 3  where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  if @@error <> 0   begin   select @ErrorCode = 100018  GOTO syserror   end  update SVC00211 set   SRVRECTYPE = 3  where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  if @@error <> 0   begin   select @ErrorCode = 100030  GOTO syserror   end   update SVC00220 set  SRVRECTYPE = 3  where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  if @@error <> 0   begin   select @ErrorCode = 100028  GOTO syserror   end   update SVC00306 set  SRVRECTYPE = 3  where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  if @@error <> 0   begin   select @ErrorCode = 100019  GOTO syserror   end  update SVC00230   set POSTED = 1,POSTEDDT = CONVERT(varchar(10),GETDATE(),102) + ' 00:00:00'  where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr and POSTED = 0  update SVC00230   set SRVRECTYPE = 3  where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  update SVC00231   set SRVRECTYPE = 3  where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  if @@error <> 0   begin   select @ErrorCode = 100029  GOTO syserror   end  if @meter1+@meter2+@meter3+@meter4+@meter5+@Internal1+@Internal2+@Internal3+@Internal4+@Internal5 > 0  begin  select @equipid = null  select @equipid = EQUIPID  from SVC00202   where SRVRECTYPE <> 1 and CALLNBR = @callnbr and EQPLINE = 1  if @equipid is not NULL and @equipid <> 0  begin  exec SVC_METER_Post_Internal_Usage @equipid,@Internal1,@Internal2,@Internal3,@Internal4,@Internal5,@compdate  select @SourceModule = 'CL',   @SourceDocument = '3-' + RTRIM(@callnbr) + '-1-N-0'   exec SVC_METER_Post_Serial_Readings @equipid,@meter1,@meter2,@meter3,@meter4,@meter5,  @Rep1,@Rep2,@Rep3,@Rep4,@Rep5,@compdate,@TechID,'Service Call',@SourceModule,@SourceDocument  end  end  select @equipid = null  select @equipid = EQUIPID  from SVC00202   where SRVRECTYPE = 3 and CALLNBR = @callnbr and EQPLINE = 1 and PMPERF = 1  if @equipid is not NULL and @equipid <> 0  begin  update SVC00300 set  SVC00300.LSTPMDTE  =  @compdate  from SVC00300 where SVC00300.EQUIPID = @equipid  end   update SVC00204 set SRVRECTYPE = 3  where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  if @@error <> 0   begin   select @ErrorCode = 100021  GOTO syserror   end  exec SVC_Post_Process_Service_Call @srvrectype, @callnbr  update SVC00305 set PMSTAT = 3,SVCLSTPMPERF = @compdate  where EQUIPID = @equipid and CALLNBR = @callnbr  if @@error <> 0   begin   select @ErrorCode = 100022  GOTO syserror   end  update SVC00701 set SRVRECTYPE = 3  where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  if @@error <> 0   begin   select @ErrorCode = 100023  GOTO syserror   end  update SVC05000 set SRVRECTYPE = 3  where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  update SVC05200 set SRVRECTYPE = 3  where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr   update SVC00212 set SRVRECTYPE = 3  where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr   update SVC00207 set SRVRECTYPE = 3  where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr   update SVC00240 set SRVRECTYPE = 3 where SRVRECTYPE = @srvrectype and CALLNBR = @callnbr  exec SVC_Post_Process_Service_Call @srvrectype, @callnbr   if @AutoMoveHist = 1  begin  exec SVC_Create_Service_Audit @callnbr, 3, @compstatus, @USERID, 'Move To History via Billing'  exec SVC_Transfer_CallToHistory 3, @callnbr  end  commit transaction  return 0      syserror:  rollback transaction  return @ErrorCode   
GO
GRANT EXECUTE ON  [dbo].[SVC_Post_Service_Call] TO [DYNGRP]
GO
