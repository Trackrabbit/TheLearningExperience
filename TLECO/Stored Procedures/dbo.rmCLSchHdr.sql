SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[rmCLSchHdr]   @I_cUserID char(15) = NULL,  @I_cFileName1 varchar(40) = NULL,  @I_cSearchString1 char(2)  = NULL,  @O_iErrorState int  = NULL output as  declare  @iError int,   @iStatus int,   @tLoop tinyint,  @RM_POSTED smallint,  @RM_DOC_SCH_PYMNT smallint,  @RM_UNPOSTED smallint  select  @O_iErrorState = 0,  @iStatus  = 0  while (@tLoop is NULL) begin  select @tLoop = 1   if   @I_cUserID is NULL  or @I_cFileName1 is NULL  or @I_cSearchString1 is NULL  begin  select @O_iErrorState = 20846  break  end   exec @iStatus = DYNAMICS.dbo.smGetConstantInt  'RM_POSTED',   @RM_POSTED output,   @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   exec @iStatus = DYNAMICS.dbo.smGetConstantInt  'RM_UNPOSTED',   @RM_UNPOSTED output,   @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   exec @iStatus = DYNAMICS.dbo.smGetConstantInt  'RM_DOC_SCH_PYMNT',   @RM_DOC_SCH_PYMNT output,   @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if (@iStatus <> 0) or (@O_iErrorState <> 0)  break   insert into  #CNTRLNUMTEMP(  CNTRLNUM,  DOCTYPE,  VENDORID )  select   SCHEDULE_NUMBER,  @RM_DOC_SCH_PYMNT,  CUSTNMBR  from   RM20400  where   Status = @RM_POSTED  and not exists  (select   1  from   RM20401  where   RM20400.SCHEDULE_NUMBER = RM20401.SCHEDULE_NUMBER)  if @@rowcount <> 0  begin  delete  RM20400  where   Status = @RM_POSTED  and not exists  (select   1  from   RM20401  where   RM20400.SCHEDULE_NUMBER = RM20401.SCHEDULE_NUMBER)  exec @iStatus = smCreateErrorLogRecord  @I_cUserID,  @I_cFileName1,  NULL,  4455,  @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break  end    insert into  #CNTRLNUMTEMP(  CNTRLNUM,  DOCTYPE,  VENDORID )  select   SCHEDULE_NUMBER,  @RM_DOC_SCH_PYMNT,  CUSTNMBR  from   RM20400  where   Status = @RM_POSTED  and  (not exists  (select   1  from   RM20101  where   RM20400.SCHEDULE_NUMBER = RM20101.DOCNUMBR  and  RM20101.RMDTYPAL = @RM_DOC_SCH_PYMNT)  and  not exists  (select   1  from   RM30101  where   RM20400.SCHEDULE_NUMBER = RM30101.DOCNUMBR  and  RM30101.RMDTYPAL = @RM_DOC_SCH_PYMNT)  )    if @@rowcount <> 0  begin  delete  RM20400  where   Status = @RM_POSTED  and  (not exists  (select   1  from   RM20101  where   RM20400.SCHEDULE_NUMBER = RM20101.DOCNUMBR  and  RM20101.RMDTYPAL = @RM_DOC_SCH_PYMNT)  and  not exists  (select   1  from   RM30101  where   RM20400.SCHEDULE_NUMBER = RM30101.DOCNUMBR  and  RM30101.RMDTYPAL = @RM_DOC_SCH_PYMNT)  )    exec @iStatus = smCreateErrorLogRecord  @I_cUserID,  @I_cFileName1,  NULL,  4909,  @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break  end    insert into  #CNTRLNUMTEMP(  CNTRLNUM,  DOCTYPE,  VENDORID )  select   SCHEDULE_NUMBER,  @RM_DOC_SCH_PYMNT,  CUSTNMBR  from   RM20400  where   Status = @RM_POSTED  and  (exists  (select   1  from   RM30101  where   RM20400.SCHEDULE_NUMBER = RM30101.DOCNUMBR  and  RM30101.RMDTYPAL = @RM_DOC_SCH_PYMNT)  and  not exists  (select   1  from   RM30401  where   RM20400.SCHEDULE_NUMBER = RM30401.SCHEDULE_NUMBER)  )    if @@rowcount <> 0  begin  insert into  RM30104( SCHEDULE_NUMBER,  SCHEDULE_DESC,  ORIG_DOC_NUMBER,  ORIG_DOC_TYPE,  CUSTNMBR,  SCH_DOC_DATE,  SCHEDULE_AMOUNT,  CURNCYID,  SCHEDULE_INT_TYPE1,  SCHEDULE_INT_RATE,  NUM_PAYMENTS,  PYMNT_FREQUENCY,  PAYMENT_AMOUNT,  FIRST_INV_DOC_DATE,  FIRST_INV_DUE_DATE,  REC_ACCT_IDX,  REC_OFFSET_ACCT_IDX,  INT_INCOME_ACCT_IDX,  Status)  select  SCHEDULE_NUMBER,  SCHEDULE_DESC,  ORIG_DOC_NUMBER,  ORIG_DOC_TYPE,  CUSTNMBR,  SCH_DOC_DATE,  SCHEDULE_AMOUNT,  CURNCYID,  SCHEDULE_INT_TYPE1,  SCHEDULE_INT_RATE,  NUM_PAYMENTS,  PYMNT_FREQUENCY,  PAYMENT_AMOUNT,  FIRST_INV_DOC_DATE,  FIRST_INV_DUE_DATE,  REC_ACCT_IDX,  REC_OFFSET_ACCT_IDX,  INT_INCOME_ACCT_IDX,  Status  from  RM20400  where   Status = @RM_POSTED  and  (exists  (select   1  from   RM30101  where   RM20400.SCHEDULE_NUMBER = RM30101.DOCNUMBR  and  RM30101.RMDTYPAL = @RM_DOC_SCH_PYMNT)  and  not exists  (select   1  from   RM30401  where   RM20400.SCHEDULE_NUMBER = RM30401.SCHEDULE_NUMBER)  )    delete  RM20400  where   Status = @RM_POSTED  and  (exists  (select   1  from   RM30101  where   RM20400.SCHEDULE_NUMBER = RM30101.DOCNUMBR  and  RM30101.RMDTYPAL = @RM_DOC_SCH_PYMNT)  and  not exists  (select   1  from   RM30401  where   RM20400.SCHEDULE_NUMBER = RM30401.SCHEDULE_NUMBER)  )    exec @iStatus = smCreateErrorLogRecord  @I_cUserID,  @I_cFileName1,  NULL,  4917,  @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break  end   insert into  #CNTRLNUMTEMP(  CNTRLNUM,  DOCTYPE,  VENDORID )  select   SCHEDULE_NUMBER,  @RM_DOC_SCH_PYMNT,  CUSTNMBR  from   RM20400  where   Status = @RM_POSTED  and  (exists  (select   1  from   RM30101  where   RM20400.SCHEDULE_NUMBER = RM30101.DOCNUMBR  and  RM30101.RMDTYPAL = @RM_DOC_SCH_PYMNT)  and  exists  (select   1  from   RM30401  where   RM20400.SCHEDULE_NUMBER = RM30401.SCHEDULE_NUMBER)  )    if @@rowcount <> 0  begin  delete  RM20400  where   Status = @RM_POSTED  and  (exists  (select   1  from   RM30101  where   RM20400.SCHEDULE_NUMBER = RM30101.DOCNUMBR  and  RM30101.RMDTYPAL = @RM_DOC_SCH_PYMNT)  and  exists  (select   1  from   RM30401  where   RM20400.SCHEDULE_NUMBER = RM30401.SCHEDULE_NUMBER)  )    exec @iStatus = smCreateErrorLogRecord  @I_cUserID,  @I_cFileName1,  NULL,  4917,  @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break  end    insert into  #CNTRLNUMTEMP(  CNTRLNUM,  DOCTYPE,  VENDORID )  select   SCHEDULE_NUMBER,  @RM_DOC_SCH_PYMNT,  CUSTNMBR  from   RM20400  where   Status = @RM_UNPOSTED  and not exists  (select   1  from   RM00401  where   RM20400.SCHEDULE_NUMBER = RM00401.DOCNUMBR  AND  RM00401.RMDTYPAL = @RM_DOC_SCH_PYMNT)  if @@rowcount <> 0  begin  insert into  RM00401(DOCNUMBR,  RMDTYPAL  )  select  SCHEDULE_NUMBER,  @RM_DOC_SCH_PYMNT  from  RM20400  where   Status = @RM_UNPOSTED  and not exists  (select   1  from   RM00401  where   RM20400.SCHEDULE_NUMBER = RM00401.DOCNUMBR  AND  RM00401.RMDTYPAL = @RM_DOC_SCH_PYMNT)  exec @iStatus = smCreateErrorLogRecord  @I_cUserID,  @I_cFileName1,  NULL,  10324,  @O_iErrorState output   select @iError = @@error   if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if @iStatus <> 0 or @O_iErrorState <> 0  break  end   end   return(@iStatus)    
GO
GRANT EXECUTE ON  [dbo].[rmCLSchHdr] TO [DYNGRP]
GO
