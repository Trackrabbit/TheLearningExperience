SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[taPMDistributionCreate] @I_vDOCTYPE    smallint, @I_vVCHNUMWK   char(17), @I_vVENDORID   char(15), @I_vCURRNIDX   int, @I_vCURNCYID   char(15), @I_vDECPLCUR   int,     @I_vPTDUSRID   char(15) = '', @I_vPRCHAMNT   numeric(19,5) = 0, @I_vTRDISAMT   numeric(19,5) = 0, @I_vFRTAMNT    numeric(19,5) = 0, @I_vMSCCHAMT   numeric(19,5) = 0, @I_vDISTKNAM   numeric(19,5) = 0, @I_vCASHAMNT   numeric(19,5) = 0, @I_vCHEKAMNT   numeric(19,5) = 0, @I_vCRCRDAMT   numeric(19,5) = 0, @I_vDOCAMNT    numeric(19,5) = 0, @I_vDISAMTAV   numeric(19,5) = 0, @I_vGSTDSAMT   numeric(19,5) = 0, @I_vCAMCBKID   char(15) = '',  @I_vCHAMCBID   char(15) = '', @I_vCARDNAME   char(15) = '', @I_vRATETPID   char(15) = '',    @I_vXCHGRATE   numeric(19,7) = 0,   @I_vEXCHDATE   datetime = '',    @I_vEXPNDATE   datetime = '',    @I_vEXGTBLID   char(15) = '',    @I_vTIME1      datetime = '',    @I_vORCASHAMNT numeric(19,5) = 0,   @I_vORCHEKAMNT numeric(19,5) = 0,   @I_vORCRCRDAMT numeric(19,5) = 0,   @I_vORDISTKNAM numeric(19,5) = 0,   @I_vORTRDISAMT numeric(19,5) = 0,   @I_vORMSCCHAMT numeric(19,5) = 0,   @I_vORFRTAMNT  numeric(19,5) = 0,   @I_vORTAXAMNT  numeric(19,5) = 0,   @I_vORPRCHAMNT numeric(19,5) = 0,   @I_vORDOCAMNT  numeric(19,5) = 0,   @I_vORDISAMTAV numeric(19,5) = 0,   @I_vRTCLCMTD   smallint = 0,    @I_vCMPANYID    smallint = 0,   @I_vINTERID char(5) = '',   @I_vCREATEDIST  int = 1,   @O_iErrorState int = NULL output, @oErrString    varchar(255) output  with encryption as  set transaction isolation level read uncommitted set nocount on  declare  @DTAREF char(25),  @VENDORID char(15),  @CKBKNUM2 char(15),  @PYBLGRBX smallint,  @PTCSHACF smallint,  @APADJ numeric(19,5),  @APADJ2 numeric(19,5),     @TEMP numeric(19,5),  @TEMP2 numeric(19,5),     @DISCAVAMT numeric(19,5),  @ORDISCAVAMT numeric(19,5),     @TRKDISAV int,  @ACTINDX int,  @O_oErrorState int,  @cDTYPE int,  @cDTAMT numeric(19,5),  @cCTAMT numeric(19,5),  @cORDTAMT numeric(19,5),     @cORCTAMT numeric(19,5),     @iCursorError int,  @cINDEX int,  @cStatement varchar(255),  @iStatus int,  @iError int,  @round numeric(19,5),  @ISMCTRX int,  @aaSubLedgerHdrID int,  @O_iErrorStateAASub int,  @O_iErrorStringAASub varchar(255),  @itaProcessAnalyticsErrState int,  @itaProcessAnalyticsErrString varchar(8000),  @DSTSQNUM int,  @ROUNDACCT int,  @CURRNIDX int,  @CURNCYID char(15),  @INTERID char(5)  select   @DTAREF = '',  @O_iErrorState = 0,  @iStatus = 0,  @O_oErrorState = 0,  @ACTINDX = 0,   @DISCAVAMT = 0,  @ORDISCAVAMT = 0,     @TRKDISAV = 0,  @TEMP = 0,  @TEMP2 = 0,      @APADJ = 0,  @APADJ2 = 0,      @PTCSHACF = 0,  @PYBLGRBX = 0,  @CKBKNUM2 = '',  @VENDORID = '',  @round = 0,  @ISMCTRX = 1,  @aaSubLedgerHdrID = 0,  @O_iErrorStateAASub = 0,  @O_iErrorStringAASub = '',  @itaProcessAnalyticsErrState = 0,  @itaProcessAnalyticsErrString = '',  @DSTSQNUM = 0,  @ROUNDACCT = 0,  @CURRNIDX = 0,  @CURNCYID = '',  @INTERID = ''  if ( @I_vDOCTYPE  is null or  @I_vVCHNUMWK is null or  @I_vVENDORID is null or  @I_vCURRNIDX is null or  @I_vCURNCYID is null or  @I_vDECPLCUR is null or     @I_vPTDUSRID is null or  @I_vPRCHAMNT is null or  @I_vTRDISAMT is null or  @I_vFRTAMNT  is null or  @I_vMSCCHAMT is null or  @I_vDISTKNAM is null or  @I_vCASHAMNT is null or  @I_vCHEKAMNT is null or  @I_vCRCRDAMT is null or  @I_vDOCAMNT  is null or  @I_vGSTDSAMT is null or  @I_vDISAMTAV is null or  @I_vCAMCBKID is null or  @I_vCHAMCBID is null or  @I_vCARDNAME is null or  @I_vRATETPID is null or    @I_vXCHGRATE is null or    @I_vEXCHDATE is null or    @I_vEXPNDATE is null or    @I_vEXGTBLID is null or    @I_vTIME1    is null or    @I_vORCASHAMNT is null or   @I_vORCHEKAMNT is null or   @I_vORCRCRDAMT is null or   @I_vORDISTKNAM is null or   @I_vORTRDISAMT is null or   @I_vORMSCCHAMT is null or   @I_vORFRTAMNT  is null or   @I_vORTAXAMNT  is null or   @I_vORPRCHAMNT is null or   @I_vORDOCAMNT  is null or   @I_vORDISAMTAV is null) begin  select @O_iErrorState = 700    return (@O_iErrorState) end  select  @I_vVENDORID = UPPER(@I_vVENDORID)  select @DTAREF = rtrim(@I_vVCHNUMWK) + space(20 - len(@I_vVCHNUMWK)) + '0'  if @I_vRTCLCMTD not in (0,1) begin  select @I_vXCHGRATE = 1, @I_vTIME1 = '', @ISMCTRX = 0  end  if @I_vCREATEDIST = 1 begin  if (exists (select 1 from DTA10100 (nolock) where DTASERIES = 4 and DTAREF = @DTAREF))  begin  delete DTA10100 where DTASERIES = 4 and DTAREF = @DTAREF  if (@@error <> 0)  begin  select @O_iErrorState = 3628    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end  end   if (exists (select 1 from DTA10200 (nolock) where DTASERIES = 4 and DTAREF = @DTAREF))  begin  delete DTA10200 where DTASERIES = 4 and DTAREF = @DTAREF  if (@@error <> 0)  begin  select @O_iErrorState = 3629    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end  end   create table #temp (DTYPE int, DTAMT numeric(19,5), CTAMT numeric(19,5), ORDTAMT numeric(19,5), ORCTAMT numeric(19,5), DTINDEX int)  if (@@error <> 0)  begin  select @O_iErrorState = 703    return (@O_iErrorState)  end   if (@I_vDOCTYPE = 1)  begin  select @ACTINDX = 0  select @ACTINDX = isnull(PMPRCHIX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0) from PM00203 (nolock) where VENDORID = @I_vVENDORID and DISTTYPE = 6  if (@ACTINDX = 0) and (not exists(select 1 from PM00203 (nolock) where VENDORID = @I_vVENDORID and DISTTYPE = 6))  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 600  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 6, @I_vPRCHAMNT, 0, @I_vORPRCHAMNT, 0, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(PMTDSCIX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 700  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 7, 0, @I_vTRDISAMT, 0, @I_vORTRDISAMT, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(PMFRTIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 900  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 9, @I_vFRTAMNT, 0, @I_vORFRTAMNT, 0, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(PMMSCHIX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 800  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 8, @I_vMSCCHAMT, 0, @I_vORMSCCHAMT, 0, @ACTINDX   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 10, isnull(sum(TAXAMNT),0), 0, isnull(sum(ORTAXAMT),0), 0, ACTINDX  from PM10500 (nolock) where VCHRNMBR = @I_vVCHNUMWK and DOCTYPE = @I_vDOCTYPE  group by DOCTYPE, VCHRNMBR, ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(PMTAXIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 1000  update #temp set DTINDEX = @ACTINDX where DTYPE = 10 and DTINDEX = 0   select @ACTINDX = 0  select @ACTINDX = isnull(PMDTKIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 400  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 4, 0, @I_vDISTKNAM, 0, @I_vORDISTKNAM, @ACTINDX   select @ACTINDX = 0  select @TRKDISAV = TRKDISAV from PM40100 (nolock) where UNIQKEY = '1'  if (@TRKDISAV = 1)  begin  select @ACTINDX = isnull(PMDAVIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 300  select @TEMP  =  @I_vDOCAMNT   - (@I_vCASHAMNT   + @I_vCHEKAMNT   + @I_vCRCRDAMT)  select @TEMP2 =  @I_vORDOCAMNT - (@I_vORCASHAMNT + @I_vORCHEKAMNT + @I_vORCRCRDAMT)  if (@I_vDISTKNAM < @I_vDISAMTAV)  begin  if (@TEMP >= @I_vDISAMTAV)  select  @DISCAVAMT   = @I_vDISAMTAV   - @I_vDISTKNAM,  @ORDISCAVAMT = @I_vORDISAMTAV - @I_vORDISTKNAM  else  select  @DISCAVAMT   = @TEMP  - @I_vDISTKNAM,  @ORDISCAVAMT = @TEMP2 - @I_vORDISTKNAM   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 3, 0, @DISCAVAMT, 0, @ORDISCAVAMT, @ACTINDX  end  end   select @ACTINDX = 0  select @ACTINDX = isnull(PMAPINDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 200  select @APADJ  = @I_vDOCAMNT   - (@I_vCASHAMNT   + @I_vCHEKAMNT   + @I_vCRCRDAMT   + @I_vDISTKNAM)  select @APADJ2 = @I_vORDOCAMNT - (@I_vORCASHAMNT + @I_vORCHEKAMNT + @I_vORCRCRDAMT + @I_vORDISTKNAM)  if (@TRKDISAV = 1)  select @APADJ = @APADJ - @DISCAVAMT  select @APADJ2 = @APADJ2 - @ORDISCAVAMT  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 2, 0, @APADJ, 0, @APADJ2, @ACTINDX   select @ACTINDX = 0  select @PTCSHACF = PTCSHACF from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@PTCSHACF = 1)  select @ACTINDX = isnull(PMCSHIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  else  select @ACTINDX = isnull(ACTINDX,0) from CM00100 (nolock) where CHEKBKID = @I_vCAMCBKID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 100  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 1, 0, @I_vCASHAMNT, 0, @I_vORCASHAMNT, @ACTINDX   select @ACTINDX = 0  if (@PTCSHACF = 1)  select @ACTINDX = isnull(PMCSHIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  else  select @ACTINDX = isnull(ACTINDX,0) from CM00100 (nolock) where CHEKBKID = @I_vCHAMCBID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 100  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 1, 0, @I_vCHEKAMNT, 0, @I_vORCHEKAMNT, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(ACTINDX,0), @PYBLGRBX = PYBLGRBX, @CKBKNUM2 = CKBKNUM2, @VENDORID = VENDORID  from SY03100 (nolock) where CARDNAME = @I_vCARDNAME  if (@PYBLGRBX = 1)  select @ACTINDX = isnull(ACTINDX,0)  from CM00100 (nolock) where CHEKBKID = @CKBKNUM2   else  select @ACTINDX = isnull(PMAPINDX,0) from PM00200 (nolock) where VENDORID = @VENDORID   if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 100   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 1, 0, @I_vCRCRDAMT, 0, @I_vORCRCRDAMT, @ACTINDX  end   if (@I_vDOCTYPE = 2)  begin  select @ACTINDX = 0  select @ACTINDX = isnull(PMFINIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0) from PM00203 (nolock) where VENDORID = @I_vVENDORID and DISTTYPE = 5  if (@ACTINDX = 0) and (not exists(select 1 from PM00203 (nolock) where VENDORID = @I_vVENDORID and DISTTYPE = 5))  select @ACTINDX = isnull(ACTINDX,0) from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 500  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 5, @I_vPRCHAMNT, 0, @I_vORPRCHAMNT, 0, @ACTINDX    select @ACTINDX = 0  select @ACTINDX = isnull(PMTDSCIX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 700  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 7, 0, @I_vTRDISAMT, 0, @I_vORTRDISAMT, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(PMFRTIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 900  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 9, @I_vFRTAMNT, 0, @I_vORFRTAMNT, 0, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(PMMSCHIX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 800  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 8, @I_vMSCCHAMT, 0, @I_vORMSCCHAMT, 0, @ACTINDX   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 10, isnull(sum(TAXAMNT),0), 0, isnull(sum(ORTAXAMT),0), 0, ACTINDX  from PM10500 (nolock) where VCHRNMBR = @I_vVCHNUMWK and DOCTYPE = @I_vDOCTYPE  group by DOCTYPE, VCHRNMBR, ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(PMTAXIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 1000  update #temp set DTINDEX = @ACTINDX where DTYPE = 10 and DTINDEX = 0   select @ACTINDX = 0  select @ACTINDX = isnull(PMDTKIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 400   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 4, 0, @I_vDISTKNAM, 0, @I_vORDISTKNAM, @ACTINDX   select @ACTINDX = 0  select @TRKDISAV = TRKDISAV from PM40100 (nolock) where UNIQKEY = '1'  if (@TRKDISAV = 1)  begin  select @ACTINDX = isnull(PMDAVIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 300  select @TEMP  =  @I_vDOCAMNT   - (@I_vCASHAMNT   + @I_vCHEKAMNT   + @I_vCRCRDAMT)   select @TEMP2 =  @I_vORDOCAMNT - (@I_vORCASHAMNT + @I_vORCHEKAMNT + @I_vORCRCRDAMT)  if (@I_vDISTKNAM < @I_vDISAMTAV)  begin  if (@TEMP >= @I_vDISAMTAV)  select  @DISCAVAMT = @I_vDISAMTAV - @I_vDISTKNAM,  @ORDISCAVAMT = @I_vORDISAMTAV - @I_vORDISTKNAM  else  select  @DISCAVAMT = @TEMP - @I_vDISTKNAM,  @ORDISCAVAMT = @TEMP2 - @I_vORDISTKNAM  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 3, 0, @DISCAVAMT, 0, @ORDISCAVAMT, @ACTINDX  end  end   select @ACTINDX = 0  select @ACTINDX = isnull(PMAPINDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 200  select @APADJ = @I_vDOCAMNT -( @I_vCASHAMNT + @I_vCHEKAMNT + @I_vCRCRDAMT + @I_vDISTKNAM )  select @APADJ2 = @I_vORDOCAMNT -( @I_vORCASHAMNT + @I_vORCHEKAMNT + @I_vORCRCRDAMT + @I_vORDISTKNAM )  if (@TRKDISAV = 1)  select @APADJ = @APADJ - @DISCAVAMT  select @APADJ2 = @APADJ2 - @ORDISCAVAMT  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 2, 0, @APADJ, 0, @APADJ2, @ACTINDX   select @ACTINDX = 0  select @PTCSHACF = PTCSHACF from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@PTCSHACF = 1)  select @ACTINDX = isnull(PMCSHIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  else  select @ACTINDX = isnull(ACTINDX,0) from CM00100 (nolock) where CHEKBKID = @I_vCAMCBKID   if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 100  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 1, 0, @I_vCASHAMNT, 0, @I_vORCASHAMNT, @ACTINDX   select @ACTINDX = 0  if (@PTCSHACF = 1)  select @ACTINDX = isnull(PMCSHIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  else  select @ACTINDX = isnull(ACTINDX,0) from CM00100 (nolock) where CHEKBKID = @I_vCHAMCBID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 100  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 1, 0, @I_vCHEKAMNT, 0, @I_vORCHEKAMNT, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(ACTINDX,0), @PYBLGRBX = PYBLGRBX, @CKBKNUM2 = CKBKNUM2, @VENDORID = VENDORID  from SY03100 (nolock) where CARDNAME = @I_vCARDNAME  if (@PYBLGRBX = 1)  select @ACTINDX = isnull(ACTINDX,0)  from CM00100 (nolock) where CHEKBKID = @CKBKNUM2  else  select @ACTINDX = isnull(PMAPINDX,0) from PM00200 (nolock) where VENDORID = @VENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 100   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 1, 0, @I_vCRCRDAMT, 0, @I_vORCRCRDAMT, @ACTINDX  end   if (@I_vDOCTYPE = 3)  begin  select @ACTINDX = 0  select @ACTINDX = isnull(PMPRCHIX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0) from PM00203 (nolock) where VENDORID = @I_vVENDORID and DISTTYPE = 5  if (@ACTINDX = 0) and (not exists(select 1 from PM00203 (nolock) where VENDORID = @I_vVENDORID and DISTTYPE = 5))  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 600   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 6, @I_vPRCHAMNT, 0, @I_vORPRCHAMNT, 0, @ACTINDX    select @ACTINDX = 0  select @ACTINDX = isnull(PMTDSCIX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 700   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 7, 0, @I_vTRDISAMT, 0, @I_vORTRDISAMT, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(PMFRTIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 900   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 9, @I_vFRTAMNT, 0, @I_vORFRTAMNT, 0, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(PMMSCHIX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 800   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 8, @I_vMSCCHAMT, 0, @I_vORMSCCHAMT, 0, @ACTINDX   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 10, isnull(sum(TAXAMNT),0), 0, isnull(sum(ORTAXAMT),0), 0, ACTINDX   from PM10500 (nolock) where VCHRNMBR = @I_vVCHNUMWK and DOCTYPE = @I_vDOCTYPE   group by DOCTYPE, VCHRNMBR, ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(PMTAXIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0) from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 1000  update #temp set DTINDEX = @ACTINDX where DTYPE = 10 and DTINDEX = 0   select @ACTINDX = 0  select @ACTINDX = isnull(PMDTKIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 400   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 4, 0, @I_vDISTKNAM, 0, @I_vORDISTKNAM, @ACTINDX   select @ACTINDX = 0  select @TRKDISAV = TRKDISAV from PM40100 (nolock) where UNIQKEY = '1'  if (@TRKDISAV = 1)  begin  select @ACTINDX = isnull(PMDAVIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0) from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 300  select @TEMP  = @I_vDOCAMNT   - (@I_vCASHAMNT   + @I_vCHEKAMNT   + @I_vCRCRDAMT)   select @TEMP2 = @I_vORDOCAMNT - (@I_vORCASHAMNT + @I_vORCHEKAMNT + @I_vORCRCRDAMT)  if (@I_vDISTKNAM < @I_vDISAMTAV)  begin  if (@TEMP >= @I_vDISAMTAV)  select  @DISCAVAMT   = @I_vDISAMTAV   - @I_vDISTKNAM,  @ORDISCAVAMT = @I_vORDISAMTAV - @I_vORDISTKNAM  else  select  @DISCAVAMT   = @TEMP  - @I_vDISTKNAM,  @ORDISCAVAMT = @TEMP2 - @I_vORDISTKNAM  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 3, 0, @DISCAVAMT, 0, @ORDISCAVAMT, @ACTINDX  end  end   select @ACTINDX = 0  select @ACTINDX = isnull(PMAPINDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 200  select @APADJ  = @I_vDOCAMNT   -(@I_vCASHAMNT   + @I_vCHEKAMNT   + @I_vCRCRDAMT   + @I_vDISTKNAM)  select @APADJ2 = @I_vORDOCAMNT -(@I_vORCASHAMNT + @I_vORCHEKAMNT + @I_vORCRCRDAMT + @I_vORDISTKNAM)  if (@TRKDISAV = 1)  select @APADJ = @APADJ - @DISCAVAMT  select @APADJ2 = @APADJ2 - @ORDISCAVAMT  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 2, 0, @APADJ, 0, @APADJ2, @ACTINDX   select @ACTINDX = 0  select @PTCSHACF = PTCSHACF from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@PTCSHACF = 1)  select @ACTINDX = isnull(PMCSHIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  else  select @ACTINDX = isnull(ACTINDX,0)  from CM00100 (nolock) where CHEKBKID = @I_vCAMCBKID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 100  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 1, 0, @I_vCASHAMNT, 0, @I_vORCASHAMNT, @ACTINDX   select @ACTINDX = 0  if (@PTCSHACF = 1)  select @ACTINDX = isnull(PMCSHIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  else  select @ACTINDX = isnull(ACTINDX,0)  from CM00100 (nolock) where CHEKBKID = @I_vCHAMCBID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 100  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 1, 0, @I_vCHEKAMNT, 0, @I_vORCHEKAMNT, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(ACTINDX,0), @PYBLGRBX = PYBLGRBX, @CKBKNUM2 = CKBKNUM2, @VENDORID = VENDORID  from SY03100 (nolock) where CARDNAME = @I_vCARDNAME  if (@PYBLGRBX = 1)  select @ACTINDX = isnull(ACTINDX,0)  from CM00100 (nolock) where CHEKBKID = @CKBKNUM2  else  select @ACTINDX = isnull(PMAPINDX,0) from PM00200 (nolock) where VENDORID = @VENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 100  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 1, 0, @I_vCRCRDAMT, 0, @I_vORCRCRDAMT, @ACTINDX  end   if (@I_vDOCTYPE = 4)  begin  select @ACTINDX = 0  select @ACTINDX = isnull(PMPRCHIX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0) from PM00203 (nolock) where VENDORID = @I_vVENDORID and DISTTYPE = 6  if (@ACTINDX = 0) and (not exists(select 1 from PM00203 (nolock) where VENDORID = @I_vVENDORID and DISTTYPE = 6))  select @ACTINDX = isnull(ACTINDX,0) from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 600   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 6, 0, @I_vPRCHAMNT, 0, @I_vORPRCHAMNT, @ACTINDX    select @ACTINDX = 0  select @ACTINDX = isnull(PMTDSCIX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 700  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 7, @I_vTRDISAMT, 0, @I_vORTRDISAMT, 0, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(PMFRTIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 900  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 9, 0, @I_vFRTAMNT, 0, @I_vORFRTAMNT, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(PMMSCHIX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 800  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 8, 0, @I_vMSCCHAMT, 0, @I_vORMSCCHAMT, @ACTINDX   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 10, 0, isnull(sum(TAXAMNT),0), 0, isnull(sum(ORTAXAMT),0), ACTINDX   from PM10500 (nolock) where VCHRNMBR = @I_vVCHNUMWK and DOCTYPE = @I_vDOCTYPE   group by DOCTYPE, VCHRNMBR, ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(PMTAXIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 1000  update #temp set DTINDEX = @ACTINDX where DTYPE = 10 and DTINDEX = 0   select @ACTINDX = 0  select @ACTINDX = isnull(PMDTKIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 400   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 4, @I_vDISTKNAM, 0, @I_vORDISTKNAM, 0, @ACTINDX   select @ACTINDX = 0  select @TRKDISAV = TRKDISAV from PM40100 (nolock) where UNIQKEY = '1'  if (@TRKDISAV = 1)  begin  select @ACTINDX = isnull(PMDAVIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 300  select @TEMP  = @I_vDOCAMNT   - (@I_vCASHAMNT   + @I_vCHEKAMNT   + @I_vCRCRDAMT)  select @TEMP2 = @I_vORDOCAMNT - (@I_vORCASHAMNT + @I_vORCHEKAMNT + @I_vORCRCRDAMT)  if (@I_vDISTKNAM < @I_vDISAMTAV)  begin  if (@TEMP >= @I_vDISAMTAV)  select  @DISCAVAMT = @I_vDISAMTAV - @I_vDISTKNAM,  @ORDISCAVAMT = @I_vORDISAMTAV - @I_vORDISTKNAM  else  select  @DISCAVAMT = @TEMP - @I_vDISTKNAM,  @ORDISCAVAMT = @TEMP2 - @I_vORDISTKNAM  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 3, @DISCAVAMT, 0, @ORDISCAVAMT, 0, @ACTINDX  end  end   select @ACTINDX = 0  select @ACTINDX = isnull(PMAPINDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 200  select @APADJ  = @I_vDOCAMNT   -(@I_vCASHAMNT   + @I_vCHEKAMNT   + @I_vCRCRDAMT   + @I_vDISTKNAM)  select @APADJ2 = @I_vORDOCAMNT -(@I_vORCASHAMNT + @I_vORCHEKAMNT + @I_vORCRCRDAMT + @I_vORDISTKNAM)  if (@TRKDISAV = 1)  select @APADJ = @APADJ - @DISCAVAMT  select @APADJ2 = @APADJ2 - @ORDISCAVAMT  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 2, @APADJ, 0, @APADJ2, 0, @ACTINDX   select @ACTINDX = 0  select @PTCSHACF = PTCSHACF from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@PTCSHACF = 1)  select @ACTINDX = isnull(PMCSHIDX,0)from PM00200 (nolock) where VENDORID = @I_vVENDORID  else  select @ACTINDX = isnull(ACTINDX,0) from CM00100 (nolock) where CHEKBKID = @I_vCAMCBKID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 100  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 1, @I_vCASHAMNT, 0, @I_vORCASHAMNT, 0, @ACTINDX   select @ACTINDX = 0  if (@PTCSHACF = 1)  select @ACTINDX = isnull(PMCSHIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  else  select @ACTINDX = isnull(ACTINDX,0) from CM00100 (nolock) where CHEKBKID = @I_vCHAMCBID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 100  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 1, @I_vCHEKAMNT, 0, @I_vORCHEKAMNT, 0, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(ACTINDX,0), @PYBLGRBX = PYBLGRBX, @CKBKNUM2 = CKBKNUM2, @VENDORID = VENDORID  from SY03100 (nolock) where CARDNAME = @I_vCARDNAME  if (@PYBLGRBX = 1)  select @ACTINDX = isnull(ACTINDX,0) from CM00100 (nolock) where CHEKBKID = @CKBKNUM2  else  select @ACTINDX = isnull(PMAPINDX,0) from PM00200 (nolock) where VENDORID = @VENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 100  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 1, @I_vCRCRDAMT, 0, @I_vORCRCRDAMT, 0, @ACTINDX  end   if (@I_vDOCTYPE = 5)  begin  select @ACTINDX = 0  select @ACTINDX = isnull(PMPRCHIX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0) from PM00203 (nolock) where VENDORID = @I_vVENDORID and DISTTYPE = 6  if (@ACTINDX = 0) and (not exists(select 1 from PM00203 (nolock) where VENDORID = @I_vVENDORID and DISTTYPE = 6))  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 600   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 6, 0, @I_vPRCHAMNT, 0, @I_vORPRCHAMNT, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(PMTDSCIX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 700   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 7, @I_vTRDISAMT, 0, @I_vORTRDISAMT, 0, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(PMFRTIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 900   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 9, 0, @I_vFRTAMNT, 0, @I_vORFRTAMNT, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(PMMSCHIX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 800   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 8, 0, @I_vMSCCHAMT, 0, @I_vORMSCCHAMT, @ACTINDX   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 10, 0, isnull(sum(TAXAMNT),0), 0, isnull(sum(ORTAXAMT),0), ACTINDX   from PM10500 (nolock) where VCHRNMBR = @I_vVCHNUMWK and DOCTYPE = @I_vDOCTYPE   group by DOCTYPE, VCHRNMBR, ACTINDX  select @ACTINDX = 0  select @ACTINDX = isnull(PMTAXIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 1000  update #temp set DTINDEX = @ACTINDX where DTYPE = 10 and DTINDEX = 0   select @ACTINDX = 0  select @ACTINDX = isnull(PMAPINDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 200  select @APADJ = @I_vDOCAMNT - (@I_vCASHAMNT + @I_vCHEKAMNT + @I_vCRCRDAMT + @I_vDISTKNAM)  select @APADJ2 = @I_vORDOCAMNT -(@I_vORCASHAMNT + @I_vORCHEKAMNT + @I_vORCRCRDAMT + @I_vORDISTKNAM)  if (@TRKDISAV = 1)  select @APADJ = @APADJ - @DISCAVAMT  select @APADJ2 = @APADJ2 - @ORDISCAVAMT  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 2, @APADJ, 0, @APADJ2, 0, @ACTINDX  end   if ( @I_vDOCTYPE = 6 )  begin  select @ACTINDX = 0  select @PTCSHACF = PTCSHACF from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@PTCSHACF = 1)  select @ACTINDX = isnull(PMCSHIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  else  select @ACTINDX = isnull(ACTINDX,0) from CM00100 (nolock) where CHEKBKID = @I_vCAMCBKID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 100  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 1, 0, @I_vCASHAMNT, 0, @I_vORCASHAMNT, @ACTINDX   select @ACTINDX = 0  if (@PTCSHACF = 1)  select @ACTINDX = isnull(PMCSHIDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  else  select @ACTINDX = isnull(ACTINDX,0) from CM00100 (nolock) where CHEKBKID = @I_vCAMCBKID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 100  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 1, 0, @I_vCHEKAMNT, 0, @I_vORCHEKAMNT, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(ACTINDX,0), @PYBLGRBX = PYBLGRBX, @CKBKNUM2 = CKBKNUM2, @VENDORID = VENDORID  from SY03100 (nolock) where CARDNAME = @I_vCARDNAME  if (@PYBLGRBX = 1)  select @ACTINDX = isnull(ACTINDX,0)  from CM00100 (nolock) where CHEKBKID = @CKBKNUM2   else  select @ACTINDX = isnull(PMAPINDX,0) from PM00200 (nolock) where VENDORID = @VENDORID   if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 200   insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 1, 0, @I_vCRCRDAMT, 0, @I_vORCRCRDAMT, @ACTINDX   select @ACTINDX = 0  select @ACTINDX = isnull(PMAPINDX,0) from PM00200 (nolock) where VENDORID = @I_vVENDORID  if (@ACTINDX = 0)  select @ACTINDX = isnull(ACTINDX,0)  from SY01100 (nolock) where SERIES = 4 and SEQNUMBR = 200  select @APADJ = @I_vDOCAMNT   select @APADJ2 = @I_vORDOCAMNT  insert into #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 2, @APADJ, 0, @APADJ2, 0, @ACTINDX  end   if @ISMCTRX = 1  begin  if (@I_vCURNCYID <> (select FUNLCURR from MC40000(nolock)))  begin  select @round = isnull(sum(DTAMT - CTAMT),0) from #temp   insert #temp (DTYPE, DTAMT, CTAMT, ORDTAMT, ORCTAMT, DTINDEX)  select 16,  case  when @round < 0  then @round * -1  else 0  end,  case  when @round > 0  then @round  else 0  end,  0,  0,  RNDDIFF  from MC40201 (nolock) where CURNCYID = @I_vCURNCYID  end  end   delete #temp where DTAMT + CTAMT = 0.00   declare DistLine INSENSITIVE cursor for select  DTYPE,  DTAMT,  CTAMT,  ORDTAMT,       ORCTAMT,       DTINDEX   from #temp    open DistLine  select @iCursorError = @@cursor_rows   if (@iCursorError > 0)  begin  fetch next from DistLine into  @cDTYPE,  @cDTAMT,  @cCTAMT,   @cORDTAMT,      @cORCTAMT,       @cINDEX  while (@@fetch_status <> -1)  begin  if (@@fetch_status = -2)  begin  select @O_iErrorState = 704   break  end   exec @iStatus = taPMDistributionBuild  @I_vDOCTYPE  = @I_vDOCTYPE,  @I_vVCHNUMWK = @I_vVCHNUMWK,  @I_vVENDORID = @I_vVENDORID,  @I_vACTINDX  = @cINDEX,  @I_vDTSAMT   = @cDTAMT,  @I_vCTSAMT   = @cCTAMT,  @I_vTYPE     = @cDTYPE,  @I_vCURRNIDX = @I_vCURRNIDX,  @I_vCURNCYID = @I_vCURNCYID,  @I_vDECPLCUR = @I_vDECPLCUR,    @I_vPTDUSRID = @I_vPTDUSRID,  @I_vRATETPID = @I_vRATETPID,    @I_vXCHGRATE = @I_vXCHGRATE,    @I_vEXCHDATE = @I_vEXCHDATE,    @I_vEXPNDATE = @I_vEXPNDATE,    @I_vEXGTBLID = @I_vEXGTBLID,     @I_vTIME1    = @I_vTIME1,    @I_vORDTSAMT = @cORDTAMT,    @I_vORCTSAMT = @cORCTAMT,    @I_vRTCLCMTD = @I_vRTCLCMTD,    @O_iErrorState = @O_iErrorState output,  @oErrString  = @oErrString output  select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError  if (@iStatus <> 0) or (@O_oErrorState <> 0)  begin  select @O_iErrorState = 705   deallocate DistLine  return (@O_iErrorState)  end   fetch next from DistLine into  @cDTYPE,  @cDTAMT,  @cCTAMT,  @cORDTAMT,     @cORCTAMT,     @cINDEX   end  end   deallocate DistLine end  if ((@ISMCTRX = 1) and (@I_vCREATEDIST <> 1)) begin  if (exists(select 1 from PM10100 (nolock) where VCHRNMBR = @I_vVCHNUMWK and DISTTYPE <> 15 having sum(ORCRDAMT) = sum(ORDBTAMT) and sum(CRDTAMNT) <> sum(DEBITAMT)))       begin   select  @round = sum(CRDTAMNT) - sum(DEBITAMT),   @DSTSQNUM = max(DSTSQNUM)+16384 from PM10100 (nolock) where VCHRNMBR = @I_vVCHNUMWK    select @ROUNDACCT = RNDDIFF from MC40201 (nolock) where CURNCYID = @I_vCURNCYID   select @CURRNIDX = FUNCRIDX, @CURNCYID = FUNLCURR from MC40000 (nolock)   select @INTERID = INTERID from DYNAMICS..SY01500 (nolock) where INTERID = db_name()   insert into PM10100  (  VCHRNMBR,  DSTSQNUM,  CNTRLTYP,  CRDTAMNT,  DEBITAMT,  DSTINDX,  DISTTYPE,  CHANGED,   USERID,  PSTGSTUS,  VENDORID,  TRXSORCE,  PSTGDATE,  INTERID,  CURNCYID,  CURRNIDX,  ORCRDAMT,  ORDBTAMT,  APTVCHNM,  APTODCTY,  SPCLDIST,  DistRef,  RATETPID,  EXGTBLID,  XCHGRATE,  EXCHDATE,  TIME1,  RTCLCMTD,  DECPLACS,  EXPNDATE,  ICCURRID,  ICCURRIX,  DENXRATE,  MCTRXSTT,   CorrespondingUnit  )  select  @I_vVCHNUMWK,     @DSTSQNUM,     0,      case      when @round < 0  then @round * -1   else 0  end,  case      when @round > 0  then @round  else 0  end,  @ROUNDACCT,     16,      0,      '',       0,      @I_vVENDORID,     '',      '',      @INTERID,     @I_vCURNCYID,     @I_vCURRNIDX,     0,      0,      '',      0,      0,      '',      '',      '',      1,      '',      '',      0,        @I_vDECPLCUR,          '',      @CURNCYID,            @CURRNIDX,     0,      0,       ''      if (@@error <> 0)  begin  select @O_iErrorState = 8301    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end  end end  if exists(select 1 from DYNAMICS..sysobjects (nolock) where name  = 'AAG00102') begin  if exists(select 1 from DYNAMICS..AAG00102 (nolock) where CMPANYID = @I_vCMPANYID)  begin   if @I_vDOCTYPE = 6    select @I_vDOCTYPE = 1  else  select @I_vDOCTYPE = 0   select @I_vDECPLCUR = DECPLCUR - 1 from DYNAMICS..MC40200 (nolock) where CURNCYID = @I_vCURNCYID   exec @iStatus = aagCreateSubWorkDist  @aaSubLedgerHdrID out,  0,   @I_vDOCTYPE,   @I_vVCHNUMWK,  '',   10100,  4,   @I_vCMPANYID,   0,  @I_vCURNCYID,   @I_vCURRNIDX,   @I_vRATETPID,   @I_vEXGTBLID,   @I_vXCHGRATE,   @I_vEXCHDATE,   @I_vTIME1,  @I_vRTCLCMTD,   0,  0,   @I_vDECPLCUR,   1,   @I_vINTERID,   0,   0,  '',  @O_iErrorStateAASub output,  @O_iErrorStringAASub output   if (@@error <> 0)   begin  select @O_iErrorState = 8196    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return(@O_iErrorState)  end  if @aaSubLedgerHdrID <> 0  begin  exec @iStatus = taProcessAnalytics  @I_vDOCNMBR = @I_vVCHNUMWK,  @I_vKey = @I_vVCHNUMWK,  @I_vDOCTYPE = 0,  @O_iErrorState = @itaProcessAnalyticsErrState output,  @oErrString = @itaProcessAnalyticsErrString output  select @iError = @@error  if ((@iStatus <> 0) or (@itaProcessAnalyticsErrState <> 0) or (@iError <> 0))  begin  select @oErrString = rtrim(@oErrString) + ' ' + @itaProcessAnalyticsErrString  select @O_iErrorState = 8197    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return(@O_iErrorState)  end  end  end end  return (@O_iErrorState)   
GO
GRANT EXECUTE ON  [dbo].[taPMDistributionCreate] TO [DYNGRP]
GO
