SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE Procedure [dbo].[SVC_Set_Depot_HDR_Post_Dist]  @WONumber char(11),  @RecordType smallint,  @IVIndex_P integer,  @IVIndex_L integer,  @IVIndex_E integer,  @IVIndex_I integer,  @IVIndex_O integer,  @OffsetIndex_I integer,  @OffsetIndex_O integer,  @CurrencyIndex smallint,  @From smallint   AS declare  @NextLine integer declare  @Item_In char(31),@Item_Out char(31) declare  @Serial_In char(21), @Serial_Out char(21) declare  @Cost numeric(19,2) declare  @CAmount numeric(19,2) declare  @OrigCAmount numeric (19,2) declare  @DAmount numeric(19,2) declare  @OrigDAmount numeric (19,2) declare  @PostDate datetime declare  @WOType char(11) declare  @DoExpense tinyint, @Location char(11),  @WIPIndex_P integer,  @WIPIndex_L integer,  @WIPIndex_E integer,  @newWIPIndex_P integer,  @newWIPIndex_L integer,  @newWIPIndex_E integer declare  @PartAmount numeric(19,2) declare  @LaborAmount numeric(19,2) declare  @Posted tinyint declare  @CustomerOwned tinyint declare  @RMA char(15) declare @MinDate datetime  exec smGetMinDate @MinDate output   select @PartAmount = PARSTOTCST, @LaborAmount = LABSTOTCST,@WOType = WOTYPE, @Location = LOCNCODE,  @RMA =RETDOCID, @Serial_In = IBSERIAL, @Serial_Out = OBSERIAL,  @Item_In = IBITEMNUM, @Item_Out = OBITEMNUM, @CustomerOwned = CUSTOWN from SVC06100  where WORECTYPE = @RecordType and WORKORDNUM = @WONumber select @DoExpense = SVC_Do_Expense,@WIPIndex_E = SVC_Expense_Index,  @WIPIndex_P = WIPINV, @WIPIndex_L = WIPLABOR from SVC06020 where WOTYPE = @WOType exec SVC_LocationSegmentReplace @WIPIndex_E, @Location, @newWIPIndex_E output  exec SVC_LocationSegmentReplace @WIPIndex_P, @Location, @newWIPIndex_P output  exec SVC_LocationSegmentReplace @WIPIndex_L, @Location, @newWIPIndex_L output  select @PostDate =  'January 1, 1900' select @Posted = 0  if @DoExpense = 1 and @CustomerOwned = 1  select @IVIndex_P = @newWIPIndex_E, @IVIndex_L = @newWIPIndex_E  if @Item_In > '' and @CustomerOwned = 0 begin  if @RMA > ''  select @Cost = RETCOST from SVC00951 where ITEMNMBR = @Item_In  else select @Cost = 0   if @Cost = 0 or @Cost = null  Begin  if (select ITMTRKOP from IV00101 where ITEMNMBR = @Item_In) = 2  select @Cost = UNITCOST from IV00200 where ITEMNMBR = @Item_In and SERLNMBR = @Serial_In  else   select @Cost =   case when VCTNMTHD > 3 then  STNDCOST   else CURRCOST  end   from IV00101 where ITEMNMBR = @Item_In  End  select @NextLine = 100  if not exists(select * from SVC06130 where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 4 and SEQNUMBR = 100 and POSTED = 0)  BEGIN  select @CAmount = isnull(@Cost,0), @OrigCAmount = isnull(@Cost,0)  select @DAmount = 0, @OrigDAmount = 0  insert SVC06130 select   @RecordType,@WONumber,@NextLine,4,'',@IVIndex_I,  @DAmount,@OrigDAmount,@CAmount,@OrigCAmount,isnull(@CurrencyIndex,0),  '', @Posted,@PostDate  END  else  BEGIN  select @Cost = isnull(@Cost,0)  if @From = 1  update SVC06130 set CRDTAMNT=@Cost,ORCRDAMT=@Cost, ACTINDX = @IVIndex_I  where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 4 and SEQNUMBR = 100 and POSTED = 0  END  if not exists(select * from SVC06130 where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 5 and SEQNUMBR = 100 and POSTED = 0)  BEGIN  select @CAmount = 0, @OrigCAmount = 0  select @DAmount = isnull(@Cost,0), @OrigDAmount = isnull(@Cost,0)  insert SVC06130 select   @RecordType,@WONumber,@NextLine,5,'',@OffsetIndex_I,  @DAmount,@OrigDAmount,@CAmount,@OrigCAmount,isnull(@CurrencyIndex,0),  '', @Posted,@PostDate  END  else  BEGIN  select @Cost = isnull(@Cost,0)  if @From = 1  update SVC06130 set DEBITAMT=@Cost,ORDBTAMT=@Cost, ACTINDX = @OffsetIndex_I  where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 5 and SEQNUMBR = 100 and POSTED = 0  END end   if @Item_Out > '' and @CustomerOwned = 0 begin  select @NextLine = 200  if @Cost = 0 or @Cost = null  begin  if @RMA > ''  select @Cost = RETCOST from SVC00951 where ITEMNMBR = @Item_Out  else select @Cost = 0   if @Cost = 0 or @Cost = null  select @Cost = CURRCOST from IV00101 where ITEMNMBR = @Item_Out  end  if @DoExpense = 0 select @Cost = isnull(@Cost,0) + @PartAmount + @LaborAmount  if not exists(select * from SVC06130 where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 4 and SEQNUMBR = 200 and POSTED = 0)  BEGIN  select @CAmount = 0, @OrigCAmount = 0  select @DAmount = isnull(@Cost,0), @OrigDAmount = isnull(@Cost,0)  insert SVC06130 select   @RecordType,@WONumber,@NextLine,4,'',@IVIndex_O,  @DAmount,@OrigDAmount,@CAmount,@OrigCAmount,isnull(@CurrencyIndex,0),  '', @Posted,@PostDate  END  else  BEGIN  select @Cost = isnull(@Cost,0)  if @From = 1  update SVC06130 set DEBITAMT=@Cost,ORDBTAMT=@Cost , ACTINDX = @IVIndex_O  where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 4 and SEQNUMBR = 200 and POSTED = 0  else  update SVC06130 set DEBITAMT=@Cost,ORDBTAMT=@Cost   where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 4 and SEQNUMBR = 200 and POSTED = 0  END  if not exists(select * from SVC06130 where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 5 and SEQNUMBR = 200 and POSTED = 0)  BEGIN  select @CAmount = isnull(@Cost,0), @OrigCAmount = isnull(@Cost,0)  select @DAmount = 0, @OrigDAmount = 0  insert SVC06130 select   @RecordType,@WONumber,@NextLine,5,'',@OffsetIndex_O,  @DAmount,@OrigDAmount,@CAmount,@OrigCAmount,isnull(@CurrencyIndex,0),  '', @Posted,@PostDate  END  else  BEGIN  select @Cost = isnull(@Cost,0)  if @From = 1  update SVC06130 set CRDTAMNT=@Cost,ORCRDAMT=@Cost , ACTINDX = @OffsetIndex_O  where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 5 and SEQNUMBR = 200 and POSTED = 0  else  update SVC06130 set CRDTAMNT=@Cost,ORCRDAMT=@Cost   where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 5 and SEQNUMBR = 200 and POSTED = 0  END end   if @From = 2 begin  select @Cost = @PartAmount   select @NextLine = 300  if not exists(select * from SVC06130 where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 5 and SEQNUMBR = 300 and POSTED = 0)  BEGIN  select @DAmount = isnull(@Cost,0), @OrigDAmount = isnull(@Cost,0)  select @CAmount = 0, @OrigCAmount = 0  insert SVC06130 select   @RecordType,@WONumber,@NextLine,5,'',@IVIndex_P,  @DAmount,@OrigDAmount,@CAmount,@OrigCAmount,isnull(@CurrencyIndex,0),  '', @Posted,@PostDate  END  else  BEGIN  select @Cost = isnull(@Cost,0)  update SVC06130 set DEBITAMT=@Cost,ORDBTAMT=@Cost where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 5 and SEQNUMBR = 300 and POSTED = 0  END   if not exists(select * from SVC06130 where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 9 and SEQNUMBR = 300 and POSTED = 0)  BEGIN  select @DAmount = 0, @OrigDAmount = 0  select @CAmount = isnull(@Cost,0), @OrigCAmount = isnull(@Cost,0)  insert SVC06130 select   @RecordType,@WONumber,@NextLine,9,'',@newWIPIndex_P,  @DAmount,@OrigDAmount,@CAmount,@OrigCAmount,isnull(@CurrencyIndex,0),  '', @Posted,@PostDate  END  else  BEGIN  select @Cost = isnull(@Cost,0)  update SVC06130 set CRDTAMNT=@Cost,ORCRDAMT=@Cost where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 9 and SEQNUMBR = 300 and POSTED = 0  END end    if @From = 3 begin  select @Cost = isnull(@LaborAmount ,0)  select @NextLine = 400  if not exists(select * from SVC06130 where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 5 and SEQNUMBR = 400 and POSTED = 0)  BEGIN  select @DAmount = @Cost, @OrigDAmount = @Cost  select @CAmount = 0, @OrigCAmount = 0  insert SVC06130 select   @RecordType,@WONumber,@NextLine,5,'',@IVIndex_L,  @DAmount,@OrigDAmount,@CAmount,@OrigCAmount,isnull(@CurrencyIndex,0),  '', @Posted,@PostDate  END  else  BEGIN  update SVC06130 set DEBITAMT=@Cost,ORDBTAMT=@Cost where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 5 and SEQNUMBR = 400 and POSTED = 0  END  if not exists(select * from SVC06130 where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 9 and SEQNUMBR = 400 and POSTED = 0)  BEGIN  select @Cost = isnull(@Cost,0)  select @DAmount = 0, @OrigDAmount = 0  select @CAmount = @Cost, @OrigCAmount = @Cost  insert SVC06130 select   @RecordType,@WONumber,@NextLine,9,'',@newWIPIndex_L,  @DAmount,@OrigDAmount,@CAmount,@OrigCAmount,isnull(@CurrencyIndex,0),  '', @Posted,@PostDate  END else  BEGIN  select @Cost = isnull(@Cost,0)  update SVC06130 set CRDTAMNT=@Cost,ORCRDAMT=@Cost where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 9 and SEQNUMBR = 400 and POSTED = 0  END end  if @From > 1  begin  select @Cost = isnull(@LaborAmount,0) + isnull(@PartAmount,0) if @DoExpense = 1  and @CustomerOwned = 0 and @Cost <> 0  BEGIN  if not exists(select * from SVC06130 where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 5 and SEQNUMBR = 500 and POSTED = 0)  BEGIN  select @NextLine = 500  select @CAmount = @Cost, @OrigCAmount = @Cost  select @DAmount = 0, @OrigDAmount = 0  insert SVC06130 select   @RecordType,@WONumber,@NextLine,5,'',@IVIndex_E,  @DAmount,@OrigDAmount,@CAmount,@OrigCAmount,isnull(@CurrencyIndex,0),  '', @Posted,@PostDate  END  else  BEGIN  update SVC06130 set CRDTAMNT=@Cost,ORCRDAMT=@Cost where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 5 and SEQNUMBR = 500 and POSTED = 0  END  if not exists(select * from SVC06130 where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 9 and SEQNUMBR = 500 and POSTED = 0)  BEGIN  select @CAmount = 0, @OrigCAmount = 0  select @DAmount = @Cost, @OrigDAmount = @Cost  insert SVC06130 select   @RecordType,@WONumber,@NextLine,9,'',@newWIPIndex_E,  @DAmount,@OrigDAmount,@CAmount,@OrigCAmount,isnull(@CurrencyIndex,0),  '', @Posted,@PostDate  END  else  BEGIN  update SVC06130 set DEBITAMT=@Cost,ORDBTAMT=@Cost where WORECTYPE = @RecordType and WORKORDNUM = @WONumber  and SVC_Distribution_Type= 9 and SEQNUMBR = 500 and POSTED = 0  END  END end  return(0)    
GO
GRANT EXECUTE ON  [dbo].[SVC_Set_Depot_HDR_Post_Dist] TO [DYNGRP]
GO
