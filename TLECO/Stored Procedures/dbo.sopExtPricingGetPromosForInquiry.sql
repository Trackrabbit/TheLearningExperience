SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[sopExtPricingGetPromosForInquiry]  @piST_UserID char(15), @piST_DorP char(1),      @piST_CustomerNumber char(15),   @piST_FromItemNumber char(31),   @piST_ToItemNumber   char(31),   @piDA_Date datetime,    @piST_Currency  char(16),    @piIN_Orig_and_Funct integer,   @poIN_PromFound integer  OUTPUT    AS  DECLARE  @loST_ItemNumber   char(31),    @loST_HoldItemNumber   char(31),     @loST_UofM char(10),     @loST_HoldUofM char(10),     @loST_HoldCurrency char(16),  @loST_FUNLCURR char(16),  @loST_Currency char(16)  EXECUTE ExtPricingGetFunctionalCurrency @loST_FUNLCURR OUTPUT  IF @loST_FUNLCURR IS NULL BEGIN  SELECT @loST_FUNLCURR = '' END   DELETE FROM SOP50400 WHERE USERID = @piST_UserID  IF not exists (SELECT * FROM sysobjects WHERE id = object_id(N'[dbo].[#PRItem]') and OBJECTPROPERTY(id, N'IsUserTable') = 1)  BEGIN CREATE TABLE [dbo].[#PRItem] (  [USERID] [char] (15) NOT NULL ,  [ITEMNMBR] [char] (31) NOT NULL,  [CURNCYID] [char] (16) NOT NULL,  [UOFM] [char] (10) NOT NULL) END  DELETE FROM  #PRItem  WHERE USERID = @piST_UserID  IF @piST_Currency = @loST_FUNLCURR BEGIN  GOTO FunctCurrencyRoutines END  IF @piST_CustomerNumber IS NULL BEGIN  GOTO CurrBaseListProduct END  CurrCustomerProduct:  INSERT  INTO #PRItem (USERID,  ITEMNMBR,  CURNCYID,  UOFM)  SELECT DISTINCT @piST_UserID,  SW.ITEMNMBR,  SH.CURNCYID,  SWU.UOFM  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  WHERE SL.PRODTCOD = @piST_DorP  AND SL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR >= @piST_FromItemNumber  AND SW.ITEMNMBR <= @piST_ToItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @piST_Currency  CurrCustomerGroup:  INSERT  INTO #PRItem (USERID,  ITEMNMBR,  CURNCYID,  UOFM)  SELECT DISTINCT @piST_UserID,  GW.ITEMNMBR,  SH.CURNCYID,  SWU.UOFM  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  WHERE SL.PRODTCOD = @piST_DorP  AND SL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR >= @piST_FromItemNumber  AND GW.ITEMNMBR <= @piST_ToItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @piST_Currency  CurrPriceListProduct:  INSERT  INTO #PRItem (USERID,  ITEMNMBR,  CURNCYID,  UOFM)  SELECT DISTINCT @piST_UserID,  SW.ITEMNMBR,  SH.CURNCYID,  SWU.UOFM  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10205 as PL  ON PL.PRCBKID = SL.LINKCODE  WHERE SL.PRODTCOD = 'P'  AND PL.PRODTCOD = @piST_DorP  AND PL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR >= @piST_FromItemNumber  AND SW.ITEMNMBR <= @piST_ToItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @piST_Currency  CurrPriceListGroup:  INSERT  INTO #PRItem (USERID,  ITEMNMBR,  CURNCYID,  UOFM)  SELECT DISTINCT @piST_UserID,  GW.ITEMNMBR,  SH.CURNCYID,  SWU.UOFM  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  INNER JOIN SOP10205 as PL  ON PL.PRCBKID = SL.LINKCODE  WHERE SL.PRODTCOD = 'P'  AND PL.PRODTCOD = @piST_DorP  AND PL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR >= @piST_FromItemNumber  AND GW.ITEMNMBR <= @piST_ToItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @piST_Currency  CurrBaseListProduct:  INSERT  INTO #PRItem (USERID,  ITEMNMBR,  CURNCYID,  UOFM)  SELECT DISTINCT @piST_UserID,  SW.ITEMNMBR,  SH.CURNCYID,  SWU.UOFM  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10109 as PH  ON PH.PRCBKID = SL.LINKCODE  WHERE PH.ISBASE = 1  AND SL.PRODTCOD = 'P'  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR >= @piST_FromItemNumber  AND SW.ITEMNMBR <= @piST_ToItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @piST_Currency  CurrBaseListGroup:  INSERT  INTO #PRItem (USERID,  ITEMNMBR,  CURNCYID,  UOFM)  SELECT DISTINCT @piST_UserID,  GW.ITEMNMBR,  SH.CURNCYID,  SWU.UOFM  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10109 as PH  ON PH.PRCBKID = SL.LINKCODE  INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  WHERE PH.ISBASE = 1  AND SL.PRODTCOD = 'P'  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR >= @piST_FromItemNumber  AND GW.ITEMNMBR <= @piST_ToItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @piST_Currency  FunctCurrencyRoutines:  IF  (@piST_Currency <> @loST_FUNLCURR) AND  (@piIN_Orig_and_Funct = 0) BEGIN  GOTO CreateTempTable END  IF @piST_CustomerNumber IS NULL BEGIN  GOTO BaseListProduct END  CustomerProduct:  INSERT  INTO #PRItem (USERID,  ITEMNMBR,  CURNCYID,  UOFM)  SELECT DISTINCT @piST_UserID,  SW.ITEMNMBR,  SH.CURNCYID,  SWU.UOFM  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  WHERE SL.PRODTCOD = @piST_DorP  AND SL.LINKCODE = @piST_CustomerNumber   AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR >= @piST_FromItemNumber  AND SW.ITEMNMBR <= @piST_ToItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @loST_FUNLCURR  CustomerGroup:  INSERT  INTO #PRItem (USERID,  ITEMNMBR,  CURNCYID,  UOFM)  SELECT DISTINCT @piST_UserID,  GW.ITEMNMBR,  SH.CURNCYID,  SWU.UOFM  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  WHERE SL.PRODTCOD = @piST_DorP  AND SL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR >= @piST_FromItemNumber  AND GW.ITEMNMBR <= @piST_ToItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @loST_FUNLCURR  PriceListProduct:  INSERT  INTO #PRItem (USERID,  ITEMNMBR,  CURNCYID,  UOFM)  SELECT DISTINCT @piST_UserID,  SW.ITEMNMBR,  SH.CURNCYID,  SWU.UOFM  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10205 as PL  ON PL.PRCBKID = SL.LINKCODE  WHERE SL.PRODTCOD = 'P'  AND PL.PRODTCOD = @piST_DorP  AND PL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR >= @piST_FromItemNumber  AND SW.ITEMNMBR <= @piST_ToItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @loST_FUNLCURR  PriceListGroup:  INSERT  INTO #PRItem (USERID,  ITEMNMBR,  CURNCYID,  UOFM)  SELECT DISTINCT @piST_UserID,  GW.ITEMNMBR,  SH.CURNCYID,  SWU.UOFM  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  INNER JOIN SOP10205 as PL  ON PL.PRCBKID = SL.LINKCODE  WHERE SL.PRODTCOD = 'P'  AND PL.PRODTCOD = @piST_DorP  AND PL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR >= @piST_FromItemNumber  AND GW.ITEMNMBR <= @piST_ToItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @loST_FUNLCURR  BaseListProduct:  INSERT  INTO #PRItem (USERID,  ITEMNMBR,  CURNCYID,  UOFM)  SELECT DISTINCT @piST_UserID,  SW.ITEMNMBR,  SH.CURNCYID,  SWU.UOFM  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10109 as PH  ON PH.PRCBKID = SL.LINKCODE  WHERE PH.ISBASE = 1  AND SL.PRODTCOD = 'P'  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR >= @piST_FromItemNumber  AND SW.ITEMNMBR <= @piST_ToItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @loST_FUNLCURR  BaseListGroup:  INSERT  INTO #PRItem (USERID,  ITEMNMBR,  CURNCYID,  UOFM)  SELECT DISTINCT @piST_UserID,  GW.ITEMNMBR,  SH.CURNCYID,  SWU.UOFM  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10109 as PH  ON PH.PRCBKID = SL.LINKCODE  INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  WHERE PH.ISBASE = 1  AND SL.PRODTCOD = 'P'  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR >= @piST_FromItemNumber  AND GW.ITEMNMBR <= @piST_ToItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @loST_FUNLCURR  CreateTempTable:  SET @loST_HoldItemNumber = ' ' SET @loST_HoldUofM = ' ' SET @loST_HoldCurrency = ' '  DECLARE scItemNumbers SCROLL CURSOR FOR   SELECT ITEMNMBR,  UOFM,  CURNCYID  FROM #PRItem AS PRI  WHERE PRI.USERID = @piST_UserID  ORDER BY PRI.ITEMNMBR,  PRI.UOFM,  PRI.CURNCYID  OPEN scItemNumbers  FETCH FIRST FROM scItemNumbers   INTO @loST_ItemNumber,  @loST_UofM,  @loST_Currency  WHILE @@FETCH_STATUS = 0  BEGIN  IF (@loST_ItemNumber <> @loST_HoldItemNumber) OR (@loST_UofM <> @loST_HoldUofM)  BEGIN  EXECUTE  ExtPricingGetPromoItems  @piST_UserID,  @piST_DorP,  @piST_CustomerNumber,  @loST_ItemNumber,  @piDA_Date,  @loST_UofM,  @loST_Currency  END   SET @loST_HoldItemNumber = @loST_ItemNumber  SET @loST_HoldUofM = @loST_UofM  SET @loST_Currency =  @loST_HoldCurrency   FETCH NEXT FROM scItemNumbers  INTO @loST_ItemNumber,  @loST_UofM,  @loST_Currency  END CLOSE scItemNumbers DEALLOCATE scItemNumbers  IF (SELECT COUNT(*) FROM  SOP50400 WHERE USERID = @piST_UserID) > 0  BEGIN  SET @poIN_PromFound = 1  END ELSE  BEGIN  SET @poIN_PromFound = 0  END RETURN 0    
GO
GRANT EXECUTE ON  [dbo].[sopExtPricingGetPromosForInquiry] TO [DYNGRP]
GO
