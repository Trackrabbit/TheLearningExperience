SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[glpUpdateHistorySummary]  @I_iSQLSessionID                int                     = NULL,  @I_iAccountIndex                int                     = NULL,  @I_sAccountType         smallint                = NULL,  @I_mDebit                       numeric(19,5)    = NULL,  @I_mCredit                      numeric(19,5)    = NULL,  @I_sPeriodID                    smallint                = NULL,  @I_nLedgerID int   = NULL,  @I_sYear                                smallint                = NULL,  @O_iErrorState                  int                     = NULL  output as  declare  @HISTORY                        smallint,  @tTransaction           tinyint,  @sFiguresIndex          smallint,  @sPeriodIndex           smallint,  @iError                 int,  @iStatus                        int,  @tLoop                  tinyint,  @tCategory smallint    select   @O_iErrorState = 0  if @@trancount = 0 begin  select @tTransaction = 1  begin transaction end   while (@tLoop is NULL) begin   select @tLoop = 1   if      @I_iSQLSessionID        is NULL or  @I_iAccountIndex        is NULL or  @I_mDebit               is NULL or  @I_mCredit              is NULL or  @I_sPeriodID            is NULL or  @I_nLedgerID is NULL or  @I_sYear                        is NULL  begin  select @O_iErrorState = 20403  break  end    select @HISTORY = 2   select  @tCategory = GL00100.ACCATNUM  from  GL00100  where  GL00100.ACTINDX  = @I_iAccountIndex   if exists (  select  1  from    GL10111  where   ACTINDX  = @I_iAccountIndex  and YEAR1    = @I_sYear  and PERIODID = @I_sPeriodID  and   Ledger_ID = @I_nLedgerID)  begin  update  GL10111  set     PERDBLNC         = PERDBLNC + (@I_mDebit - @I_mCredit),  CRDTAMNT        = CRDTAMNT + @I_mCredit,  DEBITAMT        = DEBITAMT + @I_mDebit,  ACCATNUM = @tCategory  where   ACTINDX  = @I_iAccountIndex  and      YEAR1    = @I_sYear  and      PERIODID = @I_sPeriodID  and Ledger_ID = @I_nLedgerID  if @@rowcount <> 1  begin  select @O_iErrorState = 20816  break  end   end  else  begin     insert   into  GL10111(  ACTINDX,  YEAR1,  PERIODID,  Ledger_ID,  PERDBLNC,  CRDTAMNT,  DEBITAMT,  ACCATNUM)   values (  @I_iAccountIndex,  @I_sYear,  @I_sPeriodID,  @I_nLedgerID,  (@I_mDebit - @I_mCredit),   @I_mCredit,  @I_mDebit,  @tCategory)   if @@rowcount <> 1  begin  select @O_iErrorState = 20817  break  end  end  end   if @O_iErrorState <> 0 begin  if @tTransaction = 1  rollback transaction  end else if @tTransaction = 1  commit transaction  return     
GO
GRANT EXECUTE ON  [dbo].[glpUpdateHistorySummary] TO [DYNGRP]
GO
