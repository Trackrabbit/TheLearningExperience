SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[smCleanupPostingJournalEntries]   @O_iErrorState int    = NULL   output as  declare @tLoopControl tinyint,  @TRUE int,  @FALSE int,  @SMALLBLOCK int,  @LARGEBLOCK int,  @BUFFERSIZE int,  @cNormal varchar(255),  @cClearing varchar(255),  @cQuick varchar(255),  @iDeletionBlockSize int,  @cCompanyName char(64),  @iPJournalCount int,  @iRowCount              int,  @iStatus                int,  @iError int  set deadlock_priority low  select  @BUFFERSIZE = 50000,     @SMALLBLOCK = 10000,     @LARGEBLOCK = 20000,     @TRUE = 1,  @FALSE = 0  exec @iStatus = DYNAMICS..smGetConstantString  'GL_NORMAL_STR',   @cNormal output,  @O_iErrorState output  select @iError = @@error if @iStatus <> 0 or @iError <> 0 or @O_iErrorState <> 0  return (@iStatus)  exec @iStatus = DYNAMICS..smGetConstantString  'GL_CLEARING_STR',   @cClearing output,  @O_iErrorState output  select @iError = @@error if @iStatus <> 0 or @iError <> 0 or @O_iErrorState <> 0  return (@iStatus)  exec @iStatus = DYNAMICS..smGetConstantString  'GL_BUSINESS_STR',   @cQuick output,  @O_iErrorState output  select @iError = @@error if @iStatus <> 0 or @iError <> 0 or @O_iErrorState <> 0  return (@iStatus)  select @cCompanyName = CMPNYNAM  from  DYNAMICS..SY01500  where  INTERID = db_name()  select @tLoopControl = @TRUE  while @tLoopControl = @TRUE begin  if exists (select   1  from  DYNAMICS..SY00800  where  CMPNYNAM = @cCompanyName   and BCHSOURC in (@cNormal, @cClearing, @cQuick)  and POSTING = @TRUE)  begin  select   @iPJournalCount = count(1)  from  PJOURNAL   if @iPJournalCount > @BUFFERSIZE  select @iDeletionBlockSize = @SMALLBLOCK  else  break  end  else   begin  select @iDeletionBlockSize = @LARGEBLOCK  end   set rowcount @iDeletionBlockSize   delete   PJOURNAL  where  REPORT = @TRUE   if @@rowcount < @iDeletionBlockSize  select @tLoopControl = @FALSE   set rowcount 0  end  set deadlock_priority normal  return    
GO
GRANT EXECUTE ON  [dbo].[smCleanupPostingJournalEntries] TO [DYNGRP]
GO
