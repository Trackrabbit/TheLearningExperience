SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE   PROCEDURE [dbo].[FA_Intercompany_Transfer_Process]  (   @Grpname varchar(15),   @IntercomID varchar(5),   @Chk_NewAsset smallint,   @AssetID varchar(15),   @AssetSufix smallint,   @MstrID varchar(20),   @ClassID varchar(20),   @StrucID varchar(20),   @PhylocID varchar(20),   @LocID  varchar(20),   @AlasID int,   @TrnsType smallint,   @TransDate datetime,   @Des_FunCurr int,   @TransIndex int ,  @AssetQTY int,  @CashP numeric(19,5),  @NoncashP numeric(19,5),  @SpreadOption int,  @AssetNumber int,  @Dfltacct int,  @UserId varchar(20),  @Percnt numeric(19,5),  @Userdate datetime,  @Acq_Cost numeric(19,5) OUTPUT,  @Acq_Date date OUTPUT,  @Comp_ID integer OUTPUT,  @New_Asset_Index int OUTPUT,  @New_Asset_ID  varchar(15) OUTPUT  ,   @OutReslt  int OUTPUT   )   AS   declare   @AssetID_Grp varchar(15),  @AssetSufix_Grp smallint,   @SQL_Statement nvarchar(4000),   @Reslt int,@Reslt1 int,   @MaxCountParam nvarchar(500),   @Next_Asset_ID varchar(20),   @NextAssetFlg nvarchar(200),  @RecordCount nvarchar(200),  @Param  nvarchar(2000),   @NextAssetIDParam nvarchar(200),   @NextAssetIndx nvarchar(200),   @NXTASSETIDFLG1 smallint,   @Errstate int,   @Corp_BookID int,   @NXTASSETIDFLG smallint,  @FUNLCURR1 varchar(15),   @NXTASSETID varchar(15),   @NXTASSETID1 varchar(15),   @Record int,  @Record1 int,   @Desc varchar(41),   @Ext_Desc varchar(41),   @Shrt_name varchar(15),   @Type_ddl smallint,   @Ptype_ddl smallint,   @Assetlbl varchar(19),   @Manufat  varchar(25),   @INDXVALUE int,   @INDXVALUE1 int,   @Acqdate datetime,   @OriAcqdate datetime,  @AMOUNT numeric(19,5),  @XCHGRATE numeric(19,5),  @EXGTBLID varchar(15) ,  @RTCLCMTD smallint ,  @I_sViewMode smallint,  @I_sMCTrxState smallint,  @I_nDenomExchangeRate numeric(19,5),  @FROMDEPREXPACCTINDX int,  @FROMDEPRRESVACCTINDX int,  @FROMPRYRDEPRACCTINDX int,  @FROMASSETCOSTACCTINDX int,  @FROMPROCEEDSACCTINDX int,  @FROMRECGAINLOSSACCTINDX int,  @FROMNONRECGAINLOSSACCTINDX int,  @FROMCLEARACCTINDX int ,  @FROMDEPREXPACCTINDX1 int,  @FROMDEPRRESVACCTINDX1 int,  @FROMPRYRDEPRACCTINDX1 int,  @FROMASSETCOSTACCTINDX1 int,  @FROMPROCEEDSACCTINDX1 int,  @FROMRECGAINLOSSACCTINDX1 int,  @FROMNONRECGAINLOSSACCTINDX1 int,  @FROMCLEARACCTINDX1 int ,  @TODEPREXPACCTINDX int,   @TODEPRRESVACCTINDX int,   @TOPRYRDEPRACCTINDX int,   @TOASSETCOSTACCTINDX int,   @TOPROCEEDSACCTINDX int,   @TORECGAINLOSSACCTINDX int,   @TONONRECGAINLOSSACCTINDX int,   @TOCLEARACCTINDX int ,   @TODEPREXPACCTINDX1 int,   @TODEPRRESVACCTINDX1 int,   @TOPRYRDEPRACCTINDX1 int,   @TOASSETCOSTACCTINDX1 int,   @TOPROCEEDSACCTINDX1 int,   @TORECGAINLOSSACCTINDX1 int,   @TONONRECGAINLOSSACCTINDX1 int,   @TOCLEARACCTINDX1 int ,  @DEFACCTGRPINDX int,  @CMPANYID int,  @CMPANYID1 int,  @No_Of_Asset int,  @Cost_Basis numeric(19,5),  @Total_Costbasis numeric(19,5),  @Cash_Per numeric(19,5),  @NoncashP_Per numeric(19,5) ,  @Total_NBV numeric(19,5),  @NBV numeric(19,5),  @Cash_PerNBV numeric(19,5),  @NoncashP_PerNBV numeric(19,5),  @OrigAMOUNT numeric(19,5),  @FuncCurrencyOrig varchar(15),  @FunCurIndxOrig int,  @XCHGDATE datetime,  @AssetNoteIndex numeric(19,5),  @NXTASSETIDFLG_CLS smallint   BEGIN  select @CMPANYID = CMPANYID from DYNAMICS..SY01500 where INTERID = @IntercomID  exec DYNAMICS..smGetNextNoteIndex  @CMPANYID,  @@SPID,  @AssetNoteIndex output,  @Errstate output  if @Errstate <> 0   set @AssetNoteIndex = 0  set @Errstate = 0  if @Chk_NewAsset=1   BEGIN   select @SQL_Statement = 'select @CMPANYID=CMPANYID from DYNAMICS..SY01500 where INTERID='''+@IntercomID+''''   set @NextAssetFlg = N'@CMPANYID int output'   EXEC sp_executesql @SQL_Statement, @NextAssetFlg, @CMPANYID= @CMPANYID1 output   set @Comp_ID = @CMPANYID1   select @SQL_Statement = 'select  @NXTASSETIDFLG = ClassNextAssetIDFLG from '  + @IntercomID + '..FA40201 where   ASSETCLASSID = '''+ @ClassID +''''  set @NextAssetFlg = N'@NXTASSETIDFLG smallint output'   EXEC sp_executesql @SQL_Statement, @NextAssetFlg, @NXTASSETIDFLG= @NXTASSETIDFLG_CLS output   if @NXTASSETIDFLG_CLS = 0   begin  select @SQL_Statement = 'select @NXTASSETIDFLG=NXTASSETIDFLG from '  + @IntercomID + '..FA49900'   set @NextAssetFlg = N'@NXTASSETIDFLG smallint output'   EXEC sp_executesql @SQL_Statement, @NextAssetFlg, @NXTASSETIDFLG= @NXTASSETIDFLG1 output   end   if @NXTASSETIDFLG1=1 OR @NXTASSETIDFLG_CLS = 1   BEGIN   if @NXTASSETIDFLG_CLS = 1   begin  select @SQL_Statement = 'select @NXTASSETID=NXTASSETID from '  + @IntercomID + '..FA40201 where   ASSETCLASSID = '''+ @ClassID +''''   set @NextAssetIDParam = N'@NXTASSETID varchar(15) output'   EXEC sp_executesql @SQL_Statement, @NextAssetIDParam, @NXTASSETID= @NXTASSETID1 output   set @NXTASSETID= @NXTASSETID1   exec FA_Number_Inc_Dec 1,@NXTASSETID output,@Errstate output   select @SQL_Statement = 'Update '  + @IntercomID + '..FA40201 set NXTASSETID='''+ @NXTASSETID+'''where   ASSETCLASSID = '''+ @ClassID +''''   EXEC sp_executesql @SQL_Statement   end  else if  @NXTASSETIDFLG1=1  BEGIN   select @SQL_Statement = 'select @NXTASSETID=NXTASSETID from '  + @IntercomID + '..FA49900'   set @NextAssetIDParam = N'@NXTASSETID varchar(15) output'   EXEC sp_executesql @SQL_Statement, @NextAssetIDParam, @NXTASSETID= @NXTASSETID1 output   set @NXTASSETID= @NXTASSETID1  exec FA_Number_Inc_Dec 1,@NXTASSETID output,@Errstate output   select @SQL_Statement = 'Update '  + @IntercomID + '..FA49900 set NXTASSETID='''+ @NXTASSETID+''''   EXEC sp_executesql @SQL_Statement   END  select @OriAcqdate=ACQDATE,@Desc=ASSETDESC,@Ext_Desc=EXTASSETDESC,@Shrt_name=SHRTNAME,@Type_ddl=ASSETTYPE,@Ptype_ddl=PROPTYPE,@Assetlbl=Asset_Label,@Manufat=MFGRNAME from FA00100 where ASSETID=@AssetID and ASSETIDSUF=@AssetSufix   select @SQL_Statement = ' if not exists (select INDXVALUE from '  + @IntercomID + '..FAINDEX where INDXNAME=2 ) insert into '  + @IntercomID + '..FAINDEX values(2,2,1)   select @INDXVALUE=INDXVALUE+1 from '  + @IntercomID + '..FAINDEX where INDXNAME=2 '   set @NextAssetIndx = N'@INDXVALUE integer output'   EXEC sp_executesql @SQL_Statement, @NextAssetIndx, @INDXVALUE= @INDXVALUE1 output   select @SQL_Statement = 'Update '  + @IntercomID + '..FAINDEX set INDXVALUE=INDXVALUE+1 where INDXNAME=2'   EXEC sp_executesql @SQL_Statement   if @TrnsType=1 or @TrnsType=4 or @TrnsType=5 or @TrnsType=6   BEGIN   set @Acqdate=@TransDate  if @Grpname=''  BEGIN  set @AMOUNT=@CashP+@NoncashP   END  if @Grpname<>''  BEGIN  Select @Total_Costbasis=SUM(COSTBASIS) from FA00200 where BOOKINDX in (select CORPBOOKINDX from FA49900) and ASSETINDEX in (Select ASSETINDEX from FA10200 where GROUPNAME=@Grpname)  Select @Cost_Basis=COSTBASIS from FA00200 where BOOKINDX in (select CORPBOOKINDX from FA49900) and ASSETINDEX in (Select ASSETINDEX from FA10200 where ASSETID=@AssetID and ASSETIDSUF=@AssetSufix)  Select @Total_NBV=SUM(NETBOOKVALUE) from FA00200 where BOOKINDX in (select CORPBOOKINDX from FA49900) and ASSETINDEX in (Select ASSETINDEX from FA10200 where GROUPNAME=@Grpname)  Select @NBV=NETBOOKVALUE from FA00200 where BOOKINDX in (select CORPBOOKINDX from FA49900) and ASSETINDEX in (Select ASSETINDEX from FA10200 where ASSETID=@AssetID and ASSETIDSUF=@AssetSufix)   Select @No_Of_Asset=COUNT(*) from FA10200 where GROUPNAME=@Grpname  if @SpreadOption=0  BEGIN  set @AMOUNT=@CashP+@NoncashP   END  if @SpreadOption=1  BEGIN  if @AssetNumber=@No_Of_Asset  set @AMOUNT=((@CashP+@NoncashP)/@No_Of_Asset)+(@CashP+@NoncashP)%@No_Of_Asset  else   set @AMOUNT=(@CashP+@NoncashP)/@No_Of_Asset  END  if @SpreadOption=2  BEGIN  set @Cash_Per=(@Cost_Basis*@CashP)/@Total_Costbasis  set @NoncashP_Per=(@Cost_Basis*@NoncashP)/@Total_Costbasis   set @AMOUNT=@Cash_Per+@NoncashP_Per  END  if @SpreadOption=3  BEGIN  set @Cash_PerNBV=(@NBV*@CashP)/@Total_NBV  set @NoncashP_PerNBV=(@NBV*@NoncashP)/@Total_NBV   set @AMOUNT=@Cash_PerNBV+@NoncashP_PerNBV  END  END  END   if @TrnsType=2    BEGIN   set @Acqdate=@TransDate  set @AMOUNT=0.0   Select @AMOUNT=NETBOOKVALUE from FA00200 where BOOKINDX in (select CORPBOOKINDX from FA49900) and ASSETINDEX in (Select ASSETINDEX from FA00100 where ASSETID=@AssetID and ASSETIDSUF=@AssetSufix)     END   if @TrnsType=3   BEGIN   set @Acqdate=@OriAcqdate  set @AMOUNT=0.0  select @AMOUNT=Acquisition_Cost from FA00100 where ASSETID=@AssetID and ASSETIDSUF=@AssetSufix  END   set @AMOUNT=round(@AMOUNT,@Des_FunCurr,0)  SET @OrigAMOUNT = @AMOUNT  SET @XCHGDATE = '1/1/1900'   select @SQL_Statement = 'select @FUNLCURR=FUNLCURR from '  + @IntercomID + '..MC40000'   set @NextAssetFlg = N'@FUNLCURR varchar(15) output'   EXEC sp_executesql @SQL_Statement, @NextAssetFlg, @FUNLCURR= @FUNLCURR1 output  select @FuncCurrencyOrig = FUNLCURR,@FunCurIndxOrig = FUNCRIDX  from MC40000   if @FuncCurrencyOrig <> @FUNLCURR1  BEGIN  select @XCHGRATE=XCHGRATE,@EXGTBLID=EXGTBLID,@XCHGDATE = EXCHDATE from DYNAMICS..MC00100 where EXCHDATE <=@TransDate and  EXPNDATE>=@TransDate and EXGTBLID in (select EXGTBLID from DYNAMICS..MC40300 where CURNCYID=@FUNLCURR1)  select @RTCLCMTD=RTCLCMTD from DYNAMICS..MC40300 where CURNCYID=@FUNLCURR1 and EXGTBLID=@EXGTBLID  select @Des_FunCurr=DECPLCUR-1 from DYNAMICS..MC40200 where CURNCYID=@FUNLCURR1  set @I_sViewMode=1  set @I_sMCTrxState=1  set @I_nDenomExchangeRate=0.00000   Set @AMOUNT = dbo.mcFuncCalculateAmount(@RTCLCMTD,@I_sViewMode,@XCHGRATE,@I_nDenomExchangeRate,@I_sMCTrxState,@Des_FunCurr,@AMOUNT)  END  set @SQL_Statement='insert into '+ @IntercomID + '..FA00100 (ASSETINDEX,  ASSETID,ASSETIDSUF,SHRTNAME,ASSETDESC,EXTASSETDESC,Master_Asset_ID,STRUCTUREID,'+   'ASSETCLASSID,LOCATNID,ACQDATE,Acquisition_Cost,ASSETTYPE,ASSETSTATUS,PROPTYPE,ASSETQTY,ASSETBEGQTY,MFGRNAME,Physical_Location_ID,Asset_Label,DATEADDED,aaAliasID,LASTPURCHLINESEQ,LASTMNTDUSERID,NOTEINDX)values('+convert(varchar(10),@INDXVALUE1)+','''+@NXTASSETID1+''',1,'''+   @Shrt_name+''','''+@Desc+''','''+@Ext_Desc+''','''+@MstrID+''','''+@StrucID+''','''+@ClassID+''','''+@LocID+''','''+convert(varchar(10), @Acqdate, 111)+''','+convert(varchar(30),@AMOUNT)+','+convert(varchar(10),@Type_ddl)+',1,'+  convert(varchar(10),@Ptype_ddl)+','+convert(varchar(10),@AssetQTY)+','+convert(varchar(10),@AssetQTY)+','''+@Manufat+''','''+@PhylocID+''','''+@Assetlbl+''','''+convert(varchar(10),@Userdate, 111)+''','+convert(varchar(10),@AlasID)+  ',1,'''+ @UserId +''','+convert(varchar(30),@AssetNoteIndex)+')'   exec sp_executesql @SQL_Statement   set @SQL_Statement='insert into '+ @IntercomID + '..FA01400 (ASSETINDEX,PURCHLINESEQ,Acquisition_Cost,Orig_Acquisition_Cost,DOCDATE,CURNCYID,CURRNIDX,XCHGRATE,'+   'EXCHDATE,EXGTBLID) values('+convert(varchar(10),@INDXVALUE1)+',1,'+convert(varchar(30),@AMOUNT)+','+convert(varchar(30),@OrigAMOUNT)+',  '''+convert(varchar(10), @Acqdate, 111)+''','''+@FuncCurrencyOrig+''','+convert(varchar(30),@FunCurIndxOrig)+','+convert(varchar(30),ISNULL(@XCHGRATE,0))+',  '''+convert(varchar(10), @XCHGDATE, 111)+''','''+@EXGTBLID+''')'  exec sp_executesql @SQL_Statement   set @Acq_Cost=@AMOUNT  set @Acq_Date=@Acqdate  set @New_Asset_Index =@INDXVALUE1  set @New_Asset_ID =@NXTASSETID1  update FA00800 set TOASSETINDX=@INDXVALUE1 , TOASSETID=@NXTASSETID1 where TRANSFERINDX=@TransIndex  set @DEFACCTGRPINDX=@Dfltacct   select @SQL_Statement = 'select @TODEPREXPACCTINDX=DEPREXPACCTINDX,@TODEPRRESVACCTINDX=DEPRRESVACCTINDX,@TOPRYRDEPRACCTINDX=PRIORYRDEPRACCTINDX,@TOASSETCOSTACCTINDX=ASSETCOSTACCTINDX,' +   '@TOPROCEEDSACCTINDX=PROCEEDSACCTINDX,@TORECGAINLOSSACCTINDX=RECGAINLOSSACCTINDX,@TONONRECGAINLOSSACCTINDX=NONRECGAINLOSSACCTINDX,@TOCLEARACCTINDX=CLEARINGACCTINDX from '+ @IntercomID + '..FA41300 where ACCTGRPINDEX='''+ convert(varchar(10),  @DEFACCTGRPINDX)+''''   set @Param = N'@TODEPREXPACCTINDX  integer output,@TODEPRRESVACCTINDX  integer output,@TOPRYRDEPRACCTINDX  integer output,@TOASSETCOSTACCTINDX  integer output,@TOPROCEEDSACCTINDX  integer output,'+   '@TORECGAINLOSSACCTINDX  integer output,@TONONRECGAINLOSSACCTINDX integer output,@TOCLEARACCTINDX integer output'   EXEC sp_executesql @SQL_Statement, @Param, @TODEPREXPACCTINDX= @TODEPREXPACCTINDX1 output ,@TODEPRRESVACCTINDX=@TODEPRRESVACCTINDX1  output,@TOPRYRDEPRACCTINDX=@TOPRYRDEPRACCTINDX1 output,@TOASSETCOSTACCTINDX=@TOASSETCOSTACCTINDX1 output,@TOPROCEEDSACCTINDX=@TOPROCEEDSACCTINDX1 output,   @TORECGAINLOSSACCTINDX=@TORECGAINLOSSACCTINDX1 output,@TONONRECGAINLOSSACCTINDX=@TONONRECGAINLOSSACCTINDX1 output,@TOCLEARACCTINDX=@TOCLEARACCTINDX1 output   update FA00800 set TODEPREXPACCTINDX=isnull(@TODEPREXPACCTINDX1,0),TODEPRRESVACCTINDX=isnull(@TODEPRRESVACCTINDX1,0),TOPRYRDEPRACCTINDX=isnull(@TOPRYRDEPRACCTINDX1,0),TOASSETCOSTACCTINDX=isnull(@TOASSETCOSTACCTINDX1,0),TOPROCEEDSACCTINDX=isnull(@TOPROCEEDSACCTINDX1,0),   TORECGAINLOSSACCTINDX=isnull(@TORECGAINLOSSACCTINDX1,0),TONONRECGAINLOSSACCTINDX=isnull(@TONONRECGAINLOSSACCTINDX1,0),TOCLEARACCTINDX=isnull(@TOCLEARACCTINDX1,0) where TRANSFERINDX=@TransIndex   select @SQL_Statement = 'select @Record=count(*) from '  + @IntercomID + '..FA00400 where ASSETINDEX='''+convert(varchar(10),@INDXVALUE1)+''''   set @RecordCount = N'@Record integer output'   EXEC sp_executesql @SQL_Statement, @RecordCount, @Record= @Record1 output   if @Record1=0   set @SQL_Statement=''  BEGIN  set @SQL_Statement='insert into '+ @IntercomID + '..FA00400 ([ASSETINDEX],[DEPREXPACCTINDX] ,[DEPRRESVACCTINDX],[PRIORYRDEPRACCTINDX],[ASSETCOSTACCTINDX],[PROCEEDSACCTINDX],[RECGAINLOSSACCTINDX]'+  ',[NONRECGAINLOSSACCTINDX],[CLEARINGACCTINDX],[NOTEINDX],[LASTMNTDDATE],[LASTMNTDTIME],[LASTMNTDUSERID]) values ('+convert(varchar(10),@INDXVALUE1)+','+convert(varchar(4),isnull(@TODEPREXPACCTINDX1,0))+','+convert(varchar(4),isnull(@TODEPRRESVACCTINDX1,0))+','+convert(varchar(4),isnull(@TOPRYRDEPRACCTINDX1,0))+','+  +convert(varchar(4),isnull(@TOASSETCOSTACCTINDX1,0))+','+convert(varchar(4),isnull(@TOPROCEEDSACCTINDX1,0))+','+convert(varchar(4),isnull(@TORECGAINLOSSACCTINDX1,0))+','+convert(varchar(4),isnull(@TONONRECGAINLOSSACCTINDX1,0))+','+convert(varchar(4),isnull(@TOCLEARACCTINDX1,0))+','+  convert(varchar(4),0.0)+','+convert(varchar(10),convert(date,sysdatetime()))+','''+convert(varchar(10),convert(time,sysdatetime()))+''','''+@UserId+''')'  exec sp_executesql @SQL_Statement   END     select @FROMDEPREXPACCTINDX=DEPREXPACCTINDX,@FROMDEPRRESVACCTINDX=DEPRRESVACCTINDX,@FROMPRYRDEPRACCTINDX=PRIORYRDEPRACCTINDX,@FROMASSETCOSTACCTINDX=ASSETCOSTACCTINDX,@FROMPROCEEDSACCTINDX=PROCEEDSACCTINDX,@FROMRECGAINLOSSACCTINDX=RECGAINLOSSACCTINDX,@FROMNONRECGAINLOSSACCTINDX=NONRECGAINLOSSACCTINDX,  @FROMCLEARACCTINDX=CLEARINGACCTINDX from FA41300 where ACCTGRPINDEX in( select DEFACCTGRPINDX from FA40201 where ASSETCLASSID in(select ASSETCLASSID from FA00100 where  ASSETID=@AssetID and ASSETIDSUF=@AssetSufix))  update FA00800 set FROMDEPREXPACCTINDX=isnull(@FROMDEPREXPACCTINDX,0),FROMDEPRRESVACCTINDX=isnull(@FROMDEPRRESVACCTINDX,0),FROMPRYRDEPRACCTINDX=isnull(@FROMPRYRDEPRACCTINDX,0),FROMASSETCOSTACCTINDX=isnull(@FROMASSETCOSTACCTINDX,0),FROMPROCEEDSACCTINDX=isnull(@FROMPROCEEDSACCTINDX,0),   FROMRECGAINLOSSACCTINDX=isnull(@FROMRECGAINLOSSACCTINDX,0),FROMNONRECGAINLOSSACCTINDX=isnull(@FROMNONRECGAINLOSSACCTINDX,0),FROMCLEARACCTINDX=isnull(@FROMCLEARACCTINDX,0) where TRANSFERINDX=@TransIndex   END   END   ELSE  BEGIN  select @OriAcqdate=ACQDATE,@Desc=ASSETDESC,@Ext_Desc=EXTASSETDESC,@Shrt_name=SHRTNAME,@Type_ddl=ASSETTYPE,@Ptype_ddl=PROPTYPE,@Assetlbl=Asset_Label,@Manufat=MFGRNAME from FA00100 where ASSETID=@AssetID and ASSETIDSUF=@AssetSufix   select @SQL_Statement = 'if not exists (select INDXVALUE from '  + @IntercomID + '..FAINDEX where INDXNAME=2 ) insert into '  + @IntercomID + '..FAINDEX values(2,2,1) select @INDXVALUE=INDXVALUE+1 from '  + @IntercomID + '..FAINDEX where INDXNAME=2 '   set @NextAssetIndx = N'@INDXVALUE integer output'   EXEC sp_executesql @SQL_Statement, @NextAssetIndx, @INDXVALUE= @INDXVALUE1 output   select @SQL_Statement = 'Update '  + @IntercomID + '..FAINDEX set INDXVALUE=INDXVALUE+1 where INDXNAME=2'   EXEC sp_executesql @SQL_Statement   if @TrnsType=1 or @TrnsType=4 or @TrnsType=5 or @TrnsType=6   BEGIN   set @Acqdate=@TransDate  if @Grpname=''  BEGIN  set @AMOUNT=@CashP+@NoncashP   END  if @Grpname<>''  BEGIN  Select @Total_Costbasis=SUM(COSTBASIS) from FA00200 where BOOKINDX in (select CORPBOOKINDX from FA49900) and ASSETINDEX in (Select ASSETINDEX from FA10200 where GROUPNAME=@Grpname)  Select @Cost_Basis=COSTBASIS from FA00200 where BOOKINDX in (select CORPBOOKINDX from FA49900) and ASSETINDEX in (Select ASSETINDEX from FA10200 where ASSETID=@AssetID and ASSETIDSUF=@AssetSufix)  Select @Total_NBV=SUM(NETBOOKVALUE) from FA00200 where BOOKINDX in (select CORPBOOKINDX from FA49900) and ASSETINDEX in (Select ASSETINDEX from FA10200 where GROUPNAME=@Grpname)  Select @NBV=NETBOOKVALUE from FA00200 where BOOKINDX in (select CORPBOOKINDX from FA49900) and ASSETINDEX in (Select ASSETINDEX from FA10200 where ASSETID=@AssetID and ASSETIDSUF=@AssetSufix)   Select @No_Of_Asset=COUNT(*) from FA10200 where GROUPNAME=@Grpname  if @SpreadOption=0  BEGIN  set @AMOUNT=@CashP+@NoncashP   END  if @SpreadOption=1  BEGIN  if @AssetNumber=@No_Of_Asset  set @AMOUNT=((@CashP+@NoncashP)/@No_Of_Asset)+(@CashP+@NoncashP)%@No_Of_Asset  else   set @AMOUNT=(@CashP+@NoncashP)/@No_Of_Asset  END  if @SpreadOption=2  BEGIN  set @Cash_Per=(@Cost_Basis*@CashP)/@Total_Costbasis  set @NoncashP_Per=(@Cost_Basis*@NoncashP)/@Total_Costbasis   set @AMOUNT=@Cash_Per+@NoncashP_Per  END  if @SpreadOption=3  BEGIN  set @Cash_PerNBV=(@NBV*@CashP)/@Total_NBV  set @NoncashP_PerNBV=(@NBV*@NoncashP)/@Total_NBV   set @AMOUNT=@Cash_PerNBV+@NoncashP_PerNBV  END  END  END   if @TrnsType=2    BEGIN   set @Acqdate=@TransDate  set @AMOUNT=0.0   Select @AMOUNT=NETBOOKVALUE from FA00200 where BOOKINDX in (select CORPBOOKINDX from FA49900) and ASSETINDEX in (Select ASSETINDEX from FA00100 where ASSETID=@AssetID and ASSETIDSUF=@AssetSufix)  END   if @TrnsType=3   BEGIN   set @Acqdate=@OriAcqdate  set @AMOUNT=0.0  select @AMOUNT=Acquisition_Cost from FA00100 where ASSETID=@AssetID and ASSETIDSUF=@AssetSufix  END   set @AMOUNT=round(@AMOUNT,@Des_FunCurr,0)  SET @OrigAMOUNT = @AMOUNT   SET @XCHGDATE = '1/1/1900'  select @SQL_Statement = 'select @FUNLCURR=FUNLCURR from '  + @IntercomID + '..MC40000'   set @NextAssetFlg = N'@FUNLCURR varchar(15) output'   EXEC sp_executesql @SQL_Statement, @NextAssetFlg, @FUNLCURR= @FUNLCURR1 output   select @FuncCurrencyOrig = FUNLCURR,@FunCurIndxOrig = FUNCRIDX  from MC40000   if @FuncCurrencyOrig <> @FUNLCURR1  BEGIN  select @XCHGRATE=XCHGRATE,@EXGTBLID=EXGTBLID from DYNAMICS..MC00100 where EXCHDATE <=@TransDate and  EXPNDATE>=@TransDate and EXGTBLID in (select EXGTBLID from DYNAMICS..MC40300 where CURNCYID=@FUNLCURR1)  select @RTCLCMTD=RTCLCMTD from DYNAMICS..MC40300 where CURNCYID=@FUNLCURR1 and EXGTBLID=@EXGTBLID  set @I_sViewMode=1  set @I_sMCTrxState=1  set @I_nDenomExchangeRate=0.00000  set @Des_FunCurr=2   Set @AMOUNT = dbo.mcFuncCalculateAmount(@RTCLCMTD,@I_sViewMode,@XCHGRATE,@I_nDenomExchangeRate,@I_sMCTrxState,@Des_FunCurr,@AMOUNT)  END   set @SQL_Statement='insert into '+ @IntercomID + '..FA00100 (ASSETINDEX,  ASSETID,ASSETIDSUF,SHRTNAME,ASSETDESC,EXTASSETDESC,Master_Asset_ID,STRUCTUREID,'+   'ASSETCLASSID,LOCATNID,ACQDATE,Acquisition_Cost,ASSETTYPE,ASSETSTATUS,PROPTYPE,ASSETQTY,ASSETBEGQTY,MFGRNAME,Physical_Location_ID,Asset_Label,DATEADDED,aaAliasID,LASTPURCHLINESEQ,LASTMNTDUSERID,NOTEINDX)values('+convert(varchar(10),@INDXVALUE1)+','''+@AssetID+''',1,'''+   @Shrt_name+''','''+@Desc+''','''+@Ext_Desc+''','''+@MstrID+''','''+@StrucID+''','''+@ClassID+''','''+@LocID+''','''+convert(varchar(10), @Acqdate, 111)+''','+convert(varchar(30),@AMOUNT)+','+convert(varchar(10),@Type_ddl)+',1,'+  convert(varchar(10),@Ptype_ddl)+','+convert(varchar(10),@AssetQTY)+','+convert(varchar(10),@AssetQTY)+','''+@Manufat+''','''+@PhylocID+''','''+@Assetlbl+''','''+convert(varchar(10),@Userdate, 111)+''','+convert(varchar(10),@AlasID)+  ',1,'''+ @UserId +''','+convert(varchar(30),@AssetNoteIndex)+')'   exec sp_executesql @SQL_Statement   set @SQL_Statement='insert into '+ @IntercomID + '..FA01400 (ASSETINDEX,PURCHLINESEQ,Acquisition_Cost,Orig_Acquisition_Cost,DOCDATE,CURNCYID,CURRNIDX,XCHGRATE,'+   'EXCHDATE,EXGTBLID) values('+convert(varchar(10),@INDXVALUE1)+',1,'+convert(varchar(30),@AMOUNT)+','+convert(varchar(30),@OrigAMOUNT)+',  '''+convert(varchar(10), @Acqdate, 111)+''','''+@FuncCurrencyOrig+''','+convert(varchar(30),@FunCurIndxOrig)+','+convert(varchar(30),ISNULL(@XCHGRATE,0))+',  '''+convert(varchar(10), @XCHGDATE, 111)+''','''+@EXGTBLID+''')'  exec sp_executesql @SQL_Statement   set @Acq_Cost=@AMOUNT  set @Acq_Date=@Acqdate  set @New_Asset_Index =@INDXVALUE1  set @New_Asset_ID =@AssetID  update FA00800 set TOASSETINDX=@INDXVALUE1 , TOASSETID=@AssetID where TRANSFERINDX=@TransIndex  set @DEFACCTGRPINDX=@Dfltacct  select @SQL_Statement = 'select @TODEPREXPACCTINDX=DEPREXPACCTINDX,@TODEPRRESVACCTINDX=DEPRRESVACCTINDX,@TOPRYRDEPRACCTINDX=PRIORYRDEPRACCTINDX,@TOASSETCOSTACCTINDX=ASSETCOSTACCTINDX,' +   '@TOPROCEEDSACCTINDX=PROCEEDSACCTINDX,@TORECGAINLOSSACCTINDX=RECGAINLOSSACCTINDX,@TONONRECGAINLOSSACCTINDX=NONRECGAINLOSSACCTINDX,@TOCLEARACCTINDX=CLEARINGACCTINDX from '+ @IntercomID + '..FA41300 where ACCTGRPINDEX='''+ convert(varchar(10),@DEFACCTGRPINDX)+''''   set @Param = N'@TODEPREXPACCTINDX  integer output,@TODEPRRESVACCTINDX  integer output,@TOPRYRDEPRACCTINDX  integer output,@TOASSETCOSTACCTINDX  integer output,@TOPROCEEDSACCTINDX  integer output,'+   '@TORECGAINLOSSACCTINDX  integer output,@TONONRECGAINLOSSACCTINDX integer output,@TOCLEARACCTINDX integer output'   EXEC sp_executesql @SQL_Statement, @Param, @TODEPREXPACCTINDX= @TODEPREXPACCTINDX1 output ,@TODEPRRESVACCTINDX=@TODEPRRESVACCTINDX1  output,@TOPRYRDEPRACCTINDX=@TOPRYRDEPRACCTINDX1 output,@TOASSETCOSTACCTINDX=@TOASSETCOSTACCTINDX1 output,@TOPROCEEDSACCTINDX=@TOPROCEEDSACCTINDX1 output,   @TORECGAINLOSSACCTINDX=@TORECGAINLOSSACCTINDX1 output,@TONONRECGAINLOSSACCTINDX=@TONONRECGAINLOSSACCTINDX1 output,@TOCLEARACCTINDX=@TOCLEARACCTINDX1 output   update FA00800 set TODEPREXPACCTINDX=isnull(@TODEPREXPACCTINDX1,0),TODEPRRESVACCTINDX=isnull(@TODEPRRESVACCTINDX1,0),TOPRYRDEPRACCTINDX=isnull(@TOPRYRDEPRACCTINDX1,0),TOASSETCOSTACCTINDX=isnull(@TOASSETCOSTACCTINDX1,0),TOPROCEEDSACCTINDX=isnull(@TOPROCEEDSACCTINDX1,0),   TORECGAINLOSSACCTINDX=isnull(@TORECGAINLOSSACCTINDX1,0),TONONRECGAINLOSSACCTINDX=isnull(@TONONRECGAINLOSSACCTINDX1,0),TOCLEARACCTINDX=isnull(@TOCLEARACCTINDX1,0) where TRANSFERINDX=@TransIndex   select @SQL_Statement = 'select @Record=count(*) from '  + @IntercomID + '..FA00400 where ASSETINDEX='''+convert(varchar(10),@INDXVALUE1)+''''   set @RecordCount = N'@Record integer output'   EXEC sp_executesql @SQL_Statement, @RecordCount, @Record= @Record1 output   if @Record1=0   set @SQL_Statement=''  BEGIN   set @SQL_Statement='insert into '+ @IntercomID + '..FA00400 ([ASSETINDEX],[DEPREXPACCTINDX] ,[DEPRRESVACCTINDX],[PRIORYRDEPRACCTINDX],[ASSETCOSTACCTINDX],[PROCEEDSACCTINDX],[RECGAINLOSSACCTINDX]'+  ',[NONRECGAINLOSSACCTINDX],[CLEARINGACCTINDX],[NOTEINDX],[LASTMNTDDATE],[LASTMNTDTIME],[LASTMNTDUSERID]) values ('+convert(varchar(10),@INDXVALUE1)+','+convert(varchar(4),isnull(@TODEPREXPACCTINDX1,0))+','+convert(varchar(4),isnull(@TODEPRRESVACCTINDX1,0))+','+convert(varchar(4),isnull(@TOPRYRDEPRACCTINDX1,0))+','+  +convert(varchar(4),isnull(@TOASSETCOSTACCTINDX1,0))+','+convert(varchar(4),isnull(@TOPROCEEDSACCTINDX1,0))+','+convert(varchar(4),isnull(@TORECGAINLOSSACCTINDX1,0))+','+convert(varchar(4),isnull(@TONONRECGAINLOSSACCTINDX1,0))+','+convert(varchar(4),isnull(@TOCLEARACCTINDX1,0))+','+  convert(varchar(4),0.0)+','+convert(varchar(10),convert(date,sysdatetime()))+','''+convert(varchar(10),convert(time,sysdatetime()))+''','''+@UserId+''')'  exec sp_executesql @SQL_Statement   END  select @FROMDEPREXPACCTINDX=DEPREXPACCTINDX,@FROMDEPRRESVACCTINDX=DEPRRESVACCTINDX,@FROMPRYRDEPRACCTINDX=PRIORYRDEPRACCTINDX,@FROMASSETCOSTACCTINDX=ASSETCOSTACCTINDX,@FROMPROCEEDSACCTINDX=PROCEEDSACCTINDX,@FROMRECGAINLOSSACCTINDX=RECGAINLOSSACCTINDX,@FROMNONRECGAINLOSSACCTINDX=NONRECGAINLOSSACCTINDX,  @FROMCLEARACCTINDX=CLEARINGACCTINDX from FA41300 where ACCTGRPINDEX in( select DEFACCTGRPINDX from FA40201 where ASSETCLASSID in(select ASSETCLASSID from FA00100 where  ASSETID=@AssetID and ASSETIDSUF=@AssetSufix))  update FA00800 set FROMDEPREXPACCTINDX=isnull(@FROMDEPREXPACCTINDX,0),FROMDEPRRESVACCTINDX=isnull(@FROMDEPRRESVACCTINDX,0),FROMPRYRDEPRACCTINDX=isnull(@FROMPRYRDEPRACCTINDX,0),FROMASSETCOSTACCTINDX=isnull(@FROMASSETCOSTACCTINDX,0),FROMPROCEEDSACCTINDX=isnull(@FROMPROCEEDSACCTINDX,0),   FROMRECGAINLOSSACCTINDX=isnull(@FROMRECGAINLOSSACCTINDX,0),FROMNONRECGAINLOSSACCTINDX=isnull(@FROMNONRECGAINLOSSACCTINDX,0),FROMCLEARACCTINDX=isnull(@FROMCLEARACCTINDX,0) where TRANSFERINDX=@TransIndex    END   END     
GO
GRANT EXECUTE ON  [dbo].[FA_Intercompany_Transfer_Process] TO [DYNGRP]
GO
