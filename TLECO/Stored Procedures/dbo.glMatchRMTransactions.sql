SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[glMatchRMTransactions]  @iGLTempTable varchar(50),  @iRMTempTable varchar(50),  @iRMMatchTable varchar(50),  @iGLMatchTable varchar(50)  AS  DECLARE  @lSQLError int  EXEC(  'SELECT  POSTEDDT,  CUSTNMBR,  TRXSORCE,  DOCNUMBR,  STRVAL,  ACCTAMNT,  TRX_ID,  RMDTYPAL,  ' + @iRMTempTable + '.HISTRX  INTO  ##RMDetailTemp  FROM ' +  @iRMTempTable + ' JOIN ' + @iGLTempTable + '  ON  POSTEDDT = TRXDATE  AND  TRXSORCE = ORTRXSRC  AND  DOCNUMBR = ORCTRNUM   GROUP BY  POSTEDDT,  CUSTNMBR,  TRXSORCE,  DOCNUMBR,  STRVAL,  ACCTAMNT,  TRX_ID,  RMDTYPAL,  ' + @iRMTempTable + '.HISTRX ')  EXEC(  'SELECT  TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT,  ' + @iGLTempTable + '.HISTRX,  ' + @iGLTempTable + '.YEAR1,  ' + @iGLTempTable + '.RCTRXSEQ  INTO  ##GLDetailTemp  FROM ' +  @iGLTempTable + ' JOIN ' + @iRMTempTable + '  ON  TRXDATE = POSTEDDT  AND  ORTRXSRC = TRXSORCE   AND  ORCTRNUM = DOCNUMBR  GROUP BY  TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,   ACTINDX,  DEBITAMT,  CRDTAMNT,  ' + @iGLTempTable + '.HISTRX,  ' + @iGLTempTable + '.YEAR1,  ' + @iGLTempTable + '.RCTRXSEQ ')  EXEC(  'INSERT INTO   ##RMDetailTemp  SELECT  POSTEDDT,  CUSTNMBR,  TRXSORCE,  DOCNUMBR,  STRVAL,  ACCTAMNT,  TRX_ID,   RMDTYPAL,  ' + @iRMTempTable + '.HISTRX  FROM ' +  @iRMTempTable + ' JOIN ' + @iGLTempTable + '  ON  POSTEDDT = TRXDATE  AND  TRXSORCE = ORTRXSRC  AND  ORCTRNUM = ''''  GROUP BY  POSTEDDT,  CUSTNMBR,  TRXSORCE,  DOCNUMBR,  STRVAL,  ACCTAMNT,  TRX_ID,  RMDTYPAL,  ' + @iRMTempTable + '.HISTRX ')  EXEC(  'INSERT INTO  ##GLDetailTemp  SELECT  TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT,  ' + @iGLTempTable + '.HISTRX,  ' + @iGLTempTable + '.YEAR1,  ' + @iGLTempTable + '.RCTRXSEQ  FROM ' +  @iGLTempTable + ' JOIN ' + @iRMTempTable + '  ON  TRXDATE = POSTEDDT  AND  ORTRXSRC = TRXSORCE   AND  ORCTRNUM = ''''  GROUP BY  TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,   ACTINDX,  DEBITAMT,  CRDTAMNT,  ' + @iGLTempTable + '.HISTRX,  ' + @iGLTempTable + '.YEAR1,  ' + @iGLTempTable + '.RCTRXSEQ ')  EXEC(  'INSERT INTO   ##RMDetailTemp  SELECT  A.POSTEDDT,  A.CUSTNMBR,  A.TRXSORCE,  A.DOCNUMBR,  A.STRVAL,  A.ACCTAMNT,  A.TRX_ID,  A.RMDTYPAL,  A.HISTRX  FROM ' +  @iRMTempTable + ' AS A JOIN ##RMDetailTemp AS B  ON   A.TRXSORCE = B.TRXSORCE  AND  A.DOCNUMBR <> B.DOCNUMBR  WHERE  A.RMDTYPAL = 9  AND  (A.TRXSORCE LIKE ''RMSLS%''  OR   A.TRXSORCE LIKE ''INVCE%''  OR   A.TRXSORCE LIKE ''SLSTE%'')  GROUP BY  A.POSTEDDT,  A.CUSTNMBR,  A.TRXSORCE,  A.DOCNUMBR,  A.STRVAL,  A.ACCTAMNT,  A.TRX_ID,  A.RMDTYPAL,  A.HISTRX ')  SELECT  TRXSORCE,  SUM(ACCTAMNT) AS ACCTAMNT  INTO  #RMSumTemp FROM  ##RMDetailTemp GROUP BY  TRXSORCE   SELECT  ORTRXSRC,  (SUM(DEBITAMT) - SUM(CRDTAMNT)) AS GLAMNT INTO  #GLSumTemp FROM  ##GLDetailTemp GROUP BY  ORTRXSRC  SELECT  TRXSORCE INTO  #TRXRemoveTemp FROM  #RMSumTemp JOIN #GLSumTemp  ON  TRXSORCE = ORTRXSRC  AND  ACCTAMNT <> GLAMNT  DELETE  #RMSumTemp FROM  #RMSumTemp JOIN #GLSumTemp  ON  TRXSORCE = ORTRXSRC  AND  ACCTAMNT <> GLAMNT  DELETE  #GLSumTemp FROM  #GLSumTemp JOIN #TRXRemoveTemp  ON  ORTRXSRC = TRXSORCE  EXEC(  'INSERT INTO ' +  @iRMMatchTable +  ' (POSTEDDT,  CUSTNMBR,  TRXSORCE,  DOCNUMBR,  STRVAL,  ACCTAMNT,  TRX_ID,  RMDTYPAL,  CustomerNumberDrillback,  DocumentNumberDrillback)  SELECT  POSTEDDT,  CUSTNMBR,  ##RMDetailTemp.TRXSORCE,  DOCNUMBR,  STRVAL,  ##RMDetailTemp.ACCTAMNT,  TRX_ID,  RMDTYPAL,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppCustomerID(1,CUSTNMBR),  case HISTRX   when 1 then  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppReceivablesTransactionNumber(1,RMDTYPAL,CUSTNMBR,DOCNUMBR,3,##RMDetailTemp.TRXSORCE,'''',1,-1 )  else  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppReceivablesTransactionNumber(1,RMDTYPAL,CUSTNMBR,DOCNUMBR,2,##RMDetailTemp.TRXSORCE,'''',1,-1 )  end  FROM  ##RMDetailTemp JOIN #RMSumTemp   ON  ##RMDetailTemp.TRXSORCE  = #RMSumTemp.TRXSORCE ')  EXEC(  'INSERT INTO ' +  @iGLMatchTable +  ' (TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT,  AccountNumberDrillback,  JournalEntryDrillback)  SELECT  TRXDATE,  JRNENTRY,  ##GLDetailTemp.ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppAccountIndex(1,ACTINDX),  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppJournalInquiry(1,JRNENTRY,RCTRXSEQ,YEAR1,TRXDATE)  FROM  ##GLDetailTemp JOIN #GLSumTemp  ON  ##GLDetailTemp.ORTRXSRC = #GLSumTemp.ORTRXSRC ')  EXEC(  'DELETE   FROM ' +   @iRMTempTable +   ' WHERE EXISTS (select 1 from ' + @iRMMatchTable +   ' where TRXSORCE = ' + @iRMTempTable + '.TRXSORCE ' +  ' AND DOCNUMBR = ' + @iRMTempTable + '.DOCNUMBR ' +  ' AND RMDTYPAL = ' + @iRMTempTable + '.RMDTYPAL)')  EXEC(   'DELETE   FROM ' + @iGLTempTable +   ' WHERE EXISTS (select 1 from ' + @iGLMatchTable +   ' where ORTRXSRC = ' + @iGLTempTable + '.ORTRXSRC ' +  ' AND ORCTRNUM = ' + @iGLTempTable + '.ORCTRNUM)')  DROP TABLE  ##RMDetailTemp,  ##GLDetailTemp  RETURN (@lSQLError)    
GO
GRANT EXECUTE ON  [dbo].[glMatchRMTransactions] TO [DYNGRP]
GO
