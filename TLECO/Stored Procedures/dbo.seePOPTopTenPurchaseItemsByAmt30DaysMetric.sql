SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[seePOPTopTenPurchaseItemsByAmt30DaysMetric]   @UserDate datetime = NULL,  @I_iNumItems int   = NULL,  @I_iPeriodDays int   = NULL,  @Buyer varchar(max),  @Vendor varchar(max),  @ItemNumber varchar(max)   as set nocount ON  declare @dtStart datetime declare @dtEnd datetime  declare @ValuesTable table (Value nvarchar(500))  if (@Buyer != '') begin  insert into @ValuesTable select * from dbo.seeSplitString(@Buyer, ',') end else if (@Vendor != '') begin  insert into @ValuesTable select * from dbo.seeSplitString(@Vendor, ',') end else begin  insert into @ValuesTable select * from dbo.seeSplitString(@ItemNumber, ',') end  select  @UserDate = DATEADD(HOUR, -DATEPART(HOUR, @UserDate), @UserDate) select  @UserDate = DATEADD(MINUTE, -DATEPART(MINUTE, @UserDate), @UserDate) select  @UserDate = DATEADD(SECOND, -DATEPART(SECOND, @UserDate), @UserDate) select  @UserDate = DATEADD(MILLISECOND, -DATEPART(MILLISECOND, @UserDate), @UserDate)  set @dtEnd = @UserDate - 1  set @dtStart = @dtEnd - @I_iPeriodDays  CREATE TABLE dbo.#ItemQtys (ITEMNMBR char(31) NOT NULL,   QTYSHPPD numeric(19,5),   UNITCOST numeric(19,5),  Filter varchar(31))   CREATE INDEX AK2#ItemQtys ON #ItemQtys (ITEMNMBR)   if @Buyer = '' and @Vendor = '' and @ItemNumber = '' begin  insert #ItemQtys (ITEMNMBR, QTYSHPPD, UNITCOST, Filter)   select RcptApply.ITEMNMBR as Item,   RcptApply.QTYSHPPD as Qty,   LineHist.UNITCOST as UnitCost ,  '' as Filter  from POP30310 as LineHist with (NOLOCK), POP10500 as RcptApply with (NOLOCK)   where (RcptApply.Status = 1) and   (RcptApply.DATERECD >= @dtStart and RcptApply.DATERECD <= @dtEnd) and   (RcptApply.POPRCTNM = LineHist.POPRCTNM and RcptApply.RCPTLNNM = LineHist.RCPTLNNM) and   (RcptApply.QTYSHPPD > 0) and   (RcptApply.POPTYPE = 1 or RcptApply.POPTYPE = 3)    Insert #ItemQtys (ITEMNMBR, QTYSHPPD, UNITCOST, Filter)   select RcptApply.ITEMNMBR as Item,   RcptApply.QTYINVCD as Qty,   LineHist.UNITCOST as UnitCost,  '' as Filter   from POP30310 as LineHist with (NOLOCK), POP10500 as RcptApply with (NOLOCK)   where (RcptApply.Status = 1) and   (RcptApply.DATERECD >= @dtStart  and RcptApply.DATERECD <= @dtEnd) and   (RcptApply.POPRCTNM = LineHist.POPRCTNM and RcptApply.RCPTLNNM = LineHist.RCPTLNNM) and   (RcptApply.QTYINVCD > 0) and   (RcptApply.POPTYPE = 2) and   (exists (select * from POP10100 as POWork   where ( RcptApply.PONUMBER <> '' and RcptApply.PONUMBER = POWork.PONUMBER and   (POWork.POTYPE = 2 or POWork.POTYPE = 4))) or   exists (select * from POP30100 as POHist where   (RcptApply.PONUMBER <> '' and RcptApply.PONUMBER = POHist.PONUMBER and   (POHist.POTYPE = 2 or POHist.POTYPE = 4)))) end else begin  if @Buyer <> ''  begin  insert #ItemQtys (ITEMNMBR, QTYSHPPD, UNITCOST, Filter)   select RcptApply.ITEMNMBR as Item,   RcptApply.QTYSHPPD as Qty,   LineHist.UNITCOST as UnitCost ,  BUYERID as Filter  from POP30310 as LineHist with (NOLOCK),   POP10500 as RcptApply with (NOLOCK) ,  POP10100 as POWork with (NOLOCK)  where (RcptApply.Status = 1) and   (RcptApply.DATERECD >= @dtStart and RcptApply.DATERECD <= @dtEnd) and   (RcptApply.POPRCTNM = LineHist.POPRCTNM and RcptApply.RCPTLNNM = LineHist.RCPTLNNM) and   (RcptApply.QTYSHPPD > 0) and   (RcptApply.POPTYPE = 1 or RcptApply.POPTYPE = 3)   and RcptApply.PONUMBER <> '' and RcptApply.PONUMBER = POWork.PONUMBER and (POWork.POTYPE = 1 or POWork.POTYPE = 3)    insert #ItemQtys (ITEMNMBR, QTYSHPPD, UNITCOST, Filter)   select RcptApply.ITEMNMBR as Item,   RcptApply.QTYSHPPD as Qty,   LineHist.UNITCOST as UnitCost ,  BUYERID as Filter  from POP30310 as LineHist with (NOLOCK),   POP10500 as RcptApply with (NOLOCK) ,  POP30100 as POHist with (NOLOCK)   where (RcptApply.Status = 1) and   (RcptApply.DATERECD >= @dtStart and RcptApply.DATERECD <= @dtEnd) and   (RcptApply.POPRCTNM = LineHist.POPRCTNM and RcptApply.RCPTLNNM = LineHist.RCPTLNNM) and   (RcptApply.QTYSHPPD > 0) and   (RcptApply.POPTYPE = 1 or RcptApply.POPTYPE = 3)   and RcptApply.PONUMBER <> '' and RcptApply.PONUMBER = POHist.PONUMBER and (POHist.POTYPE = 1 or POHist.POTYPE = 3)    Insert #ItemQtys (ITEMNMBR, QTYSHPPD, UNITCOST, Filter)   select RcptApply.ITEMNMBR as Item,   RcptApply.QTYINVCD as Qty,   LineHist.UNITCOST as UnitCost,  BUYERID as Filter   from POP30310 as LineHist with (NOLOCK),   POP10500 as RcptApply with (NOLOCK),  POP10100 as POWork with (NOLOCK)  where (RcptApply.Status = 1) and   (RcptApply.DATERECD >= @dtStart  and RcptApply.DATERECD <= @dtEnd) and   (RcptApply.POPRCTNM = LineHist.POPRCTNM and RcptApply.RCPTLNNM = LineHist.RCPTLNNM) and   (RcptApply.QTYINVCD > 0) and   (RcptApply.POPTYPE = 2) and   (RcptApply.POPTYPE = 2) and RcptApply.PONUMBER <> '' and RcptApply.PONUMBER = POWork.PONUMBER and (POWork.POTYPE = 2 or POWork.POTYPE = 4)    Insert #ItemQtys (ITEMNMBR, QTYSHPPD, UNITCOST, Filter)   select RcptApply.ITEMNMBR as Item,   RcptApply.QTYINVCD as Qty,   LineHist.UNITCOST as UnitCost,  BUYERID as Filter   from POP30310 as LineHist with (NOLOCK),   POP10500 as RcptApply with (NOLOCK),  POP30100 as POHIST with (NOLOCK)  where (RcptApply.Status = 1) and   (RcptApply.DATERECD >= @dtStart  and RcptApply.DATERECD <= @dtEnd) and   (RcptApply.POPRCTNM = LineHist.POPRCTNM and RcptApply.RCPTLNNM = LineHist.RCPTLNNM) and   (RcptApply.QTYINVCD > 0) and   (RcptApply.POPTYPE = 2) and   (RcptApply.POPTYPE = 2) and RcptApply.PONUMBER <> '' and RcptApply.PONUMBER = POHIST.PONUMBER and (POHIST.POTYPE = 2 or POHIST.POTYPE = 4)   end  else  if @Vendor <> ''  begin  insert #ItemQtys (ITEMNMBR, QTYSHPPD, UNITCOST, Filter)   select RcptApply.ITEMNMBR as Item,   RcptApply.QTYSHPPD as Qty,   LineHist.UNITCOST as UnitCost ,  POWork.VENDORID as Filter  from POP30310 as LineHist with (NOLOCK),   POP10500 as RcptApply with (NOLOCK) ,  POP10100 as POWork with (NOLOCK)  where (RcptApply.Status = 1) and   (RcptApply.DATERECD >= @dtStart and RcptApply.DATERECD <= @dtEnd) and   (RcptApply.POPRCTNM = LineHist.POPRCTNM and RcptApply.RCPTLNNM = LineHist.RCPTLNNM) and   (RcptApply.QTYSHPPD > 0) and   (RcptApply.POPTYPE = 1 or RcptApply.POPTYPE = 3)   and RcptApply.PONUMBER <> '' and RcptApply.PONUMBER = POWork.PONUMBER and (POWork.POTYPE = 1 or POWork.POTYPE = 3)    insert #ItemQtys (ITEMNMBR, QTYSHPPD, UNITCOST, Filter)   select RcptApply.ITEMNMBR as Item,   RcptApply.QTYSHPPD as Qty,   LineHist.UNITCOST as UnitCost ,  POHist.VENDORID as Filter  from POP30310 as LineHist with (NOLOCK),   POP10500 as RcptApply with (NOLOCK) ,  POP30100 as POHist with (NOLOCK)  where (RcptApply.Status = 1) and   (RcptApply.DATERECD >= @dtStart and RcptApply.DATERECD <= @dtEnd) and   (RcptApply.POPRCTNM = LineHist.POPRCTNM and RcptApply.RCPTLNNM = LineHist.RCPTLNNM) and   (RcptApply.QTYSHPPD > 0) and   (RcptApply.POPTYPE = 1 or RcptApply.POPTYPE = 3)   and RcptApply.PONUMBER <> '' and RcptApply.PONUMBER = POHist.PONUMBER and (POHist.POTYPE = 1 or POHist.POTYPE = 3)    Insert #ItemQtys (ITEMNMBR, QTYSHPPD, UNITCOST, Filter)   select RcptApply.ITEMNMBR as Item,   RcptApply.QTYINVCD as Qty,   LineHist.UNITCOST as UnitCost,  POWork.VENDORID as Filter  from POP30310 as LineHist with (NOLOCK),   POP10500 as RcptApply with (NOLOCK),  POP10100 as POWork with (NOLOCK)  where (RcptApply.Status = 1) and   (RcptApply.DATERECD >= @dtStart  and RcptApply.DATERECD <= @dtEnd) and   (RcptApply.POPRCTNM = LineHist.POPRCTNM and RcptApply.RCPTLNNM = LineHist.RCPTLNNM) and   (RcptApply.QTYINVCD > 0) and   (RcptApply.POPTYPE = 2) and   (RcptApply.POPTYPE = 2) and RcptApply.PONUMBER <> '' and RcptApply.PONUMBER = POWork.PONUMBER and (POWork.POTYPE = 2 or POWork.POTYPE = 4)    Insert #ItemQtys (ITEMNMBR, QTYSHPPD, UNITCOST, Filter)   select RcptApply.ITEMNMBR as Item,   RcptApply.QTYINVCD as Qty,   LineHist.UNITCOST as UnitCost,  POHIST.VENDORID as Filter   from POP30310 as LineHist with (NOLOCK),   POP10500 as RcptApply with (NOLOCK),  POP30100 as POHIST with (NOLOCK)  where (RcptApply.Status = 1) and   (RcptApply.DATERECD >= @dtStart  and RcptApply.DATERECD <= @dtEnd) and   (RcptApply.POPRCTNM = LineHist.POPRCTNM and RcptApply.RCPTLNNM = LineHist.RCPTLNNM) and   (RcptApply.QTYINVCD > 0) and   (RcptApply.POPTYPE = 2) and   (RcptApply.POPTYPE = 2) and RcptApply.PONUMBER <> '' and RcptApply.PONUMBER = POHIST.PONUMBER and (POHIST.POTYPE = 2 or POHIST.POTYPE = 4)   end  else  begin   insert #ItemQtys (ITEMNMBR, QTYSHPPD, UNITCOST, Filter)   select RcptApply.ITEMNMBR as Item,   RcptApply.QTYSHPPD as Qty,   LineHist.UNITCOST as UnitCost ,  RcptApply.ITEMNMBR as Filter  from POP30310 as LineHist with (NOLOCK),   POP10500 as RcptApply with (NOLOCK) ,  POP10100 as POWork with (NOLOCK)  where (RcptApply.Status = 1) and   (RcptApply.DATERECD >= @dtStart and RcptApply.DATERECD <= @dtEnd) and   (RcptApply.POPRCTNM = LineHist.POPRCTNM and RcptApply.RCPTLNNM = LineHist.RCPTLNNM) and   (RcptApply.QTYSHPPD > 0) and   (RcptApply.POPTYPE = 1 or RcptApply.POPTYPE = 3)   and RcptApply.PONUMBER <> '' and RcptApply.PONUMBER = POWork.PONUMBER and (POWork.POTYPE = 1 or POWork.POTYPE = 3)   insert #ItemQtys (ITEMNMBR, QTYSHPPD, UNITCOST, Filter)   select RcptApply.ITEMNMBR as Item,   RcptApply.QTYSHPPD as Qty,   LineHist.UNITCOST as UnitCost ,  RcptApply.ITEMNMBR as Filter  from POP30310 as LineHist with (NOLOCK),   POP10500 as RcptApply with (NOLOCK) ,  POP30100 as POHist with (NOLOCK)  where (RcptApply.Status = 1) and   (RcptApply.DATERECD >= @dtStart and RcptApply.DATERECD <= @dtEnd) and   (RcptApply.POPRCTNM = LineHist.POPRCTNM and RcptApply.RCPTLNNM = LineHist.RCPTLNNM) and   (RcptApply.QTYSHPPD > 0) and   (RcptApply.POPTYPE = 1 or RcptApply.POPTYPE = 3)   and RcptApply.PONUMBER <> '' and RcptApply.PONUMBER = POHist.PONUMBER and (POHist.POTYPE = 1 or POHist.POTYPE = 3)    Insert #ItemQtys (ITEMNMBR, QTYSHPPD, UNITCOST, Filter)   select RcptApply.ITEMNMBR as Item,   RcptApply.QTYINVCD as Qty,   LineHist.UNITCOST as UnitCost,  RcptApply.ITEMNMBR as Filter  from POP30310 as LineHist with (NOLOCK),   POP10500 as RcptApply with (NOLOCK),  POP10100 as POWork with (NOLOCK)  where (RcptApply.Status = 1) and   (RcptApply.DATERECD >= @dtStart  and RcptApply.DATERECD <= @dtEnd) and   (RcptApply.POPRCTNM = LineHist.POPRCTNM and RcptApply.RCPTLNNM = LineHist.RCPTLNNM) and   (RcptApply.QTYINVCD > 0) and   (RcptApply.POPTYPE = 2) and   (RcptApply.POPTYPE = 2) and RcptApply.PONUMBER <> '' and RcptApply.PONUMBER = POWork.PONUMBER and (POWork.POTYPE = 2 or POWork.POTYPE = 4)   Insert #ItemQtys (ITEMNMBR, QTYSHPPD, UNITCOST, Filter)   select RcptApply.ITEMNMBR as Item,   RcptApply.QTYINVCD as Qty,   LineHist.UNITCOST as UnitCost,  RcptApply.ITEMNMBR as Filter   from POP30310 as LineHist with (NOLOCK),   POP10500 as RcptApply with (NOLOCK),  POP30100 as POHIST with (NOLOCK)  where (RcptApply.Status = 1) and   (RcptApply.DATERECD >= @dtStart  and RcptApply.DATERECD <= @dtEnd) and   (RcptApply.POPRCTNM = LineHist.POPRCTNM and RcptApply.RCPTLNNM = LineHist.RCPTLNNM) and   (RcptApply.QTYINVCD > 0) and   (RcptApply.POPTYPE = 2) and   (RcptApply.POPTYPE = 2) and RcptApply.PONUMBER <> '' and RcptApply.PONUMBER = POHIST.PONUMBER and (POHIST.POTYPE = 2 or POHIST.POTYPE = 4)   end end   if @Buyer = '' and @Vendor = '' and @ItemNumber = '' begin   select top (select @I_iNumItems) sum(round(ItemQtys.QTYSHPPD * ItemQtys.UNITCOST, 2)) as TotalAmount,   ItemQtys.ITEMNMBR as Item, Filter from #ItemQtys as ItemQtys with (NOLOCK)  group by ItemQtys.ITEMNMBR, Filter order by TotalAmount DESC, Item, Filter end else begin  select sum(round(ItemQtys.QTYSHPPD * ItemQtys.UNITCOST, 2)) as TotalAmount,   ItemQtys.ITEMNMBR as Item,   Filter   from #ItemQtys as ItemQtys with (NOLOCK)  inner join   (select top (select @I_iNumItems) sum(round(ItemQtys.QTYSHPPD * ItemQtys.UNITCOST, 2)) as TotalAmount,   ItemQtys.ITEMNMBR as Item  from #ItemQtys as ItemQtys with (NOLOCK)  group by   ItemQtys.ITEMNMBR  order by TotalAmount DESC, Item) ItemsList on ItemQtys.ITEMNMBR = ItemsList.Item   inner join @ValuesTable FilterList on FilterList.Value = ItemQtys.Filter  group by   ItemQtys.ITEMNMBR, Filter   order by TotalAmount DESC, Item, Filter end DROP TABLE #ItemQtys  set nocount OFF RETURN   
GO
GRANT EXECUTE ON  [dbo].[seePOPTopTenPurchaseItemsByAmt30DaysMetric] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[seePOPTopTenPurchaseItemsByAmt30DaysMetric] TO [rpt_executive]
GO
GRANT EXECUTE ON  [dbo].[seePOPTopTenPurchaseItemsByAmt30DaysMetric] TO [rpt_materials manager]
GO
GRANT EXECUTE ON  [dbo].[seePOPTopTenPurchaseItemsByAmt30DaysMetric] TO [rpt_operations manager]
GO
GRANT EXECUTE ON  [dbo].[seePOPTopTenPurchaseItemsByAmt30DaysMetric] TO [rpt_purchasing agent]
GO
GRANT EXECUTE ON  [dbo].[seePOPTopTenPurchaseItemsByAmt30DaysMetric] TO [rpt_purchasing manager]
GO
