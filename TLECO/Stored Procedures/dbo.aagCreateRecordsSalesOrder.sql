SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aagCreateRecordsSalesOrder]  @aaGLWorkHdrID INT OUTPUT,  @CtrlNo VARCHAR(100),  @TrxSrc VARCHAR(100),  @l_ErrorCode SMALLINT = NULL OUTPUT AS  BEGIN   DECLARE   @i INT,  @DEL TINYINT,  @aaSubLedgerDistID INTEGER,  @GLPOSTDT DATETIME,  @DOCNUMBR VARCHAR(100),  @SOPTYPE INT,  @aaSubLedgerHdrID INT,  @O_nSQL_Error_State INT,  @l_nError INT,  @SlsDeposit VARCHAR(100),  @l_cINTERID CHAR(5)  SELECT @DEL = 0, @aaSubLedgerHdrID = 0, @l_cINTERID = DB_NAME()    exec    @l_ErrorCode = DYNAMICS.dbo.smGetMsgString 16606, @l_cINTERID, @SlsDeposit output, @O_nSQL_Error_State output   SELECT @l_nError = @@ERROR   IF @l_ErrorCode = 0 and @l_nError <> 0   SELECT @l_ErrorCode = @l_nError   IF ( (@l_ErrorCode <> 0) or (@O_nSQL_Error_State <> 0) )   return (@l_ErrorCode)    SELECT TOP 1 @DOCNUMBR = DOCNUMBR, @SOPTYPE = SOPTYPE, @GLPOSTDT = GLPOSTDT FROM (  SELECT DOCNUMBR, SOPTYPE, GLPOSTDT, DEX_ROW_ID  FROM SOP10103 where SOPNUMBE = @CtrlNo AND TRXSORCE = ''   UNION   SELECT DOCNUMBR, SOPTYPE, GLPOSTDT, DEX_ROW_ID  FROM SOP10103 where SOPNUMBE = @CtrlNo  AND DELETE1 = 1  ) A ORDER BY DEX_ROW_ID   SELECT TOP 1 @DEL = DELETE1 FROM SOP10103 WHERE DOCNUMBR = @DOCNUMBR AND TRXSORCE = @TrxSrc   SELECT TOP 1 @aaSubLedgerHdrID = aaSubLedgerHdrID FROM AAG20000 WHERE SERIES = 3 AND DOCNUMBR  = @DOCNUMBR   IF NOT EXISTS(SELECT TOP 1 1 FROM AAG50000 WHERE aaSubLedgerHdrID = -@aaSubLedgerHdrID)  INSERT INTO AAG50000  (USERID, TRXBTCHSRC, aaSubLedgerHdrID,  SERIES, DOCTYPE, DOCNUMBR,PSTGDATE,aaOrder)   values(SYSTEM_USER,@SlsDeposit,-@aaSubLedgerHdrID,3,0,@DOCNUMBR,@GLPOSTDT,0)   SELECT @i = 1  IF @DEL = 0  BEGIN   IF NOT EXISTS(SELECT TOP 1 1 FROM AAG50001 where aaSubLedgerHdrID=@aaSubLedgerHdrID and aaSubLedgerDistID in (1,2))  BEGIN  INSERT INTO AAG50001(aaSubLedgerHdrID,aaSubLedgerDistID, ACTINDX,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, CURNCYID, CURRNIDX,POSTED)  SELECT -@aaSubLedgerHdrID,aaSubLedgerDistID, ACTINDX,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, CURNCYID, CURRNIDX,POSTED  FROM AAG20001 where aaSubLedgerHdrID = @aaSubLedgerHdrID and aaSubLedgerDistID IN (1,2) and INTERID = DB_NAME()   EXEC('UPDATE AAG50001 SET USERID = SYSTEM_USER, TRXBTCHSRC = '''+ @SlsDeposit +''', SERIES = 3 where aaSubLedgerHdrID = -' + @aaSubLedgerHdrID)  END  IF NOT EXISTS(SELECT TOP 1 1 FROM AAG50002 where aaSubLedgerHdrID=@aaSubLedgerHdrID and aaSubLedgerDistID in (1,2))  BEGIN  INSERT INTO AAG50002(aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT,  DistRef)  SELECT -@aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT,  DistRef  FROM AAG20002 where aaSubLedgerHdrID=@aaSubLedgerHdrID and aaSubLedgerDistID in (1,2)   EXEC('UPDATE AAG50002 SET USERID = SYSTEM_USER, TRXBTCHSRC = '''+ @SlsDeposit +''' where aaSubLedgerHdrID = -' + @aaSubLedgerHdrID)  END   DELETE AAG10002 WHERE aaGLWorkHdrID = @aaGLWorkHdrID    INSERT INTO AAG10002(aaGLWorkHdrID, aaGLWorkDistID, aaGLWorkAssignID, DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT,   aaAssignedPercent, DistRef, NOTEINDX, aaAssignErrors, aaAliasID)   SELECT @aaGLWorkHdrID, aaSubLedgerDistID, aaSubLedgerAssignID,   (SELECT DEBITAMT FROM AAG10001 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID = AAG20002.aaSubLedgerDistID) * aaAssignedPercent / 10000,   (SELECT CRDTAMNT FROM AAG10001 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID = AAG20002.aaSubLedgerDistID) * aaAssignedPercent / 10000,   (SELECT ORDBTAMT FROM AAG10001 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID = AAG20002.aaSubLedgerDistID) * aaAssignedPercent / 10000,   (SELECT ORCRDAMT FROM AAG10001 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID = AAG20002.aaSubLedgerDistID) * aaAssignedPercent / 10000,   aaAssignedPercent, DistRef, NOTEINDX, aaAssignErrors, aaAliasID   FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID IN(1,2)   DELETE AAG10003 WHERE aaGLWorkHdrID = @aaGLWorkHdrID    INSERT INTO AAG10003(aaGLWorkHdrID ,aaGLWorkDistID ,aaGLWorkAssignID ,aaTrxDimID  ,aaTrxCodeID ,aaCodeErrors)   SELECT @aaGLWorkHdrID , aaSubLedgerDistID ,aaSubLedgerAssignID, aaTrxDimID,  aaTrxCodeID, aaCodeErrors FROM AAG20003   WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID IN(1,2)  END  ELSE  BEGIN  WHILE @i <=2  BEGIN  IF NOT EXISTS(SELECT TOP 1 1 FROM AAG50001 where aaSubLedgerHdrID=@aaSubLedgerHdrID and aaSubLedgerDistID = @i+2)  BEGIN  INSERT INTO AAG50001(aaSubLedgerHdrID,aaSubLedgerDistID, ACTINDX,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, CURNCYID, CURRNIDX,POSTED)  SELECT @aaSubLedgerHdrID,aaSubLedgerDistID, ACTINDX,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, CURNCYID, CURRNIDX,POSTED  FROM AAG20001 where aaSubLedgerHdrID = @aaSubLedgerHdrID and aaSubLedgerDistID = @i+2 and INTERID = DB_NAME()   EXEC('UPDATE AAG50001 SET USERID = SYSTEM_USER, TRXBTCHSRC = '''+ @SlsDeposit +''', SERIES = 3 where aaSubLedgerHdrID = ' + @aaSubLedgerHdrID)   END  IF NOT EXISTS(SELECT TOP 1 1 FROM AAG50002 where aaSubLedgerHdrID=@aaSubLedgerHdrID and aaSubLedgerDistID = @i+2)  BEGIN  INSERT INTO AAG50002(aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT,  DistRef)  SELECT @aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID,  DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT,  DistRef  FROM AAG20002 where aaSubLedgerHdrID=@aaSubLedgerHdrID and aaSubLedgerDistID = @i+2   EXEC('UPDATE AAG50002 SET USERID = SYSTEM_USER, TRXBTCHSRC = '''+ @SlsDeposit +''' where aaSubLedgerHdrID = ' + @aaSubLedgerHdrID)  END   DELETE AAG10002 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID = @i   INSERT INTO AAG10002(aaGLWorkHdrID, aaGLWorkDistID, aaGLWorkAssignID, DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT,   aaAssignedPercent, DistRef, NOTEINDX, aaAssignErrors, aaAliasID)   SELECT @aaGLWorkHdrID, @i, aaSubLedgerAssignID,   (SELECT DEBITAMT FROM AAG10001 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID = @i) * aaAssignedPercent / 10000,   (SELECT CRDTAMNT FROM AAG10001 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID = @i) * aaAssignedPercent / 10000,   (SELECT ORDBTAMT FROM AAG10001 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID = @i) * aaAssignedPercent / 10000,   (SELECT ORCRDAMT FROM AAG10001 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID = @i) * aaAssignedPercent / 10000,   aaAssignedPercent, DistRef, NOTEINDX, aaAssignErrors, aaAliasID   FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @i + 2  DELETE AAG10003 WHERE aaGLWorkHdrID = @aaGLWorkHdrID AND aaGLWorkDistID = @i   INSERT INTO AAG10003(aaGLWorkHdrID ,aaGLWorkDistID ,aaGLWorkAssignID ,aaTrxDimID  ,aaTrxCodeID ,aaCodeErrors)   SELECT @aaGLWorkHdrID , @i ,aaSubLedgerAssignID, aaTrxDimID,  aaTrxCodeID, aaCodeErrors FROM AAG20003   WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @i + 2  SELECT @i = @i + 1  END  END END    
GO
GRANT EXECUTE ON  [dbo].[aagCreateRecordsSalesOrder] TO [DYNGRP]
GO
