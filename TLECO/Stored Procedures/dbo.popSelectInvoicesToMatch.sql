SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
create procedure [dbo].[popSelectInvoicesToMatch]  @I_vTableName varchar(25) = NULL,  @I_cPONumber char(21) = NULL,  @I_nOrd int   = NULL,  @I_sVendorID char(15) = NULL,   @I_sItemNumber char(30) = NULL,  @I_sUOfM char(15) = NULL,  @I_sCurrencyID char(15) = NULL,  @I_sIvcNumber char(21) = NULL,  @I_nIvcLineNumber int   = NULL,   @I_fLandedCost tinyint  = NULL,   @I_nSortSeq tinyint  = NULL,  @I_fMCRegistered tinyint  = NULL,  @I_FunctionalCurrency char(15) = NULL,  @O_iErrorState          int      = NULL output  as  declare @Posted int,  @ApplyType int  select @Posted = 1,   @ApplyType = 1  select @O_iErrorState  = 0  if( @I_vTableName is NULL or  @I_cPONumber is NULL or  @I_nOrd is NULL or  @I_sVendorID is NULL or  @I_sItemNumber is NULL or  @I_sUOfM is NULL or  @I_sCurrencyID is NULL or  @I_sIvcNumber is NULL or  @I_nIvcLineNumber is NULL or  @I_fLandedCost is NULL or  @I_nSortSeq is NULL or  @I_fMCRegistered is NULL or  @I_FunctionalCurrency is NULL) begin  select          @O_iErrorState = 21022  return end  CREATE TABLE #PORcptApply (  [PONUMBER] [char] (17) NOT NULL ,  [POLNENUM] [int] NOT NULL ,  [POPRCTNM] [char] (17) NOT NULL ,  [RCPTLNNM] [int] NOT NULL ,  [QTYSHPPD] [numeric](19, 5) NOT NULL ,  [QTYINVCD] [numeric](19, 5) NOT NULL ,  [QTYREJ] [numeric](19, 5) NOT NULL ,  [QTYMATCH] [numeric](19, 5) NOT NULL ,  [QTYRESERVED] [numeric](19, 5) NOT NULL ,  [QTYINVRESERVE] [numeric](19, 5) NOT NULL ,  [Status] [smallint] NOT NULL ,  [UMQTYINB] [numeric](19, 5) NOT NULL ,  [OLDCUCST] [numeric](19, 5) NOT NULL ,  [JOBNUMBR] [char] (17) NOT NULL ,  [COSTCODE] [char] (27) NOT NULL ,  [COSTTYPE] [smallint] NOT NULL ,  [ORCPTCOST] [numeric](19, 5) NOT NULL ,  [OSTDCOST] [numeric](19, 5) NOT NULL ,  [APPYTYPE] [smallint] NOT NULL ,  [POPTYPE] [smallint] NOT NULL ,  [VENDORID] [char] (15) NOT NULL ,  [ITEMNMBR] [char] (31) NOT NULL ,  [UOFM] [char] (9) NOT NULL ,  [TRXLOCTN] [char] (11) NOT NULL ,  [DATERECD] [datetime] NOT NULL ,  [RCTSEQNM] [int] NOT NULL ,  [SPRCTSEQ] [int] NOT NULL ,  [PCHRPTCT] [numeric](19, 5) NOT NULL ,  [SPRCPTCT] [numeric](19, 5) NOT NULL ,  [OREXTCST] [numeric](19, 5) NOT NULL ,  [RUPPVAMT] [numeric](19, 5) NOT NULL ,  [ACPURIDX] [int] NOT NULL ,  [INVINDX] [int] NOT NULL ,  [UPPVIDX] [int] NOT NULL ,  [NOTEINDX] [numeric](19, 5) NOT NULL ,  [CURNCYID] [char] (15) NOT NULL ,  [CURRNIDX] [smallint] NOT NULL ,  [XCHGRATE] [numeric](19, 7) NOT NULL ,  [RATECALC] [smallint] NOT NULL ,  [DENXRATE] [numeric](19, 7) NOT NULL ,  [RATETPID] [char] (15) NOT NULL ,  [EXGTBLID] [char] (15) NOT NULL ,  [Capital_Item] [tinyint] NOT NULL ,  [Product_Indicator] [smallint] NOT NULL ,  [Total_Landed_Cost_Amount] [numeric](19, 5) NOT NULL ,  [QTYTYPE] [smallint] NOT NULL ,  [Posted_LC_PPV_Amount] [numeric](19, 5) NOT NULL ,  [QTYREPLACED] [numeric](19, 5) NOT NULL ,  [QTYINVADJ] [numeric](19, 5) NOT NULL ,  [DEX_ROW_ID] [int] IDENTITY NOT NULL)  CREATE INDEX AK2#PORcptApply ON  #PORcptApply (POPRCTNM, RCPTLNNM, PONUMBER, POLNENUM)   IF @I_cPONumber <> ''   IF @I_nOrd = -1   BEGIN  insert into #PORcptApply  select R.PONUMBER, R.POLNENUM, R.POPRCTNM, R.RCPTLNNM, R.QTYSHPPD, R.QTYINVCD, R.QTYREJ, R.QTYMATCH, R.QTYRESERVED, R.QTYINVRESERVE, R.Status, R.UMQTYINB,  R.OLDCUCST, R.JOBNUMBR, R.COSTCODE, R.COSTTYPE, R.ORCPTCOST, R.OSTDCOST, R.APPYTYPE, R.POPTYPE, R.VENDORID, R.ITEMNMBR, R.UOFM, R.TRXLOCTN, R.DATERECD, R.RCTSEQNM, R.SPRCTSEQ,  R.PCHRPTCT, R.SPRCPTCT, R.OREXTCST, R.RUPPVAMT, R.ACPURIDX, R.INVINDX, R.UPPVIDX, R.NOTEINDX, R.CURNCYID , R.CURRNIDX, R.XCHGRATE, R.RATECALC, R.DENXRATE, R.RATETPID,  R.EXGTBLID, R.Capital_Item, R.Product_Indicator, R.Total_Landed_Cost_Amount, R.QTYTYPE, R.Posted_LC_PPV_Amount, R.QTYREPLACED, R.QTYINVADJ  from POP10500 R  where PONUMBER = @I_cPONumber and VENDORID = @I_sVendorID and Status = @Posted and ITEMNMBR = @I_sItemNumber   and UOFM = @I_sUOfM and APPYTYPE = @ApplyType and   (  ((QTYMATCH - QTYINVADJ) < QTYSHPPD) or   ((QTYSHPPD = (QTYMATCH - QTYINVADJ)) and exists(select 1 from POP10600 I where POPIVCNO = @I_sIvcNumber and IVCLINNO = @I_nIvcLineNumber and R.POPRCTNM = I.POPRCTNM and R.RCPTLNNM = R.RCPTLNNM)) )  order by PONUMBER, VENDORID, Status, ITEMNMBR, UOFM, APPYTYPE, POPRCTNM, RCPTLNNM   END   ELSE  BEGIN  insert into #PORcptApply  select R.PONUMBER, R.POLNENUM, R.POPRCTNM, R.RCPTLNNM, R.QTYSHPPD, R.QTYINVCD, R.QTYREJ, R.QTYMATCH, R.QTYRESERVED, R.QTYINVRESERVE, R.Status, R.UMQTYINB,  R.OLDCUCST, R.JOBNUMBR, R.COSTCODE, R.COSTTYPE, R.ORCPTCOST, R.OSTDCOST, R.APPYTYPE, R.POPTYPE, R.VENDORID, R.ITEMNMBR, R.UOFM, R.TRXLOCTN, R.DATERECD, R.RCTSEQNM, R.SPRCTSEQ,  R.PCHRPTCT, R.SPRCPTCT, R.OREXTCST, R.RUPPVAMT, R.ACPURIDX, R.INVINDX, R.UPPVIDX, R.NOTEINDX, R.CURNCYID , R.CURRNIDX, R.XCHGRATE, R.RATECALC, R.DENXRATE, R.RATETPID,  R.EXGTBLID, R.Capital_Item, R.Product_Indicator, R.Total_Landed_Cost_Amount, R.QTYTYPE, R.Posted_LC_PPV_Amount, R.QTYREPLACED, R.QTYINVADJ  from POP10500 R  where PONUMBER = @I_cPONumber and POLNENUM = @I_nOrd and Status = @Posted and APPYTYPE = @ApplyType and  (((QTYMATCH - QTYINVADJ) < QTYSHPPD) or    ((QTYSHPPD = (QTYMATCH - QTYINVADJ)) and exists(select 1 from POP10600 I where POPIVCNO = @I_sIvcNumber and IVCLINNO = @I_nIvcLineNumber and R.POPRCTNM = I.POPRCTNM and R.RCPTLNNM = R.RCPTLNNM)) )  order by PONUMBER, POLNENUM, Status, APPYTYPE, POPRCTNM, RCPTLNNM   END  ELSE  if @I_fLandedCost = 1  BEGIN  insert into #PORcptApply  select R.PONUMBER, R.POLNENUM, R.POPRCTNM, R.RCPTLNNM, R.QTYSHPPD, R.QTYINVCD, R.QTYREJ, R.QTYMATCH, R.QTYRESERVED, R.QTYINVRESERVE, R.Status, R.UMQTYINB,  R.OLDCUCST, R.JOBNUMBR, R.COSTCODE, R.COSTTYPE, R.ORCPTCOST, R.OSTDCOST, R.APPYTYPE, R.POPTYPE, R.VENDORID, R.ITEMNMBR, R.UOFM, R.TRXLOCTN, R.DATERECD, R.RCTSEQNM, R.SPRCTSEQ,  R.PCHRPTCT, R.SPRCPTCT, R.OREXTCST, R.RUPPVAMT, R.ACPURIDX, R.INVINDX, R.UPPVIDX, R.NOTEINDX, R.CURNCYID , R.CURRNIDX, R.XCHGRATE, R.RATECALC, R.DENXRATE, R.RATETPID,  R.EXGTBLID, R.Capital_Item, R.Product_Indicator, R.Total_Landed_Cost_Amount, R.QTYTYPE, R.Posted_LC_PPV_Amount, R.QTYREPLACED, R.QTYINVADJ  from POP10500 R  where PONUMBER = @I_cPONumber and VENDORID = @I_sVendorID and Status = @Posted and ITEMNMBR = @I_sItemNumber   and APPYTYPE = @ApplyType and POLNENUM <> 0 and   ((QTYMATCH = 0) or   ((QTYMATCH <> 0 ) and exists(select 1 from POP10600 I where POPIVCNO = @I_sIvcNumber and IVCLINNO = @I_nIvcLineNumber and R.POPRCTNM = I.POPRCTNM and R.RCPTLNNM = R.RCPTLNNM)) )  order by PONUMBER, VENDORID, Status, ITEMNMBR, UOFM, APPYTYPE, POPRCTNM, RCPTLNNM    END  ELSE  BEGIN  insert into #PORcptApply  select R.PONUMBER, R.POLNENUM, R.POPRCTNM, R.RCPTLNNM, R.QTYSHPPD, R.QTYINVCD, R.QTYREJ, R.QTYMATCH, R.QTYRESERVED, R.QTYINVRESERVE, R.Status, R.UMQTYINB,  R.OLDCUCST, R.JOBNUMBR, R.COSTCODE, R.COSTTYPE, R.ORCPTCOST, R.OSTDCOST, R.APPYTYPE, R.POPTYPE, R.VENDORID, R.ITEMNMBR, R.UOFM, R.TRXLOCTN, R.DATERECD, R.RCTSEQNM, R.SPRCTSEQ,  R.PCHRPTCT, R.SPRCPTCT, R.OREXTCST, R.RUPPVAMT, R.ACPURIDX, R.INVINDX, R.UPPVIDX, R.NOTEINDX, R.CURNCYID , R.CURRNIDX, R.XCHGRATE, R.RATECALC, R.DENXRATE, R.RATETPID,  R.EXGTBLID, R.Capital_Item, R.Product_Indicator, R.Total_Landed_Cost_Amount, R.QTYTYPE, R.Posted_LC_PPV_Amount, R.QTYREPLACED, R.QTYINVADJ  from POP10500 R  where PONUMBER = @I_cPONumber and VENDORID = @I_sVendorID and Status = @Posted and ITEMNMBR = @I_sItemNumber   and UOFM = @I_sUOfM and APPYTYPE = @ApplyType and POLNENUM = 0 and (R.CURNCYID = @I_sCurrencyID or (R.CURNCYID = @I_FunctionalCurrency and @I_fMCRegistered = 0)) and     (((QTYMATCH - QTYINVADJ) < QTYSHPPD) or   ((QTYSHPPD = (QTYMATCH - QTYINVADJ)) and exists(select 1 from POP10600 I where POPIVCNO = @I_sIvcNumber and IVCLINNO = @I_nIvcLineNumber and R.POPRCTNM = I.POPRCTNM and R.RCPTLNNM = R.RCPTLNNM)) )  order by PONUMBER, VENDORID, Status, ITEMNMBR, UOFM, APPYTYPE, POPRCTNM, RCPTLNNM   END  select @O_iErrorState = @@error if @O_iErrorState <> 0  return  exec ('insert into ' + @I_vTableName  + ' select R.PONUMBER, R.POLNENUM, R.POPRCTNM, R.RCPTLNNM, R.QTYSHPPD, R.QTYINVCD, R.QTYREJ, R.QTYMATCH, R.QTYRESERVED, R.QTYINVRESERVE, R.Status, R.UMQTYINB, '  + 'R.OLDCUCST, R.JOBNUMBR, R.COSTCODE, R.COSTTYPE, R.ORCPTCOST, R.OSTDCOST, R.APPYTYPE, R.POPTYPE, R.VENDORID, R.ITEMNMBR, R.UOFM, R.TRXLOCTN, R.DATERECD, R.RCTSEQNM, R.SPRCTSEQ, '  + 'R.PCHRPTCT, R.SPRCPTCT, R.OREXTCST, R.RUPPVAMT, R.ACPURIDX, R.INVINDX, R.UPPVIDX, R.NOTEINDX, R.CURNCYID , R.CURRNIDX, R.XCHGRATE, R.RATECALC, R.DENXRATE, R.RATETPID, '  + 'R.EXGTBLID, R.Capital_Item, R.Product_Indicator, R.Total_Landed_Cost_Amount, R.QTYTYPE, R.Posted_LC_PPV_Amount, R.QTYREPLACED, R.QTYINVADJ '  + 'from #PORcptApply R' )  select @O_iErrorState = @@ERROR  drop table #PORcptApply  return    
GO
GRANT EXECUTE ON  [dbo].[popSelectInvoicesToMatch] TO [DYNGRP]
GO
