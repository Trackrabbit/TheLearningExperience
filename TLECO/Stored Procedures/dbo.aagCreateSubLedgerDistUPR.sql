SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROC [dbo].[aagCreateSubLedgerDistUPR]  @SubLedgerHdrID INT,   @AuditCtrlCode VARCHAR(15),   @EmployeeID VARCHAR(15),  @PYRNTYPE SMALLINT = 0 AS  DECLARE @InterID VARCHAR(5),  @AcctIdx INT, @AcctTyp SMALLINT, @DebitAmt NUMERIC(19, 5), @CrdtAmt NUMERIC(19, 5), @SeqNumbr INT, @TrxNmbr INT,   @PayRolType SMALLINT, @UPRAcctType SMALLINT, @PayRollCode VARCHAR(7), @Dept VARCHAR(7), @JobTitle VARCHAR(7), @POSTEDDT DATETIME  DECLARE @ClassID INT, @BrowseType SMALLINT, @SubLedgerDistID INT, @RecordExists SMALLINT, @IncludeEmployee SMALLINT, @TESTSubLedgerDistID INT  declare @tempSeqNumbr INT   SET @RecordExists = 0  SET @SubLedgerDistID = 0  SET @IncludeEmployee = 0  SET @TESTSubLedgerDistID = 0   DELETE FROM AAG20003 WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND   aaSubLedgerAssignID IN (SELECT aaSubLedgerAssignID FROM AAG20002 WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND   AAG20002.aaSubLedgerDistID = AAG20003.aaSubLedgerDistID AND aaAssignedPercent = 0)   DELETE FROM AAG20002 WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND aaAssignedPercent = 0   DELETE FROM AAG20001 WHERE NOT EXISTS(SELECT 1 FROM AAG20002 WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND  AAG20002.aaSubLedgerHdrID = AAG20001.aaSubLedgerHdrID and AAG20002.aaSubLedgerDistID = AAG20001.aaSubLedgerDistID )  AND aaSubLedgerHdrID = @SubLedgerHdrID   UPDATE AAG20001 SET aaSubLedgerDistID = (aaSubLedgerDistID*-1) FROM AAG20001 WHERE aaSubLedgerHdrID = @SubLedgerHdrID  UPDATE AAG20002 SET aaSubLedgerDistID = (aaSubLedgerDistID*-1) FROM AAG20002 WHERE aaSubLedgerHdrID = @SubLedgerHdrID  UPDATE AAG20003 SET aaSubLedgerDistID = (aaSubLedgerDistID*-1) FROM AAG20003 WHERE aaSubLedgerHdrID = @SubLedgerHdrID   IF @PYRNTYPE <> 0   BEGIN  UPDATE AAG20001 SET SEQNUMBR = (SEQNUMBR * -1) FROM AAG20001 WHERE aaSubLedgerHdrID = @SubLedgerHdrID  END   DECLARE CreateDistrRecords CURSOR FAST_FORWARD  FOR   SELECT DB_NAME() AS INTERID, U.ACTINDX, G.ACCTTYPE, ABS(U.DEBITAMT) AS DEBITAMT, ABS(U.CRDTAMNT) AS CRDTAMNT, U.SEQNUMBR,   U.TRXNUMBER, U.PYRLRTYP, U.UPRACTYP, U.PAYROLCD, U.DEPRTMNT, U.JOBTITLE, U.POSTEDDT  FROM UPR30401 U INNER JOIN GL00100 G ON U.ACTINDX = G.ACTINDX   WHERE LTRIM(RTRIM(U.AUCTRLCD)) = LTRIM(RTRIM(@AuditCtrlCode)) AND LTRIM(RTRIM(U.EMPLOYID)) = LTRIM(RTRIM(@EmployeeID))  ORDER BY U.ACTINDX   OPEN CreateDistrRecords  FETCH NEXT FROM CreateDistrRecords INTO @InterID, @AcctIdx, @AcctTyp, @DebitAmt, @CrdtAmt, @SeqNumbr, @TrxNmbr, @PayRolType, @UPRAcctType,   @PayRollCode, @Dept, @JobTitle, @POSTEDDT  WHILE @@FETCH_STATUS = 0  BEGIN  SELECT @ClassID = aaAcctClassID FROM AAG00200 WHERE ACTINDX = @AcctIdx  IF @ClassID = 0   BEGIN  SET @BrowseType = 0  END  ELSE  BEGIN  SET @BrowseType = 1  END   SELECT @IncludeEmployee = aaSetEmployeeID FROM AAG00201 WHERE aaAcctClassID = @ClassID  IF @PYRNTYPE = 0   BEGIN  SELECT @RecordExists = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG20001   WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND SEQNUMBR = @SeqNumbr AND TRXNUMBER = @TrxNmbr AND   PYRLRTYP = @PayRolType  END  ELSE  BEGIN  SELECT @RecordExists = CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END FROM AAG20001   WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND TRXNUMBER = @TrxNmbr AND   PYRLRTYP = @PayRolType and DEBITAMT = @DebitAmt and CRDTAMNT = @CrdtAmt AND SEQNUMBR < 0  select top 1 @tempSeqNumbr = SEQNUMBR FROM AAG20001   WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND TRXNUMBER = @TrxNmbr AND   PYRLRTYP = @PayRolType and DEBITAMT = @DebitAmt and CRDTAMNT = @CrdtAmt AND SEQNUMBR < 0  ORDER BY ABS(SEQNUMBR)  END  IF @RecordExists = 1  BEGIN  SET @SubLedgerDistID = @SubLedgerDistID + 1  IF @PYRNTYPE = 0   BEGIN  SELECT @TESTSubLedgerDistID = aaSubLedgerDistID FROM AAG20001  WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND SEQNUMBR = @SeqNumbr AND TRXNUMBER = @TrxNmbr AND PYRLRTYP = @PayRolType   UPDATE AAG20001 SET INTERID = @InterID, ACTINDX = @AcctIdx, ACCTTYPE = @AcctTyp, aaBrowseType = @BrowseType,   DEBITAMT = @DebitAmt, CRDTAMNT = @CrdtAmt, POSTED = 1, GLPOSTDT = @POSTEDDT, aaSubLedgerDistID = @SubLedgerDistID  WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND SEQNUMBR = @SeqNumbr AND TRXNUMBER = @TrxNmbr AND PYRLRTYP = @PayRolType   END  ELSE  BEGIN  SELECT @TESTSubLedgerDistID = aaSubLedgerDistID FROM AAG20001  WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND TRXNUMBER = @TrxNmbr AND PYRLRTYP = @PayRolType and SEQNUMBR = @tempSeqNumbr   UPDATE AAG20001 SET INTERID = @InterID, ACTINDX = @AcctIdx, ACCTTYPE = @AcctTyp, aaBrowseType = @BrowseType,   DEBITAMT = @DebitAmt, CRDTAMNT = @CrdtAmt, POSTED = 1, GLPOSTDT = @POSTEDDT, SEQNUMBR = @SeqNumbr, aaSubLedgerDistID = @SubLedgerDistID  WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND TRXNUMBER = @TrxNmbr AND PYRLRTYP = @PayRolType and SEQNUMBR = @tempSeqNumbr  END  UPDATE AAG20002 SET aaSubLedgerDistID = @SubLedgerDistID   WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND aaSubLedgerDistID = @TESTSubLedgerDistID   UPDATE AAG20003 SET aaSubLedgerDistID = @SubLedgerDistID   WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND aaSubLedgerDistID = @TESTSubLedgerDistID   SET @TESTSubLedgerDistID = 0   END  ELSE  BEGIN  SET @SubLedgerDistID = @SubLedgerDistID + 1   IF @IncludeEmployee = 1   BEGIN  INSERT INTO AAG20001 (aaSubLedgerHdrID, aaSubLedgerDistID, INTERID, ACTINDX, ACCTTYPE, aaBrowseType, DEBITAMT,   CRDTAMNT, TRXNUMBER, PYRLRTYP, EMPLOYID, SEQNUMBR, POSTED, GLPOSTDT)  VALUES(@SubLedgerHdrID, @SubLedgerDistID, @InterID, @AcctIdx, @AcctTyp, @BrowseType, @DebitAmt, @CrdtAmt,   @TrxNmbr, @PayRolType, @EmployeeID, @SeqNumbr, 1, @POSTEDDT)  END   ELSE  BEGIN  INSERT INTO AAG20001 (aaSubLedgerHdrID, aaSubLedgerDistID, INTERID, ACTINDX, ACCTTYPE, aaBrowseType, DEBITAMT,   CRDTAMNT, TRXNUMBER, PYRLRTYP, SEQNUMBR, POSTED, GLPOSTDT)  VALUES(@SubLedgerHdrID, @SubLedgerDistID, @InterID, @AcctIdx, @AcctTyp, @BrowseType, @DebitAmt, @CrdtAmt,   @TrxNmbr, @PayRolType, @SeqNumbr, 1, @POSTEDDT)  END  IF @ClassID = 0 AND @SeqNumbr = 0  BEGIN  IF @DebitAmt <> 0  BEGIN  INSERT INTO AAG20002(aaSubLedgerHdrID, aaSubLedgerDistID, aaSubLedgerAssignID, DEBITAMT, CRDTAMNT,   aaAssignedPercent, aaAliasID)  VALUES(@SubLedgerHdrID, @SubLedgerDistID, 1, @DebitAmt, 0, 10000, 0)  END  ELSE  BEGIN  INSERT INTO AAG20002(aaSubLedgerHdrID, aaSubLedgerDistID, aaSubLedgerAssignID, DEBITAMT, CRDTAMNT,   aaAssignedPercent, aaAliasID)  VALUES(@SubLedgerHdrID, @SubLedgerDistID, 1, 0, @CrdtAmt, 10000, 0)  END  END   ELSE IF @ClassID <> 0 AND @SeqNumbr = 0  BEGIN  IF @DebitAmt <> 0  BEGIN  INSERT INTO AAG20002(aaSubLedgerHdrID, aaSubLedgerDistID, aaSubLedgerAssignID, DEBITAMT, CRDTAMNT,   aaAssignedPercent, aaAliasID)  VALUES(@SubLedgerHdrID, @SubLedgerDistID, 1, @DebitAmt, 0, 10000, 0)  END  ELSE  BEGIN  INSERT INTO AAG20002(aaSubLedgerHdrID, aaSubLedgerDistID, aaSubLedgerAssignID, DEBITAMT, CRDTAMNT,   aaAssignedPercent, aaAliasID)  VALUES(@SubLedgerHdrID, @SubLedgerDistID, 1, 0, @CrdtAmt, 10000, 0)  END  EXEC aagCreateSubLedgerCodes @SubLedgerHdrID, @SubLedgerDistID, 1, @AuditCtrlCode, @SeqNumbr, 0, @AcctIdx  END   ELSE  BEGIN  EXEC aagCreateSubLedgerAssignUPR @SubLedgerHdrID, @SubLedgerDistID, @AuditCtrlCode, @SeqNumbr, @EmployeeID, @Dept,   @JobTitle, @PayRollCode, @UPRAcctType, @DebitAmt, @CrdtAmt, @IncludeEmployee, @ClassID, @AcctIdx  END  END   SET @RecordExists = 0  SET @IncludeEmployee = 0  FETCH NEXT FROM CreateDistrRecords INTO @InterID, @AcctIdx, @AcctTyp, @DebitAmt, @CrdtAmt, @SeqNumbr, @TrxNmbr, @PayRolType,   @UPRAcctType, @PayRollCode, @Dept, @JobTitle, @POSTEDDT  END  CLOSE CreateDistrRecords  DEALLOCATE CreateDistrRecords   DELETE FROM AAG20001 WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND aaSubLedgerDistID < 0   DELETE FROM AAG20002 WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND aaSubLedgerDistID < 0   DELETE FROM AAG20003 WHERE aaSubLedgerHdrID = @SubLedgerHdrID AND aaSubLedgerDistID < 0     
GO
GRANT EXECUTE ON  [dbo].[aagCreateSubLedgerDistUPR] TO [DYNGRP]
GO
