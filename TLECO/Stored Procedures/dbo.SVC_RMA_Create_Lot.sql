SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 Create Procedure [dbo].[SVC_RMA_Create_Lot] ( @RecType smallint,  @RMANumber char(15),  @Line Numeric(19,5), @lot_number char(20),  @item_number char(30),  @location_code char(11),  @item_cost numeric(19,5), @rcv_date datetime, @date_seq numeric(19,5), @lot_qty numeric (19,5), @Bin char(15),  @original tinyint, @ExpDate datetime, @MfgDate datetime, @CMPNTSEQ int = 0, @QtyType smallint = 1 )  as declare @LotSequence int declare @UserID char(15) declare @MinDate datetime  exec smGetMinDate @MinDate output   select @UserID = SYSTEM_USER if @Bin = '' and (select ENABLEMULTIBIN from IV40100) = 1  exec SVC_Bin_GetDefault @item_number, @location_code, 'R', @Bin output  begin transaction  if not exists(select * from SVC05255 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line  and Return_Serial_Number = @lot_number and Return_Item_Number = @item_number and CMPNTSEQ = @CMPNTSEQ and QTYTYPE = @QtyType)  begin   select @LotSequence = isnull(Max(SLTSQNUM),0) + 1 from SVC05255  where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line  insert SVC05255 select  @RecType, @RMANumber, @Line, @QtyType, @lot_qty, @item_number, @lot_number, 0, @LotSequence, isnull(@Bin,''), @item_cost,  1, isnull(@rcv_date,CONVERT(char(10),GETDATE(),102) + ' 00:00:00') , isnull(@date_seq,1), 'RMA RCV' , case when @original =1 then 0 else 1 end, 0,  isnull(@MfgDate,@MinDate),isnull(@ExpDate,@MinDate), @CMPNTSEQ  if @@error <> 0 goto badentry  end else  begin  update SVC05255 set SERLTQTY = SERLTQTY + @lot_qty   where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line and CMPNTSEQ = @CMPNTSEQ  and Return_Serial_Number = @lot_number and Return_Item_Number = @item_number  end  commit transaction  return badentry:  rollback transaction  return     
GO
GRANT EXECUTE ON  [dbo].[SVC_RMA_Create_Lot] TO [DYNGRP]
GO
