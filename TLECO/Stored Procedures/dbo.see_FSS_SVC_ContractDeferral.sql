SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[see_FSS_SVC_ContractDeferral]   @RANGEOPTION smallint = 0,  @DISPLAYOPTION smallint = 0,  @FRMCONTNBR char(15) = '',  @TOCONTNBR char(15) = '',  @RPTACTNMBR int = 0,  @FRMCONT_DATE datetime = '19000101',   @TOCONT_DATE datetime = '99991231'  AS   declare @MinDate  datetime declare  @ACTINDX int,  @REVSALESACTINDX int, @REVLIABACTINDX int  select @MinDate = dbo.GetDefaultMinDate() select  @RANGEOPTION = case  when @RANGEOPTION is null or @RANGEOPTION <= 0 then 0  else @RANGEOPTION  end,  @DISPLAYOPTION = case  when @DISPLAYOPTION is null or @DISPLAYOPTION <= 0 then 0  else @DISPLAYOPTION  end,  @FRMCONTNBR = case  when @FRMCONTNBR is null or rtrim(@FRMCONTNBR) = '' then ''  else rtrim(@FRMCONTNBR)  end,  @TOCONTNBR = case  when @TOCONTNBR is null or rtrim(@TOCONTNBR) = '' then 'þþþþþþþþþþþþþþþ'   else rtrim(@TOCONTNBR)  end,  @RPTACTNMBR = case  when @RPTACTNMBR is null or @RPTACTNMBR = '' then ''  else @RPTACTNMBR  end,  @FRMCONT_DATE = case  when @FRMCONT_DATE is null or @FRMCONT_DATE = '' then @MinDate  else @FRMCONT_DATE  end,  @TOCONT_DATE = case   when @TOCONT_DATE is null or @TOCONT_DATE = '' or @TOCONT_DATE = @MinDate then dbo.GetDefaultMaxDate()  else @TOCONT_DATE  end set @ACTINDX = 0 if rtrim(@RPTACTNMBR) > 0  select @ACTINDX = isnull(ACTINDX, 0) from GL00105 where ACTINDX = @RPTACTNMBR  If OBJECT_ID('temp..#SVC_CONTRACT_DEFER') is NULL  Begin   create table #SVC_CONTRACT_DEFER   (   MY_GROUP_ID smallint not null default 0,  CONSTS smallint not null default 0,   CONTNBR char(15) not null default '',   CNTTYPE char(11) not null default '',   LNSEQNBR numeric (19,5) not null default 0.00,   SVC_Liability_Type_Txt char(1) not null default '',   HIST char(1) not null default '',   CUSTNMBR char(15) not null default '',   CUSTNAME char(65) not null default '',   ADRSCODE char(15) not null default '',   Contract_Line_Status char(1) not null default '',   STRTDATE datetime not null default '19000101',   ENDDATE datetime not null default '19000101',   Contract_Length smallint not null default 0,   Contract_Period smallint not null default 0,   ITEMNMBR char(31) not null default '',   DSCRIPTN char(60) not null default '',   EQUIPID int not null default 0,   SERLNMBR char(21) not null default '',   QUANTITY numeric (19,5) not null default 0.00,   UOFM char(9) not null default '',   DECPLCUR smallint not null default 0,  CURNCYID char(15) not null default '',   CURRNIDX smallint not null default 0,   SVC_Monthly_Price numeric (19,5) not null default 0.00,   FRSTBLDTE datetime not null default '19000101',   Last_Amount_Billed numeric (19,5) not null default 0.00,   LSTBLDTE datetime not null default '19000101',   TOTAL numeric (19,5) not null default 0.00,   Invoiced_Amount numeric (19,5) not null default 0.00,   Amount_To_Invoice numeric (19,5) not null default 0.00,   NXTBLDTE datetime not null default '19000101',   TOTBIL numeric (19,5) not null default 0.00,   BILONDY smallint not null default 0,   BILCYC smallint not null default 0,   BILSTAT smallint not null default 0,   Liabiltiy_Reduction tinyint not null default 0,   Liability_Amount numeric (19,5) not null default 0.00,   Total_Liability_Amount numeric (19,5) not null default 0.00,   Total_Liability_Billed numeric (19,5) not null default 0.00,   TAXAMNT numeric (19,5) not null default 0.00,  REVLIABACTINDX integer not null default 0,  REVSALESACTINDX integer not null default 0,   ContractRevPostedAmt numeric (19,5) not null default 0.00,  ContractRevUnPostedAmt numeric (19,5) not null default 0.00,  NonInvoicedContractBillings numeric (19,5) not null default 0.00,  GLRevPostedAmt numeric (19,5) not null default 0.00,  GLRevUnPostedAmt numeric (19,5) not null default 0.00,  SOPPostedAmt numeric (19,5) not null default 0.00,  SOPUnPostedAmt numeric (19,5) not null default 0.00,  GLTotalPostedDistAmt numeric (19,5) not null default 0.00,  GLTotalUnPostedDistAmt numeric (19,5) not null default 0.00,  RevRecogDiff numeric(19,5) not null default 0.00,  MY_DEX_ROW_ID int Identity (1,1)   )  end   INSERT INTO #SVC_CONTRACT_DEFER  (  MY_GROUP_ID,  CONSTS,  CONTNBR,  CNTTYPE,  LNSEQNBR,  SVC_Liability_Type_Txt,  HIST,  CUSTNMBR,  CUSTNAME,  ADRSCODE,   Contract_Line_Status,  STRTDATE,  ENDDATE,  Contract_Length,   Contract_Period,   ITEMNMBR,  DSCRIPTN,  EQUIPID,  SERLNMBR,  QUANTITY,  UOFM,  DECPLCUR,  CURNCYID,   CURRNIDX,  SVC_Monthly_Price,  FRSTBLDTE,  Last_Amount_Billed,  LSTBLDTE,  TOTAL,  Invoiced_Amount,  Amount_To_Invoice,  NXTBLDTE,  TOTBIL,  BILONDY,  BILCYC,  BILSTAT,  Liabiltiy_Reduction,  Liability_Amount,  Total_Liability_Amount,  Total_Liability_Billed,  TAXAMNT,  REVLIABACTINDX,  REVSALESACTINDX,  ContractRevPostedAmt,  ContractRevUnPostedAmt,  NonInvoicedContractBillings,  GLRevPostedAmt,  GLRevUnPostedAmt,  SOPPostedAmt,  SOPUnPostedAmt,  GLTotalPostedDistAmt,  GLTotalUnPostedDistAmt,  RevRecogDiff  )   select   0,  CONSTS,CONTNBR, CNTTYPE,   LNSEQNBR, SVC_Liability_Type_Txt,  HIST, CUSTNMBR, CUSTNAME, ADRSCODE, Contract_Line_Status,  STRTDATE,  ENDDATE, Contract_Length, Contract_Period, ITEMNMBR,  DSCRIPTN, EQUIPID ,SERLNMBR,QUANTITY, UOFM ,DECPLCUR, CURNCYID,CURRNIDX,  SVC_Monthly_Price ,  FRSTBLDTE , Last_Amount_Billed, LSTBLDTE, TOTAL, Invoiced_Amount ,  Amount_To_Invoice ,  NXTBLDTE, TOTBIL,  BILONDY, BILCYC, BILSTAT, Liabiltiy_Reduction, Liability_Amount,Total_Liability_Amount, Total_Liability_Billed,TAXAMNT,  dbo.svcGetContractLineLiabIndex(CONSTS, CONTNBR, LNSEQNBR),  dbo.svcGetContractLineSalesIndex(CONSTS, CONTNBR, LNSEQNBR),  dbo.svcGetContractRevPostedAmt(CONSTS, CONTNBR, LNSEQNBR),  dbo.svcGetContractRevUnPostedAmt(CONSTS, CONTNBR, LNSEQNBR),  dbo.svcGetContractLineNonBilledAmount(CONSTS, CONTNBR, LNSEQNBR),  dbo.svcGetContractLineGLRevPostedAmt(CONSTS, CONTNBR, LNSEQNBR),  dbo.svcGetContractLineGLRevUnPostedAmt(CONSTS, CONTNBR, LNSEQNBR),  dbo.svcGetContractSOPPostedAmt(CONSTS, CONTNBR, LNSEQNBR),  dbo.svcGetContractSOPUnPostedAmt(CONSTS, CONTNBR, LNSEQNBR),  0,  0,0  from svcContractLineDeferRev  where CONTNBR >= @FRMCONTNBR and CONTNBR <= @TOCONTNBR and STRTDATE >= @FRMCONT_DATE and STRTDATE <= @TOCONT_DATE  if @DISPLAYOPTION > 0  begin  INSERT INTO #SVC_CONTRACT_DEFER  (  MY_GROUP_ID,  CONSTS,  CONTNBR,  CNTTYPE,  LNSEQNBR,  SVC_Liability_Type_Txt,  HIST,  CUSTNMBR,  CUSTNAME,  ADRSCODE,   Contract_Line_Status,  STRTDATE,  ENDDATE,  Contract_Length,   Contract_Period,   ITEMNMBR,  DSCRIPTN,  EQUIPID,  SERLNMBR,  QUANTITY,  UOFM,  DECPLCUR,  CURNCYID,   CURRNIDX,  SVC_Monthly_Price,  FRSTBLDTE,  Last_Amount_Billed,  LSTBLDTE,  TOTAL,  Invoiced_Amount,  Amount_To_Invoice,  NXTBLDTE,  TOTBIL,  BILONDY,  BILCYC,  BILSTAT,  Liabiltiy_Reduction,  Liability_Amount,  Total_Liability_Amount,  Total_Liability_Billed,  TAXAMNT,  REVLIABACTINDX,  REVSALESACTINDX,  ContractRevPostedAmt,  ContractRevUnPostedAmt,  NonInvoicedContractBillings,  GLRevPostedAmt,  GLRevUnPostedAmt,  SOPPostedAmt,  SOPUnPostedAmt,  GLTotalPostedDistAmt,  GLTotalUnPostedDistAmt,  RevRecogDiff  )   select   0,  CONSTS,CONTNBR, CNTTYPE,   LNSEQNBR, SVC_Liability_Type_Txt,  'H', CUSTNMBR, CUSTNAME, ADRSCODE, Contract_Line_Status,  STRTDATE,  ENDDATE, Contract_Length, Contract_Period, ITEMNMBR,  DSCRIPTN, EQUIPID ,SERLNMBR,QUANTITY, UOFM ,DECPLCUR, CURNCYID,CURRNIDX,  SVC_Monthly_Price ,  FRSTBLDTE , Last_Amount_Billed, LSTBLDTE, TOTAL, Invoiced_Amount ,  Amount_To_Invoice ,  NXTBLDTE, TOTBIL,  BILONDY, BILCYC, BILSTAT, Liabiltiy_Reduction, Liability_Amount,Total_Liability_Amount, Total_Liability_Billed,TAXAMNT,  dbo.svcGetContractLineLiabIndex(CONSTS, CONTNBR, LNSEQNBR),  dbo.svcGetContractLineSalesIndex(CONSTS, CONTNBR, LNSEQNBR),  dbo.svcGetContractHistRevPostedAmt(CONSTS, CONTNBR, LNSEQNBR),  0,   0,   dbo.svcGetContractLineHistGLRevPostedAmt(CONSTS, CONTNBR, LNSEQNBR),  dbo.svcGetContractLineHistGLRevUnPostedAmt(CONSTS, CONTNBR, LNSEQNBR),  dbo.svcGetContractHistSOPPostedAmt(CONSTS, CONTNBR, LNSEQNBR),  dbo.svcGetContractHistSOPUnPostedAmt(CONSTS, CONTNBR, LNSEQNBR),  0,  0,0  from svcContractHistLineDeferRev  where CONTNBR >= @FRMCONTNBR and CONTNBR <= @TOCONTNBR and STRTDATE >= @FRMCONT_DATE and STRTDATE <= @TOCONT_DATE   end update #SVC_CONTRACT_DEFER with (rowlock)  set RevRecogDiff = (SOPPostedAmt + SOPUnPostedAmt + NonInvoicedContractBillings) - (GLRevPostedAmt+ GLRevUnPostedAmt + ContractRevUnPostedAmt)  SELECT MY_GROUP_ID, CONSTS, CONTNBR, CNTTYPE, convert(numeric(19,2), LNSEQNBR) as LNSEQNBR,  SVC_Liability_Type_Txt, HIST, CUSTNMBR, CUSTNAME, ADRSCODE, Contract_Line_Status,  STRTDATE, ENDDATE, Contract_Length, Contract_Period,  ITEMNMBR, DSCRIPTN, EQUIPID, SERLNMBR, QUANTITY, UOFM, DECPLCUR,  CURNCYID, CURRNIDX, SVC_Monthly_Price,  FRSTBLDTE, Last_Amount_Billed, LSTBLDTE, TOTAL, Invoiced_Amount, Amount_To_Invoice,   NXTBLDTE, TOTBIL, BILONDY, BILCYC, BILSTAT,   Liabiltiy_Reduction, Liability_Amount, Total_Liability_Amount, Total_Liability_Billed, TAXAMNT,  REVLIABACTINDX, REVSALESACTINDX,  ContractRevPostedAmt, ContractRevUnPostedAmt, NonInvoicedContractBillings, GLRevPostedAmt, GLRevUnPostedAmt,  SOPPostedAmt, SOPUnPostedAmt, GLTotalPostedDistAmt, GLTotalUnPostedDistAmt, RevRecogDiff  FROM #SVC_CONTRACT_DEFER with (NOLOCK)  WHERE (@ACTINDX <= 0 or (@ACTINDX > 0 and REVLIABACTINDX = @ACTINDX))    and (@DISPLAYOPTION <= 1 or (@DISPLAYOPTION = 2 and RevRecogDiff <> 0))   drop table #SVC_CONTRACT_DEFER    
GO
GRANT EXECUTE ON  [dbo].[see_FSS_SVC_ContractDeferral] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[see_FSS_SVC_ContractDeferral] TO [rpt_dispatcher]
GO
GRANT EXECUTE ON  [dbo].[see_FSS_SVC_ContractDeferral] TO [rpt_executive]
GO
