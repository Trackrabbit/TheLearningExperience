SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aagGetTrxDescrSet]  (  @aaStr VARCHAR (100) ,  @aaFieldCount INTEGER  ,  @aaCodeSequence INTEGER  ,  @aaBudgetTree VARCHAR (51) ,  @RetStr VARCHAR(6000) OUTPUT  ) AS BEGIN  DECLARE @strTemp  VARCHAR(100)  DECLARE @nPos INTEGER  DECLARE @Temp VARCHAR(100)  DECLARE @nCount INTEGER  DECLARE @MaxRowCount INTEGER   DECLARE @MaxCount INTEGER  DECLARE @MaxCountParam nvarchar(500)   DECLARE @TempTable VARCHAR(50)  DECLARE @TempTableQuery nVARCHAR (4000)   SELECT @TempTable = '##TEMP_TEMP'  + REPLACE(system_user,'''','') + db_name()   SELECT @RetStr = ''  SELECT @strTemp = @aaStr  SELECT @nCount = 0  WHILE ( 1 = 1 )  BEGIN  IF LEN(LTRIM(RTRIM(@aaStr))) = 0   BEGIN  SET @RetStr = ','''''   BREAK  END  SELECT @nPos = CHARINDEX (',', @strTemp )  IF @nPos = 0   BEGIN  SELECT @Temp  = @strTemp  SET @aaBudgetTree = ''  END  ELSE  BEGIN  SELECT @Temp = SUBSTRING(@strTemp, 1, (@nPos - 1))  END  SELECT @Temp = '''' + LTRIM(RTRIM(REPLACE(aaTrxDimCodeDescr,'''','''''')))   + '''' FROM AAG00401 WHERE aaTrxDimCodeID = @Temp  SELECT @RetStr = @RetStr + ',' + @Temp   SELECT @strTemp = RIGHT(@strTemp, (LEN(@strTemp) - @nPos))  IF @nPos = 0 BREAK  SET @nCount = @nCount + 1  END    SELECT @TempTableQuery = ' SELECT @MaxCount = COUNT(*) + 1 FROM [' + @TempTable + ']'  set @MaxCountParam = N'@MaxCount int output'   EXEC sp_executesql @TempTableQuery, @MaxCountParam, @MaxCount= @MaxRowCount output   SELECT @RetStr = 'SELECT ''' + CONVERT(VARCHAR(51), @MaxRowCount)   +  ''' AS RowID,''' + CONVERT(VARCHAR(51), @aaCodeSequence) +  ''' AS aaCodeSequence,'''   + REPLACE(@aaBudgetTree,'''','''''') + ''' AS aaBudgetTree' + ',' + RIGHT( @RetStr, LEN(@RetStr)-1)  WHILE @aaFieldCount > @nCount + 1  BEGIN  SELECT @RetStr = @RetStr + ','''''  SET @nCount = @nCount + 1  END END    
GO
GRANT EXECUTE ON  [dbo].[aagGetTrxDescrSet] TO [DYNGRP]
GO
