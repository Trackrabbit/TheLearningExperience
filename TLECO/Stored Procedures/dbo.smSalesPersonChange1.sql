SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
create procedure [dbo].[smSalesPersonChange1]  @I_charStartSalesperson 	char(30),  @I_charEndSalesperson 		char(30),  @O_iErrorState 			int = NULL  output with encryption as set transaction isolation level read uncommitted set nocount on declare  @SLPRSNID  		char (255), @tTransaction		tinyint, @tLoop			tinyint, @iStatus		int, @cStartSalesperson	char(50), @cEndSalesperson	char(50) exec @iStatus = smFormatStringsForExecs @I_vInputString  = @I_charStartSalesperson, @O_cOutputString = @cStartSalesperson output, @O_iErrorState	 = @O_iErrorState output if @iStatus <> 0 or @O_iErrorState <> 0 begin set @O_iErrorState = 90 return end exec @iStatus = smFormatStringsForExecs @I_vInputString  = @I_charEndSalesperson, @O_cOutputString = @cEndSalesperson output, @O_iErrorState	 = @O_iErrorState output if @iStatus <> 0 or @O_iErrorState <> 0 begin set @O_iErrorState = 91 return end select 	@O_iErrorState 	 = 0 if @@trancount = 0    begin select @tTransaction = 1 begin transaction end while ( @tLoop is NULL ) begin select @tLoop = 1 if	@I_charStartSalesperson	is NULL or @I_charEndSalesperson	is NULL or @cStartSalesperson	is NULL or @cEndSalesperson	is NULL begin select @O_iErrorState = 1		 break end  if exists (select * from sysobjects where id = object_id('dbo.taCustomerInsert')) alter table RM00101 disable trigger taCustomerInsert if @@error <> 0  begin select @O_iErrorState = 4	 break end if exists (select * from sysobjects where id = object_id('dbo.taCustomerAddressInsert')) alter table RM00102 disable trigger taCustomerAddressInsert if @@error <> 0  begin select @O_iErrorState = 5	 break end declare ta_SMCursor insensitive CURSOR for select 'update '+o.name+' set SLPRSNID =' + rtrim(@cEndSalesperson) + ' where SLPRSNID = ' + rtrim(@cStartSalesperson)  from sysobjects o, syscolumns c where	o.id = c.id and o.type = 'U' and c.name = 'SLPRSNID'  order by o.name set nocount on OPEN ta_SMCursor FETCH NEXT FROM ta_SMCursor INTO @SLPRSNID WHILE (@@FETCH_STATUS <> -1) begin exec (@SLPRSNID) if @@error <> 0  begin select @O_iErrorState = 2	 break end  FETCH NEXT FROM ta_SMCursor INTO @SLPRSNID end DEALLOCATE ta_SMCursor if @O_iErrorState <> 0 break declare ta_SMCursor insensitive CURSOR for select 'update '+o.name+' set STSPRSID =' + rtrim(@cEndSalesperson) + ' where STSPRSID = ' + rtrim(@cStartSalesperson)  from sysobjects o, syscolumns c where	o.id = c.id and o.type = 'U' and c.name = 'STSPRSID'  order by o.name set nocount on OPEN ta_SMCursor FETCH NEXT FROM ta_SMCursor INTO @SLPRSNID WHILE (@@FETCH_STATUS <> -1) begin exec (@SLPRSNID) if @@error <> 0  begin select @O_iErrorState = 3	 break end  FETCH NEXT FROM ta_SMCursor INTO @SLPRSNID end DEALLOCATE ta_SMCursor if @O_iErrorState <> 0 break declare ta_SMCursor insensitive CURSOR for select 'update '+o.name+' set ENSPSNID =' + rtrim(@cEndSalesperson) + ' where ENSPSNID = ' + rtrim(@cStartSalesperson)  from sysobjects o, syscolumns c where	o.id = c.id and o.type = 'U' and c.name = 'ENSPSNID'  order by o.name set nocount on OPEN ta_SMCursor FETCH NEXT FROM ta_SMCursor INTO @SLPRSNID WHILE (@@FETCH_STATUS <> -1) begin exec (@SLPRSNID) if @@error <> 0  begin select @O_iErrorState = 4	 break end  FETCH NEXT FROM ta_SMCursor INTO @SLPRSNID end DEALLOCATE ta_SMCursor if @O_iErrorState <> 0 break update SY01200 set Master_ID = @I_charEndSalesperson where Master_ID = @I_charStartSalesperson and Master_Type = 'SLP' if @@error <> 0  begin select @O_iErrorState = 5 		 break end  end  if exists (select * from sysobjects where id = object_id('dbo.taCustomerInsert')) alter table RM00101 enable trigger taCustomerInsert if @@error <> 0  begin select @O_iErrorState = 29	 end if exists (select * from sysobjects where id = object_id('dbo.taCustomerAddressInsert')) alter table RM00102 enable trigger taCustomerAddressInsert if @@error <> 0  begin select @O_iErrorState = 30	 end if @O_iErrorState <> 0 begin if @tTransaction = 1 rollback transaction end else if @tTransaction = 1 begin commit transaction end return  
GO
GRANT EXECUTE ON  [dbo].[smSalesPersonChange1] TO [DYNGRP]
GO
