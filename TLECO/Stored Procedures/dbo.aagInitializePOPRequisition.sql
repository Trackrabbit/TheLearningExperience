SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aagInitializePOPRequisition]  @POPRequisitionNumber CHAR(17),  @CompanyID SMALLINT,  @SqlSessionID INT,  @l_ErrorCode SMALLINT = NULL OUTPUT AS  BEGIN   DECLARE   @LineNumber                              CHAR(11),   @ORD INT,  @aaSubLedgerHdrID INT,  @aaSubLedgerDistID INT,  @aaDistID INT,  @ACTINDX INT,  @ClassID INT,  @VENDORID CHAR(15),  @CURNCYID CHAR(15),  @RATETPID CHAR(15),   @EXGTBLID CHAR(15),   @DECPLCUR SMALLINT,  @ACCTTYPE SMALLINT,  @aaBrowseType SMALLINT,  @CURRNIDX SMALLINT,  @NOTEINDX NUMERIC(19,5),  @EXTDCOST NUMERIC(19,7),  @OREXTCST NUMERIC(19,7),  @PreRequisitionDocType TINYINT,  @oRequiredFieldEmpty TINYINT,  @XCHGRATE NUMERIC(19,7),  @EXCHDATE DATETIME,  @TIME1 DATETIME,  @RATECALC SMALLINT,  @DENXRATE NUMERIC(19,7),  @MCTRXSTT SMALLINT,  @SERIES INT,  @REQDATE DATETIME   SELECT @SERIES = 12, @PreRequisitionDocType = 21, @aaSubLedgerHdrID = 0, @aaSubLedgerDistID = 0  SELECT @aaSubLedgerHdrID = ISNULL(aaSubLedgerHdrID,0) FROM AAG20000 WHERE DOCNUMBR = @POPRequisitionNumber AND SERIES = @SERIES AND DOCTYPE = @PreRequisitionDocType  IF @aaSubLedgerHdrID = 0 OR NOT EXISTS (select @aaSubLedgerHdrID)  BEGIN  EXEC DYNAMICS.dbo.aagGetNextID 20000, @CompanyID, @aaSubLedgerHdrID OUTPUT   INSERT INTO AAG20000 (aaSubLedgerHdrID, SERIES, DOCTYPE, DOCNUMBR, Master_ID, aaHdrErrors)   VALUES (@aaSubLedgerHdrID, @SERIES, @PreRequisitionDocType, @POPRequisitionNumber, '', 0)  END   UPDATE AAG20001 SET [TRNSTLOC] = LineNumber FROM AAG20001 INNER JOIN POP10210 ON POPRequisitionNumber = @POPRequisitionNumber AND ORD = SEQNUMBR and  aaSubLedgerHdrID = @aaSubLedgerHdrID   DECLARE Cursor1 CURSOR LOCAL FAST_FORWARD FOR  SELECT DISTINCT ORD, LineNumber, VENDORID, REQDATE, INVINDX, EXTDCOST, OREXTCST, DECPLCUR, CURNCYID, CURRNIDX,  RATETPID, EXGTBLID, XCHGRATE, EXCHDATE, TIME1, RATECALC, DENXRATE, MCTRXSTT   FROM POP10210 WHERE POPRequisitionNumber = @POPRequisitionNumber ORDER BY LineNumber ASC   OPEN Cursor1  FETCH NEXT FROM Cursor1 INTO @ORD, @LineNumber, @VENDORID, @REQDATE, @ACTINDX, @EXTDCOST, @OREXTCST, @DECPLCUR, @CURNCYID, @CURRNIDX,  @RATETPID, @EXGTBLID, @XCHGRATE, @EXCHDATE, @TIME1, @RATECALC, @DENXRATE, @MCTRXSTT  WHILE @@FETCH_STATUS = 0  BEGIN  SELECT @aaSubLedgerDistID = ISNULL(MAX(aaSubLedgerDistID),0)+1 FROM AAG20001 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID   IF NOT EXISTS (SELECT TOP 1 1 FROM AAG20001 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND SEQNUMBR =  @ORD AND ACTINDX = @ACTINDX AND  TRNSTLOC = @LineNumber AND CURNCYID = @CURNCYID AND CURRNIDX = @CURRNIDX AND  RATETPID = @RATETPID AND EXGTBLID = @EXGTBLID AND XCHGRATE = @XCHGRATE AND   EXCHDATE = @EXCHDATE AND TIME1 = @TIME1 AND RTCLCMTD = @RATECALC AND   DENXRATE = @DENXRATE AND MCTRXSTT = @MCTRXSTT AND DEBITAMT = @EXTDCOST AND ORDBTAMT = @OREXTCST)  BEGIN  IF EXISTS(SELECT TOP 1 1 FROM AAG20001 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND SEQNUMBR=  @ORD AND TRNSTLOC = @LineNumber)  BEGIN  SELECT @aaDistID = ISNULL(aaSubLedgerDistID,0) FROM AAG20001 WHERE SEQNUMBR =  @ORD AND TRNSTLOC = @LineNumber  DELETE FROM AAG20003 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaDistID  DELETE FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaDistID  DELETE FROM AAG20001 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaDistID  END   EXEC aagGetClassIDBrowseType   @ACTINDX,   @ClassID OUTPUT,   @aaBrowseType OUTPUT    SELECT TOP 1 @ACCTTYPE = ACCTTYPE FROM GL00100 WHERE ACTINDX = @ACTINDX  IF @ACTINDX = 0 SET @aaBrowseType = 0  EXEC DYNAMICS.dbo.smGetNextNoteIndex @CompanyID, @SqlSessionID, @NOTEINDX OUTPUT  IF (@EXTDCOST > 0 OR @OREXTCST > 0) AND @ACTINDX > 0  BEGIN  INSERT INTO AAG20001 (  [aaSubLedgerHdrID], [aaSubLedgerDistID], [INTERID], [CorrespondingUnit], [ACTINDX], [DISTTYPE], [SEQNUMBR], [TRNSTLOC],  [ACCTTYPE], [aaBrowseType], [DECPLACS], [DEBITAMT], [ORDBTAMT], [CRDTAMNT], [ORCRDAMT], [CURNCYID], [CURRNIDX],   [RATETPID], [EXGTBLID], [XCHGRATE], [EXCHDATE], [TIME1], [RTCLCMTD], [DENXRATE], [MCTRXSTT],  [GLPOSTDT], [aaCopyStatus], [aaWinWasOpen], [aaChangeDate],[aaChangeTime])  SELECT TOP 1  @aaSubLedgerHdrID, @aaSubLedgerDistID, DB_NAME(), '', @ACTINDX, 0, @ORD, @LineNumber,  ISNULL(@ACCTTYPE,0), @aaBrowseType, @DECPLCUR, @EXTDCOST, @OREXTCST, 0, 0, @CURNCYID, @CURRNIDX,  @RATETPID, @EXGTBLID, @XCHGRATE, @EXCHDATE, @TIME1, @RATECALC, @DENXRATE, @MCTRXSTT,  @REQDATE, 8, 0, CONVERT(CHAR(12), GETDATE(), 102), CONVERT(CHAR(12), GETDATE(), 108)  INSERT INTO AAG20002 ([aaSubLedgerHdrID], [aaSubLedgerDistID], [aaSubLedgerAssignID], [DEBITAMT], [ORDBTAMT], [CRDTAMNT],  [ORCRDAMT], [aaAssignedPercent],[NOTEINDX])  VALUES( @aaSubLedgerHdrID, @aaSubLedgerDistID, 1, @EXTDCOST, @OREXTCST, 0, 0, 10000, @NOTEINDX)   IF @aaBrowseType <> 0  AND NOT EXISTS  (SELECT 1 FROM AAG20003  WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID  AND aaSubLedgerDistID = @aaSubLedgerDistID  AND aaSubLedgerAssignID = 1)  BEGIN  EXEC aagSubWorkCodeUpdate  @aaSubLedgerHdrID,  @aaSubLedgerDistID,  1,  @ClassID,  @oRequiredFieldEmpty OUTPUT  END  END  END   FETCH NEXT FROM Cursor1 INTO @ORD, @LineNumber, @VENDORID, @REQDATE, @ACTINDX, @EXTDCOST, @OREXTCST, @DECPLCUR, @CURNCYID, @CURRNIDX,  @RATETPID, @EXGTBLID, @XCHGRATE, @EXCHDATE, @TIME1, @RATECALC, @DENXRATE, @MCTRXSTT  END  CLOSE Cursor1  DEALLOCATE Cursor1  IF NOT EXISTS(SELECT TOP 1 1 FROM AAG20001 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID)  DELETE FROM AAG20000 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID END   
GO
GRANT EXECUTE ON  [dbo].[aagInitializePOPRequisition] TO [DYNGRP]
GO
