SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[seepmPayablesSummaryInquiryByVendorID]  @I_cTableName char(25) = NULL,  @I_dAgingDate datetime = NULL,  @I_vVendorID varchar(max) as  declare  @vSelect_Statement1 varchar(255),  @sNumOfPeriods   int,  @iStatus            int,  @iError             int,  @max_date datetime,  @dMinDate datetime  declare  @Vendors table (VENDORID nvarchar(500))  create table #PayablesSummTemp (RCRDTYPE smallint NOT NULL,  DOCTYPE smallint NOT NULL,  CURTRXAM numeric(19,5) NOT NULL,  DOCAMNT numeric(19,5) NOT NULL,  RECCOUNT numeric(19,5) NOT NULL,  PERIODID smallint NOT NULL,  VENDORID char(15) NOT NULL,  DEX_ROW_ID int identity NOT NULL)  create table #EndingPeriodDates (  PERIODID  int   not null,  STARTDATE datetime not null,  ENDDATE datetime not null)  insert into @Vendors select * from dbo.seeSplitString(@I_vVendorID, ',')  if (@I_vVendorID = '') begin    exec @iStatus = smGetMinDate @dMinDate output  select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   select   @sNumOfPeriods = INDEX1   from   PM40101 with (NOLOCK)  where   ENDGPDYS = 999   select @max_date = dbo.GetDefaultMaxDate()   insert into  #EndingPeriodDates  select  PERIODID = INDEX1,  STARTDATE = dateadd(dd,-ENDGPDYS,@I_dAgingDate),  ENDDATE = @max_date  from  PM40101  with (NOLOCK)  where  INDEX1 < @sNumOfPeriods   insert into  #EndingPeriodDates  select @sNumOfPeriods,  @dMinDate,  dateadd(dd,-1,STARTDATE)  from  #EndingPeriodDates with (NOLOCK)  where  PERIODID = (@sNumOfPeriods -1 )   update  #EndingPeriodDates  set  ENDDATE = ( select   dateadd(dd,-1,STARTDATE)   from   #EndingPeriodDates a  where   a.PERIODID = #EndingPeriodDates.PERIODID - 1)  where  PERIODID > 1  and PERIODID < @sNumOfPeriods   INSERT INTO #PayablesSummTemp (RCRDTYPE,DOCTYPE,CURTRXAM,DOCAMNT,RECCOUNT,PERIODID,VENDORID)  SELECT 1,  DOCTYPE,  isnull(sum(PM20000.CURTRXAM),0.00),  isnull(sum(PM20000.DOCAMNT),0.00),  isnull(count(PM20000.VENDORID),0.00),  0,  ''  FROM  PM00200 with (NOLOCK),  PM20000 with (NOLOCK)   WHERE  PM00200.VENDORID = PM20000.VENDORID  GROUP BY  DOCTYPE   INSERT INTO #PayablesSummTemp (RCRDTYPE,DOCTYPE,CURTRXAM,DOCAMNT,RECCOUNT,PERIODID,VENDORID)  SELECT  2,  DOCTYPE,  isnull(sum(PM20000.CURTRXAM),0.00),  0.00,  0,  PERIODID,  ''  FROM PM00200 with (NOLOCK),  PM20000 with (NOLOCK),  PM40100 with (NOLOCK),  #EndingPeriodDates  WHERE  PM00200.VENDORID = PM20000.VENDORID  AND CASE when AGEBY = 0   AND DOCTYPE < 4   then PM20000.DUEDATE  else PM20000.DOCDATE   END   BETWEEN STARTDATE and ENDDATE  GROUP BY  PERIODID,DOCTYPE  end else begin     exec @iStatus = smGetMinDate @dMinDate output  select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   select   @sNumOfPeriods = INDEX1   from   PM40101 with (NOLOCK)  where   ENDGPDYS = 999   select @max_date = dbo.GetDefaultMaxDate()   insert into  #EndingPeriodDates  select  PERIODID = INDEX1,  STARTDATE = dateadd(dd,-ENDGPDYS,@I_dAgingDate),  ENDDATE = @max_date  from  PM40101  with (NOLOCK)  where  INDEX1 < @sNumOfPeriods   insert into  #EndingPeriodDates  select @sNumOfPeriods,  @dMinDate,  dateadd(dd,-1,STARTDATE)  from  #EndingPeriodDates with (NOLOCK)  where  PERIODID = (@sNumOfPeriods -1 )   update  #EndingPeriodDates  set  ENDDATE = ( select   dateadd(dd,-1,STARTDATE)   from   #EndingPeriodDates a  where   a.PERIODID = #EndingPeriodDates.PERIODID - 1)  where  PERIODID > 1  and PERIODID < @sNumOfPeriods   INSERT INTO #PayablesSummTemp (RCRDTYPE,DOCTYPE,CURTRXAM,DOCAMNT,RECCOUNT,PERIODID,VENDORID)  SELECT 1,  DOCTYPE,  isnull(sum(PM20000.CURTRXAM),0.00),  isnull(sum(PM20000.DOCAMNT),0.00),  isnull(count(PM20000.VENDORID),0.00),  0,  PM20000.VENDORID   FROM  PM00200 with (NOLOCK),  PM20000 with (NOLOCK)  INNER JOIN @Vendors a ON PM20000.VENDORID = a.VENDORID   WHERE  PM00200.VENDORID = PM20000.VENDORID  GROUP BY  PM20000.VENDORID, DOCTYPE   INSERT INTO #PayablesSummTemp (RCRDTYPE,DOCTYPE,CURTRXAM,DOCAMNT,RECCOUNT,PERIODID,VENDORID)  SELECT  2,  DOCTYPE,  isnull(sum(PM20000.CURTRXAM),0.00),  0.00,  0,  PERIODID,  PM20000.VENDORID  FROM PM00200 with (NOLOCK),  PM40100 with (NOLOCK),  #EndingPeriodDates,  PM20000 with (NOLOCK)  INNER JOIN @Vendors a ON PM20000.VENDORID = a.VENDORID   WHERE  PM00200.VENDORID = PM20000.VENDORID  AND CASE when AGEBY = 0   AND DOCTYPE < 4   then PM20000.DUEDATE  else PM20000.DOCDATE   END   BETWEEN STARTDATE and ENDDATE  GROUP BY  PM20000.VENDORID, PERIODID,DOCTYPE end  exec ('insert into ' + @I_cTableName + ' select RCRDTYPE,DOCTYPE,CURTRXAM,DOCAMNT,RECCOUNT,PERIODID,VENDORID from #PayablesSummTemp') drop table #PayablesSummTemp  return(@iStatus)   
GO
GRANT EXECUTE ON  [dbo].[seepmPayablesSummaryInquiryByVendorID] TO [DYNGRP]
GO
