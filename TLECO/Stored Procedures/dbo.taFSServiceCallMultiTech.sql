SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[taFSServiceCallMultiTech] @I_vSRVRECTYPE  smallint,    @I_vCALLNBR char(11),     @I_vITEMNMBR char(31) = '',    @I_vSERLNMBR char(21) = '',    @I_vEQPLINE int = 0,     @I_vLNITMSEQ int = 0,     @I_vCUSTNMBR char(15) = '',    @I_vTECHID char (11) = '',    @I_vUpdateIfExists tinyint = 0,   @I_vRequesterTrx smallint = 0,   @I_vUSRDEFND1 char(50) = '',   @I_vUSRDEFND2 char(50) = '',     @I_vUSRDEFND3 char(50) = '',   @I_vUSRDEFND4 varchar(8000) = '',  @I_vUSRDEFND5 varchar(8000) = '',  @O_iErrorState int output,    @oErrString varchar(255) output    with encryption as  set transaction isolation level read uncommitted set nocount on  declare  @iEQPLINE int,  @iStatus int,  @iLNITMSEQ int,  @iCustomState int,  @iCustomErrString varchar(255),  @iAddCodeErrState int,      @O_oErrorState int,  @iError int,  @EQUIPID int,  @iLineCount int,  @TECHSTAT char(11),  @Tech_Available int  select   @iEQPLINE = 0,  @iStatus  = 0,  @iLNITMSEQ = 0,  @iCustomState  = 0,  @iCustomErrString = '',  @iAddCodeErrState = 0,  @O_oErrorState  = 0,  @iError  = 0,  @EQUIPID = 0,  @iLineCount = 0,  @TECHSTAT = '',  @Tech_Available = 0  if (@oErrString is NULL) begin  select @oErrString = '' end  exec @iStatus = taFSServiceCallMultiTechPre  @I_vSRVRECTYPE output,  @I_vCALLNBR  output,  @I_vITEMNMBR  output,  @I_vSERLNMBR output,  @I_vEQPLINE output,  @I_vLNITMSEQ output,  @I_vCUSTNMBR output,  @I_vTECHID  output,  @I_vUpdateIfExists output,  @I_vRequesterTrx output,  @I_vUSRDEFND1 output,  @I_vUSRDEFND2 output,  @I_vUSRDEFND3 output,  @I_vUSRDEFND4 output,  @I_vUSRDEFND5 output,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if @iStatus = 0 and @iError <> 0 begin  select @iStatus = @iError end if (@iStatus <> 0) or (@iCustomState <> 0) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  set @O_iErrorState = 11405     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if( @I_vSRVRECTYPE is NULL or  @I_vCALLNBR is NULL or  @I_vITEMNMBR is NULL or  @I_vSERLNMBR is NULL or  @I_vEQPLINE is NULL or  @I_vLNITMSEQ is NULL or  @I_vCUSTNMBR is NULL or  @I_vTECHID is NULL  ) begin  set @O_iErrorState = 11406    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if( @I_vSRVRECTYPE = 0 or  @I_vCALLNBR = '' or  (@I_vITEMNMBR = '' and @I_vSERLNMBR <> '') or  (@I_vITEMNMBR <> '' and @I_vSERLNMBR = '') or  @I_vCUSTNMBR = '' or  @I_vTECHID = ''  ) begin  set @O_iErrorState = 11407    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if (@I_vUpdateIfExists not in (0,1)) begin  set @O_iErrorState = 11408     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  select  @I_vCALLNBR = UPPER(@I_vCALLNBR),  @I_vITEMNMBR = UPPER(@I_vITEMNMBR),  @I_vSERLNMBR = UPPER(@I_vSERLNMBR),  @I_vCUSTNMBR = UPPER(@I_vCUSTNMBR),  @I_vTECHID = UPPER(@I_vTECHID)  if exists (select 1 from SVC30200 (nolock) where CALLNBR = @I_vCALLNBR and SRVRECTYPE = 3) or   exists (select 1 from SVC00200 (nolock) where CALLNBR = @I_vCALLNBR and SRVRECTYPE = 3) begin  select @O_iErrorState = 11409     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if (@I_vSRVRECTYPE < 1 or @I_vSRVRECTYPE > 3) begin  set @O_iErrorState = 11410    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if exists (select 1 from SVC00215 (nolock) where SRVRECTYPE = @I_vSRVRECTYPE and CALLNBR = @I_vCALLNBR and MKDTOPST = 1) begin  set @O_iErrorState = 11411    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if (@I_vSERLNMBR <> '') and (@I_vITEMNMBR <> '') begin  if not exists (select 1 from SVC00300 (nolock) where ITEMNMBR=@I_vITEMNMBR AND SERLNMBR = @I_vSERLNMBR AND CUSTNMBR = @I_vCUSTNMBR)  begin  set @O_iErrorState = 11412     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end   select @EQUIPID = isnull(EQUIPID,0) from SVC00300 (nolock)   where ITEMNMBR=@I_vITEMNMBR AND SERLNMBR = @I_vSERLNMBR AND CUSTNMBR = @I_vCUSTNMBR end  if @I_vEQPLINE < 0 begin  set @O_iErrorState = 11413     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if (@EQUIPID <> 0) and (@I_vEQPLINE > 0)  begin  if not exists (select 1 from SVC00202 where SRVRECTYPE = @I_vSRVRECTYPE and CALLNBR = @I_vCALLNBR and   EQPLINE = @I_vEQPLINE and EQUIPID = @EQUIPID)  begin  set @O_iErrorState = 11414     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end  else  begin  select @iEQPLINE = @I_vEQPLINE  end end else if (@EQUIPID <> 0) and (@I_vEQPLINE = 0)  begin  select @iLineCount = count(SRVRECTYPE) from SVC00202 (nolock) where SRVRECTYPE = @I_vSRVRECTYPE and   CALLNBR = @I_vCALLNBR and EQUIPID = @EQUIPID   if @iLineCount > 1  begin  select @O_iErrorState = 11415     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  else  if @iLineCount = 0  begin  select @O_iErrorState = 11416     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  else  begin  select @iEQPLINE = ISNULL(EQPLINE, 0) from SVC00202 (nolock) where SRVRECTYPE = @I_vSRVRECTYPE and   CALLNBR = @I_vCALLNBR and EQUIPID = @EQUIPID  end end else if (@EQUIPID = 0) and (@I_vEQPLINE <> 0)  begin  if not exists (select 1 from SVC00202 where SRVRECTYPE = @I_vSRVRECTYPE and CALLNBR = @I_vCALLNBR and   EQPLINE = @I_vEQPLINE)  begin  set @O_iErrorState = 11417     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end  select @iEQPLINE = @I_vEQPLINE end  else if (@EQUIPID = 0) and (@I_vEQPLINE = 0) begin  select @iEQPLINE = 1 end  if not exists(select 1 from RM00101 (nolock) where CUSTNMBR=@I_vCUSTNMBR) begin  set @O_iErrorState = 11418     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if not exists (select 1 from SVC00100 (nolock) where TECHID = @I_vTECHID) begin  select @O_iErrorState = 11419     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end select @TECHSTAT = isnull(TECHSTAT,'') from SVC00100 (nolock) where TECHID = @I_vTECHID select @Tech_Available = isnull(Tech_Available,0) from SVC00905 (nolock) where TECHSTAT = @TECHSTAT if (@Tech_Available=0) begin  select @O_iErrorState = 11420     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if @I_vUpdateIfExists = 0 begin  if exists (select 1 from SVC00207 where SRVRECTYPE = @I_vSRVRECTYPE and CALLNBR = @I_vCALLNBR and   EQPLINE = @iEQPLINE and TECHID = @I_vTECHID)  begin  select @O_iErrorState = 11421     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end  else  if exists (select 1 from SVC00207 where SRVRECTYPE = @I_vSRVRECTYPE and CALLNBR = @I_vCALLNBR and   EQPLINE = @iEQPLINE and LNITMSEQ = @I_vLNITMSEQ)  begin  select @O_iErrorState = 11430     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end  if @I_vUpdateIfExists = 1 begin  if @I_vLNITMSEQ = 0  begin  select @O_iErrorState = 11422     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end  else  if not exists (select 1 from SVC00207 where SRVRECTYPE = @I_vSRVRECTYPE and CALLNBR = @I_vCALLNBR and   EQPLINE = @iEQPLINE and LNITMSEQ = @I_vLNITMSEQ)  begin  select @O_iErrorState = 11423     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end  select @iLNITMSEQ = @I_vLNITMSEQ end  if @iLNITMSEQ = 0 begin  select @iLNITMSEQ=(isnull(max(LNITMSEQ),0)+1) from SVC00207 (nolock) where SRVRECTYPE = @I_vSRVRECTYPE and   CALLNBR = @I_vCALLNBR and EQPLINE = @iEQPLINE end  if @iLNITMSEQ = 0 begin  select @O_iErrorState = 11424     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if @I_vTECHID <> '' begin  if @I_vUpdateIfExists = 0  begin  insert into SVC00207( SRVRECTYPE,  CALLNBR,  EQPLINE,  LNITMSEQ,  TECHID  )  select  @I_vSRVRECTYPE,  @I_vCALLNBR,  @iEQPLINE,  @iLNITMSEQ,  @I_vTECHID  if (@@error <> 0)  begin  set @O_iErrorState = 11425    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState)  end  end  else  begin  if @I_vUpdateIfExists > 0  begin  update SVC00207 set  TECHID = @I_vTECHID  where SRVRECTYPE = @I_vSRVRECTYPE and CALLNBR = @I_vCALLNBR and EQPLINE = @iEQPLINE and LNITMSEQ = @iLNITMSEQ  if (@@error <> 0)  begin  set @O_iErrorState = 11427    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState)  end  end  end   update SVC00200 set TECHID = '' where SRVRECTYPE = @I_vSRVRECTYPE and CALLNBR = @I_vCALLNBR  if (@@error <> 0)  begin  set @O_iErrorState = 11428    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @iAddCodeErrState output  return (@O_iErrorState)  end end  exec @iStatus = taFSServiceCallMultiTechPost  @I_vSRVRECTYPE,  @I_vCALLNBR,  @I_vITEMNMBR,  @I_vSERLNMBR,  @I_vEQPLINE,  @I_vLNITMSEQ,  @I_vCUSTNMBR,  @I_vTECHID,  @I_vUpdateIfExists,  @I_vRequesterTrx,  @I_vUSRDEFND1,  @I_vUSRDEFND2,  @I_vUSRDEFND3,  @I_vUSRDEFND4,  @I_vUSRDEFND5,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if @iStatus = 0 and @iError <> 0 begin  select @iStatus = @iError end if (@iStatus <> 0) or (@iCustomState <> 0) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  set @O_iErrorState = 11429    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  return (@O_iErrorState)   
GO
GRANT EXECUTE ON  [dbo].[taFSServiceCallMultiTech] TO [DYNGRP]
GO
