SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_Update_Contract_Total]  @CONSTS smallint,  @CONTNBR char(11) AS declare @CTOTAL numeric(19,2) declare @CTOTALUNIT numeric(19,2) declare @CAMTTOINVOICE numeric(19,2) declare @CAMTTOINVOICEMETER numeric(19,2) declare @CINVAMT numeric(19,2) declare @CORIGTOTAL numeric(19,2) declare @CORIGTOTALUNIT numeric(19,2) declare @CORIGAMTTOINVOICE numeric(19,2) declare @CORIGAMTTOINVOICEMETER numeric(19,2) declare @CORIGINVAMT numeric(19,2) declare @CORIGDiscount numeric(19,2) declare @CNUMOFINV integer declare @NEXTBILLDATE datetime declare @MONTHS integer declare @msg varchar(20) declare @CDiscount numeric(19,2)  UPDATE SVC00601 with (ROWLOCK) SET TOTAL = ROUND((Total_Unit * QUANTITY),2),  ORIGTOTAL = ROUND((Originating_Total_Unit * QUANTITY),2)  WHERE CONSTS = @CONSTS AND   CONTNBR = @CONTNBR AND CNTPRCOVR = 0 UPDATE SVC00601 with (ROWLOCK) SET  Unit_Cost_Total =(UNITCOST * QUANTITY),  ORIGUNITCOSTTOTAL =(ORUNTCST * QUANTITY)  WHERE CONSTS = @CONSTS and CONTNBR = @CONTNBR if @@error <> 0 goto baderror SELECT @CTOTAL = ISNULL(SUM(SVC00601.TOTAL),0),  @CTOTALUNIT = ISNULL(SUM(SVC00601.Unit_Cost_Total),0),  @CINVAMT = ISNULL(SUM(SVC00601.Invoiced_Amount),0),  @CNUMOFINV = ISNULL(MAX(SVC00601.NUMOFINV),0),  @CDiscount = ISNULL(SUM(SVC00601.DSCDLRAM),0),  @CORIGTOTAL = ISNULL(SUM(SVC00601.ORIGTOTAL),0),  @CORIGTOTALUNIT = ISNULL(SUM(SVC00601.ORIGUNITCOSTTOTAL),0),  @CORIGINVAMT = ISNULL(SUM(SVC00601.Orig_Invoiced_Amount),0),  @CORIGDiscount = ISNULL(SUM(SVC00601.ORDDLRAT),0) FROM SVC00601  WHERE (SVC00601.CONSTS = @CONSTS AND SVC00601.CONTNBR = @CONTNBR AND  SVC00601.Contract_Line_Status <> 'C') if @@error <> 0 goto baderror select  @NEXTBILLDATE = MIN(SVC00603.INVODATE),  @CAMTTOINVOICE= SUM(DOCAMNT),  @CORIGAMTTOINVOICE= SUM(ORDOCAMT)  from   SVC00603  where  SVC00603.CONSTS = @CONSTS and  SVC00603.CONTNBR = @CONTNBR and  SVC00603.POSTED = 0  select @CAMTTOINVOICE = isnull(@CAMTTOINVOICE,0)   select @CAMTTOINVOICEMETER = sum(isnull(SVC00607.Amount_To_Invoice,0)),  @CORIGAMTTOINVOICEMETER = sum(isnull(SVC00607.Orig_Amount_To_Invoice,0)) from SVC00607  where SVC00607.CONSTS = @CONSTS and SVC00607.CONTNBR = @CONTNBR if @CAMTTOINVOICEMETER <> 0  begin  select @CAMTTOINVOICE = @CAMTTOINVOICE + @CAMTTOINVOICEMETER,  @CORIGAMTTOINVOICE = @CORIGAMTTOINVOICE + @CORIGAMTTOINVOICEMETER   if @CNUMOFINV = 0 or @CNUMOFINV is null  select @CNUMOFINV = 1  END UPDATE SVC00600  with (ROWLOCK)  SET SVC00600.TOTAL = @CTOTAL,  SVC00600.Total_Unit = @CTOTALUNIT,  SVC00600.Amount_To_Invoice = IsNull(@CAMTTOINVOICE,0),  SVC00600.ORDDLRAT = @CORIGDiscount,   SVC00600.ORIGTOTAL = @CORIGTOTAL,  SVC00600.Originating_Total_Unit = @CORIGTOTALUNIT,   SVC00600.Orig_Amount_To_Invoice = IsNull(@CORIGAMTTOINVOICE,0),  SVC00600.NUMOFINV = @CNUMOFINV,  SVC00600.NXTBLDTE = IsNull(@NEXTBILLDATE,'January 1, 2900 00:00:00') FROM SVC00600 WHERE SVC00600.CONSTS = @CONSTS AND   SVC00600.CONTNBR = @CONTNBR if @@error <> 0 goto baderror  return baderror:   return @@error    
GO
GRANT EXECUTE ON  [dbo].[SVC_Update_Contract_Total] TO [DYNGRP]
GO
