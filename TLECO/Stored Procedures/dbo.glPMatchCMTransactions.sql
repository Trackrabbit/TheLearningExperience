SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[glPMatchCMTransactions]  @iGLTempTable VARCHAR(50),  @iCMTempTable VARCHAR(50),  @iCMPMatchTable VARCHAR(50),  @iGLPMatchTable VARCHAR(50)  AS  BEGIN  DECLARE  @lSQLError INT, @Statement VARCHAR(2000)  SELECT @Statement = ''   EXEC(  'INSERT INTO ' +  @iCMPMatchTable +  ' (POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,   TrxNumDrillBack)  SELECT  POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, '''', VOIDED,   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppCMTransactionZoom(0,CMRECNUM) AS   TrxNumDrillBack   FROM  ' +  @iCMTempTable + ' JOIN ' + @iGLTempTable + ' ON POSTEDDT <> TRXDATE AND TRXSORCE = ORTRXSRC AND DOCNUMBR = ORCTRNUM AND  (DepAmt-PAYMENT_AMOUNT) = (DEBITAMT-CRDTAMNT) ')   EXEC(  'INSERT INTO ' +  @iGLPMatchTable +  ' (TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT, ACCTAMNT,  AccountNumberDrillback,  JournalEntryDrillback)  SELECT DISTINCT TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT, DEBITAMT-CRDTAMNT,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppAccountIndex(1,ACTINDX),   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppJournalInquiry(1,JRNENTRY,0.0,YEAR1,TRXDATE)   FROM  ' + @iGLTempTable + ' JOIN ' +  @iCMTempTable + '  ON POSTEDDT <> TRXDATE AND TRXSORCE = ORTRXSRC  AND  ORCTRNUM = DOCNUMBR AND  (DepAmt-PAYMENT_AMOUNT) = (DEBITAMT-CRDTAMNT) ')    EXEC( 'DELETE ' +   @iCMTempTable +   ' FROM ' +   @iCMTempTable +   ' CMTemp INNER JOIN ' + @iCMPMatchTable + ' CMMatch ON CMMatch.TRXSORCE = CMTemp.TRXSORCE AND CMMatch.POSTEDDT = CMTemp.POSTEDDT  AND CMMatch.CMTrxNum = CMTemp.CMTrxNum AND CMMatch.DOCNUMBR = CMTemp.DOCNUMBR AND (CMMatch.DepAmt-CMMatch.PAYMENT_AMOUNT) = (CMTemp.DepAmt-CMTemp.PAYMENT_AMOUNT)')    EXEC( 'DELETE ' + @iGLTempTable + ' FROM ' + @iGLTempTable + ' GLTemp INNER JOIN ' + @iGLPMatchTable + ' GLMatch ON GLMatch.ORTRXSRC = GLTemp.ORTRXSRC AND GLMatch.TRXDATE = GLTemp.TRXDATE  AND GLMatch.ORCTRNUM = GLTemp.ORCTRNUM  AND (GLTemp.DEBITAMT-GLTemp.CRDTAMNT)=(GLMatch.DEBITAMT-GLMatch.CRDTAMNT)')    EXEC(  'INSERT INTO ' +  @iCMPMatchTable +  ' (POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,   TrxNumDrillBack)  SELECT  POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, '''', VOIDED,   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppCMTransactionZoom(0,CMRECNUM)   FROM  ' +  @iCMTempTable + ' JOIN ' + @iGLTempTable + ' ON POSTEDDT = TRXDATE AND TRXSORCE = ORTRXSRC AND DOCNUMBR = ORCTRNUM')   EXEC(  'INSERT INTO ' +  @iGLPMatchTable +  ' (TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT, ACCTAMNT,  AccountNumberDrillback,   JournalEntryDrillback)  SELECT DISTINCT TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT, DEBITAMT-CRDTAMNT,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppAccountIndex(1,ACTINDX),  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppJournalInquiry(1,JRNENTRY,0.0,YEAR1,TRXDATE)   FROM  ' + @iGLTempTable + ' JOIN ' +  @iCMTempTable + '  ON POSTEDDT = TRXDATE  AND  TRXSORCE = ORTRXSRC  AND  ORCTRNUM = DOCNUMBR')    EXEC( 'DELETE ' +   @iCMTempTable +   ' FROM ' +   @iCMTempTable +   ' CMTemp INNER JOIN ' + @iCMPMatchTable + ' CMPMatch ON CMPMatch.TRXSORCE = CMTemp.TRXSORCE AND CMPMatch.POSTEDDT = CMTemp.POSTEDDT  AND CMPMatch.CMTrxNum = CMTemp.CMTrxNum AND CMPMatch.DOCNUMBR = CMTemp.DOCNUMBR AND (CMPMatch.DepAmt-CMPMatch.PAYMENT_AMOUNT) = (CMTemp.DepAmt-CMTemp.PAYMENT_AMOUNT)')    EXEC( 'DELETE ' + @iGLTempTable + ' FROM ' + @iGLTempTable + ' GLTemp INNER JOIN ' + @iGLPMatchTable + ' GLPMatch ON GLPMatch.ORTRXSRC = GLTemp.ORTRXSRC AND GLPMatch.TRXDATE = GLTemp.TRXDATE  AND GLPMatch.ORCTRNUM = GLTemp.ORCTRNUM  AND (GLTemp.DEBITAMT-GLTemp.CRDTAMNT)=(GLPMatch.DEBITAMT-GLPMatch.CRDTAMNT)')    EXEC(  'SELECT  POSTEDDT, CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, '''' as STRVAL, VOIDED,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppCMTransactionZoom(0,CMRECNUM)   AS TrxNumDrillBack  INTO  ##CMDetailTemp   FROM ' +  @iCMTempTable + ' JOIN ' + @iGLTempTable + '  ON  POSTEDDT = TRXDATE  AND  TRXSORCE = ORTRXSRC   GROUP BY  POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,CMRECNUM ')    EXEC(  'SELECT  TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT  INTO  ##GLDetailTemp  FROM ' +  @iGLTempTable + '   JOIN ' + @iCMTempTable + '  ON  TRXDATE = POSTEDDT  AND  ORTRXSRC = TRXSORCE   GROUP BY  TRXDATE, JRNENTRY, ORTRXSRC, ORCTRNUM, ACTINDX, DEBITAMT, CRDTAMNT ')    SELECT DISTINCT * INTO #Temp3 FROM ##CMDetailTemp  TRUNCATE TABLE ##CMDetailTemp  INSERT INTO ##CMDetailTemp SELECT * FROM #Temp3  DROP TABLE #Temp3   SELECT  POSTEDDT, TRXSORCE, (SUM(DepAmt) - SUM(PAYMENT_AMOUNT)) AS ACCTAMNT INTO  #CMSumTemp3 FROM  ##CMDetailTemp GROUP BY  POSTEDDT, TRXSORCE   SELECT  TRXDATE, ORTRXSRC, (SUM(DEBITAMT) - SUM(CRDTAMNT)) AS GLAMNT INTO  #GLSumTemp3 FROM  ##GLDetailTemp GROUP BY  TRXDATE, ORTRXSRC    SELECT  POSTEDDT, TRXSORCE INTO  #TRXRemoveTemp3 FROM  #CMSumTemp3 JOIN #GLSumTemp3  ON  TRXDATE = POSTEDDT AND TRXSORCE = ORTRXSRC  AND  ACCTAMNT <> GLAMNT    DELETE  #CMSumTemp3 FROM  #CMSumTemp3 JOIN #GLSumTemp3  ON  TRXDATE = POSTEDDT AND TRXSORCE = ORTRXSRC  AND  ACCTAMNT <> GLAMNT    DELETE  #GLSumTemp3 FROM  #GLSumTemp3 JOIN #TRXRemoveTemp3  ON  TRXDATE = POSTEDDT AND ORTRXSRC = TRXSORCE   EXEC(  'INSERT INTO ' +  @iCMPMatchTable +  ' (POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,   TrxNumDrillBack)  SELECT  ##CMDetailTemp.POSTEDDT,  ##CMDetailTemp.CMTrxNum,  ##CMDetailTemp.TRXSORCE,  DOCNUMBR,  DOCTYPE, ##CMDetailTemp.PAYMENT_AMOUNT,   ##CMDetailTemp.DepAmt, '''', VOIDED, ##CMDetailTemp.TrxNumDrillBack  FROM  ##CMDetailTemp JOIN #CMSumTemp3   ON  ##CMDetailTemp.POSTEDDT = #CMSumTemp3.POSTEDDT AND ##CMDetailTemp.TRXSORCE  = #CMSumTemp3.TRXSORCE ')    EXEC(  'INSERT INTO ' +  @iGLPMatchTable +  ' (TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT, ACCTAMNT, AccountNumberDrillback,   JournalEntryDrillback)  SELECT DISTINCT ##GLDetailTemp.TRXDATE,  ##GLDetailTemp.JRNENTRY,  ##GLDetailTemp.ORTRXSRC,  ##GLDetailTemp.ORCTRNUM,  ##GLDetailTemp.ACTINDX,  ##GLDetailTemp.DEBITAMT,  ##GLDetailTemp.CRDTAMNT,  ##GLDetailTemp.DEBITAMT-##GLDetailTemp.CRDTAMNT,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppAccountIndex(1,##GLDetailTemp.ACTINDX),   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppJournalInquiry(1,##GLDetailTemp.JRNENTRY,0.0,GLTemp.YEAR1,##GLDetailTemp.TRXDATE)   FROM  ##GLDetailTemp JOIN #GLSumTemp3  ON  ##GLDetailTemp.ORTRXSRC = #GLSumTemp3.ORTRXSRC AND ##GLDetailTemp.TRXDATE = #GLSumTemp3.TRXDATE   JOIN ' + @iGLTempTable + ' GLTemp ON ##GLDetailTemp.ORTRXSRC = GLTemp.ORTRXSRC AND ##GLDetailTemp.JRNENTRY = GLTemp.JRNENTRY  AND ##GLDetailTemp.TRXDATE = GLTemp.TRXDATE')   EXEC( 'DELETE ' +   @iCMTempTable +   ' FROM ' +   @iCMTempTable +   ' CMTemp INNER JOIN ' + @iCMPMatchTable + ' CMPMatch ON CMPMatch.TRXSORCE = CMTemp.TRXSORCE AND CMPMatch.POSTEDDT = CMTemp.POSTEDDT  AND CMPMatch.CMTrxNum = CMTemp.CMTrxNum AND CMPMatch.DOCNUMBR = CMTemp.DOCNUMBR AND (CMPMatch.DepAmt-CMPMatch.PAYMENT_AMOUNT) = (CMTemp.DepAmt-CMTemp.PAYMENT_AMOUNT)')    EXEC( 'DELETE ' + @iGLTempTable + ' FROM ' + @iGLTempTable + ' GLTemp INNER JOIN ' + @iGLPMatchTable + ' GLPMatch ON GLPMatch.ORTRXSRC = GLTemp.ORTRXSRC AND GLPMatch.TRXDATE = GLTemp.TRXDATE  AND GLPMatch.ORCTRNUM = GLTemp.ORCTRNUM  AND (GLTemp.DEBITAMT-GLTemp.CRDTAMNT)=(GLPMatch.DEBITAMT-GLPMatch.CRDTAMNT)')    DROP TABLE ##CMDetailTemp,  ##GLDetailTemp   EXEC(  'SELECT  POSTEDDT, CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, '''' AS STRVAL, VOIDED,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppCMTransactionZoom(0,CMRECNUM)   AS TrxNumDrillBack  INTO  ##CMDetailTemp   FROM ' +  @iCMTempTable + ' JOIN ' + @iGLTempTable + '  ON TRXSORCE = ORTRXSRC AND  (ORCTRNUM = '''' OR DOCNUMBR = '''' OR ORCTRNUM = DOCNUMBR)  GROUP BY  POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,CMRECNUM ')    EXEC(  'SELECT  TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT  INTO  ##GLDetailTemp  FROM ' +  @iGLTempTable + '   JOIN ' + @iCMTempTable + '  ON  ORTRXSRC = TRXSORCE  AND  (DOCNUMBR = '''' OR ORCTRNUM = '''' OR ORCTRNUM = DOCNUMBR)   GROUP BY  TRXDATE, JRNENTRY, ORTRXSRC, ORCTRNUM, ACTINDX, DEBITAMT, CRDTAMNT ')    SELECT DISTINCT * INTO #Temp4 FROM ##CMDetailTemp  TRUNCATE TABLE ##CMDetailTemp  INSERT INTO ##CMDetailTemp SELECT * FROM #Temp4  DROP TABLE #Temp4   SELECT TRXSORCE, (SUM(DepAmt) - SUM(PAYMENT_AMOUNT)) AS ACCTAMNT INTO  #CMSumTemp4 FROM  ##CMDetailTemp GROUP BY   TRXSORCE    SELECT ORTRXSRC, (SUM(DEBITAMT) - SUM(CRDTAMNT)) AS GLAMNT INTO  #GLSumTemp4 FROM  ##GLDetailTemp GROUP BY   ORTRXSRC    SELECT TRXSORCE INTO  #TRXRemoveTemp4 FROM  #CMSumTemp4 JOIN #GLSumTemp4  ON  TRXSORCE = ORTRXSRC  AND  ACCTAMNT <> GLAMNT    DELETE  #CMSumTemp4 FROM  #CMSumTemp4 JOIN #GLSumTemp4  ON  TRXSORCE = ORTRXSRC  AND  ACCTAMNT <> GLAMNT    DELETE  #GLSumTemp4 FROM  #GLSumTemp4 JOIN #TRXRemoveTemp4  ON  ORTRXSRC = TRXSORCE    EXEC(  'INSERT INTO ' +  @iCMPMatchTable +  ' (POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,   TrxNumDrillBack)  SELECT  ##CMDetailTemp.POSTEDDT,  ##CMDetailTemp.CMTrxNum,  ##CMDetailTemp.TRXSORCE,  DOCNUMBR,  DOCTYPE, ##CMDetailTemp.PAYMENT_AMOUNT,   ##CMDetailTemp.DepAmt, '''', VOIDED,  ##CMDetailTemp.TrxNumDrillBack   FROM  ##CMDetailTemp JOIN #CMSumTemp4   ON  ##CMDetailTemp.TRXSORCE  = #CMSumTemp4.TRXSORCE')    EXEC(  'INSERT INTO ' +  @iGLPMatchTable +  ' (TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT, ACCTAMNT, AccountNumberDrillback,   JournalEntryDrillback)  SELECT DISTINCT ##GLDetailTemp.TRXDATE,  ##GLDetailTemp.JRNENTRY,  ##GLDetailTemp.ORTRXSRC,  ##GLDetailTemp.ORCTRNUM,  ##GLDetailTemp.ACTINDX,  ##GLDetailTemp.DEBITAMT,  ##GLDetailTemp.CRDTAMNT, ##GLDetailTemp.DEBITAMT-##GLDetailTemp.CRDTAMNT,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppAccountIndex(1,##GLDetailTemp.ACTINDX),  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppJournalInquiry(1,##GLDetailTemp.JRNENTRY,0.0,' + @iGLTempTable + '.YEAR1,##GLDetailTemp.TRXDATE)  FROM  ##GLDetailTemp JOIN #GLSumTemp4  ON  ##GLDetailTemp.ORTRXSRC = #GLSumTemp4.ORTRXSRC   JOIN ' + @iGLTempTable + ' ON ##GLDetailTemp.ORTRXSRC = ' + @iGLTempTable + '.ORTRXSRC AND ##GLDetailTemp.JRNENTRY = ' + @iGLTempTable + '.JRNENTRY  AND ##GLDetailTemp.TRXDATE = ' + @iGLTempTable + '.TRXDATE')   EXEC( 'DELETE ' +   @iCMTempTable +   ' FROM ' +   @iCMTempTable +   ' CMTemp INNER JOIN ' + @iCMPMatchTable + ' CMPMatch ON CMPMatch.TRXSORCE = CMTemp.TRXSORCE AND CMPMatch.POSTEDDT = CMTemp.POSTEDDT  AND CMPMatch.CMTrxNum = CMTemp.CMTrxNum AND CMPMatch.DOCNUMBR = CMTemp.DOCNUMBR AND (CMPMatch.DepAmt-CMPMatch.PAYMENT_AMOUNT) = (CMTemp.DepAmt-CMTemp.PAYMENT_AMOUNT)')    EXEC( 'DELETE ' + @iGLTempTable + ' FROM ' + @iGLTempTable + ' GLTemp INNER JOIN ' + @iGLPMatchTable + ' GLPMatch ON GLPMatch.ORTRXSRC = GLTemp.ORTRXSRC AND GLPMatch.TRXDATE = GLTemp.TRXDATE  AND GLPMatch.ORCTRNUM = GLTemp.ORCTRNUM  AND (GLTemp.DEBITAMT-GLTemp.CRDTAMNT)=(GLPMatch.DEBITAMT-GLPMatch.CRDTAMNT)')    DROP TABLE  ##CMDetailTemp,  ##GLDetailTemp   SET @Statement = ' (  SELECT DISTINCT TOP 1 APTVCHNM FROM (SELECT DISTINCT APTVCHNM FROM PM10200 INNER JOIN PM00400 ON CNTRLNUM = APTVCHNM AND PM10200.VENDORID = PM00400.VENDORID AND DCSTATUS = 2 AND  PM10200.VCHRNMBR = ' +  @iCMTempTable + '.DOCNUMBR AND PM10200.DOCTYPE = 6  UNION  SELECT DISTINCT APTVCHNM FROM PM30300 INNER JOIN PM00400 ON CNTRLNUM = APTVCHNM AND PM30300.VENDORID = PM00400.VENDORID AND DCSTATUS = 3 AND  PM30300.VCHRNMBR = ' +  @iCMTempTable + '.DOCNUMBR AND PM30300.DOCTYPE = 6 ) A) '   EXEC(  'INSERT INTO ' +  @iCMPMatchTable +  ' (POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,   TrxNumDrillBack)  SELECT  POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, '''', VOIDED,   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppCMTransactionZoom(0,CMRECNUM) AS   TrxNumDrillBack   FROM  ' +  @iCMTempTable + ' JOIN ' + @iGLTempTable + ' ON POSTEDDT <> TRXDATE AND TRXSORCE = ORTRXSRC AND TRXSORCE LIKE ''PMTRX%'' AND   (DepAmt-PAYMENT_AMOUNT) = (DEBITAMT-CRDTAMNT) AND ORCTRNUM = ' + @Statement + ' ')   EXEC(  'INSERT INTO ' +  @iGLPMatchTable +  ' (TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT, ACCTAMNT,  AccountNumberDrillback,  JournalEntryDrillback)  SELECT DISTINCT TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT, DEBITAMT-CRDTAMNT,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppAccountIndex(1,ACTINDX),   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppJournalInquiry(1,JRNENTRY,0.0,YEAR1,TRXDATE)  FROM  ' + @iGLTempTable + ' JOIN ' +  @iCMTempTable + '  ON POSTEDDT <> TRXDATE AND TRXSORCE = ORTRXSRC AND TRXSORCE LIKE ''PMTRX%'' AND  (DepAmt-PAYMENT_AMOUNT) = (DEBITAMT-CRDTAMNT) AND  ORCTRNUM = ' + @Statement + ' ')    EXEC( 'DELETE ' +   @iCMTempTable +   ' FROM ' +   @iCMTempTable +   ' CMTemp INNER JOIN ' + @iCMPMatchTable + ' CMMatch ON CMMatch.TRXSORCE = CMTemp.TRXSORCE AND CMMatch.POSTEDDT = CMTemp.POSTEDDT  AND CMMatch.CMTrxNum = CMTemp.CMTrxNum AND CMMatch.DOCNUMBR = CMTemp.DOCNUMBR AND (CMMatch.DepAmt-CMMatch.PAYMENT_AMOUNT) = (CMTemp.DepAmt-CMTemp.PAYMENT_AMOUNT)')    EXEC( 'DELETE ' + @iGLTempTable + ' FROM ' + @iGLTempTable + ' GLTemp INNER JOIN ' + @iGLPMatchTable + ' GLMatch ON GLMatch.ORTRXSRC = GLTemp.ORTRXSRC AND GLMatch.TRXDATE = GLTemp.TRXDATE  AND GLMatch.ORCTRNUM = GLTemp.ORCTRNUM  AND (GLTemp.DEBITAMT-GLTemp.CRDTAMNT)=(GLMatch.DEBITAMT-GLMatch.CRDTAMNT)')    EXEC(  'INSERT INTO ' +  @iCMPMatchTable +  ' (POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,   TrxNumDrillBack)  SELECT DISTINCT POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, '''', VOIDED,   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppCMTransactionZoom(0,CMRECNUM)   FROM  ' +  @iCMTempTable + ' JOIN ' + @iGLTempTable + ' ON POSTEDDT = TRXDATE AND TRXSORCE = ORTRXSRC  AND TRXSORCE LIKE ''PMTRX%'' AND ORCTRNUM = ' + @Statement + '')   EXEC(  'INSERT INTO ' +  @iGLPMatchTable +  ' (TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT, ACCTAMNT,  AccountNumberDrillback,   JournalEntryDrillback)  SELECT DISTINCT TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT, DEBITAMT-CRDTAMNT,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppAccountIndex(1,ACTINDX),  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppJournalInquiry(1,JRNENTRY,0.0,YEAR1,TRXDATE)   FROM  ' + @iGLTempTable + ' JOIN ' +  @iCMTempTable + '  ON POSTEDDT = TRXDATE AND TRXSORCE = ORTRXSRC AND TRXSORCE LIKE ''PMTRX%'' AND ORCTRNUM = ' + @Statement + '')    EXEC( 'DELETE ' +   @iCMTempTable +   ' FROM ' +   @iCMTempTable +   ' CMTemp INNER JOIN ' + @iCMPMatchTable + ' CMPMatch ON CMPMatch.TRXSORCE = CMTemp.TRXSORCE AND CMPMatch.POSTEDDT = CMTemp.POSTEDDT  AND CMPMatch.CMTrxNum = CMTemp.CMTrxNum AND CMPMatch.DOCNUMBR = CMTemp.DOCNUMBR AND (CMPMatch.DepAmt-CMPMatch.PAYMENT_AMOUNT) = (CMTemp.DepAmt-CMTemp.PAYMENT_AMOUNT)')    EXEC( 'DELETE ' + @iGLTempTable + ' FROM ' + @iGLTempTable + ' GLTemp INNER JOIN ' + @iGLPMatchTable + ' GLPMatch ON GLPMatch.ORTRXSRC = GLTemp.ORTRXSRC AND GLPMatch.TRXDATE = GLTemp.TRXDATE  AND GLPMatch.ORCTRNUM = GLTemp.ORCTRNUM  AND (GLTemp.DEBITAMT-GLTemp.CRDTAMNT)=(GLPMatch.DEBITAMT-GLPMatch.CRDTAMNT)')    EXEC(  'SELECT  POSTEDDT, CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, '''' AS STRVAL, VOIDED,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppCMTransactionZoom(0,CMRECNUM)   AS TrxNumDrillBack, ' + @Statement + ' AS APTVCHNUM  INTO  ##CMDetailTemp   FROM ' +  @iCMTempTable + ' JOIN ' + @iGLTempTable + '  ON TRXSORCE = ORTRXSRC AND TRXSORCE LIKE ''PMTRX%'' AND ORCTRNUM = ' + @Statement + '  GROUP BY  POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,CMRECNUM ')    EXEC(  'SELECT  TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT  INTO  ##GLDetailTemp  FROM ' +  @iGLTempTable + '   JOIN ' + @iCMTempTable + '  ON  ORTRXSRC = TRXSORCE  AND TRXSORCE LIKE ''PMTRX%'' AND ORCTRNUM = ' + @Statement + '  GROUP BY  TRXDATE, JRNENTRY, ORTRXSRC, ORCTRNUM, ACTINDX, DEBITAMT, CRDTAMNT ')    SELECT DISTINCT * INTO #Temp6 FROM ##CMDetailTemp  TRUNCATE TABLE ##CMDetailTemp  INSERT INTO ##CMDetailTemp SELECT * FROM #Temp6  DROP TABLE #Temp6   SELECT TRXSORCE, APTVCHNUM, (SUM(DepAmt) - SUM(PAYMENT_AMOUNT)) AS ACCTAMNT INTO  #CMSumTemp6 FROM  ##CMDetailTemp GROUP BY TRXSORCE , APTVCHNUM   SELECT ORTRXSRC, ORCTRNUM, (SUM(DEBITAMT) - SUM(CRDTAMNT)) AS GLAMNT INTO  #GLSumTemp6 FROM  ##GLDetailTemp GROUP BY ORTRXSRC , ORCTRNUM   SELECT TRXSORCE, APTVCHNUM INTO  #TRXRemoveTemp6 FROM  #CMSumTemp6 JOIN #GLSumTemp6  ON  TRXSORCE = ORTRXSRC AND ORCTRNUM = APTVCHNUM AND  ACCTAMNT <> GLAMNT    DELETE #CMSumTemp6 FROM  #CMSumTemp6 JOIN #GLSumTemp6  ON  TRXSORCE = ORTRXSRC AND ORCTRNUM =APTVCHNUM AND ACCTAMNT <> GLAMNT    DELETE #GLSumTemp6 FROM  #GLSumTemp6 JOIN #TRXRemoveTemp6  ON  ORTRXSRC = TRXSORCE AND ORCTRNUM =APTVCHNUM   EXEC( 'INSERT INTO ' +  @iCMPMatchTable +  ' (POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,   TrxNumDrillBack) SELECT CM.POSTEDDT, CM.CMTrxNum, CM.TRXSORCE, DOCNUMBR, DOCTYPE, CM.PAYMENT_AMOUNT, CM.DepAmt, '''',   VOIDED, CM.TrxNumDrillBack FROM  ##CMDetailTemp CM JOIN #CMSumTemp6 ON  CM.TRXSORCE  = #CMSumTemp6.TRXSORCE AND CM.APTVCHNUM = #CMSumTemp6.APTVCHNUM')    EXEC( 'INSERT INTO ' +  @iGLPMatchTable +  ' (TRXDATE,  JRNENTRY,  ORTRXSRC,  ORCTRNUM,  ACTINDX,  DEBITAMT,  CRDTAMNT, ACCTAMNT, AccountNumberDrillback,   JournalEntryDrillback) SELECT DISTINCT GL.TRXDATE,  GL.JRNENTRY,  GL.ORTRXSRC,  GL.ORCTRNUM,  GL.ACTINDX,  GL.DEBITAMT,  GL.CRDTAMNT, GL.DEBITAMT-GL.CRDTAMNT,  DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0) + dbo.dgppAccountIndex(1,GL.ACTINDX),   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0) + dbo.dgppJournalInquiry(1,GL.JRNENTRY,0.0,' + @iGLTempTable + '.YEAR1,GL.TRXDATE)  FROM  ##GLDetailTemp GL JOIN #GLSumTemp6  ON  GL.ORTRXSRC = #GLSumTemp6.ORTRXSRC AND GL.ORCTRNUM = #GLSumTemp6.ORCTRNUM  JOIN ' + @iGLTempTable + ' ON GL.ORTRXSRC = ' + @iGLTempTable + '.ORTRXSRC AND GL.JRNENTRY = ' + @iGLTempTable + '.JRNENTRY  AND GL.TRXDATE = ' + @iGLTempTable + '.TRXDATE')   EXEC( 'DELETE ' +   @iCMTempTable +   ' FROM ' +   @iCMTempTable +   ' CMTemp INNER JOIN ' + @iCMPMatchTable + ' CMPMatch ON CMPMatch.TRXSORCE = CMTemp.TRXSORCE AND CMPMatch.POSTEDDT = CMTemp.POSTEDDT  AND CMPMatch.CMTrxNum = CMTemp.CMTrxNum AND CMPMatch.DOCNUMBR = CMTemp.DOCNUMBR AND (CMPMatch.DepAmt-CMPMatch.PAYMENT_AMOUNT) = (CMTemp.DepAmt-CMTemp.PAYMENT_AMOUNT)')    EXEC( 'DELETE ' + @iGLTempTable + ' FROM ' + @iGLTempTable + ' GLTemp INNER JOIN ' + @iGLPMatchTable + ' GLPMatch ON GLPMatch.ORTRXSRC = GLTemp.ORTRXSRC AND GLPMatch.TRXDATE = GLTemp.TRXDATE  AND GLPMatch.ORCTRNUM = GLTemp.ORCTRNUM  AND (GLTemp.DEBITAMT-GLTemp.CRDTAMNT)=(GLPMatch.DEBITAMT-GLPMatch.CRDTAMNT)')    DROP TABLE  ##CMDetailTemp,  ##GLDetailTemp   EXEC(  'INSERT INTO ' +  @iCMPMatchTable +  ' (POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,   TrxNumDrillBack)   SELECT DISTINCT A.POSTEDDT,  A.CMTrxNum, A.TRXSORCE, A.DOCNUMBR, A.DOCTYPE, A.PAYMENT_AMOUNT, A.DepAmt, '''', A.VOIDED,   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppCMTransactionZoom(0,A.CMRECNUM)  AS TrxNumDrillBack FROM ' +  @iCMTempTable + ' AS A WHERE A.DOCTYPE = 1 AND  A.CMTrxNum IN (SELECT DISTINCT CMTrxNum FROM ' +  @iCMPMatchTable +  ' WHERE  ' +  @iCMPMatchTable +  '.DOCTYPE IN (2,0))  GROUP BY  A.POSTEDDT,  A.CMTrxNum, A.TRXSORCE, A.DOCNUMBR, A.DOCTYPE, A.PAYMENT_AMOUNT, A.DepAmt, A.STRVAL, A.VOIDED,A.CMRECNUM ')    EXEC( 'DELETE ' +   @iCMTempTable +   ' FROM ' +   @iCMTempTable +   ' CMTemp INNER JOIN ' + @iCMPMatchTable + ' CMPMatch ON CMPMatch.TRXSORCE = CMTemp.TRXSORCE AND CMPMatch.POSTEDDT = CMTemp.POSTEDDT  AND CMPMatch.CMTrxNum = CMTemp.CMTrxNum AND CMPMatch.DOCNUMBR = CMTemp.DOCNUMBR AND (CMPMatch.DepAmt-CMPMatch.PAYMENT_AMOUNT) = (CMTemp.DepAmt-CMTemp.PAYMENT_AMOUNT)')    EXEC(  'INSERT INTO ' +  @iCMPMatchTable +  ' (POSTEDDT,  CMTrxNum, TRXSORCE, DOCNUMBR, DOCTYPE, PAYMENT_AMOUNT, DepAmt, STRVAL, VOIDED,   TrxNumDrillBack)   SELECT DISTINCT A.POSTEDDT,  A.CMTrxNum, A.TRXSORCE, A.DOCNUMBR, A.DOCTYPE, A.PAYMENT_AMOUNT, A.DepAmt, '''', A.VOIDED,   DYNAMICS.dbo.createBaseDrillBackUrlString(DB_NAME(),0)   + dbo.dgppCMTransactionZoom(0,A.CMRECNUM)  AS TrxNumDrillBack FROM ' +  @iCMTempTable + ' AS A WHERE A.DOCTYPE IN (2,0) AND  A.CMTrxNum IN (SELECT DISTINCT CMTrxNum FROM ' +  @iCMPMatchTable +  ' WHERE  ' +  @iCMPMatchTable +  '.DOCTYPE IN (2,0))  GROUP BY  A.POSTEDDT,  A.CMTrxNum, A.TRXSORCE, A.DOCNUMBR, A.DOCTYPE, A.PAYMENT_AMOUNT, A.DepAmt, A.STRVAL, A.VOIDED,A.CMRECNUM ')    EXEC( 'DELETE ' +   @iCMTempTable +   ' FROM ' +   @iCMTempTable +   ' CMTemp INNER JOIN ' + @iCMPMatchTable + ' CMPMatch ON CMPMatch.TRXSORCE = CMTemp.TRXSORCE AND CMPMatch.POSTEDDT = CMTemp.POSTEDDT  AND CMPMatch.CMTrxNum = CMTemp.CMTrxNum AND CMPMatch.DOCNUMBR = CMTemp.DOCNUMBR AND (CMPMatch.DepAmt-CMPMatch.PAYMENT_AMOUNT) = (CMTemp.DepAmt-CMTemp.PAYMENT_AMOUNT)')    RETURN (@lSQLError)  END    
GO
GRANT EXECUTE ON  [dbo].[glPMatchCMTransactions] TO [DYNGRP]
GO
