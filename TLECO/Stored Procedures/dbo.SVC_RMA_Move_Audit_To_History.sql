SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_RMA_Move_Audit_To_History]  (@ReturnDocId char(16),  @LineSequence numeric(19,5),  @MaxNoLines numeric(19,5)) AS DECLARE @SVCFRMSTAT varchar(3), @SVCTOSTAT varchar(3), @DSCRPTION varchar(100), @AUDITUSERID varchar(15) DECLARE @CREATDDT datetime, @CREATETIME datetime DECLARE @AuditItemSeq numeric(19,5)  BEGIN  IF @MaxNoLines > 0  DECLARE AuditLines CURSOR  for  SELECT LNITMSEQ, SVCFRMSTAT, SVCTOSTAT, DSCRPTION, USERID, CREATDDT, CREATETIME  FROM SVC05020  WHERE RETDOCID = @ReturnDocId and LNSEQNBR = @LineSequence AND LNITMSEQ < @MaxNoLines  ELSE  DECLARE AuditLines CURSOR  for  SELECT LNITMSEQ, SVCFRMSTAT, SVCTOSTAT, DSCRPTION, USERID, CREATDDT, CREATETIME  FROM SVC05020  WHERE RETDOCID = @ReturnDocId and LNSEQNBR = @LineSequence   OPEN AuditLines  FETCH NEXT FROM AuditLines INTO @AuditItemSeq, @SVCFRMSTAT, @SVCTOSTAT, @DSCRPTION, @AUDITUSERID, @CREATDDT, @CREATETIME  WHILE @@FETCH_STATUS = 0  BEGIN  IF @MaxNoLines = 0 OR @LineSequence <> 0   SET @AuditItemSeq = (SELECT ISNULL(MAX(LNITMSEQ),0) + 1 FROM SVC35020 WHERE RETDOCID = @ReturnDocId)  ELSE IF EXISTS(SELECT * FROM SVC35020 WHERE RETDOCID = @ReturnDocId)   SET @AuditItemSeq = (SELECT ISNULL(MAX(LNITMSEQ),0) + 1 FROM SVC35020 WHERE RETDOCID = @ReturnDocId)   INSERT INTO SVC35020 values (@ReturnDocId, @LineSequence, @AuditItemSeq, @SVCFRMSTAT, @SVCTOSTAT,   @DSCRPTION, @AUDITUSERID, @CREATDDT, @CREATETIME)  IF @@ERROR <> 0  begin  return 9  end   FETCH NEXT FROM AuditLines INTO @AuditItemSeq, @SVCFRMSTAT, @SVCTOSTAT, @DSCRPTION, @AUDITUSERID, @CREATDDT, @CREATETIME  END  CLOSE AuditLines  DEALLOCATE AuditLines   IF @MaxNoLines > 0   DELETE FROM SVC05020 WHERE RETDOCID = @ReturnDocId AND LNSEQNBR = @LineSequence AND LNITMSEQ < @MaxNoLines  ELSE  DELETE FROM SVC05020 WHERE RETDOCID = @ReturnDocId AND LNSEQNBR = @LineSequence  END    
GO
GRANT EXECUTE ON  [dbo].[SVC_RMA_Move_Audit_To_History] TO [DYNGRP]
GO
