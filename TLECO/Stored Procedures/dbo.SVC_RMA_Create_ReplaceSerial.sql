SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE Procedure [dbo].[SVC_RMA_Create_ReplaceSerial] ( @RecType smallint,  @RMANumber char(15),  @Line Numeric(19,5),  @serial_number char(20),  @item_number char(30),  @location_code char(11), @Bin char(15), @item_cost numeric(19,5), @AddDelete tinyint,  @QTY numeric(19,5) = null, @ExpDate datetime = null, @MfgDate datetime = null, @RecDate datetime = null, @DateSEQ Numeric(19,5) = null, @CMPNTSEQ int = 0 )  as declare @LotSequence int declare @MinDate datetime  exec smGetMinDate @MinDate output  set @ExpDate = isnull(@ExpDate,@MinDate) set @MfgDate = isnull(@MfgDate,@MinDate) set @RecDate = isnull(@RecDate,@MinDate) set @DateSEQ = isnull(@DateSEQ,0) set @QTY = isnull(@QTY,1) begin transaction if @AddDelete = 1  begin  if not exists(select * from SVC05256 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line  and Replace_Serial_Number = @serial_number and Replace_Item_Number = @item_number and CMPNTSEQ = @CMPNTSEQ  and (BIN = @Bin or @Bin = '' or @Bin is null))  begin  if @Bin = '' or @Bin is null  select @Bin = SOFULFILLMENTBIN from IV00102 where ITEMNMBR = @item_number and LOCNCODE = @location_code  if @Bin = '' or @Bin is null  select @Bin = SOFULFILLMENTBIN from IV40700 where LOCNCODE = @location_code  select @LotSequence = isnull(Max(SLTSQNUM),0) + 1 from SVC05256  where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line and CMPNTSEQ = @CMPNTSEQ  insert SVC05256 select  @RecType, @RMANumber, @Line, 1, @QTY , @LotSequence, @item_number, @serial_number, 0 ,  isnull(@Bin,''), @item_cost, @MfgDate, @ExpDate, @RecDate, @DateSEQ, @CMPNTSEQ  if @@error <> 0 goto badentry  end  else  begin  update SVC05256 set SERLTQTY=SERLTQTY+@QTY where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line  and Replace_Serial_Number = @serial_number and Replace_Item_Number = @item_number and CMPNTSEQ = @CMPNTSEQ  end  end else  delete from  SVC05256 where RETDOCID = @RMANumber and Return_Record_Type = @RecType and LNSEQNBR = @Line  and Replace_Serial_Number = @serial_number and Replace_Item_Number = @item_number and CMPNTSEQ = @CMPNTSEQ  commit transaction  return badentry:  rollback transaction  return    
GO
GRANT EXECUTE ON  [dbo].[SVC_RMA_Create_ReplaceSerial] TO [DYNGRP]
GO
