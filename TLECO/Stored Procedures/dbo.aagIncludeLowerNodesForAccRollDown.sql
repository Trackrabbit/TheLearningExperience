SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aagIncludeLowerNodesForAccRollDown] (  @USERID CHAR(15) ,  @WINTYPE INTEGER  ,  @CMPANYID INTEGER  ,  @aaParCodeSequence INTEGER  ,  @Type INTEGER  ,   @Parts NUMERIC(19, 5) ,  @IncOB INTEGER  ,  @Result INTEGER OUTPUT  ) AS BEGIN  DECLARE @TempID INTEGER  DECLARE @aaBudgetTreeID INTEGER  DECLARE @aaBudgetID INTEGER  DECLARE @nCount INTEGER  DECLARE @nsCount INTEGER  DECLARE @TEMPACTINDX INTEGER  DECLARE @ACTINDX INTEGER  DECLARE @Percentage NUMERIC(19, 5)  DECLARE @aaActualPriliminary INTEGER  DECLARE @aaAcctType INTEGER   DECLARE @aaAmtQty INTEGER  DECLARE @table_aaCodeSequence TABLE (aaCodeSequence INTEGER )  DECLARE @temp_ACTINDX TABLE (ACTINDX INTEGER, Percentage NUMERIC(19, 5))  SELECT @aaAmtQty = aaAmtQty, @aaActualPriliminary = aaActualPriliminary, @TEMPACTINDX = ACTINDX FROM AAG00906 WHERE USERID = @USERID AND   WINTYPE = @WINTYPE AND CMPANYID = @CMPANYID  SELECT @aaBudgetID = aaBudgetID FROM AAG00906 WHERE USERID = @USERID   AND WINTYPE = @WINTYPE AND CMPANYID = @CMPANYID  SELECT TOP 1 @aaBudgetTreeID = aaBudgetTreeID FROM AAG00903 WHERE   aaBudgetID = @aaBudgetID  SELECT @TempID = aaTrxDimCodeID FROM AAG00902 WHERE aaCodeSequence = @aaParCodeSequence   AND aaBudgetTreeID = @aaBudgetTreeID  INSERT INTO @table_aaCodeSequence   SELECT aaCodeSequence FROM dbo.aagGetChildNodes (@aaBudgetTreeID, @aaParCodeSequence)  SELECT @nCount = COUNT(*) FROM @table_aaCodeSequence  IF @nCount <= 0 RETURN   WHILE (1 = 1)   BEGIN  INSERT INTO @temp_ACTINDX SELECT ACTINDX, Percentage FROM #temp_ACTINDX  SELECT @nCount = COUNT(*) FROM @table_aaCodeSequence  IF @nCount <= 0 BREAK  SELECT TOP 1 @TempID = aaCodeSequence FROM @table_aaCodeSequence   UPDATE AAG00906 SET aaCodeSequence = @TempID WHERE USERID = @USERID AND   WINTYPE = @WINTYPE  AND CMPANYID = @CMPANYID   SET @aaAcctType = @aaAmtQty + 1   DELETE FROM AAG00905 WHERE aaBudgetID = @aaBudgetID AND aaCodeSequence = @TempID AND aaActualPriliminary = @aaActualPriliminary  AND ACTINDX IN (SELECT ACTINDX FROM GL00100 WHERE ACCTTYPE = @aaAcctType)  WHILE ( 1 = 1 )  BEGIN  SELECT @nsCount = COUNT (*) FROM @temp_ACTINDX  IF @nsCount <= 0   BREAK  SELECT TOP 1 @ACTINDX = ACTINDX, @Percentage = Percentage from   @temp_ACTINDX  UPDATE AAG00906 SET ACTINDX = @ACTINDX WHERE USERID = @USERID   AND WINTYPE = @WINTYPE  EXEC aagBudgetAccountRollDownOne @USERID, @WINTYPE, @CMPANYID, @Percentage, @ACTINDX, @Type, @Parts, @IncOB, @Result OUTPUT  DELETE FROM @temp_ACTINDX WHERE ACTINDX = @ACTINDX  END  DELETE FROM @table_aaCodeSequence WHERE aaCodeSequence = @TempID  EXEC aagIncludeLowerNodesForAccRollDown @USERID, @WINTYPE, @CMPANYID, @TempID, @Type,@Parts, @IncOB, @Result OUTPUT   END END    
GO
GRANT EXECUTE ON  [dbo].[aagIncludeLowerNodesForAccRollDown] TO [DYNGRP]
GO
