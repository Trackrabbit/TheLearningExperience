SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[ExtPricingGetPromoItems]  @piST_UserID char(15),    @piST_DorP char(1),      @piST_CustomerNumber char(15),   @piST_ItemNumber char(31),   @piDA_Date datetime,     @piST_UofM char(10),    @piST_Currency  char(16)     AS  DECLARE @loDA_StartDate datetime,  @loDA_EndDate datetime,  @loST_SchemeCode char(15),  @loST_SchemeItemType char(1),  @loST_ItemNumber char(31),  @loST_UofM char(9),  @loDE_QtyFrom decimal(19,5),  @loDE_QtyTo decimal(19,5),  @loDE_Value decimal(19,5),  @loDE_EQUOMQTY decimal(19,5),  @loST_BaseUofM char(9),  @loIN_PromLevel integer,  @loIN_PromType integer,  @loDA_NextStartDate datetime,  @loDA_NextEndDate datetime,  @loST_NextSchemeCode char(15),  @loST_NextSchemeItemType char(1),  @loST_NextItemNumber char(31),  @loST_NextUofM char(9),  @loDE_NextQtyFrom decimal(19,5),  @loST_HoldSchemeCode char(15),  @loSM_CompanyID smallint  SELECT @loSM_CompanyID = CMPANYID FROM DYNAMICS..SY01500 WHERE INTERID = (select db_name())  IF @piST_CustomerNumber IS NULL BEGIN  GOTO BaseListProduct END  CustomerProduct:  DECLARE scCustomerProduct SCROLL CURSOR FOR  SELECT SH.STRTDATE,   SH.ENDDATE,  SW.PRCSHID,  SW.EPITMTYP,  SWU.ITEMNMBR,  SWU.UOFM,  SWU.QTYFROM,  SWU.QTYTO,  SWU.PSITMVAL,   SWU.EQUOMQTY,  SW.BASEUOFM,  SW.PROMOLVL,  SW.PROMOTYP  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  WHERE SL.PRODTCOD = @piST_DorP  AND SL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR = @piST_ItemNumber  AND  SWU.UOFM = @piST_UofM  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date   AND SH.PROMO = 1  AND SH.CURNCYID = @piST_Currency  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE,  SW.PRCSHID  OPEN scCustomerProduct  FETCH FIRST FROM scCustomerProduct  INTO @loDA_StartDate,  @loDA_EndDate,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_ItemNumber,  @loST_UofM,  @loDE_QtyFrom,  @loDE_QtyTo,  @loDE_Value,  @loDE_EQUOMQTY,  @loST_BaseUofM,  @loIN_PromLevel,  @loIN_PromType  IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scCustomerProduct  DEALLOCATE scCustomerProduct  GOTO CustomerGroup END ELSE BEGIN  SELECT @loST_HoldSchemeCode = @loST_SchemeCode  FETCH NEXT FROM  scCustomerProduct  INTO  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_NextSchemeCode,  @loST_NextSchemeItemType,  @loST_NextItemNumber,  @loST_NextUofM,  @loDE_NextQtyFrom,  @loDE_QtyTo,  @loDE_Value,  @loDE_EQUOMQTY,  @loST_BaseUofM,  @loIN_PromLevel,  @loIN_PromType   IF @@FETCH_STATUS = 0  BEGIN  IF  (@loDA_StartDate = @loDA_NextStartDate) and   (@loDA_EndDate = @loDA_NextEndDate) and  (@loST_SchemeCode = @loST_NextSchemeCode) and  (@loST_SchemeItemType = @loST_NextSchemeItemType) and  (@loST_ItemNumber = @loST_NextItemNumber) and  (@loST_UofM = @loST_NextUofM) and  (@loDE_QtyFrom = @loDE_NextQtyFrom)  BEGIN  CLOSE scCustomerProduct  DEALLOCATE scCustomerProduct  RETURN 0  END  END END  CLOSE scCustomerProduct DEALLOCATE scCustomerProduct  INSERT INTO SOP50400 (USERID,  ITEMNMBR,  UOFM,  PRCSHID,  EPITMTYP,  STRTDATE,   ENDDATE,  QTYFROM,  QTYTO,  PSITMVAL,   EQUOMQTY,  BASEUOFM,  PROMOLVL,  PROMOTYP,  PRCGRPID,  PRODTCOD,  ACTIVE)  SELECT   @piST_UserID,  SWU.ITEMNMBR,  SWU.UOFM,  SW.PRCSHID,  SW.EPITMTYP,  SH.STRTDATE,  SH.ENDDATE,  SWU.QTYFROM,  SWU.QTYTO,  SWU.PSITMVAL,   SWU.EQUOMQTY,  SW.BASEUOFM,  SW.PROMOLVL,  SW.PROMOTYP,  ' ',  SW.PRODTCOD,  SW.ACTIVE  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  WHERE SL.PRODTCOD = @piST_DorP  AND SL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR = @piST_ItemNumber  AND  SWU.UOFM = @piST_UofM  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date   AND SH.PROMO = 1  AND SW.PRCSHID = @loST_HoldSchemeCode  AND SH.CURNCYID = @piST_Currency  RETURN 0  CustomerGroup:  DECLARE scCustomerGroup SCROLL CURSOR FOR  SELECT SH.STRTDATE,   SH.ENDDATE,  SW.PRCSHID,  SW.EPITMTYP,  SWU.ITEMNMBR,  SWU.UOFM,  SWU.QTYFROM,  SWU.QTYTO,  SWU.PSITMVAL,   SWU.EQUOMQTY,  SW.BASEUOFM,  SW.PROMOLVL,  SW.PROMOTYP  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  WHERE SL.PRODTCOD = @piST_DorP  AND SL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR = @piST_ItemNumber  AND  SWU.UOFM = @piST_UofM  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @piST_Currency  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE,  SW.PRCSHID  OPEN scCustomerGroup FETCH FIRST FROM scCustomerGroup  INTO @loDA_StartDate,  @loDA_EndDate,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_ItemNumber,  @loST_UofM,  @loDE_QtyFrom,  @loDE_QtyTo,  @loDE_Value,  @loDE_EQUOMQTY,  @loST_BaseUofM,  @loIN_PromLevel,  @loIN_PromType  IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scCustomerGroup  DEALLOCATE scCustomerGroup  GOTO PriceListProduct END ELSE BEGIN  SELECT @loST_HoldSchemeCode = @loST_SchemeCode  FETCH NEXT FROM scCustomerGroup  INTO  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_NextSchemeCode,  @loST_NextSchemeItemType,  @loST_NextItemNumber,  @loST_NextUofM,  @loDE_NextQtyFrom,  @loDE_QtyTo,  @loDE_Value,  @loDE_EQUOMQTY,  @loST_BaseUofM,  @loIN_PromLevel,  @loIN_PromType   IF @@FETCH_STATUS = 0  BEGIN  IF  (@loDA_StartDate = @loDA_NextStartDate) and   (@loDA_EndDate = @loDA_NextEndDate) and  (@loST_SchemeCode = @loST_NextSchemeCode) and  (@loST_SchemeItemType = @loST_NextSchemeItemType) and  (@loST_ItemNumber = @loST_NextItemNumber) and  (@loST_UofM = @loST_NextUofM) and  (@loDE_QtyFrom = @loDE_NextQtyFrom)  BEGIN  CLOSE scCustomerGroup  DEALLOCATE scCustomerGroup  RETURN 0  END  END END  CLOSE scCustomerGroup DEALLOCATE scCustomerGroup  INSERT INTO SOP50400 (USERID,  ITEMNMBR,  UOFM,  PRCSHID,  EPITMTYP,  STRTDATE,   ENDDATE,  QTYFROM,  QTYTO,  PSITMVAL,   EQUOMQTY,  BASEUOFM,  PROMOLVL,  PROMOTYP,  PRCGRPID,  PRODTCOD,  ACTIVE)  SELECT   @piST_UserID,  GW.ITEMNMBR,  SWU.UOFM,  SW.PRCSHID,  SW.EPITMTYP,  SH.STRTDATE,  SH.ENDDATE,  SWU.QTYFROM,  SWU.QTYTO,  SWU.PSITMVAL,   SWU.EQUOMQTY,  SW.BASEUOFM,  SW.PROMOLVL,  SW.PROMOTYP,  SWU.ITEMNMBR,  SW.PRODTCOD,  SW.ACTIVE  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  WHERE SL.PRODTCOD = @piST_DorP  AND SL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR = @piST_ItemNumber  AND  SWU.UOFM = @piST_UofM  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SW.PRCSHID = @loST_HoldSchemeCode  AND SH.CURNCYID = @piST_Currency  RETURN 0  PriceListProduct:  DECLARE scPriceListProduct SCROLL CURSOR FOR  SELECT SH.STRTDATE,   SH.ENDDATE,  SW.PRCSHID,  SW.EPITMTYP,  SWU.ITEMNMBR,  SWU.UOFM,  SWU.QTYFROM,  SWU.QTYTO,  SWU.PSITMVAL,   SWU.EQUOMQTY,  SW.BASEUOFM,  SW.PROMOLVL,  SW.PROMOTYP  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10205 as PL  ON PL.PRCBKID = SL.LINKCODE  WHERE SL.PRODTCOD = 'P'  AND PL.PRODTCOD = @piST_DorP  AND PL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR = @piST_ItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @piST_Currency  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE,  SW.PRCSHID  OPEN scPriceListProduct  FETCH FIRST FROM scPriceListProduct  INTO @loDA_StartDate,  @loDA_EndDate,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_ItemNumber,  @loST_UofM,  @loDE_QtyFrom,  @loDE_QtyTo,  @loDE_Value,  @loDE_EQUOMQTY,  @loST_BaseUofM,  @loIN_PromLevel,  @loIN_PromType  IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scPriceListProduct  DEALLOCATE scPriceListProduct  GOTO PriceListGroup END ELSE BEGIN SELECT @loST_HoldSchemeCode = @loST_SchemeCode  FETCH NEXT FROM scPriceListProduct  INTO  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_NextSchemeCode,  @loST_NextSchemeItemType,  @loST_NextItemNumber,  @loST_NextUofM,  @loDE_NextQtyFrom,  @loDE_QtyTo,  @loDE_Value,  @loDE_EQUOMQTY,  @loST_BaseUofM,  @loIN_PromLevel,  @loIN_PromType   IF @@FETCH_STATUS = 0  BEGIN  IF  (@loDA_StartDate = @loDA_NextStartDate) and   (@loDA_EndDate = @loDA_NextEndDate) and  (@loST_SchemeCode = @loST_NextSchemeCode) and  (@loST_SchemeItemType = @loST_NextSchemeItemType) and  (@loST_ItemNumber = @loST_NextItemNumber) and  (@loST_UofM = @loST_NextUofM) and  (@loDE_QtyFrom = @loDE_NextQtyFrom)  BEGIN  CLOSE scPriceListProduct  DEALLOCATE scPriceListProduct  RETURN 0  END  END END  CLOSE scPriceListProduct DEALLOCATE scPriceListProduct  INSERT INTO SOP50400 (USERID,  ITEMNMBR,  UOFM,  PRCSHID,  EPITMTYP,  STRTDATE,   ENDDATE,  QTYFROM,  QTYTO,  PSITMVAL,   EQUOMQTY,  BASEUOFM,  PROMOLVL,  PROMOTYP,  PRCGRPID,  PRODTCOD,  ACTIVE)  SELECT   @piST_UserID,  SWU.ITEMNMBR,  SWU.UOFM,  SW.PRCSHID,  SW.EPITMTYP,  SH.STRTDATE,  SH.ENDDATE,  SWU.QTYFROM,  SWU.QTYTO,  SWU.PSITMVAL,   SWU.EQUOMQTY,  SW.BASEUOFM,  SW.PROMOLVL,  SW.PROMOTYP,  ' ',  SW.PRODTCOD,  SW.ACTIVE  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10205 as PL  ON PL.PRCBKID = SL.LINKCODE  WHERE SL.PRODTCOD = 'P'  AND PL.PRODTCOD = @piST_DorP  AND PL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR = @piST_ItemNumber  AND  SWU.UOFM = @piST_UofM  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SW.PRCSHID = @loST_HoldSchemeCode  AND SH.CURNCYID = @piST_Currency  RETURN 0  PriceListGroup:  DECLARE scPriceListGroup SCROLL CURSOR FOR  SELECT SH.STRTDATE,   SH.ENDDATE,  SW.PRCSHID,  SW.EPITMTYP,  SWU.ITEMNMBR,  SWU.UOFM,  SWU.QTYFROM,  SWU.QTYTO,  SWU.PSITMVAL,   SWU.EQUOMQTY,  SW.BASEUOFM,  SW.PROMOLVL,  SW.PROMOTYP  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  INNER JOIN SOP10205 as PL  ON PL.PRCBKID = SL.LINKCODE  WHERE SL.PRODTCOD = 'P'  AND PL.PRODTCOD = @piST_DorP  AND PL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR = @piST_ItemNumber  AND  SWU.UOFM = @piST_UofM  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @piST_Currency  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE,  SW.PRCSHID  OPEN scPriceListGroup  FETCH FIRST FROM scPriceListGroup  INTO @loDA_StartDate,  @loDA_EndDate,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_ItemNumber,  @loST_UofM,  @loDE_QtyFrom,  @loDE_QtyTo,  @loDE_Value,  @loDE_EQUOMQTY,  @loST_BaseUofM,  @loIN_PromLevel,  @loIN_PromType  IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scPriceListGroup  DEALLOCATE scPriceListGroup  GOTO BaseListProduct END ELSE BEGIN  SELECT @loST_HoldSchemeCode = @loST_SchemeCode  FETCH NEXT FROM scPriceListGroup  INTO  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_NextSchemeCode,  @loST_NextSchemeItemType,  @loST_NextItemNumber,  @loST_NextUofM,  @loDE_NextQtyFrom,  @loDE_QtyTo,  @loDE_Value,  @loDE_EQUOMQTY,  @loST_BaseUofM,  @loIN_PromLevel,  @loIN_PromType   IF @@FETCH_STATUS = 0  BEGIN  IF  (@loDA_StartDate = @loDA_NextStartDate) and   (@loDA_EndDate = @loDA_NextEndDate) and  (@loST_SchemeCode = @loST_NextSchemeCode) and  (@loST_SchemeItemType = @loST_NextSchemeItemType) and  (@loST_ItemNumber = @loST_NextItemNumber) and  (@loST_UofM = @loST_NextUofM) and  (@loDE_QtyFrom = @loDE_NextQtyFrom)  BEGIN  CLOSE scPriceListGroup  DEALLOCATE scPriceListGroup  RETURN 0  END  END END  CLOSE scPriceListGroup DEALLOCATE scPriceListGroup  INSERT INTO SOP50400 (USERID,  ITEMNMBR,  UOFM,  PRCSHID,  EPITMTYP,  STRTDATE,   ENDDATE,  QTYFROM,  QTYTO,  PSITMVAL,   EQUOMQTY,  BASEUOFM,  PROMOLVL,  PROMOTYP,  PRCGRPID,  PRODTCOD,  ACTIVE)  SELECT   @piST_UserID,  GW.ITEMNMBR,  SWU.UOFM,  SW.PRCSHID,  SW.EPITMTYP,  SH.STRTDATE,  SH.ENDDATE,  SWU.QTYFROM,  SWU.QTYTO,  SWU.PSITMVAL,   SWU.EQUOMQTY,  SW.BASEUOFM,  SW.PROMOLVL,  SW.PROMOTYP,  SWU.ITEMNMBR,  SW.PRODTCOD,  SW.ACTIVE  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  INNER JOIN SOP10205 as PL  ON PL.PRCBKID = SL.LINKCODE  WHERE SL.PRODTCOD = 'P'  AND PL.PRODTCOD = @piST_DorP  AND PL.LINKCODE = @piST_CustomerNumber  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR = @piST_ItemNumber  AND  SWU.UOFM = @piST_UofM  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SW.PRCSHID = @loST_HoldSchemeCode  AND SH.CURNCYID = @piST_Currency  RETURN 0  BaseListProduct:  DECLARE scBaseListProduct SCROLL CURSOR FOR  SELECT SH.STRTDATE,   SH.ENDDATE,  SW.PRCSHID,  SW.EPITMTYP,  SWU.ITEMNMBR,  SWU.UOFM,  SWU.QTYFROM,  SWU.QTYTO,  SWU.PSITMVAL,   SWU.EQUOMQTY,  SW.BASEUOFM,  SW.PROMOLVL,  SW.PROMOTYP  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10109 as PH  ON PH.PRCBKID = SL.LINKCODE  WHERE PH.ISBASE = 1  AND SL.PRODTCOD = 'P'  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR = @piST_ItemNumber  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE,  SW.PRCSHID  OPEN scBaseListProduct  FETCH FIRST FROM scBaseListProduct  INTO @loDA_StartDate,  @loDA_EndDate,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_ItemNumber,  @loST_UofM,  @loDE_QtyFrom,  @loDE_QtyTo,  @loDE_Value,  @loDE_EQUOMQTY,  @loST_BaseUofM,  @loIN_PromLevel,  @loIN_PromType  IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scBaseListProduct  DEALLOCATE scBaseListProduct  GOTO BaseListGroup END ELSE BEGIN  SELECT @loST_HoldSchemeCode = @loST_SchemeCode  FETCH NEXT FROM scBaseListProduct  INTO  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_NextSchemeCode,  @loST_NextSchemeItemType,  @loST_NextItemNumber,  @loST_NextUofM,  @loDE_NextQtyFrom,  @loDE_QtyTo,  @loDE_Value,  @loDE_EQUOMQTY,  @loST_BaseUofM,  @loIN_PromLevel,  @loIN_PromType   IF @@FETCH_STATUS = 0  BEGIN  IF  (@loDA_StartDate = @loDA_NextStartDate) and   (@loDA_EndDate = @loDA_NextEndDate) and  (@loST_SchemeCode = @loST_NextSchemeCode) and  (@loST_SchemeItemType = @loST_NextSchemeItemType) and  (@loST_ItemNumber = @loST_NextItemNumber) and  (@loST_UofM = @loST_NextUofM) and  (@loDE_QtyFrom = @loDE_NextQtyFrom)  BEGIN  CLOSE scBaseListProduct  DEALLOCATE scBaseListProduct  RETURN 0  END  END END  CLOSE scBaseListProduct DEALLOCATE scBaseListProduct  INSERT INTO SOP50400 (USERID,  ITEMNMBR,  UOFM,  PRCSHID,  EPITMTYP,  STRTDATE,   ENDDATE,  QTYFROM,  QTYTO,  PSITMVAL,   EQUOMQTY,  BASEUOFM,  PROMOLVL,  PROMOTYP,  PRCGRPID,  PRODTCOD,  ACTIVE)  SELECT   @piST_UserID,  SWU.ITEMNMBR,  SWU.UOFM,  SW.PRCSHID,  SW.EPITMTYP,  SH.STRTDATE,  SH.ENDDATE,  SWU.QTYFROM,  SWU.QTYTO,  SWU.PSITMVAL,   SWU.EQUOMQTY,  SW.BASEUOFM,  SW.PROMOLVL,  SW.PROMOTYP,  ' ',  SW.PRODTCOD,  SW.ACTIVE  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10109 as PH  ON PH.PRCBKID = SL.LINKCODE  WHERE PH.ISBASE = 1  AND SL.PRODTCOD = 'P'  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'I'  AND SW.ITEMNMBR = @piST_ItemNumber  AND  SWU.UOFM = @piST_UofM  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SW.PRCSHID = @loST_HoldSchemeCode  AND SH.CURNCYID = @piST_Currency  RETURN 0  BaseListGroup:  DECLARE scBaseListGroup SCROLL CURSOR FOR  SELECT SH.STRTDATE,   SH.ENDDATE,  SW.PRCSHID,  SW.EPITMTYP,  SWU.ITEMNMBR,  SWU.UOFM,  SWU.QTYFROM,  SWU.QTYTO,  SWU.PSITMVAL,   SWU.EQUOMQTY,  SW.BASEUOFM,  SW.PROMOLVL,  SW.PROMOTYP  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10109 as PH  ON PH.PRCBKID = SL.LINKCODE  INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  WHERE PH.ISBASE = 1  AND SL.PRODTCOD = 'P'  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR = @piST_ItemNumber  AND  SWU.UOFM = @piST_UofM  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SH.CURNCYID = @piST_Currency  ORDER BY SH.STRTDATE DESC,  SH.ENDDATE,  SW.PRCSHID  OPEN scBaseListGroup  FETCH FIRST FROM scBaseListGroup  INTO @loDA_StartDate,  @loDA_EndDate,  @loST_SchemeCode,  @loST_SchemeItemType,  @loST_ItemNumber,  @loST_UofM,  @loDE_QtyFrom,  @loDE_QtyTo,  @loDE_Value,  @loDE_EQUOMQTY,  @loST_BaseUofM,  @loIN_PromLevel,  @loIN_PromType  IF @@FETCH_STATUS <> 0 BEGIN  CLOSE scBaseListGroup  DEALLOCATE scBaseListGroup  RETURN 0 END ELSE BEGIN  SELECT @loST_HoldSchemeCode = @loST_SchemeCode  FETCH NEXT FROM scBaseListGroup  INTO  @loDA_NextStartDate,  @loDA_NextEndDate,  @loST_NextSchemeCode,  @loST_NextSchemeItemType,  @loST_NextItemNumber,  @loST_NextUofM,  @loDE_NextQtyFrom,  @loDE_QtyTo,  @loDE_Value,  @loDE_EQUOMQTY,  @loST_BaseUofM,  @loIN_PromLevel,  @loIN_PromType   IF @@FETCH_STATUS = 0  BEGIN  IF  (@loDA_StartDate = @loDA_NextStartDate) and   (@loDA_EndDate = @loDA_NextEndDate) and  (@loST_SchemeCode = @loST_NextSchemeCode) and  (@loST_SchemeItemType = @loST_NextSchemeItemType) and  (@loST_ItemNumber = @loST_NextItemNumber) and  (@loST_UofM = @loST_NextUofM) and  (@loDE_QtyFrom = @loDE_NextQtyFrom)  BEGIN  CLOSE scBaseListGroup  DEALLOCATE scBaseListGroup  RETURN 0  END  END END  CLOSE scBaseListGroup DEALLOCATE scBaseListGroup  INSERT INTO SOP50400 (USERID,  ITEMNMBR,  UOFM,  PRCSHID,  EPITMTYP,  STRTDATE,   ENDDATE,  QTYFROM,  QTYTO,  PSITMVAL,   EQUOMQTY,  BASEUOFM,  PROMOLVL,  PROMOTYP,  PRCGRPID,  PRODTCOD,  ACTIVE)  SELECT   @piST_UserID,  GW.ITEMNMBR,  SWU.UOFM,  SW.PRCSHID,  SW.EPITMTYP,  SH.STRTDATE,  SH.ENDDATE,  SWU.QTYFROM,  SWU.QTYTO,  SWU.PSITMVAL,   SWU.EQUOMQTY,  SW.BASEUOFM,  SW.PROMOLVL,  SW.PROMOTYP,  SWU.ITEMNMBR,  SW.PRODTCOD,  SW.ACTIVE  FROM RM00500 as SL  INNER JOIN SOP10110 as SH  ON SH.PRCSHID = SL.PRCSHID  INNER JOIN IV10401 as SW  ON SW.PRCSHID = SL.PRCSHID  INNER JOIN IV10402 as SWU  ON SWU.PRCSHID = SL.PRCSHID  AND SWU.ITEMNMBR = SW.ITEMNMBR  INNER JOIN SOP10109 as PH  ON PH.PRCBKID = SL.LINKCODE  INNER JOIN IV10400 as GW  ON GW.PRCGRPID = SW.ITEMNMBR  WHERE PH.ISBASE = 1  AND SL.PRODTCOD = 'P'  AND SH.ACTIVE = 1  AND SW.ACTIVE = 1  AND SW.EPITMTYP = 'G'  AND GW.ITEMNMBR = @piST_ItemNumber  AND  SWU.UOFM = @piST_UofM  AND SH.STRTDATE <= @piDA_Date  AND SH.ENDDATE >= @piDA_Date  AND SH.PROMO = 1  AND SW.PRCSHID = @loST_HoldSchemeCode  AND SH.CURNCYID = @piST_Currency  RETURN 0    
GO
GRANT EXECUTE ON  [dbo].[ExtPricingGetPromoItems] TO [DYNGRP]
GO
