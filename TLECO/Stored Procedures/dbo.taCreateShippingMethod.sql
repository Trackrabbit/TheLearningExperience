SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[taCreateShippingMethod]  @I_vSHIPMTHD char(15),   @I_vSHMTHDSC char(30)='',   @I_vPHONNAME char(14)='',   @I_vCONTACT char(60)='',   @I_vCARRACCT char(15)='',   @I_vCARRIER char(30)='',   @I_vSHIPTYPE smallint=1,   @I_vUpdateIfExists tinyint = 0,   @I_vUSERID  char(15)='',   @I_vCREATDDT datetime = null,  @I_vMODIFDT datetime = null,  @I_vNOTETEXT  varchar(8000) = null,  @I_vUSRDEFND1  char(50) = '',       @I_vUSRDEFND2  char(50) = '',       @I_vUSRDEFND3  char(50) = '',       @I_vUSRDEFND4  varchar(8000) = '',  @I_vUSRDEFND5  varchar(8000) = '',  @O_iErrorState int output,   @oErrString varchar(255) output   with encryption as  set transaction isolation level read uncommitted set nocount on  declare  @nNextNoteIndex numeric(19,5),    @sCompanyID smallint,     @iStatus int,      @iCustomState int,  @O_oErrorState int,  @iGetNextNoteIdxErrState int,  @iCustomErrString varchar(255),  @iError int,  @exists tinyint select  @nNextNoteIndex = 0,     @sCompanyID = 0,     @iStatus = 0,  @iCustomState = 0,  @O_oErrorState = 0,  @O_iErrorState = 0,     @iGetNextNoteIdxErrState = 0,  @iCustomErrString = '',  @iError = 0,  @exists = 0  if (@oErrString is NULL) begin  select @oErrString = '' end  exec @iStatus = taCreateShippingMethodPre  @I_vSHIPMTHD output,    @I_vSHMTHDSC output,    @I_vPHONNAME output,    @I_vCONTACT output,    @I_vCARRACCT output,    @I_vCARRIER output,    @I_vSHIPTYPE output,    @I_vUpdateIfExists output,   @I_vUSERID  output,  @I_vCREATDDT  output,  @I_vMODIFDT output,  @I_vNOTETEXT    output,  @I_vUSRDEFND1  output,  @I_vUSRDEFND2  output,  @I_vUSRDEFND3  output,  @I_vUSRDEFND4  output,  @I_vUSRDEFND5  output,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if ((@iStatus <> 0) or (@iCustomState <> 0) or (@iError <> 0)) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  select @O_iErrorState = 5334    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  if (  @I_vSHIPMTHD is null or  @I_vSHMTHDSC is null or  @I_vPHONNAME is null or  @I_vCONTACT is null or  @I_vCARRACCT is null or  @I_vCARRIER is null or  @I_vSHIPTYPE is null or  @I_vUpdateIfExists is null or   @I_vUSERID is null  ) begin  select @O_iErrorState = 168    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  select  @I_vSHIPMTHD = UPPER(@I_vSHIPMTHD)  select @sCompanyID = CMPANYID from DYNAMICS..SY01500 (nolock) where INTERID = db_name()  if (@I_vSHIPMTHD = '') begin  select @O_iErrorState = 169     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vUpdateIfExists < 0 or @I_vUpdateIfExists > 1) begin  select @O_iErrorState = 3717     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (@I_vSHIPTYPE < 0 or @I_vSHIPTYPE > 1) begin  select @O_iErrorState = 1634     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output end  if (exists(select top 1 SHIPMTHD from SY03000 (nolock) where SHIPMTHD = @I_vSHIPMTHD)) begin  select @exists = 1 end  if (@exists = 0) begin  exec @iStatus = DYNAMICS..tasmGetNextNoteIndex  @I_sCompanyID   = @sCompanyID,  @I_iSQLSessionID = 0,  @I_noteincrement  = 1,  @O_mNoteIndex   = @nNextNoteIndex output,  @O_iErrorState  = @iGetNextNoteIdxErrState output  select @iError = @@error  if ((@iStatus <> 0) or (@iGetNextNoteIdxErrState <> 0) or (@iError <> 0))  begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iGetNextNoteIdxErrState))  select @O_iErrorState = 6501   exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end end  if (@O_iErrorState = 0) begin  if (@exists = 0)  begin  insert into SY03000 (  SHIPMTHD,  SHMTHDSC,  PHONNAME,  CONTACT,  CARRACCT,  CARRIER,  SHIPTYPE,  NOTEINDX,  LSTUSRED,  CREATDDT,  MODIFDT  )  select  @I_vSHIPMTHD,      @I_vSHMTHDSC,      @I_vPHONNAME,      @I_vCONTACT,      @I_vCARRACCT,      @I_vCARRIER,      @I_vSHIPTYPE,      @nNextNoteIndex,     @I_vUSERID,      case       WHEN @I_vCREATDDT is null  THEN convert(varchar(12),getdate())  ElSE @I_vCREATDDT  end,   case       WHEN @I_vMODIFDT is null  THEN convert(varchar(12),getdate())   ELSE @I_vMODIFDT  end   if (@@error <> 0)  begin  select @O_iErrorState = 171    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  end  else  begin  if (@I_vUpdateIfExists = 1)  begin  update SY03000 set  SHMTHDSC = @I_vSHMTHDSC,  PHONNAME = @I_vPHONNAME,  CONTACT  = @I_vCONTACT,  CARRACCT = @I_vCARRACCT,  CARRIER  = @I_vCARRIER,  SHIPTYPE = @I_vSHIPTYPE,  LSTUSRED = @I_vUSERID,  MODIFDT  =     case   WHEN @I_vMODIFDT is null  THEN convert(varchar(12),getdate())   ELSE @I_vMODIFDT  end   where SHIPMTHD = @I_vSHIPMTHD  if (@@error <> 0)  begin  select @O_iErrorState = 172    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  end  end  end end  if (@exists = 1) begin  select @nNextNoteIndex = NOTEINDX from SY03000 (nolock) where SHIPMTHD = @I_vSHIPMTHD   if (@I_vNOTETEXT is null)  begin  select @I_vNOTETEXT = TXTFIELD from SY03900 (nolock) where NOTEINDX = @nNextNoteIndex  end end else begin  if (@I_vNOTETEXT is null)  begin  select @I_vNOTETEXT = ''  end end  if (@I_vNOTETEXT <> '') begin  if not ((@I_vUpdateIfExists = 0) and (@exists = 1))  begin  if (not exists(select 1 from SY03900 (nolock) where NOTEINDX = @nNextNoteIndex))  begin  insert SY03900   (  NOTEINDX,   DATE1,   TIME1,   TXTFIELD  )   select   @nNextNoteIndex,       convert(varchar(12),getdate()),      substring(convert(varchar(25),getdate()),12,12),   @I_vNOTETEXT        if (@@error <> 0)  begin  select @O_iErrorState = 5876    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end  end  else  begin  if (@I_vUpdateIfExists = 1)  begin  update SY03900 set   DATE1 = convert(varchar(12),getdate()),   TIME1 = substring(convert(varchar(25),getdate()),12,12),   TXTFIELD = @I_vNOTETEXT  where NOTEINDX = @nNextNoteIndex  if (@@error <> 0)  begin  select @O_iErrorState = 9239     exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end  end  end  end end else begin  delete SY03900 where NOTEINDX = @nNextNoteIndex  if (@@error <> 0)  begin  select @O_iErrorState = 9240    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState)  end end  if (@O_iErrorState <> 0) begin  return (@O_iErrorState) end  exec @iStatus = taCreateShippingMethodPost  @I_vSHIPMTHD,   @I_vSHMTHDSC,   @I_vPHONNAME,   @I_vCONTACT,   @I_vCARRACCT,   @I_vCARRIER,   @I_vSHIPTYPE,   @I_vUpdateIfExists,   @I_vUSERID,  @I_vCREATDDT,  @I_vMODIFDT,  @I_vNOTETEXT,  @I_vUSRDEFND1,  @I_vUSRDEFND2,  @I_vUSRDEFND3,  @I_vUSRDEFND4,  @I_vUSRDEFND5,  @O_iErrorState = @iCustomState output,  @oErrString = @iCustomErrString output select @iError = @@error if ((@iStatus <> 0) or (@iCustomState <> 0) or (@iError <> 0)) begin  select @oErrString = rtrim(@oErrString) + ' ' + ltrim(rtrim(@iCustomErrString))  select @O_iErrorState = 6500    exec @iStatus = taUpdateString  @O_iErrorState,  @oErrString,  @oErrString output,  @O_oErrorState output  return (@O_iErrorState) end  return (@O_iErrorState)   
GO
GRANT EXECUTE ON  [dbo].[taCreateShippingMethod] TO [DYNGRP]
GO
