SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[seeSOPSalesDocCountsMetric]  @I_dUserDate datetime = NULL,  @I_iPeriodMonths int   = NULL,  @DocumentType varchar(12) as  declare  @startDate datetime,   @endDate datetime,    @pos        int,  @nextpos    int,  @valuelen   int,  @SOPType1   int,  @SOPType2   int,  @SOPType3   int,  @SOPType4   int,  @iterator   int,  @temptype int  SELECT @pos = 0, @nextpos = 1, @SOPType1 = 0, @SOPType2  = 0, @SOPType3 = 0, @SOPType4 = 0, @iterator = 1   WHILE @nextpos > 0  BEGIN  SELECT @nextpos = charindex(',', @DocumentType, @pos + 1)  SELECT @valuelen = CASE WHEN @nextpos > 0  THEN @nextpos  ELSE len(@DocumentType) + 1  END - @pos - 1  select @temptype = convert(int, substring(@DocumentType, @pos + 1, @valuelen))  if @temptype=1  select  @SOPType1= convert(int, substring(@DocumentType, @pos + 1, @valuelen))  if @temptype=2  select  @SOPType2= convert(int, substring(@DocumentType, @pos + 1, @valuelen))  if @temptype=3  select  @SOPType3= convert(int, substring(@DocumentType, @pos + 1, @valuelen))  if @temptype=6  select  @SOPType4= convert(int, substring(@DocumentType, @pos + 1, @valuelen))   SELECT @pos = @nextpos  END  select  @I_dUserDate = DATEADD(HOUR, -DATEPART(HOUR, @I_dUserDate), @I_dUserDate) select  @I_dUserDate = DATEADD(MINUTE, -DATEPART(MINUTE, @I_dUserDate), @I_dUserDate) select  @I_dUserDate = DATEADD(SECOND, -DATEPART(SECOND, @I_dUserDate), @I_dUserDate) select  @I_dUserDate = DATEADD(MILLISECOND, -DATEPART(MILLISECOND, @I_dUserDate), @I_dUserDate)  select  @endDate = DATEADD(day, -DAY(@I_dUserDate), @I_dUserDate) select  @startDate = DATEADD(MONTH, -@I_iPeriodMonths, DATEADD(day, -DAY(@I_dUserDate)+1, @I_dUserDate))  create table #SalesDocCounts (NumDocs int not null,   MonthDate datetime not null,  SopType smallint not null) select  @iterator = @I_iPeriodMonths while (@iterator >= 1) begin  if @SOPType1 > 0  insert into #SalesDocCounts values(0, DATEADD(month, -@iterator, DATEADD(day, -day(@I_dUserDate)+1, @I_dUserDate)), 1)  if @SOPType2 > 0  insert into #SalesDocCounts values(0, DATEADD(month, -@iterator, DATEADD(day, -day(@I_dUserDate)+1, @I_dUserDate)), 2)  if @SOPType3 > 0  insert into #SalesDocCounts values(0, DATEADD(month, -@iterator, DATEADD(day, -day(@I_dUserDate)+1, @I_dUserDate)), 3)  if @SOPType4 > 0  insert into #SalesDocCounts values(0, DATEADD(month, -@iterator, DATEADD(day, -day(@I_dUserDate)+1, @I_dUserDate)), 6)  select @iterator = @iterator - 1 end  insert #SalesDocCounts  (NumDocs,  MonthDate,  SopType) select  count(DatePart(month, DOCDATE)) as NumDocs,  DATEADD(DAY, -DAY(DOCDATE)+1, DOCDATE) as MonthDate,  SOPTYPE as SopType from  SOP10100 with (NOLOCK) where  DOCDATE >= @startDate and DOCDATE <= @endDate  and (SOPTYPE = @SOPType1 or SOPTYPE = @SOPType2 or SOPTYPE = @SOPType3 or SOPTYPE = @SOPType4) group by  DOCDATE,  SOPTYPE union all select  count(DatePart(month, DOCDATE)) as NumDocs,  DATEADD(DAY, -DAY(DOCDATE)+1, DOCDATE) as MonthDate,  SOPTYPE as SopType from  SOP30200 with (NOLOCK) where  DOCDATE >= @startDate and DOCDATE <= @endDate and VOIDSTTS = 0  and (SOPTYPE = @SOPType1 or SOPTYPE = @SOPType2 or SOPTYPE = @SOPType3 or SOPTYPE = @SOPType4) group by  DOCDATE,  SOPTYPE order by  MonthDate,  SOPTYPE  select  MonthDate,  SUM(NumDocs) as NumDocs,  case SopType  when 1 then 'Quote'  when 2 then 'Order'  when 6 then 'Fulfillment Order'  when 3 then 'Invoice'  end as DocType from  #SalesDocCounts with (NOLOCK) group by  MonthDate,  SopType  drop table #SalesDocCounts    
GO
GRANT EXECUTE ON  [dbo].[seeSOPSalesDocCountsMetric] TO [DYNGRP]
GO
GRANT EXECUTE ON  [dbo].[seeSOPSalesDocCountsMetric] TO [rpt_executive]
GO
GRANT EXECUTE ON  [dbo].[seeSOPSalesDocCountsMetric] TO [rpt_purchasing manager]
GO
