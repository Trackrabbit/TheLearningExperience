SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[aagCopyToGLWorkFromSubLedger] @I_nSubLedHdrID int, @I_nOrigSeqNum numeric(19,5), @I_nGLWorkHdrID int, @I_nDistID int, @I_nJrnEntry int, @I_dtGLPostingDate datetime, @L_SeqLine numeric(19,5), @O_fSuccess tinyint  output as  set nocount on   Declare @Series smallint,  @aaGLWorkAssignID int,  @L_SeqLineTmp numeric(19,5),  @DOCTYPE smallint,  @tempSEQNUMBR int,  @constSeqLine numeric(19,5),  @execCmd varchar(8000),  @tempTableName varchar(50),  @FUNLCURR char(15),  @aaGLWorkDistID int,  @CURRID char(15)   Select @Series = SERIES ,@DOCTYPE = DOCTYPE  from AAG20000 where aaSubLedgerHdrID = @I_nSubLedHdrID  select @FUNLCURR = FUNLCURR from MC40000   if @Series = 5  BEGIN   SELECT @L_SeqLineTmp = SQNCLINE from AAG10001 where aaGLWorkHdrID = @I_nGLWorkHdrID and  aaGLWorkDistID = @I_nDistID  IF @L_SeqLineTmp is null or @L_SeqLineTmp = 0  BEGIN  INSERT INTO AAG10001(aaGLWorkHdrID,aaGLWorkDistID,  INTERID,CorrespondingUnit,ACTINDX,ACCTTYPE,DECPLACS,FXDORVAR,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,CURNCYID,CURRNIDX,RATETPID,EXGTBLID,  XCHGRATE,EXCHDATE,TIME1,RTCLCMTD,DENXRATE,MCTRXSTT,SQNCLINE,  aaCustID,aaVendID,aaSiteID,aaItemID,  aaCopyStatus,aaWinWasOpen,aaDistErrors,aaBrowseType,aaChangeDate,aaChangeTime)  SELECT @I_nGLWorkHdrID,@I_nDistID,  INTERID,CorrespondingUnit,ACTINDX,ACCTTYPE,DECPLACS,dbo.aagFixedOrVar(ACTINDX),   DEBITAMT,CRDTAMNT,DEBITAMT,CRDTAMNT,CURNCYID,CURRNIDX,RATETPID,EXGTBLID,  XCHGRATE,EXCHDATE,TIME1,RTCLCMTD,DENXRATE,MCTRXSTT,@L_SeqLine,  aaCustID,aaVendID,aaSiteID,aaItemID,  aaCopyStatus,1,0,aaBrowseType,convert(char(12), getdate(), 102),convert(char(12), getdate(), 108)  from AAG20001 where aaSubLedgerHdrID = @I_nSubLedHdrID and  aaSubLedgerDistID = @I_nOrigSeqNum    END   SELECT @aaGLWorkAssignID = aaGLWorkAssignID from AAG10002 where aaGLWorkHdrID = @I_nGLWorkHdrID and  aaGLWorkDistID = @I_nDistID  IF @aaGLWorkAssignID is null or @aaGLWorkAssignID = 0  BEGIN  INSERT INTO AAG10002(aaGLWorkHdrID,aaGLWorkDistID,aaGLWorkAssignID,aaAssignedPercent,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,DistRef,NOTEINDX,aaAliasID)  SELECT @I_nGLWorkHdrID,@I_nDistID,aaSubLedgerAssignID,aaAssignedPercent,  DEBITAMT,CRDTAMNT,DEBITAMT,CRDTAMNT,DistRef,NOTEINDX,aaAliasID  from AAG20002 where aaSubLedgerHdrID = @I_nSubLedHdrID and  aaSubLedgerDistID = @I_nOrigSeqNum   END   SELECT @aaGLWorkAssignID = aaGLWorkAssignID from AAG10003 where aaGLWorkHdrID = @I_nGLWorkHdrID and  aaGLWorkDistID = @I_nDistID  IF @aaGLWorkAssignID is null or @aaGLWorkAssignID = 0  BEGIN  INSERT INTO AAG10003(aaGLWorkHdrID,aaGLWorkDistID,aaGLWorkAssignID,  aaTrxDimID,aaTrxCodeID,aaCodeErrors)  SELECT @I_nGLWorkHdrID,@I_nDistID,aaSubLedgerAssignID,  aaTrxDimID,aaTrxCodeID,aaCodeErrors  from AAG20003 where aaSubLedgerHdrID = @I_nSubLedHdrID  and  aaSubLedgerDistID = @I_nOrigSeqNum   END  EXEC aagClearGLWorkCustVendItemSiteInfoALLDists @I_nGLWorkHdrID  RETURN  END  if (@Series = 2)  begin   INSERT INTO AAG10001(aaGLWorkHdrID,aaGLWorkDistID,  INTERID,CorrespondingUnit,ACTINDX,ACCTTYPE,DECPLACS,FXDORVAR,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,CURNCYID,CURRNIDX,RATETPID,EXGTBLID,  XCHGRATE,EXCHDATE,TIME1,RTCLCMTD,DENXRATE,MCTRXSTT,SQNCLINE,  aaCustID,aaVendID,aaSiteID,aaItemID,  aaCopyStatus,aaWinWasOpen,aaDistErrors,aaBrowseType,aaChangeDate,aaChangeTime)  SELECT @I_nGLWorkHdrID,@I_nDistID,  INTERID,CorrespondingUnit,ACTINDX,ACCTTYPE,DECPLACS,dbo.aagFixedOrVar(ACTINDX),   DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,CURNCYID,CURRNIDX,RATETPID,EXGTBLID,  XCHGRATE,EXCHDATE,TIME1,RTCLCMTD,DENXRATE,MCTRXSTT,@L_SeqLine,  aaCustID,aaVendID,aaSiteID,aaItemID,  aaCopyStatus,1,0,aaBrowseType,convert(char(12), getdate(), 102),convert(char(12), getdate(), 108)  from AAG20001 where aaSubLedgerHdrID = @I_nSubLedHdrID and  (SEQNUMBR =  @L_SeqLine )   INSERT INTO AAG10002(aaGLWorkHdrID,aaGLWorkDistID,aaGLWorkAssignID,aaAssignedPercent,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,DistRef,NOTEINDX,aaAliasID)  SELECT @I_nGLWorkHdrID,@I_nDistID,aaSubLedgerAssignID,aaAssignedPercent,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,DistRef,NOTEINDX,aaAliasID  from AAG20002 where aaSubLedgerHdrID = @I_nSubLedHdrID and  exists  (select 1 from AAG20001  where aaSubLedgerHdrID = @I_nSubLedHdrID and  aaSubLedgerDistID =AAG20002.aaSubLedgerDistID and  (SEQNUMBR =  @L_SeqLine ))   INSERT INTO AAG10003(aaGLWorkHdrID,aaGLWorkDistID,aaGLWorkAssignID,  aaTrxDimID,aaTrxCodeID,aaCodeErrors)  SELECT @I_nGLWorkHdrID,@I_nDistID,aaSubLedgerAssignID,  aaTrxDimID,aaTrxCodeID,aaCodeErrors  from AAG20003 where aaSubLedgerHdrID = @I_nSubLedHdrID  and  exists (select 1 from AAG20001  where aaSubLedgerHdrID = @I_nSubLedHdrID and  aaSubLedgerDistID = AAG20003.aaSubLedgerDistID and  (SEQNUMBR =  @L_SeqLine  ))   EXEC aagClearGLWorkCustVendItemSiteInfoALLDists @I_nGLWorkHdrID  RETURN   end  if (@Series = 3 and @DOCTYPE = 9)  begin  set @tempTableName = '[##TempSubLedgerHdr' + system_user + db_name() +']'  set @execCmd = ''  select @execCmd = 'SELECT aaSubLedgerDistID, INTERID,CorrespondingUnit,ACTINDX,ACCTTYPE,DECPLACS,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,CURNCYID,CURRNIDX,RATETPID,EXGTBLID,  XCHGRATE,EXCHDATE,TIME1,RTCLCMTD,DENXRATE,MCTRXSTT,  aaCustID,aaVendID,aaSiteID,aaItemID,EMPLOYID,  aaCopyStatus,aaBrowseType, SEQNUMBR into '+ @tempTableName + ' FROM AAG20001 WHERE aaSubLedgerHdrID = ' + ltrim(@I_nSubLedHdrID)  exec (@execCmd)   set @execCmd = ''  select @execCmd = 'ALTER TABLE '+ @tempTableName + ' ADD OrigSEQNUMBR numeric(19, 5) not null default (0)'  exec (@execCmd)   SELECT @constSeqLine = [Value] FROM DYNAMICS..CONSTANTS WHERE Name like 'SEQUENCE_LINE'   SELECT @L_SeqLineTmp = isnull(MAX(SQNCLINE),0) FROM GL10001 WHERE JRNENTRY=@I_nJrnEntry AND ORCTRNUM =  (SELECT MAX(ORCTRNUM) ORCTRNUM FROM GL10001 WHERE JRNENTRY=@I_nJrnEntry AND ORCTRNUM <   (select ORCTRNUM FROM GL10001 WHERE JRNENTRY=@I_nJrnEntry AND SQNCLINE=@L_SeqLine group by ORCTRNUM))   set @execCmd = ''  select @execCmd = ' DECLARE UpdateOrgiSequenc CURSOR FAST_FORWARD FOR  SELECT SEQNUMBR FROM '+ @tempTableName + ' ORDER BY SEQNUMBR '  exec (@execCmd)  OPEN UpdateOrgiSequenc  FETCH NEXT FROM UpdateOrgiSequenc INTO @tempSEQNUMBR  WHILE @@fetch_status = 0  begin  SET @L_SeqLineTmp = @L_SeqLineTmp + @constSeqLine   set @execCmd = ''  select @execCmd = 'UPDATE '+ @tempTableName + ' SET OrigSEQNUMBR = ' + ltrim(@L_SeqLineTmp) + ' WHERE SEQNUMBR = ' + ltrim(@tempSEQNUMBR)  exec (@execCmd)  FETCH NEXT FROM UpdateOrgiSequenc INTO @tempSEQNUMBR  end  CLOSE  UpdateOrgiSequenc  DEALLOCATE UpdateOrgiSequenc   set @execCmd = ''  select @execCmd = ' INSERT INTO AAG10001(aaGLWorkHdrID,aaGLWorkDistID,  INTERID,CorrespondingUnit,ACTINDX,ACCTTYPE,DECPLACS,FXDORVAR,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,CURNCYID,CURRNIDX,RATETPID,EXGTBLID,  XCHGRATE,EXCHDATE,TIME1,RTCLCMTD,DENXRATE,MCTRXSTT,SQNCLINE,  aaCustID,aaVendID,aaSiteID,aaItemID,  aaCopyStatus,aaWinWasOpen,aaDistErrors,aaBrowseType,aaChangeDate,aaChangeTime)  SELECT ' + ltrim(@I_nGLWorkHdrID) + ' HdrID,' + ltrim(@I_nDistID) +' DistID,  INTERID,CorrespondingUnit,ACTINDX,ACCTTYPE,DECPLACS,dbo.aagFixedOrVar(ACTINDX),   DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,CURNCYID,CURRNIDX,RATETPID,EXGTBLID,  XCHGRATE,EXCHDATE,TIME1,RTCLCMTD,DENXRATE,MCTRXSTT,' + ltrim(@L_SeqLine) + ' SQNCLINE,  aaCustID,aaVendID,aaSiteID,aaItemID,  aaCopyStatus,1,0,aaBrowseType,convert(char(12), getdate(), 102),convert(char(12), getdate(), 108)  from '+ @tempTableName + ' where (OrigSEQNUMBR =  ' + ltrim(@L_SeqLine) + ')'   exec (@execCmd)   set @execCmd = ''  select @execCmd = ' INSERT INTO AAG10002(aaGLWorkHdrID,aaGLWorkDistID,aaGLWorkAssignID,aaAssignedPercent,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,DistRef,NOTEINDX,aaAliasID)  SELECT ' + ltrim(@I_nGLWorkHdrID) + ' HdrID,' + ltrim(@I_nDistID) +' DistID,aaSubLedgerAssignID,aaAssignedPercent,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,DistRef,NOTEINDX,aaAliasID  from AAG20002 where aaSubLedgerHdrID = ' + ltrim(@I_nSubLedHdrID) + 'and  exists  (select 1 from '+ @tempTableName + '  where aaSubLedgerDistID =AAG20002.aaSubLedgerDistID and  (OrigSEQNUMBR =  ' + ltrim(@L_SeqLine) + '))'   exec (@execCmd)   set @execCmd = ''  select @execCmd = ' INSERT INTO AAG10003(aaGLWorkHdrID,aaGLWorkDistID,aaGLWorkAssignID,  aaTrxDimID,aaTrxCodeID,aaCodeErrors)  SELECT ' + ltrim(@I_nGLWorkHdrID) + ' HdrID,' + ltrim(@I_nDistID) +' DistID,aaSubLedgerAssignID,  aaTrxDimID,aaTrxCodeID,aaCodeErrors  from AAG20003 where aaSubLedgerHdrID = ' + ltrim(@I_nSubLedHdrID) + '  and  exists (select 1 from '+ @tempTableName + '  where aaSubLedgerDistID = AAG20003.aaSubLedgerDistID and  (OrigSEQNUMBR =  ' + ltrim(@L_SeqLine) + ' ))'  exec (@execCmd)   EXEC aagClearGLWorkCustVendItemSiteInfoALLDists @I_nGLWorkHdrID  set @execCmd = ''  select @execCmd = ' DROP TABLE '+ @tempTableName  exec (@execCmd)   RETURN  end  SELECT @L_SeqLineTmp = SQNCLINE from AAG10001 where aaGLWorkHdrID = @I_nGLWorkHdrID and  aaGLWorkDistID = @I_nDistID  IF @L_SeqLineTmp is null or @L_SeqLineTmp = 0  BEGIN  INSERT INTO AAG10001(aaGLWorkHdrID,aaGLWorkDistID,  INTERID,CorrespondingUnit,ACTINDX,ACCTTYPE,DECPLACS,FXDORVAR,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,CURNCYID,CURRNIDX,RATETPID,EXGTBLID,  XCHGRATE,EXCHDATE,TIME1,RTCLCMTD,DENXRATE,MCTRXSTT,SQNCLINE,  aaCustID,aaVendID,aaSiteID,aaItemID,  aaCopyStatus,aaWinWasOpen,aaDistErrors,aaBrowseType,aaChangeDate,aaChangeTime)  SELECT @I_nGLWorkHdrID,@I_nDistID,  INTERID,CorrespondingUnit,ACTINDX,ACCTTYPE,DECPLACS,dbo.aagFixedOrVar(ACTINDX),   DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,CURNCYID,CURRNIDX,RATETPID,EXGTBLID,  XCHGRATE,EXCHDATE,TIME1,RTCLCMTD,DENXRATE,MCTRXSTT,@L_SeqLine,  aaCustID,aaVendID,aaSiteID,aaItemID,  aaCopyStatus,1,0,aaBrowseType,convert(char(12), getdate(), 102),convert(char(12), getdate(), 108)  from AAG20001 where aaSubLedgerHdrID = @I_nSubLedHdrID and  (SEQNUMBR =  @I_nOrigSeqNum )  END   SELECT @aaGLWorkAssignID = aaGLWorkAssignID from AAG10002 where aaGLWorkHdrID = @I_nGLWorkHdrID and  aaGLWorkDistID = @I_nDistID  IF @aaGLWorkAssignID is null or @aaGLWorkAssignID = 0  BEGIN  INSERT INTO AAG10002(aaGLWorkHdrID,aaGLWorkDistID,aaGLWorkAssignID,aaAssignedPercent,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,DistRef,NOTEINDX,aaAliasID)  SELECT @I_nGLWorkHdrID,@I_nDistID,aaSubLedgerAssignID,aaAssignedPercent,  DEBITAMT,CRDTAMNT,ORDBTAMT,ORCRDAMT,DistRef,NOTEINDX,aaAliasID  from AAG20002 where aaSubLedgerHdrID = @I_nSubLedHdrID and  exists  (select 1 from AAG20001  where aaSubLedgerHdrID = @I_nSubLedHdrID and  aaSubLedgerDistID = AAG20002.aaSubLedgerDistID and  (SEQNUMBR =  @I_nOrigSeqNum ))  END   SELECT @aaGLWorkAssignID = aaGLWorkAssignID from AAG10003 where aaGLWorkHdrID = @I_nGLWorkHdrID and  aaGLWorkDistID = @I_nDistID  IF @aaGLWorkAssignID is null or @aaGLWorkAssignID = 0  BEGIN  INSERT INTO AAG10003(aaGLWorkHdrID,aaGLWorkDistID,aaGLWorkAssignID,  aaTrxDimID,aaTrxCodeID,aaCodeErrors)  SELECT @I_nGLWorkHdrID,@I_nDistID,aaSubLedgerAssignID,  aaTrxDimID,aaTrxCodeID,aaCodeErrors  from AAG20003 where aaSubLedgerHdrID = @I_nSubLedHdrID  and  exists (select 1 from AAG20001  where aaSubLedgerHdrID = @I_nSubLedHdrID and  aaSubLedgerDistID = AAG20003.aaSubLedgerDistID and  (SEQNUMBR =  @I_nOrigSeqNum  ))  END    EXEC aagClearGLWorkCustVendItemSiteInfoALLDists @I_nGLWorkHdrID   SELECT  @aaGLWorkDistID = aaGLWorkDistID,@CURRID = CURNCYID from AAG10001 WHERE aaGLWorkHdrID = @I_nGLWorkHdrID and SQNCLINE =  @L_SeqLine  if  (@FUNLCURR = @CURRID) or ISNULL(len(rtrim(ltrim(@CURRID))),0) = 0  begin  update AAG10001 set ORCRDAMT = CRDTAMNT , ORDBTAMT = DEBITAMT where  aaGLWorkHdrID = @I_nGLWorkHdrID and aaGLWorkDistID = @aaGLWorkDistID  update AAG10002 set ORCRDAMT = CRDTAMNT , ORDBTAMT = DEBITAMT where  aaGLWorkHdrID = @I_nGLWorkHdrID and aaGLWorkDistID = @aaGLWorkDistID  and aaGLWorkAssignID > 0  end    set nocount off    
GO
GRANT EXECUTE ON  [dbo].[aagCopyToGLWorkFromSubLedger] TO [DYNGRP]
GO
