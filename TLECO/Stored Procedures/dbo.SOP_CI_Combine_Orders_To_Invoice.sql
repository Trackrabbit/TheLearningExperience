SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SOP_CI_Combine_Orders_To_Invoice]   @SOPNUMBE  VARCHAR  (21) ,   @TableName  VARCHAR  (50),  @FunDecPlace   int,  @DocID   varchar(15),  @EC integer  AS   declare @ExecString  varchar (8000)   declare @ExecString1  nvarchar (4000)   declare @CommonString1 varchar (8000)   declare @CommonString2 varchar (8000)   declare @CommonString3 varchar (8000)   declare @Param nvarchar(500)  declare @XCHGRATE NUMERIC(19,7)  declare @RTCLCMTD BIT   declare @I_sMCTrxState SMALLINT = NULL  declare @I_nDenomExchangeRate NUMERIC(15,7) = NULL  declare @I_sViewMode smallint = NULL  declare @Packslnumbr as varchar(21)  declare @Picknumbr as varchar(21)  declare @SOPStatus as int  set @I_sViewMode=4  if (Select MPACKSLP from SOP40100)=2  BEGIN  select @Packslnumbr=SOPNUMBE from SOP40300 where SOPTYPE=6  END   else  BEGIN   set @Packslnumbr=@SOPNUMBE  END  if (Select MPICKTIC from SOP40100)=2  BEGIN  select @Picknumbr=SOPNUMBE from SOP40300 where SOPTYPE=7  END   else   BEGIN  set @Picknumbr=@SOPNUMBE  END   if (select WORKFLOWENABLED from SOP40200 where DOCID=@DocID  AND SOPTYPE=3)=0  set @SOPStatus=0  else   set @SOPStatus=7  SELECT @ExecString1 = ' SELECT TOP 1 @RTCM = ISNULL(A.RTCLCMTD,0),  @XCHGRATE1 = ISNULL(A.XCHGRATE,0),  @I_sMCTrxState1=ISNULL(A.MCTRXSTT,0),  @I_nDenomExchangeRate1=ISNULL(A.DENXRATE,0)   FROM SOP10100 A INNER       JOIN ' +   @TableName + ' B on  A.SOPNUMBE = B.SOPNUMBE where B.MKTOPROC = 1'   set @Param = N'@RTCM BIT output,@XCHGRATE1 NUMERIC(19,7) output, @I_sMCTrxState1 smallint output, @I_nDenomExchangeRate1 numeric(15,7) output'   EXEC sp_executesql @ExecString1,   @Param,   @RTCM= @RTCLCMTD output,  @XCHGRATE1 = @XCHGRATE output,  @I_sMCTrxState1=@I_sMCTrxState output ,   @I_nDenomExchangeRate1=@I_nDenomExchangeRate output   if exists(select * from tempdb..sysobjects where name = '##sopBulkConfirmTemp' and type = 'U')   drop table ##sopBulkConfirmTemp   select * into ##sopBulkConfirmTemp from SOP10200 where 1 = 2   alter table ##sopBulkConfirmTemp drop column DEX_ROW_ID   alter table ##sopBulkConfirmTemp add DEX_ROW_ID int IDENTITY(16384,16384)   select @CommonString1 = 'ITEMDESC,  NONINVEN,  DROPSHIP,  UOFM,  LOCNCODE,  UNITCOST,  ORUNTCST,  UNITPRCE,   ORUNTPRC,  XTNDPRCE,  OXTNDPRC,  REMPRICE,  OREPRICE,  EXTDCOST,  OREXTCST,  MRKDNAMT,  ORMRKDAM,  MRKDNPCT,  MRKDNTYP,   INVINDX,  CSLSINDX,  SLSINDX,  MKDNINDX,  RTNSINDX,  INUSINDX,  INSRINDX,  DMGDINDX,  ITMTSHID,  IVITMTXB,  BKTSLSAM,   ORBKTSLS,  TAXAMNT,  ORTAXAMT,  TXBTXAMT,  OTAXTAMT,  BSIVCTTL,  TRDISAMT,  ORTDISAM,  DISCSALE,  ORDAVSLS,  QUANTITY,   ATYALLOC,  QTYINSVC,  QTYINUSE,  QTYDMGED,  QTYRTRND,  QTYONHND,  QTYCANCE,  QTYCANOT,  QTYONPO,  QTYORDER,  QTYPRBAC,   QTYPRBOO,  QTYPRINV,  QTYPRORD,  QTYPRVRECVD,  QTYRECVD,  QTYREMAI,  QTYREMBO,  QTYTBAOR,  QTYTOINV,  QTYTORDR,  QTYFULFI,   QTYSLCTD,  QTYBSUOM,  EXTQTYAL,  EXTQTYSEL,'   select @CommonString2 = ',FUFILDAT,  ACTLSHIP,  SHIPMTHD,  SALSTERR,  SLPRSNID,  PRCLEVEL,  COMMNTID,  BRKFLD1,   BRKFLD2,  BRKFLD3,  CURRNIDX,  TRXSORCE,  SOPLNERR,  ORGSEQNM,  ITEMCODE,  PURCHSTAT,  DECPLQTY,  DECPLCUR,  ODECPLCU,  QTYTOSHP,   XFRSHDOC,  EXCEPTIONALDEMAND,  TAXSCHID,  TXSCHSRC,'   select @CommonString3 = ',ShipToName,  CNTCPRSN,  ADDRESS1,  ADDRESS2,  ADDRESS3,  CITY,   STATE,  ZIPCODE,  CCode,  COUNTRY,  PHONE1,  PHONE2,  PHONE3,  FAXNUMBR,  Flags,  BackoutTradeDisc,  OrigBackoutTradeDisc,  GPSFOINTEGRATIONID,   INTEGRATIONSOURCE,  INTEGRATIONID,  CONTNBR,  CONTLNSEQNBR,  CONTSTARTDTE,  CONTENDDTE,  CONTITEMNBR,  CONTSERIALNBR,  BULKPICKPRNT,  INDPICKPRNT,  ISLINEINTRA,   SOFULFILLMENTBIN,  MULTIPLEBINS,  DEX_ROW_TS,  Print_Phone_NumberGB'   select @ExecString = 'insert into ##sopBulkConfirmTemp   (SOPTYPE,  SOPNUMBE,  LNITMSEQ,  CMPNTSEQ,  ITEMNMBR,   ' + @CommonString1 + ' ReqShipDate ' +   @CommonString2 + ' PRSTADCD '   + @CommonString3 + '   )   SELECT  3 AS SOPTYPE,  '''+ @SOPNUMBE +''' AS SOPNUMBE,  B.LNITMSEQ,  B.CMPNTSEQ,  B.ITEMNMBR,   ' + @CommonString1 + ' B.ReqShipDate ' + @CommonString2 + ' B.PRSTADCD ' + @CommonString3 +   ' FROM ' + @TableName +   ' A INNER JOIN SOP10200 B   on A.SOPNUMBE = B.SOPNUMBE   and A.SOPTYPE = B.SOPTYPE   where A.MKTOPROC = 1 ORDER BY A.DEX_ROW_ID'   EXEC(@ExecString)   select @ExecString = 'insert into SOP10200   (   SOPTYPE,  SOPNUMBE,  LNITMSEQ,  CMPNTSEQ,  ITEMNMBR,   ' + @CommonString1 +' ReqShipDate '   + @CommonString2 + ' PRSTADCD ' + @CommonString3 + '   )   select  SOPTYPE,  SOPNUMBE,  DEX_ROW_ID as   LNITMSEQ,  CMPNTSEQ,  ITEMNMBR,   ' + @CommonString1 + ' ReqShipDate ' +   @CommonString2 + ' PRSTADCD ' +   @CommonString3 + ' from ##sopBulkConfirmTemp where 1 = 2'   EXEC ( @ExecString )   select @CommonString1 = 'insert into SOP10105 (   SOPTYPE,  SOPNUMBE,  LNITMSEQ,  TAXDTLID,  ACTINDX,  BKOUTTAX,   TXABLETX,  STAXAMNT,  ORSLSTAX,  FRTTXAMT,  ORFRTTAX,  MSCTXAMT,   ORMSCTAX,  TAXDTSLS,  ORTOTSLS,  TDTTXSLS,  ORTXSLS,  TXDTOTTX,   OTTAXPON,  DELETE1,  CURRNIDX,  TRXSORCE )'   select @CommonString2 = 'A.TAXDTLID,  B.ACTINDX,  MAX(BKOUTTAX)as BKOUTTAX,   MAX(TXABLETX) as TXABLETX,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORSLSTAX)) as STAXAMNT,   sum(ORSLSTAX) as ORSLSTAX,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORFRTTAX)) as FRTTXAMT,   sum(ORFRTTAX) as RFRTTAX,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM (ORMSCTAX))as MSCTXAMT,   sum(ORMSCTAX) as ORMSCTAX,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM  (ORTOTSLS))as TAXDTSLS,   sum(ORTOTSLS) as ORTOTSLS,   dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM (ORTXSLS)) as TDTTXSLS,  sum(ORTXSLS) as ORTXSLS,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +  convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM (OTTAXPON)) as TXDTOTTX,   sum(OTTAXPON) as OTTAXPON,  MAX(DELETE1) as DELETE1,  MAX(CURRNIDX) as CURRNIDX,   MAX(TRXSORCE) as TRXSORCE from SOP10105 A   inner join TX00201 B on A.TAXDTLID = B.TAXDTLID   inner join ' + @TableName + ' C on A.SOPNUMBE = C.SOPNUMBE and A.SOPTYPE = C.SOPTYPE   where C.MKTOPROC = 1 and A.LNITMSEQ = 0 group by A.TAXDTLID, B.ACTINDX'   select @ExecString = @CommonString1 + 'select 3 as SOPTYPE,''' + @SOPNUMBE + ''' as SOPNUMBE,   0 as LNITMSEQ,' + @CommonString2   EXEC ( @ExecString )   if exists(select * from tempdb..sysobjects where name = '##sopBulkConfirmTemp' and type = 'U')   drop table ##sopBulkConfirmTemp   select @ExecString =  ' select ''' + @SOPNUMBE + ''' as SOPNUMBE,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM  (ORDAVFRT)) as DISCFRGT, sum(ORDAVFRT) as ORDAVFRT, sum(ORDAVMSC) as ORDAVMSC,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM (ORDAVAMT)) as DISAVAMT,   min(FUFILDAT) as FUFILDAT,  min(ACTLSHIP) as ACTLSHIP,  max(DISCDATE) as DISCDATE,   min(PRCLEVEL) as PRCLEVEL,  min(LOCNCODE) as LOCNCODE,  ''' + @Packslnumbr + ''' as PCKSLPNO,   ''' + @Picknumbr + ''' as PICTICNU,  1 as TXENGCLD,12 as Flags,  '+convert(varchar(1),@SOPStatus)+ ' as SOPSTATUS,   dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   sum(ORDAVMSC)) as DISCMISC,  min(CURNCYID) as CURNCYID,  min(CURRNIDX) as CURRNIDX,   min(RATETPID) as RATETPID,   min(XCHGRATE) as XCHGRATE,   min(DENXRATE) as DENXRATE,   0 as EXCHDATE,sum(ORDAVAMT) as ORDAVAMT,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORDISRTD)) as DISCRTND,  sum(ORDISRTD) as ORDISRTD,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORDISTKN)) as DISTKNAM,   sum(ORDISTKN) as ORDISTKN,   dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORDDLRAT)) as DSCDLRAM,  sum(ORDDLRAT) as ORDDLRAT,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORDATKN)) as DISAVTKN,  sum(ORDATKN) as ORDATKN,  min(EXGTBLID) as EXGTBLID,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(OCOMMAMT)) as COMMAMNT,   dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORMRKDAM)) as MRKDNAMT,  sum(ORMRKDAM) as ORMRKDAM,  min(COMAPPTO) as COMAPPTO,  sum(OCOMMAMT) as OCOMMAMT,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',  SUM(ORCOSAMT)) as CMMSLAMT,   sum(ORCOSAMT) as ORCOSAMT,   dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',  SUM (ORNCMAMT)) as NCOMAMNT,   sum(ORNCMAMT) as ORNCMAMT,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',  SUM(ORTDISAM)) as TRDISAMT,  sum(ORTDISAM) as ORTDISAM,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',  SUM(ORSUBTOT)) as SUBTOTAL,  sum(ORSUBTOT) as ORSUBTOT,   dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(OREMSUBT)) as REMSUBTO,   sum(OREMSUBT) as OREMSUBT,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(OREXTCST)) as EXTDCOST,  sum(OREXTCST) as OREXTCST,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORFRTAMT)) as FRTAMNT,   sum(ORFRTAMT) as ORFRTAMT,   dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORMISCAMT)) as MISCAMNT,   sum(ORMISCAMT) as ORMISCAMT,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORFRTTAX)) as FRTTXAMT,  sum(ORFRTTAX) as ORFRTTAX,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORMSCTAX)) as MSCTXAMT,  sum(ORMSCTAX) as ORMSCTAX,   dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORBKTFRT)) as BKTFRTAM,  sum(ORBKTFRT) as ORBKTFRT,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORBKTMSC)) as BKTMSCAM,  sum(ORBKTMSC) as ORBKTMSC,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(OBTAXAMT)) as BCKTXAMT,  sum(OBTAXAMT) as OBTAXAMT,   dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(OTAXTAMT)) as TXBTXAMT,  sum(OTAXTAMT) as OTAXTAMT,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORTAXAMT)) as TAXAMNT,  sum(ORTAXAMT) as ORTAXAMT,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORDOCAMT)) as DOCAMNT,  sum(ORDOCAMT) as ORDOCAMT,   dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORPMTRVD)) as PYMTRCVD,  sum(ORPMTRVD) as ORPMTRVD,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORDEPRVD)) as DEPRECVD,  sum(ORDEPRVD) as ORDEPRVD,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORCODAMT)) as CODAMNT,  sum(ORCODAMT) as ORCODAMT,   dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   SUM(ORACTAMT)) as ACCTAMNT,  sum(ORACTAMT) as ORACTAMT,  sum(NOTEINDX) as NOTEINDX,   sum(WITHHAMT) as WITHHAMT ,   sum(BackoutTradeDisc) as BackoutTradeDisc,  sum(OrigBackoutTradeDisc) as OrigBackoutTradeDisc   into ##sopBulkConfirmTemp from SOP10100 A   inner join ' + @TableName + ' B   on A.SOPNUMBE = B.SOPNUMBE   and A.SOPTYPE = B.SOPTYPE   where B.MKTOPROC = 1'  EXEC ( @ExecString )   if (Select MPACKSLP from SOP40100)=2   Begin   EXEC ivNumber_Inc_Dec 1, @Packslnumbr out  Update SOP40300 set SOPNUMBE =@Packslnumbr where SOPTYPE=6   End  if (Select MPICKTIC from SOP40100)=2   Begin   EXEC ivNumber_Inc_Dec 1, @Picknumbr  out   Update SOP40300 set SOPNUMBE =@Picknumbr where SOPTYPE=7   End  select @ExecString = 'update SOP10100 SET   DISCFRGT = A.DISCFRGT,  ORDAVFRT = A.ORDAVFRT,  ORDAVMSC = A.ORDAVMSC,   DISCMISC = A.DISCMISC,  CURNCYID = A.CURNCYID,  CURRNIDX = A.CURRNIDX,   RATETPID = A.RATETPID,  XCHGRATE = A.XCHGRATE,  DENXRATE = A.DENXRATE,  EXCHDATE = A.EXCHDATE,  EXGTBLID = A.EXGTBLID,   FUFILDAT = A.FUFILDAT,  ACTLSHIP = A.ACTLSHIP,  DISCDATE = A.DISCDATE,   PRCLEVEL = A.PRCLEVEL,  LOCNCODE = A.LOCNCODE,  PCKSLPNO = A.PCKSLPNO,   PICTICNU = A.PICTICNU,  TXENGCLD = A.TXENGCLD,  Flags = A.Flags,  SOPSTATUS = A.SOPSTATUS,   DISAVAMT = A.DISAVAMT,  ORDAVAMT = A.ORDAVAMT,  DISCRTND = A.DISCRTND,  ORDISRTD = A.ORDISRTD,   DISTKNAM = A.DISTKNAM,  ORDISTKN = A.ORDISTKN,  DSCDLRAM = A.DSCDLRAM,  ORDDLRAT = A.ORDDLRAT,   DISAVTKN = A.DISAVTKN,  ORDATKN = A.ORDATKN,  MRKDNAMT = A.MRKDNAMT,  ORMRKDAM = A.ORMRKDAM,  COMAPPTO = A.COMAPPTO,   COMMAMNT = A.COMMAMNT,  OCOMMAMT = A.OCOMMAMT,  CMMSLAMT = A.CMMSLAMT,  ORCOSAMT = A.ORCOSAMT,   NCOMAMNT = A.NCOMAMNT,  ORNCMAMT = A.ORNCMAMT,  TRDISAMT = A.TRDISAMT,  ORTDISAM = A.ORTDISAM,   SUBTOTAL = A.SUBTOTAL,  ORSUBTOT = A.ORSUBTOT,  REMSUBTO = A.REMSUBTO,  OREMSUBT = A.OREMSUBT,   EXTDCOST = A.EXTDCOST,  OREXTCST = A.OREXTCST,  FRTAMNT = A.FRTAMNT,  ORFRTAMT = A.ORFRTAMT,   MISCAMNT = A.MISCAMNT,  ORMISCAMT = A.ORMISCAMT,  FRTTXAMT = A.FRTTXAMT,  ORFRTTAX = A.ORFRTTAX,   MSCTXAMT = A.MSCTXAMT,  ORMSCTAX = A.ORMSCTAX,  BKTFRTAM = A.BKTFRTAM,  ORBKTFRT = A.ORBKTFRT,   BKTMSCAM = A.BKTMSCAM,  ORBKTMSC = A.ORBKTMSC,  BCKTXAMT = A.BCKTXAMT,  OBTAXAMT = A.OBTAXAMT,   TXBTXAMT = A.TXBTXAMT,  OTAXTAMT = A.OTAXTAMT,  TAXAMNT = A.TAXAMNT,  ORTAXAMT = A.ORTAXAMT,   DOCAMNT = A.DOCAMNT,  ORDOCAMT = A.ORDOCAMT,  PYMTRCVD = A.PYMTRCVD,  ORPMTRVD = A.ORPMTRVD,   DEPRECVD = A.DEPRECVD,  ORDEPRVD = A.ORDEPRVD,  CODAMNT = A.CODAMNT,  ORCODAMT = A.ORCODAMT,   ACCTAMNT = A.ACCTAMNT,  ORACTAMT = A.ORACTAMT,  WITHHAMT = A.WITHHAMT,  BackoutTradeDisc = A.BackoutTradeDisc,   OrigBackoutTradeDisc = A.OrigBackoutTradeDisc ,  RTCLCMTD = '+ convert(varchar(2), @RTCLCMTD) + ' from ##sopBulkConfirmTemp A  where SOP10100.SOPNUMBE = ''' + @SOPNUMBE + ''''   EXEC (@ExecString)   if exists(select * from tempdb..sysobjects where name = '##sopBulkConfirm' and type = 'U')   drop table ##sopBulkConfirm   select * into ##sopBulkConfirm from SOP10101 where 1 = 2   alter table ##sopBulkConfirm drop column DEX_ROW_ID   alter table ##sopBulkConfirm add DEX_ROW_ID int IDENTITY(16384,16384)   select @ExecString = 'insert into ##sopBulkConfirm   select 3 as SOPTYPE,  ''' + @SOPNUMBE + ''' as SOPNUMBE,   16384 as SEQNUMBR,   SLPRSNID,SALSTERR,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   (sum (OCOMMAMT)) * 100.00 * 100.00) /   dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert  (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +                         convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   sum(ORCOSAMT)) as COMPRCNT,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+ ',' +   convert(varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',  sum(OCOMMAMT)) as COMMAMNT,  sum(OCOMMAMT) as OCOMMAMT,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+ ',' +   convert(varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',  sum(ORNCMAMT)) as NCOMAMNT,   sum(ORNCMAMT) as ORNCMAMT,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+ ',' +   convert(varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',  (sum(OCOMMAMT))/  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+ ',' +  convert(varchar(20), @XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +  convert(varchar(10),@FunDecPlace) + ',  sum(ORSLSAMT))) * 100.00 * 100.00 as PRCTOSAL,   dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   sum(ORSLSAMT)) as ACTSLAMT,  sum(ORSLSAMT) as ORSLSAMT,  dbo.mcFuncCalculateAmount('+convert(varchar(20),@RTCLCMTD)+ ',' +   convert (varchar(2),@I_sViewMode)+',' +   convert (varchar(20),@XCHGRATE) + ',' +   convert(varchar(20),@I_nDenomExchangeRate) + ',' +   convert (varchar(10),@I_sMCTrxState) + ',' +   convert(varchar(10),@FunDecPlace) + ',   sum(ORCOSAMT)) as CMMSLAMT,   sum(ORCOSAMT) as ORCOSAMT,   min(CURRNIDX) as CURRNIDX,   '''' as TRXSORCE   from SOP10101 A   inner join ' + @TableName + ' B   on A.SOPNUMBE = B.SOPNUMBE   and A.SOPTYPE = B.SOPTYPE   where B.MKTOPROC = 1   group by   SLPRSNID,  SALSTERR'   EXEC( @ExecString )   select @ExecString = 'insert into SOP10101   (SOPTYPE,  SOPNUMBE,  SEQNUMBR,  SLPRSNID,  SALSTERR,  COMPRCNT,  COMMAMNT,  OCOMMAMT,   NCOMAMNT,  ORNCMAMT,  PRCTOSAL,  ACTSLAMT,  ORSLSAMT,  CMMSLAMT,  ORCOSAMT,  CURRNIDX,   TRXSORCE)   select SOPTYPE,  SOPNUMBE,  DEX_ROW_ID as SEQNUMBR,  SLPRSNID,SALSTERR,  COMPRCNT,   COMMAMNT,  OCOMMAMT,  NCOMAMNT,  ORNCMAMT,  PRCTOSAL,  ACTSLAMT,  ORSLSAMT,CMMSLAMT,   ORCOSAMT,  CURRNIDX,  TRXSORCE from ##sopBulkConfirm'   EXEC( @ExecString )   select @ExecString = 'update SOP10100   set PYMTRMID = (select top 1 PYMTRMID from ' + @TableName + ' A   join SOP10100 B   on  A.SOPNUMBE = B.SOPNUMBE   AND A.SOPTYPE = B.SOPTYPE   where MKTOPROC = 1 )   where SOPNUMBE = ''' + @SOPNUMBE + '''   and SOPTYPE = 3'   EXEC( @ExecString )   if @EC=1  update SOP10100 set ECTRX=1 where SOPNUMBE =@SOPNUMBE and SOPTYPE=3    
GO
GRANT EXECUTE ON  [dbo].[SOP_CI_Combine_Orders_To_Invoice] TO [DYNGRP]
GO
