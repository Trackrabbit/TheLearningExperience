SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aagGetPeriodAccountsString] (  @aaBudgetID INTEGER  , @aaCodeSequence INTEGER  , @aaTrxString VARCHAR(250)  ) AS BEGIN SET NOCOUNT ON DECLARE @nCount INTEGER, @aaFiscalPeriod INTEGER, @PERIODDT datetime DECLARE @Balance NUMERIC(19,5), @Quantity NUMERIC(19,5)  DECLARE @PeriodTotalAmount NUMERIC(19,5) DECLARE @PeriodTotalAuantity NUMERIC(19,5) DECLARE @ACTINDX INTEGER, @ACTNUMST VARCHAR(51) DECLARE @ACTDESCR VARCHAR(51) , @nCountAcc INTEGER DECLARE @ACCTTYPE INTEGER DECLARE @aaRetString VARCHAR(6000) DECLARE @TempTable VARCHAR(50) SELECT @TempTable  = '##TEMP_TEMP'  + REPLACE(system_user,'''','') + db_name()  SELECT  @aaRetString = '' declare Accounts Cursor fast_forward for  SELECT DISTINCT A.ACTINDX, B.ACTNUMST, REPLACE(C.ACTDESCR,'''','''''')  FROM AAG00905 A  INNER JOIN GL00105 B  ON A.ACTINDX = B.ACTINDX  INNER JOIN GL00100 C ON A.ACTINDX = C.ACTINDX WHERE aaBudgetID = @aaBudgetID and A.aaCodeSequence = @aaCodeSequence open Accounts  fetch next from Accounts into @ACTINDX, @ACTNUMST, @ACTDESCR WHILE @@fetch_status = 0 BEGIN  SET @aaRetString = '' SELECT @ACCTTYPE = ACCTTYPE FROM GL00100 WHERE ACTINDX = @ACTINDX declare AmountQty cursor fast_forward for SELECT aaFiscalPeriod, PERIODDT, Balance = CASE @ACCTTYPE WHEN 1  THEN Balance WHEN 2 THEN  0 END, QUANTITY = CASE @ACCTTYPE WHEN 1  THEN 0 WHEN  2 THEN Balance END FROM AAG00905  WHERE aaCodeSequence = @aaCodeSequence AND  aaBudgetID = @aaBudgetID AND aaActualPriliminary = 0  AND ACTINDX = @ACTINDX open AmountQty fetch next from AmountQty into @aaFiscalPeriod, @PERIODDT, @Balance, @Quantity WHILE @@fetch_status = 0 BEGIN SET @aaRetString = LTRIM( RTRIM( @aaRetString ) )  + ',''' + LTRIM(RTRIM(CONVERT( VARCHAR, @Balance ) ) )  + ''',''' + LTRIM(RTRIM(CONVERT( VARCHAR, @Quantity ) ) )  + '''' fetch next from AmountQty into @aaFiscalPeriod, @PERIODDT, @Balance, @Quantity END close AmountQty deallocate AmountQty SELECT @Balance = SUM( Balance ), @Quantity = SUM( Balance )  FROM AAG00905 WHERE aaBudgetID = @aaBudgetID AND  aaActualPriliminary = 0 AND aaCodeSequence = @aaCodeSequence AND  ACTINDX = @ACTINDX IF @ACCTTYPE = 1  SET @Quantity = 0.00 ELSE SET @Balance = 0.00 SET @aaRetString = LTRIM(RTRIM(@aaTrxString)) + ','''  + LTRIM(RTRIM(@ACTNUMST)) + ''',''' + LTRIM(RTRIM(@ACTDESCR))  + '''' + LTRIM( RTRIM( @aaRetString ) ) + ','''  + LTRIM(RTRIM(CONVERT( VARCHAR, @Balance ) ) ) + ''','''  + LTRIM(RTRIM(CONVERT( varchar, @Quantity ) ) ) + '''' SET @aaRetString = 'INSERT INTO [' + @TempTable + ']' + @aaRetString EXEC (@aaRetString) fetch next from Accounts into @ACTINDX, @ACTNUMST, @ACTDESCR END close Accounts deallocate Accounts RETURN 1 SET NOCOUNT OFF END     
GO
GRANT EXECUTE ON  [dbo].[aagGetPeriodAccountsString] TO [DYNGRP]
GO
