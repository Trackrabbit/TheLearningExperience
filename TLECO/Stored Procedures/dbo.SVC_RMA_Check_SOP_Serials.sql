SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[SVC_RMA_Check_SOP_Serials]  (    @History tinyint,  @RETDOCID char(15),  @Line as numeric(19,5),  @RETORIG smallint,  @RETREF char(31),  @LNITMSEQ int,  @CMPNTSEQ int,  @Qty numeric(19,5),  @Is_Dupe smallint output,  @serial char(21) output ) as declare @item char(31)  select @Is_Dupe = 0, @serial = '' IF exists(select * from sysobjects where name = 'SVC05250')  BEGIN  if @RETORIG = 2   begin  if (select count(*) from SVC05251 where SRVRECTYPE= 3 and CALLNBR =@RETREF  and EQPLINE =1 and LINITMTYP = 'P' and LNITMSEQ = @LNITMSEQ) = @Qty   declare SerialLot cursor for select ITEMNMBR, SERLTNUM from SVC05251 where  SRVRECTYPE= 3 and CALLNBR =@RETREF and EQPLINE =1 and LINITMTYP = 'P' and LNITMSEQ = @LNITMSEQ  else  begin  if @History = 0  declare SerialLot cursor for select ITEMNMBR, SERLTNUM from SVC00250 where  SRVRECTYPE= 3 and CALLNBR =@RETREF and EQPLINE =1 and LINITMTYP = 'P' and LNITMSEQ = @LNITMSEQ  else  declare SerialLot cursor for select ITEMNMBR, SERLTNUM from SVC30250 where  SRVRECTYPE= 3 and CALLNBR =@RETREF and EQPLINE =1 and LINITMTYP = 'P' and LNITMSEQ = @LNITMSEQ  end   open SerialLot  fetch next from SerialLot into @item, @serial   while @@FETCH_STATUS = 0  BEGIN  exec SVC_Check_Serial_On_Open_RMA @item, @serial, @RETDOCID, @Line, @Is_Dupe output  if @Is_Dupe > 0 begin deallocate SerialLot return end  fetch next from SerialLot into @item, @serial   END  deallocate SerialLot  end   else if @RETORIG = 3   begin  if (select count(*) from SVC05250 where SOPTYPE = 3 and SOPNUMBE =@RETREF and LNITMSEQ = @LNITMSEQ) = @Qty   declare SerialLot cursor for select ITEMNMBR, SERLTNUM from SVC05250 where  SOPTYPE = 3 and SOPNUMBE =@RETREF and LNITMSEQ = @LNITMSEQ  else  declare SerialLot cursor for select ITEMNMBR, SERLTNUM from SOP10201 where  SOPTYPE = 3 and SOPNUMBE =@RETREF and LNITMSEQ = @LNITMSEQ and CMPNTSEQ = @CMPNTSEQ   open SerialLot  fetch next from SerialLot into  @item, @serial   while @@FETCH_STATUS = 0  BEGIN  exec SVC_Check_Serial_On_Open_RMA @item, @serial, @RETDOCID, @Line, @Is_Dupe output  if @Is_Dupe > 0 begin deallocate SerialLot return end  fetch next from SerialLot into  @item, @serial   END  deallocate SerialLot  end END  return    
GO
GRANT EXECUTE ON  [dbo].[SVC_RMA_Check_SOP_Serials] TO [DYNGRP]
GO
