SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aagUpdateLandCostINFOtoRecevingsTrx]  @aaSubLedgerHdrID INT,  @TRXSORCE CHAR(13),  @aaDistID INT OUTPUT AS  BEGIN   DECLARE @DOCNUMBR CHAR(21),  @SERIES SMALLINT,  @aaSubLedgerDistID INT,  @aaSubLedgerAssignID INT,  @LCaaSubLedgerHdrID INT,  @LCaaSubLedgerDistID INT,  @ACTINDX INT,  @SEQNUMBR INT,  @aaAssignedPercent INT,  @AssignPercent INT,  @GLPOSTDT DATETIME,  @RATETPID CHAR(15),  @EXGTBLID CHAR(15),  @DECPLCUR SMALLINT,  @VENDORID CHAR(15),  @CURNCYID CHAR(15),  @DECPLACS INT,  @CURRNIDX SMALLINT,  @DEBITAMT NUMERIC(19,7),  @ORDBTAMT NUMERIC(19,7),  @CRDTAMNT NUMERIC(19,7),  @ORCRDAMT NUMERIC(19,7),  @XCHGRATE NUMERIC(19,7),  @EXCHDATE DATETIME,  @TIME1 DATETIME,  @RATECALC SMALLINT,  @DENXRATE NUMERIC(19,7),  @MCTRXSTT SMALLINT,  @DISTTYPE SMALLINT,  @aaSubLedgerAssignID1 INT,  @TOTDISTAMT NUMERIC(19,7),  @TOTORGDISTAMT NUMERIC(19,7)   SELECT @LCaaSubLedgerDistID = 0, @AssignPercent = 0    SELECT @DOCNUMBR = DOCNUMBR, @SERIES = SERIES FROM AAG20000 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID   IF @DOCNUMBR IS NULL OR @DOCNUMBR = ''  RETURN   SELECT @aaSubLedgerDistID = MAX(ISNULL(aaSubLedgerDistID,0)) + 1, @aaDistID = MAX(ISNULL(aaSubLedgerDistID,0)) FROM AAG20001 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID  SELECT TOP 1 @CURNCYID = CURNCYID, @DECPLACS = DECPLACS, @GLPOSTDT = GLPOSTDT FROM AAG20001 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID   SELECT @LCaaSubLedgerHdrID = ISNULL(aaSubLedgerHdrID,0) FROM AAG20000 WHERE DOCNUMBR = @DOCNUMBR AND SERIES = @SERIES AND DOCTYPE = 20  IF @LCaaSubLedgerHdrID IS NULL OR @LCaaSubLedgerHdrID = 0  RETURN   DECLARE Cursor1 CURSOR LOCAL FAST_FORWARD FOR  SELECT ACTINDX, DISTTYPE, DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, ISNULL(CURNCYID,''), CURRNIDX, SEQNUMBR,  ISNULL(RATETPID,''), ISNULL(EXGTBLID,''), XCHGRATE, EXCHDATE, TIME1, RATECALC, DENXRATE, MCTRXSTT, VENDORID  FROM POP30390 WHERE POPRCTNM = @DOCNUMBR and TRXSORCE = @TRXSORCE AND DISTTYPE IN (201, 209, 210) AND CURNCYID = @CURNCYID ORDER BY SEQNUMBR  OPEN Cursor1  FETCH NEXT FROM Cursor1 INTO @ACTINDX, @DISTTYPE, @DEBITAMT, @CRDTAMNT, @ORDBTAMT, @ORCRDAMT, @CURNCYID, @CURRNIDX, @SEQNUMBR,  @RATETPID, @EXGTBLID, @XCHGRATE, @EXCHDATE, @TIME1, @RATECALC, @DENXRATE, @MCTRXSTT, @VENDORID  WHILE @@FETCH_STATUS = 0  BEGIN  IF @DISTTYPE = 209   BEGIN  SELECT TOP 1 @LCaaSubLedgerDistID = aaSubLedgerDistID FROM AAG20001 WHERE aaSubLedgerHdrID = @LCaaSubLedgerHdrID AND   ACTINDX = @ACTINDX AND CURNCYID = @CURNCYID AND CURRNIDX = @CURRNIDX AND POSTED = 0   INSERT INTO AAG20001   (aaSubLedgerHdrID, aaSubLedgerDistID, INTERID, ACTINDX, DISTTYPE, aaBrowseType,   DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, CURNCYID, CURRNIDX, SEQNUMBR,  GLPOSTDT, aaCustID, RATETPID, EXGTBLID, XCHGRATE, EXCHDATE, TIME1,  RTCLCMTD, DENXRATE, MCTRXSTT,aaChangeDate,aaChangeTime,ACCTTYPE,aaCopyStatus,aaWinWasOpen,DECPLACS,aaVendID)  SELECT @aaSubLedgerHdrID, @aaSubLedgerDistID, INTERID, @ACTINDX, @DISTTYPE, 1,   @DEBITAMT, @CRDTAMNT, @ORDBTAMT, @ORCRDAMT, CURNCYID, CURRNIDX, @SEQNUMBR,  GLPOSTDT, aaCustID, RATETPID, EXGTBLID, XCHGRATE, EXCHDATE, TIME1,  RTCLCMTD, DENXRATE, MCTRXSTT,aaChangeDate,aaChangeTime,ACCTTYPE, 8, 1, @DECPLACS,@VENDORID FROM AAG20001   WHERE aaSubLedgerHdrID = @LCaaSubLedgerHdrID AND aaSubLedgerDistID = @LCaaSubLedgerDistID   SELECT @TOTDISTAMT = @DEBITAMT + @CRDTAMNT, @TOTORGDISTAMT = @ORDBTAMT + @ORCRDAMT   DECLARE Dist CURSOR LOCAL FOR   SELECT aaSubLedgerDistID FROM AAG20001 WHERE aaSubLedgerHdrID = @LCaaSubLedgerHdrID AND   ACTINDX = @ACTINDX AND CURNCYID = @CURNCYID AND CURRNIDX = @CURRNIDX AND POSTED = 0  OPEN Dist  FETCH NEXT FROM Dist INTO @LCaaSubLedgerDistID  WHILE @@FETCH_STATUS = 0  BEGIN  DECLARE Assign CURSOR LOCAL FOR  SELECT aaSubLedgerAssignID,[DEBITAMT], [CRDTAMNT], [ORDBTAMT], [ORCRDAMT] FROM AAG20002   WHERE aaSubLedgerHdrID = @LCaaSubLedgerHdrID AND aaSubLedgerDistID = @LCaaSubLedgerDistID  OPEN Assign  FETCH NEXT FROM Assign INTO @aaSubLedgerAssignID,@DEBITAMT, @CRDTAMNT, @ORDBTAMT, @ORCRDAMT  WHILE @@FETCH_STATUS = 0  BEGIN  INSERT INTO AAG20002 ([aaSubLedgerHdrID], [aaSubLedgerDistID], [aaSubLedgerAssignID], [DEBITAMT], [CRDTAMNT], [ORDBTAMT], [ORCRDAMT], [aaAssignedPercent], [DistRef], [NOTEINDX], [aaAssignErrors], [aaAliasID])  SELECT @aaSubLedgerHdrID, @aaSubLedgerDistID, -@aaSubLedgerAssignID, @DEBITAMT, @CRDTAMNT, @ORDBTAMT, @ORCRDAMT, [aaAssignedPercent], [DistRef], [NOTEINDX], [aaAssignErrors], [aaAliasID]  FROM AAG20002 WHERE aaSubLedgerHdrID = @LCaaSubLedgerHdrID AND aaSubLedgerDistID = @LCaaSubLedgerDistID AND  aaSubLedgerAssignID = @aaSubLedgerAssignID   INSERT INTO AAG20003   (aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID,aaTrxDimID,aaTrxCodeID,aaCodeErrors)  SELECT @aaSubLedgerHdrID, @aaSubLedgerDistID,-@aaSubLedgerAssignID,aaTrxDimID,aaTrxCodeID,aaCodeErrors FROM AAG20003   WHERE aaSubLedgerHdrID = @LCaaSubLedgerHdrID AND aaSubLedgerDistID = @LCaaSubLedgerDistID AND  aaSubLedgerAssignID = @aaSubLedgerAssignID   FETCH NEXT FROM Assign INTO @aaSubLedgerAssignID,@DEBITAMT, @CRDTAMNT, @ORDBTAMT, @ORCRDAMT  END  CLOSE Assign  DEALLOCATE Assign   DECLARE Cursor3 CURSOR LOCAL FAST_FORWARD FOR  SELECT DISTINCT aaSubLedgerAssignID FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID AND aaSubLedgerAssignID < 0 ORDER BY aaSubLedgerAssignID DESC  OPEN Cursor3  FETCH NEXT FROM Cursor3 INTO @aaSubLedgerAssignID  WHILE @@FETCH_STATUS = 0  BEGIN  SELECT @aaSubLedgerAssignID1 = ISNULL(MAX(aaSubLedgerAssignID),0)+1 FROM AAG20002 WHERE aaSubLedgerHdrID=@aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID AND aaSubLedgerAssignID > 0  UPDATE AAG20002 SET aaSubLedgerAssignID = @aaSubLedgerAssignID1 WHERE aaSubLedgerHdrID=@aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID AND aaSubLedgerAssignID = @aaSubLedgerAssignID  UPDATE AAG20003 SET aaSubLedgerAssignID = @aaSubLedgerAssignID1 WHERE aaSubLedgerHdrID=@aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID AND aaSubLedgerAssignID = @aaSubLedgerAssignID   FETCH NEXT FROM Cursor3 INTO @aaSubLedgerAssignID  END  CLOSE Cursor3  DEALLOCATE Cursor3   FETCH NEXT FROM Dist INTO @LCaaSubLedgerDistID  END  CLOSE Dist  DEALLOCATE Dist   UPDATE AAG20002 SET aaAssignedPercent = CASE (ORCRDAMT+ORDBTAMT)   WHEN 0 THEN ROUND(((CRDTAMNT+DEBITAMT)* 10000)/(@TOTDISTAMT),2)  ELSE ROUND(((ORCRDAMT+ORDBTAMT)* 10000)/(@TOTORGDISTAMT),2)   END  WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID  SET @AssignPercent = (SELECT SUM(aaAssignedPercent) FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID)  IF @AssignPercent <> 0 AND @AssignPercent > 9900 and @AssignPercent <> 10000  UPDATE AAG20002 SET aaAssignedPercent = aaAssignedPercent + (10000 - @AssignPercent),  CRDTAMNT= CRDTAMNT+(SELECT a1.CRDTAMNT - SUM(a2.CRDTAMNT) FROM AAG20002 a2 Inner JOIN AAG20001 a1 ON a2.aaSubLedgerHdrID = a1.aaSubLedgerHdrID AND a2.aaSubLedgerDistID = a1.aaSubLedgerDistID AND a2.aaSubLedgerHdrID = @aaSubLedgerHdrID AND a2.aaSubLedgerDistID=@aaSubLedgerDistID GROUP BY a1.CRDTAMNT),  ORCRDAMT= ORCRDAMT+(SELECT a1.ORCRDAMT - SUM(a2.ORCRDAMT) FROM AAG20002 a2 Inner JOIN AAG20001 a1 ON a2.aaSubLedgerHdrID = a1.aaSubLedgerHdrID AND a2.aaSubLedgerDistID = a1.aaSubLedgerDistID AND a2.aaSubLedgerHdrID = @aaSubLedgerHdrID AND a2.aaSubLedgerDistID=@aaSubLedgerDistID GROUP BY a1.ORCRDAMT)  FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND   aaSubLedgerDistID = @aaSubLedgerDistID AND aaSubLedgerAssignID = @aaSubLedgerAssignID1    UPDATE AAG20001 SET POSTED = 1 WHERE aaSubLedgerHdrID = @LCaaSubLedgerHdrID AND aaSubLedgerDistID = @LCaaSubLedgerDistID  END  ELSE  BEGIN  IF @DISTTYPE = 201  SELECT @LCaaSubLedgerDistID = aaSubLedgerDistID FROM AAG20001 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND DISTTYPE = 1 AND ACTINDX = @ACTINDX  ELSE  SELECT @LCaaSubLedgerDistID = aaSubLedgerDistID FROM AAG20001 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND DISTTYPE = 10 AND ACTINDX = @ACTINDX   INSERT INTO AAG20001   (aaSubLedgerHdrID, aaSubLedgerDistID, INTERID, ACTINDX, DISTTYPE, aaBrowseType,   DEBITAMT, CRDTAMNT, ORDBTAMT, ORCRDAMT, CURNCYID, CURRNIDX, SEQNUMBR,  GLPOSTDT, aaCustID, POSTED ,RATETPID, EXGTBLID, XCHGRATE, EXCHDATE, TIME1,  RTCLCMTD, DENXRATE, MCTRXSTT,aaChangeDate,aaChangeTime,ACCTTYPE,aaCopyStatus,aaWinWasOpen,DECPLACS,aaVendID)  SELECT @aaSubLedgerHdrID, @aaSubLedgerDistID, INTERID, @ACTINDX, @DISTTYPE, 1,   @DEBITAMT, @CRDTAMNT, @ORDBTAMT, @ORCRDAMT, CURNCYID, CURRNIDX, @SEQNUMBR,  GLPOSTDT, aaCustID, POSTED ,RATETPID, EXGTBLID, XCHGRATE, EXCHDATE, TIME1,  RTCLCMTD, DENXRATE, MCTRXSTT,aaChangeDate,aaChangeTime,ACCTTYPE, 8, 1, @DECPLACS,@VENDORID FROM AAG20001   WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @LCaaSubLedgerDistID   DECLARE Assign CURSOR LOCAL FOR   SELECT aaSubLedgerAssignID,aaAssignedPercent FROM AAG20002   WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @LCaaSubLedgerDistID  OPEN Assign  FETCH NEXT FROM Assign INTO @aaSubLedgerAssignID,@aaAssignedPercent  WHILE @@FETCH_STATUS = 0   BEGIN   INSERT INTO AAG20002 ([aaSubLedgerHdrID], [aaSubLedgerDistID], [aaSubLedgerAssignID], [DEBITAMT], [CRDTAMNT], [ORDBTAMT], [ORCRDAMT], [aaAssignedPercent], [DistRef], [NOTEINDX], [aaAssignErrors], [aaAliasID])  SELECT @aaSubLedgerHdrID, @aaSubLedgerDistID, @aaSubLedgerAssignID, CASE @DEBITAMT when 0 then 0 else (@DEBITAMT * @aaAssignedPercent)/10000 END, CASE @CRDTAMNT when 0 then 0 else (@CRDTAMNT * @aaAssignedPercent)/10000 END , CASE @DEBITAMT when 0 then 0 else (@ORDBTAMT * @aaAssignedPercent)/10000 END,  CASE @ORCRDAMT when 0 then 0 else (@ORCRDAMT * @aaAssignedPercent)/10000 END, [aaAssignedPercent], [DistRef], [NOTEINDX], [aaAssignErrors], [aaAliasID]  FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @LCaaSubLedgerDistID AND  aaSubLedgerAssignID = @aaSubLedgerAssignID   INSERT INTO AAG20003   (aaSubLedgerHdrID,aaSubLedgerDistID,aaSubLedgerAssignID,aaTrxDimID,aaTrxCodeID,aaCodeErrors)  SELECT @aaSubLedgerHdrID, @aaSubLedgerDistID,@aaSubLedgerAssignID,aaTrxDimID,aaTrxCodeID,aaCodeErrors FROM AAG20003   WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @LCaaSubLedgerDistID AND  aaSubLedgerAssignID = @aaSubLedgerAssignID   FETCH NEXT FROM Assign INTO @aaSubLedgerAssignID,@aaAssignedPercent  END  CLOSE Assign  DEALLOCATE Assign  SET @AssignPercent = (SELECT SUM(aaAssignedPercent) FROM AAG20002 WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID)  IF @AssignPercent = 10000 AND @DISTTYPE = 201  UPDATE AAG20002 SET   DEBITAMT= DEBITAMT+(SELECT a1.DEBITAMT - SUM(a2.DEBITAMT) FROM AAG20002 a2 INNER JOIN AAG20001 a1 ON a2.aaSubLedgerHdrID = a1.aaSubLedgerHdrID AND a2.aaSubLedgerDistID = a1.aaSubLedgerDistID AND a2.aaSubLedgerHdrID = @aaSubLedgerHdrID AND a2.aaSubLedgerDistID=@aaSubLedgerDistID GROUP BY a1.DEBITAMT),  ORDBTAMT= ORDBTAMT+(SELECT a1.ORDBTAMT - SUM(a2.ORDBTAMT) FROM AAG20002 a2 INNER JOIN AAG20001 a1 ON a2.aaSubLedgerHdrID = a1.aaSubLedgerHdrID AND a2.aaSubLedgerDistID = a1.aaSubLedgerDistID AND a2.aaSubLedgerHdrID = @aaSubLedgerHdrID AND a2.aaSubLedgerDistID=@aaSubLedgerDistID GROUP BY a1.ORDBTAMT)  FROM AAG20002   WHERE aaSubLedgerHdrID = @aaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID AND aaSubLedgerAssignID = @aaSubLedgerAssignID   END   SELECT @aaSubLedgerDistID = @aaSubLedgerDistID + 1  FETCH NEXT FROM Cursor1 INTO @ACTINDX, @DISTTYPE, @DEBITAMT, @CRDTAMNT, @ORDBTAMT, @ORCRDAMT, @CURNCYID, @CURRNIDX, @SEQNUMBR,  @RATETPID, @EXGTBLID, @XCHGRATE, @EXCHDATE, @TIME1, @RATECALC, @DENXRATE, @MCTRXSTT, @VENDORID  END  CLOSE Cursor1  DEALLOCATE Cursor1  UPDATE AAG20001 SET POSTED = 1 WHERE aaSubLedgerHdrID = @LCaaSubLedgerHdrID END   
GO
GRANT EXECUTE ON  [dbo].[aagUpdateLandCostINFOtoRecevingsTrx] TO [DYNGRP]
GO
