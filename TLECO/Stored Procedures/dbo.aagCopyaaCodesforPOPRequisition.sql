SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[aagCopyaaCodesforPOPRequisition]  @DocNumberTo CHAR(17),  @DocNumberFrom CHAR(17),  @l_ErrorCode SMALLINT = NULL OUTPUT AS  BEGIN  DECLARE   @OldaaSubLedgerHdrID INT,  @NewaaSubLedgerHdrID INT,  @aaSubLedgerDistID INT,   @OldaaSubLedgerDistID INT,  @OldACTINDX INT,  @NewACTINDX INT,  @NewCURRNIDX INT,  @aaBrowseType SMALLINT,  @OldDEBITAMT NUMERIC(19,5),  @OldORDBTAMT NUMERIC(19,5),  @NewDEBITAMT NUMERIC(19,5),  @NewORDBTAMT NUMERIC(19,5)  DECLARE @aaDistIDTbl TABLE  (  aaSubLedgerDistID int  )   SELECT @OldaaSubLedgerHdrID = 0 , @NewaaSubLedgerHdrID = 0,@OldACTINDX = 0, @OldDEBITAMT = 0, @OldORDBTAMT = 0,@aaSubLedgerDistID = 0,   @OldaaSubLedgerDistID = 0, @NewACTINDX = 0 , @aaBrowseType = 0 , @NewDEBITAMT = 0 , @NewORDBTAMT = 0, @NewCURRNIDX = 0   SELECT @OldaaSubLedgerHdrID = aaSubLedgerHdrID FROM AAG20000 WHERE DOCNUMBR = @DocNumberFrom AND DOCTYPE = 21 AND SERIES = 12  SELECT @NewaaSubLedgerHdrID = aaSubLedgerHdrID FROM AAG20000 WHERE DOCNUMBR = @DocNumberTo AND DOCTYPE = 21 AND SERIES = 12   INSERT INTO @aaDistIDTbl SELECT 0   DECLARE Cursor1 CURSOR LOCAL FAST_FORWARD FOR  SELECT aaSubLedgerDistID, ACTINDX, aaBrowseType, DEBITAMT, ORDBTAMT, CURRNIDX FROM AAG20001 WHERE aaSubLedgerHdrID = @NewaaSubLedgerHdrID ORDER BY aaSubLedgerDistID ASC  OPEN Cursor1  FETCH NEXT FROM Cursor1 INTO @aaSubLedgerDistID, @NewACTINDX, @aaBrowseType, @NewDEBITAMT, @NewORDBTAMT, @NewCURRNIDX  WHILE @@FETCH_STATUS = 0  BEGIN  SELECT @OldaaSubLedgerDistID = ISNULL(aaSubLedgerDistID, 0)FROM AAG20001   WHERE aaSubLedgerHdrID = @OldaaSubLedgerHdrID AND ACTINDX = @NewACTINDX AND DEBITAMT = @NewDEBITAMT AND   ORDBTAMT = @NewORDBTAMT AND CURRNIDX = @NewCURRNIDX AND aaSubLedgerDistID NOT IN (SELECT aaSubLedgerDistID FROM @aaDistIDTbl)  IF @aaBrowseType NOT IN (0, 3) AND @OldaaSubLedgerDistID > 0 AND (@NewDEBITAMT > 0 OR @NewORDBTAMT > 0)   BEGIN  INSERT INTO @aaDistIDTbl SELECT @OldaaSubLedgerDistID   DELETE FROM AAG20003 WHERE aaSubLedgerHdrID = @NewaaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID  DELETE FROM AAG20002 WHERE aaSubLedgerHdrID = @NewaaSubLedgerHdrID AND aaSubLedgerDistID = @aaSubLedgerDistID  INSERT INTO AAG20002  (aaSubLedgerHdrID, aaSubLedgerDistID, aaSubLedgerAssignID, DEBITAMT, CRDTAMNT,   ORDBTAMT, ORCRDAMT, aaAssignedPercent, DistRef, NOTEINDX, aaAssignErrors, aaAliasID)  SELECT @NewaaSubLedgerHdrID, @aaSubLedgerDistID, aaSubLedgerAssignID, DEBITAMT, CRDTAMNT,   ORDBTAMT, ORCRDAMT, aaAssignedPercent, DistRef, NOTEINDX, aaAssignErrors, aaAliasID   FROM AAG20002  WHERE aaSubLedgerHdrID = @OldaaSubLedgerHdrID AND aaSubLedgerDistID = @OldaaSubLedgerDistID   INSERT INTO AAG20003 ([aaSubLedgerHdrID], [aaSubLedgerDistID], [aaSubLedgerAssignID], [aaTrxDimID], [aaTrxCodeID], [aaCodeErrors])  SELECT @NewaaSubLedgerHdrID, @aaSubLedgerDistID, aaSubLedgerAssignID, [aaTrxDimID], [aaTrxCodeID], [aaCodeErrors]  FROM AAG20003  WHERE aaSubLedgerHdrID = @OldaaSubLedgerHdrID AND aaSubLedgerDistID = @OldaaSubLedgerDistID  END  FETCH NEXT FROM Cursor1 INTO @aaSubLedgerDistID, @NewACTINDX, @aaBrowseType, @NewDEBITAMT, @NewORDBTAMT, @NewCURRNIDX  END  CLOSE Cursor1  DEALLOCATE Cursor1  DELETE FROM @aaDistIDTbl END   
GO
GRANT EXECUTE ON  [dbo].[aagCopyaaCodesforPOPRequisition] TO [DYNGRP]
GO
