SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[glpCloseFixedAllocationHistory]  @I_iSQLSessionID                int             = NULL,  @I_sTransactionType             smallint        = NULL,  @I_iJournalEntry                int             = NULL,  @I_cBatchSource                 char(15)        = NULL,  @I_cBatchNumber                 char(15)        = NULL,   @I_cUserID                      char(15)        = NULL,  @I_sSeries                      smallint        = NULL,  @I_iAllocationIndex             int             = NULL,  @I_cAuditTrailCode              char(13)        = NULL,  @I_sHistoryYear                 smallint        = NULL,  @I_sClosingYear                 smallint        = NULL,  @I_cDescription                 char(30)        = NULL,  @I_mProfitAndLossTotalDebits    numeric(19,5)   = NULL,  @I_mProfitAndLossTotalCredits   numeric(19,5)   = NULL,  @I_tPrintDistributions          tinyint  = NULL,  @I_tReversing                   tinyint  = NULL,  @I_tPrinting                    tinyint  = NULL,  @I_tPosting                     tinyint  = NULL,   @I_tOffsetAccount               tinyint  = NULL,  @I_tRealTimeQuick               tinyint  = NULL,  @I_sQuickOffset                 smallint        = NULL,  @I_mSequenceLine                numeric(19,5)   = NULL,  @I_mRecurringTRXSequence numeric(19,5)   = NULL,  @I_mExchangeRate                numeric(15,7)   = NULL,  @I_cFuncCurrencyID              char(15)        = NULL,  @I_sFuncCurrencyIndex           smallint        = NULL,  @I_sFuncDecimalPlaces           smallint        = NULL,  @I_tMCRegistered                tinyint  = NULL,  @I_sMCTransaction               smallint        = NULL,  @I_cOrigCurrencyID              char(15)        = NULL,  @I_sOrigCurrencyIndex           smallint        = NULL,  @I_sOrigDecimalPlaces           smallint        = NULL,  @I_mOrigProfitAndLossTotalDebs  numeric(19,5)   = NULL,  @I_mOrigProfitAndLossTotalCred  numeric(19,5)   = NULL,  @I_cIntercompanyID char(5)  = NULL,  @I_tICTransaction tinyint  = NULL,  @I_cOriginatingDocNumber char(21) = NULL,  @I_cOriginatingControlNumber char(21) = NULL,  @I_cOriginatingMasterID char(31) = NULL,  @I_cOriginatingMasterName char(65) = NULL,  @I_sOriginatingTrxType smallint = NULL,  @I_cOriginatingTRXDesc char(30) = NULL,  @I_sOrigDTASeries smallint = NULL,  @I_iOrigSequenceNumber int  = NULL,  @I_sDTAGLStatus smallint = NULL,  @I_nDTAIndex numeric(19,5) = NULL,  @I_nDenomExchangeRate numeric(15,7) = NULL,  @I_sMCTrxState smallint = NULL,  @I_dDocumentDate datetime = NULL,  @I_iPostingNumber int  = NULL,  @I_iPeriodPostingNumber int  = NULL,  @I_iPostingNumberHist int  = NULL,  @I_iPeriodPostingNumberHist int  = NULL,  @I_cCorrespondingUnit char(5)  = NULL,  @I_nLedgerID int  = NULL,  @IO_bLineMessages               binary(4)       = NULL  output,  @IO_bLineMessages2              binary(4)       = NULL  output,  @IO_bRetainEarnMessages         binary(4)       = NULL  output,  @IO_bRetainEarnMessages2        binary(4)       = NULL  output,  @O_iErrorState                  int             = NULL  output as  declare  @TRUE                           tinyint,  @FALSE                          tinyint,  @POST_ACCT                      smallint,  @PROFIT_AND_LOSS                smallint,  @iDistributionIndex             int,  @iTempIndex                     int,  @sAccountType                   smallint,  @mDebit                         numeric(19,5),  @mCredit                        numeric(19,5),  @mOrigDebit                     numeric(19,5),  @mOrigCredit                    numeric(19,5),  @mSequenceLine                  numeric(19,5),  @cDivisionalSegment             char(66),  @cTempSegment                   char(66),  @tDivisionalClosing             tinyint,  @iRetainedEarningsIndex         int,  @sDivisionalAccountSegment      smallint,  @tKeepingTransactionHistory     tinyint,  @tKeepingAccountHistory         tinyint,  @tKeepingMCSummaryHistory       tinyint,  @tBeforeSegmentLength           tinyint,  @tDivisionalSegmentLength       tinyint,  @tAfterSegmentLength            tinyint,  @dClosingDate                   datetime,  @tTransaction                   tinyint,  @tLoop                          tinyint,  @iError                         int,  @iStatus                        int  select   @O_iErrorState = 0,  @iStatus = 0  if @@trancount = 0 begin  select @tTransaction = 1  begin transaction end   while (@tLoop is NULL) begin  select @tLoop = 1   if      @I_iSQLSessionID         is NULL or  @I_sTransactionType      is NULL or  @I_iJournalEntry         is NULL or  @I_cBatchSource          is NULL or  @I_cBatchNumber          is NULL or  @I_cUserID               is NULL or  @I_sSeries               is NULL or  @I_iAllocationIndex      is NULL or  @I_cAuditTrailCode       is NULL or  @I_sHistoryYear          is NULL or  @I_sClosingYear          is NULL or  @I_cDescription          is NULL or  @I_mProfitAndLossTotalDebits   is NULL or  @I_mProfitAndLossTotalCredits   is NULL or  @I_tPrintDistributions   is NULL or  @I_tReversing            is NULL or  @I_tPrinting             is NULL or  @I_tPosting              is NULL or  @I_tOffsetAccount        is NULL or  @I_tRealTimeQuick        is NULL or  @I_sQuickOffset          is NULL or  @I_mSequenceLine                is NULL or  @I_mRecurringTRXSequence        is NULL or  @I_mExchangeRate                is NULL or  @I_cFuncCurrencyID              is NULL or   @I_sFuncCurrencyIndex    is NULL or   @I_sFuncDecimalPlaces    is NULL or   @I_tMCRegistered                is NULL or   @I_sMCTransaction               is NULL or   @I_cOrigCurrencyID              is NULL or   @I_sOrigCurrencyIndex    is NULL or   @I_sOrigDecimalPlaces    is NULL or   @I_mOrigProfitAndLossTotalDebs  is NULL or  @I_mOrigProfitAndLossTotalCred  is NULL or  @I_cIntercompanyID is NULL or  @I_tICTransaction is NULL or  @I_cOriginatingDocNumber is NULL or  @I_cOriginatingControlNumber is NULL or  @I_cOriginatingMasterID is NULL or  @I_cOriginatingMasterName is NULL or  @I_sOriginatingTrxType is NULL or  @I_cOriginatingTRXDesc is NULL or  @I_sOrigDTASeries is NULL or  @I_iOrigSequenceNumber is NULL or  @I_sDTAGLStatus is NULL or  @I_nDTAIndex is NULL or  @I_nDenomExchangeRate is NULL or  @I_sMCTrxState is NULL or  @I_dDocumentDate is NULL or  @I_iPostingNumber is NULL or  @I_iPeriodPostingNumber is NULL or  @I_iPostingNumberHist is NULL or  @I_iPeriodPostingNumberHist is NULL or  @I_nLedgerID is NULL or  @IO_bLineMessages               is NULL or  @IO_bLineMessages2              is NULL or  @IO_bRetainEarnMessages         is NULL or  @IO_bRetainEarnMessages2        is NULL or  @I_cCorrespondingUnit is NULL  begin  select @O_iErrorState = 20435  break  end    select   @TRUE                   = 1,  @FALSE                  = 0,  @POST_ACCT              = 1,  @PROFIT_AND_LOSS        = 1   select @mSequenceLine = @I_mSequenceLine   exec @iStatus = glpGetHistoryPostingSetup  @I_iSQLSessionID,  @I_tMCRegistered,  @tKeepingTransactionHistory     output,  @tKeepingAccountHistory         output,  @tKeepingMCSummaryHistory       output,  @tDivisionalClosing             output,  @iRetainedEarningsIndex         output,  @sDivisionalAccountSegment      output,  @tBeforeSegmentLength           output,  @tDivisionalSegmentLength       output,  @tAfterSegmentLength            output,  @dClosingDate                   output,  @O_iErrorState                  output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if @iStatus <> 0 or @O_iErrorState <> 0  break   if @tDivisionalClosing = @TRUE  begin  update  #Distributions   set  Segment = substring(ACTNUMST,   (@tBeforeSegmentLength + 1),   @tDivisionalSegmentLength)  from   #Distributions ,  GL00105  where  SQLSessionID = @I_iSQLSessionID  and     AllocationIndex = @I_iAllocationIndex  and     DistributionIndex = ACTINDX  and     PostingType = @PROFIT_AND_LOSS   if @@rowcount = 0  begin  select @O_iErrorState = 20436  break  end    select  @cDivisionalSegment = min(Segment)  from  #Distributions   where  SQLSessionID = @I_iSQLSessionID  and     AllocationIndex = @I_iAllocationIndex  and     PostingType = @PROFIT_AND_LOSS   if @cDivisionalSegment is NULL  begin  select @O_iErrorState = 20437  break  end    end    else  begin  select   @mDebit = @I_mProfitAndLossTotalDebits,  @mCredit = @I_mProfitAndLossTotalCredits,  @mOrigDebit = @I_mOrigProfitAndLossTotalDebs,  @mOrigCredit = @I_mOrigProfitAndLossTotalCred   select @cDivisionalSegment = ' '   end    while @cDivisionalSegment is not NULL  begin  if @tDivisionalClosing = @TRUE  begin  select  @mDebit = sum(Debit),  @mCredit = sum(Credit),  @mOrigDebit = sum(OriginatingDebit),  @mOrigCredit = sum(OriginatingCredit)  from  #Distributions   where  SQLSessionID = @I_iSQLSessionID  and     AllocationIndex = @I_iAllocationIndex  and     PostingType = @PROFIT_AND_LOSS  and     Segment = @cDivisionalSegment   if @@rowcount = 0  begin  select @O_iErrorState = 20438  break  end    end    exec @iStatus = glpCloseHistory  @I_iSQLSessionID,  @I_sTransactionType,  @I_iJournalEntry,  @I_cBatchSource,  @I_cBatchNumber,  @I_cUserID,  @I_sSeries,  @I_iAllocationIndex,  @POST_ACCT,                               @PROFIT_AND_LOSS,                         @mDebit,  @mCredit,  @I_cAuditTrailCode,  @I_sClosingYear,  @I_cDescription,  @I_tPrintDistributions,  @I_tReversing,  @I_tPrinting,  @I_tPosting,  @I_tOffsetAccount,  @I_tRealTimeQuick,  @I_sQuickOffset,  @mSequenceLine,  @I_mRecurringTRXSequence,  @I_mExchangeRate,  @cDivisionalSegment,  @tDivisionalClosing,  @iRetainedEarningsIndex,  @sDivisionalAccountSegment,  @tBeforeSegmentLength,  @tDivisionalSegmentLength,  @tAfterSegmentLength,  @dClosingDate,  @I_cFuncCurrencyID,  @I_sFuncCurrencyIndex,  @I_sFuncDecimalPlaces,  @I_tMCRegistered,  @I_sMCTransaction,  @mOrigDebit,  @mOrigCredit,  @I_cOrigCurrencyID,  @I_sOrigCurrencyIndex,  @I_sOrigDecimalPlaces,  @I_cIntercompanyID,  @I_tICTransaction,  @I_cOriginatingDocNumber,  @I_cOriginatingControlNumber,  @I_cOriginatingMasterID,  @I_cOriginatingMasterName,  @I_sOriginatingTrxType,  @I_cOriginatingTRXDesc,  @I_sOrigDTASeries,  @I_iOrigSequenceNumber,  @I_sDTAGLStatus,  @I_nDTAIndex,  @I_nDenomExchangeRate,  @I_sMCTrxState,  @I_dDocumentDate,  @I_iPostingNumber,  @I_iPeriodPostingNumber,  @I_iPostingNumberHist,  @I_iPeriodPostingNumberHist,  @I_cCorrespondingUnit,  @I_nLedgerID,  @IO_bLineMessages        output,  @IO_bLineMessages2 output,  @IO_bRetainEarnMessages output,  @IO_bRetainEarnMessages2 output,  @O_iErrorState output   select @iError = @@error  if @iStatus = 0 and @iError <> 0  select @iStatus = @iError   if @iStatus <> 0 or @O_iErrorState <> 0  break   if @tDivisionalClosing = @FALSE  break   select @cTempSegment = @cDivisionalSegment  select @cDivisionalSegment = NULL  select  @cDivisionalSegment = min(Segment)  from  #Distributions   where  SQLSessionID = @I_iSQLSessionID  and     AllocationIndex = @I_iAllocationIndex  and     PostingType = @PROFIT_AND_LOSS  and     Segment > @cTempSegment   select @mSequenceLine = @mSequenceLine + 10.00   end  end   if @iStatus <> 0 or @O_iErrorState <> 0 begin  if @tTransaction = 1  rollback transaction end else if @tTransaction = 1  commit transaction  return (@iStatus)   
GO
GRANT EXECUTE ON  [dbo].[glpCloseFixedAllocationHistory] TO [DYNGRP]
GO
