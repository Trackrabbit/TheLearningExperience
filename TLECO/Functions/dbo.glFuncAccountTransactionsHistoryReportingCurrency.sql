SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE FUNCTION [dbo].[glFuncAccountTransactionsHistoryReportingCurrency] (  @TranslationCurrency char(15),  @TranslationDate datetime,   @StartDate datetime,  @EndDate datetime )  returns @glAccountTrxHist table (  HSTYEAR smallint,  JRNENTRY int,  SOURCDOC char(11),  REFRENCE char(31),  DSCRIPTN char(31),  TRXDATE datetime,  TRXSORCE char(13),  ACTINDX int,  SERIES smallint,  ORTRXTYP smallint,  ORMSTRID char(31),  ORMSTRNM char(65),  ORDOCNUM char(21),  ORTRXSRC char(13),  SequenceNumber int,  CURNCYID char(15),  TranslationCurrencyID char(15),  CURRNIDX smallint,  RATETPID char(15),  EXGTBLID char(15),  Original_Exchange_Rate numeric(19,7),  TranslationExchangeRate numeric(19,7),  EXCHDATE datetime,  TIME1 datetime,  RTCLCMTD smallint,  PERIODID smallint,  CRDTAMNT numeric(19,5),  DEBITAMT numeric(19,5),  ORCRDAMT numeric(19,5),  ORDBTAMT numeric(19,5),  TranslationCreditAmount numeric(22,5),  TranslationDebitAmount numeric(22,5),  PERDENDT datetime,  DENXRATE numeric(19,7),  MCTRXSTT smallint,  CurrencyTranslationType smallint,  VOIDED tinyint,  Ledger_ID smallint,  DECPLCUR smallint,  Adjustment_Transaction tinyint)  AS  BEGIN  insert into @glAccountTrxHist  select   [GL30000Final].[HSTYEAR],   [GL30000Final].[JRNENTRY],  [GL30000Final].[SOURCDOC],   [GL30000Final].[REFRENCE],  [GL30000Final].[DSCRIPTN],  [GL30000Final].[TRXDATE],  [GL30000Final].[TRXSORCE],  [GL30000Final].[ACTINDX],  [GL30000Final].[SERIES],  [GL30000Final].[ORTRXTYP],  [GL30000Final].[ORMSTRID],  [GL30000Final].[ORMSTRNM],  [GL30000Final].[ORDOCNUM],  [GL30000Final].[ORTRXSRC],  [GL30000Final].[SequenceNumber],  [GL30000Final].[CURNCYID],  [GL30000Final].[TranslationCurrencyID],  [GL30000Final].[CURRNIDX],  [GL30000Final].[RATETPID],  [GL30000Final].[EXGTBLID],  [GL30000Final].[Original_Exchange_Rate],  [GL30000Final].[TranslationExchangeRate],  [GL30000Final].[EXCHDATE],  [GL30000Final].[TIME1],  [GL30000Final].[RTCLCMTD],  [GL30000Final].[PERIODID],  [GL30000Final].[CRDTAMNT],  [GL30000Final].[DEBITAMT],  [GL30000Final].[ORCRDAMT],  [GL30000Final].[ORDBTAMT],  case GL30000Final.CRDTAMNT  when 0.0 then  0.0  else  dbo.mcFuncCalculateAmountExtended([GL30000Final].[RTCLCMTD], 3,   [GL30000Final].[TranslationExchangeRate],  [GL30000Final].[DENXRATE],  [GL30000Final].[MCTRXSTT],  [GL30000Final].[DECPLCUR],   [GL30000Final].[CRDTAMNT])  end as TranslationCreditAmount,  case GL30000Final.DEBITAMT  when 0.0 then  0.0  else  dbo.mcFuncCalculateAmountExtended([GL30000Final].[RTCLCMTD], 3,   [GL30000Final].[TranslationExchangeRate],  [GL30000Final].[DENXRATE],  [GL30000Final].[MCTRXSTT],  [GL30000Final].[DECPLCUR],   [GL30000Final].[DEBITAMT])  end as TranslationDebitAmount,  [GL30000Final].[PERDENDT],  [GL30000Final].[DENXRATE],  [GL30000Final].[MCTRXSTT],  [GL30000Final].[CurrencyTranslationType],  [GL30000Final].[VOIDED],  [GL30000Final].[Ledger_ID],  [GL30000Final].[DECPLCUR],  [GL30000Final].[Adjustment_Transaction] from (select   [GL_Account_TRX_HIST].[HSTYEAR],   [GL_Account_TRX_HIST].[JRNENTRY],  [GL_Account_TRX_HIST].[SOURCDOC],   [GL_Account_TRX_HIST].[REFRENCE],  [GL_Account_TRX_HIST].[DSCRIPTN],  [GL_Account_TRX_HIST].[TRXDATE],  [GL_Account_TRX_HIST].[TRXSORCE],  [GL_Account_TRX_HIST].[ACTINDX],  [GL_Account_TRX_HIST].[SERIES],  [GL_Account_TRX_HIST].[ORTRXTYP],  [GL_Account_TRX_HIST].[ORMSTRID],  [GL_Account_TRX_HIST].[ORMSTRNM],  [GL_Account_TRX_HIST].[ORDOCNUM],  [GL_Account_TRX_HIST].[ORTRXSRC],  [GL_Account_TRX_HIST].[SequenceNumber],  [GL_Account_TRX_HIST].[CURNCYID],  [GL_Account_TRX_HIST].[TranslationCurrencyID],  E.[CURRNIDX],  [GL_Account_TRX_HIST].[RATETPID],  [GL_Account_TRX_HIST].[EXGTBLID],  [GL_Account_TRX_HIST].[Original_Exchange_Rate],  F.XCHGRATE as TranslationExchangeRate,  F.[EXCHDATE],  F.[TIME1],  D.[RTCLCMTD],  [GL_Account_TRX_HIST].[PERIODID],  [GL_Account_TRX_HIST].[CRDTAMNT],  [GL_Account_TRX_HIST].[DEBITAMT],  [GL_Account_TRX_HIST].[ORCRDAMT],  [GL_Account_TRX_HIST].[ORDBTAMT],  [GL_Account_TRX_HIST].[PERDENDT],  dbo.mcFuncGetDenExchRate(@TranslationCurrency,D.RTCLCMTD) as DENXRATE,  [GL_Account_TRX_HIST].[MCTRXSTT],  [GL_Account_TRX_HIST].[CurrencyTranslationType],  [GL_Account_TRX_HIST].[VOIDED],  [GL_Account_TRX_HIST].[Ledger_ID],  (E.[DECPLCUR]-1) as DECPLCUR,  [GL_Account_TRX_HIST].[Adjustment_Transaction] from DYNAMICS..MC40200 E, DYNAMICS..MC40300 D cross apply  (select a.HSTYEAR,a.JRNENTRY,a.SOURCDOC,a.REFRENCE,a.DSCRIPTN,a.TRXDATE,  a.TRXSORCE,a.ACTINDX,a.SERIES,a.ORTRXTYP,a.ORMSTRID,a.ORMSTRNM,  a.ORDOCNUM,a.ORTRXSRC,a.SEQNUMBR as SequenceNumber,a.CURNCYID,@TranslationCurrency as TranslationCurrencyID,  a.CURRNIDX,a.RATETPID,b.CurrentExchangeTableID as EXGTBLID,a.XCHGRATE as Original_Exchange_Rate,  a.EXCHDATE,a.TIME1,a.RTCLCMTD,dbo.glFuncGetPeriodID(a.TRXDATE,a.HSTYEAR,a.SERIES) as PERIODID,a.CRDTAMNT,a.DEBITAMT,a.ORCRDAMT,a.ORDBTAMT,  d.PERDENDT,dbo.mcFuncGetMCTrxState(b.CURNCYID) as MCTRXSTT,c.CurrencyTranslationType,  a.VOIDED,a.Ledger_ID,a.Adjustment_Transaction  from GL30000 a, MC40600 b, MC00200 c, (select distinct YEAR1, PERIODID, PERIODDT, PERDENDT from SY40100) d  where c.CurrencyTranslationType =2  and a.ACTINDX=c.ACTINDX and c.CURNCYID=''  and b.CURNCYID=@TranslationCurrency  and a.HSTYEAR=d.YEAR1 and a.PERIODID=d.PERIODID  and d.PERIODDT >=@StartDate and d.PERDENDT <=@EndDate) GL_Account_TRX_HIST  cross apply dbo.mcFuncGetExchangeRateTable(@TranslationDate, GL_Account_TRX_HIST.EXGTBLID, D.TRXDTDEF, D.DATELMTS,D.PRVDSLMT,D.Base_Exchange_Rate_On,GL_Account_TRX_HIST.MCTRXSTT,GL_Account_TRX_HIST.CurrencyTranslationType) F  where GL_Account_TRX_HIST.EXGTBLID = D.EXGTBLID and D.CURNCYID=E.CURNCYID) GL30000Final  union   select   HSTYEAR,  JRNENTRY,  SOURCDOC,  REFRENCE,  DSCRIPTN,  TRXDATE,  TRXSORCE,  ACTINDX,  SERIES,  ORTRXTYP,  ORMSTRID,  ORMSTRNM,  ORDOCNUM,  ORTRXSRC,  SequenceNumber,  CURNCYID,  TranslationCurrencyID,  CURRNIDX,  RATETPID,  EXGTBLID,  Original_Exchange_Rate,  TranslationExchangeRate,  EXCHDATE,  TIME1,  RTCLCMTD,  PERIODID,  CRDTAMNT,DEBITAMT,  ORCRDAMT,ORDBTAMT,  TranslationCreditAmount,TranslationDebitAmount,  PERDENDT,  DENXRATE,MCTRXSTT,  CurrencyTranslationType,  VOIDED,Ledger_ID,  DECPLCUR,  Adjustment_Transaction  from GL30000CurrencyTranslationView  where TranslationCurrencyID=@TranslationCurrency  and TRXDATE >=@StartDate and TRXDATE<=@EndDate  union select   a.HSTYEAR,  a.JRNENTRY,  a.SOURCDOC,  a.REFRENCE,  b.DSCRIPTN,  a.TRXDATE,  a.TRXSORCE,  a.ACTINDX,  b.SERIES,  b.ORTRXTYP,  b.ORMSTRID,  b.ORMSTRNM,  b.ORDOCNUM,  b.ORTRXSRC,  a.SEQNUMBR as SequenceNumber,  a.CURNCYID,  a.TranslationCurrencyID,  a.CURRNIDX,  a.RATETPID,  a.EXGTBLID,  a.Original_Exchange_Rate,  a.XCHGRATE as TranslationExchangeRate,  a.EXCHDATE,  a.TIME1,  a.RTCLCMTD,  a.PERIODID,  a.CRDTAMNT,a.DEBITAMT,  a.ORCRDAMT,a.ORDBTAMT,  a.TranslationCreditAmount,a.TranslationDebitAmount,  d.PERDENDT,  a.DENXRATE,a.MCTRXSTT,  a.CurrencyTranslationType,  b.VOIDED,  a.Ledger_ID,  a.DECPLCUR,  0 as Adjustment_Transaction  from GL30001 a, GL30000 b, (select distinct YEAR1,PERIODID,PERIODDT,PERDENDT from SY40100) d  where a.HSTYEAR=b.HSTYEAR and a.JRNENTRY=b.JRNENTRY  and a.ACTINDX=b.ACTINDX and a.TRXDATE=b.TRXDATE and a.SEQNUMBR=b.SEQNUMBR  and a.HSTYEAR=d.YEAR1 and a.PERIODID=d.PERIODID   and a.TranslationCurrencyID=@TranslationCurrency  and a.TRXDATE >=@StartDate and a.TRXDATE<=@EndDate  return END    
GO
GRANT SELECT ON  [dbo].[glFuncAccountTransactionsHistoryReportingCurrency] TO [DYNGRP]
GO
