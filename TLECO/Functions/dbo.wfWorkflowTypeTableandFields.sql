SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE FUNCTION [dbo].[wfWorkflowTypeTableandFields] (  @Workflow_Type_Name char(51),  @OnlyMainTable tinyint  )  returns @wfWorkflowTypeTableandFields table (  ResourceName char(128),  ORD int,  Row_Index int )   AS  BEGIN  declare @WfTypeBusObjKey char(201),@WfTypeBusObjKeyTable char(128), @field_name char(128), @ORD int, @Row_Index int  declare @table_fields char(201), @table_location int, @field_location int, @new_table_location int  declare @work_section char(201), @work_section_old char(201)   select @WfTypeBusObjKey=WfTypeBusObjKey from WF100001 where Workflow_Type_Name=@Workflow_Type_Name  select @new_table_location = CHARINDEX('\',@WfTypeBusObjKey)  if @new_table_location=0   begin  select @ORD=1, @Row_Index=0  select @table_location=charindex('~',@WfTypeBusObjKey)  select @WfTypeBusObjKeyTable = substring(@WfTypeBusObjKey,1,(@table_location-1))  insert into @wfWorkflowTypeTableandFields select @WfTypeBusObjKeyTable, 1, 0   select @table_fields = SUBSTRING(@WfTypeBusObjKey,(@table_location+1),201)   select @field_location=1  while @field_location>0  begin  select @ORD=@ORD+1  select @Row_Index=@Row_Index+1  select @field_location=charindex('~',@table_fields)  if @field_location>0   begin  select @field_name = SUBSTRING(@table_fields,1,(@field_location-1))  insert into @wfWorkflowTypeTableandFields select rtrim(@WfTypeBusObjKeyTable)+'.'+@field_name, @ORD, @Row_Index  select @table_fields = SUBSTRING(@table_fields,(@field_location+1),201)  end   else   begin  select @field_name = RTRIM(@table_fields)  insert into @wfWorkflowTypeTableandFields select rtrim(@WfTypeBusObjKeyTable)+'.'+@field_name, @ORD, @Row_Index  end  end  end  else   begin   select @work_section = substring(@WfTypeBusObjKey,1,(@new_table_location-1))  select @Row_Index=0  while @WfTypeBusObjKey<>''  begin  select @ORD=1  select @table_location=charindex('~',@work_section)  select @WfTypeBusObjKeyTable = substring(@work_section,1,(@table_location-1))  insert into @wfWorkflowTypeTableandFields select @WfTypeBusObjKeyTable,@ORD,0   select @table_fields = SUBSTRING(@work_section,(@table_location+1),201)   select @field_location=1  while @field_location>0  begin  select @ORD=@ORD+1  select @Row_Index = @Row_Index +1  select @field_location=charindex('~',@table_fields)  if @field_location>0   begin  select @field_name = SUBSTRING(@table_fields,1,(@field_location-1))  insert into @wfWorkflowTypeTableandFields select rtrim(@WfTypeBusObjKeyTable)+'.'+@field_name, @ORD, @Row_Index  select @table_fields = SUBSTRING(@table_fields,(@field_location+1),201)  end   else   begin  select @field_name = RTRIM(@table_fields)  insert into @wfWorkflowTypeTableandFields select rtrim(@WfTypeBusObjKeyTable)+'.'+@field_name, @ORD, @Row_Index  end  end  select @work_section_old=@work_section  select @WfTypeBusObjKey = substring(@WfTypeBusObjKey,(@new_table_location+1),201)  select @new_table_location = CHARINDEX('\',@WfTypeBusObjKey)  if @new_table_location=0  select @work_section = substring(@WfTypeBusObjKey,1,201)  else  select @work_section = substring(@WfTypeBusObjKey,1,(@new_table_location-1))  if @work_section_old=@work_section or @OnlyMainTable=1  BREAK  else  CONTINUE  end   end  return END    
GO
GRANT SELECT ON  [dbo].[wfWorkflowTypeTableandFields] TO [DYNGRP]
GO
