SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE FUNCTION [dbo].[glFuncBudgetTransactionsWorkReportingCurrency] (  @TranslationCurrency char(15),  @TranslationDate datetime,   @StartDate datetime,  @EndDate datetime )  returns @glBudgetTrxWork table (  JRNENTRY int,  BUDGETID char(15),  YEAR1 smallint,  PERIODDT datetime,  PERIODID smallint,  ACTINDX int,  TranslationCurrencyID char(15),  TranslationExchangeRate numeric(19,7),  BUDGETAMT numeric(19,5),  TranslationBUDGETAMT numeric(22,5),  BudgerAdjustment numeric(19,5),  TranslationBudgerAdjustment numeric(22,5),  REFRENCE char(31),  TRXDATE datetime,  SOURCDOC char(11),  TRXSORCE char(13),  USWHPSTD char(15),  NOTEINDX numeric(19,5) )  as  BEGIN   Declare @CurrencyTranslationType int  set @CurrencyTranslationType=4 insert into @glBudgetTrxWork  select   [GL12000Final].[JRNENTRY],   [GL12000Final].[BUDGETID],   [GL12000Final].[YEAR1],  [GL12000Final].[PERIODDT],   [GL12000Final].[PERIODID],  [GL12000Final].[ACTINDX],  [GL12000Final].[TranslationCurrencyID],  [GL12000Final].[TranslationExchangeRate],  [GL12000Final].[BUDGETAMT],  case GL12000Final.BUDGETAMT  when 0.0 then  0.0  else  dbo.mcFuncCalculateAmountExtended([GL12000Final].[RTCLCMTD], 3,   [GL12000Final].[TranslationExchangeRate],  [GL12000Final].[DENXRATE],  [GL12000Final].[MCTRXSTT],  [GL12000Final].[DECPLCUR],   [GL12000Final].[BUDGETAMT])  end as TranslationBUDGETAMT,  [GL12000Final].[BudgerAdjustment],  case GL12000Final.BudgerAdjustment  when 0.0 then  0.0  else  dbo.mcFuncCalculateAmountExtended([GL12000Final].[RTCLCMTD], 3,   [GL12000Final].[TranslationExchangeRate],  [GL12000Final].[DENXRATE],  [GL12000Final].[MCTRXSTT],  [GL12000Final].[DECPLCUR],   [GL12000Final].[BudgerAdjustment])  end as TranslationBudgerAdjustment,  [GL12000Final].[REFRENCE],  [GL12000Final].[TRXDATE],  [GL12000Final].[SOURCDOC],  [GL12000Final].[TRXSORCE],  [GL12000Final].[USWHPSTD],  [GL12000Final].[NOTEINDX] from (select distinct   [GL_Budget_TRX_WORK].[JRNENTRY],   [GL_Budget_TRX_WORK].[BUDGETID],   [GL_Budget_TRX_WORK].[YEAR1],  [GL_Budget_TRX_WORK].[PERIODDT],   [GL_Budget_TRX_WORK].[PERIODID],  [GL_Budget_TRX_WORK].[ACTINDX],  [GL_Budget_TRX_WORK].[BUDGETAMT],  [GL_Budget_TRX_WORK].[BudgerAdjustment],  [GL_Budget_TRX_WORK].[REFRENCE],  [GL_Budget_TRX_WORK].[TRXDATE],  [GL_Budget_TRX_WORK].[SOURCDOC],  [GL_Budget_TRX_WORK].[TRXSORCE],  [GL_Budget_TRX_WORK].[USWHPSTD],  [GL_Budget_TRX_WORK].[NOTEINDX],  [GL_Budget_TRX_WORK].[TranslationCurrencyID],  [GL_Budget_TRX_WORK].[PERDENDT],  F.XCHGRATE as TranslationExchangeRate,  E.[CURRNIDX],  (E.[DECPLCUR]-1) as DECPLCUR,  [GL_Budget_TRX_WORK].[EXGTBLID],  D.[RTCLCMTD],  dbo.mcFuncGetDenExchRate(@TranslationCurrency,D.RTCLCMTD) as DENXRATE,  [GL_Budget_TRX_WORK].[MCTRXSTT] from DYNAMICS..MC40200 E, DYNAMICS..MC40300 D cross apply  (select a.JRNENTRY, a.BUDGETID, d.YEAR1, d.PERIODDT, d.PERIODID,   d.ACTINDX, d.BUDGETAMT, d.BudgerAdjustment, a.REFRENCE, a.TRXDATE, a.SOURCDOC, a.TRXSORCE,  a.USWHPSTD, a.NOTEINDX,   b.CURNCYID as TranslationCurrencyID,  dbo.glFuncGetPeriodEndDate(d.YEAR1,2,d.PERIODID) as PERDENDT,  b.BudgetExchangeTableID as EXGTBLID,  dbo.mcFuncGetMCTrxState(b.CURNCYID) as MCTRXSTT  from GL12000 a, GL12001 d, MC40600 b  where a.JRNENTRY=d.JRNENTRY and a.BUDGETID=d.BUDGETID and   b.CURNCYID=@TranslationCurrency and   a.TRXDATE >=@StartDate and a.TRXDATE <=@EndDate) GL_Budget_TRX_WORK  cross apply dbo.mcFuncGetExchangeRateTable(GL_Budget_TRX_WORK.PERDENDT, GL_Budget_TRX_WORK.EXGTBLID, D.TRXDTDEF, D.DATELMTS,D.PRVDSLMT,D.Base_Exchange_Rate_On,GL_Budget_TRX_WORK.MCTRXSTT,@CurrencyTranslationType) F  where GL_Budget_TRX_WORK.EXGTBLID = D.EXGTBLID and D.CURNCYID=E.CURNCYID) GL12000Final  return END   
GO
GRANT SELECT ON  [dbo].[glFuncBudgetTransactionsWorkReportingCurrency] TO [DYNGRP]
GO
