SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
 CREATE  FUNCTION [dbo].[aagGetBudgetBalance]() RETURNS  @TEMPTABLE TABLE ( PERIODDT DATETIME,  aaFiscalPeriod INTEGER, PERDBLNC NUMERIC(19,5), DEX_ROW_ID INT )  AS  BEGIN DECLARE @aaBudgetID INTEGER , @aaCodeSequence INTEGER , @ACTINDX INTEGER , @aaActualPriliminary INTEGER , @NETCHNG TINYINT , @YEAR1 SMALLINT, @aaRange SMALLINT, @STR30 CHAR(31), @aaFiscalPeriod INTEGER ,  @aaAmountQty INTEGER , @USERID   CHAR(15), @WINTYPE   SMALLINT, @CMPANYID INTEGER,  @StartDate DATETIME,  @EndDate DATETIME,  @StartYear INT  SELECT @USERID  = SYSTEM_USER SELECT TOP 1 @WINTYPE=WINTYPE from AAG00906 order by DEX_ROW_ID desc SELECT @CMPANYID = dbo.aagGetCompanyID()  SELECT @aaBudgetID = aaBudgetID , @aaCodeSequence = aaCodeSequence , @ACTINDX = ACTINDX , @aaActualPriliminary = aaActualPriliminary ,@aaAmountQty = aaAmtQty,  @YEAR1 = AAG00906.YEAR1 , @aaRange = aaRange, @NETCHNG = NETCHNG, @STR30 = STR30 FROM AAG00906 WHERE USERID = @USERID AND WINTYPE = @WINTYPE AND CMPANYID = @CMPANYID  SELECT @StartDate = From_Date, @EndDate = TODATE FROM AAG00903 WHERE aaBudgetID = @aaBudgetID  SELECT @StartYear = SY40101.YEAR1 FROM SY40101 WHERE FSTFSCDY <= @StartDate AND LSTFSCDY >= @EndDate  IF @ACTINDX =0 OR LEN(RTRIM(LTRIM(STR(@ACTINDX)))) = 0 BEGIN  IF @NETCHNG = 0 BEGIN INSERT INTO @TEMPTABLE  SELECT PERIODDT, aaFiscalPeriod , (SELECT Balance = CASE @aaAmountQty WHEN 0 THEN SUM(ISNULL(Balance,0))  ELSE SUM(ISNULL(QUANTITY,0)) END  FROM AAG00904 B  WHERE B.PERIODDT <= A.PERIODDT AND B.aaBudgetID = @aaBudgetID AND  B.aaCodeSequence = @aaCodeSequence AND B.aaActualPriliminary = @aaActualPriliminary) AS PERDBLNC,  DEX_ROW_ID  FROM AAG00904 A WHERE aaBudgetID = @aaBudgetID AND  aaCodeSequence = @aaCodeSequence AND aaActualPriliminary = @aaActualPriliminary ORDER BY PERIODDT  END ElSE  BEGIN INSERT INTO @TEMPTABLE  SELECT PERIODDT, aaFiscalPeriod, PERDBLNC = CASE @aaAmountQty WHEN 0 THEN ISNULL(Balance,0)  ELSE ISNULL(QUANTITY,0) END,  DEX_ROW_ID  FROM AAG00904 WHERE aaBudgetID = @aaBudgetID AND  aaCodeSequence = @aaCodeSequence AND aaActualPriliminary = @aaActualPriliminary ORDER BY PERIODDT  END END  ELSE IF @aaRange = 0 or LEN(RTRIM(LTRIM(STR(@aaRange)))) = 0 BEGIN IF NOT EXISTS(SELECT * FROM AAG00905 WHERE aaBudgetID = @aaBudgetID  AND aaCodeSequence = @aaCodeSequence AND  ACTINDX = @ACTINDX AND aaActualPriliminary = @aaActualPriliminary) BEGIN INSERT INTO @TEMPTABLE  SELECT PERIODDT,  PERIODID,  0.00 AS PERDBLNC,  DEX_ROW_ID FROM SY40100 WHERE PERDENDT >= @StartDate AND PERIODDT <= @EndDate AND FORIGIN = 1 AND PERIODID != 0 OR FORIGIN = 1 AND PERIODID = 0 AND SY40100.YEAR1 = @StartYear  UPDATE A SET A.PERIODDT = B.PERIODDT FROM SY40100 B, @TEMPTABLE A WHERE aaFiscalPeriod = 0 AND B.YEAR1 = @StartYear AND B.FORIGIN = 1 AND  B.PERIODID = 1 AND B.PERIODDT < @StartDate  RETURN END IF @NETCHNG = 0  BEGIN INSERT INTO @TEMPTABLE  SELECT PERIODDT,  aaFiscalPeriod, (SELECT SUM(ISNULL(Balance,0))  FROM AAG00905 B  WHERE B.PERIODDT <= A.PERIODDT AND B.aaBudgetID = @aaBudgetID AND  B.aaCodeSequence = @aaCodeSequence AND B.aaActualPriliminary = @aaActualPriliminary AND  ACTINDX = @ACTINDX) AS PERDBLNC,  DEX_ROW_ID  FROM AAG00905 A WHERE aaBudgetID = @aaBudgetID AND  aaCodeSequence = @aaCodeSequence AND ACTINDX = @ACTINDX AND aaActualPriliminary = @aaActualPriliminary  ORDER BY PERIODDT  END ELSE BEGIN INSERT INTO @TEMPTABLE  SELECT PERIODDT,  aaFiscalPeriod,  ISNULL(Balance,0) AS PERDBLNC, DEX_ROW_ID  FROM AAG00905 WHERE aaBudgetID = @aaBudgetID AND  aaCodeSequence = @aaCodeSequence AND ACTINDX = @ACTINDX AND aaActualPriliminary = @aaActualPriliminary  ORDER BY PERIODDT  END END ELSE   BEGIN IF @NETCHNG = 0  BEGIN INSERT INTO @TEMPTABLE  SELECT PERIODDT,  aaFiscalPeriod, (SELECT SUM(ISNULL(Balance,0))  FROM AAG00904 B  WHERE B.PERIODDT <= A.PERIODDT AND B.aaBudgetID = @aaBudgetID AND  B.aaCodeSequence = @aaCodeSequence AND B.aaActualPriliminary = @aaActualPriliminary) AS PERDBLNC, 0 AS DEX_ROW_ID FROM AAG00905 A WHERE aaBudgetID = @aaBudgetID AND aaCodeSequence = @aaCodeSequence AND aaActualPriliminary = @aaActualPriliminary  GROUP BY PERIODDT, aaFiscalPeriod ORDER BY PERIODDT  END ELSE BEGIN INSERT INTO @TEMPTABLE  SELECT PERIODDT,  aaFiscalPeriod,  ISNULL(SUM(Balance),0) AS PERDBLNC, 0 AS DEX_ROW_ID FROM AAG00905 WHERE aaBudgetID = @aaBudgetID AND aaCodeSequence = @aaCodeSequence AND aaActualPriliminary = @aaActualPriliminary  GROUP BY PERIODDT, aaFiscalPeriod  ORDER BY PERIODDT  END END RETURN END    
GO
GRANT SELECT ON  [dbo].[aagGetBudgetBalance] TO [DYNGRP]
GO
