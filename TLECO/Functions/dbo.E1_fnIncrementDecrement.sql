SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE FUNCTION [dbo].[E1_fnIncrementDecrement]  
 (@OLD_STRING VARCHAR(30))  
RETURNS VARCHAR(30)--NEW STRING  
AS  
BEGIN  
DECLARE @INT BIGINT, 
 @STR_LNGHT BIGINT,  
 @CURR_CHAR BIGINT,  
 @CURR_ASCII BIGINT,  
 @STRING VARCHAR(30),  
 @CURR_STR VARCHAR(1),  
 @IS_STR BIT,  
 @FIRST_STR BIGINT,  
 @OLD_NUM BIGINT,  
 @OLD_NUM_LNGH INT,  
 @OLD_NUM_STR VARCHAR(30),  
 @NEW_NUM_LNGH INT,  
 @NEW_NUM INT,  
 @NEW_NUM_STR VARCHAR(30),  
 @PREFIX VARCHAR(30),  
 @PREFIX_LEN INT,  
 @ZERO_TO_ADD INT,  
 @FINAL_STR VARCHAR(30),  
 @NEW_STRING1 VARCHAR(30)  
SET @INT = 0  
SET @STRING = @OLD_STRING  
SET @STR_LNGHT = LEN(@STRING)  
SET @CURR_CHAR = @STR_LNGHT  
SET @IS_STR = 0  
/*Look for the first char in the STRING*/  
WHILE @CURR_CHAR <> 0 AND @IS_STR <> 1  
 BEGIN  
   SET @CURR_STR = SUBSTRING(@STRING,@CURR_CHAR,1)  
   SET  @CURR_ASCII = ASCII(@CURR_STR)  
   /*If Found report position*/  
   IF NOT @CURR_ASCII BETWEEN 48 AND 57  
    BEGIN  
     SET @IS_STR = 1  
     SET @FIRST_STR = @CURR_CHAR  
     IF @CURR_CHAR = @STR_LNGHT  
      BEGIN  
       RETURN 'err'  
      END     
    END  
   SET @CURR_CHAR = @CURR_CHAR - 1  
 END  
/*Build the new string*/  
SET @PREFIX = SUBSTRING(@STRING,0,@CURR_CHAR + 2)  
SET @PREFIX_LEN = LEN(@PREFIX)  
SET @OLD_NUM_LNGH = @STR_LNGHT - @PREFIX_LEN  
SET @OLD_NUM_STR = SUBSTRING(@STRING,@PREFIX_LEN + 1,@OLD_NUM_LNGH)  
SET @OLD_NUM = CAST(@OLD_NUM_STR AS BIGINT)  
SET @NEW_NUM = @OLD_NUM + 1    
SELECT @NEW_NUM_STR = CAST(@NEW_NUM AS VARCHAR(30))    
SET @NEW_NUM_LNGH = LEN(@NEW_NUM_STR)  
SET @ZERO_TO_ADD = @OLD_NUM_LNGH - @NEW_NUM_LNGH    
IF @ZERO_TO_ADD < 0  
BEGIN  
 SET @ZERO_TO_ADD = 0  
END    
WHILE @ZERO_TO_ADD <> 0  
 BEGIN  
  SET @NEW_NUM_STR = STUFF(@NEW_NUM_STR,1,0,'0')      
  SET @ZERO_TO_ADD = @ZERO_TO_ADD - 1  
 END    
SET @FINAL_STR = RTRIM(LTRIM(@PREFIX)) + RTRIM(LTRIM(@NEW_NUM_STR))  
/*If the new string is longer than the old string report err eg final char is 99999 a addition would make it too long*/  
IF @STR_LNGHT < LEN(@FINAL_STR)   
 BEGIN  
  SET @NEW_STRING1 = 'err'   
 END  
 ELSE  
 BEGIN  
  SET @NEW_STRING1 = @FINAL_STR  
 END    
RETURN @NEW_STRING1  
END   
GO
GRANT EXECUTE ON  [dbo].[E1_fnIncrementDecrement] TO [DYNGRP]
GO
