SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE FUNCTION [dbo].[GetGLAcctCatBalanceNetChange]  (  @StartDate datetime,   @EndDate datetime,   @AcctCat int ) RETURNS   Numeric(19,5) AS BEGIN  DECLARE @FullPeriodStart datetime DECLARE @FullPeriodEnd datetime DECLARE @FullPeriodIDStart int DECLARE @FullPeriodIDEnd int DECLARE @CurrentYear int DECLARE @IsHist int  DECLARE @TrxStartDate datetime DECLARE @TrxEndDate datetime DECLARE @DATEMAX datetime DECLARE @INVALIDPERIOD int DECLARE @FinalBalance Numeric(19,5)  SELECT @StartDate = dbo.GetDateStripTime(@StartDate)  SELECT @EndDate = dbo.GetDateStripTime(@EndDate)   SET @DATEMAX = dbo.GetDefaultMaxDate() set @INVALIDPERIOD = -1  SELECT @CurrentYear = YEAR1, @IsHist = HISTORYR FROM SY40101 WHERE @StartDate between FSTFSCDY and LSTFSCDY  SELECT @FullPeriodStart =   ISNULL(  (SELECT TOP 1   PERIODDT   FROM   SY40100   WHERE   PERIODDT >= @StartDate AND   PERDENDT <= @EndDate AND   YEAR1 = @CurrentYear AND   FORIGIN = 1  ORDER BY PERIODDT ASC),   @DATEMAX)  SELECT @FullPeriodIDStart =  ISNULL(  (SELECT DISTINCT   PERIODID   FROM   SY40100   WHERE   PERIODDT = @FullPeriodStart AND   YEAR1 = @CurrentYear AND   FORIGIN = 1),   @INVALIDPERIOD)  SELECT @FullPeriodEnd =   ISNULL(  (SELECT TOP 1   PERDENDT   FROM   SY40100   WHERE   PERIODDT >= @StartDate AND   PERDENDT <= @EndDate AND  YEAR1 = @CurrentYear AND   FORIGIN = 1  ORDER BY PERDENDT DESC),   @DATEMAX)  SELECT @FullPeriodIDEnd =   ISNULL(  (SELECT DISTINCT   PERIODID   FROM   SY40100   WHERE   PERDENDT = @FullPeriodEnd AND  YEAR1 = @CurrentYear AND   FORIGIN = 1),   @INVALIDPERIOD)  IF @IsHist = 1 BEGIN   SELECT @FinalBalance = (SELECT  ISNULL(SUM(  ISNULL(PERDBLNC, 0.00)), 0.00)  FROM   GL10111  WHERE   @AcctCat = ACCATNUM AND  PERIODID >= @FullPeriodIDStart AND  PERIODID <= (@FullPeriodIDEnd) AND  YEAR1 = @CurrentYear)   SELECT @FinalBalance = @FinalBalance + (SELECT   ISNULL(SUM(  ISNULL(DEBITAMT, 0.00) - ISNULL(CRDTAMNT, 0.00)), 0.00)  FROM GL30000 join GL00100 on GL30000.ACTINDX = GL00100.ACTINDX  WHERE   @AcctCat = ACCATNUM AND   TRXDATE >= @StartDate AND   TRXDATE <= @EndDate   AND TRXDATE NOT BETWEEN @FullPeriodStart AND @FullPeriodEnd) END  ELSE BEGIN   SELECT @FinalBalance = (SELECT  ISNULL(SUM(  ISNULL(PERDBLNC, 0.00)), 0.00)  FROM   GL10110  WHERE   @AcctCat = ACCATNUM AND  PERIODID >= @FullPeriodIDStart AND  PERIODID <= (@FullPeriodIDEnd) AND  YEAR1 = @CurrentYear)   SELECT @FinalBalance = @FinalBalance + (SELECT   ISNULL(SUM(  ISNULL(DEBITAMT, 0.00) - ISNULL(CRDTAMNT, 0.00)), 0.00)  FROM GL20000 join GL00100 on GL20000.ACTINDX = GL00100.ACTINDX  WHERE   @AcctCat = ACCATNUM AND   TRXDATE >= @StartDate AND   TRXDATE <= @EndDate   AND TRXDATE NOT BETWEEN @FullPeriodStart AND @FullPeriodEnd) END  SELECT @FinalBalance = @FinalBalance * dbo.GetTypicalBalanceMultiplier(@AcctCat) RETURN @FinalBalance END   
GO
GRANT EXECUTE ON  [dbo].[GetGLAcctCatBalanceNetChange] TO [DYNGRP]
GO
