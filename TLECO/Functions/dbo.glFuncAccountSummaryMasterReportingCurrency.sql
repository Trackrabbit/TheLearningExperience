SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE FUNCTION [dbo].[glFuncAccountSummaryMasterReportingCurrency] (  @TranslationCurrency char(15),  @TranslationDate datetime,   @StartDate datetime,  @EndDate datetime )  returns @glAccountSumMaster table (  ACTINDX int,  YEAR1 smallint,  CRDTAMNT numeric(22,5),  DEBITAMT numeric(22,5),  Ledger_ID smallint,  PERDBLNC numeric(22,5),  TranslationPeriodBalance numeric(22,5),  ACCATNUM smallint,  TranslationCurrencyID char(15),  CurrencyTranslationType smallint,  PERDENDT datetime,  TranslationExchangeRate numeric(19,7),  TranslationCreditAmount numeric(22,5),  TranslationDebitAmount numeric(22,5),  PERIODID smallint ) as  BEGIN  if (select isnull((select KPGTRXHS from GL40000),0))=1 insert into @glAccountSumMaster select   [GL10110Final].[ACTINDX],  [GL10110Final].[YEAR1],  [GL10110Final].[CRDTAMNT],  [GL10110Final].[DEBITAMT],  [GL10110Final].[Ledger_ID],  [GL10110Final].[PERDBLNC],  case GL10110Final.PERDBLNC  when 0.0 then  0.0  else  dbo.mcFuncCalculateAmountExtended([GL10110Final].[RTCLCMTD], 3,   [GL10110Final].[TranslationExchangeRate],  [GL10110Final].[DENXRATE],  [GL10110Final].[MCTRXSTT],  [GL10110Final].[DECPLCUR],   [GL10110Final].[PERDBLNC])  end as TranslationPeriodBalance,  [GL10110Final].[ACCATNUM],  [GL10110Final].[TranslationCurrencyID],  [GL10110Final].[CurrencyTranslationType],  [GL10110Final].[PERDENDT],  [GL10110Final].[TranslationExchangeRate],  case GL10110Final.CRDTAMNT  when 0.0 then  0.0  else  dbo.mcFuncCalculateAmountExtended([GL10110Final].[RTCLCMTD], 3,   [GL10110Final].[TranslationExchangeRate],  [GL10110Final].[DENXRATE],  [GL10110Final].[MCTRXSTT],  [GL10110Final].[DECPLCUR],   [GL10110Final].[CRDTAMNT])  end as TranslationCreditAmount,  case GL10110Final.DEBITAMT  when 0.0 then  0.0  else  dbo.mcFuncCalculateAmountExtended([GL10110Final].[RTCLCMTD], 3,   [GL10110Final].[TranslationExchangeRate],  [GL10110Final].[DENXRATE],  [GL10110Final].[MCTRXSTT],  [GL10110Final].[DECPLCUR],   [GL10110Final].[DEBITAMT])  end as TranslationDebitAmount,  [GL10110Final].[PERIODID] from (select   [GL_Account_SUM_MSTR].[YEAR1],   [GL_Account_SUM_MSTR].[ACTINDX],  [GL_Account_SUM_MSTR].[PERIODID],  [GL_Account_SUM_MSTR].[Ledger_ID],  [GL_Account_SUM_MSTR].[PERDBLNC],  [GL_Account_SUM_MSTR].[TranslationCurrencyID],  [GL_Account_SUM_MSTR].[ACCATNUM],  [GL_Account_SUM_MSTR].[EXGTBLID],  [GL_Account_SUM_MSTR].[PERDENDT],  [GL_Account_SUM_MSTR].[CRDTAMNT],  [GL_Account_SUM_MSTR].[DEBITAMT],   [GL_Account_SUM_MSTR].[CurrencyTranslationType],  F.XCHGRATE as TranslationExchangeRate,  E.[CURRNIDX],  (E.[DECPLCUR]-1) as DECPLCUR,  '' as RATETPID,   F.EXCHDATE,  F.TIME1,  D.[RTCLCMTD],  dbo.mcFuncGetDenExchRate(@TranslationCurrency,D.RTCLCMTD) as DENXRATE,  [GL_Account_SUM_MSTR].[MCTRXSTT] from DYNAMICS..MC40200 E, DYNAMICS..MC40300 D cross apply  (select a.YEAR1, a.ACTINDX, a.PERIODID,  a.Ledger_ID, a.PERDBLNC,  @TranslationCurrency as TranslationCurrencyID, a.ACCATNUM,  a.CRDTAMNT, a.DEBITAMT,  c.CurrencyTranslationType,  b.CurrentExchangeTableID as EXGTBLID,  d.PERDENDT,  dbo.mcFuncGetMCTrxState(b.CURNCYID) as MCTRXSTT  from GL10110 a, MC40600 b, MC00200 c, (select distinct YEAR1, PERIODID, PERIODDT, PERDENDT from SY40100) d  where c.CurrencyTranslationType =2  and a.ACTINDX=c.ACTINDX and c.CURNCYID=''   and b.CURNCYID=@TranslationCurrency  and a.YEAR1=d.YEAR1 and a.PERIODID=d.PERIODID   and d.PERIODDT >=@StartDate and d.PERDENDT <=@EndDate) GL_Account_SUM_MSTR  cross apply dbo.mcFuncGetExchangeRateTable(@TranslationDate, GL_Account_SUM_MSTR.EXGTBLID, D.TRXDTDEF, D.DATELMTS,D.PRVDSLMT,D.Base_Exchange_Rate_On,GL_Account_SUM_MSTR.MCTRXSTT,GL_Account_SUM_MSTR.CurrencyTranslationType) F  where GL_Account_SUM_MSTR.EXGTBLID = D.EXGTBLID and D.CURNCYID=E.CURNCYID) GL10110Final  union  select   a.ACTINDX,   YEAR1=OPENYEAR,  CRDTAMNT=sum(a.CRDTAMNT),  DEBITAMT=sum(a.DEBITAMT),  a.Ledger_ID,  PERDBLNC=sum(a.DEBITAMT-a.CRDTAMNT),  TranslationPeriodBalance=sum(a.TranslationDebitAmount-a.TranslationCreditAmount),  0 as ACCATNUM,  a.TranslationCurrencyID,  a.CurrencyTranslationType,  a.PERDENDT,  a.TranslationExchangeRate,  TranslationCreditAmount=sum(TranslationCreditAmount),  TranslationDebitAmount=sum(TranslationDebitAmount),  a.PERIODID  from GL20000CurrencyTranslationView a  where a.TranslationCurrencyID=@TranslationCurrency   and a.TRXDATE >=@StartDate and a.TRXDATE<=@EndDate   group by OPENYEAR,PERIODID,a.ACTINDX,Ledger_ID,TranslationCurrencyID,CurrencyTranslationType,  PERDENDT,TranslationExchangeRate  union  select   a.ACTINDX,   YEAR1=a.OPENYEAR,  CRDTAMNT=sum(a.CRDTAMNT),  DEBITAMT=sum(a.DEBITAMT),  a.Ledger_ID,  PERDBLNC=sum(a.DEBITAMT-a.CRDTAMNT),  TranslationPeriodBalance=sum(a.TranslationDebitAmount-a.TranslationCreditAmount),  0 as ACCATNUM,  a.TranslationCurrencyID,  a.CurrencyTranslationType,  d.PERDENDT,  a.XCHGRATE as TranslationExchangeRate,  TranslationCreditAmount=sum(TranslationCreditAmount),  TranslationDebitAmount=sum(TranslationDebitAmount),  a.PERIODID  from GL20001 a, GL20000 b,(select distinct YEAR1,PERIODID,SERIES,PERIODDT,PERDENDT from SY40100) d  where a.OPENYEAR=b.OPENYEAR and a.JRNENTRY=b.JRNENTRY   and a.ACTINDX=b.ACTINDX and a.TRXDATE=b.TRXDATE and a.SEQNUMBR=b.SEQNUMBR  and a.OPENYEAR=d.YEAR1 and a.PERIODID=d.PERIODID and b.SERIES=d.SERIES  and a.TranslationCurrencyID=@TranslationCurrency and a.CURNCYID=b.CURNCYID  and a.TRXDATE >=@StartDate and a.TRXDATE<=@EndDate   group by a.OPENYEAR,a.PERIODID,a.ACTINDX,a.Ledger_ID,a.TranslationCurrencyID,a.CURNCYID,  a.CurrencyTranslationType,PERDENDT,a.XCHGRATE  else    insert into @glAccountSumMaster select   [GL10110Final].[ACTINDX],  [GL10110Final].[YEAR1],  [GL10110Final].[CRDTAMNT],  [GL10110Final].[DEBITAMT],  [GL10110Final].[Ledger_ID],  [GL10110Final].[PERDBLNC],  case GL10110Final.PERDBLNC  when 0.0 then  0.0  else  dbo.mcFuncCalculateAmountExtended([GL10110Final].[RTCLCMTD], 3,   [GL10110Final].[TranslationExchangeRate],  [GL10110Final].[DENXRATE],  [GL10110Final].[MCTRXSTT],  [GL10110Final].[DECPLCUR],   [GL10110Final].[PERDBLNC])  end as TranslationPeriodBalance,  [GL10110Final].[ACCATNUM],  [GL10110Final].[TranslationCurrencyID],  [GL10110Final].[CurrencyTranslationType],  [GL10110Final].[PERDENDT],  [GL10110Final].[TranslationExchangeRate],  case GL10110Final.CRDTAMNT  when 0.0 then  0.0  else  dbo.mcFuncCalculateAmountExtended([GL10110Final].[RTCLCMTD], 3,   [GL10110Final].[TranslationExchangeRate],  [GL10110Final].[DENXRATE],  [GL10110Final].[MCTRXSTT],  [GL10110Final].[DECPLCUR],   [GL10110Final].[CRDTAMNT])  end as TranslationCreditAmount,  case GL10110Final.DEBITAMT  when 0.0 then  0.0  else  dbo.mcFuncCalculateAmountExtended([GL10110Final].[RTCLCMTD], 3,   [GL10110Final].[TranslationExchangeRate],  [GL10110Final].[DENXRATE],  [GL10110Final].[MCTRXSTT],  [GL10110Final].[DECPLCUR],   [GL10110Final].[DEBITAMT])  end as TranslationDebitAmount,  [GL10110Final].[PERIODID] from (select   [GL_Account_SUM_MSTR].[YEAR1],   [GL_Account_SUM_MSTR].[ACTINDX],  [GL_Account_SUM_MSTR].[PERIODID],  [GL_Account_SUM_MSTR].[Ledger_ID],  [GL_Account_SUM_MSTR].[PERDBLNC],  [GL_Account_SUM_MSTR].[TranslationCurrencyID],  [GL_Account_SUM_MSTR].[ACCATNUM],  [GL_Account_SUM_MSTR].[EXGTBLID],  [GL_Account_SUM_MSTR].[PERDENDT],  [GL_Account_SUM_MSTR].[CRDTAMNT],  [GL_Account_SUM_MSTR].[DEBITAMT],   [GL_Account_SUM_MSTR].[CurrencyTranslationType],  F.XCHGRATE as TranslationExchangeRate,  E.[CURRNIDX],  (E.[DECPLCUR]-1) as DECPLCUR,  '' as RATETPID,   F.EXCHDATE,  F.TIME1,  D.[RTCLCMTD],  dbo.mcFuncGetDenExchRate(@TranslationCurrency,D.RTCLCMTD) as DENXRATE,  [GL_Account_SUM_MSTR].[MCTRXSTT] from DYNAMICS..MC40200 E, DYNAMICS..MC40300 D cross apply  (select a.YEAR1, a.ACTINDX, a.PERIODID,  a.Ledger_ID, a.PERDBLNC,  @TranslationCurrency as TranslationCurrencyID, a.ACCATNUM,  a.CRDTAMNT, a.DEBITAMT,  c.CurrencyTranslationType,  EXGTBLID=  case c.CurrencyTranslationType  when 1 then b.AverageExchangeTableID  when 2 then b.CurrentExchangeTableID  when 3 then b.HistoricalExchgTableID  end,  PERDENDT=  case c.CurrencyTranslationType  when 1 then (SELECT CASE AVGCLMD WHEN 1 THEN d.PERDENDT ELSE (DATEADD(dd, -DAY(DATEADD(m,1,d.PERDENDT)), DATEADD(m,1,d.PERDENDT)))END AS A FROM MC40000)  when 2 then @TranslationDate  when 3 then d.PERDENDT  end,  dbo.mcFuncGetMCTrxState(b.CURNCYID) as MCTRXSTT  from GL10110 a, MC40600 b, MC00200 c, (select distinct YEAR1, PERIODID, PERIODDT, PERDENDT from SY40100) d  where a.ACTINDX=c.ACTINDX and c.CURNCYID=''  and b.CURNCYID=@TranslationCurrency  and a.YEAR1=d.YEAR1 and a.PERIODID=d.PERIODID   and d.PERIODDT >=@StartDate and d.PERDENDT <=@EndDate) GL_Account_SUM_MSTR  cross apply dbo.mcFuncGetExchangeRateTable(GL_Account_SUM_MSTR.PERDENDT, GL_Account_SUM_MSTR.EXGTBLID, D.TRXDTDEF, D.DATELMTS,D.PRVDSLMT,D.Base_Exchange_Rate_On,GL_Account_SUM_MSTR.MCTRXSTT,GL_Account_SUM_MSTR.CurrencyTranslationType) F  where GL_Account_SUM_MSTR.EXGTBLID = D.EXGTBLID and D.CURNCYID=E.CURNCYID) GL10110Final  return  END    
GO
GRANT SELECT ON  [dbo].[glFuncAccountSummaryMasterReportingCurrency] TO [DYNGRP]
GO
