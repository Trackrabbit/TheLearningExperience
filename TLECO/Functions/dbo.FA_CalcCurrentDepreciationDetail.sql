SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE FUNCTION [dbo].[FA_CalcCurrentDepreciationDetail]  (  @ASSETINDEX int,   @BOOKINDX int,   @dep_as_of_date datetime,  @max_date datetime,  @use_original_values tinyint   )  RETURNS numeric(19,5)  AS BEGIN   declare  @depreciation numeric(19,5)   if @dep_as_of_date=@max_date   begin  select @depreciation=(select CURRUNDEPRAMT from FA00200 where ASSETINDEX=@ASSETINDEX and BOOKINDX=@BOOKINDX)  RETURN(@depreciation)   end   if @use_original_values=1  begin  select @depreciation = (select top 1 isnull(a.AMOUNT,0) from FA00902 a, FA00100 b where a.ASSETINDEX=@ASSETINDEX and a.ASSETINDEX=b.ASSETINDEX and   a.TRANSACCTTYPE=2 and (a.SOURCDOC='FADEP-O' or a.SOURCDOC='FADEP')  and   a.BOOKINDX=@BOOKINDX and a.DEPRTODATE<=@dep_as_of_date and   a.DEPRTODATE = (select isnull((select top 1(c.DEPRTODATE) from FA00902 c, FA00100 d where c.ASSETINDEX=@ASSETINDEX and c.TRANSACCTTYPE=2 and c.FA_Reset_User_ID<>'' and (c.SOURCDOC='FADEP-O' or c.SOURCDOC='FADEP') and   c.ASSETINDEX=d.ASSETINDEX and c.BOOKINDX=@BOOKINDX and c.DEPRTODATE<=@dep_as_of_date order by c.DEPRTODATE desc),  (select top 1(c.DEPRTODATE) from FA00902 c, FA00100 d where c.ASSETINDEX=@ASSETINDEX and c.TRANSACCTTYPE=2 and c.FA_Reset_User_ID<>'' and (c.SOURCDOC='FADEP-O' or c.SOURCDOC='FADEP') and   c.ASSETINDEX=d.ASSETINDEX and c.BOOKINDX=@BOOKINDX order by c.DEPRTODATE))))   if @depreciation is null   select @depreciation = (select top 1 isnull(a.AMOUNT,0) from FA00902 a, FA00100 b where a.ASSETINDEX=@ASSETINDEX and a.ASSETINDEX=b.ASSETINDEX and   a.TRANSACCTTYPE=2 and (a.SOURCDOC='FADEP-O' or a.SOURCDOC='FADEP')  and   a.BOOKINDX=@BOOKINDX and   a.DEPRTODATE = (select isnull((select top 1(c.DEPRTODATE) from FA00902 c, FA00100 d where c.ASSETINDEX=@ASSETINDEX and c.TRANSACCTTYPE=2 and c.FA_Reset_User_ID<>'' and (c.SOURCDOC='FADEP-O' or c.SOURCDOC='FADEP') and   c.ASSETINDEX=d.ASSETINDEX and c.BOOKINDX=@BOOKINDX and c.DEPRTODATE<=@dep_as_of_date order by c.DEPRTODATE desc),  (select top 1(c.DEPRTODATE) from FA00902 c, FA00100 d where c.ASSETINDEX=@ASSETINDEX and c.TRANSACCTTYPE=2 and c.FA_Reset_User_ID<>'' and (c.SOURCDOC='FADEP-O' or c.SOURCDOC='FADEP') and   c.ASSETINDEX=d.ASSETINDEX and c.BOOKINDX=@BOOKINDX order by c.DEPRTODATE))))   if @depreciation is null  select @depreciation = (select top 1 isnull(a.AMOUNT,0) from FA00902 a, FA00100 b where a.ASSETINDEX=@ASSETINDEX and a.ASSETINDEX=b.ASSETINDEX and   a.TRANSACCTTYPE=2 and a.FA_Reset_User_ID='' and   a.BOOKINDX=@BOOKINDX and a.DEPRTODATE<=@dep_as_of_date and   a.DEPRTODATE = (select top 1(c.DEPRTODATE) from FA00902 c, FA00100 d where c.ASSETINDEX=@ASSETINDEX and c.TRANSACCTTYPE=2 and c.FA_Reset_User_ID='' and   c.BOOKINDX=@BOOKINDX and c.DEPRTODATE<=@dep_as_of_date order by c.DEPRTODATE desc))  end  else  begin  select @depreciation = (select top 1 isnull(a.AMOUNT,0) from FA00902 a, FA00100 b where a.ASSETINDEX=@ASSETINDEX and a.ASSETINDEX=b.ASSETINDEX and   a.TRANSACCTTYPE=2 and a.FA_Reset_User_ID='' and   a.BOOKINDX=@BOOKINDX and a.DEPRTODATE<=@dep_as_of_date and   a.DEPRTODATE = (select top 1(c.DEPRTODATE) from FA00902 c, FA00100 d where c.ASSETINDEX=@ASSETINDEX and c.TRANSACCTTYPE=2 and c.FA_Reset_User_ID='' and   c.BOOKINDX=@BOOKINDX and c.DEPRTODATE<=@dep_as_of_date order by c.DEPRTODATE desc))  end   RETURN(@depreciation)  END   
GO
GRANT EXECUTE ON  [dbo].[FA_CalcCurrentDepreciationDetail] TO [DYNGRP]
GO
