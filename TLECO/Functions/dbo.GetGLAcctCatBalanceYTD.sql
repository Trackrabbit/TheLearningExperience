SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE FUNCTION [dbo].[GetGLAcctCatBalanceYTD] (  @UserDate datetime,  @AcctCat int ) RETURNS  Numeric(19,5) AS BEGIN   DECLARE @CurrentPeriodID int  DECLARE @CurrentYear int  DECLARE @IsHist int  DECLARE @TrxStartDate datetime  DECLARE @TrxEndDate datetime  DECLARE @FinalBalance Numeric(19,5)   SELECT @UserDate = dbo.GetDateStripTime(@UserDate)   SELECT DISTINCT   @CurrentPeriodID = PERIODID,   @CurrentYear = YEAR1,   @TrxStartDate = PERIODDT,   @TrxEndDate = @UserDate  FROM  SY40100  WHERE  @UserDate between PERIODDT and PERDENDT AND   FORIGIN = 1   SELECT   @IsHist = HISTORYR   FROM   SY40101   WHERE   YEAR1 = @CurrentYear   IF @IsHist = 1  BEGIN  SELECT @FinalBalance = (SELECT  ISNULL(SUM(  ISNULL(PERDBLNC, 0.00)), 0.00)  FROM  GL10111  WHERE  @AcctCat = ACCATNUM AND  PERIODID >= 0 AND  PERIODID <= (@CurrentPeriodID - 1) AND  YEAR1 = @CurrentYear)   SELECT @FinalBalance = @FinalBalance + (SELECT  ISNULL(SUM(  ISNULL(DEBITAMT, 0.00) - ISNULL(CRDTAMNT, 0.00)), 0.00)  FROM  GL30000 join GL00100 on GL30000.ACTINDX = GL00100.ACTINDX  WHERE  @AcctCat = ACCATNUM AND  TRXDATE >= @TrxStartDate AND  TRXDATE <= @TrxEndDate AND  HSTYEAR = @CurrentYear)  END   ELSE  BEGIN  SELECT @FinalBalance = (SELECT  ISNULL(SUM(  ISNULL(PERDBLNC, 0.00)), 0.00)  FROM  GL10110  WHERE  @AcctCat = ACCATNUM AND  PERIODID >= 0 AND  PERIODID <= (@CurrentPeriodID - 1) AND  YEAR1 = @CurrentYear)   SELECT @FinalBalance = @FinalBalance + (SELECT  ISNULL(SUM(  ISNULL(DEBITAMT, 0.00) - ISNULL(CRDTAMNT, 0.00)), 0.00)  FROM  GL20000 join GL00100 on GL20000.ACTINDX = GL00100.ACTINDX  WHERE  @AcctCat = ACCATNUM AND  TRXDATE >= @TrxStartDate AND  TRXDATE <= @TrxEndDate AND  OPENYEAR = @CurrentYear)  END   SELECT @FinalBalance = @FinalBalance * dbo.GetTypicalBalanceMultiplier(@AcctCat)   RETURN @FinalBalance END   
GO
GRANT EXECUTE ON  [dbo].[GetGLAcctCatBalanceYTD] TO [DYNGRP]
GO
