SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
 CREATE FUNCTION [dbo].[GetGLAcctCatBalanceKPIDetail] (  @UserDate datetime,   @BalanceType varchar(15),  @AcctCat int ) RETURNS @Balances TABLE (  AcctCat int,  CurrentBalance Numeric(19,5),  PreviousBalance Numeric(19,5),  OrderingDate datetime,  Label varchar(30) ) AS BEGIN  DECLARE @PreviousType int DECLARE @CurrentType int SET @PreviousType = 0 SET @CurrentType = 1  DECLARE @KpiDetailDates TABLE (  StartDate datetime,  EndDate datetime,  DateLabel varchar(30),  CurrPrevType int )  SELECT @UserDate = dbo.GetDateStripTime(@UserDate)  INSERT INTO @KpiDetailDates  SELECT   StartDate, EndDate, DateLabel, CurrPrevType  FROM   GetKPIDetailDates(@UserDate, 'Fiscal')  INSERT INTO @Balances (AcctCat, PreviousBalance, OrderingDate, Label)  SELECT   @AcctCat, PrevBal, OrdDate, DateLabel  FROM  (SELECT   CASE @BalanceType  WHEN 'YTD' THEN dbo.GetGLAcctCatBalanceYTD(EndDate, @AcctCat)  WHEN 'NetChange' THEN dbo.GetGLAcctCatBalanceNetChange(StartDate, EndDate, @AcctCat)  WHEN 'Average' THEN dbo.GetGLAcctCatBalanceAvg(EndDate, 'Period', @AcctCat)  END  as PrevBal, EndDate as OrdDate, DateLabel  FROM   @KpiDetailDates  WHERE   CurrPrevType = @PreviousType) s1  UPDATE @Balances SET CurrentBalance = CurrBal  FROM  (SELECT  CASE   WHEN @UserDate < StartDate THEN NULL  ELSE  CASE @BalanceType  WHEN 'YTD' THEN dbo.GetGLAcctCatBalanceYTD(EndDate, @AcctCat)   WHEN 'NetChange' THEN dbo.GetGLAcctCatBalanceNetChange(StartDate, EndDate, @AcctCat)  WHEN 'Average' THEN dbo.GetGLAcctCatBalanceAvg(EndDate, 'Period', @AcctCat)  END  END  as CurrBal, DateLabel  FROM  @KpiDetailDates  WHERE  CurrPrevType = @CurrentType) s2  WHERE  Label = DateLabel  RETURN END   
GO
GRANT SELECT ON  [dbo].[GetGLAcctCatBalanceKPIDetail] TO [DYNGRP]
GO
