SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[smAddRoutineRecord] @I_tStartEnd            tinyint         =       NULL, @I_cDisplayName         char(30)        =       NULL, @I_iSQLSessionID        int             =       NULL, @I_cDBName char(5)         =       NULL, @O_iErrorState          int             =       NULL    output  as  declare @sCompanyID             smallint, @iError int, @iStatus                        int, @iIndex                 int, @iNumber1               int, @iNumber2               int, @cSearchString1         char(2), @cSearchString2         char(2), @cUserID                char(15), @cCompanyName           char(64), @cMessage1              char(98), @cMessage2              char(10), @cUpdatedMessage        char(98), @cSecurityDesc          char(98), @sDefaultDate char(12), @sDefaultTime char(12)  if      @I_tStartEnd            is      NULL    or @I_cDisplayName         is      NULL    or @I_iSQLSessionID                is      NULL begin select @O_iErrorState  =       -20457   end  exec @iStatus = smGetDefaultDate @sDefaultDate output exec @iStatus = smGetDefaultTime @sDefaultTime output  select @iNumber1       =       11468,   @cSearchString1 =       '%1',    @cSearchString2 =       '%2'      select @cUserID        =       ACT.USERID, @cCompanyName   =       ACT.CMPNYNAM, @sCompanyID     =       COMP.CMPANYID from dbo.ACTIVITY        ACT, dbo.SY01500    COMP where ACT.SQLSESID            =       @I_iSQLSessionID        and COMP.CMPNYNAM           =       ACT.CMPNYNAM  if      exists (        select 1 from dbo.SY04300 where TRKROUT =       1)              and exists (        select 1 from dbo.SY60100 where USERID          =       @cUserID        and CMPANYID        =       @sCompanyID     and TRKUSER =       1) begin  if @I_tStartEnd = 1 begin select  @iNumber2       =       11479    end else     begin select @iNumber2       =       11481    end  exec @iStatus = dbo.smGetMsgString @iNumber1, @I_cDBName, @cMessage1 output, @O_iErrorState output  select @iError = @@error if @iStatus = 0 and @iError <> 0 begin  select @iStatus = @iError end  if      @iStatus <> 0 or @O_iErrorState <> 0 begin return @iStatus end  exec @iStatus = dbo.smGetMsgString @iNumber2, @I_cDBName, @cMessage2 output, @O_iErrorState output  select @iError = @@error if @iStatus = 0 and @iError <> 0 begin  select @iStatus = @iError end   if      @iStatus <> 0 or @O_iErrorState <> 0 begin return @iStatus end  select @iIndex = charindex(@cSearchString1, @cMessage1)  select @cUpdatedMessage = stuff(@cMessage1, @iIndex, 2, rtrim(@I_cDisplayName))  select @iIndex = charindex(@cSearchString2, @cUpdatedMessage)  select @cSecurityDesc = stuff(@cUpdatedMessage, @iIndex, 2,rtrim(@cMessage2))  insert into  dbo.SY05000  ( INDEX1,  CMPNYNAM,  USERID,  INQYTYPE,  DATE1,  TIME1,  SECDESC ) values  ( 4,  @cCompanyName,  @cUserID,  14,  @sDefaultDate,  @sDefaultTime,  @cSecurityDesc )  if @@RowCount <>  1  select @O_iErrorState = 20458     end  return    
GO
GRANT EXECUTE ON  [dbo].[smAddRoutineRecord] TO [DYNGRP]
GO
