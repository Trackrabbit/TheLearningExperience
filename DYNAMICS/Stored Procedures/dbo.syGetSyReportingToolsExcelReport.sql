SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[syGetSyReportingToolsExcelReport] @LanguageID smallint, @TableName varchar(100), @Company int AS BEGIN  SET NOCOUNT ON  DECLARE @CMPANYID int  DECLARE @INTERID char(5)   DECLARE @TemplateSql varchar(4000)  DECLARE @TempSql varchar(4000)  DECLARE @Sql varchar(max)  DECLARE @InsertSql varchar(max)  DECLARE @FirstLoop tinyint  DECLARE @ExcelReportLocation smallint  SELECT @ExcelReportLocation = ExcelReportLocation  from SY40800  SELECT @FirstLoop = 1   SELECT @Sql = ''  SELECT @TemplateSql =   ' SELECT ' +   ' {1} as [Company ID], ' +   ' case when a.ObjectType = 3 then 1 else 2 end as ExcelReportType,  ' +   ' case when c.ObjectID is null then 1 else 2 end as ReportDeployedStatus, ' +   ' REPLACE(a.DisplayName, ''{0}'',''{2}'')   as ReportDisplayName, ' +   ' case  ' +   ' when d.ExcelReportLocation = 2 and a.ObjectType = 3 then rtrim(d.ExcelReportsSystemFolder) + ''\Data Connections\{2}\''' +  ' when d.ExcelReportLocation = 2 and a.ObjectType = 4 then rtrim(d.ExcelReportsSystemFolder) + ''\Reports\{2}\''' +  ' when d.ExcelReportLocation = 3 and a.ObjectType = 3 then rtrim(d.ExcelSharePointSite) + ''/'' + rtrim(d.ExcelDataConnectionLibra)+ ''/{2}/''' +  ' when d.ExcelReportLocation = 3 and a.ObjectType = 4 then rtrim(d.ExcelSharePointSite) + ''/'' + rtrim(d.ExcelReportsLibrary)+ ''/{2}/''' +  ' else '''' end as URL, ' +   ' a.FolderName as [Series Name], ' +   ' a.CurrentVersion as VersionNumber ' +   ' FROM ' +   ' dbo.syExcelReports a INNER JOIN SY40800 d ON a.DEX_ROW_ID > 0 ' +   ' INNER JOIN {2}.sys.tables b ON a.TableName = b.name ' +   ' LEFT OUTER JOIN syDeployedReports c ON ' +   ' c.ObjectType = a.ObjectType ' +   ' AND c.ObjectID = a.ObjectID ' +   ' AND c.DeployedVersion = a.CurrentVersion ' +   ' AND c.CompanyID = ''{2}'' ' +   ' WHERE ' +   ' a.ObjectType in (3,4) '    DECLARE company_cursor CURSOR FOR   SELECT CMPANYID, INTERID  FROM SY01500  WHERE @Company = -99 or CMPANYID = @Company  ORDER BY CMPNYNAM   OPEN company_cursor;   FETCH NEXT FROM company_cursor   INTO @CMPANYID, @INTERID   WHILE @@FETCH_STATUS = 0  BEGIN  SELECT @TempSql = ''  IF (@FirstLoop = 0)   BEGIN  SELECT @TempSql = @TempSql + ' UNION ALL '  END  ELSE  BEGIN  SELECT @FirstLoop = 0  END  SELECT @TempSql = @TempSql + REPLACE(@TemplateSql, '{2}', @INTERID)  SELECT @TempSql = REPLACE(@TempSql, '{1}', @CMPANYID)  SELECT @Sql = @Sql + @TempSql  FETCH NEXT FROM company_cursor   INTO @CMPANYID, @INTERID   END  close  company_cursor  deallocate company_cursor   EXEC(' DELETE FROM ' + @TableName)  IF (@Sql != '' AND @ExcelReportLocation > 1)  BEGIN  SELECT @InsertSql =  ' INSERT INTO ' + @TableName + ' SELECT * FROM ( ' + @Sql + ' ) TEMP '  EXEC(@InsertSql)  END  END   
GO
GRANT EXECUTE ON  [dbo].[syGetSyReportingToolsExcelReport] TO [DYNGRP]
GO
