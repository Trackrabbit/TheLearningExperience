SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[syGetReportDeploymentStatus]   @LanguageID smallint,   @TableName varchar(100),   @User varchar(15),  @SrsVersion varchar (20) AS BEGIN  SET NOCOUNT ON  DECLARE @CMPANYID int  DECLARE @CMPNYNAM char(65)  DECLARE @INTERID char(5)  DECLARE @SrsStatus smallint  DECLARE @ExcelStatus smallint  DECLARE @CrmStatus smallint  DECLARE @CompSrsReportsCount int  DECLARE @CompExcelReportsCount int  DECLARE @CompCrmReportsCount int  DECLARE @CompSrsReportsAvail int  DECLARE @CompSrsVersionCount int  DECLARE @CompExcelReportsAvail int  DECLARE @CompCrmVersionCount int  DECLARE @CompCrmReportsAvail int  DECLARE @CompExcelVersionCount int  DECLARE @SqlSrsAvail    nvarchar(4000)  DECLARE @SqlSrsVersion    nvarchar(4000)  DECLARE @SqlSrsDeployed    nvarchar(4000)  DECLARE @SqlCrmAvail    nvarchar(4000)  DECLARE @SqlCrmVersion    nvarchar(4000)  DECLARE @SqlCrmDeployed    nvarchar(4000)  DECLARE @SqlExcelVersionDeployed    nvarchar(4000)  DECLARE @SqlExcelDeployed    nvarchar(4000)  DECLARE @SqlExcelAvail    nvarchar(4000)  DECLARE @SqlExcelVersion nvarchar(4000)  DECLARE @Params nvarchar(4000)  DECLARE @SrsServerMode smallint  DECLARE @ExcelReportLocation smallint  DECLARE @InsertSql varchar(4000)  DECLARE @CrmServiceUrl varchar(255)  DECLARE @CrmOrganizationName varchar(255)  DECLARE @CrmCredentialsMethod smallint  SELECT @SrsServerMode = SrsServerMode, @ExcelReportLocation = ExcelReportLocation  from SY40800   DECLARE company_cursor CURSOR FOR   SELECT CMPANYID, CMPNYNAM, INTERID, CrmServiceUrl, CrmOrganizationName, CrmCredentialsMethod  FROM SY01500  ORDER BY CMPNYNAM  OPEN company_cursor;   FETCH NEXT FROM company_cursor   INTO @CMPANYID, @CMPNYNAM, @INTERID, @CrmServiceUrl, @CrmOrganizationName, @CrmCredentialsMethod   WHILE @@FETCH_STATUS = 0  BEGIN  if (@User = 'sa' or (select COUNT(*) from SY60100 where CMPANYID = @CMPANYID and USERID = @User) > 0)  begin  SET @SrsStatus = 0  SET @CrmStatus = 0  SET @ExcelStatus = 0  IF @SrsServerMode < 2   BEGIN  SET @SrsStatus = 1   SET @CrmStatus = 1  END  IF @ExcelReportLocation < 2   BEGIN  SET @ExcelStatus = 1   END  IF (@CrmServiceUrl = '' and @CrmOrganizationName = '')  BEGIN  SET @CrmStatus = 1  END  IF @SrsServerMode <> 2   BEGIN  SET @CrmStatus = 1  END  IF @SrsStatus = 0  BEGIN  SELECT @SqlSrsDeployed =   N' SELECT @CompSrsReportsCount = COUNT(a.DEX_ROW_ID) from syDeployedReports a inner join sySrsReports b ' +  N' on a.ObjectID = b.ObjectID and a.ObjectType = b.ObjectType ' +  N' where b.ObjectType in (1, 2) and a.CompanyID = ''' + @INTERID + '''' +  N' and (b.MinSrsVersion = '''' or dbo.syCompareVersionStrings(''' + @SrsVersion + ''' , b.MinSrsVersion) > 0 ) ' +  N' and b.IsCRM = 0 '  exec sp_executesql @SqlSrsDeployed, N'@CompSrsReportsCount int out', @CompSrsReportsCount out  SELECT @SqlSrsAvail =  N' SELECT @CompSrsReportsAvail = COUNT(a.DEX_ROW_ID) FROM dbo.sySrsReports a, ' + @INTERID + '.sys.tables b ' +  N' WHERE a.TableName = b.name ' +  N' and (a.MinSrsVersion = '''' or dbo.syCompareVersionStrings(''' + @SrsVersion + ''' , a.MinSrsVersion) > 0 ) '+  N' and a.IsCRM = 0 '  exec sp_executesql @SqlSrsAvail, N'@CompSrsReportsAvail int out', @CompSrsReportsAvail out   IF @CompSrsReportsCount = 0 AND @CompSrsReportsAvail > 0   BEGIN  SET @SrsStatus = 2   END  IF @SrsStatus = 0  BEGIN  IF @CompSrsReportsCount < @CompSrsReportsAvail   BEGIN  SET @SrsStatus = 3   END  IF @CompSrsReportsCount = 0 and @CompSrsReportsAvail = 0   BEGIN  SET @SrsStatus = 5   END  IF @SrsStatus = 0 AND @CompSrsReportsCount = @CompSrsReportsAvail AND @CompSrsReportsAvail > 0  BEGIN   SELECT @SqlSrsVersion =   N' SELECT @CompSrsVersionCount = COUNT(a.DEX_ROW_ID) FROM dbo.sySrsReports a inner join ' + @INTERID + '.sys.tables b ON ' +  N' a.TableName = b.name ' +  N' INNER JOIN syDeployedReports c ON ' +  N' c.ObjectID = a.ObjectID and c.ObjectType = a.ObjectType ' +  N' WHERE   dbo.syCompareVersionStrings(c.DeployedVersion, a.CurrentVersion) = 0 ' +   N' AND c.CompanyID = ''' + @INTERID + '''' +  N' and a.IsCRM = 0 '  exec sp_executesql @SqlSrsVersion, N'@CompSrsVersionCount int out', @CompSrsVersionCount out  IF @CompSrsVersionCount > 0   BEGIN  SET @SrsStatus = 4  END  ELSE  BEGIN  SET @SrsStatus = 5   END  END  END  END  IF @CrmStatus = 0  BEGIN  SELECT @SqlCrmDeployed =   N' SELECT @CompCrmReportsCount = COUNT(a.DEX_ROW_ID) from syDeployedReports a inner join sySrsReports b ' +  N' on a.ObjectID = b.ObjectID and a.ObjectType = b.ObjectType ' +  N' where  b.ObjectType in (1, 2) and a.CompanyID = ''' + @INTERID + '''' +  N' and (b.MinSrsVersion = '''' or dbo.syCompareVersionStrings(''' + @SrsVersion + ''' , b.MinSrsVersion) > 0 ) ' +  N' and b.IsCRM = 1 '  exec sp_executesql @SqlCrmDeployed, N'@CompCrmReportsCount int out', @CompCrmReportsCount out  SELECT @SqlCrmAvail =  N' SELECT @CompCrmReportsAvail = COUNT(a.DEX_ROW_ID) FROM dbo.sySrsReports a, ' + @INTERID + '.sys.tables b ' +  N' WHERE a.TableName = b.name ' +   N' and (a.MinSrsVersion = '''' or dbo.syCompareVersionStrings(''' + @SrsVersion + ''' , a.MinSrsVersion) > 0 ) '+  N' and a.IsCRM = 1 '  exec sp_executesql @SqlCrmAvail, N'@CompCrmReportsAvail int out', @CompCrmReportsAvail out   IF @CompCrmReportsCount = 0 AND @CompCrmReportsAvail > 0   BEGIN  SET @CrmStatus = 2   END  IF @CrmStatus = 0  BEGIN  IF @CompCrmReportsCount < @CompCrmReportsAvail   BEGIN  SET @CrmStatus = 3   END  IF @CompCrmReportsCount = 0 and @CompCrmReportsAvail = 0   BEGIN  SET @CrmStatus = 5   END  IF @CrmStatus = 0 AND @CompCrmReportsCount = @CompCrmReportsAvail AND @CompCrmReportsAvail > 0  BEGIN   SELECT @SqlCrmVersion =   N' SELECT @CompCrmVersionCount = COUNT(a.DEX_ROW_ID) FROM dbo.sySrsReports a inner join ' + @INTERID + '.sys.tables b ON ' +  N' a.TableName = b.name ' +  N' INNER JOIN syDeployedReports c ON ' +  N' c.ObjectID = a.ObjectID and c.ObjectType = a.ObjectType ' +  N' WHERE  dbo.syCompareVersionStrings(c.DeployedVersion, a.CurrentVersion) = 0 ' +   N' AND c.CompanyID = ''' + @INTERID + '''' +  N' and a.IsCRM = 0 '  exec sp_executesql @SqlCrmVersion, N'@CompCrmVersionCount int out', @CompCrmVersionCount out  IF @CompCrmVersionCount > 0   BEGIN  SET @CrmStatus = 4  END  ELSE  BEGIN  SET @CrmStatus = 5   END  END  END  END  IF @ExcelStatus = 0  BEGIN  SELECT @SqlExcelDeployed =   N' SELECT @CompExcelReportsCount = COUNT(a.DEX_ROW_ID) from syDeployedReports a inner join syExcelReports b ' +  N' on a.ObjectID = b.ObjectID and a.ObjectType = b.ObjectType ' +  N' where  b.ObjectType in (3, 4) and a.CompanyID = ''' + @INTERID + ''''  exec sp_executesql @SqlExcelDeployed, N'@CompExcelReportsCount int out', @CompExcelReportsCount out  SELECT @SqlExcelAvail =  N' SELECT @CompExcelReportsAvail = COUNT(a.DEX_ROW_ID) FROM dbo.syExcelReports a, ' + @INTERID + '.sys.tables b ' +  N' WHERE a.TableName = b.name '  exec sp_executesql @SqlExcelAvail, N'@CompExcelReportsAvail int out', @CompExcelReportsAvail out  IF @CompExcelReportsCount = 0 AND @CompExcelReportsAvail > 0   BEGIN  SET @ExcelStatus = 2   END  IF @CompExcelReportsCount = 0 and @CompExcelReportsAvail = 0   BEGIN  SET @ExcelStatus = 5   END  IF @ExcelStatus = 0  BEGIN  IF @CompExcelReportsCount < @CompExcelReportsAvail   BEGIN  SET @ExcelStatus = 3   END  IF @ExcelStatus = 0 AND @CompExcelReportsCount = @CompExcelReportsAvail AND @CompExcelReportsAvail > 0  BEGIN   SELECT @SqlExcelVersion =   N' SELECT @CompExcelVersionCount = COUNT(a.DEX_ROW_ID) FROM dbo.syExcelReports a inner join ' + @INTERID + '.sys.tables b ON ' +  N' a.TableName = b.name ' +  N' INNER JOIN syDeployedReports c ON ' +  N' c.ObjectID = a.ObjectID and c.ObjectType = a.ObjectType ' +  N' WHERE  c.DeployedVersion < a.CurrentVersion ' +   N' AND c.CompanyID = ''' + @INTERID + ''''  exec sp_executesql @SqlExcelVersion, N'@CompExcelVersionCount int out', @CompExcelVersionCount out  IF @CompExcelVersionCount > 0   BEGIN  SET @ExcelStatus = 4  END  ELSE  BEGIN  SET @ExcelStatus = 5   END  END  END  END    IF @SrsStatus = 0   BEGIN  SET @SrsStatus = 1  END  IF @CrmStatus = 0   BEGIN  SET @CrmStatus = 1  END  IF (@CrmServiceUrl = '' and @CrmOrganizationName = '' and @SrsServerMode = 2)  BEGIN  SET @CrmStatus = 8  END  IF @ExcelStatus = 0   BEGIN  SET @ExcelStatus = 1  END  SELECT @InsertSql =   ' INSERT INTO ' + @TableName + ' SELECT ' + STR(@CMPANYID) +  ' , ' + quotename(@CMPNYNAM, '''') + ' , ' + quotename(@INTERID, '''') +   ' , ' + STR(@SrsStatus) + ' , ' + STR(@ExcelStatus) + ' , ' + STR(@CrmStatus)  EXEC (@InsertSql)  END  FETCH NEXT FROM company_cursor   INTO @CMPANYID, @CMPNYNAM, @INTERID, @CrmServiceUrl, @CrmOrganizationName, @CrmCredentialsMethod   END  close  company_cursor  deallocate company_cursor   END   
GO
GRANT EXECUTE ON  [dbo].[syGetReportDeploymentStatus] TO [DYNGRP]
GO
