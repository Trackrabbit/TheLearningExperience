SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE PROCEDURE [dbo].[syGPAzureBackupRestoreProcess] (  @IsBackupOrRestore bit,    @SecretKey varchar(1000),  @StorageAccountName varchar(1000),  @URLToContainer varchar(1000),  @UseCompression bit,    @DatabaseName varchar(12),  @BackupOption bit    ) AS  DECLARE   @Query nvarchar(2000),  @ErrorNum int BEGIN  IF CONVERT(varchar(20), SERVERPROPERTY('productversion')) < '11.0.3339'  RETURN   IF EXISTS  (SELECT * FROM sys.credentials WHERE name = 'GPAzureBackup')  BEGIN   SET @Query = 'ALTER CREDENTIAL GPAzureBackup WITH IDENTITY = ''' + @StorageAccountName + ''', SECRET = ''' + @SecretKey + ''''  EXEC sp_executesql @Query  END   ELSE  BEGIN   SET @Query = 'CREATE CREDENTIAL GPAzureBackup WITH IDENTITY = ''' + @StorageAccountName + ''', SECRET = ''' + @SecretKey + ''''  EXEC sp_executesql @Query  END   IF @IsBackupOrRestore = 1   BEGIN  BEGIN TRY  EXEC('RESTORE DATABASE ' + @DatabaseName + ' FROM URL = ''' + @URLToContainer + '''  WITH CREDENTIAL = ''GPAzureBackup'', STATS = 5')  END TRY  BEGIN CATCH  RETURN  ERROR_NUMBER()   END CATCH  END   ELSE   BEGIN   BEGIN TRY  IF @UseCompression = 1  IF @BackupOption = 1  BEGIN  EXEC('BACKUP DATABASE ' + @DatabaseName + ' TO URL = ''' + @URLToContainer + '''  WITH CREDENTIAL = ''GPAzureBackup'', FORMAT,COMPRESSION, NAME = '''+@DatabaseName+''';')  END  ELSE  BEGIN  EXEC('BACKUP DATABASE ' + @DatabaseName + ' TO URL = ''' + @URLToContainer + '''  WITH CREDENTIAL = ''GPAzureBackup'', COMPRESSION, NAME = '''+@DatabaseName+''';')  END   ELSE  IF @BackupOption = 1  BEGIN  EXEC('BACKUP DATABASE ' + @DatabaseName + ' TO URL = ''' + @URLToContainer + '''  WITH CREDENTIAL = ''GPAzureBackup'',FORMAT, NAME = '''+@DatabaseName+''';')  END   ELSE  BEGIN  EXEC('BACKUP DATABASE ' + @DatabaseName + ' TO URL = ''' + @URLToContainer + '''  WITH CREDENTIAL = ''GPAzureBackup'', NAME = '''+@DatabaseName+''';')  END   END TRY  BEGIN CATCH   RETURN  ERROR_NUMBER()   END CATCH   END  END    
GO
GRANT EXECUTE ON  [dbo].[syGPAzureBackupRestoreProcess] TO [DYNGRP]
GO
