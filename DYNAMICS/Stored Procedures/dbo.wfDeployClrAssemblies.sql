SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS OFF
GO
 CREATE PROCEDURE [dbo].[wfDeployClrAssemblies]  AS  BEGIN  declare @TrustWorthySetting bit  declare @Directory varchar(255)  declare @Value varchar(255)  declare @DirectoryServicePath varchar(255)  declare @RuntimeSerializationPath varchar(255)  declare @IdentityModelPath varchar(255)  declare @WebPath varchar(255)  declare @sql varchar(max)  declare @Wfbits varbinary(max)  declare @Adalbits varbinary(max)  declare @AdalGcbits varbinary(max)  declare @Nsbits varbinary(max)  declare @DocAtbits varbinary(max)  declare @DynDbo varchar(100)  declare @DbName nvarchar(128)  declare @KeyNameBase varchar(100)  declare @LoginNameBase varchar(100)  declare @DsKeyName varchar(100)  declare @DsLoginName varchar(100)  declare @RsKeyName varchar(100)  declare @RsLoginName varchar(100)  declare @ImKeyName varchar(100)  declare @ImLoginName varchar(100)  declare @WebKeyName varchar(100)  declare @WebLoginName varchar(100)  declare @WfKeyName varchar(100)  declare @WfLoginName varchar(100)  declare @AdalKeyName varchar(100)  declare @AdalLoginName varchar(100)  declare @AdalGcKeyName varchar(100)  declare @AdalGcLoginName varchar(100)  declare @NsKeyName varchar(100)  declare @NsLoginName varchar(100)  declare @DocAtKeyName varchar(100)  declare @DocAtLoginName varchar(100)   IF EXISTS(SELECT * FROM tempdb.dbo.sysobjects WHERE [name] ='#ClrDeployment')   DROP TABLE #ClrDeployment  CREATE TABLE #ClrDeployment (DboName varchar(100) NOT NULL, MasterTrustworthy bit, DynTrustworthy bit)   INSERT INTO #ClrDeployment  SELECT   master.dbo.syslogins.name,  (SELECT [is_trustworthy_on] FROM sys.databases WHERE [name] = 'master'),  (SELECT [is_trustworthy_on] FROM sys.databases WHERE [name] = ltrim(rtrim(DB_NAME())))  FROM   master.dbo.syslogins, master.dbo.sysdatabases   WHERE   master.dbo.sysdatabases.sid = master.dbo.syslogins.sid AND master.dbo.sysdatabases.name = ltrim(rtrim(DB_NAME()))   EXEC sp_changedbowner 'sa'   SET @sql = ' sp_configure ''clr enabled'', 1 reconfigure with override '  EXEC(@sql)   SELECT @Value = [value] FROM sys.dm_clr_properties WHERE [name] = 'directory'  SELECT @Directory = substring(@Value, 0, LEN(@Value) + 1 - CHARINDEX('\',REVERSE(@Value)))  SELECT @DirectoryServicePath = @Directory + rtrim(ltrim('\System.DirectoryServices.dll'))  SELECT @RuntimeSerializationPath = @Directory + rtrim(ltrim('\System.Runtime.Serialization.dll'))  SELECT @IdentityModelPath = @Directory + rtrim(ltrim('\System.IdentityModel.dll'))  SELECT @WebPath = @Directory + rtrim(ltrim('\System.Web.dll'))  SELECT @DbName = ltrim(rtrim(DB_NAME()))  SELECT @KeyNameBase = ltrim(rtrim(replace([value], '.', '_'))) FROM sys.dm_clr_properties WHERE [name] = 'version'  SELECT @KeyNameBase = SUBSTRING(@KeyNameBase, 0, len(@KeyNameBase))  SELECT @KeyNameBase = @DbName + @KeyNameBase  SELECT @LoginNameBase = @KeyNameBase  SELECT @DsKeyName = @KeyNameBase + ltrim(rtrim('SystemDirectoryServicesKey'))  SELECT @DsLoginName = @LoginNameBase + ltrim(rtrim('SQLCLRSysDirServLogin'))  SELECT @RsKeyName = @KeyNameBase + ltrim(rtrim('SystemRuntimeSerializationKey'))  SELECT @RsLoginName = @LoginNameBase + ltrim(rtrim('SQLCLRSysRntmSrlztnLogin'))  SELECT @ImKeyName = @KeyNameBase + ltrim(rtrim('SystemIdentityModelKey'))  SELECT @ImLoginName = @LoginNameBase + ltrim(rtrim('SQLCLRSysIdnttyMdlLogin'))  SELECT @WebKeyName = @KeyNameBase + ltrim(rtrim('SystemWebKey'))  SELECT @WebLoginName = @LoginNameBase + ltrim(rtrim('SQLCLRSysWebLogin'))  SELECT @WfKeyName = @DbName + 'v14_0_0GPWorkflowEngineKey'  SELECT @WfLoginName = @DbName + 'v14_0_0GPWorkflowEngineLogin'  SELECT @AdalKeyName = @DbName + 'v2_11_0MSIdentityModelClientsActiveDirectoryKey'  SELECT @AdalLoginName = @DbName + 'v2_11_0MSIdentityModelClientsActiveDirectoryLogin'  SELECT @AdalGcKeyName = @DbName + 'v1_0_3MSAzureADGraphClientKey'  SELECT @AdalGcLoginName = @DbName + 'v1_0_3MSAzureADGraphClientLogin'  SELECT @NsKeyName = @DbName + 'v4_5_11NewtonsoftJsonKey'  SELECT @NsLoginName = @DbName + 'v4_5_11NewtonsoftJsonLogin'  SELECT @DocAtKeyName=  @DbName + 'v14_0_0GPDocAttachEngineKey'  SELECT @DocAtLoginName = @DbName + 'v14_0_0GPDocAttachEngineLogin'   SET @sql =   'USE master ' +  ' IF  EXISTS (SELECT * FROM sys.server_principals WHERE [name] = N''' + @WfLoginName + ''') ' +  ' DROP LOGIN [' + @WfLoginName + '] ' +  ' IF  EXISTS (SELECT * FROM sys.server_principals WHERE [name] = N''' + @DocAtLoginName + ''') ' +  ' DROP LOGIN [' + @DocAtLoginName + '] ' +  ' IF  EXISTS (SELECT * FROM sys.server_principals WHERE [name] = N''' + @AdalLoginName + ''') ' +  ' DROP LOGIN [' + @AdalLoginName + '] ' +  ' IF  EXISTS (SELECT * FROM sys.server_principals WHERE [name] = N''' + @AdalGcLoginName + ''') ' +  ' DROP LOGIN [' + @AdalGcLoginName + '] ' +  ' IF  EXISTS (SELECT * FROM sys.server_principals WHERE [name] = N''' + @NsLoginName + ''') ' +  ' DROP LOGIN [' + @NsLoginName + '] ' +  ' IF  EXISTS (SELECT * FROM sys.server_principals WHERE [name] = N''' + @DsLoginName + ''') ' +  ' DROP LOGIN [' + @DsLoginName + '] ' +  ' IF  EXISTS (SELECT * FROM sys.server_principals WHERE [name] = N''' + @RsLoginName + ''') ' +  ' DROP LOGIN [' + @RsLoginName + '] ' +  ' IF  EXISTS (SELECT * FROM sys.server_principals WHERE [name] = N''' + @ImLoginName + ''') ' +  ' DROP LOGIN [' + @ImLoginName + '] ' +  ' IF  EXISTS (SELECT * FROM sys.server_principals WHERE [name] = N''' + @WebLoginName + ''') ' +  ' DROP LOGIN [' + @WebLoginName + '] ' +  ' IF EXISTS(SELECT * FROM sys.asymmetric_keys WHERE [name] = N''' + @WfKeyName + ''') ' +  ' DROP ASYMMETRIC KEY [' + @WfKeyName + '] ' +  ' IF EXISTS(SELECT * FROM sys.asymmetric_keys WHERE [name] = N''' + @DocAtKeyName + ''') ' +  ' DROP ASYMMETRIC KEY [' + @DocAtKeyName + '] ' +  ' IF EXISTS(SELECT * FROM sys.asymmetric_keys WHERE [name] = N''' + @AdalKeyName + ''') ' +  ' DROP ASYMMETRIC KEY [' + @AdalKeyName + '] ' +  ' IF EXISTS(SELECT * FROM sys.asymmetric_keys WHERE [name] = N''' + @AdalGcKeyName + ''') ' +  ' DROP ASYMMETRIC KEY [' + @AdalGcKeyName + '] ' +  ' IF EXISTS(SELECT * FROM sys.asymmetric_keys WHERE [name] = N''' + @NsKeyName + ''') ' +  ' DROP ASYMMETRIC KEY [' + @NsKeyName + '] ' +  ' IF EXISTS(SELECT * FROM sys.asymmetric_keys WHERE [name] = N''' + @DsKeyName + ''') ' +  ' DROP ASYMMETRIC KEY [' + @DsKeyName + '] ' +  ' IF EXISTS(SELECT * FROM sys.asymmetric_keys WHERE [name] = N''' + @RsKeyName + ''') ' +  ' DROP ASYMMETRIC KEY [' + @RsKeyName + '] ' +  ' IF EXISTS(SELECT * FROM sys.asymmetric_keys WHERE [name] = N''' + @ImKeyName + ''') ' +  ' DROP ASYMMETRIC KEY [' + @ImKeyName + '] ' +  ' IF EXISTS(SELECT * FROM sys.asymmetric_keys WHERE [name] = N''' + @WebKeyName + ''') ' +  ' DROP ASYMMETRIC KEY [' + @WebKeyName + '] '  EXEC(@sql)   IF EXISTS (SELECT [name] FROM sysobjects WHERE [name] = 'GetAssignedUsers')  DROP PROCEDURE [GetAssignedUsers];  IF EXISTS (SELECT [name] FROM sysobjects WHERE [name] = 'SendWorkflowAssignmentEmail')  DROP PROCEDURE [SendWorkflowAssignmentEmail];  IF EXISTS (SELECT [name] FROM sysobjects WHERE [name] = 'SendWorkflowCompletionEmail')  DROP PROCEDURE [SendWorkflowCompletionEmail];  IF EXISTS (SELECT [name] FROM sysobjects WHERE [name] = 'IsValidUserByObjectGuid')  DROP FUNCTION [IsValidUserByObjectGuid];  IF EXISTS (SELECT [name] FROM sysobjects WHERE [name] = 'IsValidUserByUser')  DROP FUNCTION [IsValidUserByUser];  IF EXISTS (SELECT [name] FROM sysobjects WHERE [name] = 'GetUserByObjectGuid')  DROP FUNCTION [GetUserByObjectGuid];  IF EXISTS (SELECT [name] FROM sysobjects WHERE [name] = 'GetObjectGuidByUser')  DROP FUNCTION [GetObjectGuidByUser];  IF EXISTS (SELECT [name] FROM sysobjects WHERE [name] = 'TestEmail')  DROP PROCEDURE [TestEmail]   IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = 'Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine')  DROP ASSEMBLY [Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine];  IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = 'Microsoft.Dynamics.GP.DocAttachEngine')  DROP ASSEMBLY [Microsoft.Dynamics.GP.DocAttachEngine];  IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = 'Microsoft.IdentityModel.Clients.ActiveDirectory')  DROP ASSEMBLY [Microsoft.IdentityModel.Clients.ActiveDirectory];  IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = 'Microsoft.Azure.ActiveDirectory.GraphClient')  DROP ASSEMBLY [Microsoft.Azure.ActiveDirectory.GraphClient];  IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = 'Newtonsoft.Json')  DROP ASSEMBLY [Newtonsoft.Json];   IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = 'System.Web')  DROP ASSEMBLY [System.Web]  IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = 'System.IdentityModel')  DROP ASSEMBLY [System.IdentityModel]  IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = 'System.Runtime.Serialization')  DROP ASSEMBLY [System.Runtime.Serialization]  IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = 'System.DirectoryServices')  DROP ASSEMBLY [System.DirectoryServices]   ALTER DATABASE master SET trustworthy ON   SET @sql =   ' USE master ' +  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngineTEMP'') ' +  ' DROP ASSEMBLY [Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngineTEMP] ' +  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''Microsoft.Dynamics.GP.DocAttachEngineTEMP'') ' +  ' DROP ASSEMBLY [Microsoft.Dynamics.GP.DocAttachEngineTEMP] ' +  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''Microsoft.IdentityModel.Clients.ActiveDirectoryTEMP'') ' +  ' DROP ASSEMBLY [Microsoft.IdentityModel.Clients.ActiveDirectoryTEMP]; ' +  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''Microsoft.Azure.ActiveDirectory.GraphClientTEMP'') ' +  ' DROP ASSEMBLY [Microsoft.Azure.ActiveDirectory.GraphClientTEMP] ' +  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''Newtonsoft.JsonTEMP'') ' +  ' DROP ASSEMBLY [Newtonsoft.JsonTEMP] ' +  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''System.WebTEMP'') ' +  ' DROP ASSEMBLY [System.WebTEMP] ' +  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''System.IdentityModelTEMP'') ' +  ' DROP ASSEMBLY [System.IdentityModelTEMP] ' +  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''System.Runtime.SerializationTEMP'') ' +  ' DROP ASSEMBLY [System.Runtime.SerializationTEMP] ' +  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''System.DirectoryServicesTEMP'') ' +  ' DROP ASSEMBLY [System.DirectoryServicesTEMP] '  EXEC(@sql)   SET @sql =   ' USE master ' +   ' CREATE ASSEMBLY [System.DirectoryServicesTEMP] ' +  ' FROM ''' + @DirectoryServicePath + '''' +  ' WITH PERMISSION_SET = UNSAFE '  EXEC(@sql)   SET @sql =   ' USE master ' +   ' CREATE ASSEMBLY [System.Runtime.SerializationTEMP] ' +  ' FROM ''' + @RuntimeSerializationPath + '''' +  ' WITH PERMISSION_SET = UNSAFE '  EXEC(@sql)   SET @sql =   ' USE master ' +   ' CREATE ASSEMBLY [System.WebTEMP] ' +  ' FROM ''' + @WebPath + '''' +  ' WITH PERMISSION_SET = UNSAFE '  EXEC(@sql)   SET @sql =   ' USE master ' +   ' CREATE ASSEMBLY [System.IdentityModelTEMP] ' +  ' FROM ''' + @IdentityModelPath + '''' +  ' WITH PERMISSION_SET = UNSAFE '  EXEC(@sql)   SELECT @Nsbits = [BinaryBlob] FROM [syClrAssemblies]  WHERE [Platform] = 'AnyCPU' AND [AssemblyName] = 'Newtonsoft.Json'  SET @sql =   ' USE master ' +  ' CREATE ASSEMBLY [Newtonsoft.JsonTEMP] ' +  ' FROM ' + convert(varchar(max), @Nsbits, 1) +  ' WITH PERMISSION_SET = UNSAFE '   EXEC(@sql)   SELECT @AdalGcbits = [BinaryBlob] FROM [syClrAssemblies]  WHERE [Platform] = 'AnyCPU' AND [AssemblyName] = 'Microsoft.Azure.ActiveDirectory.GraphClient'  SET @sql =   ' USE master ' +  ' CREATE ASSEMBLY [Microsoft.Azure.ActiveDirectory.GraphClientTEMP] ' +  ' FROM ' + convert(varchar(max), @AdalGcbits, 1) +  ' WITH PERMISSION_SET = UNSAFE '   EXEC(@sql)   SELECT @Adalbits = [BinaryBlob] FROM [syClrAssemblies]  WHERE [Platform] = 'AnyCPU' AND [AssemblyName] = 'Microsoft.IdentityModel.Clients.ActiveDirectory'  SET @sql =   ' USE master ' +  ' CREATE ASSEMBLY [Microsoft.IdentityModel.Clients.ActiveDirectoryTEMP] ' +  ' FROM ' + convert(varchar(max), @Adalbits, 1) +  ' WITH PERMISSION_SET = UNSAFE '   EXEC(@sql)  SELECT @DocAtbits = [BinaryBlob] FROM [syClrAssemblies]  WHERE [Platform] = 'AnyCPU' AND [AssemblyName] = 'Microsoft.Dynamics.GP.DocAttachEngine'  SET @sql =   ' USE master ' +  ' CREATE ASSEMBLY [Microsoft.Dynamics.GP.DocAttachEngineTEMP] ' +  ' FROM ' + convert(varchar(max), @DocAtbits, 1) +  ' WITH PERMISSION_SET = UNSAFE '   EXEC(@sql)  SELECT @Wfbits = [BinaryBlob] FROM [syClrAssemblies]  WHERE [Platform] = 'AnyCPU' AND [AssemblyName] = 'Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine'  SET @sql =   ' USE master ' +  ' CREATE ASSEMBLY [Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngineTEMP] ' +  ' FROM ' + convert(varchar(max), @Wfbits, 1) +  ' WITH PERMISSION_SET = UNSAFE '   EXEC(@sql)   SET @sql =   ' USE master' +  ' BEGIN TRY ' +  ' CREATE ASYMMETRIC KEY ' + @DsKeyName +  ' FROM EXECUTABLE FILE = ''' + @DirectoryServicePath + '''' +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' CREATE ASYMMETRIC KEY ' + @RsKeyName +  ' FROM EXECUTABLE FILE = ''' + @RuntimeSerializationPath + '''' +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' CREATE ASYMMETRIC KEY ' + @ImKeyName +  ' FROM EXECUTABLE FILE = ''' + @IdentityModelPath + '''' +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' CREATE ASYMMETRIC KEY ' + @WebKeyName +  ' FROM EXECUTABLE FILE = ''' + @WebPath + '''' +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' CREATE ASYMMETRIC KEY ' + @WfKeyName +   ' FROM ASSEMBLY [Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngineTEMP] ' +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' CREATE ASYMMETRIC KEY ' +@DocAtKeyName +   ' FROM ASSEMBLY [Microsoft.Dynamics.GP.DocAttachEngineTEMP] ' +  ' END TRY BEGIN CATCH END CATCH '+  ' BEGIN TRY ' +  ' CREATE ASYMMETRIC KEY ' + @AdalKeyName +   ' FROM ASSEMBLY [Microsoft.IdentityModel.Clients.ActiveDirectoryTEMP] ' +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' CREATE ASYMMETRIC KEY ' + @AdalGcKeyName +   ' FROM ASSEMBLY [Microsoft.Azure.ActiveDirectory.GraphClientTEMP] ' +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' CREATE ASYMMETRIC KEY ' + @NsKeyName +   ' FROM ASSEMBLY [Newtonsoft.JsonTEMP] ' +  ' END TRY BEGIN CATCH END CATCH '  EXEC(@sql)   SET @sql =   ' USE master' +  ' BEGIN TRY ' +  ' CREATE LOGIN ' + @WfLoginName +   ' FROM ASYMMETRIC KEY ' + @WfKeyName +  ' END TRY BEGIN CATCH END CATCH ' +  ' BEGIN TRY ' +  ' CREATE LOGIN ' + @DocAtLoginName +   ' FROM ASYMMETRIC KEY ' + @DocAtKeyName  +  ' END TRY BEGIN CATCH END CATCH '+  ' BEGIN TRY ' +  ' CREATE LOGIN ' + @AdalLoginName +   ' FROM ASYMMETRIC KEY ' + @AdalKeyName +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' CREATE LOGIN ' + @AdalGcLoginName +   ' FROM ASYMMETRIC KEY ' + @AdalGcKeyName +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' CREATE LOGIN ' + @NsLoginName +   ' FROM ASYMMETRIC KEY ' + @NsKeyName +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' CREATE LOGIN ' + @DsLoginName +   ' FROM ASYMMETRIC KEY ' + @DsKeyName +  ' END TRY BEGIN CATCH END CATCH ' +  ' BEGIN TRY ' +  ' CREATE LOGIN ' + @RsLoginName +   ' FROM ASYMMETRIC KEY ' + @RsKeyName +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' CREATE LOGIN ' + @ImLoginName +   ' FROM ASYMMETRIC KEY ' + @ImKeyName +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' CREATE LOGIN ' + @WebLoginName +   ' FROM ASYMMETRIC KEY ' + @WebKeyName +  ' END TRY BEGIN CATCH END CATCH '  EXEC(@sql)   SET @sql =   ' USE master' +  ' BEGIN TRY ' +  ' GRANT UNSAFE ASSEMBLY TO ' + @WfLoginName +  ' END TRY BEGIN CATCH END CATCH ' +  ' BEGIN TRY ' +  ' GRANT UNSAFE ASSEMBLY TO ' + @DocAtLoginName +  ' END TRY BEGIN CATCH END CATCH ' +  ' BEGIN TRY ' +  ' GRANT UNSAFE ASSEMBLY TO ' + @AdalLoginName +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' GRANT UNSAFE ASSEMBLY TO ' + @AdalGcLoginName +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' GRANT UNSAFE ASSEMBLY TO ' + @NsLoginName +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' GRANT UNSAFE ASSEMBLY TO ' + @DsLoginName +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' GRANT UNSAFE ASSEMBLY TO ' + @RsLoginName +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' GRANT UNSAFE ASSEMBLY TO ' + @ImLoginName +  ' END TRY BEGIN CATCH END CATCH ' +   ' BEGIN TRY ' +  ' GRANT UNSAFE ASSEMBLY TO ' + @WebLoginName +  ' END TRY BEGIN CATCH END CATCH '   EXEC(@sql)   SET @sql =   ' USE master' +  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngineTEMP'') ' +  ' DROP ASSEMBLY [Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngineTEMP] ' +  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''Microsoft.Dynamics.GP.DocAttachEngineTEMP'') ' +  ' DROP ASSEMBLY [Microsoft.Dynamics.GP.DocAttachEngineTEMP] '+  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''Microsoft.IdentityModel.Clients.ActiveDirectoryTEMP'') ' +  ' DROP ASSEMBLY [Microsoft.IdentityModel.Clients.ActiveDirectoryTEMP]; ' +  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''Microsoft.Azure.ActiveDirectory.GraphClientTEMP'') ' +  ' DROP ASSEMBLY [Microsoft.Azure.ActiveDirectory.GraphClientTEMP] ' +  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''Newtonsoft.JsonTEMP'') ' +  ' DROP ASSEMBLY [Newtonsoft.JsonTEMP] ' +  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''System.WebTEMP'') ' +  ' DROP ASSEMBLY [System.WebTEMP] ' +  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''System.IdentityModelTEMP'') ' +  ' DROP ASSEMBLY [System.IdentityModelTEMP] ' +  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''System.Runtime.SerializationTEMP'') ' +  ' DROP ASSEMBLY [System.Runtime.SerializationTEMP] ' +  ' IF EXISTS (SELECT [name] FROM sys.assemblies WHERE [name] = ''System.DirectoryServicesTEMP'') ' +  ' DROP ASSEMBLY [System.DirectoryServicesTEMP] '  EXEC(@sql)   IF (SELECT MasterTrustworthy FROM #ClrDeployment) = 0  BEGIN  ALTER DATABASE master SET trustworthy OFF  END    ALTER DATABASE CURRENT SET trustworthy ON   CREATE ASSEMBLY [System.DirectoryServices]   FROM @DirectoryServicePath   WITH PERMISSION_SET = UNSAFE   CREATE ASSEMBLY [System.Runtime.Serialization]   FROM @RuntimeSerializationPath   WITH PERMISSION_SET = UNSAFE    CREATE ASSEMBLY [System.Web]   FROM @WebPath   WITH PERMISSION_SET = UNSAFE    CREATE ASSEMBLY [System.IdentityModel]   FROM @IdentityModelPath   WITH PERMISSION_SET = UNSAFE    SELECT @Nsbits = [BinaryBlob] FROM [syClrAssemblies]  WHERE [Platform] = 'AnyCPU' AND [AssemblyName] = 'Newtonsoft.Json'  CREATE ASSEMBLY [Newtonsoft.Json]  FROM @Nsbits  WITH PERMISSION_SET = UNSAFE   SELECT @AdalGcbits = [BinaryBlob] FROM [syClrAssemblies]  WHERE [Platform] = 'AnyCPU' AND [AssemblyName] = 'Microsoft.Azure.ActiveDirectory.GraphClient'  CREATE ASSEMBLY [Microsoft.Azure.ActiveDirectory.GraphClient]  FROM @AdalGcbits  WITH PERMISSION_SET = UNSAFE  SELECT @Adalbits = [BinaryBlob] FROM [syClrAssemblies]  WHERE [Platform] = 'AnyCPU' AND [AssemblyName] = 'Microsoft.IdentityModel.Clients.ActiveDirectory'  CREATE ASSEMBLY [Microsoft.IdentityModel.Clients.ActiveDirectory]  FROM @Adalbits  WITH PERMISSION_SET = UNSAFE  SELECT @DocAtbits = [BinaryBlob] FROM [syClrAssemblies]  WHERE [Platform] = 'AnyCPU' AND [AssemblyName] = 'Microsoft.Dynamics.GP.DocAttachEngine'  CREATE ASSEMBLY [Microsoft.Dynamics.GP.DocAttachEngine]  FROM @DocAtbits  WITH PERMISSION_SET = UNSAFE   SELECT @Wfbits = [BinaryBlob] FROM [syClrAssemblies]  WHERE [Platform] = 'AnyCPU' AND [AssemblyName] = 'Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine'  CREATE ASSEMBLY [Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine]  FROM @Wfbits  WITH PERMISSION_SET = UNSAFE   SELECT @DynDbo = DboName FROM #ClrDeployment  SET @sql = 'EXEC sp_changedbowner ''' + rtrim(ltrim(@DynDbo)) + ''''  EXEC(@sql)   IF (SELECT DynTrustworthy FROM #ClrDeployment) = 0  BEGIN  ALTER DATABASE CURRENT SET trustworthy OFF  END   IF EXISTS(SELECT * FROM tempdb.dbo.sysobjects WHERE name='#ClrDeployment')   DROP TABLE #ClrDeployment    SET @sql =   ' CREATE FUNCTION IsValidUserByObjectGuid(@objectGuid nvarchar(37)) ' +  ' RETURNS bit ' +  ' AS EXTERNAL NAME [Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine].[Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine.Directory.SqlClrFunctions].[IsValidUserByObjectGuid] '   EXEC(@sql)    SET @sql =   ' CREATE FUNCTION IsValidUserByUser(@user nvarchar(85), @searchUsers bit, @searchGroups bit) ' +  ' RETURNS bit ' +  ' AS EXTERNAL NAME [Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine].[Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine.Directory.SqlClrFunctions].[IsValidUserByUser] '   EXEC(@sql)    SET @sql =   ' CREATE FUNCTION GetUserByObjectGuid(@objectGuid nvarchar(37)) ' +  ' RETURNS nvarchar(85) ' +  ' AS EXTERNAL NAME [Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine].[Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine.Directory.SqlClrFunctions].[GetUserByObjectGuid] '   EXEC(@sql)   SET @sql =   ' CREATE FUNCTION GetObjectGuidByUser(@user nvarchar(85), @searchUsers bit, @searchGroups bit) ' +  ' RETURNS nvarchar(37) ' +  ' AS EXTERNAL NAME [Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine].[Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine.Directory.SqlClrFunctions].[GetObjectGuidByUser] '   EXEC(@sql)   SET @sql =   ' CREATE PROCEDURE GetAssignedUsers( ' +  ' @workflowUser nvarchar(37), ' +  ' @usersListGuid nvarchar(37),  ' +   ' @workflowTypeName nvarchar(51),  ' +  ' @workflowName nvarchar(51),  ' +  ' @workflowVersion int, ' +  ' @workflowInstance nvarchar(37), ' +  ' @workflowStepName nvarchar(51), ' +  ' @workflowStepInstance nvarchar(37), ' +  ' @server nvarchar(128), ' +  ' @companyDb nvarchar(6), ' +  ' @systemDb nvarchar(11) ' +  ' ) ' +  ' AS EXTERNAL NAME [Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine].[Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine.Models.WorkflowUsersModel].[GetAssignedUsers] '   EXEC(@sql)   SET @sql =   ' CREATE PROCEDURE SendWorkflowAssignmentEmail( ' +  ' @workflowInstance nvarchar(37), ' +  ' @worfkflowStepInstance nvarchar(37), ' +  ' @mailMessageID nvarchar(25), ' +  ' @workflowVersion int, ' +  ' @assignedTaskUser nvarchar(85), ' +   ' @actionDueDate datetime, ' +  ' @actionDueTime datetime, ' +  ' @docAttachBusObjKey nvarchar(200), ' +  ' @documentDrillDown nvarchar(255), ' +  ' @documentID nvarchar(50), ' +  ' @originatorComments nvarchar(500), ' +  ' @originatorCommentsDate datetime, ' +  ' @originatorCommentsTime datetime,  ' +  ' @workflowManagers nvarchar(37), ' +  ' @workflowName nvarchar(51), ' +  ' @workflowTypeName nvarchar(51), ' +  ' @workflowOriginator nvarchar(85), ' +  ' @workflowStatus int, ' +  ' @workflowStepName nvarchar(51), ' +  ' @server nvarchar(128), ' +  ' @companyDb nvarchar(6), ' +  ' @systemDb nvarchar(11), ' +  ' @canApprove bit, ' +  ' @canTaskComplete bit, ' +  ' @canReject bit, ' +  ' @canDelegate bit, ' +  ' @canRecall bit, ' +  ' @tempFilepath nvarchar(300) , ' +  ' @Error int out )' +   ' AS EXTERNAL NAME [Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine].[Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine.Email.EmailEngine].[SendWorkflowAssignmentEmail] '   EXEC(@sql)  SET @sql =   ' CREATE PROCEDURE SendWorkflowCompletionEmail( ' +  ' @workflowInstance nvarchar(37), ' +  ' @worfkflowStepInstance nvarchar(37), ' +  ' @mailMessageID nvarchar(25), ' +  ' @workflowVersion int, ' +  ' @workflowAction smallint, ' +  ' @actionCompletedUser nvarchar(85), ' +   ' @actionComments nvarchar(500), ' +  ' @actionCompletedDate datetime, ' +  ' @actionCompletedTime datetime, ' +  ' @actionDueDate datetime, ' +  ' @actionDueTime datetime, ' +  ' @docAttachBusObjKey nvarchar(200), ' +  ' @documentDrillDown nvarchar(255), ' +  ' @documentID nvarchar(50),  ' +  ' @workflowManagers nvarchar(37), ' +  ' @workflowName nvarchar(51), ' +  ' @workflowTypeName nvarchar(51), ' +  ' @workflowOriginator nvarchar(85), ' +  ' @workflowStatus int, ' +  ' @workflowStepName nvarchar(51), ' +  ' @server nvarchar(128), ' +  ' @companyDb nvarchar(6), ' +  ' @systemDb nvarchar(11), ' +  ' @Error int out)  ' +  ' AS EXTERNAL NAME [Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine].[Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine.Email.EmailEngine].[SendWorkflowCompletionEmail] '   EXEC(@sql)  SET @sql =   ' CREATE PROCEDURE TestEmail( ' +  ' @fromEmail nvarchar(255), ' +  ' @server nvarchar(80), ' +  ' @port int, ' +  ' @ssl int, ' +  ' @authentication int, ' +  ' @user nvarchar(85), ' +  ' @passwrod nvarchar(255), ' +  ' @toMail nvarchar(255), ' +   ' @subject nvarchar(255), ' +  ' @body nvarchar(255))  ' +  ' AS EXTERNAL NAME [Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine].[Microsoft.Dynamics.GP.WorkflowGP.WorkflowEngine.Email.EmailEngine].[TestEmail] '   EXEC(@sql)   GRANT EXECUTE ON dbo.GetAssignedUsers to [DYNGRP]  GRANT EXECUTE ON dbo.SendWorkflowCompletionEmail to [DYNGRP]  GRANT EXECUTE ON dbo.SendWorkflowAssignmentEmail to [DYNGRP]  GRANT EXECUTE ON dbo.IsValidUserByObjectGuid to [DYNGRP]  GRANT EXECUTE ON dbo.IsValidUserByUser to [DYNGRP]  GRANT EXECUTE ON dbo.GetUserByObjectGuid to [DYNGRP]  GRANT EXECUTE ON dbo.GetObjectGuidByUser to [DYNGRP]  GRANT EXECUTE ON dbo.TestEmail to [DYNGRP]  END   
GO
GRANT EXECUTE ON  [dbo].[wfDeployClrAssemblies] TO [DYNGRP]
GO
