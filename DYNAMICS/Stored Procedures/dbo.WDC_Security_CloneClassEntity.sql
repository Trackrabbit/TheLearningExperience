SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 CREATE procedure [dbo].[WDC_Security_CloneClassEntity] (   @pSourceEntityID int = 0,   @pTargetEntityID int = 0,   @O_iErrorState int = NULL output)   AS SET NOCOUNT ON   declare @iFORMTYPE smallint, @iREPORTTYPE smallint, @iTABLETYPE smallint  select @iFORMTYPE = 2, @iREPORTTYPE = 23, @iTABLETYPE = 1  declare @iCBOFF smallint, @iCBON smallint, @iCBPART smallint, @iCBDISABLED smallint, @iCBUNKNOWN smallint, @iNODEPENDING smallint, @iNODENODISPLAY smallint, @iNODEDISABLED smallint  select @iCBOFF = 1, @iCBON = 2, @iCBPART = 3, @iCBDISABLED = 4, @iCBUNKNOWN = 5, @iNODEPENDING = 30, @iNODENODISPLAY = 0, @iNODEDISABLED = 29  declare @iNODEWINDOW smallint, @iNODEREPORT smallint, @iNODETABLE smallint, @iNODEREPORTMOD smallint  select @iNODEWINDOW = 10, @iNODEREPORT = 20, @iNODETABLE = 21, @iNODEREPORTMOD = 33  declare @iRetVal int, @tTransaction tinyint, @iErrorState int  if @pSourceEntityID = 0 or @pTargetEntityID = 0 begin   select @O_iErrorState = 50401 return  end  if not exists(select 1 from DYNAMICS.dbo.WDC51100 where WDC_Entity_ID = @pSourceEntityID) begin   select @O_iErrorState = 50402  return  end  if not exists(select 1 from DYNAMICS.dbo.WDC51101 where WDC_Entity_ID = @pSourceEntityID) begin   select @O_iErrorState = 50403  return  end  if not exists(select 1 from DYNAMICS.dbo.WDC51100 where WDC_Entity_ID = @pTargetEntityID) begin   select @O_iErrorState = 50404  return  end  select @O_iErrorState = 0, @iErrorState = 0  if @@trancount = 0 begin   select @tTransaction = 1 begin transaction  end  DELETE from DYNAMICS.dbo.WDC51101   where WDC_Entity_ID = @pTargetEntityID and not (Node_Image = 18 or (Node_Image between 22 and 30) or (Node_Image between 34 and 48))  if @@ERROR <> 0 begin   if @tTransaction = 1  rollback transaction   select @O_iErrorState = 50405  return  end  INSERT DYNAMICS.dbo.WDC51101   (WDC_Entity_ID, Node_Image, Node_Data, Node_State, Node_Overlay, Node_Child, Node_Image_Parent1, Node_Data_Parent1, Node_Image_Parent2, Node_Data_Parent2, Node_Image_Parent3, Node_Data_Parent3, ACTIVE )   select @pTargetEntityID as WDC_Entity_ID, A.Node_Image, A.Node_Data, case   when A.Node_State = @iCBDISABLED then @iCBDISABLED   when B.State is not NULL then B.State   when D.USRCLASS is NULL and A.Node_Image in (@iNODEWINDOW, @iNODEREPORT, @iNODETABLE, @iNODEREPORTMOD) then @iCBON   when D.USRCLASS is NULL then @iCBUNKNOWN   when Node_Data % 65536 =  -7 and D.MSCPRMIS & 1073741824 > 0 then @iCBON   when Node_Data % 65536 =  -7 and D.MSCPRMIS & 1073741824 = 0 then @iCBOFF   when Node_Data % 65536 =  -8 and D.MSCPRMIS <  0 then @iCBON     when Node_Data % 65536 =  -8 and D.MSCPRMIS >= 0 then @iCBOFF   when Node_Data % 65536 =  -9 and D.MSCPRMIS & 65536 > 0 then @iCBON    when Node_Data % 65536 =  -9 and D.MSCPRMIS & 65536 = 0 then @iCBOFF   when Node_Data % 65536 = -10 and D.MSCPRMIS & (65536 * 2) > 0 then @iCBON    when Node_Data % 65536 = -10 and D.MSCPRMIS & (65536 * 2) = 0 then @iCBOFF   when Node_Data % 65536 = -11 and D.MSCPRMIS & (65536 * 3) > 0 then @iCBON    when Node_Data % 65536 = -11 and D.MSCPRMIS & (65536 * 3) = 0 then @iCBOFF   when Node_Data % 65536 = -12 and D.MSCPRMIS & (65536 * 4) > 0 then @iCBON    when Node_Data % 65536 = -12 and D.MSCPRMIS & (65536 * 4) = 0 then @iCBOFF   when Node_Data % 65536 = -13 and D.MSCPRMIS & (65536 * 5) > 0 then @iCBON    when Node_Data % 65536 = -13 and D.MSCPRMIS & (65536 * 5) = 0 then @iCBOFF   when Node_Data % 65536 = -14 and D.MSCPRMIS & (65536 * 6) > 0 then @iCBON    when Node_Data % 65536 = -14 and D.MSCPRMIS & (65536 * 6) = 0 then @iCBOFF   when Node_Data % 65536 = -15 and D.MSCPRMIS & (65536 * 7) > 0 then @iCBON    when Node_Data % 65536 = -15 and D.MSCPRMIS & (65536 * 7) = 0 then @iCBOFF   when A.Node_Image in (@iNODEWINDOW, @iNODEREPORT, @iNODETABLE, @iNODEREPORTMOD) then @iCBON   else @iCBUNKNOWN   end as Note_State, case   when A.Node_Overlay = @iNODEDISABLED then @iNODEDISABLED   else @iNODENODISPLAY   end as Node_Overlay, A.Node_Child, A.Node_Image_Parent1, A.Node_Data_Parent1, A.Node_Image_Parent2, A.Node_Data_Parent2, A.Node_Image_Parent3, A.Node_Data_Parent3, case   when A.Node_Image in (@iNODEWINDOW, @iNODEREPORT, @iNODETABLE, @iNODEREPORTMOD) then 1 else 0 end as Active   from DYNAMICS.dbo.WDC51101 A   join DYNAMICS.dbo.WDC51100 C on   A.WDC_Entity_ID = @pSourceEntityID and C.WDC_Entity_ID = @pTargetEntityID   left join (select USRCLASS, case when ALTDICID = DICTID and ALIAS = 0 then @iCBOFF else @iCBON end as State, RESTYPE, DICTID, RESID, ALIAS, ALTDICID   from DYNAMICS.dbo.SY40300) B on   case A.Node_Image   when @iNODEWINDOW then @iFORMTYPE   when @iNODEREPORT then @iREPORTTYPE   when @iNODETABLE then @iTABLETYPE   when @iNODEREPORTMOD then @iREPORTTYPE   end = B.RESTYPE   and A.Node_Data % 65536 = B.RESID and case when A.Node_Data % 65536 < 22000 and A.Node_Image in (@iNODEWINDOW, @iNODEREPORT) then 0 else A.Node_Data / 65536 end = B.DICTID and C.USRCLASS = B.USRCLASS   left join (select USRCLASS, MSCPRMIS   from DYNAMICS.dbo.SY40400) D   on A.Node_Image = @iNODEREPORT and A.Node_Data % 65536 < 0 and C.USRCLASS = D.USRCLASS   where A.WDC_Entity_ID = @pSourceEntityID and not (A.Node_Image = 18 or (A.Node_Image between 22 and 30) or (A.Node_Image between 34 and 48))  if @@ERROR <> 0 begin   if @tTransaction = 1  rollback transaction   select @O_iErrorState = 50406  return  end  exec @iRetVal = DYNAMICS.dbo.WDC_Security_ResetCacheStateParent 0, 0, @pTargetEntityID, @iErrorState  if @iRetVal  <> 0 or @iErrorState <> 0 begin   if @tTransaction = 1  rollback transaction   select @O_iErrorState = @iErrorState  return  end  if @tTransaction = 1 commit transaction  return     
GO
GRANT EXECUTE ON  [dbo].[WDC_Security_CloneClassEntity] TO [DYNGRP]
GO
