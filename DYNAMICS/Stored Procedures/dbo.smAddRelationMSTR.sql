SET QUOTED_IDENTIFIER OFF
GO
SET ANSI_NULLS ON
GO
 create procedure [dbo].[smAddRelationMSTR]   @I_iParentRelID int   = NULL,  @I_sEntityID smallint = NULL,  @I_iSQLSessionID int   = NULL,  @I_cNewRelString char(30) = NULL,  @O_iNewRelID integer  = NULL output,  @O_SQL_Error_State int   = NULL output as  declare   @iRowCount int,  @tTransaction tinyint,  @iIdentity int  select  @O_iNewRelID  = 0,  @O_SQL_Error_State = 0  if @I_iParentRelID is NULL or  @I_sEntityID is NULL or  @I_iSQLSessionID is NULL or  @I_cNewRelString is NULL begin  select @O_SQL_Error_State = 20906  return  end   select  @iRowCount = count(ENTITYID) from  ORG40100 where  ENTITYID = @I_sEntityID  if @iRowCount = 0 begin  select @O_SQL_Error_State = 20955  return  end  if @@trancount = 0 begin  select @tTransaction = 1  begin transaction end  set rowcount 1 insert into ORG00100(  RELID,  PARNTRLTID,  RELSTRNG,  ENTITYID) select  - @I_iSQLSessionID,  @I_iParentRelID,  @I_cNewRelString,  @I_sEntityID where  @I_cNewRelString not in   (select   RELSTRNG   from   ORG00100 with (NOLOCK)   where   RELSTRNG = @I_cNewRelString)  select @iRowCount = @@rowcount  set rowcount 0  if @iRowCount <> 1 begin  if @tTransaction = 1  rollback transaction  select @O_SQL_Error_State = 20907  return end  select   @O_iNewRelID = DEX_ROW_ID from  ORG00100 where  RELID = - @I_iSQLSessionID  update  ORG00100 set   RELID = DEX_ROW_ID where  DEX_ROW_ID = @O_iNewRelID  if @@rowcount <> 1 begin  if @tTransaction = 1  rollback transaction  select @O_SQL_Error_State = 20908  return end  select   @iRowCount = count(RELID) from  ORG00100 where  RELID = @I_iParentRelID  if @iRowCount <> 1 and @I_iParentRelID <> 0 begin  if @tTransaction = 1  rollback transaction  select @O_SQL_Error_State = 20910  return end  if @tTransaction = 1  commit transaction  return    
GO
GRANT EXECUTE ON  [dbo].[smAddRelationMSTR] TO [DYNGRP]
GO
